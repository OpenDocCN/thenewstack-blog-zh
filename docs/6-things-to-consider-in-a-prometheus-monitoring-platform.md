# 普罗米修斯监控平台需要考虑的 6 件事

> 原文：<https://thenewstack.io/6-things-to-consider-in-a-prometheus-monitoring-platform/>

组织纷纷转向 Prometheus 来监控他们的容器和微服务资产，但较大的公司经常一头撞上墙:当他们超越少数应用程序时，他们面临扩展挑战。

## 集装箱使情况变得复杂了

监控单一环境曾经相对简单。您有一定数量的静态物理服务器和虚拟机，以及有限数量的指标需要观察。如今，由于容器和向微服务架构的迁移，要跟踪的实体数量正在激增。

 [洛里斯·德吉奥安尼

洛里斯·德吉奥安尼是 Sysdig 的首席技术官和创始人，Sysdig 是安全 DevOps 的领导者。他还是流行的开源故障排除工具 sysdig 和开源容器安全工具 Falco 的创造者。在创立 Sysdig 之前，洛里斯参与创建了 Wireshark，这是一款开源网络分析器，目前拥有 2000 多万用户。洛里斯拥有都灵理工大学的计算机工程博士学位，现居加州戴维斯。](https://sysdig.com/) 

如果位于数据中心的服务器是需要我们持续关注的宠物(正如他们被描述的那样)，而云实例更像牛(你不在乎一只，因为你有很多)，那么容器更像蝗虫。它们有很多，有时每台机器有数百个，新的总是出现，当与 Kubernetes 这样的管弦乐队一起使用时，它们的寿命会很短。这使得跟踪它们变得更加困难，如果你不小心，它们会造成很大的损失。

随着环境的复杂性和分布的增加，需要监控的实体数量也在增加。此外，您可能希望监控更多属性，以确保您对正在发生的事情有一个准确的了解，或者在故障排除或事件响应的情况下，对正在发生的事情有一个准确的了解。后者在这些短暂的环境中尤其成问题，因为当您想要了解问题的根本原因时，有问题的资源通常已经退役，这意味着[监控解决方案](https://thenewstack.io/category/monitoring/)必须提供一种方法来存储足够的历史以供取证。

## 普罗米修斯

越来越多的，当需要云监控时，团队转向[普罗米修斯](https://prometheus.io/)，一个开源的 CNCF 项目。Prometheus 已经成为开发人员用来在云原生环境中收集和理解指标的首选监控工具。它得到了一个大型社区的支持，有来自 700 多家公司的 6，300 名贡献者，以及 13，500 个代码提交和 7，200 个拉请求。

一个典型的云原生应用栈——比如 Kubernetes、Ngnix、MongoDB、Kafka、golang——默认公开普罗米修斯指标。普罗米修斯被设计成一个垂直扩展的围棋程序。很容易部署为单个容器或单个主机。这意味着开始使用 Prometheus 来了解您的第一个 Kubernetes 集群非常容易。但这也意味着随着基础设施的增长，您将达到极限。

## 规模问题

随着您的环境的增长，您需要跟踪的时间序列数据的数量急剧增加，在某一点上，单个 Prometheus 实例将无法跟上。最直接的选择是在整个企业中运行一组 Prometheus 服务器，但这也带来了一些挑战。例如，管理和联合数十或数百台 Prometheus 服务器上的数据并不容易。同样，弄清楚企业工作流、单点登录、基于角色的访问控制以及遵守 SLA 或法规遵从性也不是容易的问题。随着应用程序的增长，在不中断开发人员工作的情况下运行全方位的监控解决方案成为一个巨大的可管理性和可靠性问题。

为了解决这个问题，公司采取了一些方法。

简单的第一步是为每个名称空间或每个集群准备一个单独的 Prometheus 服务器。这种方法显然很难扩展到某个点以上，除此之外，它还有一个缺点，就是会产生大量互不相连的数据孤岛。这使得故障排除变得很麻烦，因为大多数问题会跨越多个服务/团队/集群。不仅很难在每个环境中找到相同的指标，您还必须将数据拼接在一起，以试图了解正在发生的事情。

另一种常见的方法是使用开源工具，如 [Cortex](https://github.com/cortexproject/cortex) 或[灭霸](https://github.com/thanos-io/thanos)来联合多个普罗米修斯服务器。它们是强大的工具，使您能够以集中的方式查询服务器，收集数据，然后在单个仪表板中共享这些数据。然而，与任何数据密集型分布式系统一样，它们需要大量的技能和资源来操作。

## 需要考虑的六个因素

对于从 Prometheus 开始，然后寻找商业解决方案来提供整体视图的公司来说，重要的是他们不要失去在 Prometheus 上标准化所做的所有开发工作——仪表板、警报、导出器和其他工作。然而，这不是你应该考虑的唯一事情。如果你走这条路，坚持支持这些核心标准:

1.  **完全摄取兼容性，真正支持所有 Prometheus 功能**。您的供应商/工具/SaaS 解决方案需要能够使用来自任何能够生成 Prometheus 指标的实体的数据，无论是内部 Kubernetes 还是任何云服务。使用 Prometheus 指标相对来说并不重要，但是不要忽略这些小事情，比如在将指标接收到存储中时能够重新标记它们，或者增加数据，使其对您的环境更有意义。这些事情加在一起，在能够使用收集的大量数据方面有很大的不同。
2.  **PromQL 兼容性**。普罗米修斯查询语言是由普罗米修斯的创造者发明的，用于提取普罗米修斯存储的信息。PromQL 使您能够要求特定服务或特定用户的指标。它还使您能够聚合或分段数据。例如，您可以使用它来显示所有容器中每个应用程序的 CPU 利用率。或者只显示 Cassandra 容器的数据，并将其显示为每个集群的单个值。PromQL 解锁普罗米修斯的真正价值；因此，将 Prometheus metrics 吸收到一个不完全支持 PromQL 的产品中违背了使用 Prometheus 的全部目的。
3.  **热插拔**。为了真正与 Prometheus 兼容，该解决方案必须是热插拔的，能够与您现有的仪表板、警报和脚本配合使用。例如，许多使用 Prometheus 的公司将 Grafana 用于仪表板。这个开源工具与 Prometheus 很好地集成在一起，包括在查询级别，可以用来生成一系列有用的图表和仪表板。因此，声称与 Prometheus 兼容的商业产品应该与 Grafana 等工具兼容。仅仅说解决方案允许您在 Grafana 中看到一个数字是不够的。您需要能够原封不动地接收现有的 Grafana 仪表板，并将其重新应用于商业解决方案中安装的数据。
4.  **访问控制**。评估工具时，访问控制是您应该考虑的另一个安全问题。能够使用行业标准协议(包括 LDAP、Google Oauth、SAML 和 OpenID)保护用户身份验证，使公司能够通过基于服务的访问控制来隔离和保护资源。
5.  **故障排除**。Kubernetes 简化了容器化应用和微服务的部署、扩展和管理。这有助于保持服务正常运行，但要识别和解决底层问题，如性能缓慢、部署失败和连接错误，您需要能够从整个环境中收集和可视化深入的基础架构、应用程序和性能数据。如果无法访问实时信息和上下文数据，就几乎不可能在您的环境中关联指标，以便您能够更快地解决问题。
6.  **与现有警报的兼容性**。最后，如果您正在寻找一个商业答案来帮助处理 Prometheus 可伸缩性问题，请确保它支持所有级别的警报。实现这一点的关键是完全支持警报管理器功能，这反过来要求 100%的接收和 PromQL 兼容性。

如果您找到一个符合这些标准的商业工具，您应该能够毫不费力地将其转换到现有的 Prometheus 集成中，并避开公司遇到的可伸缩性问题。开发人员崇拜普罗米修斯，有充分的理由，现在尽职调查将帮助您确保他们仍然可以使用他们喜欢的度量标准。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>