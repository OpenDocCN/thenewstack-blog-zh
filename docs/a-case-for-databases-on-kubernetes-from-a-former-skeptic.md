# 一个来自前怀疑论者的关于 Kubernetes 数据库的案例

> 原文：<https://thenewstack.io/a-case-for-databases-on-kubernetes-from-a-former-skeptic/>

[](https://www.linkedin.com/in/bradfordcp/)

 [克里斯托弗·布拉德福德

克里斯托弗热衷于通过自动化提高效率。从通过 Cassandra 促进轻松扩展到使用基础设施自动化和容器的 DevOps 管道，他在这里完成工作并让运营商高枕无忧。](https://www.linkedin.com/in/bradfordcp/) [](https://www.linkedin.com/in/bradfordcp/)

库伯内特无处不在。交易应用、视频流服务和机器学习工作负载正在这个不断增长的平台上找到自己的家。但是数据库呢？如果你在五年前问我这个问题，答案会是响亮的“**不！**“—基于我在开发和运营方面的经验。在接下来的几年里，随着有状态应用程序的资源越来越多，我的答案可能会变成“*”，“T11”，但总是会加上一个修饰语:“这对于开发或测试环境来说很好……”或者“如果你的工具的其余部分是基于 Kubernetes 的，并且你有丰富的经验……”*

但是今天呢？你应该在 Kubernetes 上运行一个数据库吗？面对复杂的操作和持续、一致的数据要求，让我们回顾一下我目前的答案:“在云原生环境中？**是的！**

## 阶段 1:在 Kubernetes 上运行无状态工作负载，但不是数据库！

当 Kubernetes 登陆 DevOps 场景时，我热衷于探索这个新平台。我的自动化已经通过 Puppet 配置主机和 Capistrano 将我的应用程序位转移到虚拟服务器而实现了。我已经开始探索 Docker 容器，并且喜欢我不再需要在我的开发人员工作站上安装和管理服务的方式。我可以启动几个容器，继续用我的代码改变世界。

Kubernetes 使得将这些容器部署到一组服务器变得轻而易举。它还负责在实例停机时替换它们，并保持大量副本在线。再也不用随时收到传呼了！这对于无状态服务来说很棒，但是数据库呢？Kubernetes 承诺敏捷，但是我的数据库被绑在一个巨大的数据船锚上。如果我在容器中运行数据库，当容器返回时，我的数据会在那里吗？我没有时间解决这个问题，所以我启动了一个托管 RDBMS，并转向下一个特性标签。任务完成。

## 阶段 2:在 Kubernetes 上运行临时数据库进行测试

当我需要为每个 GitHub pull 请求(PR)运行单独的应用程序实例进行 QA 测试时，这个问题又出现了。每个 PR 需要一个运行的应用实例*和一个数据库*。我们不能只运行共享数据库，因为一些 PRs 包含模式更改。我不需要漂亮的解决方案，所以我们在与应用程序相同的 *pod* 中运行 RDBMS 的一个实例；并预加载了模式和一些数据。我们在它前面放置了一个反向代理，并根据需要按需旋转实例。QA 很高兴，因为在测试环境中不再安排 PRs，产品团队享受特性环境来测试新功能，而 ops 不必编写一堆自动化程序。对我来说，这是一种完全不同的情况，因为我从来没有想到这些环境会是短暂的。它肯定不是云原生的，所以我仍然不准备在生产中用 Kubernetes 部署的数据库替换我的托管数据库。

## 阶段 3:在 Kubernetes StatefulSets 上运行 Cassandra

大约在这个时候，我被介绍给了阿帕奇·卡珊德拉。我对这个高性能数据库和非凡的运营故事感到惊讶。可以支持丢失实例的数据库？帮我报名！我在 Kubernetes 上运行数据库的希望又回来了。卡珊德拉能处理容器短暂的本质吗？当时，我觉得这像是一个不情愿的“*我猜？*”。这似乎是可能的，但是在工具上有很大的差距。为了将它投入生产，我需要一个由 Kubernetes *和* Cassandra 老手组成的团队，外加一套工具和操作手册来填补运营缺口。看起来确实有很多团队成功地在容器中运行了 Cassandra。我愉快地回忆起 Instaclustr 的一个网络研讨会，讨论在 CoreOS 上运行 [Cassandra。](https://www.youtube.com/watch?v=rhqSmc9meMw)

与此同时，许多库伯内特生态系统的变化开始固化。StatefulSets 根据可预测的命名方案处理具有持久存储的 pod 的创建。持久卷 API 和容器存储接口(CSI)允许计算和存储之间的松散耦合。在某些情况下，甚至可以在应用程序围绕群集重新安排时，定义跟随应用程序的存储。

存储是每个数据库的核心。在容器化的数据库中，数据可以存储在容器内部，也可以安装在外部。使用外部存储可以切换容器来更改配置或升级软件，同时保持数据完整。Cassandra 已经能够利用高性能本地存储，但现代 CSI 实施的灵活性意味着，随着 pod 的重新安排，数据量将转移到新的工作人员。这减少了恢复时间，因为在工作人员出现故障的情况下，不再需要在主机之间同步数据。

## 第四阶段:卡桑德拉的 Kubernetes 运营商

有了 Cassandra 节点到 pod 的直接部署、数据量的弹性处理和保持一切运行的 Kubernetes 控制平面，我们还能要求什么呢？在这一点上，我遇到了两个独立开发的分布式系统的冲突。Kubernetes 供应 pod 和启动服务的方式**并不**符合维护和供应 Cassandra 集群所需的操作步骤——Kubernetes 工作流和 Cassandra runbooks 之间必须弥合差距。

Kubernetes 提供了许多内置资源——从一个简单的构建块(如 Pod)到更高级的抽象(如部署)。这些资源让用户定义他们的需求，Kubernetes 提供控制循环来确保运行状态与目标状态相匹配。一个控制循环采取简短的递增动作来将协调的组件推向期望的最终状态——比如重启一个 pod，或者创建一个 DNS 条目。然而，像分布式数据库这样的领域需要更复杂的动作序列，这些序列不太适合预定义的资源。这很好，但是并不是所有东西都适合预定义的资源。

创建 Kubernetes 定制资源是为了允许 Kubernetes API 通过定义新的资源类型和控制器来扩展特定领域的逻辑。像 [operator-sdk](https://sdk.operatorframework.io/) 、 [kubebuilder](https://github.com/kubernetes-sigs/kubebuilder) 和 [juju](https://juju.is/) 这样的 OSS 框架被创建来简化定制资源及其控制器的创建。用这些框架构建的工具被称为操作符。

随着这些功能强大的新工具的出现，我加入了 cass-operator 项目中编写 Cassandra 逻辑域和操作手册的工作。Cass-operator 定义了 CassandraDatacenter 自定义资源，并提供了包括管理 API、cass-config-builder 和其他项目在内的项目之间的粘合，以在 Kubernetes 上提供内聚的 Cassandra 体验。

有了 cass-operator，我们花在 pods、有状态集、持久卷甚至启动和扩展集群的繁琐任务上的时间更少了，而花在考虑我们的应用程序上的时间更多了。

## 现阶段:使用 K8ssandra 运行完整的数据平台

这个循环的下一次迭代，K8ssandra，让我们离单个组件更远。我们可以整体考虑我们的数据平台，而不是看 Cassandra 数据中心:不仅仅是数据库，还包括支持服务，包括监控、备份和 API。我们可以通过执行一个简单的 Helm install 命令向 Kubernetes 请求一个数据平台；一组操作员开始调配和管理所有的部分。

回顾我几年前在 Kubernetes 上运行数据库时遇到的陷阱，大多数都已经解决了。从像 Cassandra 这样的基础技术开始，可以解决我们的可用性问题:数据被复制，它足够智能，可以在对等体来来去去时处理数据的移动。Kubernetes API 已经成熟，包括定制资源和高级有状态组件(如持久卷和有状态集)。Cass-operator 就像一块罗塞塔石碑，提供了将 Cassandra 和 Kubernetes 的术语缝合在一起所需的知识财富。最后，K8ssandra 以完整的内聚体验带我们更上一层楼。

所有这些问题都是*的难题，需要技巧和缜密的思考。如果没有选择正确的部分，我们将最终放弃数据库和 Kubernetes，让它们在我们的基础设施中扮演合适的角色，以及那些投入大量精力来构建所有这些部分和操作手册的创新工程师。幸运的是，这些问题都被解决了。你应该在 Kubernetes 上运行你的数据库吗？*肯定。**

*<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>*