# Nuclio 和无服务器计算的未来

> 原文：<https://thenewstack.io/whats-next-serverless/>

[](http://iguaz.io/blog/)

 [亚龙 Haviv

作为 Iguazio 的 CTO 和创始人，亚龙是一位连续创业者，在大数据、云、存储、网络等领域拥有深厚的技术经验。在加入 Iguazio 之前，Haviv 是 Mellanox 的数据中心解决方案副总裁，负责技术创新、软件开发和解决方案集成。Haviv 是领先的数据库和存储供应商、企业组织、云和 Web 2.0 客户的开源计划和新解决方案的主要驱动力。在 Mellanox 之前，Haviv 是 Voltaire 的首席技术官兼研发副总裁，Voltaire 是一家高性能、计算、IO 和网络公司。Haviv 经常在大数据和云技术活动上发言。他在推特上写道@ yaronhaviv。](http://iguaz.io/blog/) [](http://iguaz.io/blog/)

无服务器平台允许开发人员专注于构建和运行自动扩展应用程序，而不用担心管理服务器，因为服务器供应和维护是在幕后进行的。因此，行业对即时结果的需求使得[无服务器平台](/category/serverless/)成为新的热点。

然而，无服务器平台具有限制其可用性和适用性的挑战:

*   性能缓慢且缺乏并发性(单线程)
*   锁定特定于平台的事件和数据源
*   应用程序状态维护、代码依赖和服务依赖的复杂性
*   它们不可能在混合或多云环境中开发、调试、测试和部署

当在云中开发无服务器功能时，数十或数百毫秒的延迟是当今的标准，如果我们能够在不进行第二次抵押贷款的情况下以每秒几千个事件的速度运行，那我们就很幸运了。这限制了对性能不敏感的前端应用程序或粘合逻辑的使用。如果更快或更高效，无服务器可以处理更多的工作负载。

> 许多无服务器平台“增加了更多的功能，但基本的架构决策不能随着时间的推移而修补。”

随着我们突破简单 web 应用的舒适区，我们需要从消息或流媒体源获取功能。我们还必须将状态存储在特定于云的数据库/存储中，并使用特定于云的日志记录和监控工具。这些集成并不简单，这意味着我们的功能代码现在被绑定到一个特定的云平台上。如果我们想换供应商呢？还是使用多云部署？或者在我们的笔记本上调试一些代码？或者对我们的迷你集群进行回归测试？忘了它吧。

## 是的，但是这些众多的开源无服务器/FaaS 项目呢…？

许多开源无服务器或功能即服务(FaaS)项目最初是作为快速开发前端应用程序或粘合逻辑的一种方式。他们不太关注性能、对各种事件源的支持或与状态、数据、日志记录或版本控制的更好集成，以使它们适用于要求更高的应用程序或提供端到端的服务体验。

他们现在增加了更多的功能，但基本的架构决策不能随着时间的推移而修补。一些流行的 FaaS 解决方案解决了触发任何容器化应用程序的挑战，但像 CGI 一样工作(每个事件都从头启动应用程序及其所有数据连接)，而不是像一些可以在高摄取率的应用程序上工作的东西。

## 那么我们能做什么呢？

1.  从头开始构建专注于并行性和 CPU/Mem/IO 的无服务器架构。
2.  定义跨多种事件类型、框架和云提供商的通用事件格式。
3.  从功能代码中分离事件/数据源。
4.  提供更强的数据安全性和访问控制。
5.  更加重视无服务器调试、日志记录和工具/特性。
6.  解决混合和多云环境中的持续开发和运营问题。使函数及其事件馈送和数据依赖可移植和版本化。

当我们构建 [nuclio](https://github.com/nuclio/nuclio) —一个新的高级高性能开源无服务器框架时，上述标准指导了我的公司 [iguazio](https://www.iguazio.com/) 。我们知道，如果没有一个更广泛的生态系统来应对这些挑战，它将是不完整的。我们正积极与[云本地计算基金会](https://www.cncf.io/)合作，提出行业范围的解决方案，并参与撰写了这篇[无服务器论文](https://docs.google.com/document/d/1UjW8bt5O8QBgQRILJVKZJej_IuNnxl20AJu9wA8wcdI/edit?usp=sharing)以促进合作。

以下是纽克利奥如何应对这些挑战:

## 无服务器性能

缺乏并行性、对资源(网络、io 等)的访问受阻等因素会降低应用性能。)和过多的内存分配/释放/编码。

无服务器函数受到的影响最大，因为它们是单线程的。对资源的访问被阻塞，并且在许多情况下，每次调用都要重新启动连接。无服务器还充斥着数据拷贝、消息序列化/反序列化和上下文切换。难怪性能这么慢！这影响了我们可以服务的用例类型，并增加了应用程序成本(由于需要更多的 CPU 和内存资源)。

[Nuclio](https://github.com/nuclio/nuclio) 引入了轻量级工作者上下文的概念，因为多个功能任务在相同的资源上并行运行(使用 Go 例程)。数据缓冲区被重用，消除了分配/解除分配和垃圾清理。对外部资源/数据的访问总是无阻塞的。我们不再需要(JSON)序列化和数据拷贝。nuclio 包装器进程(在 Go 中)和特定于语言的运行时之间的通信是非阻塞的，并且使用共享内存。

我们确保传入的数据或流在多个功能实例之间进行分区和动态平衡，以在大规模消息处理的情况下获得线性可伸缩性(nuclio 的经销商服务可以承受故障，同时支持不同的交付模式/保证，如“至少一次”、“最多一次”等。).结果是，nuclio 使用单个进程每秒可以处理 400，000 个事件。底线是 nuclio 比主流的无服务器解决方案快 100 倍。

## 由任何类型的源触发的功能

当我们使用目前最流行的无服务器服务 AWS Lambda 时，我们受限于一组平台事件源(如 HTTP gateway、Kinesis 和 SQS)。每个事件源生成一个不同的事件结构，即使它携带相同的有效载荷([像这样强制攻击](https://gist.github.com/jeshan/52cb021fd20d871c56ad5ce6d2654d7b))。这意味着我们的函数代码被锁定在特定的事件实现和提供者上。

Nuclio 引入了公共事件结构的概念，将特定于事件头的协议与主体中的内容分开，并支持各种序列化选项(不强制昂贵的 JSON 反序列化)。有了 nuclio，同样的功能代码可以被 HTTP、 [Kinesis](https://aws.amazon.com/kinesis/) 、 [Kafka](https://kafka.apache.org/) 、 [RabbitMQ](https://www.rabbitmq.com/) 、 [MQTT](http://mqtt.org/) 、 [NATS](https://nats.io/) 、 [iguazio 的 V3IO](https://www.iguazio.com/product/) 、文件内容或者事件模拟器触发。

我们现在可以使用仿真器开发我们的功能，使用 HTTP 进行测试，使用流进行生产，如果您在云提供商或 beta/生产设置之间移动，甚至可以更改源代码。

Nuclio 的公共事件源方法是作为 [CNCF 规范](https://github.com/cncf/wg-serverless/blob/master/proposals/cloudevents/README.md)提出来解决无服务器锁定和复杂性问题的。希望多个平台将采用这一概念。

## 加速、保护和抽象对各种数据源的功能访问

函数是无状态的。它们频繁地访问外部数据服务，以检索状态或内容、存储结果和传递消息。如今，特定的数据访问实现和凭证通常要么被硬编码到函数中，要么最多使用一些环境变量。这意味着我们无法构建一个可移植的功能，并且在开发、测试和生产过程中，很难对不同的数据类型或存储库使用相同的功能。

Nuclio 为函数提供了可插入的数据绑定。开发人员反对数据绑定，操作人员可以在部署时决定使用哪些数据系统和数据集。这个最初由 Azure 首创的概念带来了:

*   简单性:针对简单的 API 编码，不考虑 SDK 和连接细节。
*   安全性:凭证不是函数代码/变量的一部分。
*   可移植性:移动功能并使用不同的数据源。
*   可重用性:通过改变绑定的数据集，同一个函数可以在多个用例中使用。
*   性能:跨调用缓存数据和连接，并使用非阻塞 IO 和零拷贝访问。

## 简化功能调试、记录和检测

调试无服务器可能会令人沮丧，因为它没有跟踪或断点。我们如何自动化回归测试，尤其是当我们依赖于外部事件和数据源的时候？

日志记录和打印全部进入非结构化和资源密集型日志，无法控制细节级别和开销之间的权衡。自动化需要复杂的日志解析。

在这个领域还有很多事情要做，这是一个挑战，需要通过无服务器平台提供商和 ide、测试、仪器工具等软件提供商之间的协作和标准化来解决。努克利奥朝着正确的方向迈出了重要的几步:

*   内置非侵入式结构化和非结构化日志记录功能，支持一系列输出选项(屏幕、HTTP、文件、日志流),并具有动态控制的详细级别。这允许我们在代码中放置许多日志/调试点，并在运行中或每次调用时更改详细级别，以便在不更改代码的情况下诊断错误和故障。这个结构选项使它成为测试自动化和分析的理想选择。
*   Nuclio 函数导入 nuclio-SDK，使我们的本地 IDE 像本地程序一样工作，具有自动完成和断点。SDK 提供了一种方式来本地运行我们的函数，将日志打印到屏幕/文件，从模拟事件中获取日志，并使用可插入的数据绑定来模拟函数输入/输出。
*   对于回归测试，我们可以创建一个事件提要仿真(从 files/http/streams/..)与仿真输入数据集进行比较，并将日志和数据输出与预期结果进行比较，所有这些都无需更改代码。
*   额外的调试和工具特性在我们的路线图中，包括自定义统计和 OpenTracing 集成。

## 交付混合和多云 CI/CD 管道和分布式部署模型

对于一些人来说，在一个云上完成所有工作是一个可行的选择，但对于大多数其他人来说，这是昂贵和有限的。一个典型的案例涉及在笔记本电脑上工作的开发人员、受到 24×7 事件轰炸的专用集群上的回归测试(对于无服务器的每次调用成本模型来说不理想)、测试和生产部署。在物联网或边缘场景中，这些相同的功能可能还需要部署在多个边缘位置。这意味着我们需要一个版本化的分布式开发管道，可以选择滚动升级或金丝雀升级(部署 80/20 版本组合)。

上面提到的 Nuclio 特性——例如在任何地方运行的能力、事件、日志和数据的抽象以及日志功能——是支持在多个位置部署的重要特性。此外，nuclio 还提供了一种联合和版本化的部署方法。编译后的函数会生成一个工件(二进制或容器映像),可以存储在本地或共享映像报告中，函数可以有多个版本，每个版本都有唯一的元数据、事件和数据。使用 nuclio，我们可以选择在一个集群上构建/测试，并在多个集群上部署相同的工件，而无需重新构建我们的代码(从映像部署)。

## 摘要

无服务器是一个年轻且快速增长的领域。这是一种非常有前途的加速商业发展的方式，并且仍然有很大的创新空间。我相信这只能通过更好的协作以及社区中各种供应商和成员之间的共享来实现。我们希望其他国家将加入 CNCF 在该领域的发展和标准化努力。

如果您想使用独立的 nuclio 版本，只需将这一行复制/粘贴到您的命令行界面中即可:

docker run-p 8070:8070-v/var/run/docker . sock:/var/run/<wbr>docker . sock-v/tmp:/tmp nucl io/playground

在 HTTP:// <machine-ip>:8070 打开浏览器。这将调出 nuclio 游乐场。选择一个示例函数，编辑、部署和调用。当你等待的时候，请给它一颗星。访问我们的 [GitHub 页面](https://github.com/nuclio/nuclio)获取完整版本和更多细节。</machine-ip>

[云本地计算基金会](https://www.cncf.io/)是新堆栈的赞助商。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>