# 为 Envoy、Istio 和 Kubernetes 提供微服务

> 原文：<https://thenewstack.io/microservicing-with-envoy-istio-and-kubernetes/>

[](https://www.openshift.com/)

 [Christian Posta，Red Hat 首席架构师

Christian Posta(@ Christian Posta)是 Red Hat 云应用程序的首席架构师，在社区中以作家(Java 开发人员的微服务，O'Reilly 2016)、频繁的博客作者、演讲者、开源爱好者和各种开源项目的提交者而闻名。Christian 曾在网络规模的公司工作过，现在帮助公司创建和部署大规模、有弹性的分布式架构，其中许多就是我们现在所说的微服务。他喜欢指导、培训和带领团队在分布式系统概念、微服务、开发运维以及云原生应用设计方面取得成功。](https://www.openshift.com/) [](https://www.openshift.com/)

当组织谈论微服务时，我们谈论的是使用微服务作为构建业务敏捷 IT 系统的工具:这些系统使企业能够更快地改变、构建新功能、进行试验并在颠覆者和竞争中保持领先。

业界倾向于将微服务浪漫化，这通常是有充分理由的，但事实是微服务有许多困难之处。从技术角度来看，构建微服务意味着构建分布式系统。而分布式系统很难。

例如，Kubernetes 就是一个很好的部署骨干。由于像 Kubernetes 和 OpenShift 这样的平台，容器部署平台近年来已经成为我们基础设施中令人厌烦的一部分。不幸的是，令人兴奋的部分发生在服务实际尝试通信和一起工作来完成一些业务功能的时候。当我们开始构建通过网络通信的服务架构或应用程序时，我们必须处理一些令人讨厌的分布式系统问题。正如已经说过的，我们不能忽视分布式计算的谬误。

那么，当我们向服务发送消息时会发生什么呢？该请求被分解成更小的块，并通过一系列跳、控制点和防火墙在网络上路由。

因为这个“网络”，我们处理分布式计算的谬误应用程序通过异步网络进行通信，这意味着对时间没有单一、统一的理解。服务生活在他们自己对“时间意味着什么”的理解中，这可能不同于其他服务。更重要的是，这些异步网络根据路径的可用性、拥塞、硬件故障等来路由数据包。不能保证消息会在有限的时间内到达预期的接收者。网络做它想做的。

网络中的这种不确定性使得确定故障或仅仅是速度慢变得相对不可能，更重要的是确定故障的原因。

随着我们转向服务架构，我们将复杂性推向了服务之间的空间。这些需要解决的应用程序网络复杂性包括:

*   服务发现
*   重试次数
*   超时设定
*   负载平衡
*   限速
*   螺纹舱壁
*   断路

这些都是横向关注的问题，适用于服务，不管实现如何。服务是用 Java、Go、Python 还是 Node.js 写的应该没关系；我们希望他们在解决这些弹性问题时表现一致。此外，如何实现应用程序联网应该对应用程序透明。当网络和应用程序出现问题时，应该很容易确定问题的根源。这在理论上听起来很棒，但是我们如何着手去做呢？

如果我们可以在一个地方实现这个功能，并且让任何语言/框架/实现都可以使用它，那会怎么样？

## 进入服务网格

服务网格是您的服务之间的分散式应用程序网络基础设施，提供弹性、安全性、可观察性、路由控制，最重要的是，洞察一切是如何运行的。服务网格由所有流量流经的数据平面和管理数据平面的控制平面组成。代理构成了数据平面，应用程序之间的流量流经这些代理。控制平面负责管理和配置代理来路由流量，以及在运行时实施策略。

服务网格是一种范式，它的出现有助于使服务通信变得乏味。它使我们能够以最小的开销和高度的分散性将应用网络功能下推到基础架构中，并能够控制、配置和监控应用级请求，从而解决上述一些问题。

随着服务架构变得更加异构，将服务实现限制到特定的库、框架甚至语言变得更加困难(或者不切实际)。随着服务网格的发展，我们看到一些这样的弹性模式，比如断路，在基础设施中被实现为独立于语言/框架的解决方案。

借助服务网格，我们将应用程序网络功能与应用程序代码和业务逻辑明确分离，并将其向下推至基础架构中，类似于我们对网络堆栈、TCP 等所做的工作。

## 会见特使代理

通过代理，您可以将功能抽象为一个二进制文件，并将其应用于所有服务，而不管您使用的是什么语言，并让所有流量通过一个集中点。同样，这构成了服务网格中的数据平面。这反过来又:

*   支持异构架构。
*   移除此功能的特定于应用程序的实现。
*   始终如一地实施这些属性。
*   正确实施这些属性。
*   提供选择加入以及安全网。

特使代理是提供这种功能的代理的一个很好的例子。最初在 Lyft 构建的 Envoy 是一个高性能的代理，为服务网格提供了基础。它与应用程序一起运行，并通过以平台无关的方式提供通用功能来抽象网络。当基础架构中的所有服务流量都流经 Envoy mesh 时，通过一致的可观察性来可视化问题区域、调整整体性能以及在单一位置添加功能变得非常容易。

像 Envoy 这样的服务代理可以帮助推动弹性、服务发现、路由、指标收集等方面的责任。，在应用程序的下一层。否则，我们冒险希望和祈祷各种应用程序将正确地实现这些关键功能，或者依赖特定语言的库来实现这一点。****

代理架构提供了大多数使用服务架构的堆栈所缺少的两个关键部分——健壮的可观察性和简单的调试。有了这些工具，开发人员就可以专注于另一个需要他们关注的重要方面:业务逻辑。

## 满足 Istio 服务网格

[Istio.io](https://istio.io/) 是构建微服务的自然的下一步，它将特定语言的底层基础设施问题从应用程序转移到服务网格中，使开发人员能够专注于业务逻辑。它充当控制平面来配置一组特使代理。尽管 Istio 最初是为了支持 Kubernetes 而编写的，但它并不依赖于 Kubernetes，可以在任何平台上运行，包括跨多个平台的混合架构。

该项目最初由 Google、Lyft 和 IBM 赞助，并使用了 Envoy 代理的扩展版本，它作为 sidecar 部署到同一个 Kubernetes pod 中的相关服务。作为实现服务网格功能的一种方式，它已经在开源社区中引起了关注。这些功能包括将应用程序网络问题下推到基础设施中:重试、负载平衡、超时、截止时间、电路中断、相互 TLS、服务发现、分布式跟踪等。

Istio 最重要的一个方面是它控制服务间流量路由的能力。有了这种对应用程序级流量的细粒度控制，我们可以做一些有趣的弹性工作，如绕过故障路由、在必要时路由到不同的可用性区域，更重要的是，我们还可以控制部署的流量，从而降低系统变更的风险。

Istio 支持几种更高阶的集群语义，包括:

*   服务可观察性
*   分级部署和发布
*   政策实施
*   集群可靠性
*   混沌测试
*   车队配置
*   强大的安全选项

## 下一步是什么？

会有模糊的线条。在服务网格中，我们说我们的应用程序应该知道应用程序网络功能，但是它们不应该在应用程序代码中实现。关于应用程序网络功能/服务网格层到底在做什么，让应用程序变得更智能，有一些东西要说。我们很可能会在这种背景下看到库/框架的构建。

例如，如果 [Istio 服务网格](https://thenewstack.io/why-do-you-need-istio-when-you-already-have-kubernetes/)触发了一个断路器，重试了一些请求，或者由于特定原因而失败，那么对于应用程序来说，获得关于这些场景的更多理解或上下文将是一件好事。我们需要一种方法来捕捉这些信息，并将其反馈给服务。另一个例子是在服务之间传播跟踪上下文(像 OpenTracing 这样的分布式跟踪),并且透明地完成这个任务。我们可能看到的是这些瘦应用程序/语言特定的库，它们可以使应用程序/服务更加智能，并允许它们采取特定于错误的补救措施。

不管怎样，我们现在刚刚开始看到 Envoy 和 Istio 的实现通过 Kubernetes 和 Red Hat OpenShift 部署到生产中，到目前为止反馈是积极的。在某些情况下，Istio 甚至帮助那些刚刚进入该领域的人超越两三代微服务工作。因此，虽然我们仍处于开始阶段，但有许多不同的方式来建立最适合您的应用的技术。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>