# 为大型零售商部署微服务的经验

> 原文：<https://thenewstack.io/lessons-from-deploying-microservices-for-a-large-retailer/>

IT 咨询公司 CGI 的咨询服务总监希斯·墨菲说，微服务每天都“救了我们的命”。

Murphy 负责为一家美国专业零售商的订单履行系统设计微服务架构，该零售商需要为 1，200 多家实体店、15 个电子商务网站和 5，000 家 B2B 合作伙伴公司商店提供服务。他在 CodePaLOUsa 分享了他的经验，code palousa 是本月在肯塔基州路易斯维尔举行的一个区域发展会议。

## 定义微服务

墨菲说，微服务没有单一的定义。他最终确定了几个关键的决定性特征:

*   “服务”通常是使用技术不可知的协议(如 HTTP)通过网络进行通信以实现目标的过程
*   服务是围绕业务能力组织的。
*   服务可以使用不同的语言、数据库、硬件和软件环境来实现。
*   服务是“小规模的、支持消息传递的、受上下文约束的、自主开发的、可独立部署的、分散的，并且通过自动化过程构建和发布。”

## CGI 的微服务架构

墨菲说，CGI 为其客户构建的系统需要能够注入 EDI 文件、平面文件和“一百万种其他类型的文件”。它需要处理 API Rest 服务调用、直接数据库访问调用，以及流经验证、库存预订和仓库的消息队列。最后，在旅程结束时，该流程需要处理呼入的客户电话和硬件流数据。

它需要处理的业务事件包括从新的入站订单到取消订单、出站状态更新和库存更新。

CGI 在 SQL Server 上的一个非常大的遗留数据库上构建了一个微服务架构来处理这一切——他承认这在很大程度上是微服务的反模式，但这是他们必须做的。由于客户端是一个. Net 商店，它依赖于。Net 和 C#。所有的消息传递都由 RabbitMQ 处理，他指出这是“架构中极其重要的一部分，也是最先被忽略的一部分。”最后，它使用现成的产品来处理 EDI 文件，因为他们不想在. Net 中处理 EDI 文件。

值得注意的是缺少了什么，他补充道。微服务架构没有使用容器、MongoDB 或类似的大数据解决方案，甚至没有使用云。

## 记录的重要性

事实证明，日志记录是微服务应用的重要组成部分。在单块应用程序中，日志记录简单而有序，而在微服务架构中，日志记录发生在几十个进程和模块中。这带来了挑战，并使日志记录过程变得更加重要。

“到处都有日志发生，几十个地方，”墨菲斯说。

Murphy 建议开发人员选择一个包(他的例子是 SeriLog)并使用样板模板。检查良好的登录 PRs。他解释说，让伐木变得容易，以便获得更好的木材。该系统还要求在所有入站服务中关联 id；他解释说，它拒绝了所有没有这个属性的电话。最后，他建议建立或利用一个聚合平台。“当可搜索时，日志是有帮助的，”他的介绍指出。

他建议在同一个业务事务中对所有日志使用相同的关联 ID。关联 ID:在 HEAD-IN 服务中生成关联 ID。他指出，GUIDs 是很好的身份证明。然后把这些作为标题传下去。最后，交叉引用日志键，将所有外部业务标识符(如订单号、外部合作伙伴订单、仓单号、发货跟踪号和客户 ID)链接回日志键。

## 管理微服务的服务总线

这家咨询公司得到的一个教训是:如果你构建的微服务相互依赖，那么当一个连接中断时，系统就会崩溃。为了避免这种情况，CGI 设置了一个流程，以便 API 管理(APIM)向 Azure 服务总线发送一个微服务，从而在微服务之间触发事件。

最后，系统预计需要输入大约 100，000 个履行请求。他说，实际情况是它处理了 50 万个请求，因此“救了他们的命”

它能够处理这个问题是因为它依赖于 JSON 中没有订单细节的轻量级消息，这触发了履行请求微服务。RabbitMQ 能够扩大规模并处理突发流量。然后，微服务将获取完整的订单细节，执行完整的验证，并利用其他微服务。

## 墨菲的建议是:监控一切

墨菲建议监控一切。他们运行热量检测来检查连通性。他们监控消息队列，并为特定时间范围内可接受的错误数量设置阈值。当系统超过该阈值时，系统会触发警报。他们还会监控预期会发生但尚未发生的事情。

“日志告诉你发生了什么，但不告诉你还没有发生什么，”墨菲的幻灯片指出。"在事情应该发生而没有发生的时候建立监控."

最后，团队使用合成消息，将假请求注入相关的业务事务中，并监控时间、错误等方面的服务级别协议。

该系统确实使用人类来管理边缘情况 Murphy 指出这些情况肯定会出现——但 DevOps 文化也将边缘情况修复融入到 sprint 周期中。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>