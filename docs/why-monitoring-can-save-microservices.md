# 为什么监控可以拯救微服务

> 原文：<https://thenewstack.io/why-monitoring-can-save-microservices/>

[Raygun](https://raygun.com/) 赞助本帖。

埃里克·戈贝尔贝克尔

Eric 是一名 Raygun 作家，在纽约市的金融市场工作了 25 年，为市场数据和金融信息交换(FIX)协议网络开发基础设施。他喜欢谈论是什么让团队变得有效(或者不那么有效)。

在微服务应用程序的开发阶段，监控在整个过程中严重缺失。换句话说，出于多种原因，开发人员需要在设计和构建代码时考虑到监控，以便在部署微服务后省去很多麻烦。

Raygun 的[错误监控](https://raygun.com/platform/crash-reporting)和[应用性能监控](https://raygun.com/platform/apm) (APM)等系统当然可以通过几个简单的步骤将监控集成到微服务应用中。

然而，开发人员在创建微服务时，可以也应该使整个过程中的监控更加健壮和有效。

这里有一些方法来做到这一点，以及为什么它是重要的。

## 大局

在微服务架构中，业务流程分布在多个服务上。例如，考虑一个销售书籍的在线系统。每笔销售都包括向购物车中添加一本书、接受运输信息、处理付款和调整库存。在大多数微服务设计中，一个单独的服务处理每个步骤。监控一次销售意味着在几个服务中跟踪它。

因此，监控基于微服务的应用程序需要处理来自多个服务的事件。首先，这只有在服务提供必要信息的情况下才有可能。第二，它必须是共享的语法，这样你就可以整理事件。

Martin Fowler 在他关于微服务的博客中讨论了这个问题。他说减少治理是微服务的主要好处之一。团队可以根据自己的设计和独立的时间表工作。但是这种独立可能是有代价的。当团队选择不同的数据表示方式时，集中监控就会受到影响。

马丁·福勒是这样描述这个问题的:

在最抽象的层面上，这意味着世界的概念模型在不同的系统之间会有所不同。在大型企业中进行集成时，这是一个常见的问题，客户的销售观点与支持观点不同。在销售视图中被称为客户的一些东西可能根本不会出现在支持视图中。

然而，Fowler 并没有提供一个具体的解决方案来避免这个问题，同时又不会产生额外的官僚主义。我所能提供的是，治理和合作是有区别的，避开其中一个并不意味着放弃另一个。

您的组织可能促进合作或要求集中控制。无论哪种方式，您都可以采取措施使您的应用程序监控更好。让我们来看看其中的三个。

## 记录

日志是您可以添加到应用程序中的最基本的监控机制。虽然许多开发人员认为日志是报告错误的一种方式，但它们也是报告事件和应用程序状态的一种机制。

### 管理日志

在[的十二因素应用](https://12factor.net)中，亚当·威金斯将日志描述为一个[事件流](https://12factor.net/logs)。对于设计应用程序如何生成日志消息，这是一个有用的抽象。Wiggins 建议将日志文件管理委托给应用程序之外的东西。您的代码应该将日志消息交给一个外部代理，该代理将它们传递到它们应该在的地方。基础设施在中央系统中收集日志信息，用于索引和搜索。

这让开发人员不必担心日志的去向。但是让内容变得有用的责任仍然在他们身上。日志消息包含的信息以及应用程序创建它们的原因是非常重要的。开发人员应该像设计任何其他应用程序构件一样设计日志消息。

Wiggins 将日志描述为事件流，这是决定将什么放入其中的一个很好的起点。任何与监控和分析相关的应用程序事件都属于流。

### 日志内容

因此，如果我们返回到图书销售应用程序，我们可以马上识别出六条日志消息。

1.  1.  商品已添加到购物车；
    2.  退房已开始；
    3.  捕获的运输信息；
    4.  运费已计算；
    5.  付款已处理；
    6.  库存调整。

每条信息都推动我们完成销售过程。如果消息包含时间戳，它们还可以让我们了解系统的运行情况。这里的一个关键点是日志不仅仅是记录失败。通过记录事件，您可以创建应用程序内部操作和状态的图片。因此，您的代码应该记录您想要测量或跟踪的任何事件。没有理由为了节省空间或保持信噪比而删减消息。像 ElasticSearch 这样的日志管理系统让你很容易找到你要找的东西。在您的基础设施中添加一个，并使用类似于 [Raygun 的崩溃报告](https://raygun.com/platform/crash-reporting)的错误报告来处理专门系统中的错误日志和异常，以便进行分析。

同样重要的是识别日志消息中的内容。Wiggins 似乎建议根本不要使用任何日志库。但是，在没有上下文的情况下将消息记录到标准输出不是一个有效的策略。大多数日志 API 都添加了时间、严重性级别和上下文，比如类或源文件名。还可以将它们定向到标准输出或可以由外部应用程序(如 LogStash 或 FluentD)处理的文件。所以，这使得他们值得考虑。

确保日志消息对每个人都有用也很重要，而不仅仅是对开发人员。因此，与运营和其他开发团队合作处理消息内容是至关重要的一步。

## 健康检查

日志有助于告诉你事情何时发生，何时顺利，何时出错。它们可以被监控系统读取，然后用来触发警报。日志记录是被动的，而不是主动的。完整的监控解决方案具有主动机制。

开发人员可以通过健康检查为应用程序添加主动监控。这些检查是监控系统定期探测服务的一种机制。根据结果，他们通过警报报告状态，并在仪表板上显示。

这些检查可以从返回一个固定值(如“up”或“down ”)到操作的结果。例如，支票可以模拟实时交易。在我们的图书销售示例中，每个服务可能都支持一种方法来模拟其在事务中的步骤，例如将一本书添加到模拟购物车中，或者操纵目录中不存在的一本书的库存水平。这种健康检查验证服务的健康状况以及它们所依赖的基础设施。因此，他们可以在客户发现问题之前提供一个了解问题的窗口。

识别这些健康检查应该是应用程序开发的设计和构建阶段的一部分。

## APM 和仪器仪表

开发人员可以通过构建和发布带有提供检测的库的代码来添加应用程序性能监控。其中一些监控系统使用自己的仪表板，因此集成服务意味着与运营部门合作。他们可能还需要在服务器上安装额外的软件来收集数据。尽管需要额外的协调和安装工作，但这些工具为主动发现问题和提高系统性能提供了有价值的信息。

例如，Raygun 的 [APM](https://raygun.com/platform/apm) 和[错误和崩溃报告](https://raygun.com/platform/crash-reporting)提供了一个与目标应用程序链接的库。这些库向 Raygun 的平台报告相关的统计数据、日志和其他数据，以用于报告和图表。

## 应用程序设计包括监控

开发人员需要在系统监控中扮演积极的角色。在 QA 发布应用程序后对其进行改造以进行监控，这在微服务系统中是行不通的。监控需求应该被考虑到应用程序设计中，并像业务需求一样对待。微服务架构给予开发团队很大的独立性和自主性，但是就像在任何其他情况下一样，强大的能力意味着巨大的责任。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>