# Kubernetes 安全最佳实践，让您远离新闻

> 原文：<https://thenewstack.io/kubernetes-security-best-practices-to-keep-you-out-of-the-news/>

[](https://twitter.com/thedevelopnik)

 [大卫·苏迪亚

大卫是一名教育家，后来成为开发人员，后来成为开发工程师。他热衷于通过确保其他开发人员拥有正确的工具和环境来支持他们做最好的工作。在他的日常工作中，他负责管理 Kubernetes 集群、部署数据库、编写实用程序，并且通常是一把瑞士军刀。他可以在推特@thedevelopnik](https://twitter.com/thedevelopnik) [](https://twitter.com/thedevelopnik)上找到

乍一看，Kubernetes 看起来非常强大，好像它能解决你所有的问题。(解决了很多！)但是任何从事 it 工作的人都知道事情会变得多复杂。Kubernetes 安全公司也不例外。

Kubernetes 默认是*不*安全的。有多种攻击途径，并且经常发现[CVE](https://unit42.paloaltonetworks.com/cve-2020-8558/)。虽然开始时可能会感到力不从心，但您可以实施一些具体的策略来保护您的服务和基础架构，并使您的组织远离头条新闻。了解您要保护的管道的主要组件，然后了解如何保护它们。

首先，让我们了解一下您要保护的生态系统。

*   **集装箱**。Kubernetes 是一个容器编排系统。因此，任何保护 Kubernetes 的尝试都必须包括保护它所部署的容器，包括构建和部署它们的管道。
*   **Linux 和 Windows** *。*容器通常包含一个操作系统(OS ),此外还有为部署 Kubernetes 的服务器或虚拟机提供支持的操作系统，因此我们必须讨论如何保护操作系统，无论是 Linux、Windows 还是两者都有。
*   **Kubernetes**。 Kubernetes 本身既是一个 API 服务器，也是一个网络内的分布式代理系统和 etcd 数据库——所有这些都需要得到保护。

使用一个托管的 Kubernetes 解决方案，比如每个主要(和次要)云提供商提供的解决方案，通常可以得到更好的默认配置，或者更容易管理的特性；但是，如果没有选择正确的选项，它们都没有内在的安全性。

例如，对任何 Kubernetes 集群进行身份验证的最安全的方法是使用 OAuth。但是一般来说，默认情况下，通过私有客户端证书文件和/或用户名和密码的认证都是开启的。相反，配置一个支持网络策略的容器网络接口(促进 Kubernetes 网络上的容器和 pod 通信的内部服务)可能是一件麻烦的事情，但是大多数托管产品都让它成为一个点击按钮的选项。

让我们看看如何依次保护这些组件。

## **集装箱**

需要安全地构建容器，并且部署的容器映像必须是[信任的，可以在系统中运行](https://blog.paloaltonetworks.com/prisma-cloud/cloud-container-image-trust-groups/)。

### **大厦**

构建安全容器需要扫描它们的漏洞——包括 Linux 系统包，以及 Python 或 Ruby 等动态语言的应用程序包。应用程序开发人员可能习惯于扫描应用程序依赖性，但现在他们的应用程序附带了一个完整的操作系统，他们也必须在保护操作系统方面得到支持。

为了大规模支持这项工作，可以考虑使用类似于 [Cloud Native Buildpacks](https://buildpacks.io) 的工具，它允许平台或运营团队制作标准化的容器构建，开发人员可以使用这些构建来放置他们的应用程序，完全取代项目的 docker 文件。这些集中的构建可以保持最新，这样开发人员就可以专注于他们擅长的事情，而不必成为万能的开发人员。

容器映像扫描工具扫描已构建映像的各层，以发现已知的漏洞，这对于保持您的构建和依赖关系最新是必不可少的。它们可以在开发期间和 CI 管道中运行，以将安全实践转移到左边，让开发人员最早注意到漏洞。最佳实践是将容器精简到运行应用程序所需的最低限度。毁掉攻击者一天的好方法是拥有一个没有外壳的容器！

### **签约**

现在你已经建立了安全的容器。但是，您如何确定您构建的容器是真正放入集群的容器呢？Docker 支持使用密钥对图像进行签名，然后可以在提取和部署时对密钥进行认证。对容器进行签名类似于向端点添加 TLS 证书；它允许您验证您正在拉取的容器图像与您推送的容器图像完全相同，从而防止了中间人攻击。要做到这一点，你需要让推拉双方的系统都知道同一个键。当我们检查许可控制器时，我们将在下面看到如何防止未签名的映像部署到您的集群中。

## **Linux**

您的容器可能运行 Linux 或 Windows，Kubernetes 可能也在其中一个上运行容器，因为它支持 Linux 和 Windows 工作节点的混合。为了确保您的系统是安全的，您仍然必须做传统的工作，确保服务器仅在必要时公开，SSH 凭证是安全的，操作系统库是最新的，并且用户和组权限是锁定的。如果攻击者能够访问您的主节点或工作节点，他们就很容易破坏 Kubernetes 系统的任何部分——无论是 API 还是 kubelet 代理。即使在云环境中，仍然需要优秀的系统管理员工作，无论你是委托给云提供商还是自己做。

## **Kubernetes**

完全保证 Kubernetes 的安全可以而且已经写了一本书，但是对于这次讨论，最关键的方面是基于角色的访问控制(RBAC)、准入控制器和网络策略。此外，[云本地安全平台](https://www.paloaltonetworks.com/prisma/cloud)可以帮助填补攻击者喜欢挤过的小缺口。

### **RBAC**

在您的集群中，谁可以做什么？基于角色的访问控制(RBAC)回答了这个问题。Kubernetes 提供了在集群整体和给定名称空间中为用户和服务帐户授予特定权限的能力。一些示例用例是允许所有团队查看彼此的应用规范，但只能在他们专用的名称空间中修改这些规范，或者允许您的 CI/CD 管道代理将东西部署到生产中，只有少数经过审查的个人可以删除那里的东西。这些将因组织而异，但是[主动管理](https://www.paloaltonetworks.com/prisma/cloud/identity-access-management-security) RBAC 对于安全集群至关重要。

### **准入控制器**

准入控制器(AC)是实现完全 Kubernetes 安全性的唯一途径。ACs 阻止容器在集群中被调度和运行，除非它们的 pod 规格满足[某些标准](https://blog.paloaltonetworks.com/prisma-cloud/open-policy-agent-support/)。有很多种 AC，但有两种是值得注意的:PodSecurityPolicy AC 和任何验证签名图像的 AC。

PodSecurityPolicies(PSP)站在攻击者和 Kubernetes 系统最易受攻击的方面之间。例如，Kubernetes 中的容器可以请求使用“hostPath”类型的卷在底层主机上挂载任何路径，比如 Docker 套接字。安装了 docker 套接字的容器可以在没有特权状态的情况下，以 root 用户身份在主机上运行任何 docker 命令。太可怕了。防止这种情况的唯一*方法是 PSP 不允许主机路径卷。PSP 设置还可以防止其他一些严重的攻击途径。如果你只做一件事来保护你的集群，那就是创建 PSP 并启用 PSP 准入控制器。*

前面，我们讨论了如何对容器图像进行签名以建立信任链。这个链条是如何完成的？使用[开放策略代理](https://www.openpolicyagent.org/) (OPA) AC，您可以在允许每个容器映像进入您的集群之前对其进行有效签名检查。[这是一个很好的指南](https://medium.com/@siegert.maximilian/ensure-content-trust-on-kubernetes-using-notary-and-open-policy-agent-485ab3a9423c#97b0),关于如何使用[公证](https://github.com/theupdateframework/notary)和 OPA 一起建立从构建到部署的完整信任链。

### **网络策略**

Kubernetes 网络策略就像集群的内部防火墙规则，这应该说明了它们的重要性。它们允许管理员针对以下情况配置群集:

*   一个名称空间只能与其依赖项所在的另一个名称空间对话。
*   外部流量只能到达一个 API 网关容器，而不能到达其他容器。
*   阻止从除 DNS 注册表之外的所有容器的出口。

网络策略的主要限制是群集使用的容器网络接口(CNI)必须支持它们。如果您正在管理自己的集群，而不是使用云提供商管理的解决方案，您将需要研究可用的 CNI，以了解哪些为您的网络提供了网络策略支持。

### **云原生安全平台**

安全格局总是在变化，在云原生空间中变化更快，因为它正以令人难以置信的速度发展。即使上述所有步骤都已就绪，也有必要对您的实时运行时进行检查，以发现异常和违规迹象。像 [Prisma Cloud](https://www.paloaltonetworks.com/prisma/cloud) 这样的平台可以提醒您这种异常，并可以主动阻止意外进程的运行和网络连接的建立。

本文列出了一些依次解决每个问题的开源项目，但是当涉及到 Kubernetes 安全性时，“构建还是购买”的权衡会很快转向“购买”对于小型组织来说，维护所有这些工具可能会很麻烦；对于大型组织来说，大规模运行它们会让团队陷入困境，消耗宝贵的时间和资源。一个功能全面的平台通常可以节省员工的时间，并通过更容易地将安全性推向左侧来减少对专门安全团队干预的需求。

## **资源**

为了更深入地了解库伯内特的攻击面，[伊恩·科尔沃特](https://www.youtube.com/watch?v=HmoVSmTIOxM)的黑帽演示非常出色。YouTube 上的感谢上帝是 Kubernetes (TGIK)播客对各种 Kubernetes 主题进行了 1-2 小时的深入探讨，包括与 Kubernetes 安全相关的多集。

Kubernetes 安全是一个旅程，而不是一个目的地。希望本指南已经给了你开始使用它的工具。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>