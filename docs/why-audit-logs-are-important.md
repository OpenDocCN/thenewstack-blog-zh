# 为什么审计日志很重要

> 原文：<https://thenewstack.io/why-audit-logs-are-important/>

审计日志是描述系统随时间变化的不可变记录。发生的每个事件和尝试都应该记录在日志中，说明发生了什么、发生的时间以及涉及的用户。

有效的审计日志记录会创建一个审计跟踪，按顺序记录系统的活动。这些信息对于合规性、调试和安全漏洞调查来说是无价的。

本文将教您什么是审计日志，并解释为什么它们对于生产环境是必不可少的。

## 什么是审计日志？

审核日志是影响系统状态或行为的事件的集中存储记录。每个记录都是一个单一变化的历史足迹。它记录事件和关于它是如何被启动的上下文信息。日志还可以包含有关事件发生原因的信息。

以下数据字段通常作为审核日志事件的一部分进行跟踪:

*   发生的事件的类型。
*   触发的时间。
*   发起事件的客户端的标识，如用户 ID 或 API 令牌。
*   有关客户端设备的详细信息，如其 IP 地址，以跟踪事件的来源。
*   特定于事件的对系统中相关数据的引用，例如由事件修改的任何实体的 id。

用户授权检查的审计日志条目可能如下所示:

```
|  Field  |  Value  |
|-------|-------|
Type of event  |  `Authorization`
Timestamp  |  `2022-12-01  12:00:00`
Principal ID  |  `demo@example.com`
Resource ID  |  `INV-1001`
Action  |  `view`
Policy  |  `resource.invoice.v1`
Result  |  `DENY`

```

担心授权失败激增的管理员可以参考审计日志作为调查的一部分。他们会看到演示用户试图使用需要`CreateNewUser`角色的特性，但是系统拒绝了他们的访问。如果没有审计日志，就不会有这个潜在问题请求的记录。

## 审核日志与应用程序日志

与应用程序代码编写的系统日志相比，审核日志有不同的目的和目标受众。虽然这些日志通常旨在帮助开发人员调试意外的技术错误，但审计日志主要是用于监控系统操作的合规性控制。他们对[监管团队](https://thenewstack.io/authorization-in-the-context-of-soc-2-and-other-certifications/)、系统管理员和安全从业者很有帮助，他们需要检查是否遵循了正确的流程。

审计日志的存储和保留方式也有所不同。它们通常比应用程序日志保存更长的时间，应用程序日志不太可能在问题解决后保存。因为审核日志是一种历史记录，所以如果有可用的存储空间，它们可以无限期保留。这使你能够调查事件发生几年后才曝光的事件。

审计日志中的信息通常属于三个主要类别之一:

*   **信息事件和通知**–这些事件包括登录系统和访问特定数据。
*   **状态更改事件**–您的系统状态会因创建新用户、分配权限或开具发票等操作而发生改变。通过审计事件跟踪每个更改，可以让您了解系统是如何达到其当前状态的。
*   **系统事件**–这些事件与系统的内部操作直接相关。流程完成时会记录事件，例如刷新电子邮件假脱机或删除过期的 API 令牌，因此您可以检查这些活动是否已成功完成。

这些示例显示了审计事件如何与系统的业务功能直接相关。参与您项目的任何人都应该能够理解其审计跟踪中的数据。这种可访问性与通常只对开发人员有用的应用程序日志形成对比。由于他们关注代码中的错误，应用程序日志往往是技术性的、冗长的和低级的。

## 授权与身份验证日志

审计日志是监控和调查[认证和授权](https://thenewstack.io/how-do-authentication-and-authorization-differ/)模式的重要工具。[区分这些术语很重要，这样你就知道每个日志包括什么以及何时访问它们:](https://cerbos.dev/blog/what-is-cerbos)

*   **认证**–认证验证一个人是否是他们所声称的那个人。用户通常在登录时通过输入用户名和密码进行身份验证。
*   **授权**–授权决定一个已知的个人是否可以执行特定的动作。登录后，用户已经过身份验证，但他们每次尝试创建新用户、分配权限或访问敏感资源时仍需要获得授权。

审核日志条目提供的信息会因记录是否与身份验证或授权相关而异。如果是身份验证尝试，请求将发生在公共会话的上下文中。由像 [Cerbos](https://cerbos.dev) 这样的 AuthZ 服务编写的授权日志将包括登录用户的身份。

评估这两种类型的日志将暴露最大范围的攻击。暴力凭据猜测尝试将在审核跟踪中显示为失败的身份验证。同时，用户被拒绝授权的峰值可能表示他们的 API 令牌已被攻击者拦截。

## 如何实现审计日志记录

每次发生重大事件时，您的应用程序都应该写审计日志。最简单地说，审计日志就是一个文件或数据库表，当每个事件发生时，都会在其中添加一条新记录。要生成审计事件，需要捕获与您的系统相关的信息，然后用发生的事件类型来标记它。

审计日志可以以几种不同的格式存储:

*   **纯文本**–CSV 等格式的纯文本审计日志是最简单的入门方式，但使用日志索引工具可能会有挑战性。
*   **JSON**–以 JSON 格式存储审计日志使得其他工具更容易解析它们。然而，JSON 文件缺少模式，并且相对较大，这使得处理起来很麻烦。
*   **proto bufs**–[协议缓冲区](https://developers.google.com/protocol-buffers)是一种新兴的解决方案，用于[将审计日志记录等结构化数据](https://thenewstack.io/cerboss-secret-ingredients-protobufs-and-grpc/)序列化为紧凑类型的格式。它们通常比等效的 JSON 小，同时允许您规定`EventName`始终是一个字符串，而`EventTimestamp`是一个有效的时间。
*   **在数据库表内**–您可以将审计日志存储在关系数据库或基于文档的数据库内。此方法允许您使用熟悉的查询方法来搜索和过滤审计数据。但是，请考虑将审计数据库与主数据库分开，以防止危害主数据库的攻击者能够修改旧的审计事件。

您还可以选择将审计事件发送到哪里进行索引和消费。手动与上述任何一种方法交互都是笨拙且容易出错的。设置专用日志查看器可以方便地访问您的记录:

*   **将审计日志流式传输到 stdout–**如果您使用具有一致结构的 JSON 等格式，最常见的日志聚合工具，如 [Fluentd](https://www.fluentd.org) 和 [Elastic](https://www.elastic.co) 可以收集直接写入应用程序标准输出流的日志。然而，这并不总是可行的，例如，如果您已经将应用程序日志输出到了 stdout。
*   **用 Logstash 收集日志—**[Logstash](https://www.elastic.co/logstash)是弹性套件的一部分。它是一个数据收集器，可以从许多不同的来源读取日志，包括本地文件、数据库中的事件和发送到 HTTP webhook 或 websocket 的请求。一旦数据被接收，它将被转发到您首选的日志聚合器。
*   **查看日志—**[Datadog](https://docs.datadoghq.com/logs)和 [Grafana](https://grafana.com/logs) 是两种流行的聚合、浏览和搜索日志数据的工具。一旦从系统中获取了审计日志，就可以使用这些应用程序按属性(如类型和时间跨度)查询事件。

选择一个足够灵活的处理管道来处理审计日志。偶尔删除错误日志是可以接受的，但是失败的审计日志写入可能会改变未来合规性调查的结果。例如，如果没有重试提交的机制，将日志从应用程序提交到 HTTP webhook 是有风险的。网络中断时发送的事件将会不可挽回地丢失。

## 为什么审计日志很重要

审核日志通过证明是否执行了某些操作，使您能够保持合规性。当您需要证明您已经满足监管框架(如 [ICO 27001](https://www.iso.org/isoiec-27001-information-security.html) 或 [SOC2)的要求时，能够检索特定用户发起的或在特定日期发生的更改序列是至关重要的。](https://soc2.co.uk)

选择生成审计日志的技术将确保您手头总是有您需要的信息。例如，PCI DSS 审计可能会导致关于谁访问了支付信息及其请求的上下文的问题。如果您使用 Cerbos 作为您的授权平台，您可以[检索其审计日志](https://docs.cerbos.dev/cerbos/latest/api/admin_api.html)并列出与支付访问相关的“接受”决策。

审计日志和法规遵从性的另一个方面是提供发生违规的法律证据的能力。如果没有审计日志，违规行为可能几个月或几年都不会被发现，并且其存在的任何迹象都可能是不确定的。详细的审计跟踪会告知何时需要通知客户和监管机构。它可以向保险公司证明确实发生了违规行为，或者通过展示您系统的完整性来为诉讼辩护。

审计日志还允许您重建导致意外行为或安全违规的事件。观察到问题后，您可以访问审计日志，并在新的开发环境中重复记录的操作。这有助于重现漏洞，并识别攻击者是如何获得访问权限的。然而，审计日志通常不包含精确的技术数据，因为它们专注于回答关于谁在系统中做了什么的业务查询。仍然需要应用程序级日志来揭示处理用户操作的特定代码路径。

最后，一个健壮的审计日志实现会让您发现系统中的关键点，这些点对您组织的过去和未来的运营都有影响。每个审计事件都增强了责任性，提供了对变化的可见性，并帮助您识别潜在的风险。他们向开发商、法律团队、客户和监管机构证明，你在主动管理风险。

## 结论

审计日志创建了一个独立于系统当前状态的历史记录。管理员和合规团队可以使用审计日志来调查用户操作、发现可疑活动并遵守监管框架。

全面的审计日志对于应用程序的授权请求尤其重要。 [Cerbos 的开源授权平台](https://cerbos.dev/product-features#full-audit-logs)提供了对传入请求及其相应响应的全面可见性，解释了为什么做出具体的允许或拒绝决定。这使您能够保持合规并识别可疑行为。审计日志可以从 [Cerbos admin API](https://docs.cerbos.dev/cerbos/latest/api/admin_api.html) 中检索，或者写入 JSON 文件或标准输出流，准备好转发给日志聚合平台。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>