<html>
<head>
<title>How Google Turned Kubernetes into a Control Plane to Manage GCP Resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌如何将Kubernetes变成一个控制平面来管理GCP资源</h1>
<blockquote>原文：<a href="https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/#0001-01-01">https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/#0001-01-01</a></blockquote><div><div id="tns-post-body-content">


<p class="translated">大约一年前，我写了一篇<a href="/how-kubernetes-is-transforming-into-a-universal-scheduler/" target="_blank">文章</a>强调了Kubernetes向通用控制平面的转变。云原生社区一直在朝着这个方向稳步前进。</p>
<p class="translated"><a href="/kubernetes-1-15-aims-to-extensibility-with-custom-resource-definition-features/" target="_blank">定制资源定义</a> (CRDs)的成熟使得将外部资源管理纳入Kubernetes范围成为可能。微软的<a href="https://thenewstack.io/tutorial-kubernetes-for-orchestrating-iot-edge-deployments/" target="_blank" class="local-link">虚拟Kubelet </a>项目试图在Kubernetes控制平面和外部资源调度程序(如物联网中心和容器实例)之间架起一座桥梁。KubeVirt通过Kubernetes调度器和控制器实现了虚拟机的编排。</p>
<p class="translated">谷歌正在大力推动Kubernetes成为谷歌云平台(GCP)的前沿和中心。其基于Anthos的混合云战略围绕Kubernetes展开。Migrate for Anthos将工作负载直接转移和转换到在Google Kubernetes引擎(GKE)中运行的容器中。</p>
<blockquote><p class="translated">尽管Config Connector是为GKE设计的，但它可以很容易地安装在任何Kubernetes环境中。</p></blockquote>
<p class="translated">在Kubernetes引擎和相关产品上投入如此之多，谷歌希望GKE成为云原生和传统运营的首选管理层。它正缓慢但稳步地向使Kubernetes成为GCP运营和管理的前沿和中心迈进。<a href="https://cloud.google.com/config-connector/docs/overview" target="_blank" rel="noopener noreferrer external " class="ext-link"> Config Connector </a>是Kubernetes最近推出的一个插件，旨在使GCP资源成为云原生世界的一流公民:查看我上周的教程，在那里<a href="https://thenewstack.io/tutorial-use-google-config-connector-to-manage-a-gcp-cloud-sql-database/" target="_blank" class="local-link">我演示了如何安装和使用Config Connector来管理Minikube </a>的GCP资源。</p>
<p class="translated">尽管Config Connector是为GKE设计的，但它可以很容易地安装在任何Kubernetes环境中。我可以使用运行在我的开发机器上的Minikube作为控制平面，在GCP配置和提供一个云SQL实例。</p>
<p class="translated">当Azure和AWS等其他云提供商正在使用开放服务代理API将云资源连接到Kubernetes时，Google已经<a href="https://cloud.google.com/kubernetes-engine/docs/concepts/google-cloud-platform-service-broker" class="ext-link" rel="external ">弃用</a> it，转而支持Config Connector。</p>
<p class="translated">Config Connector利用CRD来注册映射到各种GCP资源的自定义对象。每个GCP服务，比如Cloud Spanner、Cloud SQL、Cloud Pub/Sub，都被公开为一个自定义资源定义，可以像对待任何其他Kubernetes对象一样对待。熟悉的kubectl工具可以用来操作这些对象。</p>
<p class="translated">Config Connector利用GCP原语(如服务帐户)结合Kubernetes原语(基于角色的访问控制(RBAC)和secrets)的方式非常有趣。以下步骤解释了向Kubernetes注册GCP资源所涉及的工作流程:</p>
<ol>
<li class="translated">在GCP创建了角色为“所有者”的IAM服务帐户</li>
<li class="translated">服务帐户密钥(一个JSON文件)作为秘密向Kubernetes注册</li>
<li class="translated">配置连接器作为一组CRD安装在专用的Kubernetes名称空间中</li>
<li class="translated">在Kubernetes中创建了一个与GCP项目名称相匹配的新名称空间</li>
<li class="translated">映射到CRD的GCP资源在YAML文件中定义，并通过kubectl创建</li>
<li class="translated">可以在Kubernetes中创建附加角色和角色绑定，以允许或限制对GCP资源的访问</li>
<li class="translated">如果资源依赖于其他资源，则可以在YAML定义中引用它们</li>
</ol>
<p class="translated">IAM所有者角色和关联的服务帐户密钥为外部应用程序提供了与GCP对话所需的权限。当这个密钥作为一个秘密在Kubernetes注册时，CRDs使用它来访问与GCP资源相关联的API。这个秘密是充当库伯内特和GCP控制平面之间管道的关键环节。</p>
<p class="translated">谷歌创建了一组CRD，映射到关键的GCP服务，如云存储、云SQL、云扳手、BigQuery，甚至GKE。注册CRD的YAML文件可以通过kubectl create命令下载并部署到任何Kubernetes集群中。</p>
<p class="translated">我们可以用下面的命令列出所有注册的CRD:<br/></p>
<div id="crayon-6422f926717b5281185249" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre>  
 
<span class="crayon-e">kubectl </span><span class="crayon-e">get </span><span class="crayon-i">crds</span><span class="crayon-h"> </span>--<span class="crayon-e">selector </span><span class="crayon-i">cnrm</span><span class="crayon-st">.</span><span class="crayon-i">cloud</span><span class="crayon-st">.</span><span class="crayon-i">google</span><span class="crayon-st">.</span><span class="crayon-i">com</span>/<span class="crayon-i">managed</span>-<span class="crayon-i">by</span>-<span class="crayon-i">kcc</span>=<span class="crayon-v">true</span>
</pre>
</div>
</div>

<p class="translated"><br/><a href="https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/cnrm/" rel="attachment wp-att-8437393" class="local-link"><img decoding="async" loading="lazy" class="aligncenter" src="../Images/ea93bece99b3914fa2e1a3d434b97c78.png" alt="" data-id="8437393" data-original-src="https://cdn.thenewstack.io/media/2019/08/b2a3e0ea-cnrm-1024x815.png"/></a><a href="https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/cnrm-sql/" rel="attachment wp-att-8437392" class="local-link"><br/>T7】</a></p>
<p class="translated">Google强制执行一个约定来匹配Kubernetes名称空间和GCP项目id。如果不想创建新的名称空间，也可以对现有的名称空间进行注释，这样配置连接器就可以在指定的名称空间中创建对象。</p>
<p class="translated">一旦完成以上所有步骤，我们就可以创建包含GCP资源定义的YAML文件。下面的YAML在美国中部地区创建了一个名为storedb-instance-1的云SQL实例。您可以看到诸如region和tier之类的参数是如何从YAML文件传递过来的。</p>
<p class="translated"><a href="https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/cnrm-sql/" rel="attachment wp-att-8437392" class="local-link"><img decoding="async" loading="lazy" class="aligncenter" src="../Images/c5227f162af428006139eb969887d5fa.png" alt="" data-id="8437392" data-original-src="https://cdn.thenewstack.io/media/2019/08/08ca43c1-cnrm-sql-1024x679.png"/>T2】</a></p>
<p class="translated">类似于用kubectl apply修改Kubernetes对象，GCP资源也可以更新。例如，您可以修改YAML文件来更改SQL数据库实例的区域，并应用新定义。该操作调用相应的云SQL API将数据库移动到新的区域。</p>
<p class="translated">一旦数据库实例启动并运行，我们需要创建一个用户来访问数据库。配置连接器允许对象通过引用现有资源来指定依赖关系。下面的YAML文件为上面的云SQL实例创建了一个<strong> DB用户</strong>。</p>
<p class="translated"><a href="https://thenewstack.io/how-google-turned-kubernetes-into-a-control-plane-to-manage-gcp-resources/cnrm-sql-user/" rel="attachment wp-att-8437391" class="local-link"> <img decoding="async" loading="lazy" class="aligncenter" src="../Images/806879d8170778956f9f34676a0e42d3.png" alt="" data-id="8437391" data-original-src="https://cdn.thenewstack.io/media/2019/08/cb6b4208-cnrm-sql-user-1024x644.png"/> </a></p>
<p class="translated"><em>贾纳基拉姆·MSV的网络研讨会系列“机器智能和现代基础设施(MI2)”提供了涵盖前沿技术的信息丰富、见解深刻的会议。在<a href="http://mi2.live/" target="_blank" rel="external noopener noreferrer " class="ext-link"> http://mi2.live </a>注册参加即将举行的MI2网络研讨会。</em></p>


<div class="tns-logo-slug">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 68 31" version="1.1">
<title>Group</title>
<desc>Created with Sketch.</desc>
<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
<g id="Group">
<path d="M24.002,29.619 L29.77,29.619 L29.77,15.808 C29.77,15.038 29.622,11.265 29.59,10.414 L29.77,10.414 C31.424,14.019 31.473,14.147 32.168,15.322 L39.65,29.618 L44.845,29.618 L44.845,0 L39.075,0 L39.075,11.064 C39.075,12.197 39.075,12.44 39.182,14.472 L39.325,17.468 L39.151,17.468 C39.034,17.267 38.596,16.173 38.467,15.929 C38.164,15.323 37.725,14.512 37.373,13.905 L30.031,0 L24,0 L24,29.619 L24.002,29.619 Z" id="Path-Copy" fill="#FF3287"/>
<path d="M56.948,0 C50.745,0 47.606,3.43 47.606,8.296 C47.606,14.114 51.036,15.404 55.518,17.132 C60.438,18.853 61.782,19.332 61.782,21.539 C61.782,24.225 58.969,24.867 57.401,24.867 C54.579,24.867 52.493,23.342 51.536,20.858 L47,24.185 C49.43,28.937 52.145,30.185 57.713,30.185 C59.364,30.185 62.059,29.74 63.727,28.694 C67.779,26.156 67.779,22.22 67.779,20.898 C67.779,18.129 66.531,16.207 66.178,15.726 C65.049,14.121 63.032,12.918 61.25,12.278 L57.084,10.914 C55.073,10.267 52.928,10.105 52.928,8.019 C52.928,7.707 53.008,5.528 56.288,5.319 L61.465,5.319 L61.465,0 C61.465,0 57.342,0 56.948,0 Z" id="Path-Copy-2" fill="#00AFF4"/>
<polygon id="Path" fill="#00AFF4" points="5.32907052e-15 1.77635684e-15 5.32907052e-15 5.319 7.572 5.319 7.572 29.564 14.132 29.564 14.132 5.319 21.544 5.319 21.544 1.77635684e-15"/>
</g>
</g>
</svg> </div>
</div>
</div>    
</body>
</html>