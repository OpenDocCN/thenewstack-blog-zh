# CloudFlare JavaScript Workers 和多云

> 原文：<https://thenewstack.io/cloudflare-javascript-workers-and-multicloud/>

服务器端 JavaScript 并不新鲜；自从在 web 浏览器这样的客户端中运行 JavaScript 以来，它就一直存在。Node.js 的流行使得服务器上的 JavaScript 再次流行起来，特别是对于像没有任何用户界面的服务工作者这样的结构。服务人员可以拦截对您站点的 HTTP 请求并过滤它们，或者提出子请求、组合或有条件地路由这些请求，并返回您想要的任何最终响应。

Cloudflare Workers 结合了另一种有趣的方法；Workers 是一个运行用 JavaScript 编写的无服务器应用程序的框架，使用 W3C 标准的 [Service Workers API，](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)在一个基于 V8 JavaScript 引擎的环境中运行(但不是 Node.js，因为那样会失去久经考验的 V8 沙箱的优势)。

Cloudflare 首席执行官[马修·普林斯](https://twitter.com/eastdakota)告诉新堆栈:“我们认为工人的方式是大规模分布式的无服务器。“你写代码，它就存在于任何需要它的地方；你甚至不应该去想它。你需要一个能够以编程方式做出智能路由决策，并将代码路由到正确位置的网络。”

该 V8 环境运行在 Cloudflare 的服务器上，在一个高度分布式的基础架构中，将代码放在边缘。该公司目前在全球拥有 152 个数据中心，并计划在年底前将这一数字扩大到 200 个，所有这些数据中心都位于大型人口中心，以便在网站将其用作 CDN 或 DDOS 保护时实现最低延迟。

在 Cloudflare 数据中心的服务器上运行服务人员代码可以节省用户下载代码所需的时间和带宽，这一点非常重要，因为这对于连接性较差的位置以及像物联网系统这样受处理能力或电池寿命限制的设备来说非常重要，而不仅仅是将工作负载转移到您自己的服务器上。

> 真正的多云系统的问题不仅仅是移动工作负载，还有数据。

Cloudflare 已经充当了一个反向代理:到您站点的流量通过 Cloudflare 基础架构路由，该基础架构将请求传递到您的站点，并收集响应以提供给访问者。Workers 是实现负载平衡、安全过滤、从特定位置重定向访问者、净化和验证数据(例如，在请求到达服务器之前删除重复内容并拒绝格式错误的请求)或添加自定义逻辑以选择缓存哪些请求的简单方法。

因为服务工作者实现端点和事件处理程序，而不是请求和响应挂钩，所以它们是异步的，甚至可以操纵缓存。工作人员可以使用 Fetch API 从多个服务并行获取和组合内容(暂时限制为 50 个子请求，但很快就会取消)，或者直接响应请求，而无需连接到任何服务器。响应体中支持流 API。您可以使用 event.waitUntil()来设置异步任务，这些任务在 worker 向最终用户发送第一个响应后继续执行(对于日志记录和分析非常有用)。

您还可以使用它们来部署针对 bug 的[快速修复，而无需重启服务器(因为您可以将访问者路由到正确的代码)，或者用于开发人员在现场测试一个特定的服务，而无需向普通访问者公开，然后用于 A/B 测试，并将流量转移到一个新的服务，这样您就可以在没有任何影响的情况下关闭一个旧系统。](https://www.troyhunt.com/seamless-a-b-testing-deployment-slots-and-dns-rollover-with-azure-functions-and-cloudflare-workers/)

通过在浏览器之外运行 JavaScript，您还可以获得更多的灵活性和安全性选项，因为您可以在边缘执行身份验证。工作人员可以使用签名的 URL 或预先验证用于向 APIs REST 服务认证的 JSON Web 令牌来限制对云存储桶的访问，因此浏览器永远不会看到您的 API 密钥。它还简化了 CORS(跨源资源共享)的处理。

最初，Workers 仅支持 JavaScript，每百万次请求的费用为 0.50 美元(每月最低 5 美元)，但 Cloudflare 将使用 WebAssembly 添加对 C/C++的支持。

## 编制云

Prince 有一些雄心勃勃的想法，利用 Kubernetes 等新兴平台，利用工人来编排跨云工作流。他解释说，多云并不是在不同的云上有不同的应用程序；它在多个云中运行相同的应用程序，要么是为了可用性和可靠性，要么是为了利用更便宜的计算选项。“随着每个云提供商的功能集达到对等，通过 Kubernetes 等，您可以拥有一个跨他们的标准化平台。员工可以提供帮助，确保您获得跨提供商的超高性能和高度可用性。”

一家 Y Combinator 初创公司正在使用 Cloudflare 工作人员在不同的云提供商之间转移工作负载，这些云提供商为他们提供免费积分来试用他们的服务。普林斯告诉我们:“他们编写了一个工人，向 API 查询他们的账户上还有多少余额，当余额烧到零时，他们会切换到另一个云服务。”同样的想法可以让你将新的工作负载放在最便宜的云上，同时跟上价格的变化。“当有请求时，工作人员可以跨不同云查看计算机的现货价格。”

他建议说，这对于策略需求也很有用，比如在特定位置存储数据。“如果您有内部政策要求，即来自德国的所有用户数据都必须存储在法兰克福，您可以让网络智能地做出这些具有精细控制的路由决策。”

真正的多云系统的问题不仅仅是移动工作负载，还有数据。“我们开始更多地考虑存储，以及如何确保人们不会被存储方面的大型云提供商所束缚，”普林斯告诉我们。

“在网络边缘运行一个 S3 兼容的对象存储将是非常简单的；你可以说‘我希望这些数据存储在这两个不同的云提供商之间，或者存储在目前价格最优惠的两个云提供商之间，我们可以处理后勤工作。该结构将四处移动数据，因此数据存储将是您在特定时间需要它的位置。如果您移动了您的计算，我们可以在应用程序用户实际运行它的地方提供数据。"

他承认，工人们还没有一个好的数据存储解决方案。“这就是仍然缺失的那一部分。我们可以建立一个数据存储库，但目前还不太现实，这取决于我们如何缓存数据。”

工作线程在请求到达 Cloudflare 的缓存之前运行，因此工作线程的响应不会被缓存，但是任何使用 Fetch API 的传出子请求都会经过缓存。这包括不使用 Cloudflare 的网站(只要这些服务器返回正确的缓存头), Cloudflare 正在通过 Workers 对缓存进行更细粒度的控制。从长远来看，Prince 建议 Cloudflare 可以建立一个分布式数据服务，可以跨多个云后端工作。

在这种情况发生之前，云提供商将不得不放弃他们的数据出口费用，但普林斯相信这将会发生。“因为归根结底，提供商必须公平对待客户。当微软向 Cloudflare 发送数据时，它会通过一条 50 米长的光缆从他们的路由器传输到我们的路由器；我们都不为此买单，为什么我们的客户要为此买单？”

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>