# 无服务器开发被破坏了——修复方法如下

> 原文：<https://thenewstack.io/serverless-development-is-broken-heres-the-fix/>

为无服务器应用程序编写代码非常困难。原因如下。

无服务器在某种程度上是一种运营创新。对于运营团队来说，它可以大大简化工作流程。但是目前，对于那些必须编写代码才能让它工作的人来说，无服务器提供的体验很差。本文详细探讨了问题所在，并提出了解决方法。

## 一个叫做“无服务器开发”的恐怖故事

让我们从一个简单的场景开始:您正在构建第三个无服务器堆栈。在您的第一个堆栈中，您将代码粘贴到 Lambda 仪表板中。对于你的第二个问题，你变得更专业一些，在把你的源代码发送给 AWS 之前开始压缩它。现在，您正在使用大多数专业团队使用的流程:通过 AWS CloudFormation 部署您的 Lambda 以及其他所需的支持资源。

现在，一个简单的模板控制了您的所有资源，并且您可以添加一堆新资源——好消息！但是麻烦开始了。你想用 Lambda 启动和停止 Fargate 任务，但是 CloudWatch 显示了一条错误消息:

```
‘com.amazonaws.services.ecs.model.InvalidParameterException:  name cannot be blank`

```

这必须表示您正在查询的数据库的名称，对吗？您认为它只需要 ID，但是您在 Lambda 代码中设置了名称，然后更新代码库 zip 并点击 CloudFormation 上的 deploy。*您等待 10 分钟，等待代码部署。*

 [托比·费

Toby 是 Stackery 的社区开发人员。她的角色和经历结合了软件工程师、作家和技术讲师的工作，用新兴工具构建有趣的项目，并与世界分享她的发现。在加入 Stackery 之前，Toby 是 NWEA、瓦卡萨和新遗迹公司的工程师。](https://www.stackery.io/) 

好吧，完全一样的错误，没用。您做了一些搜索，发现您需要添加一个容器名。你更新你的代码。再次展开… *10 分钟的等待过去了*。

好了，现在这个错误已经过去 20 分钟了，你差不多已经处理好了。但是后来又加上了*。wirhName()* 给你一个新的错误信息。你大声咒骂，意识到自己打错了*。用 Name()* 点击*展开*。这一次，您尝试在 CloudFormation 说它准备好之前向 Lambda 发送请求。你猜怎么着，它还没准备好，又等了 10 分钟。

好了，我们回到正题了…现在的错误是*缺失(集群 ID)* 。经过更多的谷歌搜索，结果是我们使用的名字格式不正确。你修好它，*等 10 分钟*，Lambda 就工作了。

如果解决一个请求格式错误花费你 40 分钟，你一天能修复多少错误，你能发布多少特性？

## 等等，无服务器不好吗？我认为这是…好吗？

无服务器很好。在“不断地修改应用程序代码，直到它正常工作”这一特定领域，serverless 目前还很薄弱。那个“写，跑，哦 h*ck 不对，重写，再跑”的小循环！“发展的内循环不是很好。

但是我们喜欢无服务器，我们喜欢无服务器是因为你的代码写出来后一切都好得多。您的新功能需要新的数据库表吗？在您当前的组织中，这需要多长时间？使用无服务器，您可以在几分钟内为您的开发和测试环境建立并运行一个全新的数据库。水平缩放与其说是一个“难题”，不如说是一个“拖动滑块”随着问题的出现，将我们的应用程序从开发转移到测试，转移到生产，甚至转移回开发，使用无服务器要容易得多。架构和部署的外部循环得到了极大的改进。

## 快速响应时间，缓慢部署

让你的代码达到一个无服务器的功能是需要时间的，这样你就可以真正的使用它，这将会扼杀你的开发过程。当然，开发不仅仅是你一天可以提交的数量，但是上面描述的例子和你在笔记本电脑上工作的速度有很大的不同。

第一次我发现自己等了整整八分钟才部署完代码，全部是 *console.log(payload)* ，我意识到我们遇到了一个严重的问题。

如果这是如此困难，为什么还有人使用无服务器？同样，无服务器是一个非常有用的操作工具。编写应用程序代码可能会更难，但是一旦编写完成，您就不需要担心水平伸缩、内部消息排队或平台为您处理的数千件其他事情。

运营和您自己团队的管理层对无服务器感到兴奋是有道理的！但是如果编写代码的过程仍然如此困难，一半的开发团队可能会在第一年内沮丧地退出。

## 地图上的**是真的***不是领地*

 *另一种选择，也是大多数开发人员现在每天都在做的，是在本地编写他们的无服务器功能代码。如果你使用的是 AWS Lambdas，[甚至有一个工具可以实现这个功能](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)。问题解决了，对吧？

嗯，无服务器不仅仅是 Lambdas。当然，你可以用本地 API 网关在本地运行你的 Lambda 代码来访问它。但是它的数据库在哪里呢？长期运行的任务容器在哪里？Lambda 实际做任何事情所需的资源呢？

这里是我们大多数人求助于这些服务的模拟版本的地方；但是，我们如何为我们制作的粗糙模拟的几十个 AWS 资源编写代码，并希望我们的代码能够在云中实际工作呢？在我上面的例子中，我们遇到的错误是针对 Fargate API 的。任何模拟怎么能模拟呢？当然，我们可以写一个自动的“OK”响应，但是我们的模拟真的包括错误处理吗？

更糟糕的是，无服务器不是应该消除任意繁重的工作吗？我们不是应该能够专注于业务逻辑吗？编写一个假的 DynamoDB 来响应本地请求，而不是任意的*和*是多么的沉重？

## 有一个解决方案

我们需要一个云/本地混合开发环境。它以本地笔记本电脑的速度迭代我们的代码，但仍然可以与整个 AWS 云进行交互。

这应该不难想象:我们需要一些在本地运行 Lambda 代码的东西，然后通过 web 请求获取 AWS 堆栈的其他部分。当然，它需要正确地建立隧道，以便能够到达 AWS 虚拟私有云(VPC)内的组件，但即使如此，这似乎也是一个可以解决的问题。

你猜怎么着？在 Stackery，我们首次发布了一款[工具来完成这一任务。](https://www.youtube.com/watch?v=uBrIRMasENA) Stackery 对早期开发者免费，并提供云本地开发作为其部署和[堆栈管理工具包](https://app.stackery.io/sign-up)的一部分。

让我们回头看看上面的同一个例子:

*   使用 stackery CLI 在本地启动 Lambda，向它发送一个请求
*   本地运行的 Lambda 可以直接向 AWS 发送请求，并 ping Fargate 容器，但它会得到一个错误；
*   添加*。wirhName()* 并返回控制台，好消息是 Stackery toolkit 已经重新启动了您的 Lambda，*等待 0 秒，再次尝试您的请求；*
*   啊，snapple！现在一个新的错误！这次是从你本地的 Lambda 容器返回的，哦对了，错别字，改成*。然后回到控制台，只要更新了代码，Stackery toolkit 就会在那里重启 Lambda。*等待 0 秒重试您的代码* …您明白了。*

Stackery 的云本地工具能够以你编写代码的速度迭代 Lambda 代码，可以给你无服务器所缺乏的开发者体验。一个为无服务器编写代码**和在**无服务器架构上运行代码**一样容易的世界？这一现实似乎比以往任何时候都更加接近。**

在 Stackery 的博客上，Sam Goldstein 致力于构建一个理想的无服务器工作流，包括 CI/CD。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>*