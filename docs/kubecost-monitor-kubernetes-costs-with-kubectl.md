# KubeCost:用 kubectl 监控 Kubernetes 的成本

> 原文：<https://thenewstack.io/kubecost-monitor-kubernetes-costs-with-kubectl/>

[](https://www.kubecost.com/)

 [迈克尔·德莱赛

迈克尔·德莱赛是 Stackwatch 的全栈工程师，Kubecost 的创造者。Dresser 之前在谷歌为 Kubernetes 项目做贡献。](https://www.kubecost.com/) [](https://www.kubecost.com/)

您已经知道您可以使用 **kubectl** 客户端完全控制 Kubernetes 集群中的所有资源。现在有了一个新的开源 **kubectl** 插件，使得 **kubectl** 也可以监控成本。`cost`插件允许每个工程团队结合开源 [Kubecost](https://www.kubecost.com/) 应用程序快速确定任何 Kubernetes 工作负载的成本和效率。

现代云基础架构越来越复杂，挑战团队的不仅仅是运营和工程。为了监控和提高团队的财务绩效，财务总监承受着分配成本的巨大压力。他们向工程团队寻求答案。财务、运营和工程之间的协作增强了现代云工作流的可见性。随着技术的发展，企业文化也在发展。kubectl 的 cost 插件是对现代企业基础设施挑战的一个回答。

## 照亮基础设施成本

Kubernetes 集群通常在团队、微服务、应用甚至部门之间共享，使得基础设施更易于管理。有了共享平台，团队经常使用标签和/或名称空间来组织部署。Kubernetes 名称空间是 Kubernetes 集群内部的逻辑分离，可以分配给特定的团队、应用程序，甚至业务单元。

大多数组织将名称空间映射到特定的工作负载类型或用途。例如，虚构的电子商务公司 VeryCoolStore 运行一个集群，其中一个名称空间用于监控，另一个名称空间用于日志记录，供维护该集群的 DevOps 团队使用。面向客户的 web 前端应用程序、搜索应用程序和产品建议应用程序驻留在不同名称空间的同一个集群中。

在集群中创建这些逻辑分区很方便，但不能解决所有问题。首先，它仍然无法根据详细的计费数据准确衡量资源使用情况和每个租户的成本分配。更重要的是，它不会暴露低效或浪费的资源。

浪费是一个巨大的问题，其影响一直累积到最终消费者，通常对销售单位的价格有很大影响。难怪减少浪费是许多经理的企业使命。

要发现浪费并提高效率，您需要合适的工具。一位领导 SRE 团队的 Kubecost 用户经常看到服务失败。他们注意到服务由于缺乏资源而被踢出集群。通过 Kubecost 报告和 **kubectl** 成本，他们发现了根本原因:一个应用程序需要 30 个 pod，但这些 pod 基本上没有被使用。

为这个过度配置的应用程序分配的资源经常迫使调度程序将其他应用程序踢出，使它们失败。审查成本和效率报告强调，这 30 个豆荚是不必要的。一旦应用程序被重新配置为需要一个 pod，而不是 30 个，事情立即得到了改善。工程团队很高兴地发现一个吊舱就足够了。

## 如何使用 Kubectl 成本

**成本**插件可以在几分钟内安装完成。如果您使用 Krew，只需键入以下内容:

`kubectl krew install cost`

或者，查看 [GitHub](https://github.com/kubecost/kubectl-cost#installation) 上不同选项的安装说明。

有许多受支持的子命令，包括:

*   命名空间
*   部署
*   控制器
*   标签
*   豆荚
*   tui(将在以后的帖子中介绍！)

默认情况下，每个子命令根据窗口期间的活动显示预计的每月成本。还有一种非费率显示模式(–历史)，显示窗口持续时间内的总成本。

## 如何充分利用 Kubectl 成本

在任何复杂的环境中，了解推动成本和潜在成本增长的因素非常重要。财务总监开发了复杂的模型来分配不同场景下的成本:从工厂生产线到医院病房，财务团队和运营团队共同努力，以发现更好地利用资源的方式。有了 Kubecost，就有可能在财务和运营方面发现低效之处并提高团队绩效。

大多数工程团队在 Kubernetes 中通过名称空间或标签来组织成本。例如，之前的同一个 VeryCoolStore 公司可以通过查询该名称空间来检查 web 前端的成本。

```
kubectl cost namespace  --show-all-resources

+-------------------+-----------+----------+-----------+-------------+----------+-----------+----------+-------------+--------------------+-----------------+

|  NAMESPACE        |  CPU     |  CPU EFF.  |  MEMORY  |  MEMORY EFF.  |  GPU   |  PV      |  NETWORK   |  SHARED COST  |  MONTHLY RATE  (ALL)  |  COST EFFICIENCY  |

+-------------------+-----------+----------+-----------+-------------+----------+-----------+----------+-------------+--------------------+-----------------+

|  kubecost         |  10.166745  |  0.101536  |  17.002068  |  0.173600  |  0.000000  |  14.200444  |  0.129462  |  0.000000  |         59.748720  |      0.146633  |

|  kube-system     |  41.502550  |  0.036747  |  5.459635   |  0.363383  |  0.000000  |  0.000000   |  0.045637  |  0.000000  |         47.007822  |      0.074721  |

|  kubecost-stage  |  5.298161   |  0.083082  |  1.424946   |  3.479493  |  0.000000  |  2.552889   |  0.000000  |  0.000000  |         27.525996  |      0.802943  |

|  default           |  3.758165   |  0.000377  |  0.278833   |  0.404114  |  0.000000  |  0.000000   |  0.000000  |  0.000000  |           4.036998  |      0.028263  |

|  logging           |  0.822894   |  0.003321  |  0.689348   |  0.363660  |  0.000000  |  0.000000   |  0.000000  |  0.000000  |           1.512241  |      0.167579  |

|  frontend-services  |  0.822894   |  0.003280  |  0.689348   |  0.365613  |  0.000000  |  0.000000   |  0.000000  |  0.000000  |           1.512241  |      0.168448  |

|  data-science   |  0.000295   |  1.000000  |  0.010280   |  1.000000  |  0.000000  |  0.000000   |  0.000000  |  0.000000  |           0.010575  |      1.000000  |

+-------------------+-----------+----------+-----------+-------------+----------+-----------+----------+-------------+--------------------+-----------------+

|  SUMMED            |  62.371704  |         |  25.554458  |              |  0.000000  |  16.753333  |  0.175098  |  0.000000  |  USD  141.354594  |                    |

+-------------------+-----------+----------+-----------+-------------+----------+-----------+----------+-------------+--------------------+-----------------+

```

监控集群中每个应用的成本，如“应用”标签所示:

库贝克成本标签-l app

```
+----------------------------+--------------------+-----------------+

|  LABEL                           |  MONTHLY RATE  (ALL)  |  COST EFFICIENCY  |

+----------------------------+--------------------+-----------------+

|  cost-analyzer               |         59.145248  |      0.137997  |

|  prometheus                    |           7.940403  |      1.000000  |

|  test-app1                     |           3.612244  |      0.167835  |

|  nginx                           |           3.459811  |      0.006337  |

|  stackdriver-metadata-agent  |           1.981401  |      0.324363  |

|  grafana                        |           0.847323  |      1.000000  |

|  kubecost-network-costs  |           0.269981  |      1.000000  |

+----------------------------+--------------------+-----------------+

|  SUMMED                          |   USD  77.256411  |                    |

+----------------------------+--------------------+-----------------+

```

## 衡量支出效率及其重要性

Kubecost 中的花费效率被定义为在测量的时间窗口内使用的请求的 CPU 和内存美元的百分比。值的范围从 0 到 100%以上。例如，考虑下面的表格，该表格表示具有两个窗格的名称空间。Pod #1 运行在具有更昂贵 CPU 的按需节点上；pod #2 在 spot 节点上运行。

由此产生的 CPU 成本效率仅为 25.5%，CPU 利用率为 50%。这种衡量很重要，因为它清楚地显示了值得关注的领域，以提高支出。

为了进一步研究，让我们继续上面开始的名称空间示例。假设一个名称空间的成本比预期高得多，并且/或者效率非常低。接下来，我们可以深入到名称空间，查看每个工作负载的成本和效率:

```
kubecost cost controller  -n  kube-system

```

这显示了每个部署、副本集、作业等的成本和效率:

```
+-------------+-----------------------------------------------------+--------------------+-----------------+

|  NAMESPACE     |  CONTROLLER                                                         |  MONTHLY RATE  (ALL)  |  COST EFFICIENCY  |

+-------------+-----------------------------------------------------+--------------------+-----------------+

|  kube-system  |  daemonset:fluentbit-gke                                      |         12.712514  |      0.038815  |

|              |  deployment:kube-dns                                            |           9.508486  |      0.023992  |

|              |  daemonset:kube-proxy                                          |           6.232683  |      0.015296  |

|              |  deployment:coredns                                             |           2.680050  |      0.029732  |

|              |  deployment:stackdriver-metadata-agent-cluster-level  |           1.981401  |      0.324363  |

|              |  deployment:metrics-server-v0.3.6                        |           1.024543  |      0.063730  |

|              |  daemonset:gke-metrics-agent                                |           0.961624  |      0.444516  |

|              |  daemonset:aws-node                                             |           0.941192  |      0.567099  |

|              |  deployment:kube-dns-autoscaler                           |           0.342245  |      0.036308  |

|              |  deployment:l7-default-backend                             |           0.202655  |      0.031027  |

|              |  daemonset:prometheus-to-sd                                 |           0.128543  |      1.000000  |

|              |  deployment:event-exporter-gke                             |           0.035273  |      1.000000  |

+-------------+-----------------------------------------------------+--------------------+-----------------+

|  SUMMED   |                                                                          |   USD  36.751209  |                    |

+-------------+-----------------------------------------------------+--------------------+-----------------+

```

最后，我们可以使用-A 标志深入成本细节。这显示了成本的所有组成部分，以全面了解推动总成本的因素。

kubecost 成本控制器-n kube-system -A

```
+-------------+-----------------------------------------------------+-----------+----------+----------+-------------+----------+----------+----------+-------------+--------------------+-----------------+

|  NAMESPACE     |  CONTROLLER                                                         |  CPU     |  CPU EFF.  |  MEMORY     |  MEMORY EFF.  |  GPU   |  PV     |  NETWORK   |  SHARED COST  |  MONTHLY RATE  (ALL)  |  COST EFFICIENCY  |

+-------------+-----------------------------------------------------+-----------+----------+----------+-------------+----------+----------+----------+-------------+--------------------+-----------------+

|  kube-system  |  daemonset:fluentbit-gke                                      |  10.075020  |  0.021476  |  2.637494  |  0.105050  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |         12.712514  |      0.038815  |

|              |  deployment:kube-dns                                            |  8.977704   |  0.007332  |  0.530782  |  0.305785  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           9.508486  |      0.023992  |

|              |  daemonset:kube-proxy                                          |  6.137676   |  0.003714  |  0.072189  |  1.000000  |  0.000000  |  0.000000  |  0.022818  |  0.000000  |           6.232683  |      0.015296  |

|              |  deployment:coredns                                             |  2.455070   |  0.020677  |  0.224980  |  0.128545  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           2.680050  |      0.029732  |

|              |  deployment:stackdriver-metadata-agent-cluster-level  |  1.560401   |  0.379148  |  0.421000  |  0.121307  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           1.981401  |      0.324363  |

|              |  deployment:metrics-server-v0.3.6                        |  0.786997   |  0.020952  |  0.237545  |  0.205456  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           1.024543  |      0.063730  |

|              |  daemonset:gke-metrics-agent                                |  0.302251   |  0.460528  |  0.659374  |  0.437175  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           0.961624  |      0.444516  |

|              |  daemonset:aws-node                                             |  0.613768   |  0.352255  |  0.304606  |  1.000000  |  0.000000  |  0.000000  |  0.022818  |  0.000000  |           0.941192  |      0.567099  |

|              |  deployment:kube-dns-autoscaler                           |  0.321223   |  0.008121  |  0.021022  |  0.467031  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           0.342245  |      0.036308  |

|              |  deployment:l7-default-backend                             |  0.160612   |  0.007665  |  0.042043  |  0.120273  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           0.202655  |      0.031027  |

|              |  daemonset:prometheus-to-sd                                 |  0.033301   |  1.000000  |  0.095241  |  1.000000  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           0.128543  |      1.000000  |

|              |  deployment:event-exporter-gke                             |  0.003508   |  1.000000  |  0.031765  |  1.000000  |  0.000000  |  0.000000  |  0.000000  |  0.000000  |           0.035273  |      1.000000  |

+-------------+-----------------------------------------------------+-----------+----------+----------+-------------+----------+----------+----------+-------------+--------------------+-----------------+

|  SUMMED   |                                                                          |  31.427531  |         |  5.278041  |              |  0.000000  |  0.000000  |  0.045637  |  0.000000  |   USD  36.751209  |                    |

+-------------+-----------------------------------------------------+-----------+----------+----------+-------------+----------+----------+----------+-------------+--------------------+-----------------+

```

现在，每种资源类型都可以针对您的业务进行调整。我们大多数客户的目标利用率在以下范围内:

*   CPU: 50%-65%
*   内存:45%-60%
*   存储:65%-80%

目标数字在很大程度上取决于您的资源使用的可预测性和分布(例如，P99 与中位数)、高利用率对您的核心产品/业务指标的影响等等。找到适合你的范围是一个权衡问题:太低的资源利用率是一种浪费；过高的利用率会导致延迟增加、可靠性问题和其他负面行为。查看[历史数据可以帮助](https://blog.kubecost.com/blog/requests-and-limits/#determining-the-right-values)取得正确的平衡。

Kubernetes 不断扩大业务范围，在发展的同时，也给财务和工程团队带来了新的挑战。这种合作还处于起步阶段，但它已经展示了一条清晰的前进道路，开源将引领潮流。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>