# WebAssembly 将内联数据转换引入 RedPanda Kafka 流媒体平台

> 原文：<https://thenewstack.io/webassembly-brings-easy-inline-data-transformations-to-redpanda-kafka-streaming-platform/>

RedPanda 是来自 [Vectorized.io](https://vectorized.io/) 的 Kafka 兼容事件流平台，一直专注于提高性能和开发者体验。虽然它完全兼容 API，但它是用 C++编写的，而不是 Apache Kafka 本身部署的 Java。这不仅创建了一个更易于开发人员部署的单一二进制文件，而且语言选择允许 [RedPanda](https://vectorized.io/redpanda) 开发人员编写低级代码，绕过 Linux 内核，直接与 NVMe SSD 驱动器进行性能对话，同时将 Node.js V8 引擎放在每个内核上，以利用现代 CPU 上越来越多的内核。

“这使我们能够颠倒数据和计算之间的关系，矢量化公司首席执行官兼创始人 [Alexander Gallego](https://www.linkedin.com/in/alexandergallego/) 向新堆栈解释道，“通常人们所做的是将数据发送到 Kafka，然后有一个单独的过程；这可能是火花流，阿帕奇 Flink，卡夫卡流，等等。假设您想要为进入您网络的所有数据提供一个 GDPR 过滤器。你要做的是将你的数据保存到 Kafka，然后让 Spark Streaming 使用 Kafka 的数据，过滤数据，并将其推回到 Kafka 或其他下游系统，如 Elasticsearch。这样做的问题是，即使是简单的事情，您的数据也总是在您的网络中来回移动。"

有了 RedPanda，您可以使用 JavaScript 和使用共享内存的 sidecar 进程对数据进行这种处理。到 7 月份，你将能够使用 WebAssembly (WASM)在线完成，而无需离开主流程，上周在[kube con+CloudNativeCon EU 2021](https://www.cncf.io/kubecon-cloudnativecon-events/?utm_content=inline-mention)宣布的矢量化。

矢量化可能领先于曲线，但预计 Wasm 会更多地用于这种添加的内联功能。虽然它仍然是一项新兴技术，[IBM](https://www.linkedin.com/in/jrmcgee/)云平台的首席技术官 Jason McGee 在 Kubecon 2021 上告诉我们，WASM 非常适合这种无服务器和边缘场景，在这些场景中，足迹和低延迟启动非常重要。“当启动和运行需要多长时间时，能够使用像 WASM 这样的东西将代码注入到已经运行的容器中是一个有趣的实验。”

向现有系统添加功能正是 WebAssembly 有用的地方，[云本地计算基金会](https://cncf.io/?utm_content=inline-mention)的首席技术官 [Chris Aniszczyk](https://www.linkedin.com/in/caniszczyk/) 同意这一点。“我认为我们会看到任何具有扩展类型机制的项目都可能会利用 WASM 来实现这一点。”

Gallego 建议说，可以把这看作是非常传统的数据库技术——存储过程——的一种现代方法。“你可以把它写成 Go 或 Rust，在你的机器上编译成 WebAssembly，然后你把代码送到 RedPanda，当数据进来时，它被内联过滤。不再使用网络来交换您的数据提供了巨大的性能优势。”将计算引入到数据中解决了数据重力的问题，并吸引了习惯无服务器方法的开发人员。

他指出，这并不适合所有的流媒体场景，尤其是在有状态的情况下。“它旨在解决一次性转换，在这种情况下，您有自己的有效负载，然后您想对它做些什么，然后您想将它转发到不同的主题或不同的分区，或者可能获取一个对象并用 IP 信息丰富它。这些都是简单的事情，实际上在当今的企业中很难做到。”

内联转换对于处理机器学习训练数据特别有用(RedPanda 的金融服务客户将此用于信用评分等功能)。格式统一是常见的机器学习问题；数据可能是 CSV、JSON 和其他格式，WASM 代码可以将其内联转换为机器学习工作流的统一格式。

使用 WASM 进行内联数据转换的速度使其适合于近实时任务，如电子商务欺诈检测。“有一个非常高的 SLA 规定，销售点必须在两秒钟内返回信用卡应该被接受还是被拒绝，”Gallego 说。“通常情况下，它会被推到卡夫卡这样的系统中，然后引发流媒体，再回到卡夫卡那里。使用 WebAssembly，您可以发布这样的逻辑:“是的，这是欺诈性的，或者不，这不是欺诈性的”。它让你可以让一些实时的体验变得真实。”

一个客户正在使用 Kafka 从原油管道中的传感器传输数据。如果有太多的抖动，系统需要在任何损坏发生之前关闭管道；WebAssembly 代码可以向 Kafka 发布的主题发送消息以触发警报。

## 更便宜、更简单、更安全

将 V8 放在每个内核上减少了进行数据转换所需的代理数量；在一个案例中，从 100 台计算机减少到 37 台，这是一个明显的成本节约。Wasm 可能会进一步减少，因为它使用更便宜、更快速的数据调用机制。

Gallego 建议，开发者仍然可以利用丰富的 Kafka 生态系统，但他们现在可以将它用于更多的用例。当您开始将这些功能交付给存储引擎本身时，您就提高了数据消费者的抽象级别，并且可以开始为数据流的输出提供计算保证

首席安全官可以确定他们的所有数据流都符合 GDPR 标准，因为他们将经过认证的 Wasm 脚本发送到了存储引擎。金融客户也欣赏 Wasm 固有的安全性。

Wasm 的有界内存模型(它只能处理 4GB 的内存)被设计为不受信任代码的安全沙箱，避免了内存溢出问题，Wasm 的功能模型提供了矢量化的大量控制。“它允许我们暴露特定的功能来与外部世界进行交互。我们审查哪些特定的函数被允许在 Wasm 环境中执行；这些是加密功能和压缩功能，我们知道它们是安全可靠的。”

与往常一样，在开发人员的生产力和安全性之间有一个权衡，但使用 Wasm 允许 RedPanda 用户设置关于如何处理数据的策略。“这种控制非常强大。在与银行的安全审计中，我们可以准确地解释他们的开发人员可以对数据执行哪些 Wasm 功能。这是我们可以提供给安全官和安全团队的一个心理模型，作为一种方式来推理什么是可能的，什么是可能发生的实际故障，或者有多少数据可能会泄漏。他们可以自己决定向数据消费者提供什么样的保证。”

他们无需额外的复杂性就能获得这种控制。“我们向 JavaScript 开发者、Go 开发者、Rust 开发者开放市场；那些在文化上厌恶使用 JVM 系统的人，现在他们觉得有能力构建这种实时体验。这非常简单，他们可以快速迭代，因此调试周期非常快。我认为 WebAssembly 是比现有工具更大的开发者子集的关键。现有的工具非常丰富和强大，但它们真的很重。对于 Spark 流，你必须知道 Spark API，它非常复杂。作为开发人员，我们有多种选择，这很好，但有时你只想做简单的事情，你希望这些事情简单易行。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>