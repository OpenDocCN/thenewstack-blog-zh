# Kubernetes 之路:规模和可靠性

> 原文：<https://thenewstack.io/taking-closer-look-kubernetes-part-two/>

在本文的第[部分，我们探讨了 Kubernetes 中的 pod 和服务的概念。让我们了解如何利用复制控制器实现规模和可靠性。我们还将讨论如何为部署在 Kubernetes 上的云原生应用程序带来持久性。](https://thenewstack.io/kubernetes-way-part-one/)

## 复制控制器:扩展和管理微服务

如果单元是单元，部署和服务是抽象层，那么谁来跟踪单元的健康状况？这就是复制控制器(RC)概念的由来。

部署完 pod 后，需要对它们进行扩展和跟踪。RC 定义具有在任何给定点应该可用的 pod 数量的基线配置。Kubernetes 通过跟踪 pod 的数量来确保始终保持所需的配置。它可以杀死几个或发射几个，以满足基线配置。

RC 可以跟踪 pod 的健康状况。如果一个吊舱变得不可访问，它会被杀死，然后一个新的吊舱被发射。因为 RC 本质上继承了 pod 的定义，所以 YAML 或 JSON 清单可能包含重启策略、容器探测和健康检查端点的属性。

Kubernetes 支持基于 CPU 利用率的 pod 自动伸缩，类似于 EC2 自动伸缩或 GCE 自动伸缩。在运行时，可以根据特定的 CPU 利用率阈值，操纵 RC 来自动扩展 pod。也可以在同一命令中指定吊舱的最大和最小数量。

## 平面网络:秘方

网络化是集装箱化的复杂挑战之一。向外界公开容器的唯一方式是通过主机的端口转发。但是当缩放容器时，这就变得复杂了。Kubernetes 没有将网络配置和集成留给管理员，而是提供了一个开箱即用的集成网络模型。

每个节点、服务、单元和容器都有一个 IP 地址。节点的 IP 地址由物理路由器分配；结合分配的端口，它成为访问面向外部的服务的端点。尽管不可路由，Kubernetes 服务也能获得一个 IP 地址。所有通信都不需要网络地址转换(NAT)层，从而使网络变得扁平和透明。

这种模式具有以下优势:

*   所有容器都可以在没有 NAT 的情况下相互通信。
*   所有节点都可以在没有 NAT 的情况下与集群中的所有 pod 和 containers 通信。
*   每个容器看到的 IP 地址与其他容器看到的完全相同。

通过副本集(RS)扩展 pod 的最大好处是端口映射由 Kubernetes 处理。属于一个服务的所有 pod 都通过每个节点上的同一个端口公开。即使没有在特定节点上安排 pod，请求也会自动转发到适当的节点。

这种魔力是通过名为 kube-proxy 的网络代理、iptables 和 [etcd](https://thenewstack.io/coreos-updates-etcd-large-scale-container-coordination/) 键值存储的组合实现的。集群的当前状态由 etcd 维护，在运行时由 kube-proxy 查询。通过操纵每个节点上的 iptables，kube-proxy 将请求发送到正确的目的地。

Kube-proxy 还处理服务的基本负载平衡。服务端点通过与 Docker 链接兼容的环境变量来管理。这些变量解析为服务公开的端口。Kubernetes 1.1 包括一个使用本地 iptables 的选项，这将减少 80%的延迟。这种设计消除了 CPU 开销，从而提高了效率和可伸缩性。

## 持久性:给容器带来状态

容器是短暂的。当它们从一个主机移动到另一个主机时，它们不保持状态。对于生产工作负载，持久性是必须的。任何有用的应用程序都有数据库支持。

默认情况下，豆荚也是短暂的。他们每次复活都是从一张白纸开始。可以设置一个卷，由同一个 pod 中运行的所有容器共享。由 emptyDir 名字标识，它类似于 Docker 卷，其中主机文件系统作为容器中的目录公开。emptyDir 卷遵循 pod 的生命周期。删除一个 pod 后，卷也会随之删除。由于这些卷特定于主机，因此它们在其他节点上不可用。

为了在 pod 之间实现持久性，而不管它们被安排在哪个节点上，Kubernetes 支持 PersistentVolume (PV)和 PersistentVolumeClaim (PVC)请求。PVC 和 PV 共享与 pod 和节点相同的关系。创建 pod 后，可以通过声明将其绑定到特定卷。PV 可以基于多种插件，例如 GCE 持久磁盘、亚马逊弹性块存储(EBS)、网络文件系统(NFS)、互联网小型计算机系统接口(iSCSI)、GlusterFS 和 RBD。

设置持久性的工作流包括配置底层文件系统或云卷，创建持久性卷，最后创建将 pod 与卷相关联的声明。这种分离的方法在 pod 和 volumes 之间实现了清晰的分离，使它们非常便于携带。应用程序、容器或 pod 不需要知道实际的文件系统或支持它的持久性引擎。一些文件系统，比如 GlusterFS，可以容器化，使得配置更加容易和可移植。

## 摘要

容器并不像许多人认为的那样是一个新概念，谷歌十年来一直在容器中运行其大部分网络规模的工作负载。他们在 Kubernetes 中学到的许多经验教训可以转化到其他编排平台，甚至是一般的编排概念。它解决了近十年前谷歌网站可靠性工程师面临的一些难题，并影响了许多编排者的前进道路。

最重要的是，Kubernetes 已经成为容器编排生态系统中的一个主要焦点，并且作为其他相关服务的一个有价值的开源平台而存在。了解 Kubernetes 当前的角色和功能对于展望编排市场的未来是必要的。

Docker 是新堆栈的赞助商。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>