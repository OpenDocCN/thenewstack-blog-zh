# Docker 符号链接竞争漏洞可能允许未经授权的数据访问

> 原文：<https://thenewstack.io/docker-symlink-race-vulnerability-could-allow-unauthorized-data-access/>

两名 SUSE 安全研究人员[在 Docker 容器引擎的所有版本中发现了一个漏洞](https://seclists.org/oss-sec/2019/q2/131)，该漏洞为攻击者提供了一种进入主机或主机管理的其他容器的方法。据安全研究员 [Aleksa Sarai](https://www.cyphar.com/) 称，针对该漏洞的[补丁](https://github.com/docker/docker/pull/39252)已提交上游( [CVE-2018-15664](https://nvd.nist.gov/vuln/detail/CVE-2018-15664) )，目前正在审查中。

“这是一个非常严重的漏洞，因为它可以完全破坏数据的完整性或保密性，因为攻击者可以读取和修改文件，”在容器或主机系统中， [Kelly Shortridge](https://twitter.com/swagitda_) 说，他是生产 Linux 安全提供商 [Capsule8](https://capsule8.com/?tns) 的产品战略副总裁，他是博客文章[的作者，该博客文章更详细地描述了该漏洞](https://duo.com/decipher/docker-bug-allows-root-access-to-host-file-system)。Docker 提供了一些细节，以尽量减少攻击面，直到下个月发布一个测试。

Docker 广泛使用的 **FollowSymlinkInScope** 函数是该漏洞的来源，因为它受到 [TOCTOU](https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use) (检查时间到使用时间)竞争条件的影响。正如撒莱所写的:

*FollowSymlinkInScope 的目的是采用一个给定的路径并安全地解析它，就好像该进程在容器内部一样。在完整路径被解析之后，被解析的路径被传递一点，然后在一点之后被操作。…如果攻击者可以在解析之后、操作之前向路径添加一个[符号墨水]组件，那么您最终可能会将主机上的符号链接路径*
*组件解析为根。*

也许最值得注意的是,“docker cp”复制命令使用了 **FollowSymlinkInScope** ，并且可以被误用来获得对任何路径的读*和写*访问。在主机上。函数[和](https://news.ycombinator.com/item?id=20031403)在 docker 代码库中的其他地方使用。例如，SUSE 编写了两个利用这个漏洞的脚本。

肖特里奇说，好消息是“docker cp”似乎没有在很多自动化操作中使用。她建议公司在 docker 发布补丁之前阻止使用“docker cp”命令，特别是那些对数据完整性有高优先级的组织。

在回复一封电子邮件询问时，Docker 发言人补充了一些关于此漏洞范围的更多信息。

该公司指出，攻击场景“只有在容器已经受损，用户正在使用“docker cp”复制容器文件，并且在复制的同时发生，只有几毫秒的时间，才有可能发生”。

据该公司称，作为一项短期措施，用户可以在使用“docker cp”复制文件之前手动运行“docker pause”，并在复制完成后手动运行“docker unpause”来解决这个问题。下个月的版本将通过在“docker cp”命令中自动插入“docker pause”来解决该问题，该命令会在进行复制时冻结容器，并防止容器修改数据。

为了防止未来出现类似的问题，Sarai 开发了大量的 Linux 内核补丁,可以安全地解析 rootfs 中的路径[,以及一个](https://marc.info/?l=linux-fsdevel&m=155835923516235&w=2)[“安全加入”库](https://github.com/cyphar/filepath-securejoin),以检测对旧内核的攻击。

上个月，Docker 的容器库 Docker Hub[被攻击者](https://thenewstack.io/a-week-later-docker-offers-scant-details-on-hub-attack/)攻破。

Capsule8 是新堆栈的赞助商。

照片由 Pixabay 的 Michel Aelbrecht 拍摄。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>