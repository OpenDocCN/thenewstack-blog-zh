# 使用集群 API 将 Kubernetes 商品化

> 原文：<https://thenewstack.io/commoditizing-kubernetes-with-the-cluster-api/>

[](https://www.linkedin.com/in/gianlucarbezzano/)

 [吉安卢卡

吉安卢卡是 Packet 公司的高级软件工程师。他是一个全栈开发者，一个 PHP 开发者，一个开源贡献者，也是 Doctrine ORM 团队的成员。](https://www.linkedin.com/in/gianlucarbezzano/) [](https://www.linkedin.com/in/gianlucarbezzano/)

Kubernetes 不是作为一个可爱的新宠物为你的家而发明的。把它想象成一头牛。

我们都知道奶牛和宠物的区别，对吧？奶牛通常没有名字(恐怕我不得不反对这种想法，但就这个例子来说，我们就顺其自然吧)，宠物是你像家人一样对待的可爱动物。

这显然是一个众所周知的比喻，可以给你一个我们应该如何看待容器和云计算的参考框架。您不需要拥有自己的服务器池，您对这些服务器了如指掌，包括它们的主机名。

云计算不关心你的虚拟机。它更不关心你的容器，因为它们来来去去。Kubernetes 会自动杀死一个制造麻烦的应用程序的副本——例如，您部署了一个有内存泄漏的新版本的应用程序，它开始使用您分配给容器的所有可用内存。容器将耗尽内存，Kubernetes 将重新启动应用程序。该应用程序返回一个不同的主机名，你对此无能为力。抱歉，事情就是这样。

任何管理过服务器的人都知道，事实是我们一直把服务器当成宠物，因为我们没有合适的技术来看待它们。

让我们换一个比喻。引力是维系我们太阳系的力量。它让地球上的一切都保持在原位。我们需要它。但是，如果你增加重力，它会使物体变得更重。随着重力的增加，我们走路会更困难，移动东西也会更困难。随着重力的增加，试图移动的难度也在增加。在某一点上，重力变得如此过度，它粉碎了一切。假设我们想要更轻的东西，更容易移动。为了解决这个问题，我们可以进入一个模拟器或者建造一个火箭去月球。

在科技领域，这并不难。Gravity 随着应用程序和基础设施的增长而不断发展。我们添加了更多的技术、更多的组件、更多的数据，接下来，我们曾经响应迅速的应用程序或生态系统现在变得不堪重负且运行缓慢。

假设我们不打算扔掉所有东西，移动环境来降低重力——比喻把我们的工作炸到月球上——我们能做什么？幸运的是，你所需要的是正确的工具来将重力恢复到可接受的水平。

以前，像对待牲畜一样对待服务器和应用程序所需的经验和工具仅限于超大规模公司，但现在情况不同了。我们现在有了更多的选择。

这个故事今天在 Kubernetes 身上重演。我看到许多公司都有著名的、一致命名的 Kubernetes 集群。他们稳如磐石，因为这项技术是新的，他们刚刚起步。使其成为商品所需的知识和工具还没有开发出来，或者不容易采用。

我在 Packet 工作，我可以告诉你，科技领域的引力是 100%基于外部因素的。这不像物理学，你可以用数字来描述它。(如果你想知道，地球上的重力是每秒 9.81 米。)

在科技领域，重力会根据你所处的位置、你知道什么和你关心什么而变化。对于一些公司来说，数据具有引力，因为他们还没有找到一个好的管道，让他们能够安全、快速、经济高效地移动数据。

让我们以数据中心为例。根据您的公司构建供应链的能力以及对机架布线或管理操作系统更新的效率，拥有服务器的重要性会有所不同。

如果您将混合云添加到这个等式中，重力将会更小，因为您将有办法将它转移给其他人，如果它变得过于复杂(例如，停机)，他们将为您管理它。

## Kubernetes 中的集群 API

Kubernetes 中的工具和操作体验正在改进。大公司正在有效地使用它，拥有正确知识的小公司也是如此，这证明了它在任何规模下的效率。但是许多公司仍然把集群当作宠物。这篇文章解释了为什么会这样，现在我将解释为什么集群 API 会把管理 Kubernetes 的公司带到月球上。

我最近有机会为 Packet 编写一个集群 API。这是构建集群 API [的 Kubernetes 社区对它的描述](https://github.com/kubernetes-sigs/cluster-api#what-is-the-cluster-api):

*“集群 API 是一个 Kubernetes 项目，将声明性的、Kubernetes 风格的 API 引入集群创建、配置和管理。它在核心 Kubernetes 的基础上提供可选的附加功能。”*

你可以把它看作是一种对整个集群应用的方式。它可以是单节点的，也可以是多节点、多管理器的。

它使用 Kubernetes 开发的所有其他资源所使用的相同构件:协调循环和控制器。

一切都从名为“管理集群”的 Kubernetes 集群开始它必须启动并运行，它是你必须创造的所有其他事物的父亲。这是元的，但是这个集群允许您通过 **kubectl apply** 创建其他集群，就像您对任何其他资源所做的一样——比如 pod、服务、入口或部署。

从这个集群中，您可以应用将描述和创建新集群的清单。管理集群运行许多由 cluster-api 项目提供的定制资源定义:Machine、MachineSet、MachineDeployment、KubeadmBoostrap 等等。其中一些是新概念。其他的来自我们已经知道的想法——pod、replicaset 和 deployment——但是应用于机器(服务器)。

服务器可以在任何地方运行；每个基础架构提供商(vSphere、Packet、AWS、GCP)都有其集群 api 提供商实施。实际上，它将“元”对象(Machine、MachineSet、MachineDeployment)转化为更具体的东西，通常称为 AWSMachine、PacketMachine 等，这取决于您选择的云提供商。它有我们都知道的属性，比如操作系统、AMI、instance_type 等等。

我故意说得有点“元”，因为本文的目的不是解释 cluster-api 是如何实现的，或者 cluster-api-provider 是如何工作的；这些话题值得他们自己的文章。

cluster-api-provider 获取具体的 PacketMachine 或 AWSMachine，并启动一个控制器，该控制器不断地进行协调循环，直到提供了集群。这与创建 pod 的工作方式相同。

cluster-api 文档使用大量图表来描述复杂的步骤和过程，以保证不同提供者之间的行为相似。如我所说，cluster-api 是一个框架；每个基础设施提供商都必须将其与自己的基础设施 API 结合起来。

这就是商品的定义:你可以快速替换并且在任何地方都能找到的东西，也许有不同的味道，但是仍然有用。

数据包的[集群 API 实现仍在进行中，但是已经到了可以尝试的时候了。看看吧，在推特上告诉我](https://www.packet.com/resources/guides/kubernetes-cluster-api-on-packet/) [@gianarb](https://twitter.com/gianarb) ，和你最喜欢的 Gophernetes 分享你的痛苦！

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>