# Kubernetes 在 AWS 停机期间节省 Spire 服务

> 原文：<https://thenewstack.io/kubernetes-credited-saving-spire-service-s3-outage/>

周二下午亚马逊网络服务的 S3 云服务 US-EAST-1 可用区的[中断可能已经持续了长达四个小时，尚未得到诊断。接下来的周三下午，亚马逊支持论坛上要求该公司发表声明的几个帖子中，有一个被官方留为“未回复”。不过，一位顾客确实留下了这样的评论:“在大停电后一天保持沉默一点也不酷。你需要时间，说出来。我们大多数人都会理解。我们是那些在听到你的验尸报告后有自己的验尸报告要完成的人。”*(编者注:AWS 已经在*](http://www.businessinsider.com/aws-outage-hurt-internet-retailers-except-amazon-2017-3)*[贴出了一份关于中断根本原因的摘要](https://aws.amazon.com/message/41926/))。*

但是一个亚马逊 AWS 客户——一个在目标可用性区域使用服务器的客户——没有事后分析可做。员工参与服务提供商 [Spire](https://spire.me/) 受到了中断的影响，尽管其首席工程师之一——Spire 负责软件架构的副总裁[Rob Scott](https://www.linkedin.com/in/robertjscott1/)——周三报告称，其 [Kubernetes](/category/kubernetes/) 驱动的服务部署立即减轻了这种影响，将其活动节点转移到其他 EC2 可用性区域，而他的团队则坐在一旁高兴地看着。

“实际上，像周二这样的一天发生这种故障可能会导致数小时的停机时间，”斯科特周三在一篇中型博客文章中写道。“有了 Kubernetes，就不会有片刻的恐慌，只有一种敬畏感，看着自动缓解发生。”

如果有更多的事件发生，斯科特就有故事可讲了。事实证明，Spire 因其数据中心的就绪状态而实现了零停机，据他自己说。

他认为 Kubernetes 的命令行工具 [**kops**](https://github.com/kubernetes/kops) 的使用对于 Spire 服务在 S3 停机期间的恢复能力至关重要，该工具用于自动化整个集群的部署——包括在 EC2 上。

Scott 告诉新堆栈:“**Kops**使配置多个可用性区域变得非常简单。“作为**创建集群**命令的一部分，您可以简单地选择您希望在其中调配实例的可用性区域。”

在他的博客文章中，Scott 建议读者使用 **kops** 在多个可用性区域中分配节点，并确保每个节点都能够故障转移到另一个节点。他说，不分配足够的故障转移容量的危险是，利用率可能会超过 60%的容忍水平，可以想象会上升到令人吃惊的 80%的水平。

我们问斯科特，如果利用率跨过这个门槛，Spire 会有什么危险？

> “有了 Kubernetes，就不会有片刻的恐慌，只有一种敬畏感，看着自动缓解发生。”

“当我们的利用率水平超过 80%时，我们开始触发警报，因为这不会给我们留下太多的增长空间，”Spire 副总裁回应道。“虽然 80%的利用率可能不会很明显，但 100%肯定会，当你开始接近这一水平时，你就要小心了。

“如果您接近 100%的利用率，任何系统上的使用高峰都可能意味着其他系统变慢甚至可能崩溃，”他继续说道。“根据定义，您的利用率会有所不同，因此为使用高峰留出一些空间非常重要。这也取决于节点的大小。如果你在亚马逊上使用类似于 [**t2.medium**](https://aws.amazon.com/ec2/instance-types/) 实例的 4 GB 内存，80%的利用率意味着你真的没有太多的内存用于任何类型的峰值。另一方面，如果你使用一个有 32 GB 内存的 4.2 倍大的，80%的利用率仍然会给你留下超过 6 GB 的内存。我想这就是说，80%对每个人来说都不是一个完美的数字；而是为各种用途留出一些额外空间。”

Scott 的博客文章还建议使用 [*就绪探测器*](https://www.ianlewis.org/en/using-kubernetes-health-checks)——Kubernetes 的另一个本地特性，用作心跳机制。orchestrator 停止向任何配备了无响应的就绪探测器的 pod 发送流量。然后它可能开始发射一个新的吊舱来取代它的位置。

Spire 是否会受益于使用更全面的监控系统，如 Prometheus？还是准备就绪探测器提供了 Spire 需要的所有预防措施？

“即使监控工具能够重新分配节点，”Scott 回应道，“我也不愿意把这种控制权交给这样的工具。另一方面，像 Prometheus 这样功能强大的监控解决方案无疑具有重要价值。Kubernetes 并不完美，肯定会有第三方工具发现 Kubernetes 可能忽略的异常。在运营中，冗余是关键。仅仅依靠普罗米修斯号或战备探测器是目光短浅的。最好的方法永远是在其中一个部分(无论是服务器还是监控工具)出现故障时仍能工作的方法。”

社交媒体上对 S3 停电的很大一部分回应可以归结为，“冷静点，人们，这些事情会发生的。”Rob Scott 的故事提供了一些急需的证据，证明这些事情不会发生——至少不会发生在那些有应变计划的组织身上。

*【本文经过编辑，以反映 Rob Scott 周四下午做出的澄清。]*

特征图片:[幸存者树](https://commons.wikimedia.org/wiki/File:Oklahoma_City_National_Memorial_4878.jpg)，它在 1995 年俄克拉荷马城 Murrah 联邦大楼爆炸中幸存，由 Dual Freq 制作，在知识共享*下授权。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>