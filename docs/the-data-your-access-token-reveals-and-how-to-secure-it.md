# 您的访问令牌透露的数据以及如何保护它

> 原文：<https://thenewstack.io/the-data-your-access-token-reveals-and-how-to-secure-it/>

信息安全，有时简称为 InfoSec，是一个组织的安全策略的组成部分。它试图确保恶意行为者不能访问或修改属于公司的有价值的信息。

毫不奇怪，InfoSec 对 API 同样重要，尽管这个主题经常被忽略。许多 API 努力将与消费者共享的信息保持在必要的最低限度。因此，过度的数据暴露在 OWASP 2019 年十大 API 漏洞列表中名列第三。

## 我的数据在哪里？

OWASP 漏洞主要针对开发人员在 API 响应中暴露未经过滤的数据。例如，API 请求可能会在响应体中返回整个数据库对象，而不是只发送客户机需要的最少数据。但是响应体并不是唯一可以从系统中流出数据的地方。

 [米哈尔·特罗扬诺斯基

Michal 是 Curity 公司的产品营销工程师。他是一名拥有 10 多年 web 技术工作经验的开发人员。从事不同的项目使他能够学习不同的语言，观察不同的设计模式——也涉及到 API。](https://www.linkedin.com/in/micha%C5%82-trojanowski-58664932/) 

访问、刷新和 ID 令牌通常被视为安全或实用实体，但实际上它们是有价值信息的载体。给我看你的访问令牌，我会告诉你你是谁，或者至少获得很多有价值的信息。符合 OpenID Connect 规范的 ID 标记总是以 JSON Web 标记(JWT)的形式出现。这意味着它的内容，即使受到完整性保护，也可以被任何获得它的人阅读。

当然，ID 令牌旨在向客户端提供用户信息。尽管如此，公司应该始终意识到最终出现在 ID 令牌中的声明，以及它是否是客户端应该接收的必要最小值。

任何 JWT 都可能包含用户的敏感数据。

在访问和刷新令牌的情况下，事情就不那么简单了。OAuth 规范并不要求这些令牌具有任何特定的格式，但是 jwt 通常是出于方便而使用的。然而，编码在访问或刷新令牌中的信息应该由 API 使用，而不是由客户机使用，当然也不是由任何碰巧阅读这种令牌的人使用。

API 需要关于用户的信息来执行细粒度的授权决策，但是应该由 API 而不是其他任何人来访问这些信息。当 jwt 用于访问或刷新令牌时，该信息会泄露给客户端或拦截令牌的任何恶意参与者。

API 和授权服务器通常属于同一个组织，因此数据可以在它们之间安全地共享。但是客户端通常属于第三方，因此不应该访问令牌中包含的信息。甚至第一方客户端的令牌也可以被用户访问并通过互联网交换，因此容易被窃听。

## 哪些数据应该受到保护？

个人身份信息(PII)是人们在考虑 InfoSec 时首先想到的数据类型。公司不得泄露任何用户的 PII，当这些信息作为声明放入令牌时必须小心。在令牌中用作声明的关于用户的其他信息，从业务角度来看可能很重要，也应该受到保护。这可能包括用于描述用户的任何信息，例如兴趣和爱好。即使泄露此类信息不会招致惩罚，它仍可能损害公司的运营和声誉。

但是，用户信息并不是唯一需要谨慎对待的令牌数据类型。恶意行为者可以利用声明来获取有关他们使用的公司基础设施和技术的信息。这些信息可能会帮助攻击者突破公司的安全系统。

## 如何保护令牌中的数据

### **治理是关键**

在设计、开发和安全审计期间，在应用程序生命周期的每一步都要注意令牌的内容。公司必须了解最终出现在访问和刷新令牌中的数据，以及哪些可能的用户信息可能会出现在 ID 令牌中。建立适当的程序来管理对令牌内容的任何修改。声明不应由任何人随意添加，应进行审核和验证，以确保包含声明不会构成信息披露。

### **始终使用令牌服务**

始终使用负责颁发令牌的专用服务来促进令牌内容的治理。这提供了一个清晰的关注点分离，并创建了一个单点控制。商业服务不应该自己发行令牌。允许它将很快变得不可维护。当没有集中的令牌发放者时，识别数据泄漏并解决它们将变得困难。

通常，专用授权服务器具有健壮的令牌服务实现。它们将允许您基于各种输入参数轻松定制令牌的内容。(Curity Identity Server 的[令牌设计器](https://curity.io/resources/learn/token-designer/)就允许这样做。)例如，令牌可以包含针对不同客户端或受众的不同声明。这提供了一种防止披露不必要数据的机制。授权服务器还将审核令牌发放，并提供撤销令牌的端点。

### **幻影令牌**

如果使用不透明的令牌，来自令牌的数据不会泄露，但是通常 API 接收 jwt 更方便。这就是[幻象令牌](https://curity.io/resources/learn/phantom-token-pattern/)模式派上用场的地方。在这种方法中，您向客户端颁发不透明令牌，并使用 API 网关来执行令牌自检，并将不透明令牌交换为 JWT。因此，即使客户端处理不透明的令牌，API 也会接收 JWT 访问令牌。这种方法允许公司在将数据放入令牌时更加宽松，因为它们的内容无法读取。

在某些情况下，[分割令牌](https://curity.io/resources/learn/split-token-pattern/)方法可能更合适。这是一种类似于幻影令牌的模式，但是令牌自检不需要与授权服务器进行在线通信。

### **将令牌排除在浏览器之外**

另一种防止令牌内容被窃听的方法是将令牌完全排除在浏览器之外。在名为[令牌处理器](https://curity.io/resources/learn/the-token-handler-pattern/)的后端组件的帮助下，令牌可以远离用户代理，而安全、加密的 cookies 则用于处理用户会话。这可以防止恶意参与者拦截令牌，这也意味着令牌的内容不会泄露。

## 结论

在考虑信息安全时，很容易忽略系统的特定部分。在设计或测试信息安全时，令牌经常被遗漏。公司倾向于关注 API 应该返回什么数据，如何适当地保护对这些 API 的访问，或者如何适当地保护令牌本身。

令牌本身的内容很少被认为是值得预先设计的。但是包含在声明形式的令牌中的数据应该像 API 返回的数据一样受到保护。公司应该考虑对外界隐藏这些数据，或者，如果这不可能，要知道哪些信息可以通过令牌暴露。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>