# 成功使用 API 网关的 5 种方法

> 原文：<https://thenewstack.io/5-ways-to-succeed-with-an-api-gateway/>

[HAProxy](https://www.haproxy.com/) 赞助本帖。

 [尼克·拉米雷斯

Nick 是一名软件开发人员和作家。他目前为 HAProxy Technologies 工作，创建博客帖子、文档和网络研讨会，帮助人们充分利用 HAProxy。此前，他是俄亥俄州哥伦布市一家咨询公司的软件开发人员，专攻 DevOps、基础设施自动化和 CI/CD 管道。](https://www.linkedin.com/in/nick-ramirez-1b44624/) 

每当一项新技术获得牵引力时——无论是框架、语言、工具还是实践——软件开发人员必须从喧嚣中提取其真正的价值。许多人已经将这种技能磨练到了极致，准备从有意义的事物中剔除无意义的事物。由于不缺乏新技术，这种精神上的除草已经成为这项工作的一个重要部分。

术语 *API 网关*现在正在流行。然而，即使是最有经验的趋势判断者，也不容易准确地说出为什么以及应该如何使用它——尤其是考虑到市场上充斥着大量的竞争产品。在这里，我给出了五个技巧，这些技巧可以让你更好地理解 API 网关，帮助你更好地理解这项技术，并最终引导你成功地交付高可用性、安全性和可观察性的 API。

## 技巧 API 网关是一种设计模式

当然，API gateway 是一种*产品*，因为供应商的产品名称中都有术语 API Gateway。然而，最好忽略围绕这个术语的市场宣传，而是将它视为一种*设计模式*，或者一个众所周知的问题的通用解决方案。作为一种设计模式，它可以简洁地表达为:

> API 网关将许多 API 整合在一个端点之后，同时提供额外的功能，如 SSL 终止、负载平衡、基于令牌的授权、重试逻辑、速率限制和监控。

API 网关试图通过提供一个将多个 API 压缩成一个的统一接口来解决调用许多后端 API 的内在复杂性，许多现代网站都倾向于这样做。前端代码只需要知道 API 网关的位置，而不是直接连接到每个 API。这使得前端代码对变化更有弹性，允许您在不影响客户端的情况下扩大或缩小 API 服务器(或容器)，改变内部网络的布局，并更安全地推出更新。

因为 API 网关面向您的所有服务，所以它通常增加了跨服务的功能，如 SSL 终止、负载平衡、重试逻辑、速率限制和监控。有趣的是，在一个现代的软件负载平衡器中，您会发现几乎所有这些特征。事实上，使用负载均衡器作为 API 网关没有任何问题。例如，您可以轻松地在您的客户端和服务之间部署开源的 HAProxy 负载平衡器，它具有所有这些功能，并可以根据 URL 中的路径将 API 请求转发到正确的服务。

## 技巧 2:规划安全的高可用性

假设您部署了一个 API 网关，并将您的服务器放在它后面的网络上。如果您只运行它的一个实例，就有可能产生一个单点故障，导致您的所有服务停止运行。提前计划，至少运行两个实例。然后，您可以通过使用 Ansible 这样的配置管理工具或运行 rsync 这样的文件同步软件，在它们之间镜像相同的配置。

如果您使用 HAProxy，您可以启用健康检查来持续 ping 后端服务器，并确保它们是可访问的。不健康的服务器将被自动移除，并在恢复健康后重新引入。您还应该启用重试，这将在出现暂时性网络问题时将失败的请求重新路由到另一个服务器。

还要考虑[设置速率限制](https://www.haproxy.com/blog/four-examples-of-haproxy-rate-limiting/)来限制每个客户端的连接数或请求数。这保护了 API 不被过度使用——包括故意的拒绝服务攻击——同时保持服务对其他客户端可用。前端代码可以被设计成处理速率限制、回拨请求(如果需要的话)以及在短时间后重试。HAProxy 负载平衡器还支持在后端服务器达到定义的连接限制时对连接进行排队。关键是要从整体上保护服务的正常运行时间，即使以牺牲一些客户为代价。

## 技巧 3:避免将业务逻辑放入您的网关

在将业务逻辑移入 API 网关时要小心。例如，你会发现一些供应商在他们的产品中包含了像 *API 聚合*这样的特性，这意味着当一个 API 调用进入网关时，它会被拆分成对多个后端服务的调用。这些服务将它们的结果返回给网关，然后网关将它们组合成一个大的结果并返回给客户端。这种方法背后的原因是通过使调用一个 API 函数而不是许多 API 函数成为可能来减少客户端的延迟，至少从客户端的角度来看是这样的。

然而，这样做的问题是，您会将业务逻辑引入到 API 网关中:业务流程工作流的逻辑。例如，如果客户从电子商务网站购买一件商品，将有几个后端系统需要更新:库存、运输、账单、客户通知。这些步骤发生的顺序可能很重要。无论工作流是什么，它都符合业务逻辑的定义，因为它编码了流程的业务规则。当您将业务逻辑移出服务代码并移入外部组件(如 API 网关)时，它通常会变得更难查看、更难测试，并且有被忽略的危险。

第二个问题是，通过将所有的结果合并成一个结果，你正在击败 web 开发的现代原则——其中最主要的是希望将 UI 和服务逻辑分割成独立的组件，这些组件可以彼此独立地进行版本控制、测试和交付。Vue.js、React 和 Angular 都将组件提升到更高的突出程度；微服务提升了服务器端的组件。通过返回一个单一的、大的响应，组件失去了独立性，变得紧密耦合，迫使开发团队在数据格式和命名方案上相互协调，这减慢了交付的速度。

还有其他模式来管理分布式系统中的工作流，比如 [Saga 模式](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga)，它更适合以正确的顺序传播变更，并允许系统在出现错误时回滚。或者，如果您希望进行聚合，以便用新的服务逐渐替换过时的服务，您可以使用[扼杀模式](https://docs.microsoft.com/en-us/azure/architecture/patterns/strangler)。然而，像这样的模式可以在代码中实现，使它们可测试和可维护。

## 技巧 4:监控您的 API

使用日志和指标监控 API 甚至比使用传统应用程序更重要。这是因为你需要记录谁在消费它们，以及消费到什么程度。您如何知道哪些客户端正在使用某项服务？什么时候你能最终淘汰一个废弃的 API？哪些服务接收的流量最大，其流量是周期性的还是突发性的？尝试找到一个解决方案，为您提供日志记录级别和提供这些信息的指标。

如果您决定使用 HAProxy 负载平衡器来实现这一目的，它会附带日志，可以捕获每个请求和响应的几乎每个方面，并且它内置了对 Prometheus 指标的支持。您从这一层获得的额外细节可以在以后得到回报，特别是当服务老化并且必须退休时。API 网关可以跟踪仅从网络中的该点可用的信息，例如 HTTP 请求或错误的全局数量、授权失败、重试次数等。通过预先检测 API 网关，您将拥有管理服务生命周期所需的所有信息。

## 技巧 5:抽象细节

如果可能的话，您应该通过直接抽象出使用 API 网关的细节来努力给予开发团队自主权；开发团队应该能够在运营团队最少的帮助下注册新的服务。有几种方法可以实现这一点。例如，您可以启用服务发现—例如通过使用像 Consul 这样的工具—它可以使网络上运行的其他软件发现新的服务。然后，您可以使用 DNS 服务发现或 [consul-template](https://github.com/hashicorp/consul-template) 从向 consul 注册的服务元数据中生成 API 网关配置。

在某些情况下，您的 API 网关可能有一个 API 本身，您可以使用它来动态地配置它。例如，HAProxy 提供了其数据平面 API，您可以使用它以编程方式添加前端路由和后端服务器池。这可以集成到 CI/CD 部署中。最终，您的目标是在平台和开发人员之间创建一个抽象层，以便他们可以自己注册服务。独立构建和交付的能力将加速他们的工作，这可以带来更快乐、更高效的团队。

## 结论

API 网关是一种设计模式，用于在单个端点之后整合 API。它简化了前端逻辑与后端服务的通信方式，同时提供了跨领域的功能，如 SSL 终止、负载平衡和授权。有几种方法可以确保这种模式的成功:

*   提前计划并部署考虑高可用性的网关。
*   在后端服务器上启用运行状况检查；考虑添加速率限制或连接排队来防止过度使用。
*   对将业务逻辑放入网关层要谨慎；更喜欢将工作流决策保留在代码本身中的技术。
*   充分利用来自该层的日志记录和指标；并且寻找方法抽象出配置网关的细节，以便加速新服务的交付。

通过 Pixabay 的特征图像。

目前，新堆栈不允许直接在该网站上发表评论。我们邀请所有希望讨论一个故事的读者通过 [Twitter](https://twitter.com/thenewstack) 或[脸书](https://www.facebook.com/thenewstack/)访问我们。我们也欢迎您通过电子邮件发送新闻提示和反馈: [feedback@thenewstack.io](mailto:feedback@thenewstack.io) 。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>