# 两种尺寸最合适:PostgreSQL 和 ClickHouse

> 原文：<https://thenewstack.io/two-sizes-fit-most-postgresql-and-clickhouse/>

自从 1974 年推出 [System R](https://en.wikipedia.org/wiki/IBM_System_R) 以来，一般的关系数据库，尤其是 SQL 数据库，已经成为行业中数据持久性的主导方法，并且尽管面临各种重大挑战，仍然保持着这种主导地位。尽管有些人谣传传统关系数据库的死亡和衰落，PostgreSQL 已经被证明是对其前身及其假定的继承者的改进。

事实上，开源 MySQL 数据库无处不在，以至于它成为主导早期 web 开发的 LAMP 堆栈(Linux、Apache、MySQL、Perl)的一部分。

这一趋势的一个大例外是在线分析处理(OLAP)，在这种情况下，可以显著提高某些工作负载性能的专门技术已经遇到了实际需要这些技术的用例，新的竞争者如 ClickHouse 实现了质的不同的分析方法。

## **一刀切**

 [西德·西伊布兰迪

Sid 是 DevOps 平台 GitLab，Inc .的联合创始人、首席执行官兼董事会主席。Sid 花了四年时间为 U-Boat Worx 建造休闲潜艇，并在荷兰司法和安全部(Ministerie van Justitie en Veiligheid)从事 Legis 项目，该项目开发了几个创新的网络应用程序来帮助立法。他第一次看到 Ruby code 是在 2007 年，他非常喜欢它，以至于自学了编程。2012 年，作为一名 Ruby 程序员，他遇到了 GitLab，并发现了他对开源的热情。不久之后，Sid 将 GitLab 商业化，到 2015 年，他带领公司通过了 Y Combinator 的 2015 年冬季队列。在他的领导下，该公司从初创公司发展到全球企业，注册用户超过 3000 万。](https://www.linkedin.com/in/sijbrandij/) 

当一项技术占据主导地位时，它会被不假思索地应用，即使它可能不合适，这种情况经常发生，因此各种数据过去和现在都被推入通用关系数据库。

可以找到极端的例子，例如开发人员为总共有五个小元素(而不是列、数据段)的数据集创建远程 Oracle 数据库，或者 Apple 将他们的系统日志推送到 SQLite 数据库(他们后来纠正了这个错误)。

Bind10 的开发是在以 Bind9 作为 DNS 名称服务器，以 SQLite 作为后端来解决伸缩问题的前提下开始的。互联网系统联盟在 2014 年停止了 DNS 开发，OSS 项目 [Bundy](https://github.com/bundy-dns/bundy) 仍然处于非活动状态。PowerDNS 早期关注 MySQL/PostgreSQL 的性能扩展。

2005 年，[Ingres 和后来的 PostgreSQL 背后的数据库研究员迈克尔·斯通布雷克](https://thenewstack.io/dr-michael-stonebraker-a-short-history-of-database-systems/)，与乌尔·埃廷梅尔一起，写了一篇题为[“一个尺寸适合所有人”:一个已经过时的想法](http://cs.brown.edu/%7Eugur/fits_all.pdf)的论文，其中他们认为这已经走得太远太久了，并以[基准测试结果](http://nms.csail.mit.edu/%7Estavros/pubs/osfa.pdf)支持他们的论点。

简而言之，在数据库的核心应用程序(在线事务处理(OLTP ))之外还有许多工作负载，在这些工作负载中，通用数据库架构远远落后于它们，使用它们毫无意义。

应该注意的是，Stonebraker 和 etintemel 并没有反对关系数据库或 SQL，而是反对从最初的 System R 和 Ingres 系统派生出来的一种特定的体系结构，这种体系结构过去和现在都被大多数通用数据库系统所使用。

这种架构具有以下特点:

*   面向磁盘和行的存储和索引结构。
*   多线程隐藏延迟。
*   基于锁定的并发控制机制。
*   基于日志的恢复。

除了特殊用途的文本索引之外，传统体系结构被证明不适合的主要用例是数据仓库，对于数据仓库，列存储被证明比传统的行存储高效 10 到 100 倍。

## **点击屋**

关于 OLAP 数据库引擎将从主流数据库中分离出来的预测在业内已经成为现实。OLAP 数据库凭借其自身的权利已经成为一个重要的类别，本文中讨论的原始 cstore 的商业分支 Vertica 是主要参与者之一。

正如预测的那样，这些数据库对于分析工作的实际优势是足够大的，因此有必要拥有一个单独的数据库引擎。

或者甚至是必要的，就像 Yandex 的 ClickHouse OLAP 数据库一样，它最近分拆成一家刚刚获得 2.5 亿美元 b 轮融资的初创公司

ClickHouse 开发人员希望实时分析不使用定制的数据结构，而是使用通用的数据库引擎，可以使用 SQL 查询。

当然，这通常是用定制的数据结构来完成的，这是有原因的:用通用的数据库引擎来完成被认为是不可能的，部分原因是用现有的引擎是不可能的。

通常情况下，不可能的事情“只是”大量的工作和一些出色的工程，几年后，开发人员得到了他们想要的东西:一个专门用于 OLAP 但足够通用的数据库引擎，可以通过 SQL 查询，并且仍然能够进行实时分析。

工程和基准测试的结果都令人印象深刻，包括我们自己的[测试](https://gitlab.com/gitlab-org/incubation-engineering/apm/apm/-/issues/4#results) ( [视频](https://www.youtube.com/watch?v=cMdQsxolcqc))。

它比 PostgreSQL 扩展(如 Citus 或 TimescaleDB)快得多，据报道也比 Vertica 快。

## **一个时代的终结？**

2005 年的白皮书认为 OLTP 是传统(基于磁盘、面向行、多线程)体系结构唯一可行的领域。两年后，Stonebraker 出版了“[一个架构时代的终结(是时候彻底重写了)](http://nms.csail.mit.edu/~stavros/pubs/hstore.pdf)”，他在书中认为，即使对于 OLTP，现有的引擎也可以被超过 10 倍。

关键的见解是，关于不同组件的相对性能的长期假设不再准确，因此，根据 Stonebraker 等人的说法，数据库引擎大约 90%的性能预算不是用于实际处理数据，而是用于缓冲区管理和锁定等开销。

因此，如果我们能够消除这些开销，我们就能制造出比现有引擎快 10 倍的数据库引擎。要实现这些好处，需要构建一个单线程的、在主存中工作的数据库引擎，这与现有的体系结构完全不同。

但不是前所未有的。自从那些早期的数据库被设计以来，主内存容量已经提高了 100 多万倍，所以许多过去由于大小而需要持久存储的工作负载现在可以在内存中处理。

例如，甚至在 21 世纪初，雅虎就有一个政策，任何小于 2GB 的数据集都应该存在于 RAM 中，而不是磁盘上。不久之后，事件海报架构、进程内 [REST](https://link.springer.com/chapter/10.1007%2F978-1-4614-9299-3_11) 和 [LMAX](https://martinfowler.com/articles/lmax.html) 与 [Disruptor](https://lmax-exchange.github.io/disruptor/) 模式的交换证明，从复杂的多线程、基于磁盘的系统迁移到单线程、基于 RAM 的架构，可以在简单性、可靠性和性能方面产生巨大的好处。

那是 32 位计算。如今，我们只需点击一下鼠标，就可以获得为我们配置了数十 TB 内存的单个服务器(以及随后的账单……)，因此我们可以保存在 RAM 中的工作负载相当可观。

Stonebraker 和他的团队建立了一个学术原型 H-Store 和一个商业产品 VoltDB。

它并没有席卷数据库世界。

令人惊讶的是，这并不是因为它不像预期的那样工作。从所有的报告来看，它似乎确实像宣传的那样工作。

然而，它的承诺伴随着权衡，似乎这些权衡对于大多数领域来说并不理想。首先，尽管现在将整个数据库一直保存在 RAM 中是可行的，但对于大多数域来说，这可能不是一个好的性价比权衡，因为大多数数据都是冷的。

第二，尽管更高的峰值性能是可能的，但机器现在如此之快，以至于最高可能的峰值性能只对非常特殊的领域是必要的。

第三，由于计算机速度如此之快，性能通常也足够，性能焦点已经从峰值甚至吞吐量转移到最坏情况下的延迟。在只有一个线程访问数据库的情况下，一个很长的查询就可能导致整个数据库停止运行，并导致极其严重的后端延迟。因此，使用传统的吞吐量和峰值性能指标的最快的数据库实际上可能需要非常小心，不要在人们现在最关心的性能指标上得分最差。

最后，同样重要的是，要求分布式设置，虽然对于大型安装来说很好，但对于入门级设置来说负担很重，这意味着这种技术没有很好的入口。

## **PostgreSQL**

因此，看起来传统架构的 OLTP 数据库的时代实际上还没有结束。当然，这不应该是斯通布雷克教授太多的关注，因为最终胜出的竞争者仍然是他的创意，只是更早的一个。不，不是 T2 的 Ingres，而是它的继任者 PostgreSQL。

根据行业情绪和数据库[排名](https://db-engines.com/en/ranking/relational+dbms)，PostgreSQL 正在成为或者已经成为这些传统架构数据库的主要变体。它肯定是不依赖于某个主要数据库供应商的引擎之一。

在 GitLab，我们也使用 PostgreSQL 进行复制，在 2019 年将[从 MySQL 中移出](https://about.gitlab.com/blog/2019/06/27/removing-mysql-support/)，部分原因是 PostgreSQL 具有对我们很重要的功能，部分原因是我们的大多数客户无论如何都在使用它。

## NoSQL 怎么样？

尽管本世纪初的 NoSQL 运动确实指出了主流数据库的一些缺点，但技术处方实际上只在极少数情况下才有意义。

NoSQL 并不是一个真正的类别，而是 PostgreSQL 等丰富数据库引擎的一个特性。

随着计算能力和快速存储的增加，传统数据库引擎可以处理高容量和高事务率，非传统引擎可以使用 SQL 作为接口来服务于关系模型，参见 VoltDB 和 Google 的 Spanner，构建在 Bigtable 之上。

有些用例不需要关系数据库，键值存储就足够了，或者需要 JSON 文档存储；例如，PostgreSQL 中的 JSON 类型可以很好地处理大多数用例。即使对于非常专业的用例，如文本或地理信息系统数据，现代关系数据库引擎也提供直接支持。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>