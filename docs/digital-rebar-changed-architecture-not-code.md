# 我们如何在六个简单的步骤中改变数字力霸的架构，而不是它的代码

> 原文：<https://thenewstack.io/digital-rebar-changed-architecture-not-code/>

[](http://robhirschfeld.com/digital-rebar/)

 [罗布·希施菲尔德

罗布·希施菲尔德是 RackN 的首席执行官兼联合创始人，该公司为以容器为中心的数据中心提供编排软件。他已经在云计算和基础设施领域工作了近 15 年，从早期的 ESX 测试版开始工作，到在 OpenStack Foundation 董事会任职四届。作为数字 Rebar 项目的联合创始人，Rob 创建了新一代 DevOps 编排工具，以利用容器和面向服务的运营。他认为，在云上运行数据中心和应用程序的技术只是更大故事的一部分。作为一名工业工程师，他热衷于将精益和敏捷流程应用到软件交付中。](http://robhirschfeld.com/digital-rebar/) [](http://robhirschfeld.com/digital-rebar/)

在过去的几个月里，我们在没有真正改变太多核心代码的情况下，将我们的[数字 Rebar](https://digitalrebar.github.io/) 编排平台显著改变为微服务架构。虽然这一过程仍在继续，但我们已经到了分享经验的时候了。

结果超出了我们的预期。我们不仅在代码区域之间有了更好的分割；我们看到启动时间大幅减少，因为我们消除了许多不必要的配置和下载。不利的一面是，我们不得不大幅重写我们的网络和启动顺序。在容器后面运行真正的网络服务(如 DHCP 和 PXE)要复杂得多。

我们的起点是 [OpenCrowbar](https://crowbar.github.io/) 代码库。它已经在使用 [Consul](https://www.consul.io/) 进行一些操作；然而，我们希望完全迁移到基于 [Docker Compose](https://docs.docker.com/compose/) 的系统，这样我们就可以将已经在使用的服务从 Rebar 核心中分离出来。

Digital Rebar 做跨平台 DevOps 编排。基本上，它在云和金属上部署软件。除了跨多个云平台部署之外，Digital Rebar 还扩展了 Crowbar 的深度裸机配置引擎。系统的关键设计要求之一是混合开发运维服务和配置步骤，因为服务器或云配置中的许多步骤实际上都是服务调用，如 DNS、DHCP / IP 分配、PXE、磁盘分配或网络分配。

由于需要服务管理，我们已经不得不将服务作为架构的核心部分来处理。然而，硬连线的服务接口和用无状态容器创建的动态环境之间有一个重大的飞跃。这是我们走过的路:

## 步骤 1:接受服务注册(咨询)

当我们的应用程序还是单片的时候，我们添加了 Consul，然后在 Consul 中注册了我们的各种服务。渐渐地，我们用对注册中心的引用代替了所有查找这些服务的地方。具体来说，不是从共享配置中获取服务信息；我们将依赖已发布的服务数据。最初，这感觉就像在我们房子的房间之间使用电话交谈，但这允许我们安全地逐渐增加服务和消费者之间的分离。

## 步骤 2:容器协调(合成)

这可能看起来有些落后，但是我们在进行任何真正的容器化之前就已经开始使用 Compose 了。Consul 用于协调一组互连容器的启动。它还提供了有用的容器配置管道，如外部路径映射和端口暴露。

值得注意的是，我们已经将单片应用程序容器化了，所以将它包装成 Compose 只是一小步。如果您还没有将应用程序封装到一个容器中，那么就从这里开始吧。

从单个容器编排开始，我们有了一个工作参考点。它还让我们习惯于构建控制模型。一个意想不到的好处—一致的日志记录。将日志发送到控制台会有很高的回报，这样它们就可以很容易地从 Compose 进行监控。

## 第三步:集装箱化(码头工人)

有了框架之后，我们开始将服务分解到容器中。我们通常遵循我们在第一步中确定的服务。在某些情况下，当我们将紧密耦合的服务从父应用程序中分离出来时，我们会将它们保持在一起。其他的，比如我们的数据库，很容易分离出来。第三类容器是服务 API 包装器。

API 包装器是小型的专用 web 服务(通常在 Golang 中),我们在打包时将它们添加到现有的服务中。这些新的 API 为以前直接调用的代码创建了一个简单的抽象点。API 是必不可少的，因为容器不能直接调用代码，但增加了最小的开销，因为它们是我们应用程序的专用函数。

## 步骤 4:服务容器注册(再次咨询)

当我们了解我们的内部模式时，我们的注册过程就正常化了。我们能够创建一个一致的容器初始化模式，包括每个容器的服务注册，以及具有依赖关系的容器的等待过程。谢天谢地，这意味着更少地依赖 Compose 进行排序，更多地使用服务注册作为我们的协调机构。最终，这使得容器更加独立和无状态。

如果你发现自己依赖 Compose 来准确地安排你的成长，那么回顾一下这个过程，找到消除或削弱依赖的方法。否则，您的应用程序将比以前更加脆弱。

## 第五步:建立关系网(你得到你所得到的)

网络在容器中是一个挑战，因为容器对它的控制很少。关键是永远不要在服务中构建网络假设或静态信息。假设容器管理将处理入站规则，并且从不假设任何地址是静态的。如果这听起来像是您希望服务侦听器是哑的，而出站请求是动态的，那么您已经有了这个想法。

对于 Digital Rebar，我们必须创建一个路由流量的容器(许多像 PXE 和 DHCP 这样的 Ops 服务都很挑剔，它们关心数据包的来源)。希望你能够避免这种混乱。如果您有类似的问题，请联系我们。

## 步骤 6:数据局部性(文件、数据库和咨询)

一旦我们愉快地将所有服务容器化，真正的挑战就开始了:我们需要我们的容器变得无状态。这意味着容器不能存储任何内部数据或配置。对于像数字 Rebar API 服务器这样的容器，选择很简单，使用数据库。像 DNS、DHCP 和我们的 Provisioner(存储 PXE 图像)这样的支持服务变得更加棘手。对于每个服务，我们必须评估存储了多少数据，数据更新的频率，以及它是否能容忍分布式锁。每个容器没有单一的模式，甚至没有单一的答案。

我们的经验法则是这样的:如果应用程序数据库是规范化的应用程序数据或托管配置，就使用它(通过 API)。如果共享文件位置足够大和/或足够静态，可以通过 rsync 缓慢复制，则使用共享文件位置。如果 Consul 的数据量有限，需要进行有限的搜索，请使用 Consul。对于 Consul 数据，我们在提交之前还会评估多主同步的风险。

总的来说，我们发现保持数据存储选项开放是正确的方法。

## 摘要

简而言之，做好迁移过程中重构和脆弱的准备。

迁移到容器中的服务使我们的平台更健壮，更容易排除故障，部署更快。它也驱动了许多计划外的重构，虽然最终是有帮助的，但我们不会有其他的计划。迁移中最令人沮丧的部分是我们发现容器状态的脆弱性和导致第六步的持久性。

总的来说，随着架构的变化，数字 Rebar 变得更加强大和可维护。我们希望听到我们的旅程对你有所帮助。

Docker 是新堆栈的赞助商。

专题图片:Edvin Andren and Co. catalog，1874-1875，[瑞典国家图书馆](http://libris.kb.se/)，via [新老库存](http://nos.twnsnd.co/)。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>