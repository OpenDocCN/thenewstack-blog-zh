# 有状态数据:Couchbase 及其多重一致性模型

> 原文：<https://thenewstack.io/stateful-data-couchbase-and-its-multiple-consistency-models/>

构建分布式应用程序并不容易。我们需要抛弃我们在数据中心和桌面工作中学到的许多东西，在那里代码可以在受控的集群中运行，延迟是我们最不担心的问题。把它带到云上，模型就改变了:我们不再担心微服务是否正在运行，只担心它的状态随时可以访问，并且可以被另一个服务实例获取。

状态在现代云原生应用中至关重要，这使得我们使用的数据库更加重要。不过，有个问题。这些数据库需要针对云原生世界进行设计，在云原生世界中，规模是关键，并且我们需要围绕全球规模网络的物理特性来设计我们的应用和服务，该网络正在转移不断增长的数据量。

### NoSQL 变得结构化了

有趣的是，我们可以看到数据库，尤其是 NoSQL 的商店是如何处理这个问题的。NoSQL 作为一个国家商店特别有吸引力:它是一种无模式的数据处理方法，为 NoSQL 平台提供了传统关系平台无法提供的速度和灵活性。无论您存储的是简单的键/值对还是更复杂的 JSON 文档，NoSQL 都可以提供您需要的东西，以可伸缩的方式支持半结构化数据。

最初的 NoSQL 数据库之一 Couchbase 经历了一次重大的重新架构，重点是支持云原生应用。像微软的 [Cosmos DB](https://thenewstack.io/cosmos-db/) 一样，它现在是一个多模式数据库，从它存储的半结构化数据中动态生成一个灵活的模式。这使它能够提供 NoSQL 的写入速度，并可以选择通过 SQL 方言 N1QL 查询数据。正如 [Ravi Mayuram](https://www.linkedin.com/in/ravimayuram/) 所言，Cochbase 的高级工程副总裁兼首席技术官指出，“SQL 基本上是一种函数式编程语言”，一种基于集合论的语言。

> 设计数据库是一项复杂的数学任务。核心是索引的概念，管理对数据的访问。

许多现代数据库设计都可以追溯到这些数学根源。你只需要看看像菲尔·伯恩斯坦和已故的 T2、吉姆·格雷以及 T4、莱斯利·兰波特这样的图灵奖获得者在这个领域的影响力。他们的理论工作一直是最近许多数据库创新的核心，即使其中许多可以追溯到几十年前。这并不是说他们所做的工作被遗忘了，只是现在有了云托管的分布式编程模型，我们才需要实施基础研究。

设计数据库是一项复杂的数学任务。核心是索引的概念，管理对数据的访问。在底层，Couchbase 提供了几个索引，用一个键/值存储作为主索引，用动态模式作为辅助索引。正是这个二级索引赋予了 Couchbase 多重个性，允许跨整个存储进行 SQL 查询，即使数据本质上不是关系型的。通过构建内存存储，速度很快。

正如 Mayuram 向我指出的，速度不仅仅来自于内存。“所以有两个方面总是会变得更好。一个是记忆，这很好。但这并不能解决整个问题。第二部分是网络越来越快。实际上，通过网络获取数据比从磁盘缓存数据更快。”

### 使用一致性模型减少查询延迟

延迟永远是分布式数据库的一个问题，即使它们在内存中并且是围绕现代网络技术构建的。打算在云中大规模使用的数据库需要利用替代方法来确保碎片和实例之间的一致性。当在实例之间复制数据时，实例是否有必要完全同步，从而增加应用程序延迟，或者我们是否可以利用与我们构建和操作应用程序的方式更加一致的备用一致性模型。

从本质上讲，Couchbase 对于写操作具有很强的一致性，二级索引的作用范围是单个索引节点，然后在整个集群中复制。然而，当涉及到查询数据时，情况就不同了，提供了与 Cosmos DB 相似的一致性模型，提供了不同的方法来查询具有不同级别的延迟和可靠性的数据。您需要做的就是挑选最符合您应用需求的型号。

也许最有用的选项是 Read Your Own Writes，这是一种基于会话的一致性模型。当数据库跨群集和副本复制数据时，您的查询范围是用于写入的实例。如果您使用 Couchbase 来管理购物车或类似的东西，而您只对与当前事务相关的记录感兴趣，那么这是一种非常有用的技术。在其他实例中所做的更改不会反映在结果中，因此您需要确保您的查询只针对您编写的数据，并且该数据是不可变的。

### Couchbase SDK 中的一致性

还有另外三种一致性模型可以使用，通过 SDK 调用解决。当您不关心底层数据的一致性，而只关心索引的当前状态时，默认值是为了提高速度。这确实意味着结果可能会在读取之间发生变化，或者您写入数据库的数据不会立即可见。如果你使用这个选项，你可能想要使用 Couchbase 的两个索引器中较快的一个，因为它每 20 毫秒更新一次内存中的二级索引。

请求加查询是一个有时间限制的查询，由您进行查询的时间定义。这使得它成为一个非常严格的一致性模型，因为它需要确保所有的索引都是最新的。使用这种方法的任何查询都会有延迟，因为数据库必须处理所有相关的写入和更改，然后在实例之间传递它们。就所有必要的检查和处理的计算而言，它可能是昂贵的。

最后一个选项提供“高性能一致性”，内部称为 AT Plus。在这里，查询链接到与数据库的特定更改相关联的更新。因此，如果您编写一个记录并处理它，在处理后读取它，对记录的更改将作为结果的一部分返回。这意味着您的数据与特定的更改一致，如果您的查询与集群中的单个节点相关联，这可能会非常快。实际上，AT Plus 查询比同等的 request plus 查询快 10 倍。

将所有这些放在一个在云规模上工作的 NoSQL 数据库中是非常有意义的，尤其是现在 Couchbase 提供了在 Kubernetes 内部运行并按需自动扩展的工具。像这样的分布式数据库是云存储的未来，提供一个以上的一致性模型是提供开发人员需要的灵活性和性能的关键。这是许多其他数据库在未来几年将要走的一条路。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>