# 对于大规模日志管理，计算和存储应该分离

> 原文：<https://thenewstack.io/why-compute-and-storage-should-be-decoupled-for-log-management-at-scale/>

[](https://logiq.ai/)

 [蒂托·乔治

蒂托·乔治是 logiq.ai 的联合创始人，他拥有超过 14 年的软件系统开发经验。Tito 在印度班加罗尔工作，他喜欢开发分布式系统，特别关注 DevOps 和可观测性。他喜欢谈论云原生以及公司如何采用云原生策略来在竞争中保持领先。在推特上关注他@titogeo](https://logiq.ai/) [](https://logiq.ai/)

大多数日志管理解决方案将日志数据存储在数据库中，并通过存储数据的索引来实现搜索。随着数据库规模的增长，索引管理成本也在增加。在小范围内，这不成问题。但是，在处理大规模部署时，除了数据本身之外，组织最终还会使用大量计算、存储和人力资源来管理索引。当公司每天都在处理万亿字节的数据时，数据库支持的日志管理系统变得难以为继。

另一个常见问题是，大多数日志解决方案不仅仅存储一组数据。许多 DIY 日志管理实现使用流行的数据库，如 [MongoDB](https://www.mongodb.com/cloud/atlas/?utm_content=inline-mention) 、ElasticSearch 和 [Cassandra](https://www.datastax.com/?utm_content=inline-mention) 。我们以 ElasticSearch 为例。一个 ElasticSearch 集群在 hot store 层运行多个数据副本，以确保高可用性。即使使用数据压缩，保持数据可用所需的复制仍然会显著增加所需的存储总量。当您考虑索引所需的存储时，这个问题就更大了。

群集还增加了管理的复杂性，并要求用户了解如何管理节点故障和数据恢复。即使使用复制，当一个实例停机时，也不可能立即启动一个新的实例。在大多数情况下，当日志分析系统变得不可用时，会有一些停机时间。当这种情况发生时，数据会继续进来，因为日志是实时生成的。赶上进度需要额外的资源供应。因为实时数据从未停止，所以很难让日志分析系统跟上。一键式灵活性对于大规模管理至关重要。

上述挑战是任何 DIY 解决方案都必须支付的隐性**“存储运营税”**的典型例子。**规模越大，税收越高！**一家每天接收大约 1tb 数据的公司，如果希望保持 30 天的日志数据可供搜索，则需要 1tb 的存储空间和相应数量的 RAM。

解决这个问题的方法是远离数据库，使用可伸缩的 API 存储层。像[亚马逊网络服务](https://aws.amazon.com/?utm_content=inline-mention)S3 这样的 API 存储层，传统上用于冷存储，非常适合这个需求。它提供了高可用性和耐用性、无限的可扩展性、最低的每 GB 价格，并有效地将您的存储运营税降至零。但是，要做到这一点，必须确保应用程序不会出现冷存储中常见的较高延迟。

## 您是否保留了 30 天的数据？

企业认为他们在热存储中保存了 30 天的日志数据，但实际上他们并没有这样做。大多数查询都是以定期运行报告的形式进行的，与坐在控制台前的用户没有交互作用。在一分钟内接收数百兆字节或数千兆字节的日志数据并不罕见的情况下，这一点尤其明显。这种环境中的交互式工作流侧重于识别相关事件和数据模式，然后将这些事件和数据模式编程到机器中，并转换为对管理员的及时实时通知。这意味着大多数数据根本不需要存储在热存储中，而是可以在接收过程中进行在线处理，或者在稍后的时间点进行异步处理。

公司将数据快速转移到 S3 兼容或其他冷存储中还有另一个很好的原因。缩短数据库中的数据持续时间将数据存储与计算分离开来，使组织能够更轻松地扩展存储和从崩溃的集群中恢复。将数据存储在冷存储中比存储在数据库中便宜得多，并且扩展冷存储比扩展数据库更容易。

然而，这种方法产生了一个新问题，我们需要将数据分成多个层；冷热。在两个层之间移动和管理数据需要专业知识。现在，关于分层内容、移动数据的频率以及何时用冷层中的数据补充热层的考虑事项变得和往常一样。“仓储运营税”刚刚上涨。

## 如果我需要长期数据保留怎么办？

在高度管控的环境中，短期保留通常不是一个选项，因为企业必须存储数据、编制索引并使数据可搜索几年。同样的问题也存在，尽管规模更大。我们需要在大量昂贵的主存储和分层存储体系结构之间做出选择。根据这些要求，分层实施的情况并不少见，大多数数据位于冷层，但大量数据仍位于热层(例如，30 天的保留期)。“存储操作税”不会有任何变化，只会增加。

## 消除传统存储体系结构和数据分层

公司使用分层存储方法，因为他们担心失去在冷存储中搜索数据的能力。如果有必要进行搜索，繁重的请求过程会使访问日志变得缓慢而困难。对旧数据进行实时搜索是不可能的。对于某些应用程序类型，这没什么大不了的。尽管如此，对于创收的关键路径应用程序来说，快速、实时地访问日志并能够在接到通知后立即从中获取信息是至关重要的。拥有多个数据层，其中有一个“热”存储和一个“冷”存储，会产生成本和管理开销，尤其是对于第 2 天的操作。把所有东西都搬到热的商店会非常昂贵——那么如果你能把冷藏作为你的主要商店会怎么样呢？

## 让 S3 变得可搜索或“零存储运营税”

如果我们能让 S3 兼容的存储像数据库一样可搜索，会怎么样？公司将日志数据保存在数据库中的原因是为了实现实时搜索。尽管如此，在实践中，大多数组织在数据库中保留的历史数据并不像其官方数据保留策略所规定的那样多。假设任何与 S3 兼容的商店都可以像数据库一样被搜索。在这种情况下，组织可以大幅减少存储在数据库中的数据量以及管理这些数据所需的计算资源。最新的数据——比如说，一分钟的数据——可以存储在磁盘上，但一分钟后，所有的数据都会转移到 S3。不再需要运行一个数据库的多个实例来实现高可用性，因为如果集群关闭，一个新的实例可以启动并指向同一个 S3 兼容的存储桶。

将日志数据直接移动到冷存储，同时确保实时可搜索性，这使其更易于扩展，提高了日志数据的可用性，并大大降低了存储和计算资源的成本。当在冷存储中直接访问日志数据时，用户不必担心管理热存储层和冷存储层之间的索引、数据再水化或构建复杂的策略。这还意味着公司可以遵循他们的数据保留计划，以确保开发人员可以访问日志并使用它们来调试关键应用程序。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>