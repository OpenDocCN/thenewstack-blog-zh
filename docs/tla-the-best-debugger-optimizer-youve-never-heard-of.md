# TLA+:你从未听说过的最好的调试器/优化器

> 原文：<https://thenewstack.io/tla-the-best-debugger-optimizer-youve-never-heard-of/>

![TLA+ logo](img/e767683834dba29d710d72c39ba8d759.png)2012 年，当[亚马逊网络服务](https://aws.amazon.com/?utm_content=inline-mention)将 DynamoDB 作为一项商业服务推出时，它带来了额外的可靠性保证。分布式数据库系统的复制和容错机制通过了通常的设计和代码审查、广泛的测试，并在一系列非正式的正确性证明中得到检验。

但是在这个案例中，进行了额外的检查。这些功能的代码库也是通过基于离散数学的正式规范语言建模的，称为 [TLA+](https://github.com/tlaplus) 。TLA+发现了一个以前遗漏的错误，当特定的故障序列和恢复步骤与其他处理交错时，该错误可能会导致数据丢失。这是一个极其微妙的错误；展示该错误的最短错误跟踪包含 35 个高级步骤。

通过 TLA+，AWS 工程师还发现了其他以前无法检测到的细微错误，更好的是，他们能够“在不牺牲正确性的情况下进行积极的性能优化”，云巨头“[随后的一篇论文提到了亚马逊网络服务如何使用正式方法。](https://cacm.acm.org/magazines/2015/4/184701-how-amazon-web-services-uses-formal-methods/fulltext)”

“一些更微妙、更危险的错误被证明是设计上的错误。我们发现测试代码作为发现这些错误的方法是不够的，因为代码可达到的状态数量是天文数字，”工程师写道。

长期以来，形式上验证程序的正确性被认为是一项昂贵的任务，因此它的使用主要限于安全关键的应用。但是 AWS 软件工程师声称它可以被更广泛地使用。特别是，它可以用来解决分布式云本地系统中棘手的并发问题。

微软也从 TLA+中受益。TLA+在 Xbox 的内存设计中发现了一个严重的错误，这个错误可能会在四个小时的游戏后关闭主机。

亚马逊网络服务的分布式系统工程师 Murat Demirbas 在他在布法罗大学教的课上测试了 TLA+,发现这种语言很有用。尽管学习曲线很陡，“学生们喜欢 TLA+，因为它给了他们一种实验的方式，并支持他们对算法进行推理，”他[写道](https://muratbuffalo.blogspot.com/2015/01/my-experience-with-using-tla-in.html?m=1)。引用一篇论文，行业观察家阿德里安·科勒[建议](https://blog.acolyer.org/2017/08/30/a-concurrent-perspective-on-smart-contracts/) TLA+可以用来检查智能合同。

尽管经过严格的测试，还是会发现 bug？可能是时候进行一些正式的规范和模型检查来帮助解决关键系统中的困难设计问题了。

## 它是如何工作的

软件顾问 Hillel Wayne 第一次知道 TLA+是在一个教育系统上工作，用他的话说，这是一个“偶然分布的系统”，在那里许多重复出现的“奇怪的错误”不断出现。它们通常是运营团队无法控制的第三方软件之间的冲突。

“我看到了亚马逊是如何使用它的，并认为这可能是值得尝试的东西。我在几周内就学会了，”韦恩说。在工作中申请，他抓住了一堆关键的错误，并削减了一些时间的交货时间表。

韦恩想知道为什么除了亚马逊之外，似乎很少有人使用它。事实证明，除了一些更侧重于形式数学方面的书籍之外，严重缺乏关于使用规范语言的教育材料。为了填补 TLA+的信息空白，Wayne 写了一系列教程，一本书，现在专业教授 TLA+。

作为一种数学语言，TLA+使用时态逻辑来推理并发系统。这个名字是动作的时间逻辑的首字母缩写，因为它是由它的创造者 Leslie Lamport 定义的。作为分布式系统科学的先驱，Lamport 一直倡导开发人员在实际编码之前对系统建模的重要性。

对于任何系统来说，它既规定了系统应该做什么——它期望的“正确性属性”——又规定了系统应该如何工作，即它的设计。伴随的显式状态模型检查器检查所有可能的执行状态*的期望正确性。*

TLA+有点像建筑设计。正如房屋建筑商不会随意建造房屋一样，大规模软件开发也应该遵循高水平的设计。编码人员将无法知道不同的组件如何在更高的层次上进行交互。

架构图本身并没有提供测试的方法。但是 TLA+也提供了一个包含每个组件属性的地方。通过属性，TLA+可以对设计进行模型检查，寻找可能导致不良状态的可能组合和边缘条件。一个简单的例子是队列可能改变它处理消息的顺序，这可能会混淆两个组件之间的事务。

使用 TLA+有多种方式。人们可以勾画出他们想要创建的程序的高层次概述，然后映射到 TLA+原则，然后从中导出代码。或者他们可以反其道而行之，将现有的代码库翻译成 TLA+,以获得更高层次的概述。

许多 TLA+用户依赖 TLC，一个模型检查器，是 [Lamport 的 TLA+工具箱](https://lamport.azurewebsites.net/tla/toolbox.html)的一部分，可以运行一个系统所有可能的排列。模型也可以手工检查，但这确实很耗时。

TLA+可以解决的一个典型问题是保证幂等性，即一条消息只需要发送一次。这一要求可以从各种供应商保证中推导出来，例如从不多次发送消息，至少发送一次。

“它能够从本质上测试你的架构图，”Wayne 说。

[https://www.youtube.com/embed/ATobswwFwQA?start=19&feature=oembed](https://www.youtube.com/embed/ATobswwFwQA?start=19&feature=oembed)

视频

## 缓慢接受

虽然大约十年前围绕 TLA+有一些讨论，但是宣传似乎已经减弱，尽管它立即适用于分布式云原生系统。当它出现在黑客新闻(Hacker News)等论坛上时，大多数好奇的人承认它可以帮助他们的工作，但他们没有时间学习或使用 TLA+。

有一点学习曲线。在 Wayne 教授的研讨会上，学生通常能够在第三天左右找到复杂代码中的实际 bug。他的大多数学生是开发人员和软件工程师，也有一些 IT 架构师和项目经理。韦恩估计，他们自己可能在几周之后就能达到那种熟练程度。通常可以使用一个叫做 [PlusCal](https://learntla.com/pluscal/) 的工具，它为规范提供了一个更加以开发人员为中心(而不是以数学家为中心)的伪代码式接口。

采用的一个更大的障碍是它需要项目工程师的时间。输出的是设计，而不是代码，因此工程师仍然必须进行设计到代码的转换，反之亦然(尽管有一个好处，即使是映射程序或提议的程序的手工工作，也可能使工程师明显地发现他们以前可能没有想到的错误)。

此外，企业对 TLA+的全面采用超出了编码人员的范畴，需要改变项目工作本身的结构。时间敏感项目的经理(什么项目不是？)可能不想考虑额外的验证步骤。为了获得 TLA+的全部好处，项目团队应该考虑加入 TLA+的额外步骤。

[https://www.youtube.com/embed/p54W-XOIEF8?feature=oembed](https://www.youtube.com/embed/p54W-XOIEF8?feature=oembed)

视频

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>