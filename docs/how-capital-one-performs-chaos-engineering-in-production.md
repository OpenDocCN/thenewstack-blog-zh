# Capital One 如何在生产中执行混沌工程

> 原文：<https://thenewstack.io/how-capital-one-performs-chaos-engineering-in-production/>

在本周举行的 [DevOps 企业峰会](https://events.itrevolution.com/) 上，Capital One 软件工程高级总监布莱恩·皮诺斯 对在线人群说:“我们喜欢说我们是一家做银行业务的科技公司。”。

这家拥有 1 亿客户的财富 100 强公司已经有 28 年的历史了——对于一家美国银行控股公司来说还很年轻，但却远早于云原生金融科技的时代。尽管如此，在 2020 年，Capital One 成为第一家完全在公共云上运行的银行，使其成为亚马逊网络服务最大的客户之一。这与金融行业不愿向云转移的态度背道而驰，MYHSM 首席执行官 John Cragg 认为云是基于法规、成本和安全性的不确定性。

那么，Capital One 如何克服这种保留，仅通过公共云提供不间断的银行和信贷服务呢？随着对计划内和计划外 [混沌工程](https://thenewstack.io/chaos-engineering-can-give-distributed-systems-stability/) 和生产中测试 [和大剂量开源](https://thenewstack.io/how-open-source-drives-cloud-innovation-at-capital-one/) 的坚定投入。请继续阅读，了解受控混乱如何在 Capital One 占据主导地位，以及他们认为自己需要什么才能更上一层楼，成为一个精英 DevOps 组织。

## Capital One 如何在生产中进行测试

[混沌工程](https://thenewstack.io/chaos-engineering-business-value/) 是一个有十年历史的 DevOps 实践，它给科技对快速和破坏事物的痴迷带来了积极的旋转。有点矛盾，混沌工程实际上是受控的实验，旨在将服务推向极限，并测试围绕软件弹性的过程。它不是混乱的，而是有条不紊的，可测量的，如果做得好的话，可以快速恢复。TNS 的同事 Maria Korolov 写道 ，在着手解决整体业务影响和弹性目标之前，公司通常会专注于他们已经知道的问题。

虽然混沌工程的 [原则](https://principlesofchaos.org/) 特别关注于承受生产中的动荡条件，但很少有组织达到了在生产中运行混沌的程度。毕竟，没有人真的想破坏客户服务。

Pinos 的同事兼 Capital One 的稳定性和网站可靠性工程总监 [Yar Savchenko](https://www.linkedin.com/in/yar-savchenko-6a973723/) 在发布之前说:“ [在生产中测试](https://thenewstack.io/honeycombs-charity-majors-go-ahead-test-in-production/) 被认为是一个不好的词，你没有测试你的代码。他说，实际上，维护较低质量保证环境和生产之间的一致性是极其困难和昂贵的，“几乎不可能，也不值得这么麻烦。”

相反，他的团队使用 [AWS 故障注入模拟器](https://docs.aws.amazon.com/fis/latest/userguide/what-is.html) 、 [AWS 系统管理器](https://aws.amazon.com/systems-manager/) 和其他混沌工程工具，以及他们内部开发的工具，在生产中生成现实的高负载——就像周五发薪日的负载一样。

皮诺斯解释说，它们“是对抗复杂性和假设失败的工具”，包括每月的游戏日，以及“计划外”——或事先没有警告——的混沌实验。

## 没有基础设施作为代码，就不会有混乱

Capital One 团队解决了大规模的某些失败:

*   **应用层故障**–内部工具 Cloud Doctor 通过在一小部分生产环境中模拟应用程序层故障来帮助团队了解环境的复杂性，因此他们可以观察发生了什么，然后努力使其更具弹性。
*   **可用性区域故障**—模拟—当每个人都还醒着并在工作时—如果一个区域发生故障，它会自动重新路由到一个新的区域，然后容器会自动重新连接吗
*   **区域故障**–他们需要确保，如果一个或多个区域出现故障，他们有能力从一个区域运行出去。

虽然这是一个非常技术性的内部过程，但它以一个假设对话开始——如果 X 发生故障，我们会怎么办？—为特定的体系结构故障创建灾难场景。

Pinos 表示，如果没有通过基础设施即代码(IaS)进行标准化部署，Capital One 团队将无法实现上述任何目标。“为了理解所有云的复杂性，你必须在工具上投资，”他继续说道，你必须“通过有针对性的练习来摆脱手动干预。”

## 降低延迟和提高容量的混沌工程

Capital One 第一轮混沌实验的大部分内容都是为了寻找答案:

*   一个关键系统在极端负载下会有怎样的表现？
*   如果其中一个区域或数据中心出现故障，会发生什么情况？
*   API 网关能够扩展吗？
*   负载平衡器的大小是否正确？

这些答案有助于他们主动识别多个微服务的几个潜在延迟增加场景。

“通过进行大量计划内和计划外的混沌练习，我们已经发现了潜伏。Savchenko 在同一场演讲中说:“我们无法达到光速，所以你必须传输的数据越多，数据中心之间的距离越远，你的延迟就越大。”。他说，数据只会来回反弹，然后，“如果发生了变化，比如某个组件出现故障，或者您的主数据库从一个中心或地区移动到另一个中心或地区”，事情就会超时，客户就会受到负面影响。

组件彼此离得越远，引入的等待时间就越长。Savchenko 继续说道:“没有客户会为了你的应用程序加载而等待 30 秒。因此，Capital One 重点关注移动组件和 [云组件](https://thenewstack.io/the-right-sizing-problem-in-cloud-computing-and-how-to-solve-it/) 。

他们还发现了一些能力方面的发现。“云的好处是您可以无限制地扩展，从零扩展到任何合理的数量。这是有成本的，但有时你没有正确地调整你的云原生资源，所以当流量转移时，你没有良好的计算能力，”他继续说。

通过混沌工程，他们发现了一些情况，其中资源的大小没有正确地适应用户访问的高峰——“有时当我们期望——当人们拿到工资的时候——但也有其他不可预测的原因，”他解释道。

尽管“IT 部门没有人喜欢流程”，Savchenko 说他们需要围绕下一步做什么建立一个流程，通常旨在通过配置更改、容量扩展或重新架构来缓解 30 天内发现的问题。他说，通常情况下，规模和延迟缺陷可以很快解决。

## 生产中测试的风险

正如在实际用户身上进行的任何实验一样，生产测试存在固有的风险，但是，皮诺斯认为，其价值远远超过风险。

意想不到的影响包括:

*   延迟增加
*   缺乏足够的能力
*   实际故障
*   在混乱发生的同时，在产品的同一区域发生的真实事件

“管理风险的关键是减轻风险，”Pinos 说。您需要从一开始就让测试人员与业务和技术涉众坐下来，就您的实验的限制创建一个一致同意的剧本。如果你达到了那个阈值，你就中止测试。他说，每个人都必须事先就回滚触发器和技术达成一致，这些触发器和技术可以在五分钟内执行——“任何可以消除控制缺失的东西。”

当然，为了大规模实施混沌工程，你必须知道有一个问题，这就是对所有关键系统和事务进行实时监控的原因。首先，在测试之前了解稳定率，然后在测试期间进行监控，然后在测试之后再次检查稳定率。

Pinos 说:“如果你在调用路径中引入了延迟，并且没有验证延迟是否已经消失，那么你就有一个非常大的问题。”

监测也是必要的，以衡量无通知混乱事件的影响，迄今为止，已有经验丰富的网站可靠性工程师待命，以协助万一事情真的出错。然而，其他受影响的团队并不知道。这是 Capital One 故意破坏东西，以查看自动化以及人员和流程是否如预期那样响应的时候——工程师在桥上跳跃的速度有多快？

## **迈向下一级弹性的步骤**

“你永远都不应该停止成长。萨夫琴科说:“在 IT 行业，维持现状是最糟糕的事情。

Capital one 目前正在为所有面向网络和移动客户端的产品执行混沌工程。2023 年，他们希望扩展到范围内的所有关键应用，包括呼叫中心和交互式语音应答系统——他说，这些通常被认为是独立的，但肯定都是客户体验的一部分，有待改进。

除此之外，他们还把自己的乱局延伸到了第三方厂商。Savchenko 说:“Chaos 将允许我们在利用这些第三方供应商时测试并主动识别差距，包括他们变慢时的延迟。  这还包括 Zoom、Slack 和 Splunk 等关键通信工具的计划内故障，确保工程师可以轻松切换到不同的工具。

他们还在试验生成假 HTTP 错误代码并将其注入到下游应用程序中，以观察它们对受控错误的反应。

Capital One 工程团队致力于在没有提前通知的情况下，在最大批量的日子里执行各种测试。该团队正在非常努力地工作，以便生产中发生的任何事故都能自我修复。

Savchenko 说:“我们的最终目标是确保比赛日练习是未经宣布的…使用一个工具，只需点击一下就可以开始实验，如果出现任何问题，只需点击一下就可以回滚，”他们努力实现更高水平的弹性。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>