<html>
<head>
<title>Off-The-Shelf Hacker: Picking the Right Data Bus for the Job</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现成的黑客:为工作选择正确的数据总线</h1>
<blockquote>原文：<a href="https://thenewstack.io/instrumenting-pancakebot-phase/#0001-01-01">https://thenewstack.io/instrumenting-pancakebot-phase/#0001-01-01</a></blockquote><div><div id="tns-post-body-content">


<p class="translated">在过去的周末，我更接近于为<a href="http://www.pancakebot.com/" class="ext-link" rel="external "> PancakeBot </a>添加仪器，这是一台定制的煎饼打印机，New Stack偶尔会在我们的煎饼播客系列中推出。<a href="https://thenewstack.io/avoid-burning-christmas-turkey-thermocouples/" class="local-link">老读者可能还记得</a>，我讲述了如何将热电偶及其相关放大器连接到<a href="https://www.arduino.cc/en/Main/ArduinoBoardDuemilanove" class="ext-link" rel="external "> Arduino Duemilanove </a>以读取温度并将结果数据推送到Linux笔记本上。</p>
<p class="translated">本周，我们将着眼于将<a href="https://www.adafruit.com/product/1748" class="ext-link" rel="external "> MLX90614红外非接触式温度传感器</a>集成到组合中。</p>
<p class="translated">MLX90614实际上有两个版本，一个是5伏的，一个是3.3伏的。几年前，当“包装”传感器开始出现在DIY/Maker社区时，它们通常在5伏电压下工作，无论是逻辑电平还是电源。Arduinos和其他微控制器也普遍使用5伏电压。随着时间的推移，随着器件尺寸和功耗要求的降低，很多行业已经过渡到3.3伏，有时甚至是1.8伏。此外，像ESP8266这样的芯片使用3.3伏的逻辑和电源，所以现在购买3.3伏的传感器是标准的。</p>
<p class="translated">将红外传感器放在工作台上，让我们看看如何将它与热电偶和<a href="https://learn.adafruit.com/adafruit-max31856-thermocouple-amplifier/wiring-and-test" class="ext-link" rel="external "> MAX 31856通用放大器</a>组合一起使用。</p>
<p class="translated">我的计划是热电偶将附在热板加热元件上，并直接监控其温度，而PancakeBot则完成其烹饪程序。同时，红外传感器将监控热板的表面温度。然后，我们可以尝试将温度数据与物理煎饼印刷进行关联。</p>
<p class="translated">记录和分析数据是物理计算堆栈的重要组成部分。我们将看看如何将“实时”数据反馈到煎饼打印过程中。这也是研究热电偶放大器和I2C(红外传感器)总线在同一项目中实际应用的绝佳机会</p>
<h2 class="translated">同时使用SPI和I2C接口</h2>
<p class="translated">MAX31856热电偶放大器模块通过<a href="https://learn.sparkfun.com/tutorials/serial-peripheral-interface-spi" class="ext-link" rel="external ">串行外设接口</a> (SPI)总线输出数据。在<a href="https://thenewstack.io/off-shelf-hacker-comms-across-multiple-microcontrollers/" class="local-link">的上一篇专栏文章</a>中，我们了解到SPI接口通常用于微控制器和外设之间的短距离、高速数据交换。该协议的缺点是，对于添加到总线上的每个设备，都需要一条额外的控制线连接到GPIO引脚。如果你连接很多设备，你很快就会用完GPIO管脚。</p>
<p class="translated">好在SPI都是高速的。小<a href="https://www.adafruit.com/product/358" class="ext-link" rel="external ">彩色TFT液晶显示器</a>使用SPI总线。总线处理大量数据的速度非常快。在我们的例子中，除了热电偶/放大器组合之外，我们还可以在Arduino上连接一个TFT LCD来显示温度。像这样的便携式设备可能是有用的，也许是未来故事的候选。目前，我们将只坚持在这个项目中使用一个thermo/amp设置。</p>
<p class="translated">相比之下，MLX 90614红外温度传感器通过<a href="http://www.i2c-bus.org/" class="ext-link" rel="external "> I2C总线</a>发送数据。这种总线处理中等的数据带宽，仅使用两条线(加上电源和地),可以并行容纳100多个设备。今天我们将只使用一个来检查。请随意在您的项目中尝试使用几个I2C模块。</p>
<h2 class="translated">将SPI和I2C总线连接到Arduino</h2>
<p class="translated">在同一个项目中结合SPI和I2C总线是常见的做法。看一下项目<em>的Fritzing示意图(我用UNO Fritzing图标替换了Duemilanove部分，它似乎已经从网络上消失了，再也看不到了。没关系。UNO有一个相同的引脚排列，用于说明目的。)</em>:</p>
<div id="attachment_1882219" class="wp-caption aligncenter"><img aria-describedby="caption-attachment-1882219" decoding="async" loading="lazy" class="size-large wp-image-1882219" src="../Images/63d4aa2a71e2aa445cc41cbb97ad5e42.png" alt="" data-original-src="https://cdn.thenewstack.io/media/2017/02/d14c4e82-max-ir-uno_bb-974x1024.png"/><p id="caption-attachment-1882219" class="wp-caption-text translated">MAX31856、MLX90614和Arduino烧结接线图</p></div>
<p class="translated">布线很简单。MAX 32856热放大器板需要四个GPIO引脚以及电源和接地。MLX 90614板只需要两个GPIO引脚，以及电源和接地。</p>
<p class="translated">这两个电阻充当数据线的上拉电阻。您可能还记得，我们总是希望数据引脚上有一个已知的逻辑电平，以确保可预测的输出。将线拉向源电压会得到默认的“高”或“1”值。像MLX 90614这样的器件在工作时会将器件拉至“低”或“0”值，这样就可以使用程序代码检测数据线上的变化。如果没有上拉电阻，引脚只会在高电平(逻辑1)和低电平(逻辑0)之间浮动，产生随机的傻瓜式输出。</p>
<p class="translated">我通过USB线给Duemilanove Arduino供电。</p>
<h2 class="translated">SPI和I2C码</h2>
<p class="translated">读取SPI热电偶和I2C红外传感器值的代码也很简单。</p>
<p class="translated">首先，引入库来处理SPI和I2C器件的具体操作细节。</p>
<p class="translated">接下来，串行通信开始，器件初始化。loop()部分每半秒读取一次每个设备，并将逗号分隔的数据字符串输出到串行行。在我的Linux笔记本上，每一行数据都通过USB电缆输出到串行端口。</p>
<p class="translated">我下载了<a href="https://github.com/engineertype/MAX31856" class="ext-link" rel="external "> MAX 31856 </a>和<a href="https://github.com/adafruit/Adafruit-MLX90614-Library" class="ext-link" rel="external "> MLX 90614 </a>库后，从Arduino IDE收集的例子中拼凑出代码。我喜欢用华氏温度来读取温度，因此简单的C到F转换函数应用于热电偶读数，以达到此目的。默认情况下，MLX红外线代码输出F。<br/></p>
<div id="crayon-642311c9deb00194369045" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-p">#include &amp;lt;SPI.h&amp;gt;</span>
<span class="crayon-p">#include &amp;lt;Adafruit_MAX31856.h&amp;gt;</span>
<span class="crayon-p">#include &amp;lt;Wire.h&amp;gt;</span>
<span class="crayon-p">#include &amp;lt;Adafruit_MLX90614.h&amp;gt;</span>
 
<span class="crayon-e">Adafruit_MLX90614 </span><span class="crayon-i">mlx</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-e">Adafruit_MLX90614</span>();
 
<span class="crayon-c">// use hardware SPI, just pass in the CS pin</span>
<span class="crayon-e">Adafruit_MAX31856 </span><span class="crayon-i">max</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-e">Adafruit_MAX31856</span>(<span class="crayon-cn">10</span>);
 
<span class="crayon-e">void </span><span class="crayon-e">setup</span>()<span class="crayon-h"> </span>{
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">begin</span>(<span class="crayon-cn">9600</span>);
<span class="crayon-h"> </span>
<span class="crayon-h">  </span><span class="crayon-i">max</span><span class="crayon-st">.</span><span class="crayon-e">begin</span>();
 
<span class="crayon-h">  </span><span class="crayon-i">max</span><span class="crayon-st">.</span><span class="crayon-e">setThermocoupleType</span>(<span class="crayon-i">MAX31856_TCTYPE_K</span>);
 
<span class="crayon-h">  </span><span class="crayon-e">switch</span><span class="crayon-h"> </span>(<span class="crayon-h"> </span><span class="crayon-i">max</span><span class="crayon-st">.</span><span class="crayon-e">getThermocoupleType</span>()<span class="crayon-h"> </span>)<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_B</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_E</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_J</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_K</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_N</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_R</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_S</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_TCTYPE_T</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_VMODE_G8</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-e">case </span><span class="crayon-i">MAX31856_VMODE_G32</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">    </span><span class="crayon-i">default</span>:<span class="crayon-h"> </span><span class="crayon-i">break</span>;
<span class="crayon-h">  </span>}
 
<span class="crayon-h">  </span><span class="crayon-i">mlx</span><span class="crayon-st">.</span><span class="crayon-e">begin</span>();<span class="crayon-h"> </span>
 
}
 
<span class="crayon-e">void </span><span class="crayon-e">loop</span>()<span class="crayon-h"> </span>{
 
<span class="crayon-h">  </span><span class="crayon-c">// 3 number data output with "," separator</span>
<span class="crayon-h">  </span><span class="crayon-c">// 1st number = thermocouple temp measured by MAX amp board</span>
<span class="crayon-h">  </span><span class="crayon-c">// 2nd number = ambient temp measured by MLX IR sensor</span>
<span class="crayon-h">  </span><span class="crayon-c">// 3rd number = object temp measured by MLX IR sensor</span>
<span class="crayon-h">  </span>
<span class="crayon-h">  </span><span class="crayon-c">// 1st number - thermocouple</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-e">Celcius2Fahrenheit</span>(<span class="crayon-i">max</span><span class="crayon-st">.</span><span class="crayon-e">readThermocoupleTemperature</span>()));<span class="crayon-h"> </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">","</span>);
<span class="crayon-h">  </span>
<span class="crayon-h">  </span><span class="crayon-e">uint8_t </span><span class="crayon-i">fault</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-i">max</span><span class="crayon-st">.</span><span class="crayon-e">readFault</span>();
<span class="crayon-h">  </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span>)<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_CJRANGE</span>)<span class="crayon-h"> </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Cold Junction Range Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_TCRANGE</span>)<span class="crayon-h"> </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Thermocouple Range Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_CJHIGH</span>)<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Cold Junction High Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_CJLOW</span>)<span class="crayon-h">   </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Cold Junction Low Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_TCHIGH</span>)<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Thermocouple High Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_TCLOW</span>)<span class="crayon-h">   </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Thermocouple Low Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_OVUV</span>)<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Over/Under Voltage Fault"</span>);
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">fault</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;amp;</span><span class="crayon-h"> </span><span class="crayon-i">MAX31856_FAULT_OPEN</span>)<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Thermocouple Open Fault"</span>);
<span class="crayon-h">  </span>}
<span class="crayon-h">  </span>
<span class="crayon-h">  </span><span class="crayon-c">// 2nd number - ambient</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-i">mlx</span><span class="crayon-st">.</span><span class="crayon-e">readAmbientTempF</span>());<span class="crayon-h"> </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">","</span>);
<span class="crayon-h">  </span>
<span class="crayon-h">  </span><span class="crayon-c">// 3rd number - object</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-i">mlx</span><span class="crayon-st">.</span><span class="crayon-e">readObjectTempF</span>());<span class="crayon-h"> </span>
<span class="crayon-h">  </span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>();
<span class="crayon-h">  </span><span class="crayon-e">delay</span>(<span class="crayon-cn">500</span>);
}
 
<span class="crayon-e">double </span><span class="crayon-e">Celcius2Fahrenheit</span>(<span class="crayon-e">double </span><span class="crayon-i">celsius</span>)
{
<span class="crayon-h">  </span><span class="crayon-i">return</span><span class="crayon-h"> </span><span class="crayon-cn">1.8</span><span class="crayon-h"> </span>*<span class="crayon-h"> </span><span class="crayon-i">celsius</span><span class="crayon-h"> </span>+<span class="crayon-h"> </span><span class="crayon-cn">32</span>;
}
</pre>
</div>
</div>

<p class="translated"><br/>Linux笔记本上的数据收集是通过通常的“命令行上的猫”技术完成的。您也可以看看<a href="https://help.ubuntu.com/community/Minicom" class="ext-link" rel="external "> minicom </a>，一个常用的Linux串行监视器应用程序。这是输出的样子。</p>
<div id="attachment_1882220" class="wp-caption aligncenter"><img aria-describedby="caption-attachment-1882220" decoding="async" loading="lazy" class="size-full wp-image-1882220" src="../Images/935e6924c4d7f461a4cc326b5b006acc.png" alt="" data-original-src="https://cdn.thenewstack.io/media/2017/02/04509102-max-mlx-arduino-data.png"/><p id="caption-attachment-1882220" class="wp-caption-text translated">逗号分隔的温度数据输出屏幕截图。</p></div>
<h2 class="translated">后续步骤</h2>
<p class="translated">我们越来越接近控制和入侵这个机器人了。</p>
<p class="translated">我在考虑为这个项目的2.0版本将热放大器和红外传感器连接到Arduino Pro或Pro Mini，以取代更大的Duemilanove。</p>
<p class="translated">或者，我们可以使用带有集成WiFi的<a href="https://thenewstack.io/off-shelf-hacker-two-way-comms-esp8266/" class="local-link"> ESP8266-07 </a>模块。走这条路还会使使用<a href="https://thenewstack.io/off-shelf-hacker-lightweight-inter-device-messaging-mqtt/" class="local-link"> MQTT </a>作为数据传输协议变得容易，因为我们在过去的故事中也讨论过这个话题。</p>
<p class="translated">你怎么想呢?很刺激，对吧？</p>


<div class="tns-logo-slug">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 68 31" version="1.1">
<title>Group</title>
<desc>Created with Sketch.</desc>
<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
<g id="Group">
<path d="M24.002,29.619 L29.77,29.619 L29.77,15.808 C29.77,15.038 29.622,11.265 29.59,10.414 L29.77,10.414 C31.424,14.019 31.473,14.147 32.168,15.322 L39.65,29.618 L44.845,29.618 L44.845,0 L39.075,0 L39.075,11.064 C39.075,12.197 39.075,12.44 39.182,14.472 L39.325,17.468 L39.151,17.468 C39.034,17.267 38.596,16.173 38.467,15.929 C38.164,15.323 37.725,14.512 37.373,13.905 L30.031,0 L24,0 L24,29.619 L24.002,29.619 Z" id="Path-Copy" fill="#FF3287"/>
<path d="M56.948,0 C50.745,0 47.606,3.43 47.606,8.296 C47.606,14.114 51.036,15.404 55.518,17.132 C60.438,18.853 61.782,19.332 61.782,21.539 C61.782,24.225 58.969,24.867 57.401,24.867 C54.579,24.867 52.493,23.342 51.536,20.858 L47,24.185 C49.43,28.937 52.145,30.185 57.713,30.185 C59.364,30.185 62.059,29.74 63.727,28.694 C67.779,26.156 67.779,22.22 67.779,20.898 C67.779,18.129 66.531,16.207 66.178,15.726 C65.049,14.121 63.032,12.918 61.25,12.278 L57.084,10.914 C55.073,10.267 52.928,10.105 52.928,8.019 C52.928,7.707 53.008,5.528 56.288,5.319 L61.465,5.319 L61.465,0 C61.465,0 57.342,0 56.948,0 Z" id="Path-Copy-2" fill="#00AFF4"/>
<polygon id="Path" fill="#00AFF4" points="5.32907052e-15 1.77635684e-15 5.32907052e-15 5.319 7.572 5.319 7.572 29.564 14.132 29.564 14.132 5.319 21.544 5.319 21.544 1.77635684e-15"/>
</g>
</g>
</svg> </div>

</div>
</div>    
</body>
</html>