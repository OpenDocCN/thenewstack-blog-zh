# 拦截动态 DNS 流量的安全漏洞

> 原文：<https://thenewstack.io/dynamic-dns-security-blues/>

每当你遇到网络问题，明智的网络管理员或系统管理员总是记得“总是 DNS[域名服务]。”因为，嗯，通常是 DNS。

因此，当在[黑帽美国 2021](https://www.blackhat.com/us-21/) 安全会议[云安全公司 Wiz](https://www.wiz.io/) 首席技术官 [Ami Luttwak](https://www.linkedin.com/in/amiluttwak/) 和研究负责人 [Shir Tamari](https://www.linkedin.com/in/shir-tamari-a02584109/) 发现一个[简单的漏洞，允许他们拦截通过亚马逊和谷歌等托管 DNS 提供商的动态 DNS (DDNS)流量](https://www.youtube.com/watch?v=72uzIZPyVjI)时，我们应该感到惊讶。

是的，这包括您在云上使用的 DDNS。如果你认为这很糟糕，那就等着看这次攻击有多微不足道吧。

我们无畏的研究人员发现，“简单地注册某些‘特殊’域名，特别是域名服务器本身的名称，会对使用该域名服务器的所有其他客户产生意想不到的后果。[打破租户之间的隔离](https://www.wiz.io/blog/black-hat-2021-dns-loophole-makes-nation-state-level-spying-as-easy-as-registering-a-domain)。我们成功地注册了一种特殊域名，但我们怀疑还有许多其他类型的域名。”

换句话说，通过注册重复的域名服务器，他们打破了 DNS 租户之间的隔离。这意味着，对于那些没有被无休止的 DNS 问题困扰的人来说，你得到了托管区域的控制权。这意味着您可以将 DNS 流量导向您的 IP 地址。因此，“每当 DNS 客户端向该名称服务器查询自身信息时(成千上万的设备会自动更新其托管网络中的 IP 地址，稍后会详细介绍)，流量会直接到达我们的 IP 地址。”

准确的说，他们所做的只是在[亚马逊网络服务](https://aws.amazon.com/?utm_content=inline-mention)(AWS)’[Route 53](https://aws.amazon.com/route53/)云 DNS 服务平台上注册了一个与 Route 53 官方 DNS 服务器同名的新域名。从技术上来说，他们在 AWS 名称服务器 ns-1611.awsdns-09.co.uk 内部创建了一个新的“托管区域”,并将其命名为“ns-852 . AWS dns-42 . net”。AWS Route 53 拥有大约 2，000 台 DNS 服务器，它们在所有客户之间使用和共享，其中任何一台都可能成为攻击目标。这是如此微不足道的攻击，以至于我甚至不确定我可以称之为黑客。

这不仅仅是 53 号公路的问题。他们发现其他托管 DNS 提供商，如谷歌云 DNS 和 Akamai 也容易受到攻击。将这一点与远程工作的增加结合起来，可以发现“在这个为员工和服务器都在‘本地’的世界设计的几十年前的协议结构中，存在各种有趣的新漏洞。”"

我不同意最后一种说法，DNS 从来就不是为内部世界设计的。然而，不管是好是坏，许多 DNS 实现都将其视为服务是内部的，并且在公司防火墙后是安全的。众所周知，这已经是一个很久很久以前的安全，甚至理智的假设了。

因此，研究人员获得了托管 DNS 区域的部分控制权。因此，当它们将 DNS 查询指向它们的 IP 地址时，每当 DNS 客户端向该名称服务器查询自身时，数以千计的设备会自动更新它们在其管理的网络中的 IP 地址，流量会直接到达它们的 IP 地址。还记得我说过的信任 DNS 服务器就像你控制它一样吗？给你。

理论上，DNS 主机提供了一个易于使用的自助服务平台，使用户能够更新他们的域名和它所指向的名称服务器。客户可以添加任何他们想要的域名。例如，你甚至可以声称 google.com 或 I.have.the.best.website.com ),因为这些域名没有在他们的区域之外注册，从来没有在权威的域名注册机构注册过。这依赖于“基本假设是，你和其他客户之间是完全隔离的。Route53 不会验证我拥有 Amazon.com，因为我在 DNS 上注册的任何东西都不会对其他客户产生任何影响。”

哦，好吧，这是一个可爱的想法，但它不是真的。一旦他们复制了一个 DNS 注册名称，他们突然受到数百万次 DNS 查询的猛烈攻击。你可能会想，那又怎样？知道某家公司的某个人曾经是——太可怕了！—检查 pornhub.com 而不是他们的工作地点？

好吧，如果这就是全部，它仍然是值得注意的，但没有太大的破坏性。唉，事实并非如此。原来 Windows 机器经常对自己的 IP 地址进行 DDNS 查询。而且，由于他们认为他们在与一个安全的内部网络合作，他们发送的不仅仅是他们的内部 IP 地址。哦，不，它们还包括更有价值的情报，如内部和外部 IP 地址、计算机名称、员工姓名和办公地点。

似乎没有人知道会发生什么。研究人员能够使用他们的 DDNS 窃听装置监听超过 15，000 个组织。其中包括财富 500 强公司、45 家美国政府机构和 85 家国际政府机构。例如，想知道你的竞争对手在旧金山有多少员工，他们运行什么系统？没问题！

微软可以解决这个问题，但他们选择不这么做。Wiz 表示，“当我们向微软报告我们的发现时，他们告诉我们，他们不认为这是一个漏洞，而是一个已知的错误配置，当一个组织使用外部 [DNS 解析器](https://www.computerhope.com/jargon/d/dns-resolver.htm)时就会发生这种情况。”

没错。当然可以。

平心而论，这是那些陷入灰色地带的问题之一。谁应该负责修理它？微软？微软？托管 DNS 服务？你的公司？

幸运的是，DDNS 的服务提供商发现了一条安全线索。AWS 和 Google 已经修复了。然而，其他人可能不会。正如 Wiz 指出的那样，“最终，客户负责正确配置他们的 DNS 解析器，这样动态 DNS 更新就不会离开内部网络。”

你现在应该在问，“我脆弱吗？”使用 Wiz 的[动态 DNS 泄漏测试仪](https://dynamic-dns-checker.tools.wiz.io/)来找出答案。我很幸运，我的站点和服务器没有受到攻击。你可能不会这么幸运。现在就检查一下你是否会受到攻击。如果是的话，那就开始努力吧。Wiz 很乐意通过一个[特殊的电子邮件地址](https://mail.google.com/mail/?view=cm&fs=1&tf=1&to=dynamic-dns-leak@wiz.io)提供帮助，或者你可以加入他们的 [slack group](https://join.slack.com/t/dynamicdnsleak/shared_invite/zt-u7w6mw5d-dYn7KqY1c_z2kyfMrsSpPw) 。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>