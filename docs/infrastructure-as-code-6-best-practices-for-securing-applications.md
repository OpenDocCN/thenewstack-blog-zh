# 基础设施即代码:保护应用程序的 6 个最佳实践

> 原文：<https://thenewstack.io/infrastructure-as-code-6-best-practices-for-securing-applications/>

[](https://www.linkedin.com/in/jdarmstro/)

[Jim Armstrong](https://www.linkedin.com/in/jdarmstro/)

[Jim Armstrong 的职业生涯始于安全软件的技术销售，之后转向虚拟化和云技术，然后转向产品营销，参与产品和业务战略。随着数字化转型的开始，他注意到开发人员正在成为许多组织的焦点，这促使他加入 Snyk，在那里他能够将自己的安全、云和应用程序体验结合在一起。除了工作，吉姆喜欢和他的配偶一起旅行和欣赏艺术，他还是一个狂热的自行车爱好者。](https://www.linkedin.com/in/jdarmstro/)

[](https://www.linkedin.com/in/jdarmstro/)[](https://www.linkedin.com/in/jdarmstro/)

大多数现代应用程序自动部署在通过代码创建和配置的基础设施上。这种实践称为基础设施即代码(IaC ),允许开发团队管理应用程序如何在云基础设施上部署和运行。组织正在采用它来快速供应和部署云环境——尤其是那些包含在 Kubernetes 上运行的容器化应用程序的环境。

[来自安全平台提供商](https://go.snyk.io/IaC-Report-2021.html%23:~:text=In%2520this%2520survey,%2520Snyk%2520investigated,from%2520known%2520vulnerabilities%2520and%2520misconfigurations) [Snyk](https://snyk.io/about/) 的研究显示，许多公司才刚刚开始他们的 IaC 之旅，63%的公司刚刚开始探索这项技术，只有 7%的公司表示他们已经实施了 IaC 来满足当前的行业标准。这种实践带来了责任的变化:IaC 进一步扩展了开发人员的责任，包括保护他们的代码和基础设施。

如果不遵循最佳实践，错误配置很容易带来安全风险。事实上，[根据 Gartner](https://www.gartner.com/en/documents/3984345/magic-quadrant-for-application-security-testing?utm_source=thenewstack&utm_medium=website&utm_campaign=platform) 的说法，“70%针对容器的攻击将来自已知的漏洞和错误配置，而这些漏洞和错误配置本来是可以补救的。”通常，使用 IaC 后会出现安全问题，导致配置问题，这些问题只有在部署应用程序后才能发现。不一定是这样的。事实上，确保每个配置都是安全的，同时仍然受益于 IaC 的速度和可重复性的最佳方式是将 IaC 的安全测试构建到开发人员的工作流中，就像其他形式的代码一样。

那么，保护 IaC 的最有效途径是什么呢？这六个关键的最佳实践提供了一个很好的起点。

## 1.替换硬编码的机密

Terraform 变量或动态生成的内容中提供的任何硬编码机密都应替换为敏感变量引用、动态生成的值或 HashiCorp Vault 等机密管理工具。这种最佳做法可以防止凭据泄漏。此外，托管机密应该安全地存储在. ftstate 文件中。

## 2.静态测试 IaC 文件

在编写和应用每个 IaC 配置之前，对其进行测试，以便尽快修复错误。在提交任何更改之前，使用像 [Snyk IaC](https://snyk.io/product/infrastructure-as-code-security/) 这样的工具来静态测试 IaC，作为开发人员本地工作流程的一部分。然后在提交代码和创建拉请求之后再次测试，并在将配置应用到环境之前再次在管道中测试。这给了开发人员每个机会来确保他们的更改会起作用。其他静态测试工具可以确保配置有效，并检查格式是否一致。大多数 IaC 工具也有自己的内置验证测试。

## 3.根据环境进行动态测试

运行执行 IaC 的测试允许您尽早识别错误的配置。应该运行连接到真实 IaaS 的测试，执行 IaC 工具，并断言结果。这听起来很简单，但是有其他先决条件和警告。例如，IaC 配置必须以这样一种方式编写，即每个要测试的结果都是可预测的。“切换电源”似乎是一个合理的配置，但结果可能是“开”或“关”；另一方面，“关闭电源”应该有一个且只有一个结果，因此您可以清楚地测试该断言。

## 4.自动更新正在运行的管道

CI 服务器和管道应该配置为在定义发生变化时自动更新正在运行的管道。管道是用代码定义的，和 apps、IaC 一样。当您扩展测试和工具以支持 IaC 的安全使用时，您的管道应该能够自动检测它们定义的变化，并自动开始使用新版本，而不是依赖于人工干预。

## 5.限制对环境的访问

只有自动化系统应该对基础设施进行更改，以防止配置漂移，并确保对环境的每个更改都可以通过源代码管理系统进行审计。应该限制对环境的访问，以便在大多数情况下，人们拥有只读权限。CI 服务器应该配置有特权凭证，允许它进行基础结构更改。对于一个完整的审计跟踪，所有的代码更改都应该加密签名。

## 6.故障警报

CI 管道应该配置为在作业失败时发送警报，这样可以在开发过程的早期发现错误配置。问题发现得越早，解决起来就越容易，成本也越低。失败一发生就应该通知团队，这样做是为了让最近做出更改的开发人员仍然记得他们在做什么，并且可以快速解决问题。

## 不要等到为时已晚才保护 IaC

尽管许多组织仍在开发他们使用 IaC 的标准和实践，Snyk IaC Security Insights research 揭示了一些令人担忧的 IaC 实践仍然存在。超过一半的团队声称他们仍然通过直接调整基础设施来修复安全问题，而不是修改 IaC 源代码。根据这些团队的说法，部署后审计和 pentests 是测试基础设施的最常见方法，这也许不足为奇。

但是，如果按照其他形式的代码已经使用的最佳实践正确地实现 IaC，那么 IaC 的使用就提供了一个机会，可以从一开始就防止错误配置进入生产环境，并随着时间的推移保持基础设施的安全性，同时还实现了 IaC 的速度和敏捷性承诺。

这就是为什么遵循 IaC 安全的这些最佳实践可以帮助团队限制配置偏差，同时减少错误配置和其他关键安全问题的风险，这些问题可能会使他们的云本机应用程序面临不必要的风险。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>