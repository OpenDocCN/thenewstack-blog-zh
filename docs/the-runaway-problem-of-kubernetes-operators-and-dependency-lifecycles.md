# Kubernetes 算子和依赖生命周期的失控问题

> 原文：<https://thenewstack.io/the-runaway-problem-of-kubernetes-operators-and-dependency-lifecycles/>

Kubernetes operator 模式的思想是通过将实现和操作逻辑转化为代码，以可重用的方式打包关于在 Kubernetes 上运行特定应用程序的深层知识。舵图将部署正确的工件，但它不会编码如何保护和备份应用程序或管理应用程序用户。由定制控制器和 CRD 组成的操作器对操作动作进行编码，并消除确保为该应用程序启动正确的资源和依赖关系的开销，或者在半夜出现故障时正确调整 etcd 集群的大小。

但运营商很快变得流行起来，这种纯粹的扩散意味着具有讽刺意味的是，Kubernetes 运营团队需要获得关于运营商本身的同样深刻的知识，从运营商框架之间的选择，到从许多应用程序的多个选项中选择正确的运营商，再到管理依赖关系的生命周期。

因为简化集群范围服务的 CRD 的打包、安装和操作并不能消除运营商自身处理发现、访问控制和依赖性的复杂性。

## **一个缺失的概念**

运营商的概念最初是[为数据库、缓存和监控系统等有状态应用设计的](https://coreos.com/blog/introducing-operators.html)，即使有了 Kubernetes，在不丢失数据或可用性的情况下进行扩展、升级和重新配置也意味着要了解这些应用是如何工作的。

数据库提供商[DataStax](https://www.datastax.com/)[Patrick McFadin](https://www.linkedin.com/in/patrick-mcfadin-53a8046/)的 Cassandra 专家和开发者关系副总裁告诉新的堆栈，根本问题是，虽然 Kubernetes 一直在处理分布式应用基础设施，但它并不是真正为分布式数据而设计的。

“取服目。这是当前的热门话题，也是支持应用层的一个很好的例子:如何以一种安全的方式部署所有这些微服务，并具有可发现性。”麦克法丁说，对于如何启用数据层，还没有相同的探索。“当你在创建微服务时，你可能会连接到一个数据库，你知道该做什么，这是留给用户去解决的。这不是谈话的一部分。当你在 Kubernetes 上创建一个部署，并创建你的部署 YAML 文件时，一切都非常整洁有序，直到你到达它的分布式部分，如你的存储和数据库，然后它变得相当疯狂。”

运营商是当前问题的解决方案，但麦克法丁建议，“运营商正在成为太多的解决方案。”

“运营商的数量出现了真正的爆炸，” [MayaData](https://mayadata.io/) 的首席执行官 Evan Powell 告诉新堆栈。“除了实际使用操作符的设置之外，用户的问题是我应该从哪一个开始？也许这正是我们采用 Kubernetes 的情况，因为它被大量用于需要操作员的工作负载，如数据库和日志记录，它会及时解决-但现在它让人们感到困惑。”

一个 MayaData 客户在 Kubernetes 上有 15 个生产数据库，每个数据库都有 5 到 10 个相关联的操作员。

“运营商应该简化我的生活，但我应该查看 70 或 90 个运营商，以找出如何操作这个复杂的环境吗？他们是一个非常复杂的组织，但他们会问‘你是如何对一个运营商进行生命周期管理的？’操作符的概念很棒，但是现在我们有大量的操作符；这就像旧的虚拟机蔓延。"

虽然操作员通常与单个应用程序相关联，但运行与不同操作相关联的多个数据库实例并不少见，因此除非对部署进行仔细划分，否则 Kubernetes 管理员可能必须以在 Windows Server 中解决 DLL 管理的相同方式来处理 CRD 的版本和关联。

“这些运营商的设计方式，[你不得不问]他们能自己清理吗？如果有，这是正确的模式吗？还是你想要一个更通用的模式？”运营商也使混沌工程和其他一些测试弹性的方法变得复杂。“如果你杀了工作量，操作员会离开吗？它杀对了吗？”

Powell 建议说，还有关于运营商的治理在一个组织中处于什么位置的问题。

运营商的功能从基本的安装脚本到处理升级、备份和故障的复杂逻辑，再到[完全“自动驾驶”操作](https://operatorframework.io/operator-capabilities/)，因此根据功能而非受欢迎程度来选择运营商非常重要。随着时间的推移，单个运营商可能会变得更加强大:他们倾向于从自动化安装和自助供应开始，并经常发展到[涵盖复杂的自动化](https://www.redhat.com/en/blog/introducing-operator-framework-building-apps-Kubernetes)；因此，您最初可能需要两到三个操作符，但以后能够整合——这意味着密切关注操作符的功能，并有可能改变您使用的操作符。

“Kubernetes 做得这么好的一个原因是，它实现并支持负责构建应用程序的人与平台团队和运营商之间的某种分工，”鲍威尔指出。“但是如果你不小心，操作员很快就会创建会议，而松散耦合的全部意义在于我们不需要任何讨厌的会议！你现在有可能在有其他事情要做的人之间进行耦合，或者至少是强迫他们进行对话。”

为了避免这些会议，平台团队可能会在验证的工作负载中加入一些操作人员。

鲍威尔指出，从长远来看，应用程序上使用的弹性测试也需要应用于运营商。“你需要以正确的方式建立运营商，你需要知道如何对它们进行生命周期管理，但我认为你还需要试图在生产中打破它们的系统。”

## **访问和控制**

运营商越来越受欢迎的一个原因是它们是 Kubernetes 本身原则的自然演变，[普鲁米](https://www.pulumi.com/)创始人兼首席执行官[乔·达菲](https://www.linkedin.com/in/joejduffy/)告诉新堆栈。“这很有趣，因为在某种程度上，它实现了 Kubernetes 的梦想，这是许多松散、独立、自我管理、自我修复、长寿命的过程。这就是 Kubernetes 的设计哲学，所以当你开始考虑可扩展性时，操作符是这种哲学的自然体现。但随着运营商的激增，需要管理大量的依赖项和版本。”

减少与运营商合作的开销需要解决访问和生命周期问题。Duffy 将运行集群名称空间的早期 Helm 组件 Tiller 比作“在操作符存在之前的操作符”，这导致了 RBAC 和安全问题。

“我们从客户那里听到的一件事是，在运营商的早期，人们没有理解 RBAC 的故事。拥有正确的 RBAC 和命名空间的方法真的可以帮助驯服一些复杂性，因为现在你真的细分了谁必须关心这 80 个运营商中的哪一个。实际上，每个团队可以有 5 名操作员，而不是 80 人的海洋。”

## **进化模式和定义**

操作符的[定义保持不变；Kubernetes 应用交付 SIG 已经讨论了几个月，但没有一个明确的结果，因为这是一个仍在发展的活跃领域。](https://github.com/cloud-ark/kubeplus/blob/master/Operator-FAQ.md)

有多个项目用于创建和管理操作符( [KUDO](https://kudo.dev/) (雄心勃勃地命名为 Kubernetes Universal Declarative Operator)、Metacontroller(以及在 Metacontroller 开发停止时启动的 [Metac 项目](https://github.com/AmitKumarDas/metac))和 Red Hat 的操作符框架，该框架最终作为[孵化项目](https://www.openshift.com/blog/operator-framework-moves-to-cncf-for-incubation)转移到了云计算原生计算基金会，以及具有类似想法的项目，如 kubebuilder 和 Cluster Addon Operators)。有如此多的操作符和如此多的部署操作符的方式(通过 Helm、KUDO、操作符框架 OLM 和 raw Kubernetes manifest ),以至于对[工件中枢](https://artifacthub.io/)的少数示例查询中有两个是特定类别的操作符。

您将看到术语操作员、控制器和 CRD 在某种程度上可以互换使用，尽管它们有细微的区别。

操作符已经超越了处理有状态应用程序的方式，现在开始用于非常不同的概念，包括调用外部服务的无状态应用程序，这使得事情变得更加复杂。

微软最近放弃使用[开放服务代理 API](https://www.openservicebrokerapi.org/) 为 Azure 提供服务目录，转而提供 [Azure 服务运营商](https://github.com/Azure/azure-service-operator)，客户不仅可以使用它来动态供应 Azure 存储、数据库和监控服务，如 Cosmos DB、Event Hubs、Application Insights，甚至还可以从 Kubernetes 集群中动态供应虚拟网络和 VM 规模集。[亚马逊网络服务运营商](https://github.com/aws/aws-controllers-k8s)正在成为一组控制器，使你能够管理来自 Kubernetes 的 AWS 服务。

操作符的流动性允许这种试验，而更严格的定义可能会限制太多。“运营商框架非常灵活，”麦克法丁指出。“如果你看看运营商 SDK，它不是很固执己见，也不是故意的。它应该是一个非常通用的框架。”

但是，同样的灵活性也让操作员成为一个高级领域，可能会让他们要帮助的人感到困惑。

“运营商真的处于风口浪尖，”达菲指出。“在我们真正理解最佳运营商模式之前，我们已经进行了多年的学习。”

## **超越运算符**

一种可能是运行运算符的元运算符。Red Hat 运营商框架中的运营商生命周期管理器最初是 Prometheus 和 Vault 等服务的元运营商，这些服务位于 core OS constructive Kubernetes 发行版中。KUDO 提供了一种在 YAML 创建运营商的高级方法，允许 KUDO [作为多种应用的 Kubernetes 运营商。](https://d2iq.com/blog/getting-started-with-kudo)

这也可以解决操作员缺乏工具的问题，这些操作员对运行应用程序有深入的了解，当他们想要准备好这些应用程序容器并开始用 Kubernetes 编排它们时，可以将这些知识封装在操作员中。维护 Metac 工具包的[阿米特·达斯](https://github.com/AmitKumarDas)指出:“尽管他们知道运营商是必由之路，但他们不知道如何利用多年来学到的知识轻松构建一个运营商。”。

一种选择是将操作者纳入其他管理工具中。Pulumi 现在有一个操作员来支持使用 GitOps 工作流从集群内进行部署，该工作流还使用本机准入控制器将云策略作为代码来实施，以“在途中”应用策略，并可以取代其他一些操作员。它是使用 [Flux](https://github.com/fluxcd/flux) 构建的，这是一个 Kubernetes GitOps 操作符，可以基于 git 合并和提交触发操作符操作。

“Pulumi 操作员可以管理所有其他层和其他操作员，所以也许您需要更少的其他操作员，”Duffy 建议道。“您真的需要 Cassandra 操作员来管理 Cassandra 基础架构吗？或者您只是使用 Pulumi 的 Cassandra provider 来管理您的 Cassandra 数据库吗？而不是安装 AWS 运营商和 Azure 运营商，因为他们有自己的原型运营商来管理这些云上的基础设施，也许可以在 Pulumi 运营商上实现标准化来管理所有这些东西，这可以帮助降低运营商的爆炸式增长。”

Kubernetes 本身的更高级服务可能是另一个方向，伴随着使应用程序更适合运行云原生的变化。

有超过 10 个甚至可能多达 20 个不同的运营商供 Cassandra 选择的一个原因是，开源鼓励开发人员自己动手，McFadin 建议运营商在短期内改善的最佳方式是让更多的 Kubernetes 用户和管理员参与到项目中来，将他们需要的功能集成到标准运营商中，而不是自己编写。

但多个 Cassandra 操作符的另一个原因是，数据库有“大量的表面区域配置，几乎与项目上有多少表面区域配置以及有多少潜在操作符直接相关，因为每个操作符都将表达其中的不同部分。”

Apache Cassandra 团队正致力于将几十个选项整合到一个通用的操作符中，该操作符将成为 Cassandra 主发行版的一部分，编码它如何与 Kubernetes 共存。麦克法丁推测，从长远来看，这甚至可能导致数据和分布式存储服务成为 Kubernetes 的一等公民，因为另一种选择是“从几十个潜在的运营商中选择一个，并祝你好运做对。”

他建议，项目也可以做更多的工作来减少配置的需求。“您应该能够用很少的配置来部署您的产品或软件，并让它在最佳状态下工作。”

鲍威尔指出，对于操作符激增带来的所有问题，它们明显优于需要深入的领域专业知识或处理原始 API。“至少我们在同一个房间里讨论最佳模式，以利用互操作性或至少跨系统的 API 和方法的一致性方面的巨大飞跃。”

“我们作为人类创造的任何大规模工业，我们使其更有效率，我们以某种方式使其自动化；我们减少了提高生产率所需的人员数量。运营商是实现这一目标的第一步。”

亚马逊网络服务、云计算原生计算基金会、DataStax、MayaData 和 Red Hat 是新堆栈的赞助商。

图片由来自 Pixabay 的 Hans Braxmeier 提供。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>