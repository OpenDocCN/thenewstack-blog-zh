# 我们在 Octopus Deploy 上运行手册的方法

> 原文：<https://thenewstack.io/our-approach-to-runbooks-at-octopus-deploy/>

您可能使用软件工具来帮助自动化您的开发过程，从 git 到构建服务器到持续测试套件。这些工具可以让您简化开发流程，将精力集中在更关键的任务上。

 [特伦斯·王

Terence Wong 是一名软件工程师，热爱解决问题和技术。特伦斯喜欢了解新技术，并与不同的受众交流复杂的信息。作为 Octopus 的技术内容创建者，Terence 与 DevOps 和云技术合作，了解并撰写客户面临的问题。](https://www.linkedin.com/in/terenceywong/?originalSubdomain=au) 

操作手册允许运营团队共享标准流程，从而简化了开发运维的“运营”方面。

如果您在运营部门工作，您可能已经完成了一本详细说明一系列手动步骤的操作手册，或者自己编写了一本操作手册来帮助自动化日常任务。

操作手册，因为他们经常在运营团队中使用，只是人们手动工作的检查表。在 Octopus，我们开发了一个 runbook 特性，与我们的部署工具一起运行，因为 run book 和部署是密切相关的。

Octopus Runbooks 始终是自动化流程，使 DevOps 团队更加高效。我们广泛使用和创建操作手册，并对如何设计和执行它们有一些想法。

## 什么是 Runbooks？

操作手册是用来完成常规计算机过程的一系列步骤。传统上，操作手册是印在纸上的，需要时可以查阅。当然，这导致了纸质清单不更新的问题，人们试图遵循不再有效的指示。

现代 IT 系统中的操作手册采用这些指令，并在可重复的过程中自动化它们。在一个开发者拥有许多自动化工具的世界里，runbooks 是一个受欢迎的操作工作流的补充。

您可以使用操作手册来:

*   自动化日常配置、维护和紧急操作任务。
*   提供基础设施。
*   安装依赖项。
*   重启基础设施。
*   简化运营工作，专注于无法自动化的关键任务。

## 为什么我们将 Runbooks 构建到我们的平台中

为我们的用户提供 runbook 功能是有意义的，因为 Octopus Deploy 已经连接到您的部署基础设施。我们知道您的部署目标在哪里，并且有集成来与他们通信。通过向我们的平台添加操作手册，我们可以让您在一个工具中执行部署的同时执行操作任务。

在内部测试和使用 runbook 之后，我们发布了一个 run book 特性，与我们的部署流程一起运行。操作任务和部署任务都是 Octopus 中的专用功能。您可以跨操作手册和部署共享变量，允许跨开发和运营进行全面集成。

部署过程将一个由 CI 服务器构建的工件带到一个实时部署中，但是在这个过程中有很多地方可以使用 runbook。runbook 可以使用最新的依赖项更新部署目标，或者在部署完成后删除不必要的基础架构。您可能需要在特定时间重新启动服务器，或者在某个条件下触发某个进程。操作手册是这项工作的最佳工具。

我们的内部测试表明，操作手册在部署过程中提供了发现和可见性。由于部署目标是已知的，自动化操作任务会显示日志和指标，您可以使用这些日志和指标对系统进行故障排除。跟踪可以连接相关的部署目标，并帮助诊断更广泛的系统间问题。

操作手册也有助于满足安全要求。您可以使用它们来:

*   续订 SSL 证书。
*   新用户加入系统时配置权限。
*   自动删除不应再访问系统的人。

运行手册中的日志在审计过程中也很有帮助，尤其是当您的企业试图获得 ISO-27001 和 SOC II 等安全认证时。

## 我们认为您应该如何使用操作手册

当我们为 Octopus Deploy 设计 run book 时，我们知道添加这一功能将为开发人员提供一个开放的环境来创建复杂的 run book。尽管这是一个开放的环境，但制定一些基本规则来充分利用 runbooks 还是很有帮助的。我们自己也花了很多时间使用和思考 runbooks，所以我们有一些关于如何最好地使用它们的意见。

## 你的 Runbook 在解决什么问题？

开发人员的一个常见陷阱是在没有完全理解问题的情况下一头扎进问题中。我们的 runbooks 功能允许您创建步骤来解决许多不同的操作任务。然而，您需要理解操作手册的目的，以避免结束一个试图做太多事情的臃肿的过程。

最好预先规划出所有的用例以及“疑难杂症”,以便最终的操作手册解决一个特定的用例。

*   如果这个 runbook 出现故障或者卡住会怎么样？
*   这个 runbook 依赖于什么依赖关系来运行？
*   这本操作手册有一个功能吗？

如果一个潜在的 runbook 有许多用例，将这些用例分成多个 run book，并将它们链接在一起。

## 我们以前试过这样的操作手册吗？我们学到了什么？

在分散的劳动力中，不同的团队解决相同的问题，很容易孤立地工作。你所在企业的其他团队可能已经有了解决类似问题的操作手册。

在设计你的操作手册时，询问是否有人已经尝试过创建类似的操作手册。也许你可以重复使用一本手册。或者，如果一本操作手册不起作用，可能会有一些经验教训会影响你的操作手册的设计。

在 Octopus Deploy 中，您可以导出 runbooks 以供共享和重用。我们建议您利用之前的知识建立自己的操作手册，这样您就不必重新发明轮子。我们的步骤模板是一个很好的选择，因为你可以保存一个参数化的脚本步骤并在你的操作手册中调用它。

## 不断调整运行手册是一件坏事

在测试我们的 run book 功能时，我们制作了一些非常聪明的 run book。他们完全按照我们的要求做了，而且都是自动化的！然而，随着系统的变化和发展，操作手册变得过时了。我们不断调整和编辑操作手册，使其保持最新。我们了解到，在可能的情况下，运行手册应该经得起未来的考验。即使他们已经闲了几个月，他们也应该还在工作。

为了实现这一点，我们计划我们的 runbooks 应该在哪里运行。

*   它应该在部署目标上吗？
*   它应该在工人身上运行吗？

了解操作手册的生命周期有助于减少它们的冗余。你不希望回到 runbook，发现它连接到不再存在的沙盒目标。

你还应该知道是一个人还是一个自动化的设计过程在运行你的操作手册。当系统可以自动操作时，您不希望通过指定手动操作手册来限制您的系统。了解依赖关系将有助于您保持操作手册的简化和更新。

## Runbook 的警报策略是什么？

默认情况下，Octopus 中的运行手册是自动的。自动化有助于持续集成的 DevOps 实践。尽管建立自己的操作手册并忘记它很有吸引力，但你需要一个计划来启动相关的批准并提醒适当的人。在实施 runbook 之前，考虑需要哪些批准，以及 runbook 运行时要通知哪个开发人员。Octopus Deploy 具有内置的批准和提醒功能，可帮助您在工作流程中设置这一流程。

## 您需要哪些信息，这些信息应该保留多长时间？

您创建的 runbook 会留下一系列日志，理解这些日志有助于系统的可观察性和安全性。记录信息、度量和轨迹构成了遥测数据的主体。遥测数据允许开发人员根据输出结果来修复或改进系统，从而实现系统的可观测性。

如果您能够理解系统可观测性需要什么数据，那么您可以设计您的操作手册来为您的团队获取相关数据。如果您正在处理敏感数据，您不应该捕获每种类型的日志，也不应该无限期地存储所有日志。尝试将操作手册作为整体安全策略的一部分进行规划，以满足您的认证要求，如 ISO-27001 和 SOC II。

## Runbooks 最佳实践

根据我们的经验，我们发现大多数好的操作手册都遵循一个趋势。我们将最佳实践操作手册视为通过测试和自动化连接起来的一系列步骤:

*   形容
*   检查
*   收集
*   确认
*   整流
*   核实
*   通知

理想的运行手册是自我描述的，首先检查问题以确认它必须运行。它收集有关系统的诊断信息，以确定问题的根本原因。它确认运行手册在执行代码纠正问题之前是否需要手动批准。代码执行后，runbook 验证系统是否已修复，并通知相关渠道。在这些步骤的每一点上，都要对操作手册进行测试和自动化。以下是我们对流程中每一步的想法:

### 形容

runbooks 的质量描述对于促进重用和自我文档化至关重要。当你在创建许多操作手册时，你希望能够回到这些手册上来，了解它们各自的功能。在 Octopus Deploy 中，您可以将描述附加到 runbook，以将其连接到部署。这些描述可以针对特定的用例进行搜索，例如“web 服务器”或“IAM”

### 检查

操作手册帮助您修复系统的特定部分。它可能是安装最新的补丁，重新启动系统或将用户添加到安全列表中。操作手册的第一步应该检查系统的当前状态，以确定它是否降级或需要修复。该检查是一种确认检查，用于验证系统是否需要补丁程序，或者服务器是否返回 404 错误。

### 收集

在运行手册确认系统的降级部分后，您的运行手册应该收集诊断信息，以确定任何问题的根本原因。

您可以稍后使用此信息来防止系统返回到该状态。由于并非所有数据都有价值，因此了解您需要哪种信息来解决问题非常重要。

### 确认

诊断完问题后，您的 runbook 应该在继续之前调用任何手动干预步骤。如果诊断出的错误是常规错误，不需要手动干预，操作手册应该继续。这一步的关键是在需要时请求人工干预。请求不必要的手动干预会适得其反，而在必要时不请求手动干预可能会是灾难性的。

### 整流

纠正步骤是运行手册执行步骤来修复问题的地方。它可能正在运行重启服务器代码或应用补丁。在 Octopus，我们让用户定义一系列步骤来完成 runbook 流程。这些步骤都有模板，集成到主要的 DevOps 平台中。如果 runbook 失败了，您可以查明哪个步骤导致了失败，哪个步骤成功了。

### 核实

在 runbook 执行之后，它应该通过查询系统的健康指标来验证问题是否得到了解决。健康指示器可以是确认新版本或验证服务器的状态。这一步就像是部署构建的绿灯。一旦变成绿色，runbook 就成功了。如果验证步骤失败，则需要重启或重新配置 runbook。

### 通知

如果验证成功，您的 runbook 应该会向适当的渠道发送警报。通知可以是报告运行手册状态的松弛消息或电子邮件。像 Slack 和 Teams 这样的 ChatOps 工具都有优秀的移动界面。您可以使用这些接口为每次 runbook 运行将状态消息打印到专用的 Slack 通道。虽然您可以将所有状态消息转储到一个 Slack 通道中，但是您应该只对严重错误执行 ping 操作。我们都知道被我们学会忽略的通知超载是什么感觉。

### 使自动化

自动化是运行手册的价值主张。如果没有自动化，我们仍然会从活页夹中读取和执行指令！在 Octopus，您可以配置 runbook 的步骤和条件，并让它根据时间表在后台运行。当你成功地创建了一个自动化的运行手册，你可以导出运行手册，并在另一个环境中使用自动化，为你节省大量的时间。

### 试验

持续测试是 DevOps 中的一个阶段，它在将每个版本部署到生产环境之前对其进行自动化测试。一个类似的概念可以应用到 runbooks 来实现相同的测试覆盖率。在 Octopus Deploy 中，您可以在测试环境中执行 runbook 来验证其性能，然后再将其用于生产环境。

## 结论

Runbooks 是 Octopus 的一项内置功能，得到了用户的积极反馈。如果做得好，runbooks 可以节省大量时间并消除手工操作。然而，如果计划不当，操作手册可能难以维护，其目的可能变得不明确，并且操作手册无法实现其目标。

通过了解你的 runbook 是给谁的，它将实现什么，以及数据是如何收集的，你将释放 run book 的价值。我们提供了一些最佳实践，您可以遵循这些实践来构建成功的操作手册。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>