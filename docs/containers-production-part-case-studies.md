# 生产中的容器:案例研究，第 1 部分

> 原文：<https://thenewstack.io/containers-production-part-case-studies/>

音乐流媒体服务 Spotify、视频流媒体公司 DramaFever、back end as a Service Provider build . io 和教育智库“Instituto de Investigacion，innovation y Estudios de Posgrado para la Educacion”(IIIEPE)有什么共同点？它们都依赖容器来运行关键的 Web 基础设施。

他们的故事说明了利用微服务架构、创建 web 级应用程序以及在生产中运行容器的一些好处和挑战。

## 大规模运行全球应用程序

Spotify 有一大堆功能，包括使用社交媒体凭证登录，查看基于以前听过的歌曲的推荐，以及分享音乐。但是演奏音乐本身才是最重要的。为了让 Spotify 的 6000 万用户满意，音乐必须保持流媒体播放，即使开发者在专辑封面艺术功能中引入了一个错误，或者其四个不同数据中心的 5000 多台制作服务器中的一台出现故障。

[cyclone slider id = " ebook-2-赞助商"]

为了实现这一目标，该公司将 Spotify 的每个独立功能打包成一项微服务。然后使用容器来允许 Spotify 将这些微服务捆绑在一起，以便单个请求调用可以获取所有相关信息，并将其显示在最终用户(以及可能的订户)可以看到的界面上，而无需进行太多重复调用来匹配特定信息。这也让其他微服务可以同时独立运行。

在旧金山举行的 DockerCon 2014 上，Spotify 软件工程师 Rohan Singh 制定了 Spotify 的游戏计划，将微服务打包成一系列容器，可以根据用户需求在全球各地上下旋转。辛格在 DockerCon 的讲话恰逢 Spotify 计划在生产中部署容器的第一周。9 个月后——2015 年 3 月——Spotify 的 Evgeny Goldin 登上特拉维夫 DevCon 的舞台，就容器如何成为流媒体服务持续交付文化的核心提供了深入的见解。

戈尔丁说，Spotify 的问题是他所说的 NxM:“你有‘N’个服务，你想把它们部署在‘M’个主机上，”他告诉 DevCon 观众。

NxM 问题是指当全球用户观众都以自己的方式使用 Spotify 时，打开和关闭功能、播放音乐或关闭应用程序时，出现的大规模问题。因此，当 Spotify 用户的应用程序需要特定的微服务时，它会向 Spotify 的服务器发出请求，并获得所需的数据。随着新功能的增加，或者更多的用户同时要求启动自己的应用服务，Spotify 需要旋转更多的容器来满足额外的需求，然后在不需要保持服务器处理能力的时候放弃它们。

为了解决这个问题，Spotify 创建了[开源项目 Helios。](https://github.com/spotify/helios)

“我们称之为 Docker 编排框架。它解决了一个问题，而且解决得非常好，”辛格说。“给定主机列表和要部署的服务列表，它就在那里部署它们，”戈尔丁说。

自 2014 年 7 月以来，Spotify 一直在生产中使用 Containers 和 Helios 模型，这是其可扩展性战略的一个关键支柱。“我们已经生产了数百台机器，”该团队在 GitHub 上的 Helios 自述文件中宣布。“但在现有架构需要重新审视之前，我们还远远没有接近极限。”

## DramaFever 的视频要求

DramaFever 运营着 AMC 的 SundanceNow Doc Club 和恐怖流媒体网站颤栗等白牌网站，并与其他流媒体服务公司签订了提供内容的合同。在最近跳槽到 Pivotal 担任 Cloud Foundry 的首席技术专家之前，Kromhout 曾在 DramaFever 从事网站可靠性工作，她谈到了自己在那里的时光:“我们不是网飞，我们也不是 Hulu，但如果你在 Hulu 上观看韩剧，他们会播放他们从 DramaFever 获得许可的内容。”

在 DramaFever 工作期间，Kromhout 对服务器架构采取了“牛，而不是宠物”的心态，将请求路径中的一切都容器化，以实现自动伸缩。DramaFever 于 2013 年 10 月开始在生产中使用 Docker，版本为 0.6。使用 Docker 实施一致的开发和可重复的部署；容器有助于保持开发人员使用的代码和配置环境不变，即使他们将代码从笔记本电脑转移到基于云的 QA、试运行和生产环境。每当架构自动扩展应用程序或微服务组件的新实例时，容器中的代码都是可信的，因为它将具有与任何测试或开发安排相同的操作上下文。

“当我在 2014 年 7 月开始工作时，在生产中使用 Docker 是一个迹象，表明它将是一个令人兴奋的工作场所，”Kromhout 说。

DramaFever 在生产规模上充分实现自动扩展时必须解决的最初障碍之一是构建一个健壮的容器注册表。Kromhout 说，在分布式架构中，你经常会遇到多个容器同时启动的情况。这是动态完成的，因此该架构只根据使用情况按需启动实例和容器。所发生的是这些“docker 拉”请求被发送到私有 Docker 注册中心。当大约 20 个容器同时启动时，注册表往往会崩溃。

> Built.io 继续关注容器生态系统，寻找其他可以接管管理层的工具，虽然 [Deis](http://deis.io/) 已经很接近了，但目前他们已经决定继续自己做这件事。

为了解决这个问题，DramaFever 在本地的每台主机上到处运行注册表容器，这样图像拉取就在本地完成，AWS S3 作为后备存储。

“戏剧热可能会朝着扩大规模的方向发展，”克罗姆胡特说。但她说，DramaFever 的运营总监蒂姆·格罗斯(Tim Gross)意识到，“如果他必须扩展注册表，为什么不采用一种你永远不会想到‘我们的注册表服务器能处理这么多图像拉取’的方式呢？”"

她承认这是一种独特的情况，但这正是你在使用自托管注册表大规模运行容器时会遇到的那种问题。Kromhout 在 2015 年 OSCON 上讲述了 DramaFever 的容器故事，[“Docker in Production:Reality，not Hype”](http://bridgetkromhout.com/speaking/2015/oscon/)。

## 在生产中通过 API 管理容器

集成和后端即服务提供商[build . io](https://www.built.io/)的首席技术官 Nishant Patel 已经在生产中使用容器近两年了，他认为这有助于他们将公司的服务与市场上的其他提供商区分开来。

Patel 表示，在很大程度上，大多数 IaaS 和 BaaS 客户确实在寻找一种数据库即服务解决方案，它具有开箱即用的身份验证和类似功能，能够将数据库作为应用程序提供给最终客户。但是他们的 20%的客户需要一些更严格的东西，需要围绕数据库包装额外的业务逻辑。build . io 的客户需要能够编写定制逻辑并将其添加到 build . io 的服务器中。

[cyclone slider id = " ebook-2-赞助商"]

“我们不希望它变得太复杂，让我们的客户不得不设置自己的服务器等。因此，我们想要一种简单的方法，让我们的客户上传他们的定制代码，并与他们的数据库一起运行。所以，本质上，我们想要一个云中的容器，”Patel 说。

这促使 Built.io 位于孟买的工程团队寻找可用的选项，两年前，他们的一名工程师偶然发现了 Docker，当时它仍处于 0.9 版本发布阶段。“我们做了一个快速的概念验证，设置了这些容器，上传了代码，你知道吗，我们对它提供的东西印象深刻。这是一个安全的容器，不会弄乱任何人的代码。因此，我们更进一步，考虑编写我们自己的管理层。”

Patel 估计，Built.io 的客户在任何给定的时间都会旋转成千上万个容器，因为每个客户的帐户默认都带有一个 Docker 容器。

“使用集装箱给了我们竞争优势。我们的竞争对手有着与我们相同的要求:他们也必须满足这 20%有特定需求的客户，但是因为我们使用 Docker，我们能够创建一个平台即服务，这是我们的竞争对手无法做到的。这让我们的故事更加有力。例如，在生产中使用我们的 MBaaS 和 Docker，您可以上传完整的 Node.js 应用程序。”

像 Spotify 和 DramaFever 一样，Built.io 发现缺乏现有的工具，因为它们的生产环境中的容器具有早期采用的性质。这导致 Built.io 选择建立自己的管理层，就像 Spotify 建立自己的编排服务一样，以及 DramaFever 如何建立一个可水平扩展的主机本地 Docker 注册表架构。

“我们想要的是通过 API 进行 API 调用来设置容器的能力。然后，我们建立了各种各样的东西，例如，我们希望支付更高的客户能够建立更大的容器。我们希望客户能够拥有一个负载平衡器容器，我们希望添加额外的安全措施，并通过 API 管理容器的启动和停止，使用 API 获取容器日志并将其放入我们的客户管理 UI 中。”

Patel 表示，Built.io 将继续关注容器生态系统，寻找能够接管管理层的其他工具，虽然 [Deis](http://deis.io/) 即将到来，但目前他们已经决定继续自己做这件事。

## 利用容器引入连续交付

正如路易斯·埃利宗多在他的 Docker 生产工作流程上发表了一系列[博客文章](http://www.luiselizondo.net/a-production-ready-docker-workflow/)后发现的那样，那些想要在生产中使用容器的人并不缺乏。埃利宗多在 IIIEPE 工作，这是一个政府资助的致力于教育研究的机构，在那里他管理着从小型静态 HTML 网站到成熟的教师学习管理系统的一切。

“我们有 25 个 web 应用程序，其中大部分运行在 Drupal 上，但我们也使用 Node.js 和 Python。埃利宗多说:“最大的问题是，当我们把一个网络应用从开发阶段转移到生产阶段时，我们会遇到很多问题。

埃利宗多一直在寻找能够利用其可横向扩展的私有云基础架构的解决方案。他们希望他们的 web 应用程序在数量和使用上都有所增长，因此 Docker 是一个有吸引力的基础设施解决方案选项，可以根据他们的预期增长进行扩展。

当时，IIIEPE 在其应用架构中没有使用连续交付方法，因此迁移到 Docker 容器基础架构也为他们提供了结合其编排流程实施新的连续交付工作流的机会。

埃利宗多的博客系列记录了他在生产中对存储、编排、服务发现和负载平衡的方法，以此分享他在使其工作流准备就绪时必须解决的变通办法和挑战。

该团队有两台服务器。一个运行 MaestroNG，并负责启动库存码头集装箱。另一个运行一个运行 Jenkins 的虚拟机。“我们把它当作一种执行重复性工作的机器人，”他说。“我们对 Jenkins 进行了编程，这样当我们对任何项目进行新的更改时，Jenkins 都会检测到新的更改，重建整个映像，向新映像添加代码，然后命令 MaestroNG 从 Docker Hub 中提取映像，这基本上就是我们的工作流程。”

埃利宗多在 2014 年底使用 DigitalOcean 平台测试了新的架构和容器工作流程，令人惊讶的是，仅用了大约一个半月的时间来测试和解决所有问题。

“我们实验中最大的发现是，在我们的容器和 Git repos 中，这个工作流不仅仅适用于 Drupal，”他说。“它也适用于 Node.js 应用程序。我还用我们的 Ruby 应用程序测试了它。所以这是一个标准的工作流程。谁都可以用。”

## 使用 Kubernetes 管理生产中的容器复杂性

对埃利宗多来说，解决生产中的集装箱问题的方法是 Docker。例如，埃利宗多说他已经用 Kubernetes 做过实验，但是发现它太复杂了，不符合他的需要。但对其他人来说，比如电子商务巨头 Zulily 的核心工程团队，情况正好相反。据《华尔街日报》的雷切尔·金(Rachael King)报道，Zulily 于 2014 年 5 月首次开始在生产中试验容器。King 报道说，Zulily 的软件主管 Steve Reed 在 2015 年 7 月的 OSCON 上说“最难的部分是操作容器，尤其是在生产环境中。”

当第一次评估容器在生产中的好处时，由于编排中固有的复杂性，Zulily 最终搁置了他们基于 Docker 的生产用例的计划。然而，随着 Kubernetes 平台的成熟，它现在能够管理 Docker 容器的编排，Zulily 已经能够回到他们的生产目标上来了。“Kubernetes 已经为生产做好了准备，即使是像我们在 Zulily 这样的部署，我们也不会谈论数百个节点，”Reed now 说。

## 结论

2015 年初，在生产中使用容器被视为企业的一项实验或大胆选择。现在，仅仅 12 个月之后，生产中的容器不仅被部署用于试点或特定项目，而且被编织到企业的架构结构中。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>