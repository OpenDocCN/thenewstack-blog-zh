# 全员参与:在企业中运行 Kubernetes

> 原文：<https://thenewstack.io/all-hands-on-deck-running-kubernetes-within-an-enterprise/>

在本系列的第[部分](/kubernetes-in-the-house-enterprise-options-for-k8s-on-prem/)中，我们探讨了组织内部部署 Kubernetes 的一些常见原因，以及一些促进此类部署的流行平台。在本帖中，我们将了解一些在本地部署 Kubernetes 的最佳实践，以及像 Google Kubernetes 本地引擎( [GKE 本地](https://cloud.google.com/anthos/gke/docs/on-prem/overview))这样的公共云产品的到来。

除了前面提到的促使组织考虑在内部部署 K8s 的主要因素(即合规性、云能力和未来兼容性)之外，我们可能还应该提到几个因素。其中包括希望使用 Kubernetes 但不想花费大量资金在公共云上托管它的组织，以及部署混合解决方案的组织。

## 选择正确的平台

 [吐温·泰勒

吐温·泰勒在谷歌开始了他的职业生涯，在那里他为 AdWords 团队提供技术支持。后来，他构建了品牌社交媒体应用程序和自动化脚本，帮助初创公司更好地管理营销运营。今天，他阐述了 DevOps 团队如何改变他们构建和发布应用程序的方式。离开电脑时，他会弹贝斯吉他，或者找个借口骑着摩托车离开。](https://www.twaintaylor.com/) 

无论您的理由是什么，毫无疑问，从管理的角度来看，在本地部署 K8s 是“全员参与”，而实现这一目标的第一步是为您的部署选择正确的“平台”。在 Kubernetes 平台中，使用单个控制平面跨多个环境进行部署的能力是一项关键功能。这是因为，虽然一开始在几个不同的控制平面中管理几个集群似乎很容易，但当您开始扩展时，这变得非常不可持续。

清单上的第二项不仅需要管理和调配基础架构的能力，还需要与其他内部组件(如网络、存储、监控、负载平衡器等)良好集成的能力。请记住，这里没有公共云，因此您的应用程序完全依赖于您的基础架构以及您管理它的能力。强烈建议自动化这一层，因为这有助于更快、更好地部署以及自助服务。好消息是，大多数内部基础架构解决方案提供了与公共云解决方案相同的自动化水平。

要考虑的其他重要因素包括操作的简单性和供应商支持的质量、对开源的参与和支持、对有状态应用程序的支持程度、可伸缩性、稳定性和许可成本(如果有的话)。

## DevSecOps 从一开始

现在，与先设置存储、网络和监控，然后再回到安全性的做法相反，最佳实践要求从一开始就构建安全性。这就是为什么一旦你选择了平台，第二步就是开始考虑安全性和治理。强烈建议在构建和运行阶段集成一个扫描应用程序的图像扫描过程，特别是开源组件、库和框架。

使用旧的、更易受攻击的软件版本是容器安全问题的主要原因之一。实现版本控制是绕过这一障碍的一个很好的方法，尽管有很多解决方案是云原生的，但也有一些本地解决方案，包括一些开源的。使用[互联网安全中心](https://www.cisecurity.org/) (CIS) [的 Kubernetes 运行时基准](https://www.cisecurity.org/benchmark/kubernetes/)是另一个帮助建立安全配置基线的最佳实践。此外，SSL 密钥或数据库凭证需要加密，并使用 Kubernetes secrets 或第三方机密管理服务(如 Vault)集中存储。

## 适合的储物空间

Kubernetes 内部存储的最佳实践首先涉及选择支持内部部署并与微服务架构兼容的存储解决方案。避免专有解决方案，而是倾向于与 Kubernetes 紧密集成的供应商也是明智的。此外，选择与硬件无关的存储解决方案，同时满足内部容器存储的所有要求并支持所有标准接口(如容器存储接口[CSI])，这一点至关重要。

对于内部高可用性，最佳实践要求使用所有主要组件的冗余实例，如 etcd、scheduler 和 API 服务器。特别是对于 etcd 集群，建议维护一个至少有五个节点的专用集群，以确保集群的高可用性和可恢复性。最后，确保您的存储解决方案具有分布式架构，并与容器原生服务保持一致。

## 内部联网和监控

在内部部署 Kubernetes 涉及到灵活性和可移植性，传统的网络无法满足这一要求。这是因为随着规模的扩大，您无法让 IT 部门负责为每个环境手动创建网络。此外，像所有其他事情一样，确保您的网络解决方案与 Kubernetes 和兼容的容器网络接口(CNI)集成网络覆盖网络(如法兰绒)很好地集成也很重要。一旦您开始扩展，部署一个像 Istio 这样在内部和云中运行的服务网格对于管理服务到服务的通信是至关重要的。

在主机级别监控指标的传统方法需要被现代解决方案所取代，这些解决方案是容器原生的，并在应用程序级别提供对容器的可见性。最佳实践是支持与 Kubernetes 本地集成的工具，以自动服务发现为特色，并实时提供建议，最好是在机器学习算法或某种人工智能分析的帮助下。

## 内部公共云

混合云和内部部署最近在企业中引起了相当多的“关注”，很明显公共云巨头不会被排除在外。这可能就是为什么你现在可以使用亚马逊网络服务的前哨站来使用 AWS 服务，包括亚马逊 EKS，这是一个托管的 Kubernetes 服务。对于本地系统要求极低延迟的应用程序，建议采用这种设置。类似地，谷歌的 Anthos 允许你在内部使用 GKE，而 T2 的 Azure Stack 允许你使用 Azure Kubernetes 服务。如果你资金雄厚，又不想染指 Kubernetes，这些都是不错的选择，但供应商锁定是明显的缺点。

总之，基础设施抽象是寻求在本地部署 Kubernetes 的组织的底线和主要原因。虽然 PaaS 和公共云解决方案提供了许多可感知的安全性和熟悉性，但需要 Kubernetes-native 解决方案来利用 Kubernetes 内部部署的全部功能，如专注于第 2 天实施的 Kublr 或跨平台和环境服务上游 Kubernetes 的 Canonical。

*本文作者曾在 Rancher 和 Kublr 做过咨询工作。*

亚马逊网络服务是新堆栈的赞助商。

来自 Pixabay 的 Vined 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>