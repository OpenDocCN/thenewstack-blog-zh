<html>
<head>
<title>Nested Virtualization Offers Containers the Isolation of VMs without the Overhead</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">嵌套虚拟化为容器提供了虚拟机隔离，而没有开销</h1>
<blockquote>原文：<a href="https://thenewstack.io/azure-ahead-nested-virtualization/#0001-01-01">https://thenewstack.io/azure-ahead-nested-virtualization/#0001-01-01</a></blockquote><div><div id="tns-post-body-content">


<p class="translated">在虚拟机中运行虚拟机(VM)听起来可能效率低下，但在最新的CPU上运行硬件辅助虚拟化意味着只有适度的性能损失，并且这种嵌套虚拟化为传统应用程序以及混合搭配容器和虚拟机的应用程序打开了许多选项。</p>
<p class="translated"><a href="https://azure.microsoft.com/en-us/?v=17.14" class="ext-link" rel="external ">微软Azure </a>已经上线了该功能(它是Azure运行于其上的Windows Server 2016功能集的一部分，可用于所有地区的最新<a href="https://azure.microsoft.com/en-us/blog/introducing-the-new-dv3-and-ev3-vm-sizes/" class="ext-link" rel="external "> VM实例类型</a>)。<a href="https://cloud.google.com/kubernetes-engine" class="ext-link" rel="external ">谷歌计算引擎</a>最近<a href="https://cloudplatform.googleblog.com/2017/09/introducing-nested-virtualization-for.html" class="ext-link" rel="external ">发布了KVM和Linux虚拟机的测试版</a>，这些虚拟机运行在使用<a href="https://cloud.google.com/compute/docs/regions-zones/regions-zones#available" class="ext-link" rel="external "> Haswell或更新的CPU</a>的实例上，<a href="https://www.theregister.co.uk/2017/11/07/aws_writes_new_kvm_based_hypervisor_to_make_its_cloud_go_faster/" class="ext-link" rel="external ">亚马逊Web服务即将为其C5 </a>实例从Xen切换到KVM的原因之一很可能是为了实现嵌套虚拟化(特别是因为亚马逊今年早些时候向<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e1d39b17e044e8ae819827810d87d809ba5f58c0" class="ext-link" rel="external "> Linux内核贡献了一些相关代码</a>)。</p>
<p class="translated">这个想法并不新鲜；当微软在2003年从Connectix 购买虚拟个人电脑时，它可以运行自己的模拟器。但正是Hyper-V容器——它结合了Docker容器的优势和虚拟机的隔离——给了Windows服务器提供他们十年来一直想创建的功能的动力。</p>
<p class="translated">“我们发现这是一个非常方便、有用的工具，特别是对开发人员来说，但嵌套虚拟化的用例爆炸式增长非常快，”微软的泰勒·布朗告诉新堆栈。</p>
<h2 class="translated">提升、移位和追加</h2>
<p class="translated">“我们在Azure上的主要堆栈都是虚拟化的，”微软Azure计算产品负责人Corey Sanders指出。“一些客户需要利用一些虚拟化技术和功能，我们的主机不会直接公开这些技术和功能。”</p>
<p class="translated">最明显的用途是用于QA和运行培训实验室，在这种情况下，您希望将现有的虚拟化环境迁移到云中，而不做任何更改，这些都是谷歌为嵌套虚拟化提供的相同示例，使用类似<a href="http://www.functionize.com/" class="ext-link" rel="external ">功能化</a>的服务。</p>
<p class="translated">但布朗说，生产工作量也是如此。</p>
<p class="translated">“我可以将整个环境迁移到Azure，这是我以前无法做到的。我有一组预配置的虚拟机，我已经对它们进行了验证，它们可以正常工作；现在，我不必担心更改任何东西，我只需提升整个映像并在Azure中运行它，所有这些虚拟机将继续像以前一样工作。现在，我可以移动整个应用程序，这些应用程序不容易装箱或搬运；该应用的整个部分只是在一组嵌套的虚拟机中运行，甚至是一对一的。”</p>
<p class="translated">例如，与使用<a href="https://cloud.oracle.com/en_US/ravello" class="ext-link" rel="external "> Oracle的Ravello </a>嵌套虚拟化在AWS上运行VMware工作负载而不进行更改不同，还有机会扩展应用程序并通过对其进行编码来取代一次性的“雪花”环境。</p>
<p class="translated">嵌套虚拟化还为第三方软件供应商提供了一种为云打包现有应用和服务的方式。“我们有一个合作伙伴围绕Hyper-V Replica构建了一个解决方案，这是一个API，使您能够拍摄快照并将Hyper-V实时复制到另一个Hyper-V实例，”Sanders证实道。“他们希望在Azure中启用该解决方案，通过嵌套虚拟化，他们可以让客户在我们的虚拟机中部署虚拟机，并利用内置于Hyper-V中的技术。”</p>
<p class="translated">一些客户一直在要求嵌套虚拟化，以便对Azure上的虚拟机进行更多控制。“借助嵌套虚拟化，您可以在我们的规模内创建您想要的任何实例规模，甚至可以配置超额订阅，以更高效的方式尝试和利用云硬件。”这需要桑德斯巧妙地称之为“大量的复杂性”，同时也牺牲了云IaaS的简单性和敏捷性。</p>
<h2 class="translated">隔离虚拟机但没有开销的容器</h2>
<p class="translated">但Azure客户最感兴趣的是嵌套虚拟化可以使用Hyper-V容器将容器的低成本和更容易的服务模式与虚拟机的隔离和安全优势结合起来。“嵌套虚拟化的大趋势将是容器，”Sanders预测道。</p>
<p class="translated">“特别是对于那些运行一些面向客户的应用程序的客户，一些多租户解决方案，其中他们的最终客户可以完全访问容器，实现虚拟化保护和隔离层将非常重要，”他说。</p>
<p class="translated">布朗解释说，并不是每个人都需要这种保护，但这使集装箱对那些需要的人来说是可行的。“我们看到了Hyper-V隔离的充分渗透，很明显，业务和监管需要一个完善的隔离边界。”</p>
<p class="translated">“Hyper-V隔离允许我们在对话中说‘安全边界没有什么不同，它们与物理边界完全相同’，但容器是当今思考问题空间的一种不同方式。虚拟机提供的特性是它们非常安全，这对于一些应用程序来说很有价值，但对于其他应用程序来说确实没有必要。因此，我们可以就“为什么需要有状态层或不需要有状态层”展开对话。为什么那个特定的层级需要那个状态？我们可以为开发人员讨论一些事情，比如检查点；虚拟机提供检查点技术，可以捕获所有内存状态。这是您所需要的，还是您只需要磁盘上的状态；如果您需要的只是磁盘上的状态，那么容器会更适合您吗？"</p>
<p class="translated">布朗认为，这种发展反映了向容器的转变及其持续的演变。“虚拟机运行良好。它们解决了我们在云中的很多需求，但是容器为跨云和DevOps模型的可移植性提供了更好的体验。它们比抽象层次高了一步，但仍然提供了相同的价值，这也是它们如此吸引人的部分原因。”</p>
<p class="translated">随着开发人员开始发现他们可以用容器做什么，需要新的工具。“当我们发现一些领域的答案是‘我们需要这个工作的另一个工具’时，比如有状态性(stateful ness)——这是分离状态——像卷驱动程序和以一种非常容易理解的方式在容器外保存状态的能力。因此，我们获得了由容器和DevOps模型提供的更好的密度，但我们仍然可以将它用于一些有状态的应用程序。”在嵌套虚拟化中运行容器填补了另一个空白。</p>
<h2 class="translated">特定问题的真实世界解决方案</h2>
<p class="translated">然而，嵌套虚拟化并不是微软提供其新的VMware支持的方式(也不是微软最近宣布的对Azure的SAP HANA的支持)。“我们在裸机上发布了一系列功能，如SAP大型实例和Cray，”Sanders解释道。“在所有这些情况下，由于各种原因，裸机支持只能在裸机上进行，无论是网络要求、规模要求，还是Cray的实际硬件要求。在VMware的案例中，很多都是围绕着交付它所必需的网络要求。”</p>
<p class="translated">例如，嵌套虚拟化不支持广播或多播，Brown告诉我们Hyper-V团队希望做更多的工作来“提高内存访问和性能”</p>
<p class="translated">在Azure和Windows Server上使用嵌套虚拟化的Hyper-V容器最初只支持Windows容器，但<a href="https://cloudblogs.microsoft.com/hybridcloud/2017/04/18/dockercon-2017-powering-new-linux-innovations-with-hyper-v-isolation-and-windows-server/" class="ext-link" rel="external ">微软也一直在研究运行Linux容器的</a>(Windows上Linux容器的缩写为LCOW)。Windows Server 1709可以运行带有Hyper-V隔离的Linux容器，虽然Docker LinuxKit <a href="https://blog.docker.com/2017/09/preview-linux-containers-on-windows/" class="ext-link" rel="external ">支持还在预览</a>，这里有<a href="https://tutorials.ubuntu.com/tutorial/tutorial-windows-ubuntu-hyperv-containers#0" class="ext-link" rel="external "> Ubuntu的分步说明</a>；在带有vCPU的虚拟机中创建容器，如Dv3或Ev3实例，它运行嵌套虚拟化。</p>
<p class="translated">下一个阶段(仍在合并到<a href="https://github.com/moby/moby/pull/34859" class="ext-link" rel="external "> Docker </a>中)是支持同时在同一个Windows节点上并行运行Linux和Windows容器(不仅仅是在同一个集群中混合Windows和Linux节点，你已经可以这样做了)。这将在容器之间提供更好的延迟，但也允许组织在单个基础设施上运行混合负载，并使开发人员更容易在单个系统上构建混合的Linux和Windows应用程序。它为受监管行业中希望对Linux容器进行虚拟机级隔离的企业提供了传统虚拟化之外的另一种选择。</p>
<p class="translated">到目前为止，AWS和GCP只支持KVM，而且只支持Linux。虽然桑德斯指出Hyper-V是“我们完全理解并完全支持的虚拟机管理程序”，但Azure的嵌套虚拟化也适用于其他虚拟机管理程序；Azure自己的网络团队使用KVM的嵌套虚拟化来运行容器化的路由器，并在其<a href="https://www.microsoft.com/en-us/research/publication/crystalnet-faithfully-emulating-large-production-networks" class="ext-link" rel="external "> CrystalNet </a>网络仿真工具中与虚拟机一起交换映像——因为一些网络硬件制造商只提供虚拟机形式的映像，而一些只提供容器形式的映像。</p>
<p class="translated">随着组织超越将应用程序迁移到云并开始扩展和增强这些应用程序，这种混合和匹配的异构系统可能会变得更加常见。能从零开始，很难得；通常，一个应用程序需要的资源不会以同样干净、整洁、现代的形式存在。</p>
<p class="translated">桑德斯说:“几乎世界上的每一个应用程序，如果今天完全重写，都将使用非常不同的技术，但对于几乎每一个客户和应用程序来说，这只是一种不合理或合理的可能性。”</p>
<p class="attribution translated">谷歌、<a href="https://azure.microsoft.com/en-us/?v=17.14" class="ext-link" rel="external ">微软</a>和<a href="https://www.vmware.com/cloud-solutions/app-modernization/cloud-native-apps.html" class="ext-link" rel="external "> VMware </a>是新堆栈的赞助商。</p>
<p class="attribution translated">由<a href="https://unsplash.com/photos/05_sUnshoaE?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" class="ext-link" rel="external "> Kate Remmer </a>在<a href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" class="ext-link" rel="external "> Unsplash上拍摄的特征图像。</a></p>


<div class="tns-logo-slug">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 68 31" version="1.1">
<title>Group</title>
<desc>Created with Sketch.</desc>
<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
<g id="Group">
<path d="M24.002,29.619 L29.77,29.619 L29.77,15.808 C29.77,15.038 29.622,11.265 29.59,10.414 L29.77,10.414 C31.424,14.019 31.473,14.147 32.168,15.322 L39.65,29.618 L44.845,29.618 L44.845,0 L39.075,0 L39.075,11.064 C39.075,12.197 39.075,12.44 39.182,14.472 L39.325,17.468 L39.151,17.468 C39.034,17.267 38.596,16.173 38.467,15.929 C38.164,15.323 37.725,14.512 37.373,13.905 L30.031,0 L24,0 L24,29.619 L24.002,29.619 Z" id="Path-Copy" fill="#FF3287"/>
<path d="M56.948,0 C50.745,0 47.606,3.43 47.606,8.296 C47.606,14.114 51.036,15.404 55.518,17.132 C60.438,18.853 61.782,19.332 61.782,21.539 C61.782,24.225 58.969,24.867 57.401,24.867 C54.579,24.867 52.493,23.342 51.536,20.858 L47,24.185 C49.43,28.937 52.145,30.185 57.713,30.185 C59.364,30.185 62.059,29.74 63.727,28.694 C67.779,26.156 67.779,22.22 67.779,20.898 C67.779,18.129 66.531,16.207 66.178,15.726 C65.049,14.121 63.032,12.918 61.25,12.278 L57.084,10.914 C55.073,10.267 52.928,10.105 52.928,8.019 C52.928,7.707 53.008,5.528 56.288,5.319 L61.465,5.319 L61.465,0 C61.465,0 57.342,0 56.948,0 Z" id="Path-Copy-2" fill="#00AFF4"/>
<polygon id="Path" fill="#00AFF4" points="5.32907052e-15 1.77635684e-15 5.32907052e-15 5.319 7.572 5.319 7.572 29.564 14.132 29.564 14.132 5.319 21.544 5.319 21.544 1.77635684e-15"/>
</g>
</g>
</svg> </div>
</div>
</div>    
</body>
</html>