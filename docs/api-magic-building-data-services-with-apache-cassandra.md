# API Magic:用 Apache Cassandra 构建数据服务

> 原文：<https://thenewstack.io/api-magic-building-data-services-with-apache-cassandra/>

所有应用程序都依赖于数据，然而应用程序开发人员不喜欢考虑数据库。学习特定数据库的内部结构和查询语言会增加认知负荷，并且需要上下文切换，这会降低生产率。然而，成功的应用程序必须具有响应性、弹性和可伸缩性——所有这些特征都取决于数据库的选择。那么，应用程序开发人员应该如何平衡这些考虑呢？

如果我们可以改变这种平衡，用开发人员友好的习惯用法提供数据服务，而不是期望开发人员学习特定于数据库的习惯用法，会怎么样？

在 [Stargate project](https://stargate.io/) 上，开源 API 数据网关被设计为与 [Apache Cassandra](https://dtsx.io/3ZsUcBp) 一起工作，我们很兴奋地开始公开谈论我们即将到来的 [JSON API](https://github.com/stargate/jsonapi) ，它满足了面向 JSON 的开发者的条件。这不仅对面向 JSON 的开发人员来说是个好消息，而且我们所遵循的技术构成了一种新的设计模式，可以利用数据 API 和高级数据建模来产生数据服务。

在本文中，我将讨论如何使用 Cassandra 和 Stargate 来提供开发人员友好的习惯用法，以及我们如何为 JSON 做到这一点。

## 数据模型:互操作性与习语

在早期，Cassandra 有时被描述为“制作索引的机器”。这证明了卡桑德拉与生俱来的韧性和灵活性，一种可以塑造出更坚固结构的粘土。今天的卡桑德拉是一块更丰富的粘土，有着更大的可能性。它不仅是一个伟大的数据库，而且是一个伟大的数据库制造机器。在 Stargate 项目中，我们使用 JSON API 来证明这是数据库开发中新范例的第一个例子。

一个数据库建立在另一个数据库之上并不罕见。如果你挖得足够深，甚至 MongoDB 也是建立在 WiredTiger 之上的。AWS 以在幕后大量使用 MySQL 而闻名，包括[为 DynamoDB](https://news.ycombinator.com/item?id=18871661) 使用 MySQL 存储引擎。因此，使用 Cassandra 及其固有的可伸缩性和性能作为其他数据系统的构建模块的想法是有意义的。

然而，应用程序开发人员并没有真正与数据库进行交互。即使您的组织管理自己的数据库基础结构并根据该基础结构构建应用程序，第一步通常是定义和实现应用程序所需的数据模型。

这些数据模型是应用程序和数据库之间的媒介。在某种意义上，数据建模限制了数据库；它采用未成型的通用粘土，将其塑成某种为特定应用而特制的东西，习语。我们为了一些习惯性的东西牺牲了互操作性。

用一些惯用的东西来交换，放弃一些可互操作的东西，这是一个好主意吗？如果你想打破平均水平，那么答案是肯定的“是”我们在选择数据库的时候不怎么这么想，但是在选择编程语言的时候我们早就这么想了。

保罗·格拉厄姆在几十年前就很好地表达了这个想法，当时他解释了 Viaweb 如何在早期的网络竞赛中获胜，创建了第一个广泛成功的基于网络的电子商务平台。

Viaweb 不一定是最快或最具扩展性的电子商务平台。用格雷厄姆的话说，这是“相当有效的”相反，格雷厄姆认为，对于编程语言来说，在机器可读到人类可读的范围内，人类可读程度越高的语言(以及更高级别的语言)就越强大，因为它们提高了开发人员的生产率。在 Viaweb 时代，Graham 认为最强大的语言是 [Lisp](https://en.wikipedia.org/wiki/Lisp_(programming_language)) 。格雷厄姆论点的关键在于:

*“我们的假设是，如果我们用 Lisp 编写我们的软件，我们将能够比我们的竞争对手更快地完成功能，并且在我们的软件中做他们做不到的事情。因为 Lisp 是如此高级，我们不需要一个大的开发团队，所以我们的成本会更低。如果是这样的话，我们就能以更低的价格提供更好的产品，同时还能获得利润。我们最终会得到所有的用户，而我们的竞争对手将一无所获，并最终倒闭。”*

## 释放开发人员的生产力

Graham 在 20 年前写下了这句话，开发者生产力仍然是指引技术创新的北极星。在 Graham 谈到高级语言的力量时，我们表达了同样的概念，即向开发人员提供更符合他们软件开发经验的工具。

格雷厄姆称赞 Lisp(正确地)，自从网络时代以来，我们已经看到了新的高级语言的扩散:Ruby 和 Rust，举几个例子。我们也看到了移动设备开发语言和框架的诞生和扩散，如 Swift、Flutter 和 Dart。

那么为什么像 C 和 C++这样的语言仍然很重要呢？关于 C 的老笑话包含了一个重要的真理:“将汇编语言的强大功能与汇编语言的易用性结合起来。”如果你想写一个编译器，那么你需要向机器语言习语靠拢，远离自然语言习语。

换句话说，在其他优点中，C 和 C++是构建新语言的机器。Graham 对 Lisp 的赞美中容易忽略的是，Lisp 也有一些“构建语言的机器”的特征。

Lisp 是第一个引入宏概念的广泛使用的语言，而且经常是宏的概念使那些对 Lisp 不熟悉的人出错。一旦你理解了宏，你就会明白 Lisp 与其说是一种语言，不如说是一种元语言，宏可以用来为特定的问题领域构建一种专门构建的语言。

设计和创建一个初始的宏集是困难的、智力挑战性的工作。但是一旦 Graham 和 Viaweb 团队做到了这一点，实际上他们就有了一种电子商务编程语言，这释放了开发人员的生产力，使他们能够超越竞争对手。

二十年后，在编程语言的背景下，所有这些似乎都足够清楚了。那么，数据库世界发生了什么呢？简而言之，数据库发展得更慢了。

## 数据 API 革命

如果表格数据是数据库世界的汇编语言，那么 SQL 就是查询语言的 C/C++。在计算和存储昂贵的时代，我们开发了表格数据结构和数据规范化的概念，并用于定义良好、模式变化相对较少的用例。在这种情况下，为了在任何规模下高效运行，数据库都需要密切模仿计算机存储和访问信息的方式。

今天的世界正相反，相比之下，早期的时代似乎已经过时:计算和存储成本已经高度商品化，但在实时数据与机器学习和人工智能相结合的世界中，用例是开放的，模式变化是频繁的。

数据库技术中最近的一次革命是 NoSQL 革命，它是对关系数据库领域的大师们制定的表格化、规范化数据标准的直接回应。当我们说“NoSQL 革命”时，我们指的是从 2004 年谷歌发布其 [MapReduce 白皮书](https://static.googleusercontent.com/media/research.google.com/en//archive/mapreduce-osdi04.pdf)到 2007 年亚马逊发布其 [Dynamo 白皮书](https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf)这段时间。

从这一时期出现的是一个数据库家族，它通过放弃两个宝贵的关系原则实现了前所未有的速度、可伸缩性和弹性:NoSQL 数据库更喜欢非规范化数据而不是数据规范化，更喜欢最终一致性而不是事务一致性。2008 年首次发行的《卡桑德拉》诞生于这场革命。

数据 API 将是数据库技术的下一次重大革命，一场刚刚开始的革命。数据库世界的变化往往落后于编程语言和应用程序开发的变化。因此，尽管 RESTful APIs 已经存在了一段时间，并帮助引入了分布式、面向服务的应用程序的架构，但我们才刚刚开始看到数据 API 成为应用程序基础架构的关键部分。

为了理解这场革命的意义，以及在保罗·格拉厄姆宣言发表 20 年后，数据库世界如何最终交付开发人员的生产力，让我们看看 Stargate 自己的故事。它从返回互操作性与习惯性的主题开始。

## Stargate:高保真、地道的开发者体验

当我们决定卡珊德拉生态系统需要一个数据网关时，我们怀着一种紧迫感建立了最初的一套星门 API。这意味着一个整体架构；巨石柱建造起来更快，但并不总是更好。我们推出了 Cassandra 查询语言(CQL) API、REST API 和 RESTful 文档 API。我们很快添加了 GraphQL 作为额外的 API。迄今为止，星际之门已经可以互通；来自 Stargate 的一切都是使用原生 CQL 数据模型存储的，所以原则上，您可以从任何 API 查询任何表。

我们了解到，在实践中，没有人真的这样做。开发者坚持他们特定的习语。通过支持互操作性，我们在开发人员的体验中引入了卡桑德拉主义，从而阻碍了开发人员的生产力。因为 Stargate 的原始版本要求开发人员理解 Cassandra 的宽列表格数据结构，理解密钥空间和分区，我们锚定得离机器习语太近，离人类习语太远。

互操作性陷阱是在设计思维中倾向于通用而不是专用。我们已经转向根据目的构建来思考，这种方式用一些一般能力换取更具体的表达模式，使我们更接近人类的习语，而远离机器的习语。因此，我们开始思考:我们能否在保留卡珊德拉的 NoSQL 基金会的优点(规模、可用性和性能)的同时，交付高保真的惯用开发人员体验？

关键在于数据建模。为了将 Cassandra 变成“数据库的 Lisp”，我们需要一个数据模型，它可以服务于类似于 Lisp 宏的目的，以及一个 Stargate API，它将使开发人员能够与该数据模型进行惯用的交互。我们从 JSON 开始，它是应用程序开发人员之间数据结构的最大公分母，因此我们开始为 Stargate 构建 JSON API。然后我们必须弄清楚如何在 Cassandra 中最好地建模 JSON。

Stargate 已经有了一个文档 API，但是在 Stargate 的原始文档 API 中，我们使用了一个我们称之为“shrinking 的数据模型[来将一个 JSON 文档渲染成一个 Cassandra 表。该模型将一个文档映射到单个 Cassandra 表中的多行，并保留了互操作性。如果使用 CQL 查询结果表，将会得到有意义的结果。](https://stargate.io/2020/10/19/the-stargate-cassandra-documents-api.html)

这种原始的粉碎数据模型有缺点。它不保留关于文档的元数据。例如，对于任何包含数组的文档，一旦文档被编写，在没有完全检查文档的情况下，我们对数组大小一无所知。更重要的是，我们已经背离了卡珊德拉对索引的期望。Cassandra 对行进行索引，但是我们现在已经将文档分布在多行中，使得文档的本地 Cassandra 索引成为不可能。

为了让 Cassandra 成为适合 JSON 的存储引擎，我们需要一个新的数据模型，一个优于分解的模型。我们称之为“超级粉碎”你可以在 12 月的亚伦·莫顿 [Cassandra Summit talk](https://sched.co/1Gy9I) 上了解更多关于超级粉碎的知识，但这里有一个小问题:我们利用 Cassandra 的宽列特性，每行存储一个文档，因为我们知道 Cassandra 行甚至可以处理非常大的文档。

该行中还有一组列，专门用于存储 JSON 文档的标准元数据特征。现在我们有了更容易索引的东西，以及保存和检索元数据的方法。

## 回馈给卡珊德拉

是的，为了让这一切大规模运作，我们需要对 Cassandra 做一些基本的改变。苹果正在为 Cassandra 5 贡献的 Accord 将帮助我们以一种更具事务性的方式处理数据变化。DataStax 正在为 Cassandra 5 贡献的存储附加索引(SAI)和全局排序将帮助我们以更高效的方式处理针对 JSON 文档的范围查询。

卡珊德拉不是一个静态的软件；这是一个充满活力和不断发展的开源项目。因此，我们也在延续一个由来已久的 Cassandra 传统，即利用客户端出现的需求来促进数据库端的变化。用户需求促使提出了 Accord、SAI 和 Global Sort。这些不仅会让 Stargate 的 JSON API 更好，也会让 Cassandra 更好。这很好地提醒了我们，数据工程师和应用程序开发人员不是两个不同的社区，而是扩展的 Cassandra 社区的互补群体。

而 JSON 只是第一步。本质上，我们已经建立了一个文档数据库，你可以通过 Cassandra、Stargate 和一个相当有效的 Cassandra 数据模型的 JSON API 与之交互。超级粉碎是我们的宏指令。这种方法将 Cassandra 变成了一台制造数据库的机器。

除了 Cassandra 之外，这种方法会被其他数据库采用吗？不容易，原因如下。有一种类似热力学第二定律的数据库对卡珊德拉有利。我们从快速、可伸缩和有弹性的东西开始，但对开发人员来说不是很习惯。在合理效率的限制下，我们用一些速度、规模和弹性来换取更习惯的界面呈现给开发人员。一个人不容易做到的是反方向走。从高度习惯化的东西开始，然后试图找出如何使它快速、可伸缩和有弹性是一项艰巨的任务，甚至可能是不可能的。

热力学原理就是为什么数据 API 是新的数据库革命，为什么 Cassandra 是将推动这场革命的数据库。

在 3 月 14 日的虚拟活动 Cassandra Forward 了解更多信息。[现在注册](https://www.cassandrasummit.org/cassandra-forward)！

[*了解更多数据税务*](https://www.datastax.com/) *。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>