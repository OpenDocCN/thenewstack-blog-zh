# 如何为基于微服务的部署实现传统应用的现代化

> 原文：<https://thenewstack.io/modernize-legacy-applications-keep-update-re-write-needs-re-written/>

[](http://kublr.com/)

[Slava Koltovich](http://kublr.com/)

[Slava Koltovich 是 Kublr 的首席执行官，ku BLR 是一家领先的企业级 Kubernetes 供应商，由 EastBanc Technologies 提供技术支持。](http://kublr.com/)

[](http://kublr.com/)[](http://kublr.com/)

数字化转型迫使我们加快交付速度。每个组织都希望拥有设计良好的应用程序，能够部署到云和本地环境，独立更新服务，并在几小时或几天内部署修复程序和新功能，而不是几个月。组织满足于季度或半年发布的时代已经结束。

正如部署已经达到新的速度一样，用户也期望 100%的可用性。你上一次看到“网站因维护暂时关闭”页面是什么时候？消费者和最终用户期望应用程序全天候可用。

## 然而，DevOps 的承诺没有兑现

DevOps 本该为这类绿地项目带来涅槃重生。从可以独立更新或替换的服务构建的设计良好的应用程序；自动将代码变更推向质量保证(QA)的交付管道，甚至更好地推向生产环境；和平台，使您几乎可以在任何地方运行应用程序，而无需更改源代码。如果德沃普斯的承诺是真的就好了。如果我们今天能够以这种方式开发和部署应用程序，那么响应业务需求将轻而易举！

然而，现实是完全不同的:单一的应用程序，跨几个应用程序的重复功能(由不同的单位构建或收购)，不同的技术堆栈使得代码共享几乎不可能，危险的手动部署，等等。这些挑战会降低组织的速度，并阻止其利用技术创新。

> 那个遗留的应用程序很可能是由今天开发你的应用程序的同一批工程师编写的；他们只是在应用程序架构中使用了稍微不同的范例。

这是一个令人头痛的问题。然而，传统应用程序的伟大之处在于它们可以工作！他们传递价值，通常比你更了解你的业务。

但是，如何使这些单一的应用程序现代化呢？

中间立场在哪里？

你有什么选择来达到 DevOps 涅槃？

一个解决方案是从头开始重写一切。在某些情况下，这可能是唯一的选择(想想在大型机上运行的 Cobol)，但是重写是昂贵的。我们谈论的是一个数百万美元的事业，一个资源的消耗，以及巨大的失败风险。出于这些原因，重写很少是一个选项。

## 不要重写，重构

传统应用现代化的另一种方法是重构一切，目标是将传统应用拆分为[微服务](/category/microservices/)，并将这些微服务连接到一个平台，如 Docker 或 Kubernetes。该平台可能拥有你在后端运行微服务所需的一切；前端看起来是一样的。

重构遗留应用和微服务的开发不是你想仓促从事的事情。采取渐进的方法。在每次迭代之后(我们不是在谈论开发冲刺)，您需要确保您有一个正在运行的应用程序。它可能没有投入生产，但必须功能齐全。

以下是迭代方法的五个主要步骤:

1.  **计划有控制的行动:**作为第一步，你必须证明重构是可行的。以最简单的组件为例，你可以很容易地从你的应用程序中提取，然后重构或重写。本质上，您选择了最接近您需要的实现的版本，并在此基础上进行构建。

2.  **限制对你的应用程序池的破坏:**同时，尽量确保你的其他应用程序保持不变。你不想为了提取一个服务而重写大量代码。对于其余的应用程序，使用模仿旧行为的存根，它将在后台与新服务对话。

3.  **选择您的应用交付平台:**不要推迟您的应用交付平台选择。在我们的业务中，我们发现越早做越好。如果添加一个新的微服务令人头疼，你的团队就会退缩。尽可能使它简单，这样每个人都知道，一旦他们完成了代码，平台就会处理其他的事情。一旦第一个组件启动并运行，并且建立了平台，重复该过程。

4.  **区分组件的优先级:**根据提取的难易程度、路线图、风险等等来区分组件的优先级。将它与新的功能交付混合在一起，避免过于关注重构，否则你将冒把它变成完全重写的风险。当然，有些功能可能永远不会被重构。如果您知道您的一些前端将很快重建，比方说支持响应能力、新的移动平台等。，为什么要花时间去重构即将过时的东西。

5.  **远离数据统一:**尽量避免数据统一。这些项目很少成功，因为它们更关注数据结构而不是应用程序需求。相反，创建代理，将来自不同数据库的数据转换成您的新微服务能够理解的格式。这将定义需要什么样的数据以及如何存储和在哪里存储。

## 将所有这些放在一个真实的用例中

这一切在现实生活中是如何结合在一起的？让我们用一个具体的例子来看看从单片应用程序过渡到微服务的过程。

通常，当你听到“单体”、“企业”或“遗产”这些词时，你会想到一些复杂而古老的东西——一些你不想处理的东西。但是这样想想，那个应用程序很可能是由今天开发你的应用程序的同一批工程师编写的；他们只是在应用程序架构中使用了稍微不同的范例。

看看这些应用程序，你会发现，尽管它们是整体性的，但它们也被分成模块。这些模块也称为层，由数据库、对象关系映射(ORM——负责访问数据库的层)、业务逻辑层以及最终与用户界面(UI)的生成相对应的层组成。您还可以确定一个负责与其他系统集成的模块，通常有几个这样的模块，它们通常是独立的。

应用程序也可能有几个用户界面，一个用于后台，另一个用于前台。前者是在允许自动生成 UI 表单的技术上实现的。这部分比较难分开。然而，前台 UI 通常是为某种 JavaScript 技术实现的，并且更容易分离。

在应用程序中占用大量空间的一个模块是授权模块——存储用户特权数据的部分。分离这一部分可能是一个挑战，因为用户权限可以存储在数据库中，并与该数据密切相关(稍后将详细介绍)。

最后，应用程序中可能有几个辅助模块。例如，审计、历史信息存储和归档，这是一个负责业务流程、报告等的模块。

这些模块都不能按业务功能分组，但是它们总是每个遗留应用程序的基本部分。

考虑到传统和现代之间的这些相似性，现代化这些整体应用程序的过程从选择应用程序模块开始是有意义的，这些模块是由开发人员设计的逻辑划分较少的元素，并将它们作为独立容器中的独特服务运行。虽然不是真正的微服务，但我们正处于可以开始独立管理其生命周期的阶段。将来我们可以将每个服务分成几个更小的服务。

下面是执行的步骤:

### **在容器中运行数据库**

使用 Docker 容器的基础平台和 [Kubernetes](/category/kubernetes/) 容器编排引擎，获取当前数据库并在容器中运行它。如果您使用商业供应商数据库，明智的做法是首先与他们协商这种解决方案的主要可能性。如果您使用的是开源数据库(如 MySQL 或 PostgreSQL 系列)，那么您可以在容器中运行它，即使是在高可用模式下。您还需要考虑合适的容器存储解决方案，特别是如果您使用的是本地安装，其中有几个商业和开源选项。

### **注意 ORM 层**

一旦数据库启动，注意 ORM 层。该层允许您在 CRUD 级别将接口设置为 web 服务，并提供一组接口选项。根据您的编程语言，快速的互联网搜索会将您带到一个将方法转换为 REST 接口的库。

### **分离负责集成的模块**

接下来，您将分离负责集成的模块。这些通常在逻辑上被很好地分开，公开一个接口，并且有一个到数据库的连接。前台 UI 通常是使用 JavaScript 框架设计的，很容易安装在 Docker 容器中。大多数辅助模块可以相对简单地分离，因为企业应用程序不是完全从零开始编写的。

例如，嵌入式模式中的一个框架可以用作业务流的报告和组织。如果您的应用程序使用框架进行报告，您可以找到独立的应用程序并传输配置，而不是手动分离代码。研究你的企业应用的架构，你会找到一种方法来分离它。

可能最复杂的模块之一是包含业务逻辑的模块，它也可能包含 UI 部分。您可以从将它们全部放在一个容器中开始，然后，如果必要的话，逐渐将模块分成几个更小的模块。如果业务逻辑和 UI 的连接性很大，那么将这个模块划分成小的微服务可能不是一件容易的事情。但请记住，我们已经分离了其他几个模块，在这个阶段，我们不再处理一个单一的应用程序，只是一个大的。

后续步骤的驱动因素之一可以是对当前堆栈的分析，包括负责 UI 的堆栈。今天，技术发展迅速，值得考虑这项技术将使用多久——十年后会有专家支持这项产品吗？第二点可能是用户对当前 UI 实现的满意度问题的答案。

由于我们已经分离了应用程序，因此值得等待下一个业务功能请求，然后再决定是将该功能创建为新的微服务，还是调整当前应用程序以满足需求。也许这个特性将是第一个实现业务需求的微服务。

在这个决策过程中，您可能会发现对现有代码进行更改(例如，如果它是用旧语言编写的)比创建单独的微服务成本更高。主要是你已经通过把应用分成几个服务实现了微服务平台。您还安装了必要的基础设施，因此引入新服务本质上就是编写一些代码，没有实现开销。另一方面，如果包含业务逻辑的模块是以业务逻辑和 UI 分开的形式组织的，那么你可以更进一步，开始把它分成几个微服务。

### **考虑您的软件基础设施**

现在谈谈围绕应用程序的软件基础设施。要创建您的微服务架构，请使用微服务模式(可以在[这里](http://microservices.io/patterns/microservices.html)找到研究材料和指南的答案)，并选择一个服务网格将代理服务引入每个应用程序，然后集中管理这些代理。

Istio 就是这样一个工具。换句话说，一个[服务网格](/tag/service-mesh/)帮助设计应用程序，以去除应用程序的业务逻辑。您可以用任何编程语言编写应用程序的业务逻辑，对其进行封装，Istio 会处理诸如身份验证、授权、发现、智能路由和负载平衡、流量控制、安全性等重要事务。也就是说，微服务环境中所需的所有功能都在您的应用程序范围之外。

下一个重要的基础设施考虑是使用统一的方法来管理生命周期 API。每个服务都必须声明 API。如果应用程序很大或者有几个应用程序，那么实现成熟的 API 管理平台是值得的。这统一了方法，使服务和服务之间以及服务和人之间的通信更加透明。正如我们上面所讨论的，服务网格和管理 API 一起将解决认证、授权的挑战性问题。

### **开放便携**

最后一点，任何遗留应用程序的现代化最好通过开源、可移植的工具来实现。为了部署到 Kubernetes，我们通常建立一个管道，使用 Jenkins 进行 CI(持续集成)，使用 Spinnaker 进行 CD(持续部署)。至于映像存储库，目前每个云提供商都提供这一功能，并且有几种产品可用于内部部署，尽管我们最常用的是 Nexus。

提示:不要过度使用詹金斯。组织倾向于像 Jenkins jobs 一样构建自己的部署机制。这是对资源的低效利用。像 Spinnaker 这样的工具已经实现了大多数场景，例如，blue\green 部署和 canary 发布。

我们还建议您投资开发微服务的单元和集成测试。这些测试的可用性将决定您交付微服务的速度和效率，并减轻 QA 团队的压力。

## 结果是:风险更小、收益更快、更现代化

虽然重构和容器化应用程序的工作量不会比完全重写更快或更便宜，但这是一种风险更小的应用程序现代化方法。因为我们的方法是迭代的，所以您可以更有效地管理您的风险状况。你也会看到立竿见影的效果。你可以在每一次迭代中将结果建立在你的重构之上，而不是等待一个重写的项目完成才能看到结果。您还可以将它与新特性的交付很好地结合起来，基于您新重构的组件，将您的重构工作与新的开发结合起来。

利用这种方法使您的传统应用程序现代化—保留它们，更新它们，并且只重写需要重写的内容。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>