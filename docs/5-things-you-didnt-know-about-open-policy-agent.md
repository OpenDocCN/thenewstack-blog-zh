# 关于开放式保单代理，你不知道的 5 件事

> 原文：<https://thenewstack.io/5-things-you-didnt-know-about-open-policy-agent/>

[](https://www.linkedin.com/in/anderseknert/)

[Anders Eknert](https://www.linkedin.com/in/anderseknert/)

[Anders 是 Styra 的一名开发人员，在主要分布式环境的软件开发、安全和身份系统方面有着长期的背景。不在电脑前时，他喜欢看足球、烹饪和比利时啤酒。在推特上关注他，地址是@ anderskernt](https://www.linkedin.com/in/anderseknert/)

当向应用程序开发人员和平台工程师介绍[开放策略代理(OPA)](https://blog.styra.com/blog/what-is-open-policy-agent?utm_campaign=MKT%202020-12-16%20The%20New%20Stack%20sponsorship&utm_source=byline) 时，我通常会以一个项目符号列表来结束我的演示，该列表详细列出了我认为开始学习 OPA 及其声明性策略语言减压阀的最佳步骤。一些简单的事情，比如“从小处着手”，“这些[文档](https://www.openpolicyagent.org/docs/latest/)很棒，请阅读它们！”还有“试试[斯泰拉学院](https://academy.styra.com/)”

对 OPA 是什么以及如何在减压阀编写简单的策略并部署它们的这种基本理解实际上可能足以解决开发团队可能面临的关于应用程序授权的大多数问题。其他场景需要更深入的理解。或者有人会发现自己喜欢学习更多的东西。

假设你知道基础知识，并且你想学习更多，你如何把你的技能提升到一个新的水平？答案取决于您的兴趣所在(例如，性能、数据集成等。).因此，没有任何借口提供一个完整的答案，这里有五种方法来加强你的 OPA/减压阀游戏。

## 1.理解是理解的关键

如果你曾经在减压阀收集过数据，你可能会发现自己掌握了常见的功能性习惯用法，如“映射”、“过滤”或“减少”。减压阀以[理解](https://www.openpolicyagent.org/docs/latest/policy-language/#comprehensions)的形式提供了一个有趣且同样强大的选择。综合处理减压阀中的所有集合(即复合值)类型，如[数组](https://www.openpolicyagent.org/docs/latest/policy-language/#array-comprehensions)、[集合](https://www.openpolicyagent.org/docs/latest/policy-language/#set-comprehensions)和[对象](https://www.openpolicyagent.org/docs/latest/policy-language/#object-comprehensions)。

理解提供了一种简洁、优雅的方式来获取一个集合(或多个集合！)作为输入，并将修改后的新集合作为输出返回。想要大写数组中的所有字符串吗？用一个理解。想过滤掉集合中所有不匹配谓词的项目吗？用一个理解。有一个键数组和另一个值数组，想从这两个数组构建一个新的映射？你猜对了，理解支持你。

在下面的例子中，我们期望找到一个以 URN 形式的权限数组作为输入的一部分。任何权限的结构都是“urn:domain:resource:action”，因此，如果允许用户 Jane 读取信用报告，权限可能是这样的:“urn:credit:report:read”。如果我们想获得 Jane 可读的所有资源的列表，我们可以使用一个理解来做到这一点:

```
readable  :=  [resource  |  urn  :=  input.user.roles[_]
                        [_,  _,  resource,  action]  :=  split(urn,  ":")
     action  ==  "read"]

```

在上面的理解中，我们迭代角色，在“:”上拆分每个 URN，并检查最后一部分(动作)是否是“read”。如果是，资源的名称将作为新数组的一部分包含在内。如果我们宁愿返回一个集合，我们可以简单地用花括号替换外面的方括号。

## 2.布景太棒了

JSON 只支持数组，而减压阀同时支持数组和集合。虽然这些唯一值的无序集合看起来没什么大不了的，但在减压阀策略中，它们通常优于数组。为什么？

1.  很好地映射到领域——像组或角色这样的公共对象几乎总是唯一的和无序的。
2.  常见的“包含”和“不包含”操作不需要迭代。检查我的集合是否包含项目再简单不过了。如果集合不包含项目，则不进行检查。
3.  真正有用的[内置](https://www.openpolicyagent.org/docs/latest/policy-reference/#sets-2)用于执行集合运算，如[交集](https://en.wikipedia.org/wiki/Intersection_(set_theory))，简洁地回答常见问题，如“该用户是否在所有需要的组中？”或者 [union](https://en.wikipedia.org/wiki/Union_(set_theory)) 来查询“如果我想执行操作 X、Y 和 Z，我需要的所有角色是什么？”

在减压阀创建新的集合很简单，但是如果 JSON 不支持集合，并且提供给 OPA 的任何输入都是以 JSON 的形式提供的，那么我们如何从 input 开始使用它们呢？简单——使用一套理解(看，我告诉过你理解是有用的！)遍历数组并将每一项复制到一个新的集合:

```
my_set  :=  {x  |  x  :=  my_arr[_]}

```

那么，为什么它们没有变得更普遍呢？首先，由于集合不像数组那样广为人知，集合操作也不像数组迭代那样熟悉，所以使用集合而不是数组的策略可能会被认为更复杂。幸运的是，差异很小，只需几分钟的教育就足以让你相信 set 的大部分好处。

此外，由于集合不能被表示为 JSON，所以每当我们想要以集合的形式处理输入内容时，我们需要在策略中添加一些额外的数组到集合的转换仪式。即使考虑到这一点，您处理集合的策略也很有可能比迭代多个数组的策略更简单明了。

总结:布景太棒了！正确使用它们可以大大简化一些政策。了解何时使用(和不使用)它们。

## 3.OPA 文档模型和减压阀查询语言

理解 OPA 和减压阀的一个关键方面是理解 OPA 文档模型是如何工作的。了解文档模型确实是任何高级 OPA 开发的关键，但也许特别是*交互式*开发，其中您经常*查询*文档以获得结果，无论是借助 REST API、REPL 还是作为编写减压阀[测试](https://www.openpolicyagent.org/docs/latest/policy-testing/)的一部分。

OPA 文档模型由两种类型的文档组成。首先，存在策略和规则，它们生成*虚拟文档*，通常基于被查询的规则可用的其他规则、数据或内置函数。其次，OPA 文档模型包括*基础文档*，即加载到 OPA 中的任意*数据*。无论是否生成减压阀文档，所有**数据**都存储在同一层级文档下，可以使用减压阀*查询语言*进行查询。

也许真正感受 OPA 文档模型的最有效方法是通过 OPA REST API 查询它。只需将您最喜欢的 API 客户机指向/v1/data 端点，就可以检索 OPA 实例中所有数据的完整视图，无论这些数据是否生成。

## 4.减压阀游乐场的把戏

掌握任何语言或工具的一个最基本的要求是了解正在发生的事情。观察事物的状态和流程，不仅是为了回答一个查询、规则或函数产生了什么，也是为了回答为什么会发生什么——这项技能在减压阀和软件开发的任何领域都是至关重要的。

在到达那种启蒙状态之前，你只要盯着它，就能准确地预测一个减压阀文件规则将返回什么，你将需要一些工具来帮助你。OPA 本身提供了一些工具来帮助你，你会在生态系统中发现更多，比如 IntelliJ IDEA 插件、VS 代码扩展插件和其他编辑器插件。

减压阀游乐场众所周知，并迅速成为许多减压阀开发者撰写和分享政策片段的最爱工具。您的策略是否没有按照您的预期运行，并且您无法找出原因？使用“发布”按钮获得一个永久链接，然后您可以在 [OPA Slack](https://slack.openpolicyagent.org/) 或其他地方与其他人共享该链接以获得支持。

虽然使用得当，但许多人似乎忽略了游乐场的一些伟大特征。首先，在评估前选中“覆盖率”复选框将使每行以绿色或红色显示。绿色表示评估成功，红色表示评估失败，例如由于某个值未定义。这通常会使评估失败的位置和原因变得非常明显，从而提供了在重新评估之前纠正策略中任何错误的机会。

其次，如果您选择了您正在创作的策略中的一些文本，“评估”按钮将切换到显示“评估选择”这使得快速识别变量值或表达式结果变得非常方便，甚至在规则内部也是如此！

最后，你知道减压阀游乐场包括一个[捆绑服务器](https://www.openpolicyagent.org/docs/latest/management-bundles/)吗？按下“发布”后，查看“使用游乐场政策运行 OPA”下面列出的说明。这将获取您在屏幕上看到的策略(和数据),并在本地机器上的 OPA 中运行它，在 Kubernetes 集群中或任何您想要的地方！虽然这显然不是为了生产使用，但这是一个将操场代码快速转移到真实应用程序中进行测试的好方法。

## 5.REPL 岩石

OPA REPL(Read-Evaluate-Print-Loop)可能不如操场那样广为人知或使用，但对探索性政策制定非常有用，它为从内部查询 OPA 提供了一个“实时”环境，无论是数据、规则还是函数。

凭借对 OPA 文档模型的理解，REPL 成为快速浏览 OPA 文档的首选环境，无论这些文档是基础文档还是虚拟文档。只需发出不带–server 标志的 opa run 命令来启动 REPL。在 REPL 中键入“help”以获得所有可用命令的列表，或者直接开始键入您的查询。

就像 REST API 一样，您可以查询完整的数据，也可以深入到特定的文档。因为您很可能想尝试为您查询的文档提供不同的输入，所以带有关键字的**在这个上下文中非常有用:** 

```
data.policies.authz.allow with input.user as  {"roles":  ["developer"]}

```

如果你认为这看起来类似于一个测试断言，那你就完全正确了！在编写测试时，将 OPA 测试运行程序与 REPL 结合使用是探索不同评估变量的结果的一个好方法。与大多数 REPL 和 shells 一样，您可以通过使用向上和向下箭头来浏览过去命令的历史，并且这些环境中熟悉的许多键盘快捷键也可以在 OPA REPL 中使用。

## 包扎

最后，减压阀、OPA 及其工具一直在改进，今天被认为是 OPA/减压阀开发的最佳实践，明天可能会有更好的替代方案。也许一个减压阀[调试器](https://github.com/open-policy-agent/opa/issues/3191)会简化那些习惯于这种工作流程的人的政策制定？此外，有时我们真正想要的只是在控制台上*打印*一些东西——不管是“hello”、变量值还是脏话。或许是时候将一个合适的[打印功能](https://github.com/open-policy-agent/opa/issues/3319)添加到不断增长的有用内置列表中了？

随着 OPA 向前发展的步伐，我们将迎来一些激动人心的时刻！

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>