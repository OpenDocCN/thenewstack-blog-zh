# 头盔 3 几乎是无聊的，这是一个成熟的伟大标志

> 原文：<https://thenewstack.io/helm-3-is-almost-boring-and-thats-a-great-sign-of-maturity/>

如果你听说过的关于 [Helm 3](https://helm.sh/) 的唯一事情是它移除了 [Tiller](https://github.com/markround/tiller) 动态配置文件生成工具，那么你已经知道了关于最新发布的权威 Kubernetes 包管理器的最重要的事情:该项目已经进行了重大的重写，以赶上 Kubernetes 的状态并消除长期的安全问题。这是项目成熟的标志，也反映在其他关键发展中，如更好的补丁合并，可用性的重大改进，包括发布管理，以及 Helm 2 图表的清晰支持生命周期。

微软首席项目经理 [Bridget Kromhout](https://github.com/bridgetkromhout) 告诉新堆栈，作为一个安全性和稳定性的进化更新，而不是一个带有铃铛和哨子的新功能清单，是一个好迹象。

“Helm 3 更简单、更安全，可能不会成为一个华丽的标题，但这些功能对任何大规模操作系统的人来说都是令人愉快的。冒险、刺激:一个随叫随到的工程师渴望的不是这些。在功能上添加功能是一个简单的默认，而经过深思熟虑的编辑是项目成熟的一个受欢迎的标志，”她说。

“你知道有多少项目删除了大量代码？这是成熟的标志，”Azure Container Compute 的首席项目经理 lach LAN Evenson 认为，他是 Kubernetes 1.16 的发布负责人。“他们说这不再是人们想要的；让我们继续前进，摆脱它，让我们提高我们的安全姿态。因为我们在 Helm 2 社区中听到的是，我们喜欢 Helm，但 Helm 的安全姿态不是我们在生产中想要的。所以我们基本上接受了这一点，并表示我们将在 Helm 3 中提供这一点。让我们获得安全态势，准确地达到我们需要的位置。”

## 取出分蘖

Helm 是一个复古项目，由 Deis 在 Kubernetes 之后不久启动，并在第一届 Kubecon 上宣布。Helm 2 是与 Google 的 Kubernetes 部署管理器团队一起构建的，并添加了 Tiller 组件和 GRPC 来处理 Helm 图表的安装和管理，呈现图表并将其推送到 Kubernetes API 服务器。

Tiller 允许团队共享一个 Kubernetes 集群，多个操作员可以使用同一套版本，但随着 Kubernetes API 的发展，Tiller 没有跟上，导致一些人担心授予任何人访问 Tiller 的广泛权限。

“对 Helm 的担忧，部分是因为它已经存在了很长时间，在很大程度上是围绕着安全性，比如如何将现成的软件安全地交付到集群中？”Azure Compute 的主管 Gabe Monroy 解释道，他在 Deis 的团队启动了这个项目。“Helm 3 已经过重新设计，去掉了 Tiller，并将许多这种逻辑转移到更现代的 Kubernetes 技术中，如操作符和客户端模板。”

> 既然自定义资源定义已经可用，Tiller 不再需要维护状态，也不再需要成为 Helm 发布信息的中心。

移除 Tiller 是可能的，因为自 Helm 2 于 2016 年发布以来，Kubernetes 增加了一些重要功能，如基于角色的访问控制和自定义资源定义。“当时，还没有 CRDs，也没有 RBAC。蒙罗伊指出:“上帝模式就是模式，没有其他方法可以做到这一点。”。

现在 CRDs 已经可以使用了，Tiller 不再需要维护状态或者是通过 Helm 发布信息的中心枢纽；所有这些信息都可以作为记录存储在 Kubernetes 中。用户身份验证和授权现在由 Kubernetes 完成，而 Helm 权限只是 Kubernetes 权限，因此他们使用 RBAC，集群管理员可以选择他们想要使用的粒度 Helm 权限。

Helm 取代了 Tiller 的客户机-服务器模型，成为了 Kubernetes 的客户机；这消除了层层复杂性，但仍为运营商提供了他们需要的工具。

IBM 高级软件工程师兼 Helm 核心维护者 [Martin Hickey](https://github.com/hickeyma) 告诉我们，如果你习惯了 Helm 2，这是思维模式上的一个重大变化。“有了 Helm 2，人们谈论了很多关于 Tiller 的事情；他们担心安全问题，他们担心设置这个东西。你可以进去，让蒂勒安全，但我们都采取系统和使用默认设置，我们很少改变他们。安全现在被推到 Kubernetes。我们已经把它推到了它应该在的地方，理解它的地方，RBAC 在的地方。”

Helm 3 还降低了设置和操作的复杂性。"本质上，你是在那里放了一个代理，这增加了一层额外的复杂性."Hickey 解释说，锁定 Tiller 权限是可能的，但特别是对于多租户集群，默认设置(旨在使其易于采用)过于开放，可能会导致混乱。

“当您[使用 Helm]部署一个版本时，它不会存储在集群内的命名空间中。它存储在 Tiller 的名称空间中。默认情况下，这是 kubesystem。那是你的系统命名空间！假设有人没有更改 Tiller 名称空间，接下来你看到的是 kubesystem 中成百上千的配置图，你会感到非常愤怒！如果你不知道如何寻找它，不知道它的主人是蒂勒，你就不知道它们是从哪里来的。”

Hickey 警告说，Helm 3 不再发生这种情况，所以如果你习惯了 Helm 2 的工作方式，命名空间的改进可能会有点混乱，因为你必须在正确的位置寻找你的部署。“因为蒂勒是在上帝模式下运行的，除非你对它进行了不同的重新配置，否则当你执行 **helm -ls** 时，它会返回所有内容。现在，它将进入您要求它进入的名称空间，是的，现在您必须创建名称空间。”

(如果你不想手工完成，有一个[名称空间插件](https://github.com/thomastaylor312/helm-namespace)仍然可以为你创建名称空间。)

### **发布、配置和图表**

没有 Tiller，Helm 需要一种方法来跟踪集群中不同版本的状态。头盔 2 可以选择释放物品的秘密；现在是默认了。

存储在发布名称空间中的发布信息也非常不同:它既包括发布实例，这是关于图表的特定安装的信息，也包括 **ReleaseVersion** secret，它存储发布的升级、回滚或删除的细节。如果你使用 Helm 图表安装 WordPress，这将创建一个 WordPress 版本，如果你使用 Helm 升级 WordPress，这将创建一个包含升级操作细节的新的 **releaseVersion** secret，并修改 Release 对象以指向新的 secret。如果您需要回到旧版本，您可以使用旧的 **ReleaseVersion** secret 将版本回滚到更早的状态。

如果您需要在多个地方安装同一个应用程序，将发布信息存储在相关的名称空间中也使得重复命名变得更加容易(比如将单独的 WordPress 实例作为从同一个集群运行的不同系统的一部分。在 Helm 2 中，如果集群只有一个 Tiller 实例，那么版本名必须是唯一的。

随着 Tiller 的消失和 Helm 现在直接与 Kubernetes API 对话， **helm init** 和 **home** 也被移除，因为你不需要它们来创建和存储配置；相反，配置文件现在使用 XDG 存储。Hickey 指出:“XDG 是一种标准的方式，你可以把你的配置放在一个文件系统上，不管它是 Windows、Linux 还是其他什么，它是平台独立的。”。“所以我们现在可以做懒人创作了。当您需要该配置时，可以即时创建，不需要预先完成。所以你点击你的二进制文件，然后你就可以走了；那是在打击人们的思想！”

尽管头盔基本上被重写，去掉了舵柄，头盔 2 的图表仍然适用于头盔 3(有一些例外，这意味着它们需要更新)。Monroy 说，这是一个非常慎重的决定，因为 Helm 的价值与其说是引擎，不如说是社区内容的财富。

“架构非常不同，更加现代，但它仍然具有在生态系统中创建的内容的所有好处，为您提供键入 **helm install kafka** 的良好体验，并且您有一个 kafka 集群在运行，现在只是增加了安全性。”

“我们非常清楚的一件事是头盔 2 的图表仍然应该在头盔 3 中渲染和部署，”希基补充道。“图表应该仍然能够运行，如果它们没有运行，请联系我们。名称空间和 CRD 之间有一些细微的差别，其原因是为了更好地与 Kubernetes 保持一致。”依赖性管理也略有不同。

围绕 CRD 的变化反映了一个事实，即 Kubernetes 生态系统仍然在决定如何管理 CRD 以避免类似于 DLL 地狱。“一个应用程序可以拥有一个 CRD，也可以由多个应用程序拥有，我们正在尝试用图表管理 CRD。我们对它进行了简化和重新设计，只创建 CRDs 所以没有更多的修改或删除，”希基说。现在将自动安装 CRD，但是如果它们已经存在，它们将不会被再次安装，并且有一个跳过安装的命令。这符合越来越常见的 DevOps 模式，即用一个图表安装 CRD，然后用它们自己的图表安装应用程序。

如果您想让图表同时与 Helm 2 和 Helm 3 一起工作，请确保它们创建了名称空间并使用了 **crd-install** 钩子和 **crds/** 目录；这个钩子将会被头盔 3 忽略并发出警告，但是在头盔 2 中仍然有效。

但是，如果你准备好迁移到 Helm 3，你可以利用新的图表功能——如果你这样做，你应该将你的 Helm 3 图表标记为使用 Helm 版本 2 API。同样，这可能最初会令人困惑:图表 API 版本在 Helm 的第一版中是 v1，而在 Helm 2 中是 v1，所以在 Helm 3 中图表 API 迁移到了 v2。

“我们对此表示歉意，但我们将 API 版本号提升至 v2，以便我们能够在引擎中了解它是 Helm 3 图表还是 Helm 2 图表，”Hickey 解释道。"新的图表将不会在头盔 2 中呈现，因为那里没有这些功能."

这些功能包括库图表，它取代了 Helm 2 中的常用图表，以帮助您在多个图表中共享和重用您需要的代码片段，以保持一致性(并避免键入和复制粘贴错误)。将图表的属性字段设置为 library 而不是 app，您可以创建一个不包含任何部署对象、不创建任何发布工件但可被其他图表引用的图表。这是区分图表类型的一种更简洁的方式，避免了在头盔 2 中意外安装一个普通图表产生错误的问题。

需求和依赖转移到了 **chart.yaml** 文件中，因此需要为 Helm 2 和 3 指定不同的需求和依赖。图表现在还可以使用 JSON 模式来验证 install、upgrade、template 和 lint 命令，以使需要设置的值更加清晰。

当您使用 Helm 更新版本时，它现在会进行三向合并，包括实时集群状态以及使用最新的和建议的图表清单。只查看清单意味着丢失作为 sidecar 注入的任何东西，比如 Istio 代理或 Linkerd 服务网格，或者通过其他带外方法注入的任何东西，因为它不会出现在任何一个图表中。那些现在将在升级期间被保留。

### **更简单，安全，准备 2020 年毕业**

Helm 3 重新架构的另一个结果是 Go SDK 也进行了重新架构。CLI 是 SDK 的包装器，使其易于使用，但如果您想要创建更复杂的部署模式，您需要直接使用 SDK 和 Helm 2，这很难做到。Hickey 解释说:“现在它已经被很好地分离了，并且这些包被更好地封装在 CLI 部分之外。”如果你想让 Helm 成为管道的一部分，你需要使用 Helm 的一部分功能，并在其中插入你自己的步骤，你可以直接调用 Go SDK 中的包来完成。这就是从头盔 2 迁移到头盔 3 的插件[的工作方式](https://GitHub.com/helm/helm-2to3)。

对 Helm 引擎和社区图表内容的成熟度的强调是该项目从其云计算原生计算基础孵化状态中毕业的一步，因为它成功地通过了先决条件[第三方安全审计](https://github.com/helm/community/blob/master/security-audit/HLM-01-report.pdf)。

“我们希望将 Helm 转移到一个毕业项目中，我们希望确保这是一个安全的产品，并支持 Helm 3 的安全态势，”Evenson 说。“TLDR 是发光的；它被推荐用于生产，我认为在最高的给定代码质量方面，它仅次于 linkerd。它有一个很小的问题，第二天就被修补了。”

在 Helm 安全审计的同时，Snyk 还对公共 Helm repo 中的图表进行了安全审计，在这些图表引用的图像中寻找漏洞。

“我们在内部使用 Helm，我们知道安全审计，但那是项目的范围，”Snyk 产品管理总监 [Gareth Rushgrove](https://github.com/garethr) 告诉我们。“显然 Helm 本身需要安全，但 Helm 是一个人们使用内容的项目。你不是为了引擎而使用它，你使用它是因为它是你如何获得内容的，实际上没有人关注这些内容的安全性。”

以如此方便的方式解决漏洞以获得应用程序，如掌舵图，将对人们获得软件的更新版本产生重大影响。因此，尽管有许多图表引用了带有漏洞的过期图像，但图表维护者欢迎审计并着手解决问题。“我认为他们成熟的做法值得称赞，因为一家安全公司向他们表示，我们一直在关注你们生态系统的安全性。”Snyk 用来检查图表漏洞的插件是[，现在在头盔](https://github.com/snyk-labs/helm-snyk)中可用。

拉什格罗夫还将 Helm 3 的明确范围视为成熟的标志。“他们可能已经忘乎所以了；Helm 3 有像 Perl 6 一样的风险。然后他们说，让我们实际上运送这个，让我们专注于我们想要在那里得到的主要东西。”

如果像 Helm 这样广泛使用的东西(每月超过 100 万次下载，是 CNCF 第三大被采用的技术)仍在孵化中令人惊讶，那么值得记住的是，它曾经是 Kubernetes 的顶级项目，直到 2018 年 Kubernetes 自己搬到 CNCF 后才成为一个独立的项目。虽然 Helm 接下来的步骤是关于文档和开放接受功能广告，随着安全审计的完成，Hickey 建议 Helm 很可能在 2020 年初毕业。

赫尔姆的孵化状态也不能反映赫尔姆图表社区的规模。“赫尔姆周围的社区规模庞大，形式多样，并继续以令人难以置信的速度增长，”蒙罗伊指出。“我认为，能够用一个命令安装复杂软件的价值主张正在进入一个工作流程，而 Kubernetes 和 CNCF 生态系统仍在努力解决这个问题。Helm 实现了一种 helm 安装模式，而生态系统的其余部分仍在努力提供这种模式。”

能够进行重大的内部更改，使项目与当前关注的问题保持相关，而不中断用户，这是一项令人印象深刻的成就，尽管在云原生世界中有各种各样的打包和安装工具，Helm 仍然能够保持相关。

“经受住时间考验的平台有能力随着技术基础的变化而发展，”Monroy 指出。“Kubernetes 展示了以这种方式发展的能力，我认为 Helm 带来的价值主张是一样的。人们仍然会使用 Helm，因为它已经经历了一些严重的重新架构；作为一项关键的使能技术，它的价值将会持续很长时间。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>