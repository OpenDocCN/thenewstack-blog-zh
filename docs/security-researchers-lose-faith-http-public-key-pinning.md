# 安全研究人员对 HTTP 公钥密码失去信心

> 原文：<https://thenewstack.io/security-researchers-lose-faith-http-public-key-pinning/>

几年前，谷歌安全工程师为网站管理员提出了一种方法来保护他们的用户免受黑客的攻击，这些黑客可能试图通过使用欺诈性获得的 SSL 证书来冒充 HTTPS 网站。这种安全机制被称为 [HTTP 公钥锁定](https://tools.ietf.org/html/rfc7469) (HPKP)或证书锁定，现在是一种互联网标准，但一些安全研究人员对其效率有了新的想法。

事实证明，证书锁定弊大于利，因为它很难配置，错误的配置会导致网站无法访问。最重要的是，黑客还可能滥用它进行类似勒索软件的攻击。

HPKP 背后的想法——网站可以准确地告诉浏览器他们应该从他们那里得到什么证书——是为了应对一系列事件而产生的，在这些事件中，黑客通过欺骗证书管理机构或破坏他们的基础设施，成功获得了他们不拥有的网站的 SSL 证书。

## 信任问题

互联网公钥基础设施的安全性依赖于浏览器和操作系统制造商对被称为证书颁发机构(CAs)的组织的信任。在执行域名所有权检查后，这些组织可以为网站颁发公共信任的 SSL 证书。ca 必须遵循行业公认的政策，并接受定期的外部审计，但有时事情会因为各种原因而出错。

一个问题是，有数十个证书颁发机构分布在世界各地，其中许多还拥有授权经销商，可以代表他们颁发证书。一些认证机构由商业公司管理，而另一些则由政府支持的机构运营。有些规模很大，面向全球市场，而另一些规模较小，面向特定的区域需求。这意味着他们的安全姿态和技术知识水平也千差万别。

从理论上讲，ca 使用自动和手动控制来防止他们向不拥有或控制网站的人颁发证书，这些网站是为这些人申请证书的。但是这些年来，发生了许多这样的情况:CA 遭到黑客攻击，攻击者为知名网站获得欺诈性证书，或者 CA 员工无意中签发了欺诈性证书，或者攻击者发现并利用了他们的域所有权验证系统中的漏洞。

底线是，对于域名所有者来说，不能保证其他人在他们不知情的情况下不会为他们的网站获得有效的 SSL 证书。这种证书将使中间人攻击成为可能，在这种攻击中，能够拦截用户和 HTTPS 网站之间流量的攻击者可以即时解密流量，或者提供该网站的虚假版本。

## HTTP 公钥密码如何解决这个问题？

顾名思义，HPKP 允许网站所有者告诉浏览器记录下与网站证书相对应的公钥(pin ),并在特定时间段内的后续访问中只接受带有该密钥的证书。

这是一个有些简化的解释，因为公钥不一定是叶证书(网站的最终实体证书)的公钥，而是可以是网站证书链中任何证书的密钥。这包括叶证书所联系的任何中间 CA，或者根 CA——链中最顶端的链接。

这提供了更多的灵活性，例如，允许网站所有者告诉浏览器接受他们网站的任何有效证书，只要这些证书是由他们知道他们将在可预见的未来使用的特定证书颁发机构颁发的。

网站的 HPKP 策略和固定公钥是通过特殊的服务器响应头定义的。实际上，事情甚至更复杂，因为为了有效，HPKP 策略需要定义至少一个备份密钥，该密钥不对应于链中的任何证书。当主密钥过期或需要替换时，可以使用这个二级密钥来生成新的证书，此时还会生成新的备份密钥。

## 那么问题出在哪里？

“HPKP 的问题是，让你的头脑清醒过来可能是一个相当复杂的想法，需要完美的部署，否则事情可能会出错，”安全研究员 [Scott Helme](https://www.linkedin.com/in/scotthelme/?ppe=1) 在最近的[博客文章](https://scotthelme.co.uk/im-giving-up-on-hpkp/)中说，标题是“我放弃 HPKP”

最常见的问题之一是对应于固定公钥的秘密密钥可能被意外删除、泄露或丢失。在这种情况下，网站所有者可以用不同的密钥获得一个新的证书，但浏览器不会接受它，因此过去的访问者将无法访问该网站，直到 HPKP 策略到期，这可能是一段很长的时间。据赫尔姆称，这在安全专业人士中被称为 HPKP 自杀。

如果主证书过期，而所有者忘记使用备份密钥之一生成新证书，而是使用新密钥生成证书并将其添加到 HPKP 列表中，则访问者也将被锁定。这个[去年发生在 SmashingMagazine.com](https://www.smashingmagazine.com/be-afraid-of-public-key-pinning/)。

更糟糕的是，如果攻击者破坏服务器，他们可能会故意修改 HPKP 策略并添加他们控制的密钥，这样网站所有者只能在攻击者提供其密钥的情况下恢复对网站的访问。这在 2016 年 DEF CON 黑客大会上的一个演示文稿中进行了描述，可能会导致类似勒索软件的攻击。

赫尔姆并不是唯一对 HPKP 失望的人。[瑞安·斯利维](https://twitter.com/sleevi_)，谷歌的软件工程师，HPKP 标准的作者之一，[最近在推特上写道:“钉住是可怕的——正如我们所见，对生态系统的伤害大于帮助。标准化是一件坏事。”](https://twitter.com/sleevi_/status/900571558896435201)

当有人开玩笑地请他喝苏格兰威士忌来了解更多时，他回答说:“不需要苏格兰威士忌来让我为我的罪过和吸取的痛苦教训道歉。我现在积极劝阻，即使有生态系统风险。”

Qualys SSL 实验室前负责人 Ivan Ristic 是《防弹 SSL 和 TLS》一书的作者，他也在去年的一篇详细的博客文章中表达了他对 HPKP 的担忧，宣布它已经死亡。

“我认为，最终，HPKP 需要太多的努力，只有少数网站将部署它，”Ristic 说。“与此同时，以目前的形式，它可以成为对付任何人的有力武器。具有讽刺意味的是，HPKP 不会被很多网站使用(因为它太税了)，但它可以用来对抗数百万甚至不知道 HPKP 存在的小网站的长尾。”

## 好消息和坏消息

好消息是，HPKP 最近才被标准化，尽管在 2015 年，它只在谷歌 Chrome、Mozilla Firefox 和 Opera 中受支持，所以它还没有在网络上得到广泛采用。此外，虽然 HPKP 标准允许用户创建长期有效的 HPKP 策略，但 Chrome 和 Firefox 仅在 60 天内遵守观察到的 pin，以限制潜在错误的影响。

根据 Helme 最近进行的扫描，Alexa 排名前 100 万的网站中大约有 277，000 个目前使用 HTTPS，只有 3，500 个启用了 HPKP。然而，自 2 月份以来，在 Alexa 排名前 100 万的网站中，类似的扫描只检测到 500 个支持 HPKP 的网站，采用率出现了显著增长。

据 Helme 称，坏消息是，即使在目前使用 HPKP 的 3500 个网站中，也有大量部署不当的例子。

“不仅仅是一点点错误，完全错误，以至于浏览器不会接受这个政策，这也是一个好工作，因为这是唯一能拯救他们的东西，”他说。

底线是，除非你真的知道你在做什么，你准备好承诺仔细规划证书密钥轮换，你可能应该远离 HPKP；尤其是因为有其他机制可以部分解决同样的问题。

一个这样的机制是[证书透明性](https://www.certificate-transparency.org/)，这是一个越来越多地被认证机构采用的框架，它包括在公共日志中发布所有颁发的证书。这样可以更容易地审核证书，并快速识别任何错误颁发的证书。

另一个机制是一个名为[认证机构授权](https://tools.ietf.org/html/rfc6844) (CAA)的 DNS 记录，所有的认证机构都必须在今年晚些时候开始执行。域名所有者可以使用此 DNS 记录来指定允许哪些 ca 为其域名颁发证书。

[谷歌](https://cloud.google.com/kubernetes-engine)是新堆栈的赞助商。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>