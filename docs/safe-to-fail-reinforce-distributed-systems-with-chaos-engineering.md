# 安全失败:用混沌工程强化分布式系统

> 原文：<https://thenewstack.io/safe-to-fail-reinforce-distributed-systems-with-chaos-engineering/>

对 [Honeycomb.io](https://Honeycomb.io) 的首席开发人员 Liz Fong-Jones 来说，混沌工程是“如何对你的系统进行实验，以确定哪些地方的事情不一定符合你的期望。”

她在今年由混沌工程服务提供商 Gremlin 主办的 [ChaosConf](https://www.chaosconf.io/) 上发表了演讲，讲述了[可观测性](https://thenewstack.io/observability-a-3-year-retrospective/)——及其服务的目标[站点可靠性工程](https://thenewstack.io/the-evolution-of-the-site-reliability-engineer-sre/)——仍然是一个新兴的和不断发展的领域。[混沌工程](https://thenewstack.io/chaos-engineering-can-give-distributed-systems-stability/)——通常与大型企业有关——是初创公司寻找系统弱点、修复它们并再次测试它们的合理方法。正如你将在这篇文章中了解到的，混沌工程一点也不混乱。它包括测量您的系统，了解它们的弱点和阈值，然后系统地一次攻击一小部分。这一切都是为了让系统变得更强大。

投资于这种连续性是提高产品开发速度的关键。这包括专门致力于使有状态系统可靠和一致。

Fong-Jones 说，一致的和有状态的服务“是一些最可怕的东西，因为有一堆隐藏的依赖关系和假设可能会打破，并且更难用混沌工程技术进行测试。”

她说，当你有存储数据的服务时，情况会变得更加可怕。但她发现，混沌工程是蜂巢保持状态、稳定和健全的最佳解决方案之一。

## 混沌工程第一步:量化可靠性

任何时候，当你试图关闭你的系统时，你很可能会关闭你的系统。这意味着你需要知道在它打断你的工程师或你的客户之前，你能把他们推到什么程度。

Fong-Jones 解释说，“我们正在努力实现一定程度的可靠性，以满足客户的期望，同时还允许我们进行创新。”

您混乱的旅程从定义“可靠性”对您的系统意味着什么开始。理解什么是“足够好”，什么是“太差”，以及你如何衡量你的服务质量。

> “如果系统运行非常、非常可靠，并且超出了我们的可靠性目标，我们在什么时候需要花费时间和投入错误预算或我们允许的停机时间，以便探索潜在的故障案例？”— Liz Fong-Jones，Honeycomb.io

她指出，服务水平协议(SLA)是客户、产品经理和工程师之间的共同语言，它展示了客户试图实现的目标以及您如何衡量它。从这里开始，您可以将所有的规划映射到 SLA 中提出的目标级别。

Fong-Jones 说，你可以从测量一个数据点内部“可实现的”可靠性开始。对于蜂巢来说，这不是 100%的可靠性。

Fong-Jones 说，由于可观察性完全是关于客户的数据，蜂巢的关键指标是明确的。

“我们只有一次机会来存储传入的遥测数据，因此我们的客户一直在向我们抱怨数据，我们已经决定要接收 99.99%的事件，”她说。

此外，不到 0.1%的访问蜂巢主页的人会经历超过一秒的加载时间，该团队的目标是让任何类型的通用查询失败的时间少于百分之一。

Fong-Jones 表示，可靠性目标必须与客户期望直接挂钩。

## 混沌工程第二步:设计实验

工程是一门科学，混沌工程利用了我们在小学学到的科学方法:

1.  观察:这正在发生。
2.  作为一个问题:如果发生这种情况会怎样？
3.  创建一个假设:如果这种情况发生，那么这种情况就会发生。
4.  进行实验。
5.  多观察一些。
6.  做个决定。
7.  再试一次，直到得到想要的结果。

你的实验应该把所有这些步骤都考虑进去。

“我们设计实验来证明风险，以验证我们的假设，并验证我们使用的弹性技术将在生产中保持不变，”Fong-Jones 解释说。

然而，事情没那么简单。她将数据持久性视为成功存储的“非常、非常棘手”的事情，尤其是在一个有很多活动部件的系统中。

对于数据，Honeycomb 混合使用[卡夫卡](https://kafka.apache.org/intro)、[动物园管理员](https://zookeeper.apache.org/)和它自己开发的存储引擎 Retriever 来保存数据。该公司定期对其余系统进行更改，但他们对数据堆栈的更改不到一个月一次。

Fong-Jones 说:“这些变化非常、非常罕见，测试起来也困难得多，因为它们不是每天都进行的。”。

大约一年前，他们开始询问有关这些长期运行流程的问题，例如:

*   如果其中一个意外重启会怎么样？
*   即使重启正确，您如何验证数据的完整性和一致性？
*   如果一台机器重启会怎么样？
*   他们的[单点故障](https://thenewstack.io/cloudbees-devops-world-2020-points-the-way-to-accelerated-resiliency/)在哪里？

“剧透警告:我们发现了一些问题，但由于剩余的误差预算，我们能够进行生产实验，”她说。

该团队开始了一项实验，在一个环境中，一次只重启一个动物园管理员。然后他们观察变化。发生什么事了？稳态有什么变化吗？

## 混沌工程第三步:修复你发现的东西

这是你通过处理任何风险和解决你发现的任何问题来结束反馈循环的时候。然后再次进行实验。

一旦他们发现问题，他们就使用蜂窝供电的可观测性来调试它们。

> “可观察性真的让你能够理解你没有预料到的事情，这正是我们希望通过我们的混沌工程实验来验证的本质。”— Liz Fong-Jones，Honeycomb.io

他们意识到，当他们重启 Zookeeper 时，它会停止向任何内部客户发送警报五到十分钟。他们观察到，他们的流程依赖于领导者选举来运行这些蜂窝警报的一个副本。

Honeycomb 团队随后进行了另一项实验，以确保他们测量的一切——遥测——都运行正常。如果某些东西失败了，那么遥测技术应该同意它正在失败。

Fong-Jones 解释说，“否则，你的遥测技术可能会告诉我们一切都很好，而实际情况并非如此。”

## 混沌工程步骤 3 和 1:重复

所以你修好了什么就完事了，对吧？嗯，这种修复可能会引发其他问题。也可能根本没修好。混沌工程学要求你应该重复实验，以确保一切都按照预期的方式运行。

蜂巢工程师确保解决了他们的节点只与第一个 Zookeeper 实例对话的问题。但是当他们重新进行实验时，他们发现了另一个问题，这个问题也阻止了 Zookeeper 正常重启。这次一个队友推了一个坏掉的厨师。

重复实验是团队走向幸存中断的下一个阶段。

一旦你运行了几次实验，你就可以用一个类似 Gremlin 的[混沌即服务工具集来自动运行这个实验。或者您可以手动继续。](https://thenewstack.io/gremlins-tammy-butow-on-the-business-side-of-chaos-engineering/)

通过 Gremlin，Honeycomb 现在每周至少自动重启一个节点，以验证 Kafka 复制是否正常工作，以及他们的系统是否可以从单个 Kafka 节点故障中恢复。

Fong-Jones 说:“你进行的混沌工程越多，你就越有信心，你的系统将能够经受住像节点离开你这样的事情。”

此外，蜂巢团队通过混沌工程，发现了系统灵活性和省钱之间的直接关联。既然他们知道他们的节点可以在需要时重启，他们就可以采用[可抢占的实例](https://cloud.google.com/kubernetes-engine/docs/how-to/preemptible-vms)，Fong-Jones 说这可以节省一半的成本。此外，他们不需要对这些实例执行主动混沌工程，因为他们现在知道他们将如何执行。

## 混沌工程规则:这是白天的团队工作

科技文化现象的某些方面[渐进式交付](https://thenewstack.io/the-rise-of-progressive-delivery-for-systems-resilience/)让开发团队在非正常时间进行一些渐进式推广，以便影响较小或不太重要的客户群。混沌工程不在其中。

Fong-Jones 说，不要在周末进行你的混沌实验。“我们的想法是，虫子的眼睛比较浅，所以让我们确保所有人都在甲板上，让我们确保我们有能力尽快恢复实验。”

参与的人越多，就越容易找到系统缺陷背后的原因。也是为了把影响降到最低。更多的人帮助寻找漏洞，意味着更少的可怕后果。

“对我们来说，混沌工程的另一个关键是真正限制爆炸半径，开发一个我们认为会发生什么的假设，一次只重启一个服务器或服务，”Fong-Jones 说。

然后，Honeycomb 团队可以继续衡量他们的 SLA，看看他们是否有更多的错误预算，然后扩展他们的混沌工程，这反过来应该增加他们的系统弹性。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>