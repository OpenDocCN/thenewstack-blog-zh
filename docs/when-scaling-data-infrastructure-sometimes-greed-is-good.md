# 在扩展数据基础架构时，有时贪婪是好事

> 原文：<https://thenewstack.io/when-scaling-data-infrastructure-sometimes-greed-is-good/>

[](https://www.linkedin.com/in/glommer/?originalSubdomain=ca)

[Glauber Costa](https://www.linkedin.com/in/glommer/?originalSubdomain=ca)

[Glauber Costa 是 ScyllaDB 的现场工程副总裁。他在工程部门和帮助客户成功之间分享他的时间。在 ScyllaDB 之前，Glauber 在 Linux 内核的虚拟化领域工作了 10 年，贡献范围从 Xen 和 KVM 虚拟机管理程序到各种来宾功能和容器。](https://www.linkedin.com/in/glommer/?originalSubdomain=ca)

[](https://www.linkedin.com/in/glommer/?originalSubdomain=ca)[](https://www.linkedin.com/in/glommer/?originalSubdomain=ca)

关于最佳技术的争论从未真正解决。想想制表符和空格，emacs 和 vim。除此之外，我们现在还可以讨论扩展数据基础架构的最佳方式。您应该通过添加更多资源和扩展空间(横向扩展)来满足需求，还是在现有空间内提高性能(纵向扩展)？

在很长一段时间里，这甚至不是一个问题。默认情况下按比例放大。提高性能意味着增加内存、购买更大的 CPU 或插入更快、更高效的存储阵列。

1998 年，谷歌在廉价的商用服务器上运行迅速成为世界上最受欢迎的网络应用程序，从而改变了一切。如果需要扩展，只需将更多的服务器放入一个数据中心。当它的一个服务器停止工作时，谷歌的架构绕过损害，很像互联网本身。

与纵向扩展不同，这种横向扩展方法没有理论限制。在某些时候，你不能买一个更快的 CPU，但你总是可以添加另一个服务器。也许它不是绝对最好最快的。也许它没有被充分利用。但是当你需要的时候，它就在那里疏导交通。

与之相比，AltaVista 是最受欢迎的早期网络搜索引擎之一，被视为 DEC 64 位 Alpha 处理器的展示平台。今天它是互联网历史上的一个脚注。谷歌和它的横向扩展能力埋葬了它的纵向扩展的竞争对手。

其他发展使钟摆进一步向外扩展。1995 年引入的 Java 和容器(如 2001 年的 Linux VServer，以及 2013 年导致 Docker 的其他发展)使代码易于移植。谷歌、脸书和雅虎开源了他们的内部技术来整合计算资源。虚拟化模糊了服务器和软件之间的界限，而像 AWS、Azure 和 GCP 这样的公共云可以轻松地启动无限数量的虚拟机。

根据新的传统智慧，扩大规模是傻瓜的事。聪明、具有前瞻性思维的 IT 商店是一切都虚拟化、分布式和软件定义的商店，无论这是否有意义。微软的一组研究人员[观察到](https://www.microsoft.com/en-us/research/publication/nobody-ever-got-fired-for-buying-a-cluster/?from=http%3A%2F%2Fresearch.microsoft.com%2Fapps%2Fpubs%2Fdefault.aspx%3Fid%3D179615)“在当今世界，没有人会因为采用集群解决方案而被解雇。”2015 年，《哈佛商业评论》的一篇文章可能会[提出问题](https://hbr.org/2015/06/does-hardware-even-matter-anymore)，“硬件还重要吗？”

钟摆的特点是:它们会摆回来。云时代已经过去十多年了，横向扩展带来的额外成本、权衡和危险正变得难以忽视，而新技术也让纵向扩展策略变得更加可行。横向扩展不会有任何进展，但所有迹象都表明，纵向扩展即将卷土重来。

## 表演

横向扩展体系结构最明显的缺点是性能。根据定义，与使用商用硬件进行横向扩展相比，使用高性能硬件进行纵向扩展可以提供更好的逐服务器性能。特定于操作系统的软件在利用可用资源方面变得更加有效。早在 21 世纪初，利用多个 CPU 内核的工具还处于起步阶段，因此只有技术最成熟的组织才能充分利用最新、最强大的硬件。对大多数人来说，更简单的方法是启动另一台服务器。但是，充分利用多核处理器、NUMA 架构、超线程和多线程的基础设施已经有了很大的改进，在这一点上，纵向扩展提供了明显优于横向扩展的性能优势。

> "人们常常只是接受他们的大规模横向部署所带来的痛苦和折磨."

类似地，在走向商品化的过程中，Java 被提出来作为可移植的随处运行部署的解决方案。然而，事实证明，Java 远非它所宣称的最佳可移植性和终极灵丹妙药。虽然它使部署代码变得更加容易，但也成为了性能的瓶颈。对于要求苛刻的应用程序，在 Java 虚拟机上运行被证明是一种积极的责任。对于数据库来说，这意味着更低的速度、不可预测的延迟峰值(例如由于可怕的垃圾收集)以及对扩展范围的限制。超过某一点，JVM 的限制就变成了应用程序的限制。Opera 的开发人员发现了这一点，他们试图使用 Cassandra 及其基于 Java 的代码来保持数百万个浏览器的同步。无论他们向外扩展了多少个集群，都无法防止进程丢失和不断出现垃圾收集问题。

寓意:向外扩展在增加新资源方面可能很棒，但是如果资源没有按照您需要的方式运行，它对您没有任何好处。

## 管理

反对横向扩展的一个更严重的理由是管理负担。向外扩展意味着增加需要管理的实体的数量。如果你把一个集群想象成一个旋转的盘子，而维护就是你保持盘子旋转的方式，很明显，你在空中的东西越多，就越有可能掉下来。即使使用多复制和全局分布等技术，丢失节点也是痛苦的。

撞车会致命吗？大概不会。横向扩展体系结构专为故障设计。这并不意味着成本为零。当盘子掉下来的时候，地板上仍然有很多陶瓷。用另一个比喻来说，构建一个横向扩展的架构就像是报名参加一个持续的低烧。你并不是完全卧床不起，穷困潦倒，但是每天都充满了头痛和痛苦。由于要管理数百甚至数千个节点，概率法则意味着群集中的某些设备正在接近或已经超过其 MTTF。或者是垃圾收集导致了一个节点停止(再次)。正如最初的 Cassandra 白皮书本身所解释的，“处理由数千个组件组成的基础设施中的故障是我们的标准操作模式；在任何给定时间，总会有少量但数量可观的服务器和网络组件出现故障。因此，软件系统需要以一种将失败视为常态而非例外的方式来构建。”

虽然这其中有一些核心智慧——故障可以随机建模和构建以解决——但在实践中，人们往往只是接受他们的大规模横向部署所带来的痛苦，即使他们的系统“温度”继续上升到危险水平。节点反弹。失败的恢复。不得不不断调整和扑救。

## 安全性

这才是真正的大开眼界。向外扩展意味着增加您的攻击面，这为坏人创造了更多的机会。需要监控的节点越多，就越难防御。那只是直觉。

但是，向外扩展会产生更多的潜在安全问题，我们现在才开始意识到这一点。由于英特尔 CPU 架构的缺陷，数千万处理器容易受到 Meltdown、Spectre 和 Zombieload 等所谓的“侧通道”攻击。这些漏洞允许流氓进程使用 CPU 中的一种窥视孔来窥探其他进程。好的软件设计没有帮助。缺陷在硬件本身，所以任何共享架构都是易受攻击的。容器、虚拟机和多租户软件设计掩盖了这个问题，但并没有消除它。事实上，许多横向扩展服务器都是高密度节点(32 个 CPU 及以上)。只有通过云部署和虚拟化，您才可能意识不到您是在一个大型共享集群上，这使您容易受到您甚至不知道自己拥有的邻居的攻击。

防范旁路利用的最佳方法是在裸机服务器上运行单租户进程，从而最大限度地减少与吵闹的(可能是爱管闲事的)邻居的接触。问题是，公共云提供商鼓励多租户以充分利用每台服务器。许多关键应用程序现在也设计为横向扩展而不是纵向扩展，因此在大型裸机上运行几乎没有什么好处。更糟糕的是，任何用 Java 编写的应用程序将只使用服务器全部资源的一小部分，这又为服务器虚拟化创造了另一个吸收这些额外资源的动机。

因此，你有易受攻击的硬件、未优化的应用程序和云提供商，他们希望将尽可能多的用户打包到他们的服务器上，换句话说，这是旁路攻击的完美条件。

这个问题不会消失。新一代 CPU 可能会阻止最新的漏洞，但共享架构总是容易受到新漏洞的攻击。为了保护自己，默认情况下，组织将不得不停止横向扩展，这反过来将使“贪婪”的应用程序更具吸引力，因为它们能够利用每一盎司的可用计算。

## 结果是

明确地说，横向扩展很受欢迎，这是有充分理由的，但纵向扩展也将继续存在。核心数量只会随着时间的推移而增加。用户不应将其大数据架构强加于任何无法充分利用原始处理能力和高密度节点容量的系统。通过拥有更少、更密集的节点，您还可以最大限度地减少受攻击面并降低管理成本。如果从这些大机器中获得每一盎司的生产力对您来说都很重要，请停下来考虑虚拟化是否是对这些密集节点进行的正确操作。

真正的要点是:你不应该非要选择一个或另一个。那是傻瓜的选择。您今天部署的数据架构应该能够纵向扩展*和横向扩展*。纵向扩展以获得您部署的每个机箱的最高效率和性能，横向扩展则通过部署您需要的任意数量的机箱来实现。如果在当今时代，您选择的技术迫使您只能做其中一项，而不能同时支持这两项，那么是时候寻找新的数据基础架构了。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>