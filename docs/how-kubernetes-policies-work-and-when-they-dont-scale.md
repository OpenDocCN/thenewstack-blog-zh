# Kubernetes 策略如何工作(以及何时不可伸缩)

> 原文：<https://thenewstack.io/how-kubernetes-policies-work-and-when-they-dont-scale/>

Kubernetes 是一个在集群中管理和编排容器化应用程序的系统。

在这样的架构中有许多动态移动的部分。为了帮助您保持对它们的关注，Kubernetes 使用了“策略”的概念

在这篇文章中，我将解释 Kubernetes 策略是什么，以及它们如何帮助您管理和保护您的集群。我还讨论了它们的局限性，以及它们在某些情况下难以大规模使用的原因。

## Kubernetes 政策基础

Kubernetes 中策略的目的很简单:它们定义应该在集群中应用的设置。这并不意味着它们是一揽子政策；相反，Kubernetes 策略可以通过多种方式进行配置。例如，你可以告诉他们让 Kubernetes 对不同类型的用户做不同的事情。

但是从高层次来看，Kubernetes 策略用于创建和实施集群范围的设置。

目前，Kubernetes 策略可以用来管理几个不同的领域。网络、资源消耗以及身份和访问管理是主要的问题。

## Kubernetes 网络政策

 [曾佩琪

Daisy Tsang 是 Twistlock 的客座博主，也是一名软件开发人员，目前居住在柏林。在过去的几年里，她在加拿大和德国的公司工作，喜欢学习新技术，尤其对开源空间感兴趣。](https://infoverload.github.io/) 

在较低的层面上，Kubernetes 有网络策略，这是一种在 pod 层管理流量并控制进出 pod 的流量的结构。名称空间有助于组织资源，但不提供隔离。

默认情况下，每个单元都可以与其他单元连接，并且每个服务都允许所有流量。这就是网络策略发挥作用的地方。网络策略指定选择的 pod 如何相互通信以及如何与其他网络端点通信。它由一个 pod 选择器(指示它适用于哪些 pod)、一个入口规则列表(指示允许哪些入站流量)和一个出口规则列表(指示允许哪些出站流量)定义。网络策略资源使用标签来选择 pod，然后定义一个规则列表来确定哪种类型的流量可以到达所选的 pod。

## Kubernetes 资源配额

还有资源消耗的政策。这些工具可以解决关于共享集群中资源消耗的问题。资源配额可以约束每个命名空间的资源消耗，并限制可以按类型创建的对象数量以及每个项目中可以消耗多少计算能力(即 CPU、内存)。

还可以对给定命名空间中请求的存储资源数量设置限制。为了实现这一点，为每个名称空间创建一个 ResourceQuota 对象，系统将跟踪每个名称空间中的使用情况，以确保它遵守 ResourceQuota 对象中定义的规则。对于许多 Kubernetes 发行版来说，这种支持是默认启用的——请注意，这些配额与集群容量无关(也就是说，如果您分配的配额多于您拥有的资源，即使没有达到配额限制，也可能会耗尽容量)。

## Kubernetes 安全策略

最重要的是理解 Kubernetes 中的安全策略是如何工作的。这主要涉及身份验证(验证用户的身份)和授权(指定允许他们做什么)。

在 Kubernetes 中有多种授予权限的方式，称为授权者。其中包括节点授权、基于属性的访问控制、webhook 和基于角色的访问控制(RBAC)。RBAC 是 Kubernetes 中的标准授权模式，允许细粒度的权限，这些权限被表示为规则(动词、资源和资源名称的组合)。例如，“缩放者”角色可能有权“更新”特定命名空间中的部署，以便更改其副本数量。

还有 pod 安全策略，它允许对 Pod 的创建和更新进行细粒度授权。它们通常还用于防止容器以根用户或特权模式运行。它是一个准入控制器，这意味着它有能力在面向授权的部分发生之后添加一些东西。PodSecurityPolicy 对象定义了一组条件，pod 必须遵守这些条件才能被系统接受。

有[种不同的方法来保护您的堆栈](https://www.twistlock.com/2019/03/14/kubernetes-auditsink-real-time-k8s-audits-forensics/)的不同部分。您可以围绕将哪些容器映像放入生产环境来设置策略，并管理如何对已经在生产环境中运行的内容设置策略。没有一种单一的技术为如何做到这一点设定了标准，许多东西都存在于注册表和 CI/CD 管道中，因此您可能还需要考虑 Kubernetes 之外的策略。

## Kubernetes 政策的局限性

Kubernetes 的政策并非没有一些挫折。我们将讨论在大规模应用它们时会有什么样的复杂性。

首先，在 Kubernetes 上编排您的容器化应用程序不是一件小事。有许多动态变化的部分，因此很难获得全面的安全解决方案。将事情设置成让你的用户被限制做他们被允许做的事情是很棘手的。

例如，特定用户可以做什么将由他们的身份、他们所属的组、他们可以对各种 Kubernetes 资源(pod、部署、服务等)执行的操作、适用于他们创建的对象的网络和 pod 安全策略等来定义。因此，枚举特定用户的权限及其范围是很重要的，并且每次更新这些组件中的一个时，都必须为每个用户重新执行该任务。

此外，Kubernetes 目前的政策组成部分都处于不同的成熟程度。有些策略在每个组件中都是可扩展的，而有些则不是。每个项目用来表达意图的语言也各不相同。整个 Kubernetes 领域尚未达成共识。希望有一天会实现，但是现在，这种不成熟是 Kubernetes 政策的另一个主要限制。

## 当前状态

为了解决这些问题，一个[政策工作组](https://github.com/kubernetes/community/tree/master/wg-policy)已经成立，旨在提供 Kubernetes 政策的总体观点。Kubernetes 被分成不同主题的特殊兴趣小组。一个工作组跨越 SIG，一个策略工作组将跨越 SIG 架构组。目的是描述当前的政策实施以及未来的建议。

目前，要实现可扩展的策略策略，您可以依赖命名空间。您可以根据名称空间进行推理，而不是授予对单个 pod 或服务的访问权限。名称空间是一种允许容器拥有自己的 IP 地址和路由表的功能。创建容器时，会为容器创建一个网络名称空间，它可以在容器之间共享。

[Open Policy Agent](https://www.openpolicyagent.org/) 也是一个有趣的项目，它使 Kubernetes 管理员能够对他们的堆栈进行细粒度的基于策略的控制。

## 结论

Kubernetes 策略是影响安全性的非常强大和有用的特性，但是仍然存在挑战。由于部署具有如此多移动部件的应用程序的复杂性，伸缩策略并非没有问题。有许多东西需要保护，每一样都有不同的方式，而且很容易忽略一些东西。所以我们需要清单，它们往往很长。我们还需要考虑组织文化，并确保将正确的权限授予正确的人，我们还需要一个系统来轻松撤销这些权限。

目前，有一些有用的社区可以解决政策和新兴项目方面的问题，也有一些私营企业解决方案可以改善大规模的政策实施。在 Twitter 上关注某些有安全意识的公司也很有帮助。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>