# 对于我的下一个技巧，我将制作一个服务网格...消失！

> 原文：<https://thenewstack.io/for-my-next-trick-ill-make-a-service-mesh-disappear/>

[](https://www.linkedin.com/in/petercmccarron/)

 [彼得·麦卡隆

彼得是位于加州三藩市的哈希公司的高级产品营销经理。如果他没有研究发现和管理微服务的最佳方式或谈论基于云的网络，你可能会发现他在户外发现了真正的云。](https://www.linkedin.com/in/petercmccarron/) [](https://www.linkedin.com/in/petercmccarron/)

对于这篇文章，我将尽我最大的大卫·科波菲尔的影响——不，我不会让服务网格的需求消失，就像那位著名的魔术师曾经对自由女神像做的那样。但是，就像那个幻觉一样，我们会从不同的角度看待事物。

如果你和我一样是《美国生活》的粉丝，你可能听过这一集，大卫·克斯滕鲍姆讲述了他对这个特殊魔术的着迷，以及它是如何让他自己尝试魔术的。在那一集里，他们谈了一点这个把戏实际上是如何完成的(剧透:自由女神像实际上并没有消失)。相反，他们使用了旋转平台、巧妙的拍摄角度和现场观众(是的，他们也参与其中)。

现在，如果你还和我在一起，你可能会想，“谢谢你破坏了我的好奇心，但是这和服务网格有什么关系？”这是我在这里尝试进行的比较——我们需要将同样的误导和方法应用到我们如何将服务网格与现有工作流相结合。它永远不会真正消失，但我们只是从不同的角度看待事物。就像那些观众一样，我们都是其中一员。

所以，事不宜迟，让我们让服务网消失吧！

> 服务网格不应该是“你做的事情”原因是:期望应用程序开发人员除了他们管理的其他事情之外，还是服务网格方面的专家是不公平的。

## 云基础架构供应和自动化

如果我不是将服务网格视为部署到现有环境中的东西，而是将其编织到核心基础架构供应工作流中，以首先构建网络，会怎么样？

让我们从一个普遍认同的熟悉前提开始，越来越多的公司希望跨云提供商和内部实现基础架构配置的自动化和标准化。我们看到的 HashiCorp Terraform 的大量下载——每月超过 100 万次——证明了这一点。

Terraform 可能是应用最广泛的基础设施供应工具。it 提供的最基本的单元是云基础设施，但是(许多 Terraform 用户可能会告诉你)Terraform 用于一切。

*作为免责声明，我将使用 HashiCorp 工具来阐述我在本文中的观点，但我完全理解这些概念仍然适用于您和您的组织正在使用的其他解决方案。请记住，这都是关于工作流程和我们试图解决的结果。*

在 [Terraform Registry](https://registry.terraform.io) ，你会发现一个提供商(基本上是集成和插件)，社区或官方，几乎任何技术。原因是，故事不会在我调配基础架构时就结束。我有其他的技术和工具，我想把它们结合起来，使开发团队可以使用这个环境。Terraform 文件将变得越来越复杂，由多个提供者和模块组成，以构建代码中定义的更健壮的架构。

那么，这如何应用于服务网格呢？

[hashi corp consult](https://www.consul.io/)是一款服务网格工具，可在云和本地环境中的应用程序之间提供服务发现和安全连接(还有其他服务网格解决方案可以通过基础设施作为代码提供，但我想为您提供具体的示例)。从 Terraform 的角度来看，我可以使用[hashi corp consult provider](https://learn.hashicorp.com/tutorials/cloud/terraform-hcp-consul-provider)或 [Helm provider 将 consult](https://learn.hashicorp.com/tutorials/terraform/helm-provider?in=terraform/kubernetes)部署到我新创建的基础架构中，突然间，我有了一种可重复和可复制的方式来配置部署了服务网格的新基础架构。

我的操作员不必学习新的工作流程。事实上，我仍在以同样的方式调配基础架构，但只是在某种程度上“旋转了平台”,这样我们就有了我们想要的最终视图。现在，虽然这掩盖了构建这些解决方案的复杂性，但投资构建时间一次，通过自动化为我赢得了未来的价值。接下来，我将解释谁应该负责管理复杂性。

## 零信任安全

当讨论服务网格时，您会经常听到它如何提高应用层的安全性。但是，如果你向安全团队询问服务网格，他们可能不会表现出太大的兴趣。服务网格通常被认为是一种开发工具，但是正如我们在基础设施部分所讨论的，我们也可以将服务网格集成到安全工作流中。这种说法已经成为对话的一部分，你可能听说过它被称为[](https://www.hashicorp.com/solutions/zero-trust-security)*。*

 *总的前提是，我需要计划拥有不同的身份驱动控件。这些控制措施包括:

*   人工访问和授权
*   机器访问和授权
*   机器对机器访问
*   人对机器的访问

对于人机认证和授权，SSO 产品(Okta、Ping、Auth0 等。)和像 [HashiCorp Vault](https://www.vaultproject.io/) 这样的工具在保护这些工作流方面非常出色。Vault 不会将轮换机器用于访问其他服务的重要凭据(例如，数据库密码、证书或访问令牌)的责任委托给用户，而是会自动执行此过程。此外，Vault 采用“不信任优先”的方法来提供机密和对各种实体的访问。Vault 和类似工具的兴起受到了市场的关注，被定义为“秘密管理”， [CNCF 最近发布了这一类别的新雷达](https://radar.cncf.io/2021-02-secrets-management)，显示出从依赖用户管理凭证到自动化工具的普遍转变。

身份验证和授权是为了保护终端——身份代理和秘密管理非常适合这一点——但这并不是真正的零信任，对吗？[零信任网络](https://www.hashicorp.com/resources/how-zero-trust-networking)意味着我们还会关注身份验证发生时会发生什么，并保护应用程序之间交换的实际通信数据。

### 通过服务网格实现真正的零信任

有些人可能会说这太夸张了，但是威胁可能来自任何地方。看看 Canva、 [Marriott](https://news.marriott.com/news/2020/03/31/marriott-international-notifies-guests-of-property-system-incident) 或 Auth0 的 2020 年 11 大数据泄露事件中的任何其他公司最近遭受的黑客攻击就知道了。在每一种情况下，这些违规行为都是由泄露的凭据和不良行为者获取网络访问权限造成的。

当服务网格配置有零信任网络模式时，默认情况下，新注册服务的所有网络通信都会被拒绝，直到以证书或 ACL 令牌的形式给出授权。实施这种策略有助于防止这些违规行为，因为它可以确保即使攻击者获得了网络访问权，他们也无法获得访问其他应用程序的必要权限。

如果你要创建一个真正的零信任环境，服务网格将帮助你实现，但它需要感觉像一个秘密，工作流的配角，而不是表演的明星。

在我提到的工具的上下文中，如果我利用 Vault 作为我的可信身份源和根证书颁发机构，我如何在我的不同应用程序之间分发和轮换这些证书？与 Consul 这样的工具配合，我可以[从保险库](https://learn.hashicorp.com/tutorials/consul/vault-pki-consul-secure-tls)生成和检索中间证书或者[创建访问控制令牌](https://learn.hashicorp.com/tutorials/consul/vault-consul-secrets?in=consul/vault-secure)，在一个工作流中同时用于认证和[保护与 mTLS](https://learn.hashicorp.com/tutorials/consul/service-mesh-application-secure-networking?in=consul/gs-consul-service-mesh) 的通信。

这再次掩盖了复杂性，但我的想法是，我将服务网格视为我的安全策略的一部分，并试图实现加密和可信通信的结果。

## 应用交付

也许采用服务网格的最大动机是它可以将您的网络安全、服务发现和渐进式交付实践(例如蓝/绿&金丝雀部署)转变为开发人员的自助服务界面。我同意 Forrester 的 David Mooter 的观点，即“[服务网格应该从应用程序开发人员的视线中消失](https://www.cdotrends.com/story/15316/why-service-mesh-should-fade-out-sight)”，我在这里讨论的许多主题都基于他的文章。

总的想法是，服务网格不应该是“你做的事情”原因是:期望应用程序开发人员除了他们管理的其他事情之外，还是服务网格方面的专家是不公平的。仅仅因为一些开发人员了解如何管理 Kubernetes 或 HashiCorp Nomad，并不意味着他们对服务网格有隐含的理解。

那么，我们如何让开发人员可以使用服务网格，而不强迫他们成为 it 专家呢？我们是这样做的——让网格成为交付过程的一部分。

我认为这里的关键是识别应用程序团队使用的编排方法。一旦你这样做了，典型的问题就是将网格和环境一起部署，并编写必要的脚本添加到部署文件中。从表面上看，将应用程序添加到服务网格实际上只是几行代码。这可以是 Kubernetes 清单中的几个注释，也可以是游牧作业中的额外资源块。

```
```
 service  {
 name  =  "count-dashboard"
 port  =  "9002"

 connect  {
 sidecar_service  {
 proxy  {
 upstreams  {
 destination_name  =  "count-api"
 local_bind_port  =  8080
 }
 }
 }
 }
 }
```

```

*领事边车代理通过服务模块*被添加到游牧作业的示例

实际的艰苦工作是交付之前的事情。前面，我建议您在环境中提供服务网格。如果您使用 [Terraform 通过 Consul](https://youtu.be/d9NTBb6zByE) 部署 Kubernetes 集群，那么实际上应用工程师需要做的就是确保已经添加了正确的配置。然后，流程保持不变，如果他们正在处理共享的 repo，那么不管代码发生什么变化，清单都是一致的。

不要期望开发人员在运行他们的应用程序之前建立服务网格，只需要标准化实践并确保环境为他们准备好。

## 结论:谁是魔术师？

所以在这个消失的隐喻中，谁是魔术师？没有大卫·科波菲尔设计和编排的幻觉，自由女神像的把戏就不会发生。服务网格也是如此。

> 在应用程序开发人员的眼中，服务网格应该淡出人们的视线。

我已经谈到了不同的工作流，以及服务网格如何成为它们的一部分，但重要的是要记住，有人需要成为专家。需要有人熟悉这些概念，可以帮助增强这些工作流，并进行必要的更改。我们在采用服务网格中看到的最大挑战是缺乏实现该工具的技能或资源。如果你看看今天的企业网络，它们只是在某种程度上工作——开发人员、基础设施和安全团队将实际的网络配置留给网络团队。当谈到服务网格时，也有类似的期望，但是拥有团队的身份不一定由传统的组织结构定义。

让一个专家(或专家团队)以与他们所支持的团队不断发展的工作流相一致的方式来实现网格，是成功部署服务网格的关键。组织在制定计划时应该考虑这一点，但是要确保这个人或团队是这些讨论的一部分。就像没有设备、摄像机和观众的帮助，自由女神像不会“消失”，没有所有团队的合作，服务网络也不会消失。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>*