# Kubernetes 秘密管理:3 种方法，9 种最佳实践

> 原文：<https://thenewstack.io/kubernetes-secrets-management-3-approaches-9-best-practices/>

用户名、密码、API 令牌和 TLS 证书等机密信息包含可用于认证和授权用户、组或实体的机密数据。顾名思义，秘密不是要让别人知道或看到的。那么我们如何保证他们的安全呢？

保守秘密的关键在于你管理它们的方式。在将应用或微服务迁移到 Kubernetes 时，开发人员必须在设计初期就做出选择，比如在哪里存储机密、如何检索机密以及如何在应用中提供机密。这种设计选择的一部分是确保秘密可以变得可用，而不损害应用程序的安全状态。

在本文中，我将提供在 Kubernetes 中管理秘密的方法和推荐的最佳实践。

## 如何在 Kubernetes 中进行秘密管理

先说一些方法。以下是我为 Kubernetes 秘密管理推荐的三种方法。

### etcd

在 Kubernetes 中，etcd 是一个受支持的数据存储，许多开发人员选择将机密以 Base64 编码的格式存储在 etcd 中，作为一个键值对。存储在 etcd 中的秘密可以作为环境变量从 Kubernetes 部署规范中获得，它存储在内存中，使秘密更难提取。秘密也可以作为卷挂载从容器内部获得，但是因为卷挂载将秘密存储在容器文件系统上，所以与环境变量相比，从容器文件系统中提取秘密更容易。如果你担心灵活性和安全性，那么你会很高兴听到 etcd 访问是通过 Kubernetes 基于角色的访问控制(RBAC)来控制的。

通过强并发原语、API 和可线性化读取，可以使用 etcd 大规模管理机密。然而，这也有缺点:秘密以明文(Base64 编码)存储、检索和发送。我强烈建议不要用明文存储机密，因为这意味着任何人或任何机器都可以在你不知道的情况下轻易地读取你的机密数据。这个问题可以通过[配置 etcd 使用 TLS](https://link.tigera.io/ue5xp) 加密传输中或静态的数据来解决。

请注意，对 etcd 的访问是未经审计的，这意味着任何有权访问它的人都可以访问所有机密。存储在 etcd 中的机密也没有版本控制，也不可恢复。对于那些需要大规模组织机密管理的人来说，etcd 可能不是正确的选择，因为它是一个 Kubernetes 数据存储库。

### 秘密管理服务

大多数公共云提供商提供秘密管理服务。一些最受欢迎的秘密管理服务包括 Google Secret Manager、Azure Key Vault 和 AWS Secrets Manager。

HashiCorp 保险库是另一个选择，因为它提供密钥管理、加密、轮换、公钥基础设施 **(** PKI)和其他基本服务。作为一个集中的机密管理器，Vault 可以与云提供商的机密管理服务一起使用。借助 Vault，操作员可以避免处理明文密钥，因为当 Vault 初始化时，初始密钥可以加密并存储在云密钥管理服务(KMS)中。

### 容器存储接口驱动程序

容器存储接口(CSI)驱动程序是一个秘密存储，自

Kubernetes 的 1.13 版本。CSI 驱动程序通过 CSI 将外部秘密存储(如 Azure、AWS、GCP 和 HashiCorp 的 Vault)合并到 Kubernetes 中。

通过卷属性对 secret store 服务进行身份验证，并将必要的机密装入 pod，CSI 驱动程序方法避免了使用 Kubernetes etcd 数据存储。这使您可以有效地管理您的秘密，并根据需要进行扩展。

## Kubernetes 机密管理的最佳实践

### 避免秘密蔓延

当应用程序机密存储在不同的位置时，例如在配置文件、git 存储库和 YAML 中，就会出现机密蔓延。机密蔓延意味着没有机密管理工作流。

通过实施集中式机密管理来降低机密蔓延的风险。设置一个位置，在这里可以安全地存储和从单点检索凭据，并通过适当的授权、监控和日志记录机制供整个组织使用。

### 加密传输中的数据和静态数据

默认情况下，Kubernetes 不会安全地存储或传输机密。因此，拥有一个使用端到端 TLS 加密对传输中的机密进行加密的结构以及一个以加密形式存储机密的解决方案至关重要。

### 使用自动秘密轮换

组织通常会针对不同的机密制定不同的轮换计划，以控制在遭受攻击时的暴露程度。云机密管理服务和外部解决方案通常能够提供自动机密轮换，因此您的机密可以根据数据敏感度每小时轮换一次。

### 有审计日志

了解你的秘密活动是个好主意。在发生违规事件时，审计日志会提供可见性并帮助您评估事件，包括是否是故意的、受影响的区域和其他调查步骤。

### 实施反关联性规则

您的机密管理解决方案应该是有限数量的指定虚拟机或主机上的单个进程。如果在 Kubernetes 上作为微服务运行，这个过程将在一个专用的 pod 中运行。要指定 pod 应该在哪些节点上运行，您可以实施反关联性规则来控制 pod 在设置为运行机密管理解决方案的节点上的分布。

### 利用动态秘密

动态秘密是根据需要生成的短暂秘密，具有有限的寿命。即使攻击者通过泄漏的应用程序代码或调试日志等手段获取了机密，该机密也会在短时间内被更改，从而限制了暴露并保护了应用程序。动态秘密还可以更容易地确定攻击者发现秘密的时间范围，并加速调查。

### 使用自定义证书颁发机构

作为深度防御方法的一部分，自定义证书颁发机构(CA)可用于实施端到端 TLS。组织可以选择使用他们自己的 CA 签署他们的证书，这意味着必须提供组织签署的证书才能访问服务。

### 在容器内存中存储秘密

在内存中存储秘密将使攻击者在入侵时更难找到秘密。每当容器化的应用程序接收到一个秘密时，它应该存储在内存中，而不是存储在磁盘或主机中的可用卷中。

### 保护零号机密

许多秘密管理解决方案经常采用信封加密，其中数据加密密钥(dek)由密钥加密密钥(KEK)保护。在这里，KEK 被认为是零秘密，终极万能钥匙。如果 KEK 遭到破坏，攻击者可以解密 DEK，从而解密由 DEK 加密的数据。

为了保护 secret zero，请将您选择的云服务提供商的身份和访问管理框架(IAM)与密钥管理服务器(KMS)结合使用。请注意，IAM 和 KMS 在信任链中都有自己的秘密零，这也应该被视为敏感数据。

## 摘要

当涉及到保护敏感数据时，最有效的方法是坚持零信任模型，假设妥协，并采取措施来降低风险。

我在本文中推荐的方法和最佳实践为秘密管理奠定了基础。对于那些有兴趣更全面了解的人，我推荐阅读我合著的电子书《 [Kubernetes 安全性和可观察性:保护容器和云原生应用的整体方法](https://link.tigera.io/ueMes)》的第三章。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>