# 基于痕迹的测试:可观察性的下一步

> 原文：<https://thenewstack.io/trace-based-testing-the-next-step-in-observability/>

对于软件工程师来说，可观察性是云原生技术的关键组成部分之一。事实上，[云原生计算基金会章程](https://github.com/cncf/foundation/blob/main/charter.md)指出，云原生技术“支持弹性、可管理和可观察的松散耦合系统。”但是为什么仅仅停留在观察系统行为呢？

 [肯·哈姆里克

Ken 已经做了 35 年的开发人员，并创办了多家科技初创公司，包括 CrossBrowserTesting.com，该公司被 SmartBear 收购，并加入了其强大的测试组合，以及最近的 Tracetest，这是一个开源项目，允许用户通过 OpenTelemetry Traces 创建深度集成测试。不发展时，肯喜欢钓鱼和在他的船上消磨时间。](https://www.linkedin.com/in/ken-hamric-016b1420/) 

现代微服务和分布式架构非常复杂。单个流中可能涉及数百个服务。应用程序可以用多种语言编写，并且可能链接到许多后端数据存储。除此之外，还有多个团队在开发不同的应用程序，这些团队经常跨越各大洲。在这些固有的困难架构中，发现问题的根源尤其具有挑战性。

这就是为什么支持分布式跟踪的可观察性工具近年来变得如此重要——使工程师能够理解服务流并构建系统行为和性能的图像。这些信息对于集成测试来说非常理想。如果您正在编写的测试可以访问一个告诉您确切发生了什么以及什么时候发生的跟踪，那么您可以通过利用这些数据来减少构建集成测试的大量工作。

基于跟踪的测试是可观察性的下一步。这种方法使您能够通过观察系统行为，准确地指定您想要测试的事务以及应该得到的结果。基本上，您可以验证组件之间的依赖关系，这在您将代码推向生产时通常会看到。您可以主动测试潜在问题，而不是匆忙修复故障。

## 基于跟踪的测试是如何开始的？

十多年前的 2010 年，谷歌发布了:“ [Dapper，一个大规模分布式系统追踪基础设施](https://research.google/pubs/pub36356/)”现代的追踪系统，如 OpenTelemetry Tracing，可以精确地追踪它们的来源。如果你想了解更多的背景，我们最近[写了关于 OpenTelemetry tracing](https://kubeshop.io/blog/tracing-the-history-of-distributed-tracing-opentelemetry) 的历史。谷歌在发布之前在内部使用了该项目两年，并报告说“Dapper 最重要的成功衡量标准是它对开发人员和运营团队的有用性。

 *除了非常有用之外，谷歌团队还意识到 Dapper 在[跟踪中捕获的数据可以用于测试](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36356.pdf)——事实上，基于跟踪的测试的第一次使用记录是在谷歌的广告审查服务上。

“新代码发布会通过一个简洁的跟踪 QA 流程，该流程会验证正确的系统行为和性能。在这个过程中发现了许多问题，包括广告审查代码本身和支持库，”它说。

## 为什么基于痕迹的测试很重要？

就像谷歌团队报告的那样，理解系统行为是非常宝贵的。这意味着你可以积极主动，而不是不断地对可以预测的问题做出反应。

早在 2018 年，Lightstep 的 Ted Young 就在 kube con+CloudNativeCon North America 发表了演讲“[跟踪驱动开发](https://www.youtube.com/watch?v=NU-fTr-udZg)”。这是对基于跟踪的测试背后的概念及其重要性的最好解释之一。在这个精彩的演示中，我强烈推荐观看，Young 解释了低效的测试方法是如何将我们引向一些质量相当差的代码的:

“我认为我们开始合并我们的开发实践和监控实践是非常重要的。现在，我们开发代码，我们有所有的工具用来开发代码，然后我们把它投入生产。然后，我们希望看到它在生产中的表现，我们使用一个完全不同的工具链来做到这一点，我们不在开发中测试该工具链。我们在开发中没有利用工具链，多年来我发现这意味着工具链有很高的可变性和质量。”

他提出了一个直接而重要的问题:为什么我们的开发和测试实践与我们的监控实践相分离？如果我们投入时间和精力来编写和测试我们的代码，应该在监控过程中利用它来关闭反馈回路，并确保 360 度的可观察性。

## 数据驱动的软件开发

事实上，基于跟踪的测试归结为数据驱动的开发——使用跟踪中固有的数据来创建测试和定义断言，从而通过可重复的测试来验证正确的系统操作。

“我们可以开始应用数据科学来观察我们的软件，不仅仅是制作漂亮的图表，而是实际编写断言，创建假设并测试它们，”杨在他的演讲中说。

“我们一直在谈论跟踪数据，就像跟踪数据是特殊的东西一样，但实际上跟踪数据只是数据。跟踪驱动的开发实际上只是数据驱动的开发。没有理由不采取我们通常用来测试代码中逻辑执行的测试方式，并针对我们在生产中收集的聚合数据编写相同类型的测试。”

## 如何开始基于跟踪的测试

早在 2010 年，谷歌的工程师们就看到了将测试建立在一个完整的、装备良好的分布式跟踪所提供的数据基础上的好处。然而，到目前为止，这个值很难使用。

这就是为什么我们正在开发 [Tracetest](https://tracetest.kubeshop.io/) ，一个使用 OpenTelemetry traces 创建深度集成测试的开源工具。

*根据痕迹添加断言*

Tracetest 解锁该值，允许您使用 OpenTelemetry 跟踪数据来启用集成和复杂的端到端测试。通过依赖来自现有跟踪系统的跟踪数据来启用测试，我们使得集成测试更容易编写。此外，通过基于您的跟踪构建测试，我们使跟踪的工具化成为开发周期的核心部分——而不是事后的想法，创建一个反馈周期，从而产生更好的测试和更好的可观察性。

随着我们继续构建 Tracetest，我们渴望听到您的反馈，所以请让我们知道您的想法。你可以[从这里](https://github.com/kubeshop/tracetest)开始，随时在我们的[不和谐频道](https://discord.com/channels/884464549347074049/963470167327772703)和我们聊天。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>*