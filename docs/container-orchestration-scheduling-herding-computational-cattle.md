# 容器编排和调度:放牧计算牛

> 原文：<https://thenewstack.io/container-orchestration-scheduling-herding-computational-cattle/>

[](https://opencredo.com/people/daniel-bryant/)

 [丹尼尔·布莱恩特

丹尼尔·布莱恩特是 OpenCredo 的首席科学家。他目前的工作包括通过引入更好的需求收集和计划技术来实现组织内的敏捷性，关注敏捷开发中架构的相关性，以及促进持续集成/交付。Daniel 目前的技术专长集中在“DevOps”工具、云/容器平台和微服务实施上。他还是伦敦 Java 社区(LJC)的领导者，为多个开源项目做出贡献，为 InfoQ、DZone 和 Voxxed 等知名技术网站撰写文章，并定期出席 QCon、JavaOne 和 Devoxx 等国际会议。](https://opencredo.com/people/daniel-bryant/) [](https://opencredo.com/people/daniel-bryant/)

请原谅这种类比，但是我们越来越多地被要求把我们的基础设施和应用程序想象成牛。我们关心牛，但与我们的宠物相比，我们关心的可能要少一些。我们尽量不要对我们的牛鲁莽，我们希望它们在最好的土地上吃草，我们希望定期将它们从拥挤或危险的牧场移走，如果它们生病了，我们希望有人照顾它们恢复完全健康。

在云原生容器平台的世界中，编排和调度框架为我们的应用程序“牛”执行所有这些角色最佳应用程序“农民”最大限度地提高资源利用率，同时平衡系统不断变化的需求和容错需求。

IT 行业正在形成一场完美风暴，它包括三个重要趋势:真正可编程基础设施的兴起，包括云、配置管理工具和容器；适应性应用架构的开发，包括微服务、大规模分布式消息/日志处理和事件驱动应用的使用；以及新流程/方法的出现，如精益和 DevOps。

有了这些变化，我们为什么还要关心容器编排和调度这样的话题呢？我们应该关心的原因与后农业革命时期的成功农民关心他们让牛在哪里吃草是一样的。

## 你经营的是什么类型的集装箱农场？

目前，托管和部署容器化应用程序的选择范围很广。如果我们只考虑现代云平台，我们可以将这个场景大致分为三类:基础设施即服务(IaaS)、容器即服务(CaaS)和平台即服务(PaaS)。

根据所部署的应用程序的类型，每个类别都有其固有的优点和缺点。尽管一些组织会倾向于简单地根据直觉、分析师报告或现有的供应商关系进行选择，但这是一个需要认真评估的基本决策。

[cyclone slider id = " ebook-3-赞助商"]

所用平台的选择严重影响可以实现的编排和调度的类型。下表试图为三种类型中的每一种提供关键抽象、控制平面和适当用例的见解。值得注意的是，容器即服务仍然是一个备受争议的领域——许多人说我们传统上所说的容器服务也是一种容器即服务；然而，Docker 提出了一组不同的标准来考虑 CaaS 解决方案，并且资格的核心是与云基础架构无关。我们认为该产品类别的更大市场解释仍有澄清的空间。

按照我们的农业类比，我们可以想到计算资源(CPU、内存、磁盘、网络等)。)作为我们的应用程序牛吃草的土地。容器平台中编排和调度的作用是以最有效和高效的方式将应用程序与资源相匹配——从牲畜到土地。乍一看，将应用程序与资源有效匹配似乎不是特别困难，但是优化资源使用的装箱方法在计算上是一个 [NP-hard 问题](https://en.wikipedia.org/wiki/NP-hardness)。当我们将这一事实与底层云结构的易变和短暂特性相结合时，我们无疑面临着一个挑战。

## 圈养集装箱化的牛

从 IaaS 创建一个容器化的应用程序平台类似于购买一块荒地并从零开始建造你的农场——相当困难，但是你有最大的控制权。利用 CaaS 很像购买牧场，并雇用一个专业牧群人员来建造围栏和放牧牛群。这让你可以看到这片土地，宣布你的意图，并让其他人做出即时的决定。将应用程序部署到 PaaS 实际上是将您的牛托付给另一个农民。可以说，在这里你可以专注于真正重要的事情(购买和繁殖最好的牲畜，把你的牛迅速带到市场)，但你可能看不到牧场，你可能不总是同意其他农民如何经营他们的农场。

在我在 [OpenCredo](https://opencredo.com/) 的工作中，我们与多个客户合作设计、构建和运营容器化的应用程序和平台。以下部分分享了我们制作的两个案例研究的细节。这些示例旨在演示创建这些编排堆栈的决策。

### 在 Mesos 和 Google 云平台上运行 Spring Boot 服务

对于我们的第一个客户，Apache Mesos 是正在实施的协调器。客户希望将长期运行的容器化应用服务和基于 Spark 的批量数据处理结合起来。Mesos 本身实际上是一个“数据中心内核”，因为它从基础设施集群中抽象出计算资源，并将这些资源提供给框架，如用于长期运行服务的 Mesosphere 的马拉松、用于批处理作业的 Chronos 和用于数据处理工作负载的 Spark。部署和运行 Mesos 在操作上可能很复杂；然而，Twitter、Airbnb 和易贝等公司已经证明它可以大规模工作，并且能够在整个数据中心混合工作负载和调度应用程序是一个有吸引力的提议。

Mesos 由 Ansible 部署和管理，容器化的应用程序通过 Jenkins 构建和部署到马拉松框架中。Consul、Registrator 和 srv_router 的组合提供了服务发现，马拉松提供了用于容错目的的服务重启或重新分配。QA 团队能够在谷歌云平台(GCP)中运行 Mesos 平台的个人实例，这通过减少资源争用(以前是一个问题)来促进测试。然而，由于资源受限的个人环境对整个平台的工作负载安排不同，因此也吸取了一些惨痛的教训。例如，在一台机器的集群中运行多个 Mesos 框架通常会导致其中一个框架的资源匮乏。

### 在 AWS 上向 Kubernetes 部署基于 Go 的微服务

在这个项目中，Kubernetes 通过 Terraform 和 Ansible 部署到 Amazon Web Services (AWS)上，主要目标是为 IaaS 之上的开发人员提供一个抽象级别，但不需要对 PaaS 进行大规模投资。由于客户/供应商限制，无法使用谷歌容器引擎(GKE)。很容易认为，绝大多数组织最终都会创建某种形式的 PaaS，因为许多 PaaS 产品是典型开发团队所需要的，例如，测试、部署、服务发现、存储、数据库集成和开发人员社区促进。因此，这个案例研究确实实现了许多这些特性。

Kubernetes 提供了名称空间隔离，这对于在同一个集群上运行多个测试和部署非常有用。单独的簇用于真正的隔离。部署是通过集成 Kubernetes API 或 kubectl CLI 工具来管理的。使用了持续集成框架 Jenkins，它还负责构建和测试我们的应用服务。通过提供节点健康检查和应用程序/容器级别的[活性探测](http://kubernetes.io/docs/user-guide/liveness/)健康检查，服务发现是开箱即用的，具有良好的容错水平。存储和数据库集成由底层 IaaS 层提供，开发模式通过版本控制系统(VCS)和内部维护良好的 wiki 的组合来共享和重用。

## 从我们在牧场的时光中学到的教训

本文的目的是提供关于选择容器平台的信息，并根据您的需求提供相关的编排和调度机制。然而，这主要是基于两个客户案例研究。还有许多其他产品组合和由此产生的堆栈，从 [Docker Swarm 与 Mesos](https://mesosphere.com/blog/2015/05/20/hyperscaling-docker-swarm-with-mesos-mesosphere-hackweek/) 的混合到[基于 PaaS 的云编排](http://www-03.ibm.com/software/products/en/ibm-cloud-orchestrator)与 IBM 的构建。

以下是我们迄今为止在 OpenCredo 的一些重要学习经历。

### 工具作业

*   尽可能实现自动化，目标是节省时间、大规模可重复性以及减少基础架构/配置的偏差。
*   不鼓励，但允许人工干预，尤其是在组织中引入这种新的容器技术时。我们都知道不应该使用 SSH 进入生产主机，但是将这种进入方法作为最后的手段可以节省业务。

### 性能错误

*   语义错误——理解为“业务影响”错误——在云和容器世界中比底层基础设施故障更重要。最终，如果您失去一半的生产环境也没关系，只要系统正常降级，客户仍然可以从应用程序中获得价值。很多次，我们看到运营团队被基础架构故障警报淹没，但他们不知道对用户的实际影响。
*   了解 Brendan Gregg 的[利用率、饱和度和误差](http://www.brendangregg.com/usemethod.html)(使用)以及 Tom Wilkie 的[速率、误差和持续时间](http://www.slideshare.net/weaveworks/monitoring-microservices)(红色)方法。我们发现这些方法在解决性能问题时非常有用。

### 监控和资源争用

*   各级都必须有能见度。容器监控和管理是在生产中实施容器的公司主要关心的问题。
*   适当地检测应用程序，并且只记录必要的信息。
*   提供业务级(语义)指标。这对于推动关键利益相关者的采用特别有用，对于失败也有很大帮助。
*   网络:如果创建平台，请确保适当地确定计算实例规模。例如，您的应用程序可能只需要一个“小型”实例提供的 CPU 和内存，但是您确认过相关的网络带宽吗？
*   在磁盘和 CPU 级别进行广泛的监控至关重要。如果您正在部署到公共云上，请注意 CPU 的[窃取时间](http://iamondemand.com/blog/who-stole-my-cpu/)。
*   缺少熵可能是一个难以调试的问题，并且在多个容器争用 host /dev/random 的容器化环境中非常普遍。容器化的应用程序通常会无缘无故地挂起，并且在调试时发现安全操作(例如，会话或加密令牌生成)正在阻止它。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>