# 作为代码的基础设施:发展与实践

> 原文：<https://thenewstack.io/infrastructure-as-code-evolution-and-practice/>

[](https://sensu.io/)

 [肖恩·波特

肖恩·波特是 Sensu 项目的创建者，也是开源监控领域的领导者 Sensu Inc .的联合创始人兼 CTO。Sean 是一名经验丰富的系统操作员和软件开发人员，在自动化基础设施方面有十年的经验。作为 Sensu Inc .的首席技术官，他监督 Sensu 的开发，并与用户合作，以更好地了解 Sensu 如何帮助他们解决复杂的监控问题。](https://sensu.io/) [](https://sensu.io/)

随着基础架构在过去十年中不断发展和成熟，我们构建和部署基础架构的方式在很大程度上也保持了同步。随着部署速度的加快，持续部署和交付等实践成为常态，我们以类似的方式管理基础架构和部署应用变得至关重要。

这种需求催生了“基础设施即代码”(IaC)，即基础设施的管理(以及其中的一切，从网络到虚拟机到负载平衡器)，它为您的应用提供了基础。通过以相同的方式部署和编码您的部署，您为从基础架构到应用程序的所有内容的配置状态建立了一个框架—一个事实的来源。正如 Jesse Robins 和 John Allspaw 在 [Web Operations](https://www.amazon.com/Web-Operations-Keeping-Data-Time/dp/1449377440) 中所说的那样，IaC 让您能够“只从源代码库、应用程序数据备份和裸机资源开始重建业务。”

> 如今，我们对待基础设施就像对待应用程序代码一样。我们编写代码，以可预测的方式供应和管理我们的基础架构。这意味着一个应用程序，不管它的环境如何，也不管它托管在哪里，都可以完全按照预先定义的需求列表从头开始构建。

通过实现 IaC，您为运营人员和开发人员提供了一条了解您的基础设施的途径，让他们了解了如何部署和配置。您还可以授权给安全团队—他们可以审核单一的事实来源，以确保您的部署符合安全要求。如果他们有顾虑，他们可以在基础架构的上下文中以代码的形式提出来——因为所有的东西都通过代码进行了编码和记录，所以您可以在相同的上下文和理解下进行跨团队对话。

在这里，我将看看 IaC 的发展——包括我们以前的情况——以及它在实践中的样子。

## 部署代码的演变

从前，应用程序是手动部署到其托管环境中的。

在那之后，我们开始通过脚本来自动化这个过程，尽管它们很脆弱。通常为操作员需要执行的一组操作(例如，apt-get update 和 apt-get install apache2)编写一个脚本，一个用于设置负载平衡器，另一个用于安装依赖库，等等。修改脚本以适应新的需求既困难又耗时；更糟糕的是，只有少数操作工程师能理解所有的神秘开关。如果服务器由于部署不当、选项配置错误、不可操作的依赖关系或许多其他原因导致不可用，可能需要几个小时才能诊断和解决问题。

然而，DevOps 的兴起意味着许多面向未来的组织选择 IaC。

如今，我们对待基础设施就像对待应用程序代码一样。我们编写代码，以可预测的方式供应和管理我们的基础架构。这意味着一个应用程序，不管它的环境如何，也不管它托管在哪里，都可以完全按照预先定义的需求列表从头开始构建。

同样的代码可以运行在生产环境中，运行在暂存环境中，运行在您的本地开发环境中，无论您的应用程序在哪里运行，都可以确保(相当)一致的结果。

此外，虽然过去的定制脚本可能适用于较小的环境(例如，几台服务器)，但它们很难扩展。诸如 Chef、Puppet 和 Ansible(仅举几个例子)之类的工具将一个框架作为代码引入到您的基础设施中，允许您支持成千上万的机器，这些机器最终会自行配置。幂等性 IaC 的一个关键原则——使客户端能够重复进行相同的调用，同时产生相同的结果。也就是说，发出多个相同的请求与发出一个请求具有相同的效果。幂等性使得在同一台机器上一遍又一遍地运行您的代码变得便宜，并确保结果如您所料。Chef 和 Puppet 特别关注这个原则，如果没有这个原则，您将回到运行定制脚本的状态。

## 益处 IaC

IaC 的一个巨大优势是它是一个单一的事实来源:关于您的服务如何运行以及它们所需要的依赖性的知识可以在整个应用程序交付团队之间共享，而不是在高度技术性的操作成员的严格子集之间共享(他们的时间可以更好地用于微调网络和数据库性能)。以这种方式传播知识可以确保每个人都可以自给自足地调整服务器、构建功能并最大限度地减少停机时间。(您仍然必须小心——在某些情况下，您可能会自动停机并放大错误)。

由于我们的基础设施是由代码生成的，这也意味着您可以对您的基础设施进行版本化，并与您的团队讨论变更。自动化提供了多种业务优势(降低运营成本和停机时间),从而减少了对工程师工作效率的影响。

你可以(也应该！)还要测试您的配置代码，以确保更少的意外损坏。例如，如果一个上游包更改了一个接口并破坏了它的依赖项，您可以在它成为您的测试环境中的一个问题时检测到该更改，并推迟任何包的升级，直到问题得到解决。像 [test-kitchen](https://github.com/test-kitchen/test-kitchen) (我喜欢和 [kitchen-docker](https://github.com/test-kitchen/kitchen-docker) 驱动一起使用)和 [serverspec](https://github.com/mizzy/serverspec) 这样的工具通过提供一个开发和测试 IaC 代码和软件的集成工具来帮助解决这个问题。

说到检测，IaC 设置还允许您监视应用程序的配置。正如您检查软件的性能一样，您可以跟踪基础架构设置的各个方面，例如从头到尾配置一个应用程序需要多长时间。您可以基于事件发生的时间来自动执行任务，例如，如果节点行为不正常，如果 Nginx 等关键服务关闭，甚至当测量磁盘空间或内存使用等资源分配时，您都会收到警报。

## 要考虑的权衡

IaC 方法并不完美，和任何实践一样，需要考虑权衡。

首先，你需要确保实现一个易于理解的工作流程——确保组织中的大多数团队使用相同的策略来部署他们的应用程序和管理他们的基础设施。如果您的应用程序被设计为多个微服务，这一点尤其正确。和往常一样，当涉及到目标时会有一些妥协——我最近采访的一位企业 it 经理引用了 Puppet、Ansible、一些脚本和 Docker 的组合来运行他们的基础设施。

您可能还需要适当的指南和权限，禁止直接在服务器上编辑配置文件，因为这可能会在您的版本控制系统(VCS)中存储的预期设置和实际运行的代码之间引入偏差。幸运的是，Chef 和 Puppet 都通过覆盖更改来自动纠正控制漂移——下次 Chef 或 Puppet 运行时，它们将清除更改以获得预期的声明状态。

另一个可能的缺点是学习曲线。不熟悉 OS 软件包管理器的复杂性或使用它们的框架(如 Chef 和 Puppet)的开发人员可能需要先接受一些培训。然而，从长远来看，这是一个很好的信息，因为严格意义上的“软件工程师”和“操作工程师”之间的差距正在缩小。很好地理解应用程序的所有部分是如何协同工作的，对于开发可靠的软件是至关重要的。

## 简单期望的轻松

最后，基础设施即代码定义了一个以可靠和高效的方式配置基础设施和应用程序的过程。简化的应用程序配置流程使您能够快速部署更好的软件。当您测试和监控您的基础架构时，您可以确保跨您拥有的每个环境进行稳定且可重复的部署。

随着 IaC 实践的继续发展，我们可以期待看到基础设施管理方面的更多改进。我们还可以期待机器学习报告问题或自动进行安全升级。例如，Chef Automate 旨在识别低效的配置，就像我们开始对我们的系统获得同样的洞察力一样。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>