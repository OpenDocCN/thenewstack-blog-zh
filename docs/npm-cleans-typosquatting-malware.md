# Npm 清理 Node.js 域名仿冒恶意软件

> 原文：<https://thenewstack.io/npm-cleans-typosquatting-malware/>

NPM(T1)社区对包装(T2)争议(T3)并不陌生。作为一个收集世界上 [Node.js](/tag/node.js/) 项目并向所有开发者免费提供[下载的资源库](https://medium.com/@maybekatz/anyone-who-uses-npm-is-automatically-allowing-usually-unreviewed-arbitrary-remote-code-execution-c4bc41f0a74c)，npm 偶尔会经历来自成千上万托管包之一的些许戏剧性。

上一次出现重大包问题是在 2016 年 3 月，一名不满的开发人员从 npm 中删除了他广受欢迎的 left-pad 包，[由于依赖性消失而留下了许多不完整的构建](https://thenewstack.io/the-kik-kerfuffle/)。虽然实际的损害是有限且短暂的，但这一事件确实促使 ECMAScript 委员会[最终在 JavaScript 语言](https://thenewstack.io/newly-released-ecmascript-8-sets-stage-concurrent-javascript-processing/)中添加了字符串填充，完全消除了左填充包的需要。

本周，一个恶意开发者故意毒害并重新发布一个现有的包，引发了一场新的争议。

[Cross-env](https://www.npmjs.com/package/cross-env) 是 npm 存储库中的一个流行包，JavaScript 开发人员使用它来处理在 Windows 和基于 POSIX 的系统中设置 Node.js 环境变量之间的差异。本质上，使用 Cross-env 允许开发人员使用 POSIX 约定，并自动转换它们，以便它们也能在 Windows 中工作。

输入 [Crossenv](https://webcache.googleusercontent.com/search?q=cache:zAzfBZIg0vYJ:https://www.npmjs.com/package/crossenv+&cd=1&hl=en&ct=clnk&gl=us) ，一个相同的包，有相同的描述。唯一的不同是缺少了破折号，并且在源代码中添加了一些恶意软件。

npm 的 CLI 工程师[写道](https://medium.com/@maybekatz/anyone-who-uses-npm-is-automatically-allowing-usually-unreviewed-arbitrary-remote-code-execution-c4bc41f0a74c) [Kat Marchán](https://www.linkedin.com/in/katmarchan/) 。

“任何使用 npm 的人都会自动允许通常未经审查的任意远程代码执行。您安装的 npm 库本身可以执行 _any_ code。即使你使用**–ignore-scripts**，你仍然在*加载代码*，或者一些依赖的代码。Marchán 在一篇博客中写道:“这不仅是 npm 的一个已知问题，几乎所有未固化的包管理器生态系统都是如此，其中几乎包括所有主要的语言包管理器(rubygems/bundler、pypi、cpan、bower、cocoapods 等)。“这就是我们实际拥有的基线:通过使用包管理器，您表达了对整个系统的某种程度的信任。”

她接着说，“也就是说，npx 可以做一些事情来缓解更突出的问题(比如域名抢注，这在 npm 生态系统中是非常罕见的，基于实际研究)，但它也将确保它是一个合理有用的工具。npm 已经在致力于改善 npm 和 npx 情况的其他缓解措施(即将推出！)，但最终，任何使用这两种工具的人都会选择将自己置于某种程度的风险之中，以换取便利，”马尔尚写道。

[npm 首席技术官 CJ Silverio](https://www.linkedin.com/in/ceejbot/) 表示，攻击者被迅速处理，NPM 知识库中域名仿冒的实际攻击媒介并不是传播恶意软件的非常有效的方式。首先，她说由于命名的不同，这个包不能替换现有的跨 env 包。即使有人不小心将它添加到使用 cross-env 的现有项目中，这一点点名称差异也会确保代码在编译时无法正确解析，就像开发人员在代码中键入了错误的包名一样。

事实上，唯一可能受到影响的开发人员是那些正在构建一个全新项目，并且从一开始就包含了错误类型的 crossenv 包的开发人员。这确保了在 7 月 19 日上传的包和 8 月 1 日删除的包之间，只有新的项目有风险。

Silverio 还表示，开发人员倾向于在使用软件包之前搜索它，这意味着大多数 cross-env 用户会通过搜索 web 找到它，而不是简单地在 npm 命令中键入单词。总的来说，可能只有不到 50 次暴露在这个包裹下。因此，她补充道，[域名抢注](http://incolumitas.com/2016/06/08/typosquatting-package-managers/)并不是传播恶意软件的一种非常有效的方式。

“包抢注主要发生在竞争性模块。有人将他们的日期解析和处理库命名为类似于 [Moment.js](https://momentjs.com/) 的东西，故意混淆了两者。通常都是这样。我没见过恶意抢注，尽管我知道这是可能的。通常，这是偶然的，”西尔维奥说。

比如两个 JavaScript 流处理包被命名为相同的东西，只是大小写不同。Silverio 说，npm 过去是区分大小写的，但这个特殊的问题迫使它做出了改变。

这并不意味着 Silverio 和 npm 团队不会做出改变，以确保这种情况不会再次发生。他们提议寻找域名抢注者的一种方法是通过[](https://www.computerhope.com/jargon/d/diff.htm)**不同的项目描述进行对比。在这种情况下，这样的比较会捕获 crossenv。**

 **## 复制粘贴

Silverio 说，另一个解决方案是“以编程方式对项目名称进行最近邻检查，但最终，即使这样也需要人工审查。”她说，目标是尽可能地自动化这个过程。Silverio 说，npm 中有太多的包需要手工检查安全问题。

Silverio 还指出，围绕 npm 知识库的安全由其他公司提供，如^Lift 安全公司。^Lift 提供了自己的[节点安全平台](https://nodesecurity.io/) (NSP)，它将安全检查添加到基于 GitHub 的工作流中。Silverio 表示，^Lift 还针对 npm 注册表进行了广泛的包分析。

Silverio 推荐的另一家安全公司是 Snyk，该公司提供工具来查找节点应用程序及其依赖关系中的安全漏洞。Silverio 表示，这些公司可以提供大多数企业所需的节点包安全和监控的额外层。

“我建议人们雇佣^Lift 安全公司或与 Snyk 合作，因为这些公司有专门做这件事的完整商业模式:分析软件包，给你关于它的建议，维护和管理他们手动审计的东西的列表……这需要特定的专业知识，而 npm 目前不具备这些，这就是我们与他们合作的原因。我们让他们扫描所有的注册表代码，以确保我们没有犯错误，”西尔维奥说。

“[^Lift]用大量注册数据做了一些有趣的事情。当这封信到达我们的收件箱时，我做的第一件事就是把它发给(^Lift].)这是注册表中的唯一事件吗？我们有足够的数据，他给了我们一些信心，我们解决了这个问题。

还有另一个幸运的来源，使这个问题没有扩展到少数用户之外。Silverio 说，很多开发人员甚至不再从头开始构建他们的项目时键入包名。相反，他们经常从其他项目或解释项目的网页中复制粘贴包依赖项。

这种复制粘贴有助于降低恶意软件的传播，因为任何打字错误都被阻止出现。虽然社区中的一些人会谴责复制和粘贴代码的流行，但 Silverio 说，在这里，它实际上挽救了局面。

由 Guillaume Bolduc 通过 [Unsplash 拍摄的特写图片。](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>**