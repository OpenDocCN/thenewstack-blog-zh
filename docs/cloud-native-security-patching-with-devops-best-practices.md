# 使用 DevOps 最佳实践进行云原生安全修补

> 原文：<https://thenewstack.io/cloud-native-security-patching-with-devops-best-practices/>

[](https://www.aquasec.com/)

 [利兹·赖斯

利兹·赖斯是集装箱安全专家 Aqua Security 的技术布道者。在此之前，她是 Microscaling Systems 的 CEO，也是管理容器元数据的工具 MicroBadger 的开发者之一。](https://www.aquasec.com/) [](https://www.aquasec.com/)

在传统部署中，安全团队的一项重要职责是确保服务器安装了最新的安全补丁。因此，乍一看，云原生部署对安全专业人员来说就像一场噩梦:数千个容器，每个容器都有自己版本的不同操作系统文件、包和可执行文件。这不是把打补丁的问题放大了几个数量级吗？

幸运的是，DevOps 中当今最佳实践的一些主要原则真的很有帮助。让我们看看不可变的工件和自动化如何简化保持云原生部署正确修补的过程，并提高其有效性。

## 容器图像是不可变的

在当今世界，部署的基本单位是容器映像。一旦构建了容器映像，就无法更改；如果您想要更新映像，您需要重建一个新版本。

当您启动容器运行时，它是从容器映像实例化的，文件系统启动该映像内容的副本。从理论上讲，完全有可能按照传统的方式将该容器视为一台服务器:您可以进行设置，这样就可以 SSH 到一个容器中，并对其应用补丁。但是用补丁构建一个新的映像并重启容器是一个好得多的主意，原因有几个:

*   构建一次，运行任意多的实例。您不需要单独修补每个容器；您只需要重新构建一次映像，包括需要更新的任何包的修补版本，然后您可以将相同的代码重新部署到您的所有容器实例。Kubernetes 和其他 orchestrators 可以通过滚动升级轻松做到这一点。
*   手动修补服务器(或容器)时，很难保持可靠的记录。相比之下，docker 文件记录了每个容器映像是如何构建的。您可能需要将此与容器图像扫描结合起来，以获得包含哪些包版本的精确图片，但是同样，您只需要扫描一次图像，就可以获得所有运行的容器中包含的内容的完整图片。作为推论，您可以确信从同一个映像运行的所有容器都使用了该映像中每个包的完全相同的版本。这对于调试已部署代码中的问题非常有帮助。
*   在绝大多数情况下，您不需要通过 SSH 之类的工具来访问容器——这样您就可以避免在容器映像中包含这些东西，并显著减少容器的攻击面。

可以编写容器代码，在运行时将额外的包安装到自身中。这是非常糟糕的做法，因为直到实例化的时候你才知道你将要运行什么软件，你甚至会以从相同的映像启动容器而结束，但是不执行相同的代码！从确保您不会带着漏洞运行的安全角度来看，这是一个可怕的想法。

由于没有在容器映像中包含不必要的工具和包，当发现新的漏洞时，需要修补的代码实例可能会更少，这仅仅是因为您的映像不太可能包含受影响的代码。但是我们仍然必须考虑如何识别您的哪些映像需要修补以及何时修补的问题。在此之前，让我们花点时间来讨论一下如何识别漏洞。

## 补丁的生命周期

世界各地的安全研究人员日复一日地工作，寻找新的方法来滥用现有的代码，以产生意想不到的副作用。例如，在最近的 [Meltdown 和 Spectre](https://blog.aquasec.com/do-containers-provide-better-protection-against-meltdown-and-spectre) 事件中，很明显可以利用推测执行(一种旨在提高性能的功能)来访问本不应该访问的内核内存。有识别这些漏洞的标准方案，例如在[国家漏洞数据库](https://nvd.nist.gov/)中使用的 CVE 标识符。

一旦发布了对某个漏洞的描述，这有助于整个社区了解存在被该漏洞攻击的风险，但同时也提醒坏人注意他们可以利用的新的潜在攻击媒介。如果漏洞很严重，安全团队将同意在一段时间内对细节保密，以便给代码供应商(或作者)时间先发布补丁。

安全团队将确定哪些版本的代码包受到了影响；与此同时，供应商努力发布一个修改后的新版本代码，这意味着该漏洞不再可能被利用。发布了包含此修改的新包。

那么，在攻击者到达您的部署之前，部署这个补丁包就成了一场竞赛！

## 图像扫描

图像扫描器查看包含在容器图像中的软件包。他们用漏洞数据库(如 NVD)交叉检查这些包，在那里他们可以查找哪些 CVE，如果有的话，出现在这个精确的包集中。有几种扫描仪可供选择，包括免费的解决方案，如 CoreOS 的 Clair，Aqua Security 新发布的 [MicroScanner](https://github.com/aquasecurity/microscanner) ，以及付费的企业级解决方案。

检测漏洞听起来很简单，但实际上很复杂。例如，包 A 可能包含一个漏洞，只有在包 B 存在或使用了特定类型的网络协议时，该漏洞才会被利用。如果这些情况不适用于您，您就不会想要应用补丁版本的包 A，尤其是如果补丁与您的应用程序代码不兼容的话。此外，不同的 Linux 发行版可能会将补丁反向移植到旧版本的软件包中。NVD 并不跟踪所有不同发行版中的这些反向修复，因此仅依赖 NVD 数据会导致大量误报。有效处理假阳性的能力是不同图像扫描仪之间的关键区别。

我们在上面看到了如何使用容器映像，并在需要更改代码时重新构建一个新的映像，可以减少修补问题的规模，同时提高安全性。现在，让我们来看看自动化(尤其是 CI/CD 管道)如何进一步发挥作用。

## 自动化漏洞检测

我们考虑过重新构建容器映像来应用补丁。您可以手动完成这项工作，但绝大多数云原生代码都是使用持续集成工具构建的，如 Jenkins、Travis、CodeShip 或 GitLab。安全扫描的云原生方法包括将其作为持续集成管道中的一个步骤。

通过 CI 管道中包含的图像扫描，您可以在每次代码更改时自动检查任何新漏洞的引入。例如，如果检测到高严重性问题，您可以自动使构建失败。

定期对已部署的容器映像运行映像扫描，可以让您在发现影响代码的新漏洞时获得警报。因为您使用不可变的容器映像作为容器的基础，所以没有必要扫描容器本身。这可以节省大量的时间和资源，因为您只需要重新扫描一个映像，而不是从该映像派生出的数千个正在运行的容器。当您找到受影响的容器映像时，您可以使用更新重新构建它，并重新部署所有受影响的运行容器。

在传统部署中，安全修补通常由安全或运营团队在开发团队参与的阶段完成。随着图像扫描包括在管道中，开发人员开始投资于使用适当版本的基本图像、包和库。安全性“左移”，成为一项共同的责任，而不是完全孤立在不同的团队中。

## 更有效的安全性

我们已经看到了使用基于不可变映像的容器如何允许我们用新代码高效地更新部署，并给予我们减少容器攻击面的潜力。通过图像扫描，漏洞检测可以很容易地包含在构建管道中，这样我们就可以在出于安全目的需要更新图像时得到提醒。将安全性留给开发人员可以让他们对潜在的问题有更多的认识，并防止安全性被当作事后的想法。在我看来，这些原因都有助于使云原生部署比传统部署更安全。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>