# 数据库——最终——被容器化了

> 原文：<https://thenewstack.io/databases-finally-get-containerized/>

到目前为止，传统数据库很难在 Kubernetes 上部署，因为它们不是为在容器化环境中工作而设计的。企业被迫创建自己的解决方案，或者更多时候，依赖云提供商自己的云数据库产品，这将他们锁定在特定的云平台上。

在过去的几个月里，随着开源社区和提供额外支持和管理工具的供应商增加了对 Kubernetes 上 SQL 和 noSQL 数据库的支持，这种情况已经发生了变化。

在过去的几年中，企业在云基础架构方面取得了巨大的进步。随着新冠肺炎疫情，在过去的一年里，这种流动变成了海啸。

根据 Flexera 在三月份进行的一项调查，99%的公司现在都有云采用战略，其中 92%的公司选择结合不同公共云或公共云和内部云的多云方案。

每月在云服务上花费至少 100 万美元的公司比例现在为 31%，比去年调查的 16%增加了近一倍。现在所有工作负载的一半都在云中，企业计划将这一比例提高到 57%。

容器的采用也随着云计算的兴起而增加。根据云计算原生计算基金会 2020 年[的一项调查，92%的全球云用户社区正在生产中使用容器，高于 2019 年的 84%，高于该组织 2016 年首次调查的 300%。](https://www.cncf.io/wp-content/uploads/2020/11/CNCF_Survey_Report_2020.pdf)

Kubernetes 占了容器使用量的很大一部分，83%的人将 Kubernetes 作为他们的首选容器平台，高于 2019 年的 78%。

数据服务紧随其后。根据 Flexera 的调查，87%的公司正在使用、试验或计划使用数据仓库或关系数据库即服务。

事实上，46%的组织数据已经在公共云中，并将在未来 12 个月内增长到 54%。

[Gartner 预测](https://www.gartner.com/en/newsroom/press-releases/2020-06-25-gartner-forecasts-strong-revenue-growth-for-global-co)到 2022 年，超过 75%的组织将在生产中运行容器化应用。

根据 Flexera 的调查，Docker 和 Kubernetes 占了所使用的容器工具的大部分。公司正在采用容器来缩短开发周期、简化云迁移和降低云成本。

DataStax 的首席战略官 Sam Ramji 说:“容器都是关于水平可伸缩性的。“如果我们可以垂直扩展一切，我们仍然会在大型机或运行巨大的 Java 虚拟机上。”

在这些较旧的方法中，组织会看到软件更新间隔数月，甚至更长。

“连续交付公司可以一天迭代多次，”他说。“这是 Kubernetes 的第一个驱动力——精益流程，即缩短从提出想法到在生产中实施的周期时间的能力。”

拉姆奇说，这改变了你可以向顾客提供的产品种类。

“我们能够在谷歌产生多个价值数十亿美元的想法，”曾担任谷歌产品管理副总裁的拉姆奇说。"我们可以尝试许多想法，看看它们是否可行。"

他说，通过这种发展方式，“你可以满足你的客户，争取市场份额，并从单位经济中获益。你可以将一百万行代码分成一百个不同拓扑的微服务，每一部分都可以独立扩展。”

但是随着组织向云、容器和 Kubernetes 迁移，数据已经成为一个挑战。

容器支持应用程序开发的“无状态”方法。单个容器可以根据需要上下旋转，所以应用程序不能被设计成连续运行并记住它们在做什么。如果一个容器化的应用程序有一个内置的数据库，那么当容器关闭时，这个数据库就消失了，当它再次启动时，这个数据库就会重新创建。

“在这种环境下，单实例数据库可能会消亡，”Ramji 说。

根据 IDC 今年早些时候发布的一项调查，47%的微服务依赖于数据库，32%的受访者表示数据库管理是他们面临的最大挑战之一。

IDC 负责数据管理软件的研究副总裁 Carl Olofson 写道,[许多数据库没有被设计为云原生的、与容器兼容的或由 Kubernetes 编排的。](https://redis.com/docs/application-modernizaton-impact-on-data-layer/)

为了解决这个问题，组织通常使用单独的外部数据存储。例如，如果他们在亚马逊上运行他们的容器，他们将使用 AWS 云数据库。如果他们在 Azure 或 GCP 上运行，他们将使用这些平台上可用的云数据库。

这本身就带来了挑战，因为从一个云迁移到另一个云需要重写应用程序，以便在新的云环境中工作。

当数据库足够小时，另一种方法是将每个数据库的完整副本放在每个容器中。

这给管理带来了挑战。例如，如果一个数据库被更新，在容器关闭的情况下，更改必须被发送到备份数据库，并被复制到运行相同数据库的所有其他容器。

或者可以对数据库进行分片。例如，一个容器可以处理姓名以 A 到 M 开头的客户的请求，另一个容器可以处理从 N 到 z 的请求。

应用程序现在需要知道将每个请求发送到哪里。如果你需要扩展容器的数量，你可能需要把其中的一个碎片分割得更远，比如说，从 A 到 F，从 G 到 m。

“如果你改变你的分片策略，你必须改变你的应用程序，”拉姆奇说。

他说，由于迁移到容器化环境的好处，企业对寻找在 Kubernetes 上运行 SQL 和非 SQL 数据库的方法很感兴趣。

## 容器化数据的新方法

在过去的一年中，有几个项目使数据库适应集装箱化的环境。

例如，使用 Cassandra(一种流行的非 SQL 数据库)的公司一直在合作 DataStax 的开源项目 [K8ssandra](https://k8ssandra.io/) 。

去年 11 月，DataStax 首次推出了 K8ssandra(发音为“Kate Sandra”)，以及在 Kubernetes 集群中运行数据库所需的工具和仪表盘。

它建立在 2020 年春天发布的更简单的用于 Cassandra 的 Kubernetes 操作系统之上。

K8ssandra 基于 DataStax 自己运行其托管云数据服务 Astra 的经验。

其他数据库也正在被移植到容器中。例如，蟑螂实验室一直致力于将其分布式 SQL 数据库[cocroach db 引入 Kubernetes](https://www.cockroachlabs.com/blog/running-cockroachdb-on-kubernetes/) 。

与此同时，例如，PlanetScale 使用开源的 [Vitess](https://vitess.io/) 来横向扩展 MySQL，并且[也有一个让它在 Kubernetes 上工作的操作符](https://vitess.io/blog/2020-11-09-vitess-operator-for-kubernetes/)。Vitess 缩放技术最初是在 YouTube 上开发的，现在支持 Square、Slack、HubSpot 和其他大型互联网网站。

Ramji 说，诀窍是为开发人员提供一个正常工作的数据结构，而不强迫开发人员在安全性、可审计性或可扩展性方面进行斗争。

即使开发人员只构建小规模的应用程序，比如只有三个节点，也是如此。

“你希望它们(应用程序)变得流行，”他说。“但一旦(某个应用)变得流行起来，你就不想重新设计整个系统了。你无法关闭它，所以你最终试图建立两个并行系统。”

公司可以通过选择一个从一开始就可以很好扩展的平台来避免这个问题。

例如，卡珊德拉最初是在脸书开发收件箱搜索功能的。它于 2008 年作为开源项目发布。其他使用它的公司包括 Instagram、GoDaddy、易贝、Spotify 和网飞。但是最大的一次部署可能是在苹果公司，该公司在 Cassandra 投入了大量资金。苹果公司与 Cassandra 相关的职位空缺是 HBase、Couchbase 和 MongoDB 总和的三倍多。

“据报道，苹果公司运行着一个 20 万节点的 Cassandra 集群，为 iCloud 上的数据服务提供动力，包括 iMessage 和许多其他服务，”Ramji 说。

他说，Cassandra 的工作原理是自动向负载最小的服务器发送入站请求。

“你可以创建跨越多个地理区域的数据库集群，”他补充道。"例如，脸书的收件箱必须在地理上随处可用."

Cassandra 可以在每个实例中默认数据的完整拷贝，或者公司可以使用智能复制并指定哪些数据可以放在哪里。Ramji 说，当监管机构要求将敏感数据移出某些区域时，智能复制特别有用。

“这非常适合 Kubernetes，因为 Cassandra 知道如何横向扩展自己，”他说。“无论您如何扩展 Kubernetes 集群，您都可以流畅地添加 Cassandra 节点。但挑战在于让卡珊德拉·库贝内特斯本土化。”

这花了几年时间。“Kubernetes 是一个非常不利于数据库的环境，”他说。

首先，Kubernetes 完全是关于无状态应用程序的。

“有了 Kubernetes，你可以随时停止和启动服务，然后在其他地方弹出它，”他说。"你不记得以前的服务."

因此，开发人员通常将他们的数据保存在 Kubernetes 世界之外。

要将数据移入 Kubernetes，首先，平台需要支持有状态的应用程序。解决方案 StatefulSets 于 2018 年推出 Kubernetes 1.9。StatefulSets 从 2016 年的 1.5 版本开始处于测试阶段。

这种方法很快流行起来。根据 CNCF 的调查，今天，55%的公司在生产中使用容器中的有状态应用程序。

“StatefulSets 让你告诉 Kubernetes，‘我实际上是一个数据库，所以要冷静，’”ram Ji 说。

他说，这意味着容器在关闭时必须格外小心。数据库必须将其内存中的写操作提交到永久存储中。

然后是同步和协调的问题。Cassandra 集群通常使用 gossip 协议相互通信。这必须随着向集装箱化环境的转移而改变。

“卡珊德拉必须停止在它自己的节点之间说三道四，并学会使用 Kubernetes 控制平面中的协议，”拉姆奇说。

最后，运行 Cassandra 传统上需要一些手动管理和控制功能。

“为了在 Kubernetes 控制平面上扩展、自我修复、恢复和工作，它必须以 Cassandra 从未有过的方式彻底自动化，”他说。

当 K8ssandra 在 11 月份首次发布时，它准备在 Kubernetes 上工作。本月，该项目为所有主要的云提供商增加了[开箱即用的支持](https://www.datastax.com/press-release/k8ssandra-now-runs-any-kubernetes)，因此它可以与特定风格的 Kubernetes 一起工作，而不需要任何额外的配置。

“我们预计人们会在亚马逊、谷歌或 RedHat OpenShift 上运行它，”他说。“我们还能够修复一些错误和依赖关系，并使配置更加智能。”

## 存储容器

另一家致力于在 Kubernetes 上部署 Cassandra 的公司 [MayaData](https://mayadata.io/) 的首席现场工程师[丹·亚斯尼](https://www.linkedin.com/in/dyasny/)说，在容器中运行数据库最重要的是找到一种存储数据的方法。

他说，存储区域网络(SAN)是一种方法，但价格昂贵。

“一个典型的 SAN 项目当场就要花掉六位数的钱，”他说。“再过五年，它就要报废了，你最终不得不买一台新的。”

他补充说，还有与管理平台相关的成本。“当你花费六位数时，你需要一个了解 Hyperchannel 的人。不简单。”

有了 Kubernetes，公司可以使用本地附加存储，并且可以通过添加更多节点和更多磁盘来进行扩展。

这是针对私有云部署的。云也有自己的本地存储版本。

“在亚马逊、GCP 和 Azure 上，你可以使用本地非易失性内存的实例类型，”他说。“单个磁盘每秒可以提供 10 万次操作，这太疯狂了。典型的 SCSI 磁盘最多只能提供 150 个。因此，当您在这些云中使用这些实例时，您可以在单个虚拟机上调配 60tb 的容量。它巨大无比，速度惊人。”

当然，缺点是它是短暂的。

“如果你停止一个虚拟机，然后再启动它，磁盘将会是空的，”他说。“运行这样的数据库听起来很疯狂。但是想象一下，数据库有多个节点，有多个副本，如果一个笔记出现故障，它会再次出现。”

有了自我复制的 Kubernetes 堆栈，公司不必担心为他们的应用程序设置单独的存储功能，因为数据库本身可以处理被复制的内容。

他补充说，新的容器友好型数据库有自己的备份解决方案。

“你拍一张快照，然后离开你当前的状态，”他说。“您可以每次只备份增量数据，也可以备份全部数据，这有很多种可能性。”

MayaData 通过其 OpenEBS Mayastor 为基于 Kubernetes 的数据库提供备份和编排功能。

OpenEBS 是一个由 MayaData 支持的开源项目，它允许有状态的 Kubernetes 应用程序访问动态的本地持久卷或内存的复制持久卷。

它负责容器数据难题的另一部分——管理分布在多个 Kubernetes 存储环境中的数据。

Yasny 说:“有时，您有单独的节点，这些节点有磁盘，而工作负载在其他节点上。

他说，以前的解决方案可以提供复制、快照和其他功能，但在性能方面受到了影响。

他说，OpenEBS 是一个存储协调器，可以连接到本地和网络附加存储卷。这是 Kubernetes 上最流行的开源存储实现，已经存在了几年。Mayastor 将这种能力扩展到了整个容器。

“在良好的实验室条件下，我们的开销只有个位数，”他说。"不需要太多的调整或太多的努力，我们可以达到 15%的开销."

三月份，MayaData 与英特尔联合发布了一份关于其性能测试的[基准测试报告](https://mayadata.io/assets/pdf/product/intel-and-mayadata-benchmarking-of-openEBS-mayastor.pdf)。

OpenEBS MayaStor 目前处于测试阶段。

MayaData 董事长兼首席执行官[Evan Powell](https://www.linkedin.com/in/epowell/)表示，正式发布日期将由更广泛的社区决定，并将基于代码稳定性、测试覆盖率和测试结果等标准。他说，这可能会有更多的版本，这意味着该项目将在几个月内退出测试。

印度电子商务巨头 Flipkart 目前正在使用不同风格的 OpenEBS 将 Cassandra 工作负载转移到 Kubernetes。

“随着规模的扩大，他们将成为 Kubernetes 的最大用户之一，”鲍威尔说。“很荣幸能与他们合作。”

## 在变化的时代，容器增加了灵活性

Target 从 2014 年左右开始使用 Cassandra 数据库。2018 年，该公司在其所有商店推出了单独的 Cassandra 集群，并需要这些集群在 Kubernetes 中运行。

那是在有 K8ssandra 项目之前，Target 从零开始建立这个基础设施。

[据 Target 的工程总监 Daniel Parker](https://tech.target.com/2018/08/08/running-cassandra-in-kubernetes-across-1800-stores.html) 称，第一个挑战是当新节点启动时，它们必须找到其他节点进行连接，如果同一个集群中有几个新节点同时上线，它们必须能够找到彼此并聚集在一起。

此外，在设置容器重启时不会被擦除的备份、设置自动监控和警报方面也存在问题。

“在所有目标商店部署 Cassandra 集群时，我们有许多障碍要克服，”Parker 写道。

但是这项投资可能会有回报，DataStax 的开发者关系副总裁 Patrick McFadin 说。

当疫情来袭时，世界各地的零售店不得不转向送货或路边取货。

这意味着公司需要有适当的技术基础设施，让他们能够快速转换业务流程。

“没有这样做的公司很难适应。看看零售业最近的变化，包括 Gap、JCPenney 和 Sears，”麦克法丁说。

其他需要高度可扩展性或敏捷性的公司包括娱乐公司、医疗保健、金融、零售和物流等具有大量季节性波动的行业、SaaS 供应商、部署 5G 和边缘计算的公司、部署新的人工智能应用和自动化的公司。

他补充说，今天，技术和业务灵活性是生死存亡的问题。不仅仅是疫情。公司在多个领域面临着极大的市场压力。

如果不是疫情，那就是别的东西。一家新的创业公司到来了。一家竞争公司决定积极扩张到你的领域。供应或市场需求出现中断。或者，越来越频繁地，亚马逊决定进入一个新的利基市场，并威胁要在一夜之间让那里的所有在位者破产。

“这是一个生存问题，”麦克法丁说。“如果你不动，你就进入了第 11 章。”

容器化的敏捷方法允许快速升级应用程序和快速扩展容量。

“我们不能回到旧的传统瀑布方法，”麦克法丁说。

## 避免云锁定

调整数据库以在 Kubernetes 上本地工作还创造了一个额外的好处:企业不再局限于他们的云提供商。

根据 Gartner 的说法，一旦一家公司在特定的云平台上部署了一个应用程序，它就倾向于留在那里。一旦它出现，它往往会吸引其他应用程序和服务，这一概念通常被称为数据引力。

“这是因为数据湖很难移植，而且成本很高，因此最终成为重心，”Gartner 分析师 Marco Meinardi [在去年秋天的一份报告](https://blogs.gartner.com/marco-meinardi/2020/09/04/adopting-kubernetes-application-portability-not-good-idea/)中说。

麦克法丁说:“看看这些大云在做什么。”“如果云提供商能说服你在他们的云中使用他们的专有数据库，你可能永远不会离开。就像吃了蓝色药丸一样。你完了。您不想继续使用您的云提供商了吗？来吧，移动你的数据，我谅你也不敢。”

但是，转换供应商的能力让企业能够货比三家，寻找最佳交易。

“商品化是关键，”麦克法丁说。“商品化是他们协商价格和获得长期节约的方式。云现在没有产生大量的商品，但 Kubernetes 正在迫使它们成为一种商品。”

借助便携式容器，公司可以跨多个公共云创建虚拟数据中心，并针对价格或性能进行优化。“如果我卖不出好价钱，我可以把它捡起来，搬到别的地方去。”

他说，支持 Kubernetes 上的数据是公司一直缺失的可移植性难题的最后一块。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>