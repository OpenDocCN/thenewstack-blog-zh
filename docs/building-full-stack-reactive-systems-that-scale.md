# 构建可扩展的全堆栈反应式系统

> 原文：<https://thenewstack.io/building-full-stack-reactive-systems-that-scale/>

[](https://twitter.com/kvnwbbr)

[Kevin Webber](https://twitter.com/kvnwbbr)

[Kevin Webber 是《从 O'Reilly 迁移 Java 到云》和《IBM Developer 实践中的反应》系列的作者，他是一名架构师和技术领导者，拥有超过 15 年构建大规模企业系统的经验。Kevin 目前在教育技术领域工作，应用全栈反应式开发的原则来帮助提高 K-12 识字率。他之前的一些角色包括 Lightbend 的开发人员，在那里他致力于提高对 Scala、Play 和 Akka 等反应式计算和技术的认识，以及沃尔玛加拿大现代化项目的技术负责人，帮助将 walmart.ca 转变为使用 Lightbend 平台的现代反应式系统。](https://twitter.com/kvnwbbr)

[](https://twitter.com/kvnwbbr)[](https://twitter.com/kvnwbbr)

几十年来，我们一直专注于基于计算机的系统的“组件”:前端、后端、数据库、服务器。我们分别开发、部署和优化了这些组件。不幸的是，在一些组织中，美妙的和有意的用户体验成为组件本身的次要关注点。如果后端构建在大规模数据库模式、复杂的 SQL 连接、两阶段提交和一大堆其他自我施加的限制之上，以及减缓或停止创新的过时流程，那么创新的用户体验将始终受到影响。可以肯定地说，未来最具创新性的用户体验不会建立在过去的 CRUD 系统之上。

最有效打破过去枷锁的公司将会胜出；不仅通过改善用户体验赢得市场份额，还赢得人才争夺战。开发人员从来没有在花时间的地方有更多的选择。全栈反应意味着从我们持久化数据的方式到我们构建团队的方式都需要适应不断变化的环境。

以 [Spotify 工程模型](https://medium.com/the-ready/how-to-build-your-own-spotify-model-dce98025d32f)为例，包含小队、部落、分会和公会。这是一个公司在从技术到人员的各个层面都保持被动的很好的例子。或者是“[逆康威策略](https://www.thoughtworks.com/radar/techniques/inverse-conway-maneuver)”，即一家公司围绕其系统的理想架构进行重组。保持流动性和灵活性的公司已经接受了一些反应性原则。但是结构和过程只是开始。我们需要从我们希望交付的用户体验开始向后工作，并重新思考我们从头开始实现系统的方式，以便交付那些体验。如果你喜欢播客而不是阅读文章，我最近在 Lightbend 上做了一个关于全堆叠反应式系统的网络研讨会，你可以在这里听听。全堆栈反应式系统基于 2014 年发布的[反应宣言](https://www.reactivemanifesto.org/)的原始原则。

### 事件风暴、过程建模和领域驱动设计

反应式系统的迷人之处在于它们与实际业务本身的接近程度。以支票清算这样的业务流程为例。如果不完全理解支票清算是如何工作的，并且没有业务专家的输入，技术专家可能会试图将其建模为 100%一致和 100%可靠的交易。然而，业务流程包含一些概念，如最终一致性(在支票清算前有权使用现金)和错误补偿，而不是防止错误(人工后台流程有助于在清算期间纠正问题，而不会向用户抛出异常)。

通过像[事件风暴和领域驱动设计](https://blog.redelastic.com/corporate-arts-crafts-modelling-reactive-systems-with-event-storming-73c6236f5dd7)这样的技术将技术专家和商业专家聚集在一起，我们给技术一个完整的席位，既贡献想法又了解业务本身。只有这样，我们才能开始意识到技术给具有前瞻性思维的公司带来的真正的竞争优势。真正令人兴奋的是，传统技术中心之外的公司，如湾区和纽约市，也可以获得这种竞争优势，并将其应用于各种行业。

你可以选择任何一项业务，不管它有多复杂，通过思考该业务中发生的每一件有趣的事情来讲述一个关于该业务的故事。事件仅仅是“过去发生的有趣的事情”通过考虑事件是如何流动的，而不是组件的结构或层次，我们有能力构建非常类似于业务实际工作方式的系统。

现在，我们如何给事件流添加结构，以便我们可以实际上基于事件风暴练习构建一个系统？本质上，我们将在事件流和微服务集合(或其他实现细节)之间有一个增量。领域驱动的设计有助于为这个流程带来一个结构，使我们更接近一个全面的蓝图，我们可以用它来创建软件组件。有界上下文等概念可以帮助我们确定应该在哪里定义微服务边界，聚合根可以为我们指出如何处理微服务边界内的状态和状态转换。

### 电抗前端

我们需要改变我们对前端的定义。想象一下，当每个人都在自己的家庭办公室里拥有类似 Oculus Rift 的东西时，商业生产力工具会是什么样子？如果您正在考虑构建一个与各种客户端交互的后端，从其他系统到移动设备，再到 VR 头戴设备等未来接口，您真的想要一个笨重、过于复杂的关系数据库和单片后端平台来支持这些体验吗？

考虑一下电子商务中的物理体验——也许我在增强现实驱动的镜子前试穿一件衣服，镜子上覆盖了其他颜色或合身的选项。我如何与镜子互动有助于训练镜子做出更好的建议。这些事件直接推动了用户体验，也推动了系统的核心智能——毕竟，事件也是机器学习的一个关键原料。这些数据可用于增强购物体验，从指导店内的新鲜互动，到根据商店级别或全球活动模式预购新库存。当我们依赖关系数据库时，甚至更糟的是，在数据库中改变数据(丢弃所有的状态变更日志)，我们丢失了难以置信的大量数据，而这些数据原本可以用来为我们的系统注入机器智能。

我们的“后端”系统越接近真实的人类语言，我们就能从实时用户体验和机器智能机会中获得越多的价值。当公司 A 正在通过多层委员会和批准运行一个想法，并协调几十个团队预先更改 API 和数据库模式时，公司 B 将在生产中试验新功能，并使用 A/B/n 测试、CI/CD、功能标志驱动开发等技术和实践每天多次调整它们，并基于预测分析预测未来事件。

B 公司的变化速度会比乍看上去更快。B 公司还采用了事件驱动的 pubsub 集成，因此一旦事件被发布并在整个组织中默认可用，新的团队就可以组建起来，而无需任何前期协调成本，如就 API 规范达成一致。一个新团队只需订阅实时领域事件，就可以开始构建一个全新的系统。想想“弹出式商店”或“弹出式餐馆”，但由于某些架构选择，能够快速组建一个新团队。这还不是一种主流的实践，但是在几年内，随着高性能团队接受异步发布-订阅而不是同步集成，这将变得更加明显，不仅是在单个团队内部，而是在整个组织中。

### CQRS 和活动采购

这一切在实践中是如何运作的？事件源是一种基本上避开关系数据库的实现技术。当事件应用于有状态的实体时，当前状态只是所有过去事件的总结。该视图通常预先计算(“投影”)到读取端查询存储，如数据库，并随着每个新事件保持更新。CQRS(命令查询责任分离)和事件源一起真正令人兴奋的是它如何很好地映射到实时系统。当我们将这些技术引入基于微服务的架构时，我们可以使用 CQRS 将应用程序的“读取端”与“写入端”完全分离，然后针对每一项进行独特的优化。这有助于通过消除不必要的工作从根本上提高每个通道的性能和可靠性，例如读取端通道上的 CPU 密集型 SQL 查询，这很容易导致几分钟的延迟。相反，我们可以将数据视图从写端投影到读端。唯一的权衡是一致性(视图在被查询时可能不是完全最新的)和额外的复杂性(维护一个单独的读写通道)。

这种方法并不适合所有人，但是对于非常关心弹性和性能的系统来说，这是一种非常好的方法。如果在复杂的查询过程中出错，与其让用户忍受微调器、延迟或错误消息，为什么不直接向他们展示我们现在已经计算好的数据的最佳投影呢？只要数据仍然与他们相关，那么它就是有效的实时数据，并且可以在没有任何用户体验风险的情况下呈现。总之，CQRS 在架构上支持读/写优化，而事件源是状态和原始数据的核心实现。本质上，通过事件源，我们总是知道一个实体处于什么状态，我们也知道它是如何到达那里的。当您将这两种技术结合起来时，我们可以用非常少的关系数据库技术构建一个完整的系统，也许将它们的使用限制在投影的存储上，这样您就可以继续在读取端利用 SQL。

### Kubernetes 和容器化应用程序的管理

使用像 Kubernetes 这样的技术从头开始构建一个反应式系统，使得各种团队更容易创建和管理容器管理的系统。我们不需要倾家荡产来实现某些特性，例如我们的平台能够按需向外扩展，然后在需求减弱时再向内扩展。在成本效益和出色的用户体验之间取得平衡不再像十年前那样痛苦，那时我们必须调配自己的物理或虚拟硬件。我们总是不得不过度配置资源，并希望使用率永远不会超过容量。那些日子已经过去了。

反应需要在各个层面上进行。它需要在组织层面上。它需要一直向下到服务器，一直向上到用户体验。函数式反应式编程和其他实现细节构成了全栈反应式的一个非常小的子集。

Lightbend 是新堆栈的赞助商。

照片由来自 Pixabay 的 Michal Jarmoluk 拍摄。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>