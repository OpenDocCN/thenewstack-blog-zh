# 生产中的机器学习:从部署我们的第一个 ML 模型中学到的经验

> 原文：<https://thenewstack.io/machine-learning-in-production-lessons-learned-from-deploying-our-first-ml-model/>

[](https://clearcover.com)

 [亚历克斯·波斯特

亚历克斯·波斯特是保险提供商 Clearcover 的数据工程师，致力于部署机器学习模型。在空闲时间，他喜欢看太空电影，打高尔夫球，和他的新小狗玩耍。](https://clearcover.com) [](https://clearcover.com)

[机器学习](https://thenewstack.io/category/machine-learning/)模型通常有两种类型:用于批量预测的模型和用于在生产应用中进行实时预测的模型。这些分别被称为离线和在线模型。离线模型需要很少的工程开销，有助于业务决策的可视化、规划和预测。

另一方面，在线模型需要大量的工程工作，用于通过推荐个性化客户体验。基于项目需求理解使用哪个模型是至关重要的，因为它不仅决定了部署过程，还影响了模型的训练方式。在这篇文章中，我将讨论我们在实时生产应用程序中部署第一个在线机器学习模型时面临的一些挑战，以及我们如何应对这些挑战。

当我们开始创建模型时，我们很少考虑模型在应用程序中的实际部署。我们在一个 [Jupyter 笔记本](https://jupyter.org/)中构建了我们的模型，该笔记本从我们的数据仓库中加载干净的数据模型，转换各个列，并生成一个模型。虽然这种方法对于快速迭代和试验非常有效，但是它在部署过程中导致了一些困难——特别是在特性提取、特性转换和可伸缩性方面。相反，我们需要找到一种方法来准确地执行这些操作，同时具有足够的可扩展性和灵活性，以便在未来的部署中重用。如果更有远见，我们可以大大减少将模型从笔记本转移到部署的应用程序所需的工程工作。

## 特征抽出

数据科学家至少要花 80%的时间准备数据，这是业内的常识。这是因为创建一个好的训练数据集通常需要我们从多个原始数据源收集数据，然后使用这些数据来创建可能预测我们的目标变量的新特征。在 [Clearcover](https://clearcover.com) ，我们有一个非常有才华的数据分析师团队，他们已经根据我们的原始数据构建了复杂的数据模型，以便跟踪我们的业务目标。我们发现这些预先转换的特征对于建模至关重要。虽然将数据模型直接导出用于预测建模很有诱惑力(我们甚至在一开始就犯了这种错误！)，跳过转换前的特性会给实时应用程序的部署带来严重的挑战。

出于报告目的而被限制在数据仓库中的数据模型通常被优化为以可预测的节奏在大量数据上运行。这与在生产机器学习应用中应该如何进行特征提取有着根本的不同。我们发现我们需要以不可预测的节奏从少量数据中提取特征，这意味着我们不能“按原样”使用数据模型此外，我们发现我们需要在 Python 而不是 SQL 中复制特征提取来满足我们的不同需求。这是因为我们部署的模型不接收数据模型提供的表格格式的数据。Python 为我们提供了以易于维护的方式解析半结构化数据所必需的工具。Python 的逻辑也为未来的工作奠定了基础，在未来的工作中，特性不是来源于传统的数据模型。

## 特征转换

特征变换是训练数据集的特征工程中的另一个重要步骤。这可能包括缺失值插补、宁滨和一键编码等流程。特征转换尤其棘手，因为生产数据是不可预测的。例如，定型数据中可能有一列没有缺失数据，因此定型数据不会估算该列的缺失值。但是，这并不一定意味着该字段永远不会有缺失值。忽略这样的边缘情况在最好的情况下可能意味着错误或延迟，或者在最坏的情况下可能导致模型中看不见的错误。当我们意识到这一点时，我们必须完全重写我们的特征转换代码，以确保每个特征都定义了一整套转换——即使这些转换不会导致训练数据的任何变化。

起初，我们使用不同的[熊猫](https://pandas.pydata.org/)方法来执行这些操作。但是我们很快发现，在部署时，这些方法无法满足我们的需求。例如，pandas 有一个名为“get dummies”的方法，它对于一次性编码非常有用，但只能用于训练数据，因为它需要了解某个特征的所有可能类别。在一次只有一个单独记录要评分的实时环境中，该方法只能知道一个可能的类别，这意味着一键编码列不能反映我们需要的适当类别。

[scikit-learn](https://scikit-learn.org/stable/) 模型被证明是解决这个问题的最佳方案，尽管它们对用户稍显不友好。Scikit-learn 提供了一个 API，允许以与训练和应用预测模型相同的方式训练和应用这些特征变换。这样，来自训练数据的知识可以被“记住”使用这样的模型要求我们像对待模型本身一样对待特征转换:每个特征转换都是根据训练数据训练的，经过处理，然后与我们的模型一起部署。

## 解决方案:功能存储

虽然我们能够在短期内克服这些挑战，但很明显，我们需要从根本上重新思考我们的功能工程基础设施，并牢记以下两点:

1.  特征工程应该专门从运行时可用的数据开始。
2.  产品应用和实验性 Jupyter 笔记本应该能够共享特征提取和特征转换的逻辑。

在 Clearcover，我们对这个基础设施的愿景是一个功能商店。在这种情况下，特征库是一个集中式数据库，它从我们的应用程序产生的原始数据中筛选机器学习就绪的特征。特征存储不仅需要维护数据本身，还需要维护用于创建数据的逻辑。这样，我们的生产模型就可以实时转换原始数据。通过集中功能创建过程，我们确保了培训模型和生产模型之间的功能一致性，同时减少了部署所需的工程资源。

作为一家初创公司，我们经常面临“是造还是买”的困境，这个案例也不例外。我们正在积极尝试开源和付费功能商店，尽管我们可能会发现这些都不符合我们的需求。我们选择的功能工程基础设施是决定 Clearcover 数据科学未来成功的最重要决策之一，这不是我们轻易做出的决定。我们对这个项目对整个保险行业的机器学习的影响感到兴奋，我们希望它也可以帮助其他人创新。随着我们沿着这条道路前进，我们将继续分享我们的挑战、成功和经验教训。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>