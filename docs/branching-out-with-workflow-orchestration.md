# HashiCorp Nomad 如何帮助放松大麻合规性和 Kubernetes 的复杂性

> 原文：<https://thenewstack.io/branching-out-with-workflow-orchestration/>

[](https://www.linkedin.com/in/frank-lacalamita-800a778/)

[Frank Lacalamita](https://www.linkedin.com/in/frank-lacalamita-800a778/)

[Frank 是 Ample Organics 的安全、基础设施和开发总监，也是产品创意和文化开发领域的知名领导者。他拥有超过 19 年的行业经验，涉及系统管理、云基础设施设计和运营管理。](https://www.linkedin.com/in/frank-lacalamita-800a778/)

[](https://www.linkedin.com/in/frank-lacalamita-800a778/)[](https://www.linkedin.com/in/frank-lacalamita-800a778/)

对于合法的大麻生产商和供应商来说，合规是生意兴隆和丢掉执照的区别。管理机构密切监管大麻产业的每个阶段，从温室到终端零售商。充足的有机物提供了技术基础设施，帮助大麻公司满足合规性。本质上，我们提供了他们生产的任何大麻产品的整个供应链的完整可见性。

2014 年我们在多伦多开始做医用大麻软件平台。当娱乐用大麻在 2018 年 10 月变得合法时，我们的业务蓬勃发展。每个人都跳上了大麻列车，他们中的许多人成了我们的客户。今天，大约 70%的加拿大市场，包括一些加拿大最大的特许生产商，都在我们的种子到销售软件平台上运行，以跟踪和报告生产和销售的每个阶段。

但是管理如此广泛和动态的服务并不容易。开发和部署新的特性和功能既耗时又耗费资源。我们还面临着数据驻留方面的独特挑战，因为根据法律，加拿大大麻公司必须将所有客户数据存放在本国境内，这限制了我们对数据中心和服务合作伙伴的选择。

为了遵守法规并继续满足客户和我们公司的业务需求，我们需要重新思考我们开发和部署特性和工具的方式，以及支持它的底层 IT 基础架构。

## Kubernetes 引起了精神健康问题

 [尤俊霖

Glen 是 Ample Organics 的云架构师。他是一名经验丰富的基础架构专家，在开发运维工程、基础架构和云架构方面拥有超过 10 年的经验。Yu 获得了瑞尔森大学电气工程专业的工程学士学位。](https://www.linkedin.com/in/glenyu/) 

过去，在我们加入团队之前，该公司已经采用 Kubernetes 来编排其容器化开发环境。每个人都认为它是众所周知的锤子，每个 it 问题都被视为钉子。

虽然最初的首次展示在我们还是一个小公司时效果很好，但很明显，从长期来看，它并不是一个快速增长和成熟的企业的正确工具。由于 Kubernetes 不提供供应商支持，并且由于我们独特的数据驻留要求禁止我们与美国托管服务提供商签订合同，我们只能靠自己来管理、配置和改造 Kubernetes 以满足我们的需求。

随着时间的推移，这就产生了许多需要解决的瓶颈和难题。特别是，每个客户端都有自己的集群，必须手动编辑，因为我们没有联合。当我们开始对我们的服务进行分层时，变化的数量和速度意味着只有特定的客户得到了他们所要求的。

更糟糕的是，它引发了对正常运行时间和可靠性的担忧。多年来，我们主要是一家亚马逊网络服务商店。大多数云提供商的数据中心位于 QC 地区的蒙特利尔，这意味着地理冗余和合理的灾难恢复策略基本上是不可能的。

这些正常运行时间问题蔓延到了其他领域。我们违反了与客户的 SLA。我们无法在截止日期前完成客户付费的其他项目，例如增强的特性和功能。在一个未来几年肯定会继续扩张的行业，这些都不是实现可持续增长和成功的途径。

我们意识到，我们需要一个具有自动化工作流的可扩展和高效的 orchestrator。它必须与云无关，能够从一个数据中心移动到另一个数据中心，并且需要提供安全高效地移动数据的选项，以帮助我们在遵守数据驻留要求的同时为全球客户提供服务。

## 致命的车祸终结了库伯内特的统治

我们通过使用 HashiCorp 的其他工具了解了他们，例如开源版本的 Vault 和 Terraform 来部署我们的资源。因此，研究它的编排工具 Nomad 是有意义的。

巧合的是，我们的 Kubernetes 星团已经在 2019 年 9 月崩溃了。这是对 Nomad 进行测试的最佳时机，因此我们指派一个团队重建我们的 Kubernetes 集群，另一个团队尝试另外建立一个 Nomad 集群。我们让我们的客户在两周内就在 Nomad 集群上设置并运行了，但是我们无法让 Kubernetes 集群恢复运行，这使得我们采用 Nomad 的决定变得显而易见。

> 过去，我们需要五个人来管理 Kubernetes，但是 Nomad 和我们的其他 HashiCorp 工具只需要两个人。

游牧者很容易聚集在一起。我们将 Kubernetes 部署清单转换成了 Nomad 作业文件，然后对其进行了测试。由于它是一个单一的二进制文件，所以很容易根据我们的特定需求进行配置，这消除了我们在 Kubernetes 中面临的许多复杂性。更重要的是，Nomad 的独立基础架构资源池和自动化工作流使我们能够在内部和任何私有或公共云环境中部署和管理我们的容器和应用，这极大地扩展了我们的数据中心选项，同时仍能满足我们的数据驻留义务。

Nomad 有一个很好的网络用户界面，所以它甚至适用于我们的一些一级支持团队。如果他们不熟悉命令行，他们仍然可以通过点击进入用户界面并找到所需的东西。他们不会碰 Kubernetes，担心一个按键会毁掉一切。现在，他们能够从我们手中接过一些支持问题。

作为 HashiCorp 生态系统的一部分，Nomad 是创建完整的、与主机无关的解决方案所缺少的一环。我们使用 Terraform 为新老客户部署资源，而 Nomad 确保我们的容器已经启动并使用适当的资源运行。它比 Kubernetes 有更好的资源分配和整合，所以我们现在不必部署那么多资源。我们使用 Vault 进行秘密管理，使用 Consul 进行服务发现，以减少我们需要的负载平衡器的数量。Consul UI 提供了一个清晰的视图，显示了正在运行的程序、每个客户端的版本以及其他类似的信息。我们已经通过咨询抵消了 5-10%的成本。

## Nomad 解决了我们的编排问题

从心理健康的角度来看，这一切都很棒。我们已经稳定了我们的性能，提高了我们的安全性，并且我们能够将更多的客户端和容器放入我们的资源中，以获得更高的生产率和效率。

过去，我们需要五个人来管理 Kubernetes，但是 Nomad 和我们的其他 HashiCorp 工具只需要两个人。现在有了额外的可用人员，我们可以重新利用以前忙于管理工作的团队成员。这帮助我们增加了客户项目部署，从每周 8 个增加到两小时内超过 125 个客户部署。

我们不仅能更快地完成更多的客户工作，而且做得更好。以前，我们每周至少有一两次部署失败。对于 Nomad，现在是 125 分之一，而且只是偶尔为之。当我们遇到超出我们能力的问题时，我们依靠 HashiCorp 的支持团队和资源来获得我们需要的答案和帮助。

很多人认为 Kubernetes 是众所周知的锤子，可以神奇地解决任何和所有的 IT 需求。我们在各种 Reddit 子网站上看到不少帖子，人们发帖希望他们早点尝试 Nomad，但他们不能，因为他们已经在特定的 Kubernetes 设置上投入了太多。但是不管你的公司有多大，我们还是建议你去看一看。HashiCorp tools 拥有您从企业角度所需的 90%的免费开源版本，以及良好的文档和教程。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>