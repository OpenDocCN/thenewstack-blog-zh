# Kubernetes 在生产中需要运行什么

> 原文：<https://thenewstack.io/kubernetes-needs-production/>

编者按:这一章最初出现在 2017 年 6 月，是我们在 Kubernetes 上的电子书系列的一部分。从那以后，一些技术得到了更新:仅在接下来的五个月里，就出现了两个新版本的 Kubernetes 和三个版本的 Kubeadm。此外，请注意，自从这篇文章首次发表以来，这里的一些材料已经被修改，以解决一些不准确的地方。

生产环境不再总是必须在物理上，甚至是虚拟上与开发环境隔离开来。也就是说， [Kubernetes](/category/kubernetes/) 开源容器编排引擎将会有超出开发或测试环境所需的生产需求。以下是你应该评估的关键因素，以及它们之间的区别。

## 弹性

在开始讨论之前，我们将重点关注 Kubernetes 的部署方式，使其能够在部分子系统故障的情况下存活。这种可生存性的质量通常被称为弹性(有时也称为弹性)。记住，Kubernetes 不是整个容器系统，而是部署在数据中心的一个实体。与任何其他数据中心软件一样，它也面临着相同的运行条件和长期威胁。当我们考虑在 Kubernetes 环境中维护可用性时，我们倾向于将其分为三个不同的方面:

1.  **基础设施可用性**决定了运行 Kubernetes 的基础设施是否是高度可用和分布式的，与环境无关。
2.  **Kubernetes availability** 确保环境永远不会出现单点故障，并确保编排系统的组件按照与基础设施相同的路线正确且按比例地分布。
3.  **应用程序可用性**关注应用程序，并确保所有 pod 和容器都达到正确的可用性级别。根据应用程序的需求，应用程序组件将松散地分布在 Kubernetes 环境中，而 Kubernetes 环境本身又分布在基础设施中。

 [贾纳基拉姆·MSV

贾纳奇拉姆·MSV 是贾纳奇拉姆公司的首席分析师，也是国际信息技术研究所的兼职教员。他还是 Google 认证的云开发人员、Amazon 认证的解决方案架构师、Amazon 认证的开发人员、Amazon 认证的 SysOps 管理员和 Microsoft 认证的 Azure Professional。Janakiram 是云本地计算基金会的大使，也是第一批获得认证的 Kubernetes 管理员之一。他之前的工作经历包括微软、AWS、Gigaom Research 和阿尔卡特朗讯。](https://www.janakiram.com/) 

由于 Kubernetes 可以安装在多个公共和私有基础设施即服务(IaaS)平台上，这些平台的功能和属性共同构成了 Kubernetes 安装的固有弹性。例如，IaaS 可以提供什么级别的分区？

您的公共云的 IaaS 平台由细分的部署位置组成。亚马逊网络服务称这些位置为“区域”，细分为“可用区域”，其他主要的云提供商也纷纷效仿。Kubernetes 可以跨这些区域部署。但是默认情况下，Kubernetes 总是部署一个主服务器，不管您有多少个区域。

处理这个问题的最常见、通常也是最推荐的方法是使用多主控 Kubernetes 环境。在这种情况下，只有一个主服务器被“选举”为活动主服务器，因此如果它关闭，将会选举一个新的主服务器。这个新的 master 然后用于处理 Kubernetes 环境的所有调度和管理。

Kubernetes 集群本质上是一组相关联的工作节点。由于您的业务价值的生成器正在这些集群上运行，因此将每个集群部署在尽可能多的可用逻辑分区上是有意义的。

请注意，将您的主节点专用于管理您的 Kubernetes 环境，并专门使用工作节点来托管和运行所有的 pods，这被认为是最佳实践。这使得 Kubernetes 和您的应用程序之间的关注点完全分离。

使用私有 IaaS，您仍然可以将服务器划分到区域中。虽然每个私有 IaaS 配置可能都像雪花一样独特，但它们有一些共同的概念。无论您的 IaaS 是公共的还是私有的，您的存储和网络分区都应该与您的计算分区相对应。在数据中心，您将拥有冗余存储区域网络(SAN)功能以及冗余架顶式和架尾式网络功能，这些功能反映了刀片式服务器机箱中的冗余。这样，您可以配置冗余的网络、电源、计算和存储分区。对于公共 IaaS，每个服务提供商以不同的方式处理存储和网络功能，尽管大多数都内置了分区冗余。至于联网，您应该利用 IaaS 的负载平衡器来公开 Kubernetes 服务端点。

[cyclone slider id = " kubernetes-series-book-1-赞助商"]

最终，来自 IaaS 的所有这些低级的弹性允许 Kubernetes 支持副本集，这确保了指定数量的 pod 副本在分区间一致地部署。这样，Kubernetes 可以自动处理分区故障。Kubernetes 的最新版本实现了一种称为部署的副本集超级结构，其中每个副本集都包含一个称为部署对象的实例。该对象指示部署控制器自动管理副本集，定期刷新它们，以便它们尽可能接近您声明的所需配置。

通过这种方式，您的 pod 可以在断电事件中跨幸存区域重新平衡，而无需操作员执行特殊操作。更直接地说，在声明节点时，可以将节点的故障域指定为显式注释。您可以定制调度程序以满足您的特定需求，并确保它可以跨节点或跨您的特定基础架构进行复制。

我们过去实现这一点的方法之一是通过 [nodeAffinity](https://kubernetes.io/docs/concepts/configuration/assign-pod-node/) (以前是 nodeSelector，[在 Kubernetes 1.6](http://blog.kubernetes.io/2017/03/advanced-scheduling-in-kubernetes.html) 中有所改变)，它告诉调度器当一个调度事件发生时，哪些节点应该受到影响。这确保了应用程序级可用性与基础架构分区保持一致，从而消除或至少减少了基础架构出现故障时的停机时间。

## 建立工作关系网

*(编者注:在进一步审查材料的准确性之前，这一部分已被暂时删除)。*

 [克里斯南·萨勃拉曼尼亚，瑞希多研究公司。

Krish Subramanian 是 Rishidot Research 的创始人，rishi dot Research 是一家专注于现代企业、应用平台和智能平台的研究和咨询公司。他为首席信息官和企业决策者的现代化战略提供建议，也是许多初创公司的顾问。此前，他是 CloudMunch 的战略副总裁和 Red Hat 的 OpenShift 战略总监。](http://rishidot.com/) 

## 储存；储备

容器最适合 12 因素无状态应用程序，在这种应用程序中，服务响应请求，然后消失，什么也不留下。可以想象，这是一种非常新的——对许多企业来说是陌生的——呈现应用程序的方式。而且它根本无法转化为现有应用程序的存储密集型模型，这些应用程序的生命周期尚未完全摊销。

Kubernetes 同时支持有状态和无状态应用程序，增加了对持久卷的支持——特别是持久卷子系统——以及对动态配置的额外支持。这允许在 Kubernetes 集群上支持遗留的和其他有状态的应用程序，从而使 Kubernetes 成为对企业有吸引力的候选。orchestrator 支持附加到 pod 的卷以及外部持久卷。

[cyclone slider id = " kubernetes-series-book-1-赞助商"]

Kubernetes 中的卷不同于 Docker 中的卷概念。Docker 卷附加到容器，而 Kubernetes 卷与 pod 相关。因此，即使容器内的容器关闭，容积仍保持不变。但是，Kubernetes 卷仍然是短暂的，这意味着它将在 pod 终止时终止。在拥抱 Kubernetes 时，你必须在头脑中保持这两个同名的概念的不同。

Kubernetes 通过将存储抽象化，并提供一个 API 供用户使用和管理员管理存储，为有状态应用程序提供支持。在 Kubernetes 中，卷是通过 PersistentVolume 子系统外部化的，PersistentVolumeClaim 是 pods 如何以无缝方式消耗 PersistentVolume 资源的。具体来说，它在豆荚内部的容器之间建立了一种联系，以及一种将在那些豆荚的生命周期之后继续存在的体积。

> 简单地说，很少有人能够直接访问 Kubernetes 节点。

Kubernetes 为来自云供应商的各种存储产品提供逻辑文件系统挂载选项，例如网络文件系统(NFS)、GlusterFS、Ceph、Azure SMB 和 Quobytes。Kubernetes [存储特别兴趣小组](https://groups.google.com/forum/#!forum/kubernetes-sig-storage) (SIG)目前正致力于通过外部化插件支持，使添加对新存储服务和系统的支持变得更加容易。

在开始将现有应用程序过渡到像 Kubernetes 这样的分布式系统环境之前，您应该确保现有应用程序的存储需求得到支持。

## 安全性

容器化改变了数据中心的整个安全概念。编排又一次改变了它。因此，公平地说，您可能已经在应对并管理您的数据中心向新安全模式的过渡。Kubernetes 在这张图片中的插入影响了该模型可能要改变的内容。

与 Kubernetes 环境中运行的工作负载相关的安全主题分为三类:

*   *   **应用层:**会话建模，数据加密，节流。
    *   **平台级**:密钥管理、数据存储、访问限制、分布式拒绝服务(DDoS)保护。
    *   **环境安全:** Kubernetes 访问、节点访问、主节点配置、etcd 中的加密密钥/值存储。

### 节点访问

简单地说，很少有人能够直接访问 Kubernetes 节点。每次你授予某人这样的权限，你都在承担风险。用户不需要直接访问主机，而是可以运行 kubectl exec 来获得容器及其环境的可见性，而不会引入安全漏洞。

如果你需要细粒度的、容器级的安全性，运营商可以通过 Kubernetes 的[授权插件](https://kubernetes.io/docs/admin/authorization/)对访问进行微调。这些插件能够限制特定用户对某些 API 的访问，并防止意外更改系统属性，如调度程序选项。

### 名称空间

Kubernetes 允许应用程序安装在不同的名称空间中。这在应用程序之间创建了一个轻量级的边界，并有助于恰当地划分应用程序团队。这样的边界用于防止意外部署到错误的 pod 或集群，并允许在每个名称空间上建立固定的资源约束(配额)。比如，你可以在生产中给每个由[微服务](/category/microservices/)组成的 app 赋予自己的命名空间。这允许一个单一的 Kubernetes 环境托管许多应用程序，而没有应用程序之间冲突的风险(通过名称空间)。

名称空间充当工作负载的逻辑边界，它将应用程序的范围限制在系统中应用相同名称的部分。从技术上讲，名称空间代表由同一个物理集群支持的多个虚拟集群。这首先使集装箱化成为可能。

### 资源配额

[资源配额](https://kubernetes.io/docs/concepts/policy/resource-quotas/)提供了限制每个名称空间的总资源消耗的约束。您的企业 IT 团队应该创建多个名称空间，每个名称空间都有自己的配额策略。这样，每个策略都可以限制工作负载可能消耗的 CPU、内存和存储资源的数量。

此外，资源配额可以防止单个 pod 扩展到耗尽所有资源的程度。如果没有资源配额，恶意来源很容易对应用程序进行拒绝服务(DoS)攻击。在最高级别，可以在 pod、命名空间或群集级别设置资源配额，以监控 CPU、内存、存储空间或请求。您的具体需求将由您的应用程序和可用资源决定，尽管您必须建立资源配额。

[cyclone slider id = " kubernetes-series-book-1-赞助商"]

### 网络分段

在同一个 Kubernetes 集群上运行不同的企业应用程序会产生一个受威胁的应用程序“攻击”相邻应用程序的风险——不是通过黑客攻击，而是通过被动干扰它们共享的网络中的流量。网络分段确保容器只能与策略明确允许的其他容器通信。通过使用防火墙规则创建子网，管理员可以为 Kubernetes 集群中运行的每个工作负载实现适当的隔离级别。

对网络进行分段可以确保没有两个系统可以共享资源或调用错误的 pods，这是保护应用程序的一种非常强大的方法。但是要小心:很容易成为诱惑的受害者，并且过度使用您的分割策略，导致环境不仅更加难以管理，而且在开发团队中产生了一种虚假的安全感。

### 机密管理

 [肯赞·克雷格·马丁

克雷格·马丁(Craig Martin)是肯赞的工程界 SVP，他领导着工程运营部门，自称的使命是找到应对复杂挑战的优雅解决方案。在他的职位上，Craig 帮助领导公司的技术方向，确保探索新的和新兴的技术并将其纳入战略愿景。最近，克雷格一直专注于通过构建大规模微服务应用来帮助公司进行数字化转型。他长期从事专业服务领域的定制软件开发，在加入 Kenzan 之前，Craig 是 Flatiron Solutions 的工程总监。他在乔治梅森大学获得了理学学士学位。](http://kenzan.com/) 

Kubernetes 具有内置的秘密存储功能，即通常与正在运行的应用程序相关的离散值，但不应与其他应用程序或任何人共享。当您将某个内容定义为秘密时，它将独立于 pod 存储，确保它在静止时被加密。一个 pod 只被授权访问在其 pod 定义文件中定义的机密。在容器启动时，向容器提供秘密，以便可以适当地使用它们。

Kubernetes 提供了一种机制，通过环境变量的方式让容器可以直接使用机密。具体来说，您在 pod 定义文件中定义了 [secretKeyRef](https://kubernetes.io/docs/concepts/configuration/secret/) 变量。

作为 Kubernetes secrets 的补充，你可以选择使用另一个秘密管理工具，比如[金库](https://www.vaultproject.io/)。专用于密钥管理的应用程序通常提供更健壮的特性，比如密钥轮换。

例如，软件工程公司 [Kenzan](https://kenzan.com/) 一直对使用 secretKeyRef 方法犹豫不决，指出将秘密直接写入每个人都知道其名称和位置的属性文件并没有太多的步骤。应用程序之间的秘密不一定是人与人之间的秘密，也不一定是关于人的秘密，但是为不想被看到的东西提供方向和地图从来都不是一个好主意。

### 存取管理

除了网络分段之外，两个 pod 之间几乎没有安全性。对于许多数据中心来说，这是一个严重的问题，因为坏人可能会访问集群，或者至少触发网络错误，然后所有服务都会暴露。

您可能会发现最好制定某种级别的内部安全控制来验证 pod A 可以调用 pod B，假设这些交互是策略允许的。类似 JSON Web Token (JWT)声明(一种基于 JSON 的断言，用于帮助验证真实性)这样的带有短期签名密钥轮换的东西在这里似乎很好。通过在 JWT 中提供角色，这允许对每个特定端点的安全需求进行非常细化，并且还确保了频繁的 JWT 私钥轮换(我们建议每一两分钟轮换一次)。使用这种模型，任何设法穿透防御并进入网络的人在没有签名的 JWT 的情况下仍然不能成功地拨打电话。一个签名的 JWT 只在一两分钟内有效。

## 最后

您已经看到了许多与 Kubernetes 日常维护和保养相关的关键因素，以及与 Kubernetes 互操作的网络。您和您的组织可能不愿意在对需要准备的内容没有一点了解的情况下，就做出影响应用程序试运行、监控和操作所有方面的部署决策。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>