# 可信交付:基于策略的合规性 GitOps 方式

> 原文：<https://thenewstack.io/trusted-delivery-policy-based-compliance-the-gitops-way/>

[](https://uk.linkedin.com/in/jordimoncompanys)

 [乔迪·蒙公司

乔迪是 Weaveworks 的产品营销总监。他是一名开源产品专家、社区建设者和公共演说家。他是 OpenUK 和 PMM 联盟大使，常驻伦敦。](https://uk.linkedin.com/in/jordimoncompanys) [](https://uk.linkedin.com/in/jordimoncompanys)

SecOps 团队的一个关键优先事项是验证策略和其他防护栏在每个版本中都存在。在一个自动化程度不断提高的世界里，这正成为一项挑战，因为运营自动化是以牺牲合规性为代价的。在本帖中，我们将探讨一种现代的、声明性的和基于策略的方法，将合规性构建到系统的每个步骤中。我们描述了一种有效的方法来管理对软件交付实践的变更控制，并将更多的控制权交给法规遵从性和 SecOps 团队。

执行引擎由 YAML 配置文件定义。这可以说是软件交付工具链中最过度延伸和滥用的部分之一。这很可能是任何关注法规遵从性的人最头疼的问题，因为这些配置文件被滥用可能会导致无法对流程进行故障排除或审计。

但是，如果控制这个配置文件的一个或多个策略的定义是一成不变的呢？如果此策略将成为排除任何不符合部署的过滤器，会怎么样？如果任何人都可以修改该策略，只要法规遵从性团队批准它，会怎么样？这些场景在 Kubernetes 的声明世界中是可能的。

## 合规性的证据

首先，让我们看看整个过程是如何工作的。这种基于策略的系统背后的关键思想是为每个策略提供一个明确的“证据点”。这包括在软件交付管道的以下关键阶段进行检查:

1.  用代码
2.  在配置中
3.  在管道飞行前检查中
4.  在部署后运行时检查中

如果以这种方式实现，它将表明端到端的安全交付是有保证的。这将保证发布的代码的完整性。

现在，为了深入了解这在一个由 git 存储库、持续集成/持续交付(CI/CD)管道和 Kubernetes 管理的基础设施组成的现代系统中实际上是如何工作的。

## Git 在法规遵从性中的作用

策略可以以声明格式定义，并存储在特定 git repo 的代码中。这是至关重要的一步，因为 git 带来了强大的变更管理功能，比如版本控制和细粒度的访问控制。这样的回购将只为合规团队提供管理权限。然而，与任何 git repo 一样，存储在其中的源代码对来自组织内任何人的拉取请求都是开放的。这给了开发团队他们需要的自主权，同时没有牺牲合规团队需要的控制水平。这些策略可以在任何执行引擎中实现，无论是 CI 引擎还是 CD 引擎。

利用 git 执行策略解决了在代码和配置中获得证据的前两步。现在我们已经有了流程的 git 部分，让我们看看执行引擎的角色。

## 将 GitOps 编织为执行引擎

假设一个核心模板集存储在一个遵从性 repo 中，以减少清单维护。下一步是让执行引擎在部署前应用这个模板集。执行引擎有很多选择，但是出于本文的目的，我们将讨论 [Weave GitOps](https://www.weave.works/) 。在运行时，可以将 Weave GitOps 配置为从法规遵从性报告中获取和部署清单的特定子集。然后，Weave GitOps 将部署包含在这些清单中的策略，这反过来将定义环境配置和访问权限，以及其他已经定义的策略变量。这可以在单个 Kubernetes 集群上执行，也可以在多个目标集群上执行，从内部部署到云，再到边缘。

## 管理生产中的漂移

有了这种预部署策略显示，我们可以确信没有任何东西可以违反它。但是，即使在部署后阶段，也可能引入与设定的遵从性策略相违背的更改。端到端法规遵从性还需要考虑生产环境。

同样，Weave GitOps 在防止漂移方面也起着关键作用。Weave GitOps 持续执行健康检查，将目标环境中运行的内容映射到合规性报告中预定义的策略。如果检测到任何漂移，Weave GitOps 就会发出警报，确定 Kubernetes 集群中的确切变化。如果更改是合法的，那么需要对 git 中的策略模板进行简单的编辑，以适应将来的这种更改。

在许多情况下，漂移需要校正。在这里，Weave GitOps 既可以回滚到以前的兼容状态，也可以覆盖手动更改会强制执行的任何漂移。这就是 git 的版本控制不可或缺的地方。Weave GitOps 允许您选择以前的兼容状态——无论是一个拉请求还是几十个拉请求——并回滚到那个特定的状态。

## 结论

随着自动化大大提高了部署的速度和频率，法规遵从性团队一直在努力跟上步伐。这种妥协不能再被忽视了。由于 Kubernetes 和 git，软件栈变得越来越具有声明性，所以遵从性也应该变得具有声明性。

实施这种合规性需要 git 的版本控制、访问控制和协作能力。此外，它还需要增加一个执行引擎，如 Weave GitOps，以控制前期和后期制作阶段。当以这种方式实现时，可信交付成为规范。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>