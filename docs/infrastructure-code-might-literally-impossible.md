# 漏洞百出的软件粉碎了基础设施即代码的梦想

> 原文：<https://thenewstack.io/infrastructure-code-might-literally-impossible/>

我们中的许多人认为基础设施即代码是某种已知的东西，或者至少是事情如何完成的一种可能性。

但是在 OSCON 欧洲大会上，[乔·达马托](https://twitter.com/joedamato)，他是 [Packagecloud](https://packagecloud.io/) 主机服务提供商的创始人兼首席执行官，讨论了试图以编程方式管理基础设施软件的一些挑战和陷阱。

“今天，人们将基础设施作为代码来使用……取得了不同程度的成功，在许多情况下也带来了巨大的痛苦，”他说。

在许多情况下，这些挑战来自于所使用的语言和特定硬件的多种组合。

1999 年，AMD Opteron 修订版 E 和预发布修订版 F 处理器在处理原子指令的方式上有一个硬件缺陷。这种类型的错误对于某些类型的应用程序来说可能是灾难性的，尽管可以构建防止硬件错误的软件。达马托说，“MySQL 很棒……MySQL 检测到了这个错误，并防止了硬件错误破坏你的数据库。”他写了一篇[博文](http://timetobleed.com/mysql-doesnt-always-suck-this-time-its-amd/)，如果你想了解更多关于这个问题的血淋淋的细节。

“不同的语言有不同的权衡，”达马托说。像汇编、C 和 C++这样的语言更难，但是它们不那么抽象，可以用于防御。他接着说“有些语言被认为很容易，但是非常难”，比如 Ruby、Perl 和 Bash。“你必须是 C 语言专家才能写出好的、快速的 Ruby，”他说。

他提供了一个故事来说明这个问题，其中涉及到 Ruby VM 实现中与 MRI(Matz 的 Ruby 解释器)segfaults 和 MRI 线程相关的两个特别隐蔽的错误。segfault bug 是垃圾收集和对象分配器工作方式中的一个设计错误造成的，问题是因为它隐藏在 VM 中，所以当你用 Ruby 编程时，你对此无能为力。线程错误导致使用了一组错误的系统调用，这导致了严重的性能问题。

这个故事的寓意是“你的代码在你的参考框架之外做事情……除非你已经从头到尾读完了每一行(你没有)，”达马托说。

这类问题会导致事情非常失败。例如，达马托回忆说“一个核磁共振成像错误曾经导致木偶占用 CPU”，这导致一个木偶运行需要 20 多分钟，而不是几分钟。他提到解决这个问题的唯一方法是修复 Ruby 中的底层错误，他推测这就是为什么 Puppet 说他们正在重建他们的客户端技术堆栈。

达马托说，Chef 遇到了类似的问题，Chef“[Ohai](https://docs.chef.io/ohai.html)在 Solaris 11、Ubuntu 12.04 上崩溃”是因为 Ruby VM 中的垃圾收集错误。解决方法是禁用垃圾收集器，完成所有工作，然后重新启用垃圾收集器。换句话说，“解决方法是禁用该语言的一个主要特性。”

诸如此类问题的结果是，它们使得以编程方式改变您的基础设施的想法变得极其困难，如果不是完全可能的话。

“在我们找到建造计算机系统的更好方法之前，我们将无法拥有真正可再生的基础设施，”他说。“我们需要对我们的技术选择和分析更加诚实和负责。”

另一个障碍:“在大多数 Linuxes 上安装一个安全的程序是不可能的，”他指责道。

例如，结合使用 **[百胜](https://access.redhat.com/solutions/9934)** 安装程序和 [GPG](https://www.gnupg.org/) 加密工具，“在大多数时候都不起作用，而且几乎不可能让它工作。”

他说，在百胜，pygpgme 包是 GPG 所必需的，但是当它没有安装时，百胜不会验证它，只是静静地失败，就好像什么坏事也没发生一样。为了验证存储库元数据，还需要使用 **repo_gpgcheck** ，但是绝大多数人并不使用它，因为它通常默认是禁用的。至于 GPG V3 的签名，他指出它们非常复杂，并继续说大多数人没有时间去学习所有这些并弄清楚如何让它安全地工作。

这不仅仅是一个美味的问题。达马托对 APT 打包工具和 GPG 有着相同的总结，这是一个组合，也“在大部分时间里不起作用，而且几乎不可能让它工作”有使用 **debsigs** 或 **dpkg-sig** 的选项，因为两者都可以签署 deb 包，但是他们不理解对方，所以你需要确保你总是使用同一个。然而，它们通常在默认情况下是禁用的，而且 Ubuntu 和 Debian 库也不使用 GPG 签名，所以他认为这有点无意义。

达马托谈到了 APT 和百胜集团的其他一些问题:

*   "两者都容易受到重放攻击."
*   "也不处理密钥撤销."
*   "两者都容易受到几起与 GPG 相关的攻击."

很大一部分问题是，关键的东西是建立在脚本层和其他代码层之上的，没有人能够完全理解所有这些层。

“在这些软件系统上赚了数十亿美元的大公司应该主动投资，让它们变得更好，”达马托总结道。“我们还没有找到‘答案’。我们拥有的比我们曾经拥有的更好，但我们需要想得更大。”

声明:Dawn Foster 于 2012 年至 2015 年在 Puppet 工作，目前拥有 Puppet 的股票。

特征图像由威斯康星州自然资源部， [CC BY-ND 2.0](https://creativecommons.org/licenses/by-nd/2.0/) 许可。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>