# Excel:你不知道自己拥有的函数式编程工具

> 原文：<https://thenewstack.io/excel-the-functional-programming-tool-you-didnt-know-you-had/>

Haskell 的创造者[西蒙·佩顿·琼斯](https://twitter.com/simonpj0)最近宣布他将离开[微软研究院](https://www.microsoft.com/en-us/research/)。他在那里的[工作](https://www.microsoft.com/en-us/research/people/simonpj/)专注于教育计算，以他的函数式编程研究为基础。近年来，他从事了一项有趣的工作，与 Excel 函数团队一起扩展函数编程环境的功能。

得益于函数，Excel 已经成为最流行的开发工具之一。许多业务都是建立在 Excel 电子表格之上，代码是由不知道自己是开发人员的人编写的，更不用说他们使用的是函数式编程语言。正如 Peyton Jones 在 2003 年的一篇论文中指出的，电子表格的结构有些独特，迫使开发走函数路线。

我们称 Excel 代码为“函数”，因为它们对单元格执行数学运算。

## Excel 作为代码

如果您将这些单元格公式放在一个文本文件中，您可以很快看到它的代码。单元格编号是变量，您正在编写将单元格链接到单元格的代码，更改会影响到您的电子表格。

传统的程序可能最好被认为是一维的，程序中的每一步都会改变变量。

电子表格的结构改变了这一点，为您提供了一个二维结构，其中操作在您的编程表面上呈扇形展开。

这是参与者/消息模式的一个非常简单的版本。每个单元格都是一个单独的 actor，包含一个非常简单的函数程序，您只能使用 Excel 提供的函数，对一个单元格的任何更改都会变成一条消息，触发另一个单元格(或其他几个单元格)中的函数。

Peyton Jones 在 2003 年关于该主题的早期论文显示了他指导 Excel 公式语言开发的方向，填充了核心原语，使微软能够在不破坏现有代码的数十亿个单元的情况下扩展该语言。这是一系列从新的数据类型开始的变化，赋予单元格更像对象的行为，同时仍然允许原来的字符串和数字工作。

微软 Excel 产品负责人布莱恩·琼斯将这一过程描述为“思考缺失的核心原语是什么，这将使[Excel]更健壮，更不容易出错，并且实际上使人们可以做更多的事情。”

## 数据优先…

这些新的数据类型帮助扩展了 Excel 作为数据转换工具的作用。

如果您使用过其数据导入工具的最新版本，您应该熟悉这些新功能，因为它们可以更容易地从许多不同的来源获取数据，并在熟悉的电子表格中处理这些数据。

我最近一直在用它来分析大规模的 JSON 数据结构，将原本是 [MongoDB](https://www.mongodb.com/cloud/atlas/?utm_content=inline-mention) 或类似的 JSON 文档转换成电子表格，然后使用公式来处理这些数据。

扩展数据类型允许微软将 Excel 扩展到其他数据平台，例如与 [Wolfram](https://www.wolframalpha.com/) 的合作。在这里，电子表格中的数据可以链接到 Wolfram 的精选内容，允许它填充其他相关数据。地理数据可以直接链接到相关的人口统计信息，或食物到营养数据，有一百多种数据类型。

## …然后是命名变量

添加新类型只是使 Excel 的内置编程工具更像通用编程语言所需的一部分。在过去一年左右的时间里，微软已经开始添加这些功能，首先添加了一个新的 LET 指令，以提供与单元格内容无关的公式内变量，这些变量可以在电子表格的公式之间共享。

LET 提供了两个重要的特性。首先，它给你一个工具来命名你的表达式的值，而不是引用它们作为单元格引用。这使得您的 Excel 代码更容易阅读，因为用户不必一直回头看单元格来理解他们正在处理的代码的上下文。其次，它加快了操作速度。在没有 LET 的情况下，如果您将一个表达式复制到另一个单元格中，它会再次计算该表达式，即使您只想在不同的计算中重用该结果。使用 LET，它只计算一次，可以在应用程序中多次引用。如果一个表达式被频繁使用，这可以显著提高性能。

LET 语句的结构是一组与计算相关联的键值对。关键字是名称，值是标准的 Excel 单元格引用。这确实改变了表达式的结构，但是总的来说，好处超过了额外的输入。

## …最后，LAMBDAs 和 Excel 图灵终于完成了！

虽然 LET 语句使 Excel 公式更像代码，但 LAMBDA 的引入彻底改变了 Excel 编程，允许您将函数包装成可重复、可重用的函数。现在，代码只需编写一次，就可以在电子表格中使用，没有复制错误或打字错误的风险。更重要的是，LAMBDA 是递归的，所以公式可以调用自己——或者更好的是，调用另一个 LAMBDA，从而允许您在几个单元中快速构建复杂的程序结构。正如 Jones 指出的，这意味着“Excel 现在是图灵完整版了！”

可重用函数对 Excel 来说并不陌生；你已经能够用像 JavaScript 这样的语言来构建它们。但这需要学习多种语言并依赖 API。有了 LAMBDA，你就可以用 Excel 熟悉的公式语言编写代码了。可以在工作表中获取代码并构建库，这些库可以在整个团队中共享，例如，用于计算抵押贷款付款的 LAMBDA，或者用于为 Azure 或 [Amazon Web Services](https://aws.amazon.com/?utm_content=inline-mention) 基础架构提供伸缩信息的 LAMBDA。

LAMDA 的结构非常简单。它接受一个或多个输入，然后对这些值进行计算，并在其单元格中返回响应。您可以通过向公式中添加单元格标识符来测试 LAMBDA(当您准备将其作为命名函数发布时，可以删除这些标识符)。所以一个基本的 LAMBDA 将两个数相加，看起来像这样:

要对单元格 A1 和 A2 中的值进行测试，只需添加单元格引用。

一旦你确定你的 LAMBDA 已经可以使用了，你需要暂时离开电子表格单元格，使用 Excel 的名称管理器创建一个命名函数。

创建一个新名称，添加一个范围，任何注释，以及您的 LAMBDA 代码(没有测试单元引用)。一旦指定了名称，就可以用新名称调用函数，同时传递单元格值，就像对待任何 Excel 内置函数一样。

名称管理器对于应用程序开发来说不是最好的用户体验，但目前它适合 Excel 的工作方式。这可能是 Excel 函数式编程体验的一个缺点，有时您必须跳出工作表开发流程，使用其他工具。

但这也是第一次尝试新的工作方式，因此我们可以期待未来的变化，这将使 Excel 开发更加自然，并提供更好的调试和代码共享选项。

LET 和 LAMBDA 的结合填补了 Excel 编程中的一个大洞，为我们提供了快速构建复杂自定义函数所需的工具。

其结果是，这种语言提供了我们期望从函数式编程中获得的许多特性，以及我们期望从生产力工具中获得的可访问性。

毫不奇怪，这是微软用 Excel 衍生的 PowerFX 构建低代码平台的模型。正如琼斯所说，“知道如何编写公式的人比知道如何编写 JavaScript 的人多得多。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>