# 我们的裸机云如何跟上所有新的操作系统版本

> 原文：<https://thenewstack.io/how-our-bare-metal-cloud-keeps-up-with-all-the-new-os-releases/>

当您运行裸机云服务时，您会花费大量时间来确保您的硬件支持所有最新版本的流行操作系统。每个新的操作系统版本都必须在您设备中的每个服务器配置上进行验证，并且已经在列表中的每个操作系统都必须在您添加的每个新服务器配置上进行测试。

 [莎拉·芬克豪斯

Sarah 管理 Equinix Metal 的交付工程团队。她是在裸机上部署和运行 Kubernetes 的专家，最近写了很多 Go 来保持事情顺利运行。当她不工作时，你会发现她和她的两个孩子在一起，和她的三只狗一起玩，或者在北卡罗来纳州的罗利周围跑步、骑自行车和游泳。](https://www.linkedin.com/in/sfunkhouser) 

新的操作系统版本不断出现，因此保持我们的产品 Equinix Metal 上验证的操作系统列表的最新状态很容易消耗大量工程时间。不过，这对于我们的业务来说是一项至关重要的功能，因此直到最近，我们还会投入资源来手动添加每个新的操作系统。然而，几个月前，我们用使用 Buildkite 创建的自动化 CI 管道取代了耗时且重复的手动流程。我们非正式地称它为“建筑者鲍勃”Bob 已经为我们节省了大量工程时间——这些时间可以用来做更有创造性、更有影响力的工作——我在这里分享我们的经验。

从长远来看，使用旧流程在 Equinix Metal 上验证新操作系统可能需要几个月的时间。一个简单的升级，比如从 Ubuntu 18.04 升级到 20.04，通常需要几周的时间。问题是双重的。首先，我们没有一个简单、自动化的 CI 管道来将包添加到操作系统映像、定制配置或运行构建。我们都是手动完成的。

其次，每个新映像都需要在多个硬件平台上部署和测试，以确保它能够在我们的裸机云中的每个服务器配置上工作。我们会通过手动将每个映像安装到不同的服务器上来验证它是否能按要求工作，然后四处查看以验证功能。

没有用于操作系统映像的 CI 管道，并且必须手动测试，这是准备每个新操作系统映像花费如此长时间的主要原因。这个过程完成了工作，但是不用说，这并不是花费宝贵的工程资源的理想方式。

## bob Builder 将操作系统管道推向了新的高度

建筑者鲍勃正好解决了这两个问题。 [Buildkite](https://buildkite.com/) 是一个运行灵活且可扩展的 CI 管道的平台。使用 Buildkite 自动化了我们的操作系统构建和测试管道，极大地加快了速度，解放了我们的工程师。

以下是新流程的工作原理:

1.  为我们想要添加的任何操作系统找到一个上游云映像。例如，如果我们想要一个 Ubuntu 映像，我们从 Canonical 提供的源[这里](https://cloud-images.ubuntu.com/)中获取它。
2.  配置 YAML 模板，定义如何定制操作系统以满足 Metal 的要求。我们可以指定将哪些包添加到映像中，应用哪些网络配置，等等。我们还确定映像应该支持哪些硬件计划。
3.  自动化接管。我们在 Buildkite 中设置了一个管道，根据 YAML 配置生成一个定制的操作系统映像。构建者 Bob 使用 virt-customize 来处理映像修改，以修改操作系统映像，将其推送到 S3 存储桶，将其部署到我们想要支持它的服务器配置，并运行所有必要的测试来验证新映像。
4.  如果它通过了所有的测试，新的映像将被自动推送给客户，然后客户可以将它部署到 Metal 服务器配置中。

## Buildkite:鲍勃的忠实伙伴

Bob Builder 可以在笔记本电脑上运行并触发一次性构建——事实上，作为一个基于 Go 的 CLI 工具，基本上可以在任何地方运行是 Bob 的优势之一——但我们主要将其用作 Buildkite 管道的一部分。

我们选择 Buildkite 来编排 OS 映像管道，因为它的几个特性特别好地满足了我们的需求。

一个是它支持动态管道。Buildkite 允许我们设置条件和阶段，而不是将管道定义为一组步骤然后运行它。这意味着我们可以为多个映像构建重用同一个管道，这比必须为每种类型的映像创建单独的管道要好。

它还让我们可以在管道中的任何一点收集用户输入。这使得我们的管道是交互式的，为复杂的操作系统构建过程提供了很大的灵活性和控制力。

最重要的是，它让我们可以完全控制构建发生的位置。我们可以在容器中运行它们，或者直接在我们选择的硬件上运行它们。这对于 Metal 来说是一件大事，因为我们经常需要在特定类型的硬件上运行构建，比如裸机 Arm 服务器。

最后，我们可以轻松地跨我们想要支持的各种 x86 和 Arm 服务器配置发布映像，而不必为每种配置设置不同的管道。这不是一般的 CI 服务器能够做到的。

当然，Buildkite 的高级特性集有一个学习曲线。我们的第一条 Bob Builder 动力管道不是一天建成并投入运行的。这是一个长达数月的过程，但一旦我们学会了将 Buildkite 和 Bob Builder 配对，推出新的操作系统映像就变得轻而易举了。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>