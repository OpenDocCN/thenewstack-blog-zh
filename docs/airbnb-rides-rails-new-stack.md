# Airbnb 转而做出反应，建立一个反应更灵敏的前端

> 原文：<https://thenewstack.io/airbnb-rides-rails-new-stack/>

每天每分钟，平均有 5.2 万人在 Airbnb 的网站上搜索住宿的地方。

世界上最大的房屋共享服务每天支持 7500 万次搜索——用户希望预订 Airbnb 在全球 191 个国家经纪的 300 万套住宅中的一套(包括 3000 座城堡和 1400 座树屋)。自 2008 年公司成立以来，该网站已帮助 1.6 亿客人入住上市酒店。

随着 Airbnb 进入新的服务领域，这种强劲的流量只会增加。该公司最近推出了 Airbnb Trips，这一功能允许用户在住宿的同时研究和预订当地冒险活动。Airbnb Experiences 将 Airbnb 用户与当地的常驻专家联系起来，这些专家带领探险队去意大利寻找松露，或者在加利福尼亚海岸秘密冲浪。Airbnb Places 提供目的地城市的内部推荐，从一般(通常的餐厅、酒吧、景点等。)到非常特殊的(跳萨尔萨舞的秘密地点)。额外的旅游服务，如机票预订，正在建设中，很快就会上线。

当他们考虑建立新的 Trips 平台时，Airbnb 的工程团队意识到这是一个从根本上重新设计前端代码库的机会，该代码库始于 2008 年，当时是一个不起眼的 Rails/Prototype.js 应用程序。这种仍可使用但迅速老化的基础设施沿用了传统的方法，即登录页面搜索结果，单个列表预订——每个页面都通过 Rails 独立交付。的确很像 2008 年。

“我们的搜索页面包含一些非常旧的代码，”Airbnb 工程师 Adam Neary 在[最近的一篇总结工作的博客文章中写道。"就像《指环王》里那种冒险的老把戏."](https://medium.com/airbnb-engineering/rearchitecting-airbnbs-frontend-5e213efc24d2)

Airbnb 希望 UX 是完全流动的，随着用户探索和缩小搜索范围，在瞬间进行有机调整，甚至是先发制人。“新架构的一个驱动因素是，我们希望在客户机上实现的新产品功能在传统堆栈上根本不可能实现，”Neary 在后续采访中说道。目前，页面请求仍然是通过 Rails 处理的，尽管将来可能会有所改变。然而，增加了关键的一步:让一个节点服务运行 [Hypernova 库](https://www.npmjs.com/package/hypernova)来实际呈现 React 组件服务器端。

想象 Rails 处理一个请求并检索呈现页面所需的数据。然后，Rails 将这些数据传递给 Hypernova，Hypernova 返回所需的标记，Rails 将页面转发给用户，由客户端代码接管。

“让这个通用 JavaScript 解决方案成为可能的关键技术是 React，它可以在服务器和客户端上可靠地呈现相同的内容，”Neary 说。

## 我们不能和睦相处吗？

最初的 Airbnb 网站拥有服务器渲染的 Rails 页面，可以处理服务器渲染的 React 组件上以任何方式抛出的数据。“控制器、助手和演示者可以产生任何形状的数据，每个组件都可以消耗所需的任何数据，甚至在您迁移页面部分以做出反应时也是如此，”Neary 说。然而，新的客户端路由需要以高度特定的“规范”形式交付动态数据。

Neary 说，最终，该团队希望“寻找类似于 [GraphQL](http://graphql.org/) 的东西来实现这一功能，但在最初的重构时，决定创建当前 API 的新版本，同时要求所有组件开始使用规范的数据形状。Neary 说，迁移现有的服务器端管道实际上相当简单:工程师“检查了 Rails 渲染 React 组件的每个地方，以确保数据输入是正确的 API 形状，并通过客户端的 React PropTypes 进一步验证合规性。”

比整合 API 更复杂的是整合该公司的多个团队，每个团队专注于预订流程的不同方面，分布在 Airbnb 的 19 个全球办事处。“我们需要接触并重新教育所有这些人，即使在技术上仍然可以直接将数据传递给正在呈现的组件，但所有数据现在都需要通过 API，”Neary 说。

## 无法追踪的巫术

一组单独的(非 API)数据也需要返工。功能本身——应用程序配置、国际化和本地化等等——是可靠的，但是它们的前端交付机制“有点欠完善” [Hypernova](https://www.npmjs.com/package/hypernova) 在服务器渲染 React 的地方，但是有一些潜在的陷阱。“如果服务器和客户端输出不匹配，页面不仅会闪烁差异，还会在加载后重新呈现整个页面，这对性能来说是非常糟糕的，”Neary 在他的博客中总结了这一过程。他进一步阐述道:

*“更糟糕的是，我们很久以前就编写了一些神奇的 Rails 函数，例如 add_bootstrap_data(key，value)，表面上可以在 Rails 中的任何地方调用这些函数，通过 BootstrapData.get(key)使数据在客户端全局可用。对于一个小团队来说，开始是一个有用的工具，但对于一个大的应用程序和团队来说，却成了不可追踪的魔法的来源。“数据清洗”犯罪变得越来越棘手，因为每个团队都拥有不同的页面或功能，因此每个团队都开发了不同的机制来加载配置，每个机制都适合他们独特的需求。”*

为了驱除恶魔，工程团队设计了一种特定的机制来引导非 API 数据，将所有页面定向到 Rails 和 React/Hypernova 之间的这种切换。这个更高阶的组件接收到作为 JS 对象的引导数据的必要形状，并且在客户端和服务器端正确地初始化所有支持工具。

“在一个单一的镜头中，我们能够消除 add_bootstrap_data，并防止任意键传递到顶级 React 组件，”Neary 说。

## 现在是前端

服务器返工，是时候升级 Airbnb 的前端了。方法是:使用 [React Router](https://github.com/ReactTraining/react-router) 的客户端路由，利用路由的延迟加载和代码分割包。从而在服务器上呈现页面，只提供在浏览器中交互所需的 JavaScript，然后在浏览器空闲时主动下载并缓存其余内容。

早期，Airbnb 网站一口气渲染了整个页面，这种做法延续到了该公司早期的 React。然而，现在一个 [AsyncComponent](https://medium.com/@thejameskyle/react-loadable-2674c59de178) 从组件层次结构中分离出包，以便在挂载后异步加载。Neary 说，路线之间的转换现在不仅“像黄油一样平滑”，而且步长变化也令人印象深刻(大约快了五倍)。这是 Airbnb 新网站设计提供的雄心勃勃的动画的必要场景。

“在这里，我们简单地将地图的同步版本替换为异步版本，这在小断点上特别有用，其中地图通过用户与按钮的交互来显示，”Neary 说。“由于这些用户大多使用手机，让他们在担心谷歌地图之前进行互动意味着页面加载时间的大幅提升。”

Neary 特别指出了 scheduleAsyncLoad()实用程序，它甚至在用户有机会进行交互之前就请求了这个包。“由于地图使用如此频繁，我们可以在他们到达住宅搜索路线时将其排队。HomesSearch _ Map 成为浏览器可以缓存的命名包，”他解释道。随着更大的基于路线的包被分解，应用程序的许多部分在更新中保持不变，从而进一步节省了 JavaScript 下载时间。

## (永无止境的)前端故事的其余部分

Airbnb 工程团队还在大修期间解决了其他问题，包括无障碍环境。Neary 说，内部组件库现在正在以可访问性作为硬约束进行构建，“在接下来的几个月里，我们将替换访客流中的所有 UI，以与屏幕阅读器兼容。”

更深入的细节(和代码片段！)关于可访问性，团队如何处理应用程序状态，以及更多信息可以在 Neary 的博客文章中找到。

Airbnb 在短时间内管理了令人印象深刻的堆栈重新配置，没有中断用户，同时推出了重要的新功能。(Neary 对这一成就的总结是“重建一个每天服务 7500 万次搜索的页面是一件棘手的事情”，这正是“轻描淡写”这个词的定义。)Neary 和团队是如何取得这一令人印象深刻的成果的？回顾过去，他对其他考虑类似令人生畏的情况的工程师有什么建议吗？

根据 Neary 的说法，方法是:首先，手动挑选一小组工程师，在很短的期限内紧密合作，为新架构构建核心功能。手中有稳定的演示，开始寻求对设计的反馈，并扩大团队，以便快速迭代更改。接下来，获得一个与遗留版本并行运行的现场版本，并开始与外部用户进行测试。

“这次经历最棒的部分之一是我们能够保持目标明确，专注于我们在破土动工的同一个季度可以投入使用的工作范围，”Neary 说。任何更大的范围，这两个分支的代码将会开始有太大的分歧，迫使团队为两者构建新的特性。保持目标性意味着不仅对开发团队，而且对更广泛的涉众社区来说，使过程更容易。

内尔利的终极建议是:“做一些大胆的事情，但要付诸实施。长弧要难得多。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>