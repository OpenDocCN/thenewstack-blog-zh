# 让传奇模式工作起来没有所有的麻烦

> 原文：<https://thenewstack.io/making-the-saga-pattern-work-without-all-the-headaches/>

## 第一部分:传奇的问题

当我们意识到我们的软件过程比我们想象的更复杂时，我们都在项目的那个点上。传统上，处理这种复杂的流程是痛苦的，但其实不必如此。

一个里程碑式的软件开发剧本叫做[传奇设计模式](https://microservices.io/patterns/data/saga.html)已经帮助我们应对过程复杂性超过 30 年了。它已经为数千家公司提供了服务，因为它们构建了更复杂的软件来满足更苛刻的业务流程。

这种模式的缺点是成本和复杂性较高。

在这篇文章中，我们将首先剖析编码 Saga 模式以处理事务复杂性的传统方式，并看看为什么它不起作用。然后，我将更深入地解释不关注这个管道代码问题的开发团队会发生什么。最后，我将向您展示如何避免随之而来的项目腐败。

### 满足持久执行的需求

Saga 模式的出现是为了应对复杂软件过程中的一个迫切需求:持久执行。当您编写的事务发出一个简单的数据库调用并获得快速响应时，您不需要在代码中容纳该事务之外的任何内容。然而，当事务依赖于多个数据库(或者实际上依赖于其他事务执行)来完成任务时，事情会变得更加困难。

例如，一个预订汽车旅行的应用程序可能需要检查客户的帐户是否信誉良好，然后检查他们的位置，然后检查哪些汽车在该地区。然后，它需要预订旅程，通知司机和客户，然后在旅程结束时接受客户的付款，将所有内容写入更新司机和客户帐户历史的中央存储。

像这样处理相关事务的流程需要在整个事件序列中跟踪数据和状态。他们必须能够经受交易流程中出现的问题。如果事务返回结果的时间比预期的长(可能移动连接中断了一会儿，或者数据库达到峰值负载，需要更长的时间来响应)，软件必须适应。

它必须等待必要的事务完成，重试直到成功，并协调执行队列中的其他事务。如果事务在完成前崩溃，流程必须能够回滚到一致的状态，以保持整个应用程序的完整性。

这对于需要在几秒钟内做出响应的用例来说已经足够困难了。一些应用程序可能会执行数小时或数天，这取决于它们所支持的事务和流程的性质。开发人员面临的挑战是在整个执行期间维护流程的状态。

这种可靠性——不会失败或超时的事务——被称为强执行保证。它与易变执行相反，易变执行可以在任何时候停止存在，而不完成它应该做的所有事情。易变的执行会使系统处于不一致的状态。

起初看似简单的事情变成了以我们的软件为中心人物的传奇。开发人员必须引导它通过多个步骤才能完成，确保在发生某些情况时我们能保持它的状态。

### 理解传奇模式

传奇模式为这一旅程提供了路线图。在 1987 年的一篇论文中首次讨论了这种模式，这种模式通过使复杂的流程能够相互通信，为它们带来了持久的执行。中央控制器管理服务通信和事务状态。

该模式为开发人员提供了持久执行所需的三样东西。它可以将事务串在一起，以支持长时间运行的流程，并通过在失败时重试来保证流程的执行。它还通过确保某个过程完全完成或根本不完成来提供一致性。

然而，使用传奇模式要付出沉重的代价。虽然原则上这个概念没有错，但一切都取决于实现。开发人员传统上不得不自己编写模式，作为他们应用程序的一部分。这使得它的设计、部署和维护变得如此困难，以至于应用程序可能成为模式的奴隶，最终占用开发人员的大部分时间。

> 最终，当开发人员添加更多的事务时，他们会花费更多的时间来维护管道代码。曾经的线性开发工作量现在变成了指数级。随着每一个新的变化，花费在开发上的时间不成比例地增加。

手工编码 Saga 模式包括将一个连贯的过程分解成块，然后用管理其操作的代码包装它们，包括在失败时重试它们。开发人员还必须在相互依赖的不同过程中管理这些任务的调度和协调。他们必须同时使用数据库、队列和定时器来管理这种进程间的通信。

软件处理量和依赖性的增加需要开发人员花费更多的时间来创建和维护管道基础设施，这反过来又增加了应用程序的成本。这种日益增加的复杂性也使得开发人员更难证明其代码的可靠性和安全性，这对运营和合规性产生了影响。

### 抽象是关键

抽象是保留 Saga 模式持久执行优势的关键，同时丢弃它的负面包袱。我们不能让开发人员将模式编码到他们的应用程序中，我们必须通过将事务序列抽象到另一个层次来隐藏它。

抽象是计算中一个众所周知的过程。它给每个应用程序一种它拥有一切的错觉，消除了开发人员适应它的需要。虚拟化系统在管理程序的帮助下完成这一任务。TCP 栈通过自动重试网络连接来做到这一点，因此开发人员不必编写自己的握手代码。当关系数据库不可见地回滚失败的事务以保持它们的一致性时，它们就会这样做。

运行一个单独的平台来管理持久执行，通过创建时态工作流来为事务排序带来这些好处。开发人员仍然可以控制工作流，但是他们不需要关心底层的机制。

除了易于实现之外，将持久执行抽象到工作流还带来了几个好处。久经考验的工作流管理层使得复杂的事务序列比自制的临时管道代码更不容易失败。为每个项目消除数千行定制代码也使得代码更易于维护，并减少了技术债务。

开发人员在调试时最清楚地看到这些好处。当您还必须模拟和管理管道代码时，根本原因分析和补救会变得异常困难。工作流隐藏了一整层的潜在问题。

### 高效的开发人员是快乐的开发人员

基于工作流的持久执行提升了开发人员的体验。他们没有消失在事务管理的兔子洞里，而是开始做对他们来说真正重要的事情。这提高了士气，并可能有助于留住他们。随着美国软件工程师的空缺职位数量预计在 2021 年至 2031 年间增长 25%，人才竞争非常激烈。公司承受不起太多的损耗。

在使用 Saga 模式来处理软件过程中的上下文切换方面，公司已经朝着正确的方向前进。然而，他们可以更进一步，将这些传奇模式从应用层抽象为一个独立的服务。做好这一点可以将组织中的软件成熟度向前推进几年。

## 第 2 部分:避免引爆点

在这篇文章的前半部分，我谈到了在应用层协调事务和保持状态是多么麻烦。现在，我们将讨论这是如何使软件项目偏离轨道的，以及对此你能做些什么。

任何合理规模的软件工程项目都会遇到持久执行的需求。

理想情况下，创建新软件特性所涉及的成本和时间应该是一致的和可计算的。耐久性编码打破了这种一致性。它使开发工作看起来更像曲棍球棒曲线，而不是线性斜率。

临界点是花在编码新特性上的时间和精力开始上升的地方。这是管理长期交易的真正程度变得清晰的时候。我将描述它是什么，为什么它会发生，以及为什么匆忙编写管道代码不是处理它的正确方法。

### 什么触发了临界点

在临界点之前的生活通常是好的，因为开发者的体验是线性的。开发人员正在使用的应用程序框架支持开发人员添加的每一个新特性，没有令人讨厌的意外。这使得开发团队能够以可预测的新特性实现时间来扩展应用程序。

只要开发人员进行数量上的改变，添加更多相同的东西，这种线性比例就能起作用。当有人不得不做出不同于其他人的改变，并发现应用程序框架中的缺点时，事情往往会破裂。这通常是一个质的变化，要求改变应用程序的工作方式。

这种变化可能涉及对多个数据库的调用，或者第一次依赖多个相关事务。它可能会调用一个需要不可预测的时间来交付结果的软件过程。

起初，这种变化可能还不足以达到临界点，但开发者的生活将开始改变。他们可能会编写管道代码来管理进程间的通信，以保证执行和保持事务的一致性。但这仅仅是开始。编写代码需要时间，现在，开发人员必须扩展代码，以应对他们引入的每一个新的质变。

他们会继续这样做一段时间，但情况会变得更糟。最终，当开发人员添加更多的事务时，他们会花费更多的时间来维护管道代码。曾经的线性开发工作量现在变成了指数级。随着每一个新的变化，花在开发上的时间不成比例地增加。

### “厄运之会”

有些人直到临界点发生时才意识到它。没有经验的初级开发人员经常会不知不觉地陷入其中。高级开发人员通常处于最糟糕的位置；他们知道转折点即将到来，但政治往往让他们无能为力，只能等待，收拾残局。

最终，有人引入了一个暴露问题的变化。压死骆驼的是最后一根稻草。也许一个变更打破了软件交付时间表，某个有影响力的人抱怨了。然后，有人称之为“末日会议”

在这次会议上，团队承认他们目前的方法是不可持续的。应用程序变得如此复杂，以至于这些特别的管道变更不再支持项目进度或预算。

这种认识让开发人员经历了悲伤的五个阶段:

*   否认。这种情况已经持续了一段时间。人们试图忽略这个问题，认为继续这样就好了。这让位于…
*   愤怒。会议中有人解释说这不会好。他们的预算被打破了；他们的日程安排被取消了；这个问题需要解决。他们不会接受否定的回答。所以人们尝试…
*   讨价还价。人们会想出创造性的方法，用更特别的变化来支撑事物更长的时间。但是最终，他们意识到这是不可扩展的，导致…
*   抑郁症。最后，开发人员意识到他们必须进行更基本的架构变更。他们的广告 ho- plumbing 代码已经采取了自己的生活，现在尾巴摇狗。这与…密切相关
*   接受。每个人都带着一种厄运感离开会议，并且知道在这之后没有什么会是好的。是时候取消几个周末开始工作了。

这种厄运感是有道理的。正如我解释的那样，管道代码很难编写和维护。从临界点开始，事情变得更加困难，因为开发人员发现代码更难编写和维护。突然间，他们习惯的线性编程体验消失了。他们花在编写事务管理代码上的时间比他们在看板上开发软件功能的时间还多。这会导致开发人员精疲力尽，并最终导致人员流失。

### 防止引爆点

我们如何避免这个临界点，平滑曲棍球棒曲线并保持软件特性和开发时间之间的线性比例？第一个建议通常是这次接受失败，并保证下次从头编写管道代码，或者重用您已经拼凑起来的代码。

那不行。这给我们留下了同样的问题，即管道代码最终将变得难以管理。而不是一个引爆点，这种发展只会更早地失去线性。从项目的开始，您将创建一个更加渐进的开发焦虑。

相反，团队需要做一开始就应该做的事情:做一个系统地支持持久执行的主要架构变更。

我们已经讨论了抽象作为前进的方向。在编写更多的项目代码之前，首先将管道功能从应用层抽象到它们自己的服务层。这将通过消除非线性工作来减轻开发人员的负担，使他们能够扩展并保持实现新功能所需的时间不变。

这种抽象保持了程序员的线性体验。他们总会觉得自己的时间在自己的掌控之中，并且确信自己正在完成任务。他们将不再需要考虑缓存和排队等任务的战略决策。他们也不必担心如何将杂乱无章的软件工具和库组合在一起来管理这些任务。

项目经理将会像开发人员一样乐于拥有一组抽象的事务工作流。确定性和可预测性是他们的关键要求，这使得打破线性发展的临界点特别成问题。对事务排序任务的抽象消除了开发人员意料之外的工作量，并保持了线性，为他们提供了满足时间安排和预算承诺所需的确定性。

支持这种抽象和将管道代码转换成可管理的工作流的工具将帮助您保持可预测的软件开发实践，消除可怕的临界点，并为您节省项目补救的压力。部署这些抽象服务的最佳时间是在您的项目开始之前，但是即使您的团队现在正处于危机之中，它也为您提供了一条走出困境的道路。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>