# 评估分布式数据库的 5 个问题

> 原文：<https://thenewstack.io/5-questions-for-evaluating-a-distributed-database/>

[](https://www.pingcap.com/)

 [Ed Huang，PingCAP 联合创始人兼 CTO

Ed Huang(Twitter:@ C4 pt 0 r)是 PingCAP 联合创始人兼 CTO，TiDB/TiKV 首席架构师。他是一名前基础设施工程师，终身黑客，开源狂热者。](https://www.pingcap.com/) [](https://www.pingcap.com/)

当我第一次开始和我的联合创始人一起创建 TiDB 时，我们遇到了无数的挑战、陷阱和关键的设计选择，这些都可能决定项目的成败。为了从头开始构建像 TiDB 这样的企业级分布式数据库，我们必须不断地做出艰难的决策，在开发速度与我们的客户和团队的长期考虑之间取得平衡。

三年后，经过两次大发布， [TiDB 2.0](https://pingcap.com/blog/tidb-2-0-announcement/) 现已在超过 200 家[公司投入生产部署](https://github.com/pingcap/docs/blob/master/adopters.md)。一路上，我们的团队回答了用户在评估 TiDB 和其他分布式数据库时提出的许多问题。选择在您的基础架构堆栈中使用什么是一个重要的决定，而且并不容易。因此，我收集了我们多年来的经验，并将其总结为每个工程师在考虑分布式数据库时都应该问的以下问题。

## 1.为什么分布式数据库不是银弹？

没有一种技术可以解决你所有的问题。数据库领域也不例外。如果您的数据可以放在一个 MySQL 实例上而不会给服务器带来太大压力，或者如果您对复杂查询的性能要求不高，那么分布式数据库可能不是一个好的选择。选择使用分布式数据库通常意味着额外的维护成本，对于小型工作负载来说可能不值得。如果您需要小型工作负载的高可用性(HA ), MySQL 的主从复制模型加上其 [GTID](https://dev.mysql.com/doc/refman/5.6/en/replication-gtids-concepts.html) 解决方案可能足以完成这项工作。如果没有，您可以使用组复制来扩展它。有了像 MySQL 这样活跃而庞大的社区，你可以谷歌几乎任何问题并找到解决方案。简而言之，如果单个实例数据库就足够了，那么就坚持使用 MySQL。当我们第一次开始构建兼容 MySQL 的 TiDB 时，我们的目标绝不是取代 MySQL，而是解决单实例数据库无法解决的问题。

> 如果您的数据可以放在一个 MySQL 实例上而不会给服务器带来太大压力，那么分布式数据库可能不是一个好的选择。

那么什么时候是部署像 TiDB 这样的分布式系统的合适时机呢？就像任何一个难题的答案一样，这要看情况。我不想给出一个一刀切的答案，但是在决定分布式数据库是否是正确的答案时，有一些信号可以寻找。例如，您是否:

*   发现自己在考虑如何复制、迁移或扩展数据库以获得额外容量？
*   正在寻找优化您现有存储容量的方法？
*   担心缓慢的查询性能？
*   研究中间件扩展解决方案或实施手动分片策略？

如果您发现自己经常问这类问题，那么是时候考虑像 TiDB 这样的解决方案是否能帮助您了。

MySQL 和 TiDB 并不是互斥的选择。事实上，我们花费了大量的工作来帮助我们的用户继续使用 MySQL，通过构建工具来实现从 MySQL 到 TiDB 的无缝迁移。这保留了同时使用 MySQL 处理单实例工作负载的选项。

## 2.为什么要将 SQL 与存储分开？

您希望将 SQL 与底层存储分离有几个原因。

**易于维护。**我们将 TiDB 平台的 [SQL 层](https://github.com/pingcap/tidb)(无状态，也称为 TiDB)与其存储层(持久，也称为 [TiKV](https://github.com/tikv/tikv) )分离，以便使部署、操作和维护更加简单。这是我们做出的最重要的设计选择之一。这可能看起来违背直觉(组件越多，部署不是越复杂吗？).嗯，作为一名 DevOps 不仅仅是进行部署，还包括快速隔离问题、系统调试和整体维护——模块化设计在支持这些职责方面确实大放异彩。举个例子:如果你在你的 SQL 层中发现了一个需要紧急更新的错误，如果你的整个系统融合在一起而不是单独分层的话，滚动更新可能会非常耗时、具有破坏性，甚至有风险。但是，如果您的 SQL 层是无状态的和分离的，那么更新就很容易，不会中断系统的其他部分。

**更好的资源利用。**模块化设计也更有利于资源分配和使用。存储和 SQL 处理依赖于不同种类的计算资源。存储在很大程度上依赖于输入输出(I/O ),并受到您使用的硬件类型的影响，例如 PCIe/NVMe/Optane 固态硬盘。SQL 处理更依赖于 CPU 能力和 RAM 大小。因此，将 SQL 和存储放在不同的层中有助于使整个系统更有效地将合适的资源用于合适的工作。

TiDB 旨在支持一种 [HTAP](https://en.wikipedia.org/wiki/Hybrid_transactional/analytical_processing_(HTAP)) (混合事务和分析处理)架构，在这种架构中，OLTP 和 OLAP 工作负载可以同时得到出色的处理。每种类型的工作负载都有不同的优化方式，并且需要不同种类的物理资源来获得良好的性能。OLAP 请求通常是长而复杂的查询，需要大量内存才能快速运行。OLTP 请求短而快，因此必须根据 OPS(每秒操作数)优化延迟和吞吐量。由于 TiDB 的 SQL 层是无状态的，并且与存储分离，因此它可以通过应用其 SQL 解析器和基于成本的优化器在执行之前分析查询，来智能地确定哪种工作负载应该使用哪种物理资源。

**开发的灵活性和效率。**使用单独的键值抽象来构建底层存储层，有效地增加了整个系统的灵活性。它可以很容易地提供水平可伸缩性——与具有复杂模式和结构的表相比，沿着键的自动分片更容易实现。独立的存储层也为利用分布式系统中不同的计算模式开辟了新的可能性。

我们利用 Spark 的 OLAP 引擎 TiSpark 就是这样一个例子，它利用了我们的分层设计，位于 TiKV 之上，直接从 TiKV 读取数据，而不依赖 TiDB，也不受 TiDB 的干扰。从开发的角度来看，分离允许使用多种编程语言。我们选择了 Go，一种高效的语言来构建 TiDB 并提高我们的生产率，选择了 Rust，一种高性能的系统语言来开发 TiKV，在 TiKV 中速度和性能是至关重要的。如果整个系统不是模块化的，多道程序语言方法将是不可能的。我们的分层架构允许我们的 SQL 团队与我们的存储团队并行工作，我们使用 RPC(更具体地说是 TiDB 中的 [gRPC](https://github.com/pingcap/grpc-rs) )进行组件之间的通信。

## 3.为什么延迟不是首要的衡量标准？

很多人问过我:TiDB 能代替 Redis 吗？不幸的是没有，因为 TiDB 根本不是一个缓存服务。TiDB 是一个分布式数据库解决方案，它首先支持具有强一致性、高可用性和水平可伸缩性的分布式事务，其中您的数据跨多台机器(或多个数据中心)持久化和复制。简单地说，TiDB 的目标是成为每个系统的“真理之源”。但是，要在分布式系统中实现所有这些功能，延迟方面的一些折衷是不可避免的(任何相反的论点都违背了物理学)。因此，如果您的生产场景需要非常低的延迟，比如说小于 1 毫秒，那么您应该使用 Redis 这样的缓存解决方案！事实上，我们的许多客户在 TiDB 上使用 Redis，因此他们可以拥有低延迟和可靠的“真实来源”这样，当缓存层关闭时，会有一个数据库始终与您的数据保持一致、可用且容量不受限制。

分布式数据库的一个更有意义的衡量标准是吞吐量和延迟。如果系统的吞吐量随着添加到系统中的机器数量的增加而线性增加(机器越多，吞吐量越大)，而延迟保持稳定，这就是健壮的分布式数据库的真正标志。我们的一些生产用户已经在 TiDB 集群上每秒处理多达 100 万个查询；这种吞吐量水平在单台机器上几乎是不可能实现的。

我们 PingCAP 内部有一句谚语，“在快速之前先做对。”正确性、一致性和可靠性总是胜过速度。没有它们，低延迟有什么用？

## 4.基于范围的分片比基于散列的更好吗？

我们在 TiKV 中实现了基于范围的分片，而不是基于散列的分片，因为我们从一开始的目标就是支持全功能的关系数据库，而关系数据库必须支持各种类型的扫描操作，如表扫描、索引扫描等。尽管基于范围的分片更难构建，但基于散列的分片不能按顺序维护给定表的数据，因此，在基于散列的设置中，即使是对几行的小扫描也可能意味着在多个节点之间跳过多个分片。基于范围的分片不会有这个问题。

当然，这并不意味着基于范围的分片没有自己的权衡。例如，如果您的查询模式主要是顺序写入，其中写入操作远远超过没有更新或删除的读取操作，就像日志一样，那么就可能形成热点。对于这个场景，我们计划使用分区表作为解决方案，来缓解这种写入模式给系统带来的压力(这在我们 2018 年的路线图上)。另一种更难解决的情况是，如果您的请求模式包含对一个小表的频繁读/写，而这个小表恰好在同一个 Raft 区域中。现在，每个 TiKV Raft 区域都是按照有序的键值对划分的，默认为 96MB。如果这样一个频繁读/写的小表小于 96MB，无疑会形成一个热点，唯一的解决方案(到目前为止)是手动将该区域一分为二，并在不同的节点上重新分配它们。这种“修复”不会解决热点问题，只是通过缩小热点来缓解热点问题。这是一个分布式数据库不太适合解决的问题，所以如果您有这种类型的请求模式，我们建议您使用内存缓存层，比如 Redis，或者将这个小表直接放在您的应用层。

## 5.为什么可伸缩性对企业如此重要？

当一家公司开始时规模很小，任何数据库和基础设施都可以工作，但是当该公司开始经历爆炸式(通常是意想不到的)增长时，您对基础设施技术的选择就非常重要了。做出能够根据您的业务需求轻松向任一方向扩展的正确选择可能意味着您公司的生死存亡。

我们都记得 Twitter 臭名昭著的“[失败](http://www.whatisfailwhale.info/) [鲸鱼](http://www.whatisfailwhale.info/)”事件，当时这项服务因为不仅仅是用户增长，还有糟糕的基础设施而持续下降。当您的数据库成为瓶颈时，解决方案不是手动分割您的表，牺牲关系功能，制作同一个表的一堆副本，然后清洗并重复这个恶性循环。正确的(也是最具成本效益的)方法是使用可弹性伸缩的分布式数据库，因此您所要做的就是添加新的机器来增加容量。添加更多的机器似乎是一个不断增长的成本，但与您节省的人力资源和宝贵的工程时间相比，这要便宜得多，因为您需要在竞争环境中做出响应和适应。

## 摘要

当我们第一次开始设计和构建 TiDB 时，我们从自己的经验以及其他 DBA 和基础设施工程师那里学到了很多经验。一个真正有用和健壮的分布式数据库应该立即解决可扩展性瓶颈，并使所有像手动分片这样的“快速修复”变得过时，这样应用程序开发人员就可以专注于他们最擅长的事情——服务客户和发展业务，而不是管理数据库分片。

最近，我们已经看到我们的两个用户，[(无码头自行车共享)](https://www.pingcap.com/blog/Use-Case-TiDB-in-Mobike/)和转转(在线市场)正是这样做的。两家公司都经历了爆炸性的增长，由于他们在增长开始时部署了 TiDB，因此他们的数据库基础架构不是阻碍他们以这种方式增长的瓶颈。事实上，Zhuan Zhuan 在 TiDB 上孤注一掷，因为它知道一个构建良好的分布式数据库对其未来至关重要。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>