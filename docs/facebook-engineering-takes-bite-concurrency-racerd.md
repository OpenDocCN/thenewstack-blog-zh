# 脸书工程公司从 RacerD 的并发性中获益匪浅

> 原文：<https://thenewstack.io/facebook-engineering-takes-bite-concurrency-racerd/>

来自脸书 Android 团队的研究科学家和工程师今天给科技界带来了一个有趣的、潜在强大的新开源玩具:[raced](https://github.com/facebook/infer)。

RacerD 是作为[脸书推断](http://fbinfer.com/)的新组件推出的，后者是该公司于 2015 年推出的开源静态分析器平台。Infer 致力于在移动代码发布之前识别源代码错误，它通过扫描程序并识别潜在的生产故障，如 Android 和 Java 代码中的空指针异常和注释可达性，以及 C/C++/Objective C 中的内存泄漏和不可用的 API。

RacerD 通过瞄准并发性将 Infer 的静态分析向前推进了关键的一步——这意味着开发人员现在将能够自动化静态竞争检测。你没看错:这是一个免费的、开源的、经过生产测试的工具，它极大地加快了并发错误检测的速度。

《新堆栈》采访了脸书大学的研究科学家[萨姆·布莱克希尔](https://research.fb.com/people/blackshear-sam/)和[彼得·奥赫恩](https://research.fb.com/people/ohearn-peter/)，他们与该公司的 Android News Feed 工程团队合作，将自动化并发测试方面的这一理论突破融入到生产程序中——在一个服务于 20 亿月活跃用户的平台上。

顺便提一下，奥赫恩是 2016 年[哥德尔奖](https://en.wikipedia.org/wiki/G%C3%B6del_Prize)的共同获奖者(与[斯蒂芬·布鲁克斯](http://www.cs.cmu.edu/~brookes/)),该奖项因在理论计算机科学领域的杰出研究而授予，因为他发明了[并发分离逻辑](https://dl.acm.org/citation.cfm?id=1235896.1236121)。

你能向我们这些没有在理论计算领域获得任何奖项的人解释一下并发性吗？

彼得·奥赫恩:并发是计算机科学中最难的问题:当事情变得不一致时，试图保持事情的一致性。当两个计算机程序同时处理同一件事情时，这两个并发活动会加快访问数据的速度。通常会有人先到达那里。但是如果它们同时到达那里，如果它们发生冲突，事情就会进入不一致的状态，其中一个程序正在做的事情会把另一个程序试图做的事情弄糟。计算机程序很难阻止这些事情同时发生，主要原因是程序交互的方式有很多很多。

假设我有两个并发活动，每个活动有 50 条编程语句，假设我可以每纳秒查看或处理一条指令。考虑这些代码行可以相互作用的所有不同顺序需要 340 万年。这就是为什么从 20 世纪 60 年代早期开始，并发性就一直是一个问题:为了找到问题，我们不能探索所有的可能性——蛮力需要太长的时间

RacerD 在最基本的层面上，试图找到这些问题，而不是探索所有的可能性。它可以在 15 分钟内完成，而不是 340 万年。

**是什么导致了《赛车总动员》的诞生？**

**奥赫恩**:在加入脸书之前，我作为一名大学计算机科学教授从事了 15 年的并发工作。然后在 2016 年，我是脸书的一名经理，即将成为工程师，我想，我知道的最难的问题是什么？并发性。如果我们能解决这个问题，我们就能为程序员带来真正的改变。

Sam 和我一起开发了 RacerD 的早期版本——从理论上讲，我们已经建立了早期的原型。脸书科学家试图同时研究工程和理论。从笔和纸到电脑，然后再回来。

然后真正有趣的事情发生了 Android News Feed 上的工程师联系我们，提出了一个问题。他们想要获取新闻提要，这个巨大的、不断变化的代码库，并通过使其并发来加速它。由于竞争条件，这将是一项非常困难的任务——他们问，在我们将并发代码投入生产之前，raced 能否消除这些问题？

我们还没完全准备好。但认为这是一个利用理论计算机科学思想为工作工程师服务的好机会。我们一方面有计算机科学，另一方面有工程学，我们同时研究这两个问题。这给了我们一个科学和工程之间的反馈回路，让我们把它们都变得更好。

该理论的核心思想不是探索所有的可能性。我们在算法中发现了一些要跟踪的量，这些量会给我们关于并发活动何时会发生冲突的信息。信息而不做所有的探索。一切仍然很困难，但这是一个突破。

**这一突破的实现实际上是什么样子的？**

black shear:Android News Feed 工程师面临的具体问题是，他们必须处理一堆他们没有编写的代码。他们知道如何使用并发来加快速度，但是如何在现有的生产代码基础上这样做，其中一个小的代码问题可能会导致整个系统的大量错误。并发错误极难调试，甚至一旦发现就很难重现——这使得修复它们变得非常非常困难。以前，这必须靠蛮力来完成——一行一行地通过难以想象的大量代码。

赛车让手动部分消失了。您将它指向您想要引入并发性的代码，它会告诉您问题点可能出现在哪里。然后，您可以在这些点上添加一个锁，这使得迁移变得更加简单。使用 RacerD，一个由两名工程师组成的小团队花了六个月的时间将并发性构建到现有的 Android 新闻提要代码中。如果他们被要求手工操作，他们很可能根本不会尝试并发。

最终结果是我们将速度提高了 5%。即使少于 1%也会对用户体验产生显著影响，所以 5%是非常重要的。我们对此非常高兴。

RacerD 已经在我们的 Android 代码库上运行了 10 个月，发现了 1000 多个多线程问题，这些问题在代码进入生产之前就被我们的开发人员修复了。

**那么，RacerD 能为普通开发者做些什么呢？**

**奥赫恩**:人们害怕让他们的代码并发，因为错误处理起来非常复杂。现在，开发人员可以不那么害怕了，从而可以写出更好的代码。

Blackshear :作为并发代码的开发人员，使用 RacerD 你可以更快更自信地前进。并发错误是最糟糕的，需要最长的时间来解决，所以我们将为您找到这些错误！如果 RacerD 发现任何问题，它会自动对看起来不安全的代码更改行进行评论，使工程师能够快速找到并修复它。

**当前版本仅针对 Android？接下来是什么？**

**奥赫恩**:正确，安卓。但是我们现在正在开发 C++的 RacerD。我们想拓宽更多的领域。并发是一个长期存在的问题。我们在这里做了一点介绍，但是在应用于并发性的自动推理方面还有很多工作要做。程序验证是我们肯定会关注的一个领域。

RacerD 从一开始就打算开源？

**Blackshear** :是脸书 Infer 平台上的一个组件，是开源的。所以，是的，RacerD 一直都是开源的，我们对此很高兴。

奥赫恩:我们开源的主要原因之一是与社区合作。世界上有很多很多聪明的人，当我们一起努力时，问题就更容易解决了。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>