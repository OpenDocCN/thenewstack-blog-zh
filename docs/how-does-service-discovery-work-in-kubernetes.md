# Kubernetes 中的服务发现是如何工作的？

> 原文：<https://thenewstack.io/how-does-service-discovery-work-in-kubernetes/>

Kubernetes 中的服务模型提供了[微服务](https://thenewstack.io/category/microservices/)最基本但最重要的方面:发现。理解服务发现是理解应用程序如何在 [Kubernetes](https://thenewstack.io/category/kubernetes/) 上运行的关键。

本系列的[上一篇文章](https://thenewstack.io/how-do-applications-run-on-kubernetes/)介绍了节点和 pod 的基础知识。提醒一下，节点是 Kubernetes 集群的主力，负责运行容器化的工作负载；日志记录、监控和服务发现的附加组件；和可选的附加组件。而 pod 是 Kubernetes 对象模型中最小和最简单的单元，也是 Kubernetes 应用程序中最小的可调度项目。

Kubernetes 中的任何 API 对象，包括一个节点或一个 pod，都可能有与之相关联的键值对——用于标识和分组共享一个公共属性或特性的对象的附加元数据。Kubernetes 将这些键值对称为标签和注释。服务发现利用标签和选择器将服务与一组 pod 相关联。

单个 pod 或副本集可以通过服务向内部或外部客户端公开，服务将一组 pod 与特定标准相关联。任何标签与服务清单中定义的选择器相匹配的 pod 都将被服务自动发现。这种架构为服务发现提供了一种灵活的、松散耦合的机制。

创建 pod 后，会为其分配一个只能在群集内访问的 IP 地址。但是不能保证 pod 的 IP 地址在其整个生命周期中保持不变。Kubernetes 可以在运行时重新定位或重新实例化 pod，从而为 pod 生成一个新的 IP 地址。

为了补偿这种不确定性，服务确保流量总是被路由到集群中的适当 pod，而不管它被调度在哪个节点上。每个服务公开一个 IP 地址，也可能公开一个 DNS 端点——两者都永远不会改变。需要与一组 pods 进行通信的内部或外部消费者将使用服务的 IP 地址，或者更普遍的 DNS 端点。通过这种方式，服务充当了连接 pod 和其他 pod 的粘合剂。

部署依靠标签和选择器来确定哪些单元将参与缩放操作。任何标签与服务定义的选择器相匹配的 pod 都将在其端点公开。然后，服务通过在匹配的 pod 之间路由流量来提供基本的负载平衡。

选择器是一种用于查询与标签值匹配的 Kubernetes 对象的标准。这种强大的技术支持对象的松散耦合。可以生成其标签与选择器的值相匹配的新对象。标签和选择器构成了 Kubernetes 中的主要分组机制，用于标识操作所应用的组件。

在运行时，可以通过复制集来扩展 pod，确保每个部署总是运行所需数量的 pod。每个副本集始终维护一组预定义的单元。当部署启动扩展操作时，该操作创建的新单元将立即开始接收流量。

Kubernetes 提供了三种方案来公开服务:

1.  **ClusterIP** :意为 pod 在集群内相互通信。例如，通过基于集群 IP 的服务公开的数据库 pod 对 web 服务器 pod 变得可用。
2.  **节点端口**:用于在一个集群的所有节点上公开同一个端口上的服务。内部路由机制确保请求被转发到每个节点上适当的 pod。这通常用于有外部消费者的服务。
3.  **负载平衡器**:load balancer 类型通过添加第 4 层(L4)和第 7 层(L7)负载平衡器来扩展 NodePort 服务。这种方案通常用于在公共云环境中运行的集群，这些环境支持软件定义的负载平衡器的自动配置。

当多个服务需要共享同一个负载平衡器或外部端点时，建议使用入口控制器。它通过提供负载平衡、安全套接字层(SSL)终止和基于名称的虚拟主机来管理对集群中服务的外部访问(通常是 HTTP)。

Ingress 在 Kubernetes 中运行生产工作负载变得越来越流行。它允许同一应用的多个微服务使用由负载平衡器、API 网关或应用交付控制器(ADC)公开的同一端点。

本系列的下一篇文章将讨论 Kubernetes 中的网络和存储。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>