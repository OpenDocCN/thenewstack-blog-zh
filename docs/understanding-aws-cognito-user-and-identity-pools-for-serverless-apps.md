# 了解适用于无服务器应用的 AWS 认知用户和身份池

> 原文：<https://thenewstack.io/understanding-aws-cognito-user-and-identity-pools-for-serverless-apps/>

杰克·班尼特

杰克·班尼特是西雅图一家数码公司 POP 的首席技术官。

[Amazon Cognito](https://aws.amazon.com/cognito/) 是 Amazon Web Services 的服务，用于管理用户认证和访问控制。虽然它最初与 AWS 的移动后端即服务产品(MBaaS)相关，但它最近引起了无服务器人群的注意，他们正在寻找将用户管理问题转移到服务提供商的方法。Cognito 通过提供全面管理、可扩展且经济高效的注册/登录服务解决了这一问题，但代价是学习曲线陡峭。其中一个原因是因为 Cognito 由两个服务组成——用户池和身份池(也称为联合身份)——这两个服务表面上相似，但本质上不同。这两种服务解决相同的问题(即身份验证和授权)，但方式截然不同。它们也可以单独使用或一起使用，这样既灵活又容易混淆。

在本文中，我将简要介绍用户池和身份池，包括它们之间的微妙关系。然而，在我们深入解释之前，我们首先需要解释两个核心安全概念:身份验证与授权以及身份提供者。

## 身份验证与授权

在安全领域，术语“身份验证”和“授权”有非常具体的含义。身份验证是验证用户身份的过程。最常见的是，用户使用用户名(标识用户)和密码(确认用户就是他所声称的那个人)进行身份验证。相比之下，授权是在用户通过身份验证后授予他们对特定资源的访问权限的过程。例如，用户可能会根据他们的职位被分到一个或多个组中，然后应用程序会根据他们的组成员身份来确定他们可以使用哪些功能。

## 身份提供者

身份提供者是一种管理身份验证的服务，提供用户登录和验证用户身份的能力。AWS Cognito 有自己的身份提供商(使用用户池，这将在下面解释)，但它也可以与脸书和谷歌等成熟的第三方身份提供商集成。此外，Cognito 可以与任何实现 SAML 或 OAuth2 协议的身份提供者集成。与第三方集成进行身份验证的过程称为联合。

## 用户池与身份池—了解区别

正如我们前面提到的，AWS Cognito 由两个独立但相关的服务组成:用户池和身份池(也称为联合身份)。用户池为您的应用程序提供了一个用户目录，包括用户管理带来的所有功能，如注册、登录、组管理等。用户池还为您的应用程序提供用户 ID 和组成员等信息，以便您的代码可以处理授权。相比之下，身份池用于向通过单独的身份提供者进行身份验证的用户分配 IAM 角色。因为这些用户被分配了 IAM 角色，所以他们每个人都有自己的 IAM 权限集，允许他们直接访问 AWS 资源。

因为身份池将用户从身份提供者映射到 IAM 角色，所以它们本质上允许您将对 AWS 资源的授权委托给 AWS 本身。这是用户池和身份池之间的关键区别。用户池(本身)不处理 IAM 级别的权限。相反，它们向您的应用程序提供诸如组成员和用户 ID 等信息，因此您可以自己处理授权。相比之下，身份池在 IAM 级别授予用户权限。这意味着，就 AWS 服务而言，身份池允许更细粒度的权限集。

让我们用一个例子来说明区别。假设你正在使用 Cognito 和 Lambda 开发一个无服务器应用。如果您使用用户池来管理身份验证，那么您可以配置 API Gateway 将用户的 ID 和组成员身份传递到您的应用程序。这将允许您的代码确定用户是否有足够的权限访问所请求的功能。然而，用于访问底层 AWS 资源(如 DynamoDB)的 IAM 权限将来自 Lambda 执行角色。所有访问您的应用程序的用户都将在同一个 IAM 角色下操作，并且由您来确保正确的用户能够访问正确的资源。

但是，如果您的应用程序使用身份池，那么 AWS 会将用户分配到一个 IAM 角色，您可以在应用程序中传递与该角色相关联的权限。例如，这意味着用户可以用她自己的 IAM 权限访问 DynamoDB，而不是来自 Lambda 执行角色的应用程序范围的权限。

## 用户池+身份池:一起使用

现在，我们对用户池和身份池的区别有了更好的理解，让我们探索一下这两种服务是如何协同工作的。如前所述，身份池的主要用途是将用户从身份提供者映射到 IAM 角色。身份池没有自己的用户目录，它只是将其他用户目录中的用户分配给 AWS 环境中的 IAM 角色。通常，身份提供者是一个外部第三方，但如果它是作为 Cognito 用户池实现的，它也可以是您的应用程序自己的用户目录。由于 Cognito 用户池本身就是一个身份提供者，您可以配置您的身份池，以使用您的应用程序自己的用户池作为其身份提供者之一。这使您能够使用您的用户池对用户进行身份验证，并使用身份池为他们分配 IAM 角色。

令人困惑的是，术语“联合身份”(在 AWS 文档中与身份池同义)暗示了一种旨在与外部身份提供者集成的服务。因此，一开始将 Cognito 本身视为一个可用的身份提供者有点奇怪。

类似的困惑来源于这样一个事实，即你可以直接将外部社交提供商如脸书和谷歌与用户池集成，而根本不使用联合身份。使用这种方法，用户可以注册并使用他们的脸书登录帐户登录到您的应用程序，但他们永远不会被分配 IAM 角色。相反，用户池服务会自动将这些用户分配到一个脸书组，然后将其脸书简档的属性(例如，姓名、电子邮件、位置)映射到您在用户池中定义的用户属性。同样，这里的关键区别不是身份提供者是内部的还是外部的，而是身份验证后是否为用户分配了 IAM 角色。

## 用户池和/或身份池:哪种方法最好？

Cognito 在保护应用程序时提供了很大的灵活性。这使得 Cognito 可以被更广泛地使用，但也意味着需要理解更多的活动部分。以下是设计认知架构时应该问的三个问题。

首先，考虑在 IAM 级别管理安全性是否有意义。如果您有重要的 AWS 资源，可以使用 IAM 权限轻松地对其进行访问隔离，那么可以考虑使用身份池。例如，如果您在 S3 存储机密信息，并且每个存储桶存储不同部门的信息，那么使用身份池让 AWS 通过 IAM 管理对这些存储桶的访问可能是有意义的。另一方面，如果您的应用程序管理的大部分信息驻留在 Postgres 数据库中，那么 IAM 权限不会对您有太大帮助，因为它们不提供数据库中的行或列级粒度—只有您的应用程序代码可以做到这一点。

其次，确定您的应用程序是否需要与第三方身份提供者集成。如果是小型的内部业务应用程序，您可能不需要第三方集成。你的员工可能会很好地管理你的应用程序的独立登录。另一方面，如果你的应用是一个公共的、面向消费者的网站，提倡自助注册，那么让用户能够注册现有的社交账户是必须的，因为这将导致更多的注册。

第三，考虑复杂性和安全性之间的权衡。使用的服务越多，开发就越复杂。如果您可以使用没有第三方集成的用户池，那么您应该这样做，因为这是最简单的选择。但是，如果您正在处理需要由多个外部合作伙伴安全访问的高度机密的财务数据，那么您应该在应用程序级别和 IAM 级别管理访问，作为第二道防线，这将需要用户池、联合身份和高度精细的 IAM 权限。

## 结论

一旦您理解了用户池和身份池背后的基本概念，您就可以开始欣赏 Cognito 在保护您的应用程序方面的灵活性和强大功能。它出现在一个重要的时刻:新闻中充斥着因身份验证失败和访问控制失败而导致的数据泄露的报道。我们越了解应用程序安全性以及如何使用我们工具包中的安全工具，我们用户的数据就越安全。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>