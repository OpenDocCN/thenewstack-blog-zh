# mizar:Kubernetes 上与 XDP 的可扩展多租户网络

> 原文：<https://thenewstack.io/mizar-scalable-multitenant-networking-with-xdp-on-kubernetes/>

[Futurewei](https://www.futurewei.com/) 赞助本帖。

 [富川

Phu 是 Futurewei 的高级云软件开发工程师。在加入 Futurewei 之前，Phu 在华盛顿大学成像研究实验室实习，并向年轻学生教授编程。](https://www.linkedin.com/in/phudtran/) 

[Mizar](https://mizar.readthedocs.io/en/latest/) 是一个开源项目，提供云网络来运行虚拟机、容器和其他计算工作负载。我们以大规模和高性能为理念，从头开始建设 Mizar。Mizar 采用与云中分布式系统相同的方式构建，利用 XDP(快速数据路径)和 Kubernetes 来高效创建具有大量端点的多租户覆盖网络。这些技术都带来了有价值的额外津贴，使 Mizar 能够实现其目标。

有了 XDP，开阳能够:

*   尽可能跳过网络堆栈中不必要的阶段，将数据包处理转移到智能网卡。
*   高效地使用内核数据包处理结构，而不会受限于特定的处理器架构。
*   产生非常小的包处理程序(< 4KB)。

有了 Kubernetes，Mizar 能够:

*   有效地对底层核心 XDP 程序进行编程。
*   通过 CRDs 管理抽象的生命周期。
*   拥有可扩展的分布式管理平台。
*   在所有指定的主机上部署其核心组件和模块。

## Mizar 的目标和现有解决方案的局限性

当前基于流程的编程解决方案是不可扩展的，并且有许多问题和怪癖。以 OVS/OVN 为例，Mizar 旨在克服以下局限性:

*   每次配置端点时，都必须对每台主机进行编程。
*   数据包会穿过同一台主机上的多个网络堆栈。
*   难以扩展，创建 10，000 个逻辑端口会产生 40，000 多个端口绑定。
*   在流编程期间，我们通常会看到高 CPU 利用率。
*   随着现有端口数量的增加，配置端口的时间呈线性增长。
*   类似地，容器的供应时间也取决于现有容器的数量。

在克服这些问题的同时，Mizar 还有以下目标:

*   支持许多终端的供应(多达 1000 万)。
*   实现高网络路由吞吐量和低延迟。
*   为云网络创建一个可扩展的插件框架。
*   统一虚拟机、容器、无服务器和其他设备的网络数据平面。

## 米萨的整体组织

类似于在云中进行的联网，Mizar 允许对网络进行划分——通过我们向 Kubernetes 引入的两种新资源。这些是 VPC(虚拟私有云)以及其中的子网。为了使用这种新的组织方案在端点(pod)之间路由流量，我们利用 XDP 程序和网络内分布式哈希表来创建网络功能，称为 Mizar 的 Bouncers 和 Dividers。保镖在子网范围内工作，负责引导内部网流量。类似地，分隔器运行在 VPC 层，负责网间流量。此外，这些弹跳器和分隔器的配置可以隔离 pod 流量，从而支持多租户和跨多个租户重用相同的地址空间。

Mizar 的整体架构可以分为两类:管理平面和数据平面。管理平面和数据平面通过节点守护程序暴露的 RPC 接口进行通信。在接下来的部分中，我们将讨论其中每一个的关键特性和功能。

## 米扎尔管理飞机

Mizar 的管理平面利用 Kubernetes 的运营商框架、CRDs 和 Luigi 来管理和配置底层 XDP 程序/数据平面。

我们引入了六个 CRD，每一个都有一个操作者公开一个接口来管理它们的生命周期。每个对象或自定义资源的生命周期由三个工作流控制:创建、更新和删除。此外，这些工作流中的每一个都由它们各自对象中的状态变化触发。例如，如果要删除物理接口本身，则代表节点上的物理接口的 droplet 对象将触发管理平面删除工作流。

Mizar 管理平台推出的 CRD 包括:

*   VPC，包含以下信息:
    *   他们自己的 CIDR 山脉。
    *   他们的 VNI(虚拟网络标识符)。
    *   它们包含的分隔线的数量。
*   网络，其中包含以下信息:
    *   他们自己的 CIDR 山脉。
    *   他们的父母是 VPC 的 VNI。
    *   它们包含的保镖数量。
*   分隔线，包含以下信息:
    *   他们所属的 VPC。
    *   关于它们被提供的接口的信息(IP、MAC、名称等。).
*   保镖，其中包含以下信息:
    *   他们所属的网络。
    *   提供给它们的接口信息(IP、MAC、名称等。).
*   端点，包含以下信息:
    *   他们自己网络接口的详细信息(IP、MAC、名称等。).
    *   他们所属的网络。
    *   他们所属的 VPC。
    *   提供给它们的接口(IP、MAC、名称等。).
*   水滴，其中包含以下信息:
    *   它们代表的网络接口(IP、MAC、名称等。).

每个 CRD 中描述的信息主要用于数据层模块的编程，我们将在下一节中讨论。

## Mizar 数据平面

Mizar 数据平面由一组加载到网络接口上的 XDP 程序组成。

除了这些 XDP 程序，我们还在每个节点上运行一个守护程序，在数据平面和管理平面之间传递信息。这些计划的详情如下:

*   传输守护程序
    *   这个用户空间过程充当管理平面和数据平面之间的主要中继。守护程序的主要功能是根据管理平面传递的信息，对转接 XDP 和转接代理进行配置和编程。我们还公开了一个用于直接与守护进程通信的 CLI，其主要用途是测试和故障排除。
*   XDP 过境
    *   该 XDP 程序被加载到主机的接口上，从而处理所有定向到该接口的入站流量。
*   运输代理人
    *   这个 XDP 程序被加载到根命名空间中每个端点(Pod)的 veth-pair 上，处理来自接口的所有出口流量。

对于主机的入口流量，XDP 中转程序确定是否应该丢弃数据包，或者将其重定向到端点(Pod)或用户空间网络功能。

在解封装之后，为了到达 pod，分组被重定向到端点的 veth 对的 TX 队列。整个过程完全绕过了根命名空间中的主机网络堆栈。此外，要重定向到的目的地是由中转 XDP 程序根据先前通过 eBPF 映射从管理平面下推到数据平面的配置来确定的。此外，我们可以通过尾调用调用另一个 XDP 程序，或者如果一个包的目的地是一个网络函数，我们可以将这个包重定向到一个 AF_XDP 套接字。

类似地，传输代理处理和封装来自端点的所有出口分组。封装后，发往另一台主机的 TX 数据包通常会被重定向到目的地端点主机或保镖主机的主接口。在目的地端点在同一主机上的情况下，中转代理将通过 tail call 调用中转 XDP 程序，然后该程序将数据包重定向到共同托管的目的地端点的 veth 接口。

## 结论

Mizar 的当前和未来功能仍在由当前团队成员和外部大学合作者积极开发中。此外，还有许多细节和功能没有在这篇文章中介绍。想了解更多关于 Mizar 的信息并亲自测试，请访问我们的 [GitHub repo](https://github.com/CentaurusInfra/mizar) 。

自 2019 年成立以来，Mizar 已经走过了漫长的道路。截止到这篇文章，Mizar 回购已经获得了 300+的提交，并与 [Arktos](https://github.com/CentaurusInfra/arktos) 一起，在 Kubecon 2020 的[演讲中首次亮相。感谢所有的贡献者和合作者，是他们成就了 Mizar 的今天。](https://youtu.be/gptklnLaqMA)

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>