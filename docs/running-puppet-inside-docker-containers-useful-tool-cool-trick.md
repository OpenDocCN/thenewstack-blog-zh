# 在 Docker 容器中运行木偶:有用的工具还是很酷的技巧？

> 原文：<https://thenewstack.io/running-puppet-inside-docker-containers-useful-tool-cool-trick/>

周四，Puppet 宣布将有可能将 Puppet 自动化服务作为一套容器化的服务来运行。便携木偶代理、[木偶服务器](https://puppet.com/blog/puppet-server-bringing-soa-to-a-puppet-master-near-you)和[木偶数据库](https://docs.puppet.com/puppetdb/)的容器映像将于周四在 Docker Hub 上发布。

有了这些组件的容器化版本，Puppet 本身就可以由 Docker 或 CoreOS 托管，由 Kubernetes 或 DC/OS 编排，也许还可以由 Puppet 自动化。

但是正如 Puppet 高级软件工程师 [Gareth Rushgrove](https://twitter.com/garethr) 在接受新堆栈采访时所说，微服务架构使基础设施服务从这些服务寻求自动化的基础设施的容器中有效地实现成为可能。

“我同意将容器定义为可以来来去去的东西。但是从大量的容器中产生了一种服务，”拉什格罗夫解释说。“我认为 Docker 和一般的容器是为运行那些不会消失的服务而设计的。”

## 内部服务

Rushgrove 提醒我们，旨在从容器内部运行的服务通过 API 与外部世界通信。木偶在这里也不例外；很容易，整个 Puppet 自动化引擎，或者只是该引擎的某些必要部分，可以被实例化，可以响应 API 函数调用，并且可以退出。这些容器图像都是相同的；事实上，这是木偶公司周四发布的图像，作为其 [Enterprise](https://puppet.com/product) 2016.2 版本的一部分。

这位高级工程师继续说道，从依赖 Puppet 进行供应的资源(如 Puppet 代理)的角度来看，没有持久的、24/7/365 Puppet 服务器在数据中心运行并不重要。所有需要持久化的是管理构成数据中心基础设施的各种资源的活动状态的数据。毕竟，服务器和客户端之间的连接只是 HTTP。既然 Docker 和其他容器系统支持数据的持久容器，那么就不需要实例化持久服务器容器来有效地容器化 Puppet。

然而，Puppet 执行的自动化代码需要安装在一个持久容器 Rushgrove 中，以及 Puppet 代理在“呼叫总部”时产生的数据。

他坚持认为，新的 Docker 映像选项并不是要取代组织已经到位的平台的构建。换句话说，Puppet 并没有将微服务和容器化作为在旧基础设施上自动化旧应用的灵丹妙药。

相反，该选项使 Puppet 能够在以前不支持它的平台上运行——例如， [Red Hat 的 Project Atomic](https://thenewstack.io/project-atomic-creates-infrastructure-for-linux-containers/) ，一个极简的 Linux，如 CoreOS、Mesosphere Marathon、Kubernetes，甚至 Docker Swarm。他说，在 Swarm 上运行 Puppet 将让 Docker 的编排工具管理负载平衡和自我分配方面。

我们的目标是实现基础设施的自动化，这是众所周知的。理论上，如果数据中心的基础设施可以自动化，那么由该基础设施支持的应用可以变得更加可靠，并且更加独立于底层计算机的支持功能。

“当基础设施作为代码来管理时，”Puppet(以前的 Puppet Labs)出版的营销文献中写道，“多个团队可以合作，并且你可以为它带来成熟的敏捷软件开发实践:版本控制、同行评审、自动化测试和持续交付。”

基础设施通常被视为“堆栈”的原因是因为有多层支持，一层使下一层可行。在许多涉及集装箱化的模型中，位于堆栈顶层的是大量的集装箱，其中大多数旨在短暂运行，响应服务请求并迅速消失。

“优势在于，这些平台的操作系统没有本地傀儡代理，”拉什格罗夫说。在所有运行的软件都在一个容器中的平台上，Puppet 曾经被锁在外面，使得不可能获得关于这些不可访问的环境中的资源是如何运行和使用资源的洞察。“通过使用其他容器的包装，”他说，“我们可以将这些纳入管理。

“我们看到许多用户基本上持有一种[*态度*，‘一切都在我的虚拟机管理程序上运行。’我们有理由假设，一些非常有远见的新公司没有这种自动化遗留问题，他们会说，“我们将运行的所有软件都在一个容器中，因为它标准化了我们发布和部署所有软件的方式。如果不在容器里，我们就不运行，还是要自己打包。在木偶社区，有很多关于人们自己做这件事的现有艺术。上周，我与一个在 T4 牧场主 T5 上运营傀儡基础设施的人进行了交谈。"

拉什格罗夫承认，虽然那件轶事可能是一个“边缘案例”。木偶公司想今天发布这种新形式的包装的原因是——而不是等待微服务在日常业务中更加流行的时候——是“如果这成为规范，如果容器成为软件事实上的单元，我们要走在前面。”

## 情境意识

Puppet 的新 Docker 图像是该平台定期更新的一部分，正如该公司产品营销高级总监[蒂姆·佐卡](https://twitter.com/timzonca)对新 Stack 所说，这也提高了开发人员和管理员对该平台的可见性。Puppet 正在推广的关键词是“情境感知”，这是一种理解任何一个应用程序或服务的活动状态的愿景，相对于托管它的基础架构的整体视图。

这不是一个新短语；事实上，这是应用程序性能管理领域的产品在过去十年中宣称的目标——在 [Dynatrace](https://thenewstack.io/dynatrace-kicks-off-performance-bowl-superbowl-50/) 和 [New Relic](https://thenewstack.io/new-relic-revolutionizing-application-monitoring/) 领域。代理将情况数据报告回服务器进行存储，并从数据库中进行审查 Puppet 现在会与 APMs 竞争吗？

“作为操作员或 DevOps 工程师，此人的角色之一是[*确定*，‘我们了解情况吗？’Zonca 说。具体到 Puppet，我们在那里做的工作有两大类:一类可能类似于你在 APM 供应商那里看到的，但风格不同。我们看的是不同的东西，但这是围绕你的软件所发生的事情的保真度和细节水平。哪些变革已经成功展开？事情在哪里出错、失败或出错？什么事情发生了变化，这种变化是有意的还是无意的？"

他说，Zonca 提出的另一个情景意识类别更基本:对系统清单的更简单理解——这是任何面临合规问题的组织的要求。对于更传统的操作系统和虚拟化平台，简单地访问完整的软件清单需要遍历访问树、特权和权限，其技巧会让任何恶意用户嫉妒。

当然，由于这种过程通常不会自动进行，整个过程最终会更加个人化。

“如果我想知道发生了什么，在一台机器上做基本的清点，我必须弄清楚谁拥有那个东西，”他说。“然后我必须给那个人发一封短信，询问机器上的库存情况。这个人能够准确地回忆起所有事情的可能性很低。所以在几周内，我可能会有一个我非常怀疑的答案。”

我们以前听过这种说法:Puppet 不仅能够更全面地披露服务器的规格、运行特性和条件，还能披露它运行的软件资源以及谁对这些资源负责。

然而，正如任何容器开发人员所肯定的那样，这种结构的大部分假设了一种大约 2000 年的数据中心观点，其中客户机是一个操作系统，而用户是一个安全主体，试图通过该客户机访问服务器上的应用程序。作为一个容器形象的木偶对什么是“机器”会有一个非常不同的看法。因为这种观点会有所不同，所以需要多个傀儡代理在容器中一前一后地运行，以提供可以缝合在一起的集体快照(借用我妻子的一个比喻)来产生实际基础设施的更清晰的画面。

事实上，正如 Puppet 的 Gareth Rushgrove 告诉我们的那样，这就是计划。

“归根结底，木偶是由小零件组成的。并且各个部分被包装到容器中。同样，您可以在容器外部为堆栈添加弹性，您可以运行多个实例并对它们进行负载平衡。当你在一个容器编排系统中时，好的一面是它们倾向于内置这些原语。这就是附加值所在。”

Docker 是新堆栈的赞助商。

特征图片:[1912 年建造中的 F. W. Woolworth 大楼](https://en.wikipedia.org/wiki/Woolworth_Building#/media/File:Woolworth_Building_2_Feb._1912_LC-USZ62-105567.jpg)来自美国国会图书馆，在公共领域。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>