# Oxeye 发现 Spotify Backstage JavaScript 漏洞

> 原文：<https://thenewstack.io/oxeye-finds-bad-spotify-backstage-javascript-vulnerability/>

有多糟？一个[通用漏洞评分系统(CVSS)](https://thenewstack.io/cvss-struggles-to-remain-viable-in-the-era-of-cloud-native-computing/)10.0 分对你来说够差了吗？

如今，安全漏洞层出不穷，只有一个真正异常的安全漏洞才能引起我的注意。然而，云原生安全公司 [Oxeye](https://www.oxeye.io/) 发现 10.0 CVSS 漏洞后， [(CVE-2022-36067)](https://nvd.nist.gov/vuln/detail/CVE-2022-36067) 在 [Spotify 后台](https://backstage.spotify.com/)第三方模数闪烁如灰色阴天的一缕阳光。

如果你忘了，10 有潜在的巨大影响，这是一个关键的错误。换句话说:“修好它。现在就解决。”

## 后台正在使用

这不仅仅是 Spotify 用户和程序员的担忧。Backstage 在一个开发环境中统一了许多基础设施工具和服务，美国航空公司、网飞、Splunk、Fidelity Investments、Epic Games 和许多其他公司也在使用这个开发环境。Backstage 还用于保存 Prometheus、吉拉、ElasticSearch 等系统的集成细节，当然，很可能包括您的项目。

## 关键弱点

Backstage 的主要弱点在于它的软件模板。每个模板都由一个类似于 Kubernetes 资源的 YAML 文件定义。它包含定义组件应该如何操作的字段。提供给消息参数的数据是由 Mozilla [Nunjucks](https://github.com/mozilla/nunjucks) 呈现的模板。这适用于基于 JavaScript 的应用程序。它的基本思想来自于 [Jinja2](https://pypi.org/project/Jinja2/) ，Python 模板引擎。

到目前为止，一切顺利。 [Oxeye](https://thenewstack.io/oxeye-brings-multilayer-approach-to-software-security-testing/) 然而，注意到可以通过使用用户控制的模板操纵 Nunjacks 来运行 shell 命令。为了锁定这些 shell 命令的潜在问题，Backstage 开始使用 [vm2 JavaScript 沙盒库](https://github.com/patriksimek/vm2)。

但事实证明，有一种方法可以逃离 vm2。一旦泄露，攻击者就可以在主机上远程执行代码(RCE)。一如既往，这是个坏消息。

但下一个问题是，“这种利用可以在后台工作吗？”答案是:“是的，是的，可以。”

## 走出沙盒

通过使用模板强制 Nunjacks 运行 SecureTemplater.render 函数两次，攻击就可能从沙箱中爆发。这样，攻击者就可以在沙箱之外创建一个对象，比如一个可执行的任意系统命令。完成后，阻止攻击者为时已晚，因为他们在内部和外部造成损害。

好吧，那很糟糕。但是更糟的还在后面。原来你默认部署后台的时候，它没有认证机制。那是自找麻烦。果然，Oxeye 的研究人员发现，“一些可访问互联网的公共后台服务器不需要任何认证。”

哎呦。

雪上加霜的是，如果您添加了身份验证，而没有额外的工作，它只会在客户端执行身份验证。来自后端 API 的请求未经过身份验证或授权验证。

我们能再说一遍“哎呦”吗？为什么，是的，我们可以。

## 修复

要解决眼前的问题，您应该升级 [vm2 版本 3.9.11](https://github.com/patriksimek/vm2/releases) 。你还在等什么？去打补丁！

然而，Oxeye 也警告说，这里有一个更大的问题。我们假设沙盒是安全的。我是说，这是他们游戏的名字。但是，正如这一集所展示的，这并不总是一个安全的假设。

Oxeye 建议，如果你必须使用沙盒，你应该将应用程序中逻辑敏感的部分与运行沙盒代码的微服务分开。这样，即使黑客爆发，他们的攻击面也仅限于孤立的微服务。

该公司还警告说，你应该“尽可能避免使用依赖于 JavaScript 等动态编程语言的沙箱。这种语言的动态特性扩大了潜在攻击者的攻击面。”这是一个很好的观点，我建议您仔细检查一下您的沙箱，看看是否有更好、更安全的替代方案适合您的项目。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>