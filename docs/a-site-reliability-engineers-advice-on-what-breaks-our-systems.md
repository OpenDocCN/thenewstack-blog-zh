# 一位现场可靠性工程师对破坏我们系统的因素的建议

> 原文：<https://thenewstack.io/a-site-reliability-engineers-advice-on-what-breaks-our-systems/>

我们的问题有模式吗？一位现场可靠性工程师编制了一份清单，列出了“什么破坏了我们的系统:黑天鹅的分类”

劳拉·诺兰(Laura Nolan)已经在这个行业做了超过 15 年的软件工程师(最近是作为谷歌在爱尔兰的员工站点可靠性工程师之一)，在 USENIX 计算系统协会 LISA 会议上的一次令人难忘的演讲中分享了她的清单。诺兰将“黑天鹅”事件定义为那些罕见的不可预见的灾难性问题，“使我们的系统瘫痪，并长时间保持瘫痪。”但更重要的是，她还就“我们如何针对这些类别的事件强化我们的系统”提出了建议

“分类法”将灾难性事件分为六类。

*   触及极限
*   传播缓慢
*   隆隆作响的牛群
*   自动化交互
*   网络攻击
*   依赖性问题

“限制问题可以在许多方面发生，”Nolan 说，他引用了 RAM 等系统资源、缓冲区大小和事务 id 等逻辑资源。Nolan 建议对一切进行负载和容量测试，包括你的云服务。"

“我曾经花了一年的时间，除了负载测试之外，几乎什么都不做，”她说。

使用生产环境的良好副本—包括写入负载、备份、启动和重新共享—以及增长超过当前负载大小的数据集，“以便您知道是否会达到这些限制之一。”别忘了还要测试辅助数据存储，比如 Zookeeper。

她还建议进行监测，并警告说“已知极限的最佳记录是监测警报。”(“记录下来，”诺兰说，“解释限制的本质和建议的解决方案是什么。”)或者，正如诺兰所说，“然后，如果你已经离开了，五年后，收到警报的人，以后会得到警告，并能够对此采取行动。”

诺兰补充了一个更有用的提示。"监控图上显示限制的线条非常有用."

但是借助于[工业](https://sreweekly.com/) [验尸](https://github.com/danluu/post-mortems)，诺兰用一些现实世界的例子记录了她的建议。对于触及极限，一个例子是 Instapaper 的 2017 年活动。该公司在 Amazon MySQL RDS 上运行生产数据库。“在他们不知道的情况下，他们备份到了一个有 2TB 限制的 ext3 文件系统上。他们遇到了这种情况，突然之间，他们的数据库停止接受任何写入，他们花了一天多的时间才恢复正常……”

2010 年，Foursquare 在一个 MongoDB 碎片“超过了它的内存”后经历了 11 个小时的全面站点中断，严重降低了它们的性能。或者，就像诺兰所说的，“满负荷时重新洗牌很难。”

对于灾难类型#2，“传播缓慢”，诺兰提供了一个通过借鉴 2018 年 HostedGraphite 的事后分析传播缓慢的例子。“AWS 出了问题，HostedGraphite 也倒闭了。但他们没有运行 AWS，”她说。相反，来自 AWS 的较慢连接填满了 HostedGraphite 的负载平衡器，最终达到饱和。

2017 年在 Square 发生的事件是由其认证系统的问题引起的。“我想任何运营网站的人都知道，如果你的(认证)系统不好，那么一切都不好，”她说。罪魁祸首是“一段代码，它在零回退的情况下重试 Redis 事务多达 500 次。”Nolan 将此比作对您自己的 Redis 集群进行拒绝服务攻击。

幸运的是，她提出了一个恰当的辩护:“快速失败。”

“很难完全防御这种情况，但准则是快速失败比缓慢失败更好，”诺兰解释道。“如果您的服务有负载，并且您知道您可能永远无法提供服务，那么不要让队列无限增长。切断。有一种方法，让你的服务可以说，‘我超载了’，停止。”

Nolan 还推荐了所有请求的截止日期，包括服务内外的请求。"如果事情没有进展，不要只是让事情停在那里，占用资源."限制重试次数—通常不超过三次，增加每次重试之间的“回退”时间。

另一个解决方案是:实现断路器模式。“您不必在每个请求的基础上处理重试，而是在前端放一个软件小部件，它可以看到从特定客户端发出的所有请求，该客户端可能会为许多用户请求提供服务，然后发送到后端服务。如果它在所有这些请求中发现后端服务不正常，它会在这些请求转到不正常的服务之前，快速使它们失败。”

此外，使用仪表板(用于利用率、饱和度和错误)。“从根本上说，这些问题大多是由某个地方的某些东西饱和引起的。因此，快速调试和补救的关键是能够找到什么是饱和的，”她说。

“没有什么比坐在那里看着组成网站的一系列微服务更糟糕的了，你的网站在爬行，而你甚至不知道哪个服务实际上造成了这种情况。这些灰色的、缓慢的拖拉错误很难找到问题的根源。所以这真的会对你有帮助。”

“雷鸣般的牛群”指的是需求的突然激增。“一个经典的老派做法是让你组织中的所有 cron 工作在午夜开始，”诺兰解释道。但其他示例包括在特定时间更新的移动客户端，以及大型批处理作业。

“我在谷歌工作，所以我们不得不担心人们启动 10，000 个工人 MapReduces，尤其是实习生，”她说。

例如，诺兰提到了 2014 年 Slack 的一个事件。Slack 使用基于 WebSockets 的 API，“因此客户端与后端有长时间运行的会话。他们不得不重启他们的一台设备，一台服务器。这导致他们大约 13%的用户群断开连接——然后他们马上重新连接上。在 Slack 的架构中，在重新连接时，客户端试图查询一大堆东西，比如 Slack 团队中有哪些频道，其中有哪些用户，最近有哪些消息。所以所有这些协调的需求使他们的数据库饱和了。”

建议的防御措施是测试和计划。“真正的防御是不要陷入‘哦，好吧，我怎样才能让一群雷鸣般的人为我服务？’因为正如我们所看到的，有各种不同的方式可以发生这种情况，”她说。

“所以想想降级模式。如果你的服务忙到没时间服务，能不能服务点静态的？你能提供更小的数据集吗？有没有一些要求你可以放弃…？也许您可以将输入排队到一些轻量级的廉价队列中，然后再进行繁重的处理，而不是必须同步进行繁重的处理…

“并测试它。”

黑天鹅的另一个原因是自动化交互。诺兰警告说，尽管自动化很棒，“这么说吧，它并不完全安全，”她说。然后她解释了 2016 年谷歌意外“删除”其内容交付网络的时间。

一名工程师曾天真地试图将一架机器发送到磁盘擦除进程，但“由于一个不幸的 regExp 事件，它匹配了世界上的一切，”诺兰解释说。这导致了两天的查询变慢和网络拥塞，直到系统恢复。

“这是相当多的机器，”诺兰回忆道，但“足够幸运的是，谷歌基本上计划这些机器是为了减少延迟，而不是为了网站的工作而必须存在的东西。所以事情变得稍微慢了一点，有几天交通更加拥挤，直到全部重建。但一切仍然正常。所以这是一种侥幸的逃脱。”

除了对自动化操作设置一些约束(并有办法关闭它们)之外，这里真正的解决方案是控制——包括自动化可见性的日志。"一个松弛的通道工作，你的日志系统——任何有意义的东西."

谈到网络攻击，“这里的防御是最小化爆炸半径，”诺兰告诉她的观众。她建议尽可能将生产和非生产工作量分开。“将生产系统分成多个区域。限制和控制他们之间的交流，”她说。

“谷歌做了一件非常酷的事情，”诺兰回忆道。“所有进入生产环境的请求，所有进入生产环境的流量，比如 SSH 等等，都要通过代理。所以这里有纵深防御。事情在网络层被锁定，然后在应用层，只有那些代理允许的东西才能进入。”

例如，诺兰查看了 2017 年全球航运公司马士基被 NotPetya 恶意软件感染的事件。它的一台办公机器运行着易受攻击的会计软件。该公司无法卸货，也无法连续几天接受订单。该公司因为这个 bug 损失了 20%的业务。

诺兰的推荐？"验证和控制生产中运行的内容."

列表中灾难性失败的最后一个来源是依赖性问题。

诺兰提出了一个挑战:你能在没有任何基础设施运行的情况下，从头开始启动整个服务吗？她警告说“同时重启会发生。现在不是注意到您的存储基础架构依赖于您的监控来启动的时候，而监控又依赖于您的存储启动的时候……”

诺兰还警告说，“在现代微服务架构中，你很容易陷入这种情况。”她的榜样？2018 年 1 月 GitHub 停电两小时。该公司“电力中断，只是他们电力供应的一个小问题。他们的主数据中心有 25%的机器重新启动了。”但是当 Redis 集群仍然“不健康”时，该公司的工程师发现它也“无意中变成了一个硬依赖，所以他们必须在恢复之前实际重建该集群。”

她还总结了 2017 年的一次特雷罗停电。“AWS S3 宕机导致他们的前端 web 应用程序宕机。Trello API 本应该很好，但事实并非如此。它正在检查 web 客户端是否启动，尽管它并不依赖于它。”或者，正如诺兰所说，“他们的 API 服务正在检查他们的前端是否启动，没有任何好的理由。”

解决方案包括对您的基础设施进行分层。“决定每个服务在哪一层，只让它依赖于较低层的东西，”Nolan 解释说。“测试启动基础设施的过程。完整的数据集需要多长时间？”

当然，要小心那些随着时间推移会变成硬依赖的软依赖…

在“心理学”的标题下，演讲以一些善意的想法结束

“如果你正在管理一个团队，而有人刚刚经历了一整天或几天的可怕事件，那么试着缓解他们的压力，将随叫随到的工作交给其他人，给他们一点时间休息，因为他们暂时不会有用。”

* * *

## WebReduce

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>