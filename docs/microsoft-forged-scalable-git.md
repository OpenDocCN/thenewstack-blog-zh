# 微软如何打造可扩展的 Git 来更好地管理 Windows 开发

> 原文：<https://thenewstack.io/microsoft-forged-scalable-git/>

由于对 BitKeeper 的局限性感到失望， [Linus Torvalds](https://github.com/torvalds) 在十年前的一个周末从零开始创建了 [Git](https://git-scm.com/) 分布式源代码控制软件[，作为管理 Linux 内核正在进行的开发的更好的方式，多年来已经有数千名开发人员](https://www.linuxfoundation.org/blog/10-years-of-git-an-interview-with-git-creator-linus-torvalds/)[添加到它的代码库](https://thenewstack.io/contributes-linux-kernel/)。

感受到自己版本控制工作的局限性，微软采用 git 来管理自己可观的软件产品组合。但是，尽管 Git 承诺简化 Windows 上的多开发人员工作，这个雷德蒙巨人也发现该软件难以扩展。超过 300GB 的源代码分布在 500 万个文件中，Windows 对于 Git 来说太大了。获得一个简单的 git 状态需要 18 分钟；Git 提交可能需要半个小时。

因此，该公司开发了 [Git 虚拟文件系统](https://github.com/Microsoft/GVFS)作为虚拟化层来加速操作。在今年的 Microsoft Connect()大会上，该公司宣布与最大的基于 git 的托管服务 GitHub 合作开发 GVFS。

在会议上，我们与微软公司副总裁 Brian Harry 进行了交谈，Brian Harry 负责监管公司的发布管理服务，Azure 上提供的[Visual Studio Team Services](https://www.visualstudio.com/team-services/)(VSTS)(也称为[Team Foundation Server](https://www.visualstudio.com/tfs/)(TFS)，对于那些希望在内部部署此类功能的人来说)，以了解更多关于 GVFS、VSTS 和 TFS 的最新发布以及正在采用的应用程序部署和管理的[devo PS](/category/devops/)方法。

**就采用 DevOps 而言，您在微软商店看到了什么？**

我认为我们在微软社区看到的和我们在所有开发人员社区看到的一样，都非常关注更加敏捷和更加快速的响应。早在 21 世纪初，关注的焦点是敏捷运动的开始，持续的集成和单元测试以及诸如此类的实践。然后它发展到 SCRUM，然后是看板和项目管理方面。现在的重点是实现部署流程的自动化。我如何消除将所有代码投入生产的摩擦，以便我可以更频繁地更新，更频繁地打补丁，更频繁地响应反馈？我接触的每一位顾客，都想谈论这个话题。

**这是由竞争需求驱动的，还是 it 的自然发展**？

我认为两者都有。其中一些是由客户期望驱动的。顾客只希望东西是新鲜的、新的、不断更新的。其中一些是由竞争驱动的。如果我处于六个月的部署周期，而另一个人处于两周的部署周期，我将会失败，因为他将会更快地做出响应。

听着，你总是会犯错。你总是会错过一些东西，得到一些不对的东西。迭代次数越多，就越有机会做对。

在过去，it 和开发之间的关系非常疏远，开发人员开发一些东西，然后交给 IT 部门。配置部署所需的硬件需要三个月的时间，然后他们必须对部署进行一系列测试和验证。在某个时候，它会被部署。与此同时，开发人员花了几个月做其他事情，甚至不记得他们在那个版本中放了什么。

这种不连续性产生了巨大的摩擦。因此，最大的转变之一是消除移交。这可能是一件可怕的事情。这确实意味着你的责任改变了。我的意思是，如果我看看我的组织:几年前，它就像我描述的那样工作。现在，运营与配置基础架构没有任何关系，因为一切都在云中，而云就是这样做的。行动中心和部署已经没有任何关系了。都是自动化的。它只是来自执行部署的工程团队的脚本。这是不是意味着 ops 没有工作了？不。行动组还有很多事要做。对我们来说，他们进行容量规划，他们仍然深入参与事件管理和安全。在当今的威胁世界中，保护这些系统至关重要，并且比过去更加复杂。

所以你只需要重新分配职责，这样就不会有交接。

**所以系统管理员的角色发生了很大的变化。好的，请问 Visual Studio Team Services 和 Team Foundation server 给开发环境带来了什么**？

当然可以。首先，Team Foundation Server 和 Visual Studio Team Services 有两个不同的名称，这很奇怪，但它们基本上是一回事。Team Foundation Server 位于内部，Visual Studio Team Services 位于云中。它们都提供了一套丰富的 DevOps 服务，从允许你做信号量和冲刺的规划，到你托管 git repos 的源代码控制等等。我们拥有一个名为 [Team Foundation 版本控制](https://www.visualstudio.com/team-services/tfvc/)的集中式版本控制系统。我们拥有持续集成和构建管道的能力。我们拥有跨环境管理各种分阶段发布和管理部署的发布能力。我们有测试能力。我们有软件包管理来管理您的所有二进制资产。

这些工具几乎涉及到您的 DevOps 生命周期的方方面面。同时，它们是可组合的。所以在几年前，对 TFS 的一个批评是，它是一个整体，你必须使用它。在过去的几年里，情况发生了很大的变化。你不需要。如果你想在 GitHub 中拥有你的代码，并且你想使用我们的 CI/CD 系统，很好。它与 GitHub 配合得非常好。如果你想用 GitHub 做源代码，用 Jenkins 做你的构建，然后你想用我们的持续部署系统来管理部署，很好。我们的 CD 系统和 Jenkins 配合得很好。

我们还支持所有这些东西的可追溯性，所以我们与它们深度集成，实际上我们更关注于使系统成为一组可组合的部分，允许您将它与您最喜欢的工具一起使用。

**微软在今天的大会上宣布了这项服务的一些更新。一个是释放门。能解释一下它们是什么**吗？

没错。所以先说问题。因此，在任何 DevOps 过程中，当您向大量客户发布时，您必须非常小心。首先，你要认识到你会运送 bug。我不管你用什么测试流程，你都会出货 bug。所以问题就变成了，“你打算怎么处理你运送的虫子？”你会将这种新代码部署到所有 100 万用户中，然后有 30 万人遇到这种错误，然后你会得到 30 万个不满意的客户吗？还是将它部署到 1，000 个客户，让 1，000 个客户遇到错误，然后修复它，然后部署到下一个 1，000 个客户，然后逐步推广，这样您就有一种可控的方式来管理和控制您面临的风险？

因此，我们将这种逐步累积过程的概念正式化为我们内部使用的环。我们有环 0、环 1、环 2、环 3 和环 4。环 0 只是微软。因此，当我们部署环 0 时，除了我们自己，我们不会影响任何人。一旦我们在那里感到满意，我们就转到环 1，从那里继续下去。

每响一次，我们要等 24 小时。我们展开一个环，我们等待 24 小时，我们观察健康监视器，我们寻找任何可能出问题的迹象。如果有问题，我们停下来解决，然后继续推出。它以这种方式穿过所有五个环。

释放门是这一过程的正式形式。在我们的发布管理系统中，我们已经有能力找到这些东西流动的环境。发布门允许你做的是自动化准备检查。因此，我可以为一个环境定义发布门，它测量一些 KPI，看着一些东西并说，“这个发布，这个环境不被认为是健康的，除非以下是真的。”

因此，您可以在这个环境中配置流程等待六个小时。在这六个小时中，您可以设置五个指标进行监控。如果在这六个小时结束时，如果所有五个指标都是绿色的，那么它将进入下一个版本。

我们引入了两种释放门。一个是 Azure monitoring release gate，你可以连接它来观看任何 Azure 警报。你设置了一个门槛，上面写着，“超过这个量就被认为是不健康的。”

然后你可以做的第二件事是让它监视或处理你的查询。我们利用这一点。假设客户在我们的 24 小时窗口内报告了一个问题。我们接到一个电话，或者收到一封电子邮件，或者从我们的开发者社区网站上得到一个 bug 文件。如果这是一个严重的错误，它将被归类为发布阻塞错误。因此，我们的发布网关将监视该查询，如果在我们的 24 小时结束时，如果有任何发布阻塞错误仍然活跃，它将保留该发布。

这就是你对它的看法。现在我们还有另外三个发布入口，它们是可扩展性点。你可以调用一个 Azure 函数。你可以在任何地方调用任何 REST API，或者你可以在服务总线上发布一条消息，然后这些允许你创建你想要的任何释放门。我用过的一个例子是，我让我的团队编写一个样本，我们将开放源代码，让每个人都知道如何监控 Twitter 情绪，因为这是我们关注的事情之一。今天我们手动观看。我们正在关注 Twitter，如果我们看到 Twitter 因人们有问题而亮起红灯，我们将阻止发布。但最好在发布上有一个指标，上面写着，“哦，既然你发布了这个，既然你部署了这个，就像你的 Twitter 人气显著下降了一样，让我们去看看，看看这是否真的代表了一个问题。”

这就是释放门的基本意义。它在这个逐步展开的过程中自动检查准备情况。

**什么是 Git 虚拟文件系统？这是什么？为什么会这样？怎么会被 GitHub** 使用？

大约三年前，我们在研究我们的工程系统。作为其中的一部分，我们正在研究版本控制。我们内部有一堆不同的版本控制系统。经过一番讨论后，我们决定将整个公司迁移到 git。那是我们想去的地方。但与此同时，看看 Git 的现实，这将是不可能的。我们有一些非常大的代码库。典型的是 Windows 代码库，它现在在 Git 中，是一个 300GB 的 repo，这在 Git 中是不可想象的。它太大了。你要记住，Git 克隆了你的机器上的整个回购，谁想要 300GB 下载到你的机器上。

所以我们知道，要执行迁移到 Git 的战略决策，我们真的必须加入 Git 社区，并开始帮助 Git 朝着可伸缩的方向发展。所以我们开始了这个项目，GVFS 就是从这个项目中诞生的。基本上是一个东西的组合。其中一部分是性能调优，让 Git 对每个人都更好。

具体来说，GVFS 是我们添加到 Git 中的虚拟化层，例如，它使您能够克隆 sit repo，这样您就不会得到所有东西。你只能得到一些做基本操作所必需的元数据。当你触摸文件时，它会返回并下载你需要的文件。Windows 是 550 万个文件。如果我只处理其中的 10，000 个文件，我只能得到这 10，000 个文件。

另一个维度是深度。如果我只使用这 10，000 个文件的当前版本，我只能得到这 10，000 个文件的当前版本。如果我需要返回并访问六个月前的版本，那么当我需要这样做时，我会返回到 git 服务器，下载我需要的历史记录，现在它会在本地缓存，因此后续访问非常快，但它们只会在我需要时获得我需要的部分。从表演的角度来看，这很有戏剧性。区别是白天和黑夜。

我的意思是，当我们第一次开始时，如果我试图克隆 Windows repo，实际上从未成功过。它只是会超时。这没用。Git status 告诉您更改了哪些文件，它通常是一个即时操作。当我们第一次开始使用 Windows repo 时，对 Git 状态的操作大约需要 18 分钟。Git 提交大约需要 30 分钟。

有了 GVFS 和我们所做的所有性能调优工作，git clone 大约需要 Windows repo 的一分半钟。Git 状态大约是两秒半。Git 提交大约需要五六秒。互动行为的合理数字。

所以我们发布了这个。GVFS 是一个开源项目。任何人都可以接触到它。我们公布了协议。以便任何 Git 服务都可以实现它。我们本周宣布将与 GitHub 合作，继续推进这项工作。GitHub 非常明确地投资于 Git 和 Git 的未来。它希望将 GVFS 支持添加到 GitHub 中，并与我们合作继续推进 Git，帮助我们加快获得 Mac 和 Linux 客户端的工作。我们做了一个 Windows 客户端。我们正在开发 Mac 客户端。我们还没有启动我们的 Linux 客户端，尽管它已经在路线图中了。我们正计划这么做。GitHub 将与我们合作，帮助我们更快地完成这项工作。因此，我们将作为开源项目中的同行一起工作，推动它向前发展。

在今年的 Connect 中，我们还应该记住什么？

我们还宣布了[符号服务器](https://msdn.microsoft.com/en-us/library/windows/desktop/ee416588(v=vs.85).aspx)对 Visual Studio 团队服务的支持。开发人员面临的一个问题是，他们开发了一个应用程序，然后把它交给某个人，这个应用程序就会崩溃或者无法在你的机器上运行。它在我的机器上工作。所以我需要去你机器调试，但是你没有源码。

因此，Symbol Server 为您提供了一种能力，让我可以进入您的计算机，将调试器附加到您正在运行的进程，检查进程，查看 dll 的版本，进入 VSTS，找到与之相关的符号，下载它们，找到与这些符号相关的代码，下载您要调试的文件。我在您的机器上获得了丰富的源代码调试体验，即使您的机器上没有任何代码。所以这很酷。我们现在有符号服务器内置在 VSTS 的一部分。我们还将把它包括在 TFS。它不在 2018 年 TFS 奥运会上，因为它刚刚上了云，它将进入 TFS 的未来更新。

[微软](https://azure.microsoft.com/en-us/?v=17.14)是新堆栈的赞助商。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>