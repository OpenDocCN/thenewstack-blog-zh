# 图像构建和扫描的 3 个最佳实践

> 原文：<https://thenewstack.io/3-best-practices-for-image-building-and-scanning/>

[](https://www.linkedin.com/in/amitgupta1/)

 [艾米特·加普塔

阿米特是 Tigera 的首席产品官，负责 Tigera 产品的战略和愿景，并领导公司路线图的交付。Amit 是一名亲力亲为的产品执行官，在构建跨多个领域的软件产品和服务方面拥有专业知识，包括云安全、云原生应用程序以及公共和私有云基础架构。](https://www.linkedin.com/in/amitgupta1/) [](https://www.linkedin.com/in/amitgupta1/)

随着企业为云原生应用采用容器、微服务和 Kubernetes，漏洞管理对于在构建、部署和运行时提高容器化工作负载的安全性至关重要。

保护您的构建工件和部署管道，尤其是当涉及到映像时，是极其重要的。

通过在整个应用程序开发和部署过程中遵循映像构建和扫描的最佳实践，您可以帮助确保环境中容器和工作负载的安全性。

让我们看看选择基本图像、强化容器图像和[容器图像扫描](https://link.tigera.io/ueMev)的一些细微差别，包括选择合适的扫描解决方案和解决隐私问题的技巧。

## 选择合适的基础图像

选择一个可以减少容器攻击面的基础映像是很重要的。我推荐使用[发行版](https://github.com/GoogleContainerTools/distroless)或[临时](https://hub.docker.com/_/scratch)映像，因为它们只包含应用程序及其运行时依赖项。这两种类型的映像都通过减少攻击面和漏洞来改善您的安全状况。

如果由于某种原因你不能使用一个发行版或者临时镜像，选择一个最小的发行版。现代不可变的 Linux 发行版，如 Bottlerocket 和 Flatcar Container Linux，可以用作容器的基础映像，传统 Linux 发行版的最小版本，如 Ubuntu、Red Hat 或 Alpine 也可以。虽然最小映像可以工作，但请记住，这种类型的映像不能防止操作系统(OS)包中的漏洞。

## 强化你的容器形象

容器映像强化增加了防御层，允许您在容器内安全地运行应用程序，同时还减少了安全漏洞和攻击面。为工作负载构建强化的容器映像非常重要，因为非强化的映像会使您的工作负载面临一系列风险，包括向容器主机泄露信息和权限提升。

以下是强化容器图像的几种方法。

*   **仅使用来自可信来源**的基础映像，例如官方 Ubuntu 或 Red Hat 发布渠道。
*   **根据发布的信息仔细检查图像的哈希**，即使它来自可信的来源。对于攻击者来说，在基本映像中嵌入恶意代码并不困难，然后让映像在 Docker Hub 这样的存储库中可用。
*   **最小化您的基本图像**。它们应该只包含应用程序的运行时依赖项。
*   **遵循最低特权原则，以最低的必要权限运行容器**(尽可能以非根用户身份运行容器)。这样，攻击者将更难逃离容器，就像发生在 [CVE-2020-15257](https://research.nccgroup.com/2020/11/30/technical-advisory-containerd-containerd-shim-api-exposed-to-host-network-containers-cve-2020-15257/) 漏洞中的那样。
*   **使用容器图像签名验证图像**。虽然 Kubernetes 本身不包含容器图像验证工具，但您可以使用 Docker 公证人来签署图像，并使用 Kubernetes 准入控制器来验证图像签名。

如果使用 Docker 图像，我建议如下:

*   **不要使用标签:**标签(例如像 *latest* 或 *master* 这样的可变标签)会导致应用程序稳定性问题，如果一个依赖库被移动或更改的话。它们还会导致 CI/CD 管道中的图像扫描出现问题，因为它们会定期更新功能和修复。不使用标签，而是在 Dockerfile 文件中固定基础镜像版本(比如 ubuntu:20.08)。
*   **将图层压缩成一个单层:**图层显示开发历史，可以揭示敏感信息。因为用 Docker 构建的容器映像往往包含多个层，所以应该使用多级构建或`[option--squash](https://docs.docker.com/engine/reference/commandline/image_build/)`(Docker API 1.25+中提供的一个实验性 Docker 守护进程)来压缩现有层。

## 扫描您的容器图像

容器映像扫描有助于确定映像中是否存在易受攻击的组件，方法是检查容器的文件系统和元数据，然后将收集的数据与来自各种可信来源(如国家漏洞数据库或私人情报来源)的漏洞信息进行比较。有很多可用的扫描工具，包括开源的和商业的。

您需要确保您的映像扫描工具扫描了容器映像中的所有操作系统包，并且它理解您的应用程序所使用的语言，以便能够扫描应用程序的依赖关系。一个好的集装箱图像扫描工具还应该:

*   **检测文件系统中存在的敏感文件**，如证书和密码
*   **扫描二进制文件**(如。精灵或者。exe)
*   **融入你的 CI/CD 系统** 
*   **假阳性率低。**(注意，在集装箱图像扫描过程中会出现误报和漏报；您的应用程序和安全团队将需要分析这些并评估风险。)

虽然许多公共云提供商和容器注册服务提供商提供图像和容器扫描服务，但他们中的许多人不扫描应用程序依赖性，并且仅支持有限数量的操作系统版本。

由于有关产品安全漏洞的信息是敏感数据，一旦落入不法之徒手中，将会成为一大隐患，因此在选择扫描工具之前，不要忘记解决数据安全和隐私问题。为了了解数据暴露的风险，了解扫描工具将收集哪些数据以及如何收集非常重要。例如:它是只收集包元数据，还是将您的容器图像上传到它的 SaaS 服务？

为了确保该工具符合您的安全和/或法规遵从性团队制定的指导原则，您还需要确定该工具是将收集的数据存储在本地还是云中作为 SaaS 的一部分。如果使用商业工具，一定要检查合同，以了解在数据泄露的情况下什么样的条款是适当的，或者如果使用开源工具，一定要检查文档，以了解数据泄露的风险。

## 摘要

本文中包含的提示和最佳实践是漏洞管理的良好起点。我推荐阅读《Kubernetes 安全性和可观察性:保护容器和云原生应用的整体方法》的第 3 章，这是我帮助 O'Reilly 撰写的一本书。

*劳拉·弗格森对本文有贡献。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>