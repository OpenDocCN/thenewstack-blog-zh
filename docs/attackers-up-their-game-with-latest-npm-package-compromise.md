# 攻击者通过最新的 npm 包妥协提升他们的游戏

> 原文：<https://thenewstack.io/attackers-up-their-game-with-latest-npm-package-compromise/>

针对开发生态系统和包存储库(如 npm)的软件供应链攻击变得越来越复杂。在最近的事件中，一名攻击者将社交工程与依赖滥用相结合，对一个每周下载量达 200 万次的包进行后门攻击。

这一切都开始于一周前，当时有人注意到一个名为 flatmap-stream 的包，一个对[事件流](https://www.npmjs.com/package/event-stream)的依赖，正在注入一些 AES 加密的代码。Event-stream 是一个工具包，帮助开发人员更轻松地在 Node.js 中创建和使用流。它被近 1，600 个节点包使用，每周从 npm 注册表下载约 180 万次。

Flatmap-stream 在 9 月份作为事件流的依赖项被添加进来；不是由最初的维护者，而是由获得软件包发布权的用户。似乎这个用户使用了 right9ctrl(现在在 GitHub 和 npm 上暂停了)这个句柄，成功地说服了原作者 [Dominic Tarr](https://github.com/dominictarr) ，在做了一些合法的代码贡献后，将这个包转让给他。

塔尔在[GitHub](https://github.com/dominictarr/event-stream/issues/116#issuecomment-440927400)上的一次讨论中说:“他发邮件给我，说他想维护这个模块，所以我把它给了他。”。“我没有从维护这个模块中获得任何东西，我甚至不再使用它，而且已经多年没有使用它了。”

分析恶意代码的人得出结论，只有当环境包含一个名为 copay-dash 的库时，它才会注入其有效载荷，该库是用于桌面和移动设备的安全比特币和比特币现金钱包平台 [Copay](https://copay.io/) 的一部分。这意味着该攻击旨在只针对 Copay 开发人员，他们的环境中会有该库，目的是毒害应用程序的官方版本，然后分发给用户。

注入 Copay 的最后一个有效载荷旨在窃取用户包含超过 100 个比特币或 1000 个比特币现金的钱包的私钥，并将这些密钥和账户细节发送到由黑客控制的远程服务器。

总之，这是一个高度针对性的多阶段攻击，其中一个应用程序通过供应链中更高层的后门依赖关系受到危害。为了理解其复杂性，npm 安全团队在[事后分析](https://blog.npmjs.org/post/180565383195/details-about-the-event-stream-incident)中描述了攻击链:

*注入的代码:*

*   *从伪装成测试夹具的文件中读入 AES 加密的数据；*
*   *抓取导入它的模块的 npm 包描述，使用自动设置的环境变量；*
*   *使用包描述作为密钥来解密从伪装文件*
    *中拉入的一大块数据，解密后的数据是模块的一部分，然后在内存中编译并执行。*

*本模块执行以下操作:*

*   *解密了伪装文件的另一大块数据；*
*   *从第一个解密的块到第二个解密的块的末端连接一个小的注释前缀；*
*   *执行较小的解码任务，将连接的代码块从无效的 JS 转换为有效的 JS(我们认为这样做是为了逃避动态分析工具的检测)；*
*   *将这个处理过的 JS 块写出到一个文件中，该文件存储在一个依赖项中，该依赖项将被构建脚本打包。*

*写出的代码块是真正的恶意代码，打算在 Copay 终端用户拥有的设备上运行。*

*这段代码将执行以下操作:*

*   *检测当前环境:手机/科尔多瓦/电子；*
*   *查询受害人 copay 账户上的比特币和比特币现金余额；*
*   *若当前余额大于 100 比特币，或 1000 比特币现金:* *收获受害者的全部账户数据，* *收获受害者的共付私钥；*
*   *将受害者的账户数据/私钥发送给 111.90.151.134 上运行的收集服务。*

Copay 开发人员证实，该应用程序的 5.0.2 到 5.1.0 版本包含恶意代码。npm 安全小组取得了事件流包的所有权，并从注册表中删除了版本 3.3.6，以及恶意的平面图流依赖项。

“对于 npm 用户，你可以通过运行 npm 审计来检查你的项目是否包含易受攻击的依赖，”该团队说。如果您已经安装了此事件流的受影响版本，我们建议您尽快更新到更高版本

这一事件凸显了检测和防御这些攻击有多么困难，尤其是在像 npm 这样的大型生态系统中，那里有成千上万个具有数百万相互依赖关系的包。恶意代码是在 9 月份添加的，两个月后才被发现，黑客有足够的时间来实现他们的目标。

该攻击还表明，为了将恶意代码注入到包中，甚至没有必要损害开发人员的机器。找到愿意甚至渴望放弃很久以前编写的包的开发人员可能并不困难。例如，Tarr，[是 npm 上托管的 400 多个包](https://www.npmjs.com/~dominictarr)的作者，他可能不是唯一一个不再有时间或兴趣维护一些旧作品的开发人员。

过去也有过攻击者伪装成公司，花大价钱从原始开发者那里购买 WordPress 插件或 Google Chrome 扩展的案例。然后，他们将流氓代码添加到这些组件中，以便将广告注入网站或浏览会话。因此，付费访问是攻击者的另一种选择。

最终用户几乎没有办法检测到这种攻击，但是开发人员应该利用所有现有的技术让攻击者的日子更难过。例如，根据应用安全公司 Intrinsic 的托马斯·亨特二世的说法，Copay 开发者可能已经采取了阻止最终有效载荷的措施。

“利用 CSP(内容安全政策)可以阻止这次攻击，”他在关于这次事件的博客文章中说。这是用于指定网页可以与哪些 URL 通信的标准，并且是通过 web 服务器头指定的。Cordova[Copay 使用的框架]甚至有自己的机制来指定可以联系哪些第三方服务。但是，Copay 应用程序似乎禁用了这一功能。”

“随着时间的推移，这些供应链攻击只会越来越普遍，”亨特说。"有针对性的攻击，像这个软件包如何专门针对 Copay 应用程序，也将变得更加普遍."

专题图片:“[火柴火工厂](https://nos.twnsnd.co/post/180347753447/smoke-and-flames-match-factory-fire-1954)”(1954)，新老股。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>