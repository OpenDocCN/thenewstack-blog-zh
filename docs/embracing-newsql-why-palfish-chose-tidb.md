# 拥抱 NewSQL:为什么 PalFish 选择 TiDB

> 原文：<https://thenewstack.io/embracing-newsql-why-palfish-chose-tidb/>

[](https://apps.apple.com/us/app/palfish-teacher-english-tutor/id1020664979)

 [陈先林

陈先林是帕尔菲什技术中心的负责人，也是帕尔菲什技术中心从无到有的发起者和建设者。他是分布式系统架构方面的专家，在服务治理、稳定性构建和高并发架构方面有着丰富的经验。他对云原生分布式数据库有着极大的热情，提倡分布式数据库的简单优雅设计。](https://apps.apple.com/us/app/palfish-teacher-english-tutor/id1020664979) [](https://apps.apple.com/us/app/palfish-teacher-english-tutor/id1020664979)

PalFish 是一个快速发展的在线教育平台，专注于英语学习。它为英语作为第二语言的学生提供量身定制的英语口语体验。截至 2020 年，PalFish 拥有超过 3500 万用户，其中付费用户超过 100 万。

随着我们业务的快速增长，激增的数据带来了严峻的挑战。为了解决这些问题，我们迁移到开源、兼容 MySQL 的分布式 SQL 数据库，该数据库支持[混合事务/分析处理](https://en.wikipedia.org/wiki/Hybrid_transactional/analytical_processing) (HTAP)工作负载。事实证明，这是正确的举措。

在这篇文章中，我们将与你分享为什么我们选择 TiDB 而不是 MySQL。我们希望我们的经验可以帮助您找到最适合您的应用的数据库。

## 我们为什么选择 TiDB

[TiDB](https://docs.pingcap.com/tidb/stable/overview) 是一个开源的分布式 SQL 数据库。它与 MySQL 兼容，具有水平可伸缩性、强一致性和高可用性。

从我们以往的印象来看，分布式数据库擅长应对传统独立数据库无法处理的海量数据。但是保证分布式存储的一致性都很麻烦，更不用说 ACID 事务了。

所以，在我们最初的调查中，最让我们惊讶的是，作为一个分布式数据库，TiDB 支持 ACID 事务。它使用[Raft 一致性算法](https://en.wikipedia.org/wiki/Raft_(computer_science))来实现多个副本之间的数据一致性，[两阶段提交(2PC)协议](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)来确保事务的原子性，以及[乐观并发控制](https://en.wikipedia.org/wiki/Optimistic_concurrency_control)，结合 [MVCC](https://en.wikipedia.org/wiki/Multiversion_concurrency_control) ，来实现可重复读取的隔离级别。

正如我们提到的，TiDB 是一个开源项目。背后的主要维护者是 [PingCAP](https://pingcap.com/) 团队。在我们将 TiDB 投入全面生产之前，我们会见了 PingCAP 的工程师。在了解了 TiDB 在各个公司的广泛应用后，我们对 TiDB 的前景感到非常乐观。

## TiDB 与其他 NewSQL 数据库的比较

在选择 TiDB 之前，我们与其他主流的 NewSQL 数据库进行了对比。在本节中，我将使用其中的一个数据库 CockroachDB，并将其与 TiDB 进行比较。在我们对数据库的所有要求中，我们最看重两个:数据库是否能满足当前应用程序的需求，以及它是否能在未来继续创新。

对于我们当前的使用场景，TiDB 和[cocroach db](http://cockroachlabs.com)在特性、存储容量和读/写性能方面都满足我们的要求。

至于未来的发展，我们用两个标准来衡量数据库的潜力:开源社区和系统架构。

*   开源项目的长期发展与其在开源社区的影响力和受欢迎程度密切相关。项目越有影响力和受欢迎，它吸引的贡献者就越多，因此它未来的发展就越好。TiDB 和 cocroach db 都对他们的贡献者有吸引力，但在 GitHub 上，TiDB 比 cocroach db 有更多的手表、星星和叉子。另外，[TiKV](https://docs.pingcap.com/tidb/dev/tikv-overview)TiDB 的存储层是[云原生计算基金会](https://www.cncf.io/) (CNCF)的孵化项目。总的来说，我们认为 TiDB 比 CockroachDB 有更活跃的社区。
*   一个项目的系统架构对它的发展有长期的影响。有了先进的架构，数据库才能经受住时间的考验，并在未来走得更远。
*   受 Google Cloud Spanner 的启发，TiDB 将计算与存储分开。这种分离的架构允许计算层和存储层选择更适合的不同编程语言:Go 用于计算，Rust 用于存储。凭借这种架构，TiDB 实现了更好的性能以及计算和存储的独立迭代。这为未来与其他生态系统的整合提供了许多可能性。
*   CockroachDB 有一个去中心化的架构。在云原生时代，当节点数量和数据量增长到前所未有的程度时，弹性扩展成为必须，智能调度能力是决定数据库性能和稳定性的关键因素。然而，分散的体系结构使得调度变得困难，尤其是当调度器需要全局视图和多节点协调时。

基于这些考虑，我们在所有的 NewSQL 数据库中选择了 TiDB。

## MySQL 与 TiDB

有些人可能会问，如果我们如此想要 ACID 事务，为什么要大费周章地尝试一个不熟悉的数据库，而 MySQL，一个历史悠久的有事务保证的数据库，只需点击一下鼠标就可以实现？

这背后的动机很复杂。对于成熟的企业来说，选择数据库从来都不是一个简单的决定。这不仅仅是今天的技术，而是它的发展方向。这反映了您如何看待技术，以及您如何在这个快速变化的世界中定位您的公司。

### 对新技术的态度:NewSQL 是未来

当第一次谈到 MySQL 和 TiDB 的比较时，后者似乎不是一个强有力的竞争对手。MySQL 被证明是一个稳定的数据库。对于我们的所有需求，它都有可用的解决方案，如高可用性、可伸缩性，尽管它并不十分优雅。(你必须手动进行数据分片。)

然而，在 PalFish，真正的问题是独立的数据库无法处理海量的数据，在这方面，分布式数据库是更好的选择。有了 TiDB，这是一个水平可伸缩的数据库，分片就永远不用考虑了。它提供了一个解决方案，而不是妥协。事实上，TiDB 不如 MySQL 稳定和成熟，但我们相信，只要时间足够，它将胜过传统的关系数据库。

### 机器的成本还是人才的成本？

成本和效率也是我们决策的重要因素。乍一看，TiDB 所需的硬件资源令人望而生畏。但是我们知道机器只占总成本的一部分，而不是全部。

TiDB 比 MySQL 需要更多更好的机器，但也为开发人员和 DBA 节省了更多时间。还记得 Unix 哲学中的经济原则吗？“程序员时间贵；优先于机器时间保存它。”在 PalFish，我们总是希望机器和软件做得更多，而我们的员工做得更少。这正是 TiDB 所能提供的。

MySQL 确实提供了高可用性，但是我们的 DBA 和基础设施团队需要在实现上花费时间。MySQL 可以处理大表，但是数据分片必须由 DBA 和工程师来完成。这需要时间，我们可以更明智地投资的时间。对于 MySQL，人才的消耗也是成本:它不像 TiDB 需要的额外机器那样明显和有形。随着机器越来越便宜，人才越来越贵，我们必须意识到这种无形的支出。

### 后发优势

另一个激励因素是我们作为创业公司的角色。在成熟技术领域，我们几乎无法与科技巨头竞争。他们花了数年时间积累他们的优势，而我们只是从零开始建立我们的业务。通常，我们别无选择，只能成为旧技术的追随者；但是当新技术到来时，如果我们不抓住这个机会，我们会变成什么样呢？

作为后来者，我们必须把我们的弱点变成我们的优势。也就是说，当老牌公司还在沿着老路跋涉时，我们会预测趋势，选择面向未来的技术。这就是我们如何避免技术债务并超越老牌科技公司的方法，就像一辆快车在拐角处超过一辆较慢的车一样。

### 技术生态系统

选择一项技术，也是选择随之而来的生态系统。MySQL 有一个完善的生态系统，使我们能够事半功倍。由于 MySQL 兼容策略，作为 TiDB 用户，我们可以共享 MySQL 生态系统，以及享受 NewSQL 的好处。

综合考虑，帕尔菲什决定全力以赴投资 TiDB。

## 我们如何使用 TiDB

以下是我们在 TiDB 的现状:

*   我们有 10 个 TiDB 集群、110 多个实例和 6 个核心集群，每个集群每秒处理 10，000 多个事务(TPS)。
*   我们 99.9%的延迟仍然低至 16 毫秒。
*   响应时间和稳定性符合我们的期望。

回顾过去，我们可以充满信心地说，迁移到 TiDB 是一个正确的决定。我们在数据库技术方面已经超越了老牌公司，并享受到了 NewSQL 数据库的好处。自从迁移以来，R&D 和 DBA 团队的工作效率大大提高了。此外，TiDB 的[新版本](https://docs.pingcap.com/tidb/stable/release-notes)总能给我们留下深刻印象。

### 吸取的教训

虽然我们获得了 TiDB 的好处，但我们也必须承担未知的代价。在这里，我想给大家展示一下我们在调整期遇到的问题。

### 优化器索引选择

有几次优化器无法选择正确的索引，这导致了失败。

例如，在一个有 300，000 行数据和超过 10 个并发请求的表中，当我们添加一个新索引时，前面的查询选择了错误的索引。TiKV 实例的 CPU 飙升到满负荷，系统出现故障。

同样，在另一个有 14 亿行数据的大表中，某些查询条件不使用索引，而是执行全表扫描，这会影响应用程序。

PingCAP 工程师调查了这个问题，发现它是由优化器索引选择中的一个错误引起的。幸运的是，他们采取措施解决了这个问题。从 TiDB 1.x 到 3.x，优化器变得越来越高效。通过性能监控和慢速日志监控，我们的 DBA 团队现在可以快速发现问题。我们还在大表上强制索引，以避免潜在的风险。

### 大数据复制

为了进行数据分析，我们将来自许多上游 TiDB 集群的数据收集到一个 TiDB 集群中，用于大数据分析。但是数据复制速度慢，数据和数据编码不一致，导致复制失败。

随着我们对 TiDB 知识的加深，在 PingCAP 团队的支持下，我们更好地管理了 TiDB，并成功地解决了数据复制问题。

## 结论

TiDB 作为一个 NewSQL 数据库，兼容 MySQL 协议，支持横向可伸缩性、高可用性、ACID 事务和大量数据的实时分析。

在这个时代，当摩尔定律开始失效，高可用性和成本优化已经成为高层次的关注，分布式架构不可避免地获得牵引力。对于无状态服务，我们有流量路由策略和多副本部署(如微服务)；对于缓存，我们有像 Redis Cluster 和 Codis 这样的方案；有了 Kubernetes，操作系统也完成了自己的进化历程。

数据库呢？如果你问我，NewSQL 数据库肯定是下一件大事。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>