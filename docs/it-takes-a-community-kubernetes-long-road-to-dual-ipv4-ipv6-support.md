# Kubernetes 通往双 IPv4/IPv6 支持的漫长道路

> 原文：<https://thenewstack.io/it-takes-a-community-kubernetes-long-road-to-dual-ipv4-ipv6-support/>

Portworx 赞助了 New Stack 对 KubeCon+CloudNativeCon 北美 2019 的报道。

虽然你可能认为 Kubernetes 是计算的未来，但直到最近，它仍然停留在过去的一个方面，即它是建立在 IPv4 上的，IP v4 是广泛使用的，但很快就会成为互联网协议的遗留版本，互联网就是建立在 IP v4 上的。

互联网工程任务组长期以来一直敦促互联网服务提供商转向 IPv6，因为全球已经耗尽了 32 位 IPv4 地址的供应。凭借其 128 位地址空间，IPv6 将提供取之不尽的互联网地址。

“我们忽略了它，”谷歌首席软件工程师兼 Kubernetes 核心贡献者蒂姆·霍金在本周与微软 Azure 首席软件工程师兼核心贡献者 T4·哈立德(Kal)赫尼达克举行的 [KubeCon + CloudNativeCon 北美 2019](https://events19.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2019/schedule/) 会议的主题演讲中承认了 IPv6。Kubernetes 被牢牢锁定在 IPv4 上。

幸运的是，由于强大的志愿者团队，开源容器编排引擎现在已经为 IPv6 做好了准备:Kubernetes 的最新版本 1.16 将是第一个拥有双 IPv4/IPv6 堆栈的版本，这意味着它可以解释两种类型的互联网地址。据两人说，实现这一目标并不容易，但一个强大的志愿者社区——包括许多来自彼此直接竞争的公司的工程师——使这一目标得以实现。

Hockin 说,“Kubernetes 比任何一家向 Kubernetes 投入资源的公司都要大。”。"如果没有“竞合”，Kubernetes 就不会是今天的样子."

### 拉取请求长达 5000 行

Kubernetes 本质上是一种网络技术，所有与网络功能直接相关的代码都是为 IPv4 硬连线的。尽管如此，还是成立了一个工作组来搜索代码库并删除所有的 IPv4 元素，这是一个棘手的任务，但很快就成功完成了。

但这只是问题的一部分。人们很快发现 Kubernetes 真正需要的是双栈 IPv4/IPv6 支持——这意味着它的所有 API 都应该以 IPv4 或 IPv6 数据包的形式进行对话。将会有遗留应用或物联网设备仍然需要 IPv4。“我们做了一个糟糕的假设，我们总是需要单个 IP，”Henidak 说

这将是一个重大的修正。Kubernetes 是一种网络技术，它运行在 API 上。而且有许多涉及网络层的 API 需要修改:负载平衡器、节点、服务、端点。

“我们遇到了一个从未有过的问题:我们如何将一个单数字段转换为复数字段，并与所有客户保持兼容？”霍金说。“这可能会有点问题。”

一个团队在 2017 年 10 月开始研究 Kubernetes 的 bootstrap 工具，到 2018 年 6 月，他们有了一个 Kubernetes 增强提案(KEP)，其中详细列出了需要改变的一切，以及所有这些改变对用户的影响。

从这组用户需求中，工作被交给 Hockin 和 Henidak 来领导团队进行更新。他们将任务分为三个阶段:出口(因此从 Kubernetes 流出的流量可以是 IP/4 或 IP/6)，然后是入口(因此集群本身可以识别这两种协议)，最后是为所有支持工具提供双栈功能，如负载平衡器和引导工具。这项工作并不容易实现，Henidak，他们希望尽可能使最终用户不痛苦的更新。这些变化必须是向前和向后兼容的。

几个月来，各个团队一直在讨论创建一个适用于所有各方的模型的最佳方式，其中包括许多热烈的讨论。赫尼达克开始着手修复。由此产生的 pull-request 非常庞大:仅仅是 egress 阶段，就改变了两个核心 API——pod 和 node——超过 5500 行代码。端点、节点、路由和其他控制器也进行了修改。更糟糕的是，PR 是在接近 1.15 版本的代码冻结窗口时发送的。

“我们必须认真思考如何进行这些改变，并确保它们是正确的。如果可以避免，你不会真的想打破人们的群集。Hockin 说:“这是审查者用干草叉来处理的那种拉动式请求。

但是这里是社区站出来的地方。不只是少数志愿者站出来审查大规模的公关，而是 18 个人来帮忙。该评论被分成多个部分。“我们作为一个集体，作为一个社区，经历了审查、修复、修改的数据危机，”Henidak 说。最终，他们决定跳过下一个版本，而是瞄准 1.16，并包括入口。

所以现在支持入口和出口，但仍有工作要做。但是因为这次拉力赛，Henidak 和 Hockin 对 Kubernetes 的未来持积极态度。

“我们得到了一个非常强大的团体的支持，”赫尼达克说。

KubeCon+CloudNativeCon 是新堆栈的赞助商。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>