# 奥尔良计划。微软研究院的. NET 框架用于光环 4

> 原文：<https://thenewstack.io/project-orleans-the-net-framework-from-microsoft-research-used-in-halo-4/>

在本帖中，我们给出了由微软设计的旨在简化云服务构建的 Project Orleans 的基本概述。在下一篇文章中，我们将更详细地介绍 Orleans，以及它与市场上其他类似技术的比较。

2014 年底，微软宣布计划开源 Orleans 项目(T1)，这是一个由微软研究院(MSR)的极限计算小组构建的. NET 框架，旨在简化云服务的构建，可以扩展到数千台服务器和数百万用户，而无需成为分布式系统专家。

云的承诺是，您可以在需要时扩展(不需要时缩减)，获得弹性和性能，而不必担心陷入维护和管理的困境。但是，让您构建的服务而不仅仅是您运行的云平台获得这些好处，意味着将云的架构原则也构建到您的服务中，以便您可以跨数千台服务器实时处理每秒数十万个请求，并扩展到高需求、低延迟和高吞吐量。

奥尔良项目就是为了帮助解决这个问题而设计的。早在 2010 年作为一个研究项目首次公布，它已经被用于几个微软内部系统，包括[光晕 4](http://research.microsoft.com/apps/video/default.aspx?id=218161) 中的两个非常大的玩家服务:一个跟踪所有玩家和游戏会话，另一个处理关于玩家的详细统计数据以及他们在每一场光晕游戏中的所有行动，这些都显示在光晕航点界面中。

如果您尝试使用熟悉的 n 层开发模型实时构建这种系统——即使云允许您在需要时进行扩展——您很快就会遇到存储瓶颈。为了避免信息在前端和中间层存储之间来回传递，您添加了一个缓存，但这会导致更复杂的开发模型，因为您的缓存与您的主存储具有不同的语义，并且您必须处理将信息从具有并发性的存储移动到没有并发性的存储。

n 层模型也不能很好地处理常见的云场景。如果您想在社交网络上与某人聊天，与一组朋友进行在线比赛，或者处理来自多个设备的信息流，您需要高效地来回传递信息。即使是 map/reduce 这种非常适合脱机处理非常大的数据集的工具，在处理需要处理少量相关数据项的交互式请求时也不是很有效。

在较小的规模上处理这些问题更容易，但是如果你正在构建一个云服务，当它流行起来的时候，你希望它能够扩大规模，而不必改变架构。并发和分布式计算很难做好。可靠性、分布式资源管理、复杂的并发逻辑和扩展模式是几乎每个构建云服务的开发人员都需要处理的问题，Orleans 背后的想法是这些东西应该不难编写。

“Project Orleans 的目标，”MSR 极限计算小组的 Sergey Bykov 解释道，“是让构建云服务变得比以前更容易，让你编写相对简单的代码，但它可以扩展几个数量级。如果成功了，就不应该要求你扔掉自己写的代码。”

## 像农场一样扩展云，有谷物和筒仓

为了处理需要高吞吐量、低延迟和高效串扰的云工作负载，该团队从 20 世纪 70 年代的 actor 模型中获得了灵感，尽管你更可能知道它，因为 Erlang 在 20 世纪 90 年代使用过它。

您需要处理的每个对象都被视为一个参与者——一个有自己独立状态的代理。演员不共享任何内存，他们只交换消息，所以他们很容易分发。不管另一个参与者是在同一个服务器上还是在国家另一边的集群中，都没有关系，因为您有办法将内置的消息传递到系统中。这是比 COM、CORBA 和企业 Java Beans 中的分布式对象更高层次的抽象。与一些云应用开发系统(比如谷歌应用引擎)不同，Orleans 是异步和单线程的。

这使得写作变得容易多了。开发人员不必处理并发性、锁、竞争条件或分布式编程的常见问题——只需参与者，奥尔良称之为颗粒。谷物是。NET 对象，它们存在于称为筒仓的运行时执行容器中——每个节点上都有一个筒仓。Orleans 框架将在需要时自动创建更多的筒仓，在不需要时清理它们，并重启任何失败的筒仓。它还处理创建颗粒，如果一个节点失败，在另一个筒仓中重新创建它们，并在不需要它们时再次清理它们。消息传递是通过。NET 接口，Orleans 使用 C#中的 async/await 模式来实现异步。

## 奥尔良的转折是通过虚拟化演员来提高高层抽象的效率

对于颗粒，您既有定义它们的对象类，也有完成工作的颗粒实例，但也有内存中角色的物理激活。一个没有被使用的颗粒仍然存在，你仍然可以对它进行编程——但是在你调用它之前，这个颗粒是虚拟的。当您需要它时，Orleans 运行时会创建一个内存副本来处理您的请求；如果它闲置了一段时间，它会进行垃圾收集。

如果你需要它回来，框架可以重新激活颗粒，因为逻辑实体总是在那里。在一个集群中的许多不同机器上，相同的颗粒可能在内存中被激活和停用多次。当你需要它的时候它就在那里，当你不需要它的时候它不会占用内存，状态由框架处理，你不需要记住创建或删除任何东西。如果一个粒子是无状态的，运行时可以创建它的多个激活来提高性能。

奥尔良使用人们熟悉的设计模式，像调度员一样，在一次呼叫中发送一批信息，并将它们分配给正确的谷物；为客户端提供单个发布端点来传递来自多个源的事件的中心；监视颗粒并在它改变状态时得到通知的观察者；分层化简以有效地聚集存储在许多不同粒度中的值；计时器意味着颗粒之间的相互作用不必依赖于外部系统输入的节奏。

许多故障都是自动处理的，因为运行时会根据需要重新启动筒仓和颗粒。

奥尔良是构建许多典型云服务的理想之地。MSR 建立的概念验证(POC)系统之一是 Twitter 风格的社交网络(称为 Chirper ),另一个是线性代数库，用于执行 PageRank 和机器学习聚类、特征提取和分区等算法中使用的向量矩阵乘法。

它特别适合处理大型图——比如社交网络图，即使它分布在许多机器上，您也需要高效地查询。但它也有利于处理社交图表，以及近实时分析，从物联网传感器传输数据，作为移动后端和位于更传统的存储系统前面的智能分布式缓存。

有很多其他工具可以用来构建这种类型的系统，但是很少有工具可以让您在高水平上工作，而不必实现自己的扩展和并发逻辑，并且仍然可以获得非常高的性能，这就是为什么 Orleans 受到了很多关注。

## 自信和社区的开源

Orleans 是一个很好的例子，说明了微软是如何战略性地使用开放源码来改进关键技术，并给开发者信心在此基础上进行开发的。这不是一个附带项目或任何种类的废弃软件；Orleans 是一个强大的系统，正在积极开发中，并被用于微软内部的主要项目。

以新的微软“每天万亿次事件”内存流分析引擎为例，用于处理大数据。Trill 是一个. NET 库，用于 Bing 上的分析，目前正在加速 Bing 广告，并支持 Azure Stream Analytics 中的查询处理。MSR 副总裁 Jeannette Wing 称其为 MSR 的成功故事之一，并在一系列微软服务中使用。例如，为了扩大规模，Trill 被托管在 Project Orleans 内部，以处理针对实时流数据的大量独立的长期查询并生成警报。

关于 Trill 的细节并不多，它仍然是一个研究项目，除非你在微软工作，否则你无法得到它。然而，在微软 2014 年 Build conference 的本次会议上，你可以看到在 Orleans 内部托管的 [Trill，Azure 团队的 Paolo Salvatori 使用它们来构建一个实时分析服务，以使用 Azure 服务总线处理来自物联网传感器的事件。](http://channel9.msdn.com/Events/Build/2014/3-635)

Trill 的每个实例都在一个奥尔良颗粒中，因此系统可以放大和缩小以处理来自许多设备的输入。(颗粒这个词可能会让你想到小物体，但是颗粒的大小没有任何限制，所以它们可以保存很多状态。)

2014 年，在 Build conference 上发布了 Project Orleans 的首个公开预览版，反响热烈。挖掘这种热情是该团队决定将其开源的原因。与 Orleans 一起工作的开发人员喜欢他们的许多 bug 和建议进入 9 月更新的事实，但他们不喜欢等待几个月的修复。1 月下旬，在麻省理工学院的许可下，Orleans 源代码在 [GitHub](https://github.com/dotnet/orleans) 上发布，并在同一天收到了拉取请求。

开源奥尔良是我们从微软看到的构建服务开发框架模式的一部分。正如我们从。NET 团队来说，开源是开发人员所期望的——甚至来自微软。Sergey Bykov 指出:“服务与盒装软件非常不同。

> 开源是服务栈的标准。每个人都需要保证他们可以在必要时快速修复问题，而不必等待官方补丁。大多数人永远不会修复堆栈，但他们仍然需要保证在必要时可以修复。开源是保证。

此外，Bykov 对让社区帮助改善奥尔良感到兴奋。“横向扩展开发也是(开源)的一个同样重要的原因。有才华有经验的人比你能雇佣的要多得多。如果你设法让他们成为‘大家庭’团队的一员，你可以做得更多、更快。”

像往常一样，社区的贡献范围从简单的代码清理到跟踪代码中的一些复杂的 bug。这正是 Bykov 所希望的，这也是为什么你可以在 GitHub 上看到 Orleans 团队，提出 API 更改，讨论项目目标，并非常清楚他们仍然需要做的工作。例如，允许开发人员编写 Orleans 的运行时扩展，并使用它来开发自己的应用程序。

“你必须真正把这些人当作你的同龄人来对待。你必须倾听他们，讨论问题和权衡，不同意他们的观点。你不能凌驾于他们之上，对他们发号施令。他们就像你一样，但总体上比你更聪明、更有经验。”

通过 Flickr 知识共享的特色图片[。](https://www.flickr.com/photos/corrinneyu/7163490123/in/photolist-8nR9dj-ci5rsJ-bV1L3p-du4TcU-dtYiD6-bD7yp9-8oqw6v-8oqwez-4KFujv-4BpYtD-rhWK7y-ri6EPJ-Q6NT-ci5pKh-ci5qmu-ci5pRu-3cGHj3-dr39Zt-JdnKk-dwXSu5-dwSns8-dwSnE8-dwSnoD-dwXSoh-dwSnrD-dwXSq9-dwSnp4-dwXSqL-dwXSm3-dwXSAm-dwSnzM-dwXSrJ-dwXShW-dwXSyq-dwSnxt-dwXSwf-dwXSxj-dwSnzg-dwXSkw-dwSnBc-dwSnEx-dwSnpF-dwSny8-dwSnCK-dwXSoS-dwSnun-dwXSAL-9q62wU-5gsbDf-4zj4dh)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>