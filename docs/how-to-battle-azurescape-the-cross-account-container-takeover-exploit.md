# 如何对抗 Azurescape，跨账户容器接管漏洞

> 原文：<https://thenewstack.io/how-to-battle-azurescape-the-cross-account-container-takeover-exploit/>

云计算的一个噩梦场景一直是攻击者能够突破他们的容器进入其他用户的容器。好吧，幸运的我们，它终于发生了。

[帕洛阿尔托网络](https://www.paloaltonetworks.com/cloud-security?utm_content=inline-mention) ' [Unit 42](https://unit42.paloaltonetworks.com/emerging-ransomware-groups/) 研究人员发现了一个连锁的利用链，该链允许恶意的 Azure 用户入侵其他用户在微软的容器即服务(CaaS)产品中的云实例， [Azure 容器实例](https://azure.microsoft.com/en-us/services/container-instances/) (ACI)。Unit 42 给这个漏洞贴上标签 [Azurescape](https://unit42.paloaltonetworks.com/azure-container-instances/) 。首席 Unit 42 安全研究员 Yuval Avrahami 也称之为“公共云中的第一次跨帐户容器接管”我称之为灾难。

## 修复工作开始了

在你对 Azurescape 过于紧张之前，修复已经开始了。[微软在 Unit 42 发布消息后不久就修补了 ACI](https://msrc-blog.microsoft.com/2021/09/08/coordinated-disclosure-of-vulnerability-in-azure-container-instances-service/) 。也没有 Azurescape 在野外被开发的报道。还没有。

微软表示，“出于谨慎，我们通过 Azure 门户中的服务健康通知，通知了与研究人员在同一集群上运行容器的客户。如果您没有收到通知，则无需对此漏洞采取任何措施。

啊…这还不够好。问题仍然是:“如果除了 42 号机组以外的人发现了这些洞怎么办？”这对于大写的 b 来说是个坏消息。

## Microsoft 安全建议

所以，即使微软没有警告你，我也会使用他们的安全建议。这些是:

*   撤销 2021 年 8 月 31 日之前部署到平台的任何特权凭证。为容器组指定配置和机密的常见位置包括:
    *   环境变量
    *   秘密卷
    *   Azure 文件共享
*   请参考这些安全最佳实践资源
*   作为标准安全实践的一部分，您应该经常撤销特权凭据。
*   通过配置 [Azure 服务健康警报](https://azure.microsoft.com/updates/azure-service-health-security-advisories-are-now-available/)，及时了解与安全相关的重要通知。

Unit 42 补充道，你应该检查你的访问日志是否有任何异常。我很赞同。如果你发现了什么，不管事件发生的日期，我都会重置特权凭证。

具体来说，这个问题只影响基于 Kubernetes 集群的 ACI。2021 年，微软也开始在[服务架构集群](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-anywhere)上托管 ACI。今天，Unit 42 估计 Azure 使用 Kubernetes 托管大约 37%的新创建的 ACI 容器。

## 42 号机组如何工作

现在，你可能想知道，既然 CaaS 安全就是要阻止这种事情发生，那么第一个案例中怎么会发生这种事情。单元 42 通过创建 [WhoC](https://github.com/twistlock/whoc) ，一个读取执行它的容器运行时的容器映像来做到这一点。这依赖于 Linux 容器中的一个设计缺陷，该缺陷使它们能够读取底层主机的容器运行时。听起来熟悉吗？应该的。在 [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736) 中，类似的技术被用于通过 runC 突破 Docker。

关键的安全漏洞是 ACI 使用了过时版本的行业标准容器运行时 [runC](https://github.com/opencontainers/runc) 。天啊。使用过时的软件作为基础层，我们以前在哪里没有听说过这种错误？

在这种情况下，微软仍然在使用 runC v1.0.0-rc2。众所周知，这个近五年前的版本容易受到至少两次容器泄漏事件的攻击。从那以后已经发布了超过 15 个 runC 版本。最后，runC 终于在 2021 年 6 月发布了稳定的 1.0 版本。从那以后，又有了另外两个版本。简而言之，微软几年前就应该更换这个危险过时的版本了。

有了这个，Unit 42 就能够轻松地脱离容器到达底层主机，一个 Kubernetes 节点。这虽然危险，但也没那么糟糕。攻击者仍然在节点虚拟机(VM)中。

进一步检查环境发现，CVE 正在运行各种 Kubernetes 版本:Kubernetes v1.8.4、v1.9.10 和 v1.10.9。这敲响了警钟吗？应该的。这些都是老版本，发布时间在 2017 年 11 月到 2018 年 10 月之间。你猜怎么着？它们都容易受到多个已知漏洞的攻击。

其中之一， [CVE-2018-1002102](https://github.com/kubernetes/kubernetes/issues/85867) ，使攻击者能够玩 API-server 如何与 [Kubelets](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) 通信的游戏。这反过来使得恶意的 Kubelet 能够在集群中传播。这本身并没有变成真正的安全漏洞。但是，在利用它时，研究人员发现了一个携带 Kubernetes 服务帐户令牌的授权头。这些是未加密的 [JSON Web 令牌(jwt)](https://jwt.io/)，所以它们很容易受到攻击。

有了其他用户的 jwt，攻击者就可以伪装成其他帐户的所有者。雪上加霜的是，如果利用得当，您可以使用这些令牌在集群中的任何 pod 上执行命令——包括 API-server pod！

我的朋友们。现在，您可以作为集群管理员，完全控制集群及其所有客户容器。

但是等等！还有呢！工作人员还发现，你可以通过使用桥接 pod 中的[服务器端请求伪造(SSRF)](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery) 漏洞来达到相同的结果。这里的技巧是，API-server 实际上并不验证 status.hostIP 值是否有效。那很糟糕。更糟糕的是，API 服务器还接受任何字符串——包括 URL 组件。经过一番折腾后，团队想出了一个 hostIP 值，这个值可以欺骗桥在 API-server 容器上执行命令，而不是在我们的容器上。同样，从那里开始，成为事实上的集群管理员是一个简单的步骤。

## 那么，你能做什么？

首先，虽然看起来这些漏洞并没有造成真正的伤害，但是您必须确保您的集群基础设施安装了最新的安全补丁。

这是安全 101，但通常情况下，人们不会这样做。你也永远不能假设 Azure、亚马逊网络服务(AWS)、谷歌计算，不管是谁在为你运行云，都是在工作。他们不是。是的，我知道你为服务付费，所以你不必担心这些细节。艰难。不管你喜不喜欢，这仍然是你的工作。

此外，Unit 42 还建议您:

*   不要向除 API 服务器之外的任何人发送特权服务帐户令牌。如果接收者受到威胁，攻击者可以伪装成令牌所有者。
*   启用[boundserviceaccountokenvolume](https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#bound-service-account-token-volume)。这个最近升级的功能门确保令牌过期与其 pod 绑定。当一个 pod 终止时，其令牌不再有效，从而最大限度地减少了令牌失窃的影响。
*   部署策略实施器来监控和防止集群中的可疑活动。将它们配置为提醒服务帐户或节点，这些帐户或节点查询 SelfSubjectAccessReview 或 SelfSubjectRulesReview APIs 以获取它们的权限。 [Prisma Cloud](https://www.paloaltonetworks.com/prisma/cloud) 客户可以下载一个[相关的规则模板](https://github.com/twistlock/sample-code/blob/master/opa-rego-policies/suspicious-selfsubjectreview.rego)，通过 Kubernetes 内置的[准入控制强制执行。我们建议将规则设置为警报。其他人可以依赖开源工具，如](https://docs.paloaltonetworks.com/prisma/prisma-cloud/21-04/prisma-cloud-compute-edition-admin/access_control/open_policy_agent.html) [OPA Gatekeeper](https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/) 。

是的，工作量很大。但是你愿意现在就做吗？或者向您的客户或首席执行官解释为什么他们的宝贵数据被清空了，或者他们的计算时间花在了比特币挖掘上，而不是工作上？我知道我更喜欢哪个。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>