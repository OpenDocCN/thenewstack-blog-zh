# 多租户系统中的授权挑战

> 原文：<https://thenewstack.io/authorization-challenges-in-a-multitenant-system/>

多租户应用程序允许几个不同的用户组访问一个系统。大多数 [SaaS 解决方案](https://www.oracle.com/uk/applications/what-is-saas)使用多租户，以便多个组织可以注册。每个客户都成为系统中的“租户”，拥有自己的一组用户帐户。

 [詹姆斯·沃克

詹姆斯是总部位于英国的软件开发机构 Heron Web 的创始人。他拥有使用 DevOps、CI/CD、Docker 和 Kubernetes 管理完整的端到端 web 开发工作流的经验。James 还撰写关于编程和软件开发生命周期的技术文章。](https://www.linkedin.com/in/jh-walker/) 

虽然多租户通常是构建新软件的最有效方式，但它带来了授权和隐私方面的挑战。您需要在租户之间保持严格的界限，这样客户就不能访问彼此的数据。在许多情况下，支持团队最好能够忽略这些防护栏，这样他们就可以诊断各个租户遇到的问题。

在本文中，您将了解多承租带来的授权问题。在开始构建您的系统之前，了解这些是很重要的，这样您就可以预测潜在的弱点并构建足够的保护来解决它们。

## 什么是多租户系统？

[多租户](https://www.cloudflare.com/en-gb/learning/cloud/what-is-multitenancy)是一种计算模式，允许许多独立的客户使用一个服务实例。客户一可能有用户 A、B 和 C，而客户二有用户 X、Y 和 z。所有六个用户共享相同的软件部署，但是与客户一相关联的用户不应该能够访问由与客户二相关联的用户创建的数据，反之亦然。

服务运营商使用多租户是因为它比单租户方案更具可扩展性、可维护性和成本效益。单租户让您为每个客户提供一个专用的服务实例，这需要管理更多的计算资源，当租户不活动时，其中一些资源可能会闲置。这还意味着更新和回滚需要应用于所有实例，这增加了运营团队的负担。

多租户也可以对安全性产生积极影响。它为您提供了一个更容易监控和控制的单一攻击面。如果实施正确，多租户系统可以在客户之间提供强大的逻辑隔离，保护隐私和数据完整性。

## 多租户授权挑战

多租户的许多风险源于应用程序中不适当的访问控制。安全的多租户依赖于将用户与其数据可靠地联系起来的授权模型。如果您的系统设计没有预料到问题可能会出现在哪里，那么正确地做到这一点可能会很有挑战性。

### 将用户与其租户隔离开来

限制用户使用属于其租户的数据是多租户授权的最基本要求。需要租户隔离屏障来防止用户访问另一个帐户拥有的敏感信息。这种违规行为会削弱对您服务的信任，并且根据发生的暴露类型，可能会使您受到监管处罚。

租户识别通常发生在请求生命周期的早期。您的服务应该对用户进行身份验证，确定他们所属的租户，然后限制与该租户相关的数据的后续交互。您的应用程序执行的数据获取需要受到一致的约束，以避免无意中泄露另一个租户的信息。

当您实现获取用户特别请求的项目的端点时，问题经常悄悄出现。您可以使用像`/api/users/:userId`这样的 API 来提供与用户帐户相关的信息。所请求的用户 ID，比如`/api/users/100`，可能与进行交互的用户不属于同一个租户。您需要一种方便的机制来约束数据库获取活动租户的数据，或者检查经过身份验证的个人是否可以访问检索到的用户记录。

### 区分基于角色的授权和基于资源的授权

软件系统包含两种不同形式的授权:

*   **基于角色的授权**允许用户在被授予特定角色时执行某个操作。例如，如果一个用户是管理员，他们可能被允许创建其他用户。
*   **基于资源的授权**根据目标资源的特征控制对动作的访问。删除用户帐户可能有不同的授权要求，具体取决于该帐户是管理员还是普通用户。

在多租户环境中，这两种授权形式往往会重叠。基于角色的授权通常隐含地依赖于基于资源的授权。拥有角色(基于角色的授权)的用户可以执行它提供的操作，但只能针对其租户拥有的资源(基于资源的授权)。继续上面的示例，管理员可以删除用户，前提是目标用户是其组织的一部分。身份验证例程首先检查管理员是否具有“删除用户”角色，然后确保目标用户是同一个租户的一部分。

> 最有效的多租户授权系统将在每个租户的基础上灵活地适应定制。

这种区别会在您的授权逻辑中产生微妙之处，这在传统的单租户应用程序中是看不到的。安全策略总是需要意识到当前选择的租户，即使他们正在执行基于角色的授权检查。

当租户需要角色和操作的独特组合来反映其组织的结构时，会出现另一个复杂情况。一个组织可能满足于管理和只读角色；另一个可能需要将管理员角色分成五个不同的任务。最有效的多租户授权系统将在每个租户的基础上灵活地适应定制。在应用程序级别，粒度权限检查将保持不变；然而，该系统需要可配置，以便租户可以通过组合不同的权限来创建自己的角色。

### 满足交叉需求

即使您正在构建自己的授权系统，实现基本的租户隔离通常也相当简单。一旦开发了租户间横切的业务需求，事情就会变得更加复杂。SaaS 组织中的支持人员可能存在于内部租户中，但需要访问属于服务客户的相邻租户。能够从用户的角度查看数据通常是有效调查和诊断问题的最佳方式。

必须小心管理交叉问题。这会使授权变得更加困难，因为它引入了新的操作场景和潜在的边缘情况问题。您需要确保只有经过批准的用户才能进入其他租户的空间，并且他们在该空间中的行动和活动受到限制。例如，即使在支持请求的情况下，将用户的支付细节暴露给管理员通常也是不合适的。

授权并不是故事的结尾。跨租户的用户执行的操作需要被记录和监控，以便将来可以审计。这是至关重要的，这样，如果用户报告其帐户上有未识别的活动，您就可以确定是谁进行了更改。对于需要遵守特定监管框架的服务，甚至可以强制进行审计。可以将日志记录合并到您的授权层中，以便在进行横切权限检查时进行记录。

允许交叉的账户应被视为高风险资产，并接受严格的安全机制，如强制性的[双因素认证](https://www.csoonline.com/article/3239144/2fa-explained-how-to-enable-it-and-how-it-works.html)。横切所提供的特权也必须保持在满足每个用户工作职责所需的最低限度。一线员工的权限应该比高级支持人员少，如果第一层不能解决问题，请求提升会更安全。

### 限制特定租户对功能的访问

SaaS 解决方案通常附带多个订阅计划，允许客户根据自己的需求选择合适的功能集。这一需求需要在您的授权策略中得到认可。授权层应该知道当前租户可以使用的功能，这样它就可以拒绝与限制组件相关联的角色。

当客户在计划之间移动时，手动分配和撤销角色是解决这个问题的一种方法，但这是一种繁琐且容易出错的方法。将角色直接绑定到它们所支持的订阅功能要可靠得多。它还允许在客户降级后立即恢复之前分配的用户功能，然后再回到更高的级别。

您的应用程序进行的权限检查应该首先确定租户是否具有必需的特性，查看经过身份验证的用户是否具有所请求的角色，最后确认目标资源是否为租户所有，并通过任何特定于资源的授权策略。使用策略驱动的授权平台集中这个逻辑是避免错误的最佳方式，因为引入了更多影响授权结果的变量。

### 产品和工程团队的管理员访问权限

管理员、操作员和工程团队有时需要提升访问权限，以允许与任何租户的数据进行交互。这带来了进一步的风险和挑战，需要在实施之前加以考虑。

> 随着组织的发展，很容易失去对帐户的跟踪，从而导致大量特权帐户。

允许以 root 用户身份访问您的服务可以简化开发任务，从而可以更快地诊断问题。一个能够登录、伪装成报告错误的用户并遵循一组重现步骤的开发人员更有可能有效地识别出仅在特定环境下出现的问题。

当您扩展时，必须小心管理这种级别的权限。在某些系统中，特定用户帐户通过硬编码属性(如电子邮件地址、域名或特殊的“管理员”标志)获得权限。随着组织的发展，很容易失去对这些帐户的跟踪，从而导致大量特权帐户。

像对待任何其他角色一样对待管理员访问是一种更安全的前景。使用您的授权提供者向管理员授予一个角色，该角色包括您的应用程序对每个租户的所有操作。这使您可以使用现有的授权机制来管理管理员。您将能够方便地列出您的所有根级帐户，并在需要时撤销它们的权限，从而有助于合规和监控。

## 结论

多租户是一种可扩展且经济高效的软件交付模式，在这种模式下，多个客户共享一个服务实例。它依赖于您的应用程序实现适当的授权控制来隔离租户并防止用户在租户之间横向移动。大多数系统还需要一种机制，允许这些安全措施的受控覆盖，以便支持团队和开发人员可以有效地管理租用的帐户。

从头开始开发这些授权系统是一项艰巨的任务，可能会出现错误。幸运的是，您可以使用外部提供商在您的应用程序中实现多租户，而不必重新发明所有的保护措施。

Cerbos 是一种开源的访问控制技术，您可以将它与系统的其他组件一起作为自己的主机。Cerbos 允许您将您的[多租户授权规则](https://cerbos.dev/use-cases/multitenant-saas)构建为与您的应用程序代码分离的清晰策略。您可以使用 [API 调用](https://docs.cerbos.dev/cerbos/latest/api/index.html)或 [Cerbos 的特定语言 SDK](https://docs.cerbos.dev/cerbos/latest/api/index.html#_client_sdks)来检查用户是否被允许采取特定的动作。与 Cerbos 集成可加速开发并降低安全漏洞的风险，让您专注于系统的独特功能。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>