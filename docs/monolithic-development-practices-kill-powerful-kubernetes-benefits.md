# 单一的开发实践扼杀了强大的 Kubernetes 优势

> 原文：<https://thenewstack.io/monolithic-development-practices-kill-powerful-kubernetes-benefits/>

休·麦基

休是 Lightbend 的一名开发者。他在构建应用程序方面有很长的职业生涯，这些应用程序发展缓慢，没有有效地利用它们的基础设施，而且很脆弱，容易失败。他现在的重点是帮助其他开发人员和架构师构建弹性和可伸缩的分布式系统。Hugh 经常在会议上发言，并且是《设计反应式系统:分布式架构中参与者的角色》(O'Reilly)一书的作者。

说 Kubernetes 对开发实践产生了巨大的影响可能是对 21 世纪的轻描淡写，因为它的使用继续以极快的速度扩展。事实上，最近由 Portworx 进行的一项 Kubernetes 采用调查发现，由于疫情，68%的 IT 专业人员增加了他们对 Kubernetes 的使用。这种增长并不令人惊讶，因为 Kubernetes 允许快速构建和部署新的应用程序组件，从而大大加快了上市时间，尤其是对于更复杂的应用程序。

Kubernetes 提供的粒度(更集中的微服务相对于更大的单片应用)允许更快的系统发展。换句话说，可以更快地引入新服务和更改现有服务，因为引入或更改服务的范围和影响具有更小的“爆炸区域”，这意味着更改如何影响整个应用程序。当从非 Kubernetes 环境迁移到 Kubernetes 环境时，正是这种松散耦合提供了如此大的优势。然而，单一应用程序世界的旧习惯很难改变，可能会扼杀 Kubernetes 提供的许多强大优势。

## 摒弃一成不变的习惯

例如，在整体思维中，模块 A 调用 B，模块 B 调用 c。一切都正常，因为它们都运行在一个单一的顺序进程中。但是，您也在网络上运行这些流程，这意味着延迟，意味着对应用程序的性能影响，这是任何人都不希望看到的。有了 Kubernetes，微服务就不应该通过远程同步请求程序相互对话，而是应该异步地相互对话。

例如，当微服务 A 收到某种请求时，它正在捕捉信息，并可能广播它正在做的事情。它不关心广播的接收端是谁。接收者以异步方式获取信息并进行处理。构建松耦合的微服务意味着从头开始设计它们，使它们尽可能自主地工作，A 和其他所有东西之间的所有通信都是异步的。

> 有了面向事件的系统，客户就成了发布者。每当客户数据发生变化时，客户服务部门都会发布这些数据。

不幸的是，许多使用 Kubernetes 的开发人员的工作正好相反。一个很好的例子是紧密耦合的应用程序的微服务有多紧密。开发人员在服务之间进行 restful、JSON 远程过程调用，并希望具有可追溯性。需要可跟踪性，因为它们的服务是紧密耦合的。然而，当服务松散耦合时，所有消息都将被交付，只是时间问题。这消除了紧密耦合的需要。

先说尺度。当然，服务之间紧密耦合的依赖关系都可以扩展，但是通常情况下，服务之外的东西会成为瓶颈。最常见的是数据库。虽然数据库在扩展方面越来越好，但这是一种完全不同的动态。也许您可以在计算级别进行扩展，但是在持久性级别，您可能会遇到一个硬天花板。数据库只能被推到某个性能阈值。无论你在 Kubernetes 方面的规模有多大，你都不会走得更快。因此，虽然微服务可以在 Kubernetes 中在代码级别完美地扩展，但您还需要能够控制数据等外部因素。要点是不仅微服务应该是松散耦合的，数据本身也应该是自治的。

## 每个服务都应该拥有自己的模式

当讨论为什么数据应该是自治的时，让我们考虑一个购物车应用程序。在许多情况下，更有趣的是看到为什么事情没有发生，而不是发生了什么。为什么人们会把某些东西放进购物车，然后又把它们拿走？当您捕获每一个事件时，比如从购物车中添加或删除一个项目，您就获得了一组更丰富的数据来进行分析。这就是为什么对于开发人员来说，从 CRUD(创建读取更新删除)转移到 CQRS(命令查询责任分离)方法是很重要的。CQRS 将数据的写入和读取分开，这就是分离的部分。结果是面向事件类型的微服务。当您开始在事件中捕获数据时，您就停止了更新和删除操作，而这是 CRUD 中的基本操作。你不再丢弃数据，这可能是一件好事。

有了面向事件的系统，客户就成了发布者。每当客户数据发生变化时，客户服务部门都会发布这些数据。这些信息被发布出来，其他服务可以异步地获取这些信息，并保留自己的客户视图。它在复制数据，但是数据很便宜。事实上，在过去的 10 年里，数据的成本已经下降了至少 1/10。服务可以只为自己的存储获取数据。现在，两者之间不再有同步数据连接，而是异步的。这也是通过面向事件的方法实现的。当一个服务关闭时，所有其他服务都会继续运行，因为它们有自己的客户数据视图。每个服务都是完全独立的，有自己的数据。它运行得更快，你可以更快地改变它，你可以更快地修复它。

除了客户数据，还有各种参考数据，这就是为什么每个服务都有自己的模式。再次考虑购物车的例子。在购物车服务中，除了客户在购物车中添加和删除的内容，还有目录、定价、库存、运输和客户信息。每个服务的所有信息都在那里，不依赖于其他服务。这是很多开发人员犯错误的地方。当他们迁移到云和 Kubernetes 时，他们很乐意构建微服务。他们开始将他们的单片代码分解成不同的微服务，但他们也继续使用他们已经使用了几十年的单片数据库(他们不分解数据)。构建这些微服务的更好方法是获取数据模型的切片，以便每个微服务都有自己的数据视图，并且完全是私有的。

为什么？对于一个单一的数据模型，你必须考虑到所有可能受到影响的人，你甚至不能确定他们是谁。这需要与其他团队协商。这会降低您发展微服务的灵活性。更有问题的是，你要求他们因为这些数据模型的改变而改变他们的代码，而他们没有这样做的动机。不会增强他们的微服务，只会增强你的。反过来，用你的微服务拥有方案，你就可以为所欲为了。

当你迁移到云，Kubernetes 和微服务，挑战你迄今为止所知道的一切。事实上，今天的最佳实践与遗留的整体应用程序的构建方式完全相反。不要用单片数据，用私有数据做微服务。不要依赖其他微服务的数据。当这些变化发生时，使用事件从其他微服务获取数据，并为您自己的消费和使用保留该数据的私有副本。这不是关于数据的经济性，而是关于数据的速度和灵活性。使用 Kubernetes 和微服务的好处是不可思议的——只要确保你知道如何充分利用它的力量！

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>