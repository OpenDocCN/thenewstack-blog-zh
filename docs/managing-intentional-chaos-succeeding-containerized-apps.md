# 让您的容器化应用为生产做好准备

> 原文：<https://thenewstack.io/managing-intentional-chaos-succeeding-containerized-apps/>

[](http://www.vivekjuneja.in)

[Vivek June ja](http://www.vivekjuneja.in)

[Vivek June ja，首尔的工程师，专注于云服务和微服务。他于 2008 年开始从事云平台工作，是 AWS 和 Eucalyptus 的早期采用者。他还是一名技术布道者，在印度的各种技术会议上发表演讲。他在 www.cloudgeek.in 和 www.vivekjuneja.in 上写作，热爱梳理技术社区。](http://www.vivekjuneja.in)

[](http://www.vivekjuneja.in)[](http://www.vivekjuneja.in)

虽然构建容器化的应用程序已经成为一种惯例，但是一些组织在管理容器本身时面临着挑战。在生产环境中管理容器需要对技术有深刻的理解，同时要摒弃那些不再有效的习惯和实践。这些实践跨越容器管理的不同生命周期方面:日志记录、监控、通知、补救和度量。

容器化应用程序的设计必须考虑到随着时间的推移出现的各种非功能性和容器原生模式。比如[十二因素应用风格](https://thenewstack.io/12-factor-app-streamlines-application-development/)已经被微服务爱好者和开发者广泛提倡和采用。十二要素原则要求应用程序准备就绪，包括快速启动和正常关闭的设计，但它错过了处理这种基于容器的系统随着时间的推移而获得的软件熵。

## 容器增加了整个系统的复杂性

采用容器，尤其是在基于微服务的架构中，会增加系统的熵。当我们说熵时，我们的意思是系统变得非常复杂，这种复杂性需要管理。这种复杂性是由于基于容器的环境中活动部件的增加。此外，容器的一次性和不可改变的性质可以鼓励一些团队创建更快速的交付管道。这种变化的倾向进一步加剧了整个系统的复杂性。如果不加以管理，它可能会导致精力耗尽、停机和对所采用技术的失望。

另一个重要的教训是，应用程序应该能够处理来自容器的复杂性，这个教训可能会让许多人想起反脆弱运动。

## 理解新的设计目标

为了应对这些挑战，有一些方法可以创建容器化的应用程序，使它们可以随时运行。对开发过程进行更改将能够更好地监控和管理生产环境中的容器。这些经验转化为容器化应用程序开发的一些高级设计目标。

1.  **作为容器运行的应用程序应该承认服务可能在任何时候被中断。**
    中断可能由多种情况引发。在 Docker 的情况下，stop 命令向应用程序发送 SIGTERM 信号，指示关闭的请求。这可能需要应用程序在容器报废之前执行清理活动。从十二因素原则中得到启示，应用程序必须优雅地关闭。例如，如果有一个状态正在被容器操作，那就需要被检查点。[检查点](http://criu.org/Main_Page)将被保存到外部存储器上，其他容器工人可以访问它。
2.  **应用程序应该公开一个接口，以允许容器平台可以使用的健康检查。**
    运行状况检查实施的准确性对于该设置的运行至关重要。通常，应用程序会发出健康检查信息，表明它可以正确连接到第三方或外部接口。健康检查失败是平台从配置中删除实例的一个很好的指示。平台还利用这一点来决定由于容器中的错误而需要执行的补救活动。这种补救可能涉及在不同的主机上启动相同的容器映像。
3.  **应该有一种可靠地识别错误实例及其根本原因的机制。**
    在容器化的环境中诊断应用程序问题是对混乱的公开邀请。当需要确定导致问题的确切容器实例时，就会出现问题。使用跨通知、监控和日志记录基础设施的公共标识构件是解决这个问题的一种方法。一种常见的方法是使用特定于业务的身份，该身份被配置为作为通知发出，可以被日志记录系统捕获。然后，日志应该提供标识符和导致问题的容器名称之间的映射。
4.  日志格式必须向操作员提供完整的上下文。日志记录仍然是生产环境中调试问题的重要工具。对于容器环境，日志格式必须包括一些上下文，如容器 ID、容器映像和容器主机。容器运行时注入一个主机环境变量，应用程序可以在其日志中使用该变量。容器平台在其日志流中使用元数据，这有助于识别和补救活动。

## 使用容器做出敏捷决策

快速敏捷的环境提供了快速决策和按需迭代的能力。 [DevOps](/category/devops/) 运动的基石之一是采用观察、定位、决定和行动 [(OODA)循环](http://www.artofmanliness.com/2014/09/15/ooda-loop/)的理念，这是在不断变化的环境中采取行动的广泛使用的原则。将 OODA 的实践映射到集装箱化的生产环境会导致以下推论:

*   **观察:**这与从噪音中过滤出有用信号的警报和通知有关。这可以通过在出现问题时从监控系统接收事件的工具来实现。在这一阶段拥有良好的信噪比对整个过程的成功至关重要。
*   **导向:**一旦对信息的访问被整理出来，它就被用来识别导致问题的症状。从测井和监控系统获取信息是定向的基础。在这个阶段，您必须能够以最小的干扰来识别信息的确切来源。
*   **决定**:根据在定位阶段发现的症状，你必须决定采取什么行动来解决问题。例如，更改组配置或重新定位到一组新的主机。如果发现的问题与应用程序逻辑有关，那么回滚到以前的配置可能是一种修复方法。
*   **行动**:集装箱平台和工具一旦决定，就必须允许快速行动。对容器管理工具的访问和许可是有用的。

企业中的容器实现必须允许 OODA 循环被实现，并具有快速转换。任何集装箱管理和监测系统的优点是由其提供的信息的准确性和采取行动的速度来衡量的。

## 驯服复杂性的工具

在基于容器的环境中管理混乱的艺术导致了新的工具和服务的产生，这些工具和服务包含了容器管理的动态和自治性质。像 [StackStorm](https://stackstorm.com/) 和[网飞·温斯顿](http://techblog.netflix.com/2016/08/introducing-winston-event-driven.html)这样的工具激发了在事件发生时触发自动化工作流的实现，尤其是涉及环境问题的事件。将此绑定到您的容器平台可以允许在容器出现故障时执行操作手册。这减少了人工干预和工程团队的疲劳，从而提高了生产率。

我们之前讨论的一个概念是监控容器组，而不是关注单个实例。容器标签和环境变量的使用可以用来实现这一实践。像 [cAdvisor](https://github.com/google/cadvisor) 这样的工具可以捕获提供给主机上任何容器的标签。如果使用了环境变量，cAdvisor 还允许使用**–docker-env-metadata-whitelist**运行时参数来捕获它们。

[cyclone slider id = " ebook-5-赞助商"]

在传统实践中，跟踪架构中自包含服务之间的调用是很困难的。改进跟踪实践是微服务持续成功的重要组成部分。像 [OpenTracing](http://opentracing.io/) 这样的跟踪平台将会在未来所有基于容器的环境中变得普遍。云本地计算基金会已经采用 OpenTracing 作为托管项目。还有像 Zipkin 这样的工具，这是一个开源的微服务追踪器，最初是由 Twitter 开发的，用来追踪在不同的服务器上反弹的网页请求。还有 [Sysdig tracers，](https://github.com/draios/sysdig/wiki/Tracers)它允许从微服务到系统资源访问时间的一切开源跟踪。

在 OODA 循环中反复采取行动是容器实现的一个重要部分。像 [Vamp](http://vamp.io/) 这样的平台允许实现基于容器化的应用度量来做出金丝雀发布决策的工作流。像这样的工具可以作为实现 OODA 循环的方法，并将其应用到发布和测试实践中。

如果您运行带有进程隔离的容器，那么在跨主机的一组容器中找到一个运行的标记进程是一项具有挑战性的任务。识别运行标记容器的主机是问题的一部分。通常，这是通过一个主机监控工具来解决的，比如[云本地计算基金会](https://www.cncf.io/)的[普罗米修斯](https://prometheus.io/)。一旦确定了主机，就可以在主机和容器之间执行进程 ID 映射。这需要识别根进程 ID，并将其与正在运行的容器相关联。像 [Sysdig](http://www.sysdig.org/) 这样的工具解决了这个问题，并且对容器的性能几乎没有影响。

[Cloud Foundry](https://www.cloudfoundry.org/) 拥有解决容器管理和监控困难的独特方法。它以设计良好的 API、可靠的开发环境的形式，并通过为每个应用程序提供日志和指标，提供了容器化基础设施的抽象。这些特性使得开发人员可以轻松地采用敏捷实践，并利用对其容器化生产应用程序的可见性。

## 结论

在混合设置中工作的组织，包括容器化和传统工作负载，将很难接受这种转变。挑战在于维护围绕不同思想流派的系统。遗留系统通常运行时间长且不可丢弃；他们需要针对每个实例的精细监控和管理方法。

一些组织希望试验一个独立的团队，这个团队很少需要传统的系统监控。然而，OODA 循环仍然是容器化应用程序的一种有价值的方法，它为传统和基于容器的环境建立了通用的基本规则。

开发人员需要更多地了解监控、日志记录和服务管理方面的新实践，以便创建能够蓬勃发展的容器化应用程序。成功采用容器所需的改变将会产生能够实现敏捷 IT 目标的云原生系统。

Cloud Foundry Foundation、Cloud Native Computing Foundation 和 Sysdig 是新堆栈的赞助商。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>