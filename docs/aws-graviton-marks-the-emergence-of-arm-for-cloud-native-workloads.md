# AWS Graviton 标志着面向云原生工作负载的 ARM 的出现

> 原文：<https://thenewstack.io/aws-graviton-marks-the-emergence-of-arm-for-cloud-native-workloads/>

当亚马逊网络服务公司在 2018 年推出其 [AWS Graviton Arm](https://aws.amazon.com/ec2/graviton/) 处理器时，它的目标是松散耦合的横向扩展工作负载，如 Web 服务器、日志处理和缓存，这些实例对 SmugMug 这样的客户有吸引力，他们觉得自己为高级计算支付了过多的费用，而较小的内核就可以完成这项工作。基于 Arm 的计算实例作为绝大多数云巨头客户使用的基于 X86 的服务的替代方案。

在许多方面，这是关于启动生态系统，[大卫·布朗](https://www.linkedin.com/in/david-brown-aws/)，亚马逊 EC2 副总裁告诉新堆栈。“我们希望向生态系统发出信号，Arm 服务器芯片将成为现实，我们将推出它们。”

准备好生态系统意味着 Graviton2 不仅可以快速支持 EC2 实例，还可以支持越来越多的 AWS 服务，包括亚马逊 RDS、亚马逊 ElastiCache(其中 Graviton2 实际上是默认的)和亚马逊 EKS 等容器服务。

只有当客户选择处理器架构时，Graviton 才会出现；在“绝大多数服务”中，客户永远看不到服务是在 Arm 上运行的，但他暗示，很多服务会在 Arm 上运行。

布朗指出，将 AWS 服务转移到 Arm 也有助于让生态系统为客户工作负载做好准备。“这让我们在内部获得了很多经验，了解客户将会经历什么，并确保我们在生态系统中接触到各种参与者，并利用我们可以构建的工具和我们可以提供帮助的事情来解决问题。”

Graviton2 甚至可以作为 1U 前哨服务器，具有 64 个 vCPUs，128GiB 内存和 4TB 本地 NVMe 存储，用于本地运行亚马逊 EC2 和 EKS(尽管 AWS 建议它们用于手机信号塔等受限位置，而不是主流数据中心)。“我们从客户那里听说，他们希望将 Graviton2 放在前哨站中，就支持生态系统和确保我们能够在客户需要时为他们提供他们想要的硬件而言，ARM 处理器并不意味着它不能放在前哨站中。”

AWS 还将添加更多基于 AWS Graviton2 的实例，最新的是计算和网络密集型 C6gn，以配合为大型内存数据集或计算密集型工作负载设计的实例，无论有无本地 NVMe 存储。

## 从卸载到集成

布朗建议考虑开发类似 Graviton 的硬件微服务，这种服务可以比整个单片硬件系统构建得更快。布朗说，所有云提供商都希望在他们希望出售给客户运行虚拟机的相同 CPU 上减少运行云服务的开销，但 AWS Nitro compute cores 的效率远不止如此。

“虚拟化堆栈和需要在机器上运行的大量其他管理软件会使用一定比例的处理器，无论它是什么。我们注意到，除了降低效率之外——因为您使用了 10%到 20%的核心资源，而这些资源本可以用于客户自己的工作和虚拟机管理程序——我们也无法获得我们认为客户正在寻求的那种性能。我们努力应对工作流中存在抖动的延迟偏移、CPU 处理时间偏移，而抖动总是一件坏事。”

AWS 使用 Nitro 将越来越多的开销卸载到单独的处理器上，以提高性能并使其更加一致。“我们做的第一件事是移除网络，将其卸载到 Arm 处理器上。我们卸载了所有管理控制平面，最终在 2017 年，我们实现了 CPU 使用率为零的目标。”

由于 Arm 许可 IP 而不是销售处理器的方式，Arm SoCs 通常是 CPU、GPU 和加速器的定制包，亚马逊增加了许多特定于 AWS 的功能。

“Graviton2 大约三分之一是 Arm 内核，其余是我们设计的定制硅，”Brown 说。这包括加密内存和提高内存性能。“很大程度上是为了确保纠错，并确保内核真的真的是正确的，能够处理可能无法正常工作的内存模块，并保护客户工作负载免受此类故障的影响。”

## 面向 CPU 密集型应用的内核

Arm 最初是一款移动芯片，通常被视为降低功耗的一种方式，高内核数使 Arm 系统有利于并行化，但最近几代 Arm 也提供了强大的内核。这种组合提供了 AWS 关注的性价比。

“Arm 内核的功耗大约是替代内核的一半。客户已经看到原始性能提高了大约 20%;如果在 Graviton2 和最新的英特尔处理器上运行相同的基准测试，Graviton2 的速度大约快 20%，”Brown 说。也便宜 20%左右。布朗认为，结果是，你获得了大约 40%的性价比提升。

“我们已经看到客户通过最新版本的 Java 获得了巨大的性能优势，这些 Java 版本具有强大的 ARM64 支持。我们已经看到客户也从数据库应用程序中受益。因此，它确实是一个广泛的范围，任何利用核心的东西都只看到性价比的好处，”他说。

Brown 说，客户通常在移动更多堆栈之前就开始将 Graviton 用于他们的应用层。“它不一定是大规模计算密集型的；只有最通用的工作负载才会受到 CPU 的限制，如果可用的话，会使用更多的 CPU。许多云原生[工作负载]，无论是在 EC2 上原生运行还是在我们的一个容器堆栈上运行，都将获得显著的性能优势。”

这也可以削减其他虚拟机的成本。许多 IaaS 实例都没有得到充分利用，[鸭嘴集团](https://www.duckbillgroup.com/)的首席云经济学家 Corey Quinn 告诉新堆栈。“如果我看一看大规模客户的大型、运行良好的车队，在某些情况下，我们谈论的是数万个节点或更多，这些东西上的 CPU 利用率是可笑的:平均个位数百分点。”

可观察性服务提供商[蜂巢](https://www.honeycomb.io/)被更便宜和更高性能实例的承诺所吸引。“我们是一家 SaaS 公司，特别是我们是一家 SaaS 基础设施公司，所以我们运营支出的很大一部分是我们的 AWS 账单,”首席开发人员 Liz Fong-Jones 告诉 New Stack。
切换到 Graviton2 后，该公司的工程师可以在 40 个实例上运行相同的入口工作负载(接收 JSON 对象并将其放入 Kafka ),而不是在 X64 上需要的 70 个实例，性能没有明显变化。他们还能够迁移到稍高的 CPU 利用率(50-60%，而不是之前设定的 45%)，而不会在使用量激增时面临 CPU 饱和的风险。Fong-Jones 推测这是因为 Graviton2 内核没有超线程技术每个核心都是真正的核心，而不是共享的执行单元。"

Honeycomb 还将一个查询引擎工作负载(受 IO 和 CPU 限制，需要 NVMe 存储)从英特尔至强处理器上的存储优化 i3 实例迁移到 Graviton2 M6GD，以获得更好的性能，尽管成本高出约 10%。“这实际上是两倍的速度，”她说。

该公司正在继续将工作负载转移到 Arm 前端服务基础设施(不是 CPU 密集型的)现在运行在 Graviton1 上，Fong-Jones 计划转换他们的 Kafka 工作负载，纯粹是出于成本原因。对于持续的工作负载，该公司使用计算节省计划，由于 Graviton2 的实验，她希望能够承诺更低的支出水平。

## Arm 准备做什么？

随着开发人员社区开始评估苹果基于 Arm 的新 MAC，有人质疑 ARM64 客户端上可以使用哪些工具，但 ARM64 服务器软件生态系统已经大致就绪，一些迁移可以在几天或几周内完成，Brown 建议。

“在很大程度上，如果人们正在构建应用程序，那么这些应用程序的运行时很有可能是为 ARM 处理器构建的。例如，Python 或 Java 运行时提供了支持 ARM 的运行时，”Gartner 研究主管 Raj Bala 告诉新堆栈。“挑战将涉及可能利用 ARM 上不具备的处理器特定功能的框架。[商业的、现成的]应用程序可能是最大的挑战，或者可能是不支持 ARM 的 Docker 容器。”

Fong-Jones 告诉我们，内部代码肯定不太可能准备好。“你可以得到一个可以运行的 Ubuntu 映像，这已经非常大了。同样，不只是 Java 和 PHP 是解释型语言，golang 也是。如果 golang 不支持 ARM64 和交叉编译，我们就无法做到这一点。”

但她说，这是最简单的部分。“我们必须做一些准备工作，以验证我们对 x86 汇编没有任何硬性依赖。我们的存储确实有一些相当优化的部分，有些部分使用 AMD64 汇编，但它们有常规的 Go 等价物。但挑战在于所有的底层系统架构。”

Honeycomb 的安全入侵系统建立在 [osquery](https://osquery.io/) 之上，该系统最近才引入 ARM64 支持(部分原因是 Honeycomb 对该端口的赞助)。“如果我们部署了一堆这样的服务器，却没有适当的入侵检测，我们的安全审计人员会非常不满。”

该公司依赖于 Chef 配置管理软件。厨师 15 有 ARM64 支持，但是蜂巢用厨师 13。“Chef 13，至少是 Chef Inc .提供的，不是为 ARM64 打造的。所以我们不得不反向移植一些 Ubuntu 包，然后切换架构位。有些东西你必须重新配置，因为如果你运行的是旧的 LTS 软件，其中一些并不是为 Arm 构建的；你得反向移植它。”

Fong-Jones 研究了将 MySQL 切换到 Arm 的性能，“因为各种元数据的数据库伸缩是一个瓶颈。”不过还是那句话，AWS 支持 MySQL 8、MariaDB 10 和最新版本的 PostgreSQL“我们使用的是 MySQL 5.6，我们的语义不允许我们直接升级到 MySQL 8。我们可以使用 MariaDB 10，但 AWS 不会让你在零宕机的情况下这样做，因为它被认为是一个不同的数据库引擎。”

魔鬼一如既往地存在于细节中，“所有那些随机的奇怪的系统级依赖关系，你都必须真正地、真正地确定下来。让代码运行起来—这很简单！”

奎因建议，这些不匹配是不是每个人都跳到 Graviton 上的原因，或者甚至是最新的英特尔实例，如果一个必要的驱动程序没有为 Nitro 移植的话。“在许多环境中，它需要更新操作系统；这反过来意味着您需要重新认证和迁移现有的工作负载，而公司在这方面总是行动迟缓。”同样的问题阻碍了自动缩放等其他技术的采用。“他们还没有更新他们的应用程序架构，以便能够在节点加入时无需重新配置一切即可动态扩展。”

“对于一个数据库，当旧版本不支持 Arm 并且它也不会支持 Arm 时，迁移到新版本会有一点点挑战，”Brown 指出。

“这就是我们认为客户需要权衡投资的地方。在这个行业中，40%的性价比提升并不常见。他建议道:“尽可能便宜、快速地对你的工作量进行基准测试。然后，您可以投资进行迁移，比如迁移到不同的数据库版本或重写特定于处理器的内核模块，因为 40%的性价比证明了这一点。"

## 客户准备好接受 Arm 了吗？

对于新的实例类型，有时会出现可用性问题；Fong-Jones 不得不暂停查询引擎迁移 12 个小时，因为没有足够的 M6GD 实例，并且为了获得 spot 实例，她不得不接受 M6 实例(具有更多内存和稍高的时钟速度)以及 C6 实例，这些都是工作负载所需的。

Quinn 同意，可用性问题可能是 AWS 客户对迁移到 Graviton 持谨慎态度的原因，但它们应该是短暂的。“我能在任何 AWS 地区获得大规模运行该产品的能力吗？这方面的现货供应情况如何，他们能足够快地拿到吗？答案显然是肯定的，现在他们已经有了足够的数量，可以开始以托管服务的形式提供它们。”

但奎因指出，Graviton 可能不是组织降低 AWS 账单的早期选择或最重要的方式。“这是很好的内务管理，这绝对是一个好处，但这也不是他们能做的最有影响力的事情。”

“在我们的客户群中，对 Graviton 和 Nitro 的认知度有点低，”Bala 证实道。“当他们打电话时，通常是关于如何相对于传统处理器来考虑它。”他对此的回答是，“客户在考虑 ARM 与 x86 时，应该考虑端到端工作负载的兼容性和性价比。”

## 臂超出 AWS

AWS 不会是云中 Arm 服务器的唯一选择，但迄今为止它是最重要的选择。

在 2021 年初，Oracle 云基础设施将拥有 Arm 系统(使用 Ampere 的芯片，具有两个插槽和 160 个内核),可作为虚拟机或裸机提供，用于代码转换等基础设施任务以及运行容器和 Kubernetes。

微软从 2017 年开始为 Azure [打造搭载 Arm 处理器的 Windows 服务器系统。Azure 中使用的 Project Olympus OCP 机箱可以容纳不同的英特尔或 Arm 主板，微软已经测试了运行在 Arm 芯片上的 Windows Server，包括 Ampere Altra、富士通和 Marvell ThunderX2。](https://azure.microsoft.com/en-us/blog/enabling-cloud-workloads-through-innovations-in-silicon/)

当时，大多数云工作负载都是基础架构即服务，并且客户想要虚拟化的应用程序很少可用于 Arm 架构，因此微软没有公开提供基于 Arm 的 Windows Server 的计划。

相反，现在[在 Azure](https://www.marvell.com/company/newsroom/marvells-thunderx2-solution-now-deployed-for-microsoft-azure-development.html) 上运行的 ThunderX2 Arm 服务器已经被用来降低运行 Azure 内部基础设施(如存储、索引和搜索)的成本。在今年的 Arm DevSummit 技术研究员 [Arun Kishan](https://www.linkedin.com/in/akishan/) (他在 Windows 内核团队工作)指出:“今天，我们在 ARM64 上使用 Windows Server 来探索微软内部存储和虚拟机托管服务。”

Bala 认为，对于开发者来说，在 Arm 芯片上同时使用 Windows 和 macOS 可能是未来更广泛采用 Arm 服务器的转折点。“开发人员将希望在推进到 CI/CD 平台之前，在他们的本地机器上反复开发和构建，最终推进到 prod。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>