# 应监控哪些 Kubernetes 健康指标

> 原文：<https://thenewstack.io/which-kubernetes-health-metrics-should-be-monitored/>

[切尔克斯](https://www.circonus.com/)赞助本帖子。

 [Charlie Fiskeaux

Charlie 是 Circonus 的 UX 设计负责人，他在前端为客户创造了快速、易用的体验，同时与后端工程师合作，使 Circonus 变得安全、无呃逆。自从他在世纪之交热衷于多媒体光盘以来，他已经从事前端开发工作二十多年了。查理和他的妻子及儿子住在肯塔基州。](https://www.linkedin.com/in/charlie-fiskeaux-4293a54/) 

我之前写过一篇关于 [12 种最常见健康状况](https://thenewstack.io/12-critical-kubernetes-health-conditions-you-need-to-monitor/)的文章，您应该对其进行监测，以确保 Kubernetes 处于最佳状态。但是，您应该收集和分析哪些导致这些健康状况(以及更多)的指标呢？

[在 Circonus 最近对 Kubernetes 运营商进行的一项调查](https://www.circonus.com/2020/12/study-the-complexities-of-kubernetes-drive-monitoring-challenges-and-indicate-need-for-more-turnkey-solutions/)中，要收集哪些指标的不确定性是运营商面临的最大监控挑战之一。考虑到 Kubernetes 每天可以生成数百万个指标，这并不奇怪。

在本文中，我们将分享哪些健康指标对 Kubernetes 操作员收集和分析最重要。我们将查看这些指标的三个来源，按来源定义和命名每个指标，以及您应该监控的与这些指标相关联的健康状况。

## **#1:资源和利用率指标**

资源和利用率指标来自内置的指标 API，由 Kubelets 自己提供。我们仅将 CPU 使用率作为一个关键的健康条件，但监控内存使用率和网络流量也很重要。

高 CPU 使用率是一种严重的运行状况，需要使用这些指标进行监控和警报。这是最容易理解的:您应该跟踪您的节点正在使用多少 CPU 周期。进行监控很重要，原因有二。首先，您不希望应用程序的处理资源耗尽。如果应用程序受到 CPU 的限制，则需要增加 CPU 分配或向群集添加更多节点。其次，您不希望您的 CPU 闲置在那里。如果您的 CPU 使用率一直很低，那么您可能过度分配了资源，并可能在浪费资金。您应该在特定时间窗口内将 ***利用率{资源:cpu}*** 与预先确定的阈值进行比较(例如，它是否超过阈值超过 5 分钟？)来确定您的 CPU 使用率是否过高。

## **#2:状态度量**

***kube-state-metrics***是一个提供集群对象(节点、pod、DaemonSets、名称空间等)状态数据的组件。它通过提供资源和利用率指标的同一个指标 API 来提供指标。

使用这些指标，您应该监视和警告:崩溃循环、磁盘压力、内存压力、PID 压力、网络不可用、作业失败、持续卷失败、Pod 挂起延迟、部署故障、DaemonSets 未就绪和 StatefulSets 未就绪。[这里对每一种健康状况进行了定义。](https://thenewstack.io/12-critical-kubernetes-health-conditions-you-need-to-monitor/)

## **#3 控制平面指标**

Kubernetes 控制平面包含 Kubernetes 中被视为“系统组件”的部分，用于帮助集群管理。在 Google 或 Amazon 提供的托管环境中，控制平面由云提供商管理，您通常不必担心监控这些指标。但是，如果您管理自己的集群，您会想知道如何监控您的控制平面。当这些指标可用时，大部分都可以通过指标 API 找到。

## 控制飞机健康状况

您应该监控以下控制平面健康状况:

### **etcd 领导**

etcd 集群应该始终有一个领导者(除非在更换领导者的过程中，这种情况应该很少发生)。您应该密切关注您的所有 etcd_server_has_leader 指标，因为如果太多集群成员无法识别其领导者，您的集群性能将会下降。此外，如果您在***etcd _ server _ leader _ changes _ seen _ total***中看到大量的领导者变更，这可能表明 etcd 集群中的连接或资源存在问题。

### **API 请求延迟**

如果你把***API server _ request _ latencies _ count***分成***API server _ request _ latencies _ sum***，你会得到你的 API 服务器每个请求的平均延迟。跟踪一段时间内的平均请求延迟可以让您知道服务器何时不堪重负。

### **工作队列等待时间**

工作队列是由控制器管理器管理的操作队列，用于处理集群中的所有自动化进程。观察***workqueue _ queue _ duration _ seconds***或***workqueue _ queue _ duration _ seconds***中的增加会让您知道队列延迟何时增加。如果发生这种情况，您可能需要深入研究控制器管理器日志，看看发生了什么。

### **调度程序问题**

调度程序有两个方面值得关注。首先，您应该监视***scheduler _ schedule _ attempts _ total { result:unschedulable }***，因为不可调度的 pod 的增加可能意味着您的集群存在资源问题。其次，您应该关注调度器延迟，使用上面指出的延迟度量之一(度量名称和单位在 1.14 版中有所改变)。pod 调度延迟的增加可能会导致其他问题，也可能表明您的集群中存在资源问题。

## **事件**

除了从 Kubernetes 集群中收集数字指标之外，从集群中收集和跟踪事件也很有用。集群事件将允许您监控 pod 生命周期并观察重大的 pod 故障，并且观察从您的集群流出的事件的速率可以是一个很好的预警指标。如果事件的发生率突然或显著变化，这可能是出问题的迹象。

## **应用指标**

与我们上面研究的其他指标和事件不同，应用程序指标不是从 Kubernetes 本身发出的，而是从集群运行的工作负载发出的。从应用的角度来看，这种遥测可以是您认为重要的任何东西:错误响应、请求延迟、处理时间等。

关于如何收集应用程序指标，有两种理念。第一个(直到最近才被广泛接受)是指标应该从应用程序“推出”到收集端点。这意味着像 StatsD 这样的客户端必须与每个应用程序捆绑在一起，以提供一种将指标数据推出应用程序的机制。这种技术需要更多的管理开销来确保集群中运行的每个应用程序都得到正确的检测，因此它开始不受集群管理器的青睐。

第二个指标收集原则(越来越被广泛采用)是，指标应该由收集代理从应用程序中“提取”。这使得应用程序更容易编写，因为他们所要做的就是适当地发布他们的度量标准——但是应用程序不必担心这些度量标准是如何被提取或抓取的。这就是 OpenMetrics 的工作方式，也是 Kubernetes 收集集群指标的方式。当这种技术与收集代理的服务发现相结合时，它为从集群应用程序中收集任何类型的指标提供了一种强大的方法。

## **最终想法**

Kubernetes 每天可以生成数百万个新指标。这可能会带来两大挑战。首先，许多传统的监控系统跟不上正确监控 Kubernetes 集群所需的大量独特指标。其次，所有这些数据“噪音”使得我们很难跟上并知道哪些指标是最重要的。

您的 Kubernetes 监控解决方案必须能够处理所有这些数据，并且能够自动分析、绘制图表，并就需要注意的最关键指标发出警报。这样，你知道你已经收集了你需要的一切，过滤掉不必要的数据，并自动缩小最相关的数据。因此，您可以节省大量时间，并确保一切正常运行。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>