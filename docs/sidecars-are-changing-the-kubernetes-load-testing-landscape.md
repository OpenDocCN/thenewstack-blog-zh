# 边车正在改变 Kubernetes 负载测试的前景

> 原文：<https://thenewstack.io/sidecars-are-changing-the-kubernetes-load-testing-landscape/>

随着您的基础架构不断扩展，您开始获得更多流量，确保一切按预期运行非常重要。这通常通过测试来完成，负载测试是验证服务弹性的最佳方式。

传统上，负载测试是通过独立的客户端来完成的，比如 [GoReplay](https://goreplay.org/) 和 [JMeter](https://jmeter.apache.org/) 。然而，随着基础设施世界变得越来越现代化，组织正在使用像 Kubernetes 这样的工具，拥有一个现代化的工具集也很重要。

使用传统的负载测试，您通常会遇到三个主要问题之一:

*   编写负载测试脚本需要很多时间
*   负载测试通常在大型、复杂、端到端的环境中运行，这些环境难以配置，并且对于生产规模的基础架构来说成本高昂
*   数据和实际用例不可能一一对应，除非您有生产数据

更现代的方法是将负载测试工具直接集成到基础设施中。如果你使用 Kubernetes，这可以通过类似于 [操作符](https://www.redhat.com/en/topics/containers/what-is-a-kubernetes-operator) 来完成。这将为您带来这样的好处:需要管理的基础架构更少，并且能够使用特定于基础架构的功能，如自动扩展单元。

然而，将您的工具直接集成到 Kubernetes 的最大好处是您可以使用 sidecars。

## **你需要专注于流量捕捉**

任何适当的负载测试设置都有两个主要组件:流量捕获和流量重放。这是大多数负载测试工具几十年来的工作方式，并且仍然适用。但是，获取流量的方法有很多。

下一节将深入探讨边车如何具体帮助这一点。但是首先，理解为什么传统的负载测试会有问题是很重要的。

首先，你如何记录流量？最常见的方法是记录自己的流量。你打开一个配置为捕获流量的浏览器，开始模拟用户如何使用你的服务。

虽然这在许多领域肯定是有帮助的，但这确实意味着您依赖于自己对应用程序使用方式的理解。对于一个简单的应用程序，这可能不是一个问题，但是如果您的产品是一个 Saas 平台，那么您的应用程序可能有许多使用方式。

其次，你错过了重要的元数据。同样，这可能不是简单应用程序的问题，而是随着应用程序的扩展而变得越来越重要的问题。

如果您是创建流量的人，您将只能获得您的特定环境生成的头，这意味着您的负载测试将只测试一个特定的场景。更好的方法是捕获生产流量，并在您的重放中使用它，因为您将会收到一系列不同的请求。

第三，你需要考虑你的依赖关系。如果您对整个基础设施进行负载测试，这可能不是问题。但是，如果您想要对单个服务进行负载测试，也就是说，当测试是您的 CI/CD 管道的一部分时，您想要确保任何传出的请求都发送到一个 [模拟服务](https://speedscale.com/advantages-of-a-mock-api/) 。

使用传统的负载测试工具，你不会得到这个。要么您必须建立一个新的服务来充当模拟，要么您必须更改应用程序的代码。

第四，您添加了更多要管理的基础架构。在现代 DevOps 世界中，您不希望负载测试从开发人员的笔记本电脑上运行。它应该从运行在基础设施内部的服务中执行。因此，对于大多数工具，您必须添加需要管理的额外服务。

## **用边车抢流量**

现在你知道了为什么传统的负载测试不适合现代的基础设施，让我们触及前面的要点，探索 sidecars 将如何解决这些问题。

在 Kubernetes 中，很容易添加一个边车并使其充当代理。你已经解决了如何获取流量的问题。这个 sidecar 将捕获所有入站请求，并将其发送到另一个可以存储记录的请求的系统。

使用这种方法很容易实现隐藏，这是捕获生产流量并在您的开发环境中重放它的实践。

因为您直接记录生产数据，所以您也将肯定地知道您将从每个请求中获得所有元数据。不过，您可能已经看到了这方面的问题。身份验证、令牌或敏感信息呢？

嗯，边车不仅仅是捕捉交通。它还会负责回放。而且，因为 sidecar 本身就是一个应用程序，所以在它发送给应用程序之前，很容易转换任何元数据，比如时间戳。

至于敏感数据，sidecar 可以很容易地从元数据中过滤出来，然后再发送到存储器。

至此，您已经解决了管理额外基础设施的问题，因为可以通过几行简单的代码将 sidecars 添加到清单文件中。您还解决了缺少元数据的问题，因为代理将捕获所有内容，除非专门进行了配置。

然后还有嘲笑依赖的问题。sidecar 仍然充当传入和传出请求的代理。因此，您可以告诉 sidecar 您正在执行一个负载测试，它会识别出传出的请求。它不是转发请求，而是简单地用最初记录请求时获得的数据进行响应。

如果您想了解边车如何用于执行负载测试的具体示例，请查看 Speedscale 的 [这个示例](https://speedscale.com/kubernetes-load-test-tutorial/) 。

## **边车不是吸引交通的唯一方式**

在这一点上，应该清楚 sidecars 是如何被用来改变您进行负载测试的方式的。然而，值得一提的是，边车只是提高交通流量的众多方法之一。

随着行业的变化，流量捕捉很可能会变得商品化，而最好的工具将是在回放流量方面做得最好的工具。

许多开发人员使用 Postman 来测试他们的 API，并使用各种不同的请求定义创建了大量的集合。虽然这与不手动创建流量的观点有些冲突，但是能够测试特定的用例仍然是有价值的。

服务网格是管理服务之间通信的一种流行方式，尤其是微服务。大多数服务网格将使您能够拥有某种 [可观察性](https://istio.io/latest/docs/concepts/observability/) 。通过这样做，您将获得一组生产流量，然后您可以将它们导入到您选择的负载测试工具中。

考虑到这篇文章的主题，值得注意的是一些公司正致力于从服务网格的实现中移除边站。然而，现在这只是一种选择，看看服务网格的未来是否是无边车的将是令人兴奋的。

eBPF 越来越多地用于现代基础设施，如 Kubernetes。本质上， [eBPF](https://www.tigera.io/learn/guides/ebpf/) 让你在内核级执行应用，因此，这是一种非常有效的获取流量的方式。

来自监控系统的高保真日志也是捕获流量的一种可能方式。然而，这里需要注意的是，它必须是高保真的。为了节省成本和存储空间，很常见的做法是去掉请求日志中一些对故障排除没有帮助的头。如果您打算使用日志进行流量回放并获得最大收益，您需要保留所有信息。

API 网关/入口控制器可能是捕获流量的好方法，因为网关和控制器记录通过的流量是很常见的。如果流量捕获真的变得商品化了，那么只需将流量导入到负载测试工具中。

## **流量回放是负载测试的有力工具**

Sidecars 将改变负载测试的方式，一些公司已经接受了它。无论是因为你将使用它们来捕获流量，重放流量，还是嘲笑传出的请求，毫无疑问，你会看到 sidecars 的使用越来越多。

如果你有兴趣测试使用 sidecars 加载测试 Kubernetes 是什么感觉，那就去注册 Speedscale 的 [免费试用](https://speedscale.com/free-trial/) 。Speedscale 是 Kubernetes 负载测试中的一个新的开创性产品，重点关注流量回放、阴影、API 模拟等功能。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>