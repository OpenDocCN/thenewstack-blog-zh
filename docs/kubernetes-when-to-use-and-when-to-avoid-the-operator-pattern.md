# Kubernetes:何时使用，何时避免操作符模式

> 原文：<https://thenewstack.io/kubernetes-when-to-use-and-when-to-avoid-the-operator-pattern/>

在 Kubernetes 的世界中，操作符已经迅速成为一种流行的模式，远远超出了它们最初用于编码关于运行像 Prometheus 这样的有状态应用程序和服务的深层操作知识的用途。但是它们带来的 CRD 生命周期管理的复杂性意味着编写一个操作符并不总是你自己的应用程序的最佳解决方案，因为你要创建更多的代码来维护。

Rancher Labs 首席技术官 [Darren Shepherd](https://github.com/ibuildthecloud) 强烈鼓励开发人员在考虑编写自己的操作符之前[看看 GitOps](https://thenewstack.io/the-new-stack-context-kubernetes-moves-to-the-edge/) 和其他配置管理选项，他建议新的堆栈应该只保留给最高级的用例。

操作符有助于自动化如何操作复杂系统的知识，但是当存在可以使用的现有模式和原语时，使用“一次性编排逻辑”来管理应用程序有意义吗？

Shepherd 解释说:“基本上，只有在高度可用的持久系统中，才真正需要编写具有定制编排逻辑的操作符:不是持久应用程序，因为它通常只是与数据库进行通信，而是像 Cassandra 这样的实际持久系统，它需要高度可用，并具有关于如何进行定额和故障转移等操作的定制逻辑。”。“当你看到这些用例时，Cassandra 或 MySQL 或 persistent system 的操作员确实很有意义。但是如果你纵观全局，有多少这样的系统存在呢？当他们这样做时，应该是供应商或项目来编写操作符，而不是你。这是一个非常先进的概念，我认为不应该被大多数人非常积极地追求。”

Shepherd 看到人们试图用不适合的操作符解决两个主要问题:处理配置管理和将非 Kubernetes 资源作为 Kubernetes 对象公开。

“首先，他们实际上有一个配置管理问题。他们试图简化部署和管理应用的方式，他们认为运营商可以解决这个问题。”

这导致人们创建一个捆绑 Ansible 或 Helm chart 的操作符，试图解决部署管理问题，而他们实际上拥有的更多的是一个传统的配置管理问题，他认为通过 [Helm](https://helm.sh/) (牧场主正在为其 2.5 版本标准化)、GitOps 或 [Kustomize](https://github.com/kubernetes-sigs/kustomize) ，或通过更雄心勃勃的项目如 [CUE 数据约束语言](https://github.com/cuelang/cue)(自动化和脚本的通用方法)可以更好地解决这个问题。

不是说 GitOps 会让你做运营商做的事情，而是运营商做的事情解决不了配置管理问题。“GitOps 是完全不同的，但它是您更好地花费时间的地方，因为目前您的问题的解决方案很可能是在 GitOps 中，而不是在编写操作符中。”

由于 Rancher 已经开始处理边缘计算，这“放大了多个集群的问题”，他指出，“我们意识到我们实际上只是在重新发明配置管理。”

“让一个运营商说‘我要创造一些东西来体现操作应用程序的所有复杂性’，这没有多大意义，因为老实说，谁的应用程序会那么复杂？你的应用程序有什么复杂的地方不能用已经存在的原语来描述？修复你的应用，不要试图捆绑在这个运营商里。”

## 应用程序不是服务

操作符的第二个误用是使用它将非 Kubernetes 应用程序公开为 Kubernetes 服务。

谢泼德说:“我认为会出现比运营商现在所做的更好的模式来实现这一点。”。“我正在研究像 CUE 这样的框架，我认为我们将看到将一堆原语整合到一个更高级别的原语中的能力，而不需要大量的定制编程和编排逻辑。”

Rancher 为 Kubernetes 编写控制器的经验表明，有一些标准模式。“它们主要是数据输入，数据输出，”谢博德说。

“如果你有一个更好的配置管理，比如一种配置语言，你就可以在很大程度上自动化掉大量复杂的控制器和操作员等等。因为大多数时候都是‘我想拿这个输入数据，然后我想用一堆现有的数据来渲染它或者产生新的数据，然后调和那个状态’；这是一种非常常见的模式。”

他指出，运营商不会把复杂的应用程序变成你可以作为服务消费的东西。“如果我给你这个运算符，它就会自动为你做所有的事情，这有点太理想了。不，这只是让事情变得简单一点，但你仍然在操作一个非常复杂的系统。”

## 安全问题

创始人兼首席技术官[加迪·诺尔](https://www.linkedin.com/in/gadinaor)告诉我们，虽然有一些用例中操作符非常有用，以至于它们是无价的，但它们也是一个被严重滥用的概念，而且不清楚人们在开始编写操作符之前是否考虑过安全问题。在大多数情况下，他会放弃建筑运营商。

运营商执行成为平台基础设施一部分的任务；这意味着人类操作员需要清楚地了解许多移动部件。

“操作员是一个高特权组件:按照设计，他们会在您的集群中持续运行，从安全角度来看，这会带来风险。生态系统中的当前情况是拥有许多这样的集群，这会给集群带来很多风险。建立一个运营商，让它正确运行，让它以防弹的方式完全自主运行，这有很多复杂性；那是许多繁重的工作。当一个操作符只在很短的时间内执行其意图时，我为什么要在集群级别或名称空间级别运行一个具有高度特权的组件？”

Naor 指出，需要一个操作员可能表明你已经创建了一个过于复杂的架构，Kubernetes 并不是你正在构建的应用程序的最佳解决方案。你还应该考虑它将如何被消耗。

是否应该编写操作符的一个测试是，如果是一对一的关系，操作符只管理一个实例:必须有不同的方式来构建复杂的高特权自动化。"

“一种选择是，您可以只运行作业或使用现有组件，并将它们结合在一起，而不是构建会做同样事情的运算符。不用编写自己的操作符，您可以声明性地阐明您的操作符应该做什么，然后一个更强大、设计更好的组件可以处理这些繁重的工作。”

“考虑一下你认为运营商应该管理的生命周期是什么。如果是像备份和恢复这样普通的事情，可能有人已经以适合您的应用程序的普通方式完成了。如果你要建立一个运营商，感觉有一个新的微服务版本可用，你需要升级东西，GitOps 是一个非常通用的方式来实现同样的事情:你承诺有一个新版本，GitOps 代理将同步到你的目标环境，每个人都很高兴。”

Naor 建议将 KUDO 作为一个声明性的替代方案，用于在 Kubernetes 上自动化复杂应用程序的部署、安装和生命周期。“你用声明的方式写一些相当于操作符的东西；虽然没有完全成熟，但它很好地覆盖了大多数用例。而且，在你需要运行许多操作员的地方，你只需要运行一个操作员来完成所有繁重的工作。”

## 舵手和操作员

Naor 解释说，KUDO 弥补了 Helm 所能做的和构建应用程序的整个依赖树之间的差距。

Shepherd 指出，Helm 甚至可以做你需要的事情。“普罗米修斯号操作员安装了一个舵轮图，然后你就可以让一堆 CRD 去做事情。一个操作者就是一组控制器，为什么我要把它变成一个一流的概念？”他建议使用舵轮图的模式，操作员只是提供更多类型的控制器。“对我来说，这比拧一个操作员更有意义，这是一种非常专业的方法；Helm 是一种通用方法，既适用于我自己的应用程序，也适用于第三方应用程序。我从这个一次性[运营商]身上获得了什么价值？”

虽然 Helm 维护者 Matt Butcher 之前拒绝了使用 Helm 执行“[类似操作员的任务](https://cloudblogs.microsoft.com/opensource/2020/04/02/when-to-use-helm-operators-kubernetes-ops/)”的想法，但更多的操作员正在扩展原始定义，并以与 Helm 重叠的方式充当自定义安装程序。该项目目前正在讨论 Helm 4 将如何在不牺牲 Helm 的[可用性的情况下，处理 CRD 作为集群范围内共享的全球资源的脆弱性，并且存在关于处理](https://github.com/helm/community/blob/7531c3c59be0472188fae9f967652c9ff9324f61/architecture/crds.md)[操作符模式](https://github.com/helm/helm/issues/5871)的问题。

该讨论将 CRD 处理描述为“Helm 历史上最棘手的问题”，并指出真正的问题是“Kubernetes 还不够成熟”，Helm 无法为 CRDs 提供“强大的支持”。人们还担心，需要了解 CRD 管理来[安全地使用 Helm 图表](https://github.com/helm/community/pull/138)会改变项目当前的假设，即 Helm 用户不需要大量 Kubernetes 知识。

> 因为编写操作符意味着你要维护代码，所以你还必须承诺雇佣更多的开发人员和一个 Kubernetes 平台团队，他们在未来都有操作符方面的技能，以确保你对 Kubernetes 的使用是健壮和安全的。

Naor 建议考虑的另一个自动化选项是 OpenKruise 项目。这个项目扩展了 Kubernetes 基本调度结构中的一些缺点，使用了高级状态集的概念，这是 Kubernetes 默认状态集的增强版本，用于在 Kubernetes 上构建有状态服务。另一个想法是，sidecar 集合是注入 sidecar 的声明性方式。

“基于 sidecars 构建技术的开源项目一次又一次地实现同样的东西，这是一个注入侧边栏的变异准入控制器。所以他们制造了一些东西，你只需安装一次，然后声明性地告诉你注射什么和注射到哪里，”Naor 说。

Karl Isenberg ，他曾与 Mesosphere 的 KUDO 团队合作，是 Cruise Automation 的 PaaS 团队的技术负责人，该团队构建了 Isopd(一个无 YAML 的工具，在多集群插件管理变得更加复杂之前，帮助管理跨集群的公共资源),他编写了 Kubernetes 应用部署工具的[有用分类法](https://medium.com/@KarlKFI/compendium-of-kubernetes-application-deployment-tools-80a828c91e8f),其中包括操作者和替代者。

“生态系统仍在试图找出管理 Kubernetes 工作负载的最佳方式:有很多选择，它们都有利弊，”他告诉我们。由于有如此多的入口和服务网格选项，没有标准来构建部署自动化，因此解决方案往往是不可转移的，并且仅限于自定义堆栈。"

他指出，在 Mesos 中也发现了与运营商类似的模式，在 Mesos 中，应用程序和服务需要一个定制的工作负载调度程序作为两级调度程序的一部分，这导致了无状态应用程序的通用调度程序和需要生命周期管理的复杂分布式系统(如 Spark 和 Cassandra)的特定调度程序的混合。“运营商建立在此基础上。但过了一段时间后，他们接管了，每个人都编写操作符来处理定制的生命周期，部分原因是将功能更改上传到 Kubernetes 调度程序变得更加困难。”

对 Kubernetes 调度程序的改进可能会在某些情况下消除对操作员的需要，Isenberg 建议:“当操作员出现时，人们使用自己的定制控制器和操作员来管理他们应用程序的工作流或生命周期，因为他们无法定制调度程序或插件定制调度程序。现在可以在您的工作负载上设置注释，这样主调度程序就会忽略它，并由自定义调度程序进行调度。”

但定制的调度程序仍然很少:“我只知道有两个不只是运营商，”他指出。

## 集合和缩放

Isenberg 建议，操作员对具有“数据权重”的工作负载很有帮助。“数据具有重力，清空一个节点可能需要 30 多秒，或者可能需要比有状态集更复杂的东西，有状态集是为 etcd 模式设计的，在这种模式下，您有名称节点，这些名称不应该更改，它们只是应该重新出现。对于裸机或不能自动扩展的虚拟机而言，这是一种先于云原生的设计。这些云前原生部署设计需要适应 Kubernetes，因此人们与运营商一起做了很多工作。”

如果你正在写一个无状态的应用程序，你根本不需要写一个操作符。“但是没有人再编写无状态的应用程序了；每个人都在编写复杂的微服务分布式系统，如果你有任何类型的数据管道或流，你最终会有几十种服务，其中许多是现成的，它们可能会有自己的运营商，因为拥有更复杂产品的人适应 Kubernetes 的方式是与运营商合作。”

他指出，有时候，你认为的操作员实际上是控制者。“API 被设计成既可以声明使用，也可以命令使用，而操作符是使用 Kubernetes 的一种命令方式。否则，最迫切的用途要么是通过没有自己的 CRD 的控制器直接使用 API，要么只是脚本和您的 CI/CD 工作流。因为越来越多的人使用 Kubernetes，越来越多的人编写代码来执行命令式工作流，他们中的大多数人都在调用这些操作符，因为他们最终在其中使用了 CRD。但有时会有一点名称与控制器混为一谈，他们被错误地称为运营商，只是因为这很时髦。”

Isenberg 建议，操作符从根本上来说是一种解决 Kubernetes 中缺乏依赖管理或资源层次的方法(呼应了 Helm 关于 CRDs 的大部分讨论)，这两个问题都不会很快得到解决，所以有时操作符就是答案。

“写操作符不像做部署那么简单，但是如果部署不适合你，有状态集也不适合你，那么写操作符不是问题。但是你正在构建一个你将不得不无限期维护的软件，而不仅仅是一个你可以调整和替换的配置。你写的代码越多，你就越被这个平台所束缚。因此，当您编写操作符时，您被锁定在 Kubernetes 中，而部署就像一个配置文件；您可以放弃部署，将您的服务带到其他地方。Gitops 肯定更便携，写 Terraform 更便携。”

因为编写操作符意味着你要维护代码，所以你还必须雇佣更多的开发人员和一个 Kubernetes 平台团队，他们将来都有操作符方面的技能，以确保你对 Kubernetes 的使用是健壮和安全的。

Isenberg 指出，当 Kubernetes 中的资源不足以表达你需要做的事情时，运营商是“打破玻璃”的选择。但是，如果您正在调整应用程序和工作负载以在 Kubernetes 上运行，而运营商还没有为它们提供服务，那么 Kubernetes 可能不是运行它们的最佳位置。

“每个人都想最大化他们在 Kubernetes 上的投资，但我觉得有一点沉没成本的谬论。仅仅因为你可以在 Kubernetes 上运行一些东西并不意味着你应该这样做。有一些应用程序在虚拟机上更容易管理，因为它们是在一个设计部署和管理它们的时代构建的。”

## 隔离带有侧簇的操作符

如果您确实决定需要编写操作符来做您需要的事情，“您真的应该考虑在操作符空闲期间减少特权，”Naor 建议。

“考虑一下有什么东西可以从外部重新提供这些权限，这样你就不会有什么高特权的东西一直在运行。或者在集群之外运行这些操作符，断开并重新连接它们，而不是永远运行它们。从安全角度来看，不要让所有东西都在同一个地方运行更有意义，因为如果操作员受到威胁，那么整个集群都可能受到威胁。”

侧群集(Side clusters)是他根据 sidecar 模式创造的一个术语，对安全和监控服务特别有用，也可以改善运营商的安全和特权问题。

“监控 Kubernetes 审计日志的建议方式不是从集群内部进行，而是让外部安全运营集群连接到目标集群并执行监控，这意味着该集群对试图压制您的安全的威胁行为者具有更强的抵御能力。

对于 Prometheus，如果您在集群内部运行，那么 Prometheus 实例很容易受到集群状况的影响，如果集群变得不稳定，就会破坏您的监控系统。这就是为什么有些项目，比如灭霸和其他项目，试图将监控部分推出集群，然后将集群与外界隔离开来。

从安全角度来看，您面临着类似的挑战。“对于我们的一些客户，他们运行多个集群，我们正在构建辅助集群，这些集群负责运行(在我们的情况下)需要在应用集群之外运行或保留的安全相关任务。Naor 说:“如果我在一个辅助集群上运行我的操作员，并在主集群上管理代码的权限，这可以提高安全性，尽管不一定是管理许多操作员的开销。

如果在集群外托管操作符的名称空间和 RBAC 考虑看起来很复杂，这可能是另一个迹象，表明您应该采取不同于操作符的方法。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>