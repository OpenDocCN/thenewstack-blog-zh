# Golang 如何在不破坏程序的情况下发展

> 原文：<https://thenewstack.io/how-golang-evolves-without-breaking-programs/>

Go 编程语言的首席工程师有一个消息。在一年一度的围棋大会上， [Gophercon](https://www.gophercon.com/) ， [Russ Cox](https://swtch.com/~rsc/) 说很多人问他，“我们应该什么时候期待 Go 2 规范会打破我们所有的程序？”

“答案是永远不会，”考克斯告诉观众——用三张幻灯片强调优先考虑向后兼容性“是我们在 Go 1 中做出的最重要的设计决定。”

“Go 2，从与过去决裂、扔掉所有旧程序的意义上来说，是永远不会发生的。

“Go 2 是我们五年前开始的 Go 1 的主要修订版，现在*已经*开始了。但不会有破坏 Go 1 程序的 Go 2，”考克斯向观众强调。

相反，该计划是“在兼容性上加倍努力，这比我们从与过去决裂中获得的任何东西都要有价值得多。”

“我们将继续称之为 Go 1.x，而不是 Go 2，以强调连续性和向后兼容性。”

Cox 演讲的其余部分详细描述了在更新语言时，Go 团队如何努力避免破坏现有的 Go 程序。它探讨了具体的例子和边缘场景，展示了维护流行编程语言的一些日常逻辑。因此，尽管演讲的标题是“兼容性:如何让 Go 程序继续工作”，考克斯却深入探究了这一切的*如何*和*为什么*。

最后，他讨论了他们正在考虑的变化，这些变化意味着将来会有更少的坏程序。

## 稳定又无聊

这些言论是 10 月初在芝加哥万豪酒店(Marriott Marquis Chicago)发表的，是考克斯在 GopherCon 2022 年主题演讲的一部分——因此，考克斯的保证是在该活动自 2019 年以来的第一次面对面聚会上发表的。

“在 Go 1 的早期，Go 令人兴奋，充满了惊喜，”考克斯向观众回忆道，并补充道，“每周我们都会推出新版本，每个人都可以掷骰子，看看我们在他们的代码中打破了什么。

“我们发布了 Go 1 和它的兼容性承诺，以停止那种兴奋，这样新发布的 Go 就会很无聊。

“无聊是稳定的，”他告诉观众。无聊意味着能够专注于你的工作，而不是我们的。然后他开始谈论“我们为了保持无聊而做的重要而困难的工作”。"

考克斯首先想起了《承诺》结尾的一个警告:不可能保证未来的变化不会破坏项目。一种情况是:如果一个 bug 被修复，理论上它可能会破坏需要其原始 bug 行为的代码。“但我们非常努力地尽可能少地休息，并保持无聊。”

然后考克斯提供了一些从围棋历史中提取的有启发性的例子。例如，在 Go 1.1 中，他们意识到可以用更精确的纳秒测量(而不仅仅是微秒测量)来返回时间值，但这打破了一些没有预期到这种精度水平的测试。解决方案是提供一种丢弃额外精度的方法(通过将时间值截断为较旧的、精度较低的值)。然后在发行说明中记录该解决方法。

考克斯说，兼容性方面的大部分工作最终都花在了类似的问题上，对语言进行正确合理的修改——尽管如此，这仍然会破坏用户的程序。

另一个例子:Go 1.6 中的一个改变使得*排序*函数运行得更快了(大约快了 10%)。但是它以不同于以前的顺序对相同长度的元素进行排序，所以“期望特定输出的程序将会崩溃。”考克斯称之为兼容如此困难的一个例子。“我们不想破坏您的计划，但我们也不想被未记录的实施细节所束缚。”

## 在谷歌测试

Cox 强调了 Go 团队用来避免突破性变更的工具之一:大量测试，以及 beta 测试。每一个新的 Go 开发版本都要经过一系列内部测试，如果通过，谷歌就开始在内部使用。如果失败了，他们已经开始寻找缓解措施——或者至少知道在发行说明中记录问题。

Cox 分享了一个例子，在这个例子中，早期测试有助于早期发现问题。Go 1.8 改变了数据压缩包 *compress/flate* 产生更小的输出。这仍然打破了谷歌内部的一个项目，该项目需要能够创建其存档版本的精确复制。谷歌的团队最终不得不派生出 *compress/flate* 和 Go 的 *compress/gzip* 包，“这样他们就可以继续构建与早期版本的 Go 相同的部分。”

Cox 指出，Go 团队实际上用它的编译器做了同样的事情。“我们使用一个 *sort* 的副本，这样无论你使用哪个版本的 Go，编译器都会产生相同的输出。”

考克斯还讲了一个故事，讲述了一个早期的语言决定后来如何困扰着他。当他编写了一个解析 IP 地址的包时，他使用了在地址的某些部分带有前导零的示例 IP 地址。(如 18.032.4.011，在 Go 中转换为 18.32.4.11)。但是后来考克斯了解到，C 库将前导 0 解释为八进制(以 8 为基数)数的指示符，因此 032 被解释为 26，011 被解释为 9。考克斯解释了这一困境，也解释了解决方案。“这是围棋和世界其他地方的严重不匹配。但是从一个 Go 版本到下一个版本改变前导 0 将*也*是一个严重的不匹配…一个巨大的不兼容。"

相反，在 Go 1.17 中，团队改变了 ParseIP 的工作方式——但方式不同。当它遇到一个带有前导零的 IP 地址时，它不会将它们解释为八进制数，但也不会丢弃它们。相反，它只是完全拒绝了 IP 地址。"这样，如果 Go 和 C 都成功解析了一个 IP 地址，他们就能对它的含义达成一致."

虽然这一变化没有破坏谷歌内部的任何东西，但“Kubernetes 团队担心保存的配置可能会使用这些地址，现在它们将无法使用新的 Go 进行解析。”

为了避免语义变化，Kubernetes 分叉了[网。ParseIP](https://www.educative.io/answers/what-is-the-netparseip-function-in-golang) 。考克斯认为这些地址应该从配置中完全删除，“因为 Go 读取它们的方式不同于大多数其他软件。

“但那应该发生在 Kubernetes 的时间线上，而不是我们的。"

那么，如果一个协议改变了，为了支持这种改变，旧的围棋程序开始崩溃，会发生什么呢？Cox 提供了 HTTPS 的 SHA-1 证书的例子。该协议长期以来一直被认为不安全，美国国家标准与技术研究所(NIST)正式建议联邦机构在 2015 年停止在大多数用例中使用该协议[。Cert 权威机构在 2015 年停止发布它们，浏览器在 2017 年停止接受它们，因此 Go 最终在 2022 年取消了自己对它们的支持。(在 Go 1.18 和 1.19 中，通过使用 Go runtime 的调试变量 GODEBUG，可以将它们重新打开。)](https://csrc.nist.gov/Projects/Hash-Functions/NIST-Policy-on-Hash-Functions)

最初的计划是在下一个版本中删除它，但最终，Go 团队决定将它保留更长时间。Kubernetes 团队告诉他们，一些私人设施仍在使用私人 SHA-1 证书，而且“抛开安全问题不谈，Kubernetes 无权强迫这些企业按照 Kubernetes 的时间表或 Go 升级他们的证书基础设施。”

"毕竟，我们希望尽可能少地中断程序."

## 展望未来

兼容性是一个如此重要的问题，以至于 Cox 在结束他的演讲时提出了三个新的想法来帮助*进一步*减少程序中断变更的可能性。为了向后兼容，如果有一个潜在的有问题的更改，Cox 建议在 GODEBUG 变量中增加一个设置来禁用该更改。(同时保证该设置将持续至少两年——也就是说，通过四个 Go 版本。)考克斯补充道，尽管有些设置可能会持续更长时间，甚至是永远，但他们并不打算取消对 HTTP/2 的覆盖。

但是还有第三个特性:运行时中的一个计数器，用来跟踪程序因为禁用的更改而真正发生不同行为的频率，“这样用户就可以监控他们是否还在使用旧的设置。”

他们甚至会添加一种方法，在源代码的中覆盖来自*的程序中断行为，“这样二进制文件就可以拥有自己的*默认值*，与环境无关。”*

这将为 Go 团队尽可能维护 Go 向后兼容性的长期持续努力增加一个元素。

正如考克斯所描述的，“我们将继续尽我们所能——让你们所有人都感到无聊。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>