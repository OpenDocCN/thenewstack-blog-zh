# 在生产中大规模自动化 Kubernetes 的 7 种方法

> 原文：<https://thenewstack.io/7-ways-automate-kubernetes-scale-production/>

Kubernetes 开源容器编排引擎不是管理平台，也不应该被误认为是管理平台。编排的整个要点是可靠地启用自动化系统来促进应用程序的大规模部署和管理，而无需在每个步骤都进行人工干预。如果您使用的工具不支持自动化，那么您就没有真正利用编排的优势。

为此，以下是您可以并且应该在生产中自动化 Kubernetes 集群的七种方式。

## 1)记录

任何 Kubernetes 生产环境都将严重依赖日志。在[肯赞](http://kenzan.com/)，我们通常尝试将平台日志与应用日志分开。这可以通过非常不同的工具和应用程序来完成，甚至可以通过日志本身的过滤和标记来完成。与任何分布式系统一样，日志记录为准确跟踪特定调用提供了重要证据，即使它们在不同的微服务上，从而可以确定根本原因。

## 2)自愈

我们认为，如果没有自我修复能力，您的系统几乎不可能实现高正常运行率，尤其是在分布式环境中。Kubernetes 可以定期监控容器和集装箱的健康状况，并立即采取行动解决遇到的问题。Kubernetes 本地识别的两种对象类型是 podstatus 和 containerstatus。

[cyclone slider id = " kubernetes-series-book-1-赞助商"]

容器探测器(livenessProbe 和 readinessProbe)允许您定义希望 Kubernetes 如何监视容器是否处于活动状态和就绪状态。就绪探测特别有用，因为它实际上会让 pod 保持运行，但如果探测失败，则不会为它们提供任何流量。

但是，请注意，虽然自我修复功能(例如每半小时重启一次)非常有用，但它们也可能掩盖应用程序的问题。您需要足够强大的监控和日志记录功能，以便发现可能发生的任何问题。

## 3)弹性测试

根据您的应用需求(例如，99.999%的正常运行时间)，弹性测试可以也应该成为您平台的一部分。应用程序任何级别的故障都应该是可恢复的，这样就不会有人经历任何时间的停机。根据我们的经验，防弹应用程序只有在开发团队提前知道他们的工作将通过广泛的弹性测试时才是可行的。

虽然您可以通过最简单的手动方法进行一种弹性测试，例如手动关闭数据库或随机杀死 pod，但我们的经验证明，这些方法在自动化时更有效。虽然网飞的[混沌猴](https://github.com/Netflix/chaosmonkey)是一个非常强大、非常有用的弹性测试工具，它运行在亚马逊网络服务中，但它不是为 Kubernetes 构建的。令人欣慰的是，Kubernetes 领域出现了弹性测试框架，其中两个是 fabric8 [混沌猴](https://fabric8.io/guide/chaosMonkey.html)(集成开发环境 [fabric8](https://fabric8.io) 的一部分)和 [kube-monkey](https://github.com/asobti/kube-monkey) 。

## 4)日常审计

无论您设置了多少检查和平衡，您的 Kubernetes 生产环境都将从日常维护和审计中受益。这些审核将涵盖正常监控不涵盖的主题。传统上，审计被认为是一个手动过程，但是这个领域的自动化工具正在迅速和显著地改进。

## 5)自动缩放

 [肯赞·克雷格·马丁

克雷格·马丁(Craig Martin)是肯赞的工程界 SVP，他领导着工程运营部门，自称的使命是找到应对复杂挑战的优雅解决方案。在他的职位上，Craig 帮助领导公司的技术方向，确保探索新的和新兴的技术并将其纳入战略愿景。最近，克雷格一直专注于通过构建大规模微服务应用来帮助公司进行数字化转型。他长期从事专业服务领域的定制软件开发，在加入 Kenzan 之前，Craig 是 Flatiron Solutions 的工程总监。他在乔治梅森大学获得了理学学士学位。](http://kenzan.com/) 

对于 Kubernetes 来说，扩展通常意味着两件事之一:

*   缩放豆荚
*   扩展群集中的节点

缩放豆荚绝对是最常见的缩放形式。这将添加更多的服务实例，并使它们准备好开始接受流量。通常，使用 [Heapster](https://github.com/kubernetes/heapster) 度量来决定是否需要创建新的实例，从而执行 pod 级别的扩展。我们通常将最小 pod 数量设置得很低，并相信 Kubernetes 水平 Pod 自动缩放器能够正确设置最佳副本数量。我们总是设置每个集群至少有一个以上的副本，以避免出现单点故障的情况。

缩放节点是一种罕见的情况，但对于高度弹性的应用程序来说，这是一种非常有用的缩放机制。节点扩展需要后台 IaaS (AWS、GCP 等)进行扩展并注册到 Kubernetes 集群中。这个过程可以是手动操作，尽管我们不推荐这种方法。通常，我们使用能够自动扩展单个节点的工具(Kubernetes Repo 中的[示例)。节点级自动缩放器将执行两个主要操作，第一个是在需要时添加更多节点，第二个是删除未充分利用的节点。](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler)

## 6)资源配额

资源配额允许您限制 Kubernetes 平台中的名称空间，确保一个应用程序不会消耗所有资源并影响其他应用程序。设置资源配额可能有点困难。根据我们的经验，我们发现按照名称空间的预期负载来分解名称空间，并使用一个比率来计算集群的百分比是最外交化的开始方式。运行 Heapster 允许使用 kubectl top {node | pod}命令，该命令显示当前的节点或 pod 资源使用情况，这有时也有助于配额。在那里，使用监控和审计来确定您的分区是否正确。

## 7)集装箱资源限制

计算一个单独的容器或 pod 需要多少资源已经成为一种艺术。从历史上看，开发团队已经使他们的估计比他们需要的更有力量。我们尝试执行某种级别的负载测试，看看它如何进行故障转移，然后适当地分配资源。网飞创造了这种方法“挤压测试”

*有关如何在上述每个领域实现 Kubernetes 自动化的更多详细工具和技巧，请参见新书库的“[Kubernetes 生态系统的状态](https://thenewstack.io/ebooks/kubernetes/state-of-kubernetes-ecosystem/)”电子书中关于在生产中使用 Kubernetes 的问题和挑战的章节。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>