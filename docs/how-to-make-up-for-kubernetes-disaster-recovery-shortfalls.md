# 如何弥补 Kubernetes 的灾难恢复不足

> 原文：<https://thenewstack.io/how-to-make-up-for-kubernetes-disaster-recovery-shortfalls/>

[](https://www.linkedin.com/in/carlisia/)

[Carlisia Campos](https://www.linkedin.com/in/carlisia/)

[Carlisia 是 Velero 开源项目的高级工程师，该项目是一款用于备份和恢复 Kubernetes 集群的工具，同时也是 VMware 的高级技术人员。她是 CNCF 大使，也是 Podlets 播客上关于云原生技术的主持人。](https://www.linkedin.com/in/carlisia/)

[](https://www.linkedin.com/in/carlisia/)[](https://www.linkedin.com/in/carlisia/)

在 Kubernetes 之前，公司必须成为基础设施领域的专家，并维护复杂的集成，以一致、可靠地交付应用程序。事实证明，Kubernetes 为许多组织的应用程序开发和部署提供了巨大的优势。例如，Kubernetes 的抽象降低了复杂性和操作负担，同时允许应用程序开发人员以声明性和可重复的方式将应用程序部署到系统中。当使用自我监控和自我修复功能时，Kubernetes 可以帮助确保应用程序始终以最佳配置运行。所有这些都是在一个一致的平台上完成的，无论是在内部、云中还是跨混合基础架构。

但是，同样的动态行为通过将应用程序开发从运行它们的基础设施中分离出来而提供了如此多的优势，但在处理有状态应用程序时却变成了一个巨大的挑战。和有状态系统是生产中运行的大多数应用程序的原因。支持这些类型的应用程序的外部存储系统很少是可移植的，并且经常绑定到特定的云提供商。Kubernetes 通过为存储集成提供广泛的卷选项缓解了这一问题。例如，Kubernetes 持久性卷可以被视为由 Amazon 弹性块存储(EBS)支持的挂载存储。

然而，Kubernetes 没有提供数据保护或迁移解决方案，以便在灾难发生时能够恢复数据并使其恢复在线或转移到不同的提供商。

## 备份案例

在云原生空间中，有一点没有改变，那就是需要备份数据和其他关键组件，以便实现应用程序的快速恢复或迁移。以下是保持备份运行的一些原因:

*   人为错误。
*   黑客攻击易受攻击的系统。
*   天灾人祸。
*   当出现停机和数据丢失时，公司就会失去客户。
*   法律标准或合规性法规通常要求保留数据。

此外，有一个将应用程序从一个系统迁移到另一个系统的策略可能是有用的。例如，一家公司可能出于以下任何原因想要更换云提供商:

*   条款和条件的变化。
*   成本或收益的差异。
*   符合监管标准。

最后，可能需要定期进行数据归档，以便从昂贵的主存储中淘汰旧数据，同时保留这些数据以用于合规性或未来分析。

## 在 Kubernetes 备份什么

代表 Kubernetes 平台中的集群的本机对象存储在 etcd 数据库中。定期备份 etcd 集群数据对于在灾难场景下恢复 Kubernetes 集群非常重要，比如失去所有主节点。Etcd 有时也用于保存网络插件、CRD 和其他基本组件的状态。

除了 Kubernetes 集群的内容之外，一些组件存在于 etcd 之外，是运行 Kubernetes 所必需的。这些是与数据存储和基础架构相关的关键项目，也需要备份以用于完整的应用程序迁移或保护和恢复计划:

*   持久卷。
*   证书和密钥对，证书颁发机构。
*   服务帐户签名。
*   LDAP 或其他身份验证详细信息
*   与任何不使用 etcd 的 CRDs 和 CNI 插件相关的状态。
*   网络资源(允许重新创建 DNS 记录、IP 地址和子网分配、交换机、防火墙、路由、负载平衡、代理等的配置。).
*   特定于云提供商的帐户和配置数据。
*   底层基础设施的凭证(访问密钥、令牌、密码等。).

## 备份 Kubernetes 集群

受益于云原生架构的公司需要采取额外的措施，通过对其 Kubernetes 集群、数据存储和基础架构使用备份、恢复和迁移策略来实现其应用的连续可用性。

Velero 是一个开源项目，它集成了 Kubernetes 集群和数据存储，并提供了一种从其 etcd 数据库备份和恢复原生 Kubernetes 对象的方法。它还可以对任何应用程序的持久数据及其配置进行备份和恢复。这可以通过使用存储平台的本机快照功能来实现，也可以通过使用名为 restic 的集成文件级[备份工具来实现。](https://restic.net/)

因为 Velero 作为一个服务器进程在 Kubernetes 集群中运行，所以它既可以在内部运行，也可以在公共云环境中运行。因为它使用 Kubernetes API 来捕获或恢复集群资源的状态，所以它提供了以下好处:

*   备份可以捕获群集资源的子集，通过命名空间、资源类型和/或标签选择器来选择它们，这为备份和恢复的内容提供了高度的灵活性。
*   托管 Kubernetes 产品的用户通常无法访问底层 etcd 数据库，因此无法对其进行直接备份和恢复。
*   通过聚合 API 服务器公开的资源可以很容易地备份和恢复，即使它们存储在单独的 etcd 数据库中。

为了存储其备份文件，Velero 需要访问任何 S3 或 S3 兼容的数据存储或任何对象存储。此存储不需要与要备份的 Kubernetes 集群位于同一个提供程序中。

## Velero 插件系统

Velero 从一开始就提供了对执行持久卷快照的支持。为了支持团队可以维护的少数提供者之外的支持，Velero 提供了一个插件 API，允许社区为任何提供者创建插件(如果它还不存在的话)。Velero 团队为亚马逊 S3、微软 Azure Blob 存储、谷歌云平台(GCP)存储维护对象存储插件，为亚马逊 EBS、微软 Azure 托管磁盘和 GCP 计算引擎磁盘维护卷快照插件。

## Velero 功能

以下是 Velero 命令行界面(CLI)提供的一些关键功能:

*   创建、删除和列出所有备份。
*   计划备份。
*   在本地下载备份文件。
*   像其他 Kubernetes 对象一样描述和检查备份。
*   查看每个备份的日志。
*   直接从 CLI 触发错误报告。

由于所有 Velero 操作都是使用 CLI 完成的，因此 DevOps 团队和平台操作员可以快速轻松地触发临时备份、配置计划备份和执行恢复。由于该项目是开源的，任何组织(无论大小)都可以在云原生之旅的任何时间点开始创建 Kubernetes 集群的备份，只需最少的工作和成本。

## 不同的时代，同样的需求

在业务环境中，灾难是指任何中断业务连续性的事件。就 Kubernetes 而言，重要的是要了解该平台在多大程度上实现了这种连续性，以及它需要在哪些方面得到补充。

因为灾难恢复不是 Kubernetes 提供的一组操作，所以公司需要找到一个能够满足其需求的备份和恢复解决方案。同时，像 Velero 这样的工具，直接与 Kubernetes API 集成，将提供最大的灵活性和简化的工作流程。因为它是一个开源项目，并且易于使用，所以公司可以选择从他们将业务转移到 Kubernetes 的那一刻起就实施备份和恢复工作流。备份从来都是至关重要的，有了 Kubernetes 和 Velero，备份变得简单且经济实惠。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>