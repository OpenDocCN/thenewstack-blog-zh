# 优化 APM 账单的战术现场指南

> 原文：<https://thenewstack.io/a-tactical-field-guide-to-optimizing-apm-bills/>

2022 年初，Reddit 用户“engineer l”[描述了一个事件](https://www.reddit.com/r/devops/comments/udgohy/there_is_no_such_thing_as_too_much_logging_or_is/)，他公司的一个团队在短短几天内设法意外地在 Azure Log Analytics 上花费了 10 万美元。

这个特殊的事件很可能是该组织的日志记录中的一个不幸的异常。然而，我们在 Lightrun 亲眼目睹了客户、设计合作伙伴和潜在客户的情况，处理大量[数据](https://thenewstack.io/category/data-2/)或创建高交易量系统的组织每年仅在日志接收、[存储](https://thenewstack.io/category/storage/)和分析上就花费超过 100 万美元。

在现代软件组织中，日志很快成为一种非常昂贵的实践。

在我们深入探讨减少总体日志记录量的有效方法之前——以及通过代理减少每月应用程序性能监控(APM)——Datadog、New Relic、Elastic 等。—比尔，最好简要地看一下，作为一个行业，我们是如何在一个极其昂贵的可观测性的世界中结束的。

## **伐木成本**

为什么[测井越来越贵](https://go.lightrun.com/lightruns-impact-on-enterprise-logging-costs-study)？

底线是，由于复杂性的增加和替代选项的缺乏，日志量呈螺旋式上升。

创建高流量、数据密集型和/或高事务应用程序的组织每天都会生成大量日志数据，以获得对其复杂系统的足够了解。

然而，不管遇到实际的技术问题，答案无疑是相同的:添加更多的日志，探索，冲洗和重复。

[可观察性](https://thenewstack.io/category/monitoring/)供应商们非常清楚这一事实，他们想出了聪明、巧妙的方法，对涉及日志聚合和分析的每一项活动收费。如今，以下所有内容(每一项都是从大规模日志记录信息中可靠地获取价值所必需的)都要花钱:

*   日志传输/输出
*   日志摄取
*   日志处理/索引
*   日志存储
*   日志查询/分析/扫描
*   供应商订阅/许可成本(针对托管解决方案)
*   基础设施成本(对于自托管解决方案)
*   人事和培训

其中一些是显而易见的(软件许可)，但其他一些则不太为人所知，有时甚至会被完全忽略，直到账单到来(如遥测数据的云出口成本)。当汇总在一起时，在不断增长的成本背后出现了两个主要主题:

### **1。隐性成本**

如上所述，当公司购买可观察性软件时，他们并没有意识到他们所支付的一切。例如，自托管可观测性系统的一个主要潜在成本是在高日志量下维持这样一个系统所需的基础设施——大量的计算和存储资源以及大量的带宽余量，这只是购物清单上的几个项目。

除了可观测性系统的成本，我们还应该考虑测井本身的成本。

请注意，随着时间的推移，通过向我们的应用程序添加大量日志，我们可以增加 IO/CPU 使用率，降低吞吐量，并以计算和网络使用的形式产生额外费用，所有这些都是为了正常的应用程序运行。

这种对传统静态日志记录的过度依赖，再加上不断增加的日志量，实际上会显著影响处理相同工作负载所需的实例数量，这自然会转化为更高的总体云成本。

这些隐含的、隐藏的成本可能会蔓延到那些没有密切监控其日志记录情况的组织。

### **2。冗余记录**

实际上，99%的日志实际上并没有被使用。之所以创建它们，是因为开发人员必须采取“安全胜于遗憾”的方法，这导致了过度记录应用程序以应对任何可能发生的情况的趋势。

所有这些甚至没有被使用的日志，都是在几个点上付费的，包括传输、摄取、存储、处理等。

以上两点的结果是，企业为他们不需要和不使用的日志支付了数倍的费用。

下一节将讨论这些组织如何优化这些日志量，以降低他们的 APM 总成本。

顺便提一下，我们已经围绕优化日志成本创建了一份详细的报告，包括确切的数字、潜在的投资回报和更实用的日志量减少建议。你可以在这里查看[。](https://go.lightrun.com/lightruns-impact-on-enterprise-logging-costs-study)

## **优化 APM 账单—指南**

减少伐木费用有三种主要途径:

1.  用动态日志替换可重复的日志
2.  执行日志审计
3.  优化日志记录

### **1。用动态日志替换可再现日志**

让我们首先定义将在以下段落中使用的两个关键术语:

1.  **可重现的日志**是开发人员在本地、QA 或试运行环境中可以轻松重现的任何日志。
2.  **动态日志**是可以在应用程序执行期间添加到应用程序中的任何日志，而无需修改源代码、运行整个开发周期或重启/停止正在运行的应用程序。它们是短暂的、细粒度的、有条件的，可以实时检测，并且可以直接从集成开发环境(IDE)中使用。我们在 Lightrun [有一个平台](https://lightrun.com/)，可以让开发者实时按需将这样的日志添加到他们的应用中。

开始减少总日志量的最好方法是用动态日志替换所谓的可再现日志。

这意味着只有绝对关键的(出于合规性原因或数字取证所需的日志)或不可再现的日志(在开发或登台环境中难以再现的日志)才需要添加到开发中的代码库中。

所有可重现的日志都可以从代码中删除。当或者如果再次需要它们时，使用动态日志来代替，以便实时动态地检测它们，节省宝贵的开发人员时间和可观察性成本。

下面我们收集了一些日志的例子，它们应该或者不应该被动态日志所取代:

### **可以用动态测井代替的可重复测井示例**

**重复日志消息** —日志记录指令是在同一段代码中添加越来越多的日志消息而没有注意到已经记录了什么的结果。它们通常以下列形式出现:

*   具有多个日志记录指令的方法，这些指令以不同的形式记录相同变量的值
*   在连续的行中有多个日志记录指令的方法

**状态相关日志** —仅当值不是预期值时才感兴趣的日志记录指令，例如当值等于 null 或零时。它们通常以下列形式出现:

*   记录打印方法调用的返回值
*   打印输入参数值的日志
*   打印 API 调用、数据库查询或从文件中读取的信息的返回值的日志
*   通常作为零值或空值发出的日志

**“标记日志”** —以静态消息的形式记录指令，只表示执行已经到达代码的某一点。它们通常表现为:

*   带有静态消息的日志
*   日志放在方法的开头或结尾
*   日志放在作用域的开头或结尾(例如，如果是块)

### **可以用动态测井代替的不可再现测井示例**

*   指示意外情况的日志消息，这些意外情况在大部分时间都不应该处于活动状态，如果达到，则指示异常状态。
*   与合规性、安全性、产品事件和商业智能相关的日志。

### **2。执行日志审计**

日志审计是找出如何在任何应用程序中大量减少发出的日志数量的好方法。

这种类型的审核包括审查整个系统的日志记录输出，挑选出产生成本最高的日志的特定部分，然后执行删除冗余日志或降低每个日志成本的操作。

第一步是确定“大罪犯”。大多数日志接收平台都提供了一些控制台来识别占用空间最多或出现频率最高的日志。但是，这些控制台在日志记录器使用可能使日志难以识别和与特定代码行关联的信息修改日志之后处理日志。

根据您首选的日志记录方法，可以创建内部工具来解决这个问题。在我们的例子中，我们构建了一个简单的工具——[你可以在这里找到它](https://github.com/lightrun-platform/LogStats)——它作为 JUL (Java Util Logging)框架的一个额外的日志处理器工作，并对发布的每个日志进行计数。

该工具定期打印出日志调用的次数。虽然它没有估计每个日志的大小，但是它应该能够很好地判断出哪些日志被大量打印并且占用了最多的空间，这是一个很好的起点。理想情况下，此类工具还会考虑每个日志条目中的字节数，包括对象和 MDC(映射诊断上下文)以及其他额外的度量，这些度量揭示了应用程序发出的日志的大小。

我还建议花时间与您的 SRE/支持工程师一起检查有用/重要的日志。这些人通常对实践中实际使用的日志有独特的观点，并对哪些日志必须保留，哪些日志可以轻松删除有自己的看法。

### **3。优化测井**

尽管有上面的评论，要区分哪些日志是最重要的，哪些不是很容易。作为一名开发人员，通常很难给一个给定的日志赋值，直到我们运行了代码，并看到它在实际流量和实际事务中发出了多少次。

解决这个问题的一种方法是简单地遵循一种“自顶向下”的方法，并专注于一般的最佳实践，将每个单独的日志消息优化为最精简的形式(同时仍然保持其有用性)。

这些优化可以大致分为两种类型:“全局”优化和“大罪犯”优化。

**全局优化**

全局优化是那些具有广泛影响的优化。这里即使很小的变化也会显著影响总的日志记录量，并通过代理日志记录成本:

*   从 MDC 中删除对象:
    *   尽量少用它，因为它会影响随后的所有日志。
*   减小 MDC 对象的大小:
    *   不要记录对象，记录 ID。
*   缩短对象 id:
    *   如果您使用通用的唯一标识符，请尝试使用一个简短的版本，如`shortuiid`。
*   查看分支逻辑:
    *   检查包含许多条件分支的代码部分中的日志指令，并决定是否所有日志都应该存在。
    *   移除放置在依赖于功能标志或各种配置选项的代码部分中的日志指令。

**大罪犯优化**

大罪犯日志是最常导致“日志爆炸”的日志根据我们的经验，这些是发出的大多数日志，可以很容易地删除。下面的列表详细列出了这些日志类型的一些示例:

*   删除对于理解应用程序状态不是绝对必要的日志——这些日志很容易从其他日志中推断出来。
*   检查日志文件，查看日志中的信息是否已经打印在堆栈的更高层，或者甚至是以相同的方法打印。
*   尽可能将信息日志转换为调试日志，从而减少定期发出的日志。
*   将日志缩短到绝对最小值。不要在多余的散文上浪费文字。
*   不要记录范围内的每个对象，只记录那些绝对必要的对象。
*   专注于提供更多流量的特定模块/服务，并减少那里的日志量。

## **最后的想法**

通过审计您的日志，应用[帕累托原则](https://betterexplained.com/articles/understanding-the-pareto-principle-the-8020-rule/)来决定哪些日志最适合删除，然后用动态日志替换最大的违规者，您可以显著减少日志的数量，从而减少相关的 APM 账单。

*如果您想了解更多关于如何在实践中产生相同结果的信息，请阅读我们的* [*关于使用动态日志记录将日志量平均减少 35%的报告！*](https://go.lightrun.com/lightruns-impact-on-enterprise-logging-costs-study)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>