# 基础设施即代码模板中的 5 个常见风险

> 原文：<https://thenewstack.io/5-common-risks-in-infrastructure-as-code-templates/>

来自帕洛阿尔托网络公司的 Prisma 赞助了这篇文章。

 [西奥·德斯普迪斯

西奥是一名高级软件工程师、顾问和经验丰富的导师。他对开源架构、云计算、最佳实践和函数式编程有浓厚的兴趣。](https://www.linkedin.com/in/theofanis-despoudis-7bb30913/?originalSubdomain=ie) 

为复杂环境部署基础设施并不容易。为了可靠和可扩展，它需要一致性和标准。基础设施即代码(IaC)是一种简化流程的方法。

通过允许开发人员编写描述应如何配置基础架构的代码，然后自动配置基础架构以满足定义，Terraform 和 CloudFormation 等 IaC 工具为流程增加了大量自动化，否则这将是乏味和耗时的-更不用说在管理员配置系统时出错的情况下容易出现人为错误。

但是随着 IaC 提供的巨大力量而来的是巨大的责任，因为有许多[风险牵涉其中。](https://unit42.paloaltonetworks.com/cloud-threat-report-intro/)本文概述了 IaC 模板中最常见的五种风险，以及如何修复它们。

让我们开始吧…

## **1。硬编码秘密或资源引用**

对于过于敏感而无法查看或可能会随时间变化的信息，如密钥、代码、IP 地址、域名、别名或帐户名，应将其指定为具有适当名称的变量。根据经验，出于安全目的，这种类型的信息不应该硬编码在版本控制中。这也非常不方便，因为如果我们轮换一些密钥或秘密，我们将需要一个新的提交和审查阶段，在糟糕的部署情况下，这可能会被阻止或延迟几个小时或几天。相反，所有这些数据都应该存储在专门的服务中，这些服务根据需要注入所需的秘密或上下文变量。

在一个典型的案例场景中，我们使用 AWS Secrets Manager 或 Vault 的示例在创建基础设施计划并提交部署时检索这些值。通过适当的[访问控制](https://blog.paloaltonetworks.com/2020/01/cloud-ueba/)和审计，可以更安全可靠地处理秘密。

## 2.将状态文件提交到版本控制中

对于 Terraform 的用户，状态文件是在启动 IaC 计划时创建的项目。它们包含特定基础设施的有用元数据和配置选项。可以理解，在那里存储敏感值并在版本控制中提交它们的可能性更大。当其他人试图从版本控制中签出代码时，这会产生额外的问题；状态文件可能过时或不完整。他们最终可能会部署错误或不安全的基础架构组件，这些组件很难安全回滚。

共享和重用状态文件的最佳方式是在一个远程状态位置(通常是一个远程存储服务，比如 Amazon Web Services 的 S3)共享它们，并具有适当的权限。

## **3。在部署之前或之后不执行健全性和安全性检查**

在使用模板或状态计划之前，您可以选择根据当前的基础设施部署对其进行验证。这将有助于捕捉任何语法错误；但最重要的是，在这个过程中可能出现的任何意想不到的破坏性变化。

此外，在部署完成后，应该有额外的健全性和安全性检查来回答最常见的问题:部署的基础设施安全吗？部署是否留有开放端口？部署没有正确销毁未使用的资源吗？

编写验收测试来验证部署后的常见安全假设是第一步(参见 [TaskCat](https://github.com/aws-quickstart/taskcat) 和 [Terratest](https://github.com/gruntwork-io/terratest) )。此外，应该有一个自动化的系统，如 [Prisma Cloud](https://www.paloaltonetworks.com/prisma/cloud/network-protection) ，对环境执行定期检查，以捕捉任何偏差并上报安全问题。

## **4。使用不可信的图像或插件**

使用旧的或来源不明的映像和实例，如果它们存在漏洞，可能会带来安全风险。如果您使用第三方的 IaC 插件，也会出现同样的问题(例如，使用 Terraform 时的典型情况)。仅仅因为它们是开源和公开的，并不意味着它们是[可信和可靠的](https://blog.paloaltonetworks.com/prisma-cloud/cloud-container-image-trust-groups/)。事实上，除非进行彻底的安全检查，否则它们会带来巨大的安全风险，因为它们可能会在运行时泄漏数据或执行不安全的部署。

在实际使用之前，应该对图像或插件的功能进行良好的对等审查和评估。

## **5。不重用代码，将所有内容放在一个文件中**

将所有的配置和模板放在一个文件中会导致灾难。这是因为它们可能不适合在一起。增加配置数量会导致大量重复代码。这种代码重复会导致难以理解的模板，从而导致更多的配置偏差，最终导致产品化。IaC 模板应按照环境和逻辑界限进行组织(例如:生产、开发、使用其自己的数据库进行暂存、VPC、权限和 IAM 策略模板)。

使用通用参考和共享模块有助于每次都更加自信和一致地部署基础架构资源。

## **最终想法**

从上面的场景中，你可以清楚地理解 IaC 模板是源代码，需要被当作源代码来对待。这实质上意味着，在将这些模板提交到版本控制系统之前，您应该对它们进行检查，对它们进行质量评估，对它们进行格式化和验证——每次都应该由多个人进行。

一些组织政策应该在早期建立。只有这样，我们才能确保避免一整类错误和允许未经检查的代码进入生产空间的风险。坚持良好的工程实践并进行跟踪始终有助于首先避免这些风险。

*如果你对 IaC 的真实研究感兴趣，包括实际用户数据，看看帕洛阿尔托网络公司专注于 IaC 模板漏洞的* [*Unit 42 云威胁报告*](https://start.paloaltonetworks.com/unit-42-cloud-threat-report) *。*

通过 Pixabay 的特征图像。

目前，新堆栈不允许直接在该网站上发表评论。我们邀请所有希望讨论某个故事的读者通过推特或脸书与我们联系。我们也欢迎您通过电子邮件发送新闻提示和反馈:[feedback @ thenewstack . io](mailto:feedback@thenewstack.io)。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>