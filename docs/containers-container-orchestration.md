# 从容器到容器编排

> 原文：<https://thenewstack.io/containers-container-orchestration/>

[](http://www.janakiram.com/)

 [贾纳奇拉姆·MSV

贾纳奇拉姆·MSV 是贾纳奇拉姆联合公司的首席分析师，也是国际信息技术研究所的兼职教员。他还是 Google 认证的云开发人员、Amazon 认证的解决方案架构师、Amazon 认证的开发人员、Amazon 认证的 SysOps 管理员和 Microsoft 认证的 Azure Professional。他之前的工作经历包括微软、AWS、Gigaom Research 和阿尔卡特朗讯。](http://www.janakiram.com/) [](http://www.janakiram.com/)

Docker 平台和周围的生态系统包含许多工具来管理容器的生命周期。仅举一个例子，Docker 命令行界面(CLI)支持以下容器活动:

*   从注册表中提取存储库。
*   运行容器并可选地将终端连接到容器。
*   将容器提交给新映像。
*   将图像上传到注册表。
*   终止正在运行的容器。

虽然 CLI 满足了在一台主机上管理一个容器的需求，但在管理部署在多台主机上的多个容器时，它就显得力不从心了。为了超越单个容器的管理，我们必须求助于编排工具。

编排工具将生命周期管理功能扩展到部署在机器集群上的复杂的多容器工作负载。

通过对主机基础架构进行抽象，编排工具允许用户将整个集群视为单个部署目标。

### 基线特征

编排流程通常涉及工具，这些工具可以自动化应用程序管理的所有方面，从初始放置、调度和部署到稳态活动，例如支持扩展和故障转移的更新、部署、更新和运行状况监控功能。这些功能已经成为用户期望现代容器编排工具提供的一些核心特性的特征。

### 声明性配置

流程编排工具为开发运维团队提供了一个选项，可以使用 YAML 或 JSON 等语言，在标准模式中声明应用工作负载及其配置的蓝图。这些定义还包含关于支持工作负载的存储库、网络(端口)、存储(卷)和日志的重要信息。这种方法允许编排工具多次应用相同的配置，并且总是在目标系统上产生相同的结果。它还允许工具在不同目标环境的开发、测试和生产的不同阶段接受相同应用程序的不同配置。

### 规则和约束

工作负载通常对主机放置、性能和高可用性有特殊的策略或要求。例如，在同一台主机上提供主数据库容器和从数据库容器是没有意义的；这违背了初衷。同样，将内存缓存放在 web 服务器所在的主机上也是一个好主意。编排工具支持用于定义容器放置的关联性和约束的机制。

### 准备金提取

供应或调度处理协商容器在集群中的放置并启动它们。此过程包括根据配置选择合适的主机。除了容器供应 API 之外，编排工具将调用特定于主机环境的基础设施 API。

### 发现

在由运行在多个主机上的容器组成的分布式部署中，容器发现变得至关重要。Web 服务器需要动态地发现数据库服务器，负载平衡器需要发现并注册 web 服务器。编排工具提供或期望分布式键值存储、轻量级 DNS 或一些其他机制来实现容器的发现。

### 健康监控

因为编排工具知道系统的期望配置，所以它们能够独特地跟踪和监视系统的容器和主机的健康状况。如果主机出现故障，这些工具可以重新定位容器。类似地，当容器崩溃时，编排工具可以启动替换。编排工具确保部署始终与开发人员或操作人员声明的期望状态相匹配。

## 深入了解三种流行的编排平台

### 码头工人群

Docker Swarm 的目标是使用与核心 Docker 引擎相同的 Docker API。Swarm 透明地处理与 Docker 引擎池相关联的端点，而不是以代表一个 Docker 引擎的 API 端点为目标。这种方法的主要优点是，现有的工具和 API 将继续使用集群，就像它们使用单个实例一样。Docker 的工具/CLI 和 Compose 是开发人员创建他们的应用程序的方式，因此，他们不必重新编码来适应 orchestrator。

Docker Swarm 带有几个内置的调度策略，使用户能够指导容器放置，以便最大化或最小化容器在集群中的分布。也支持随机放置。

Docker 寻求遵循“包含电池但可拆卸”的原则，这意味着尽管它目前只附带了少量简单的调度后端，但未来它可能会通过可插拔的接口支持更多的后端。基于给定用例的规模和复杂性，开发人员或操作人员可能会选择插入一个合适的替代后端。

Docker Swarm 支持约束和亲缘关系来决定容器在特定主机上的放置。约束定义了选择应该考虑调度的节点子集的要求。它们可以基于存储类型、地理位置、环境和内核版本等属性。亲缘关系定义了在主机上并置容器的要求。

为了发现每个主机上的容器，Swarm 使用可插拔的后端架构，该架构与简单的托管发现服务、静态文件、IP 列表、etcd、Consul 和 ZooKeeper 一起工作。

Swarm 支持基本的健康监控，防止在故障主机上提供容器。

### 库伯内特斯

Kubernetes 来自谷歌——一家声称每天处理 20 亿个集装箱的公司——享有独特的信誉。

Kubernetes 的架构基于一个主服务器和多个附属服务器。名为 kubecfg 的命令行工具连接到主服务器的 API 端点，以管理和编排附属服务器。下面是在 Kubernetes 环境中运行的每个组件的定义:

*   **Master** :运行 Kubernetes 管理进程的服务器，包括 API 服务、复制控制器和调度器。
*   **Minion** :运行 kubelet 服务和 Docker 引擎的主机。奴才们接受主人的命令。
*   **kube let**:Kubernetes 中的节点级管理器；它运行在一个奴才身上。
*   **Pod** :部署在同一个 minion 上的容器集合。
*   **复制控制器**:定义需要运行的箱或容器的数量。
*   **Service** :允许发现每个容器发布的服务/端口以及用于通信的外部代理的定义。
*   **Kubecfg** :与主服务器对话以管理 Kubernetes 部署的命令行界面。

JSON 文件中描述了服务定义以及规则和约束。对于服务发现，Kubernetes 提供了一个稳定的 IP 地址和 DNS 名称，对应于一组动态的 pods。当 Kubernetes pod 中运行的容器连接到这个地址时，源机器上运行的本地代理(称为 kube-proxy)将连接转发到相应的后端容器之一。

【cyclone slider id = " ebook-3-赞助商"】

Kubernetes 支持用户实现的应用健康检查。这些检查由运行在每个 minion 上的 kubelet 执行，以确保应用程序正确运行。目前，Kubernetes 支持三种类型的健康检查:

*   **HTTP 健康检查**:kube let 将调用一个 web 端点。如果响应代码在 200 到 399 之间，则认为成功。
*   **容器执行**:kube let 将在容器内执行命令。如果它返回“OK”，则认为是成功的。
*   **TCP 套接字**:kube let 将尝试打开容器的套接字并建立连接。如果建立了连接，则认为是健康的。

### 阿帕奇 Mesos

[Apache Mesos](http://mesos.apache.org/) 是一个开源集群管理器，它简化了在服务器共享池上运行任务的复杂性。Mesos 最初旨在支持高性能计算工作负载，在 0.20.0 版本中增加了对 Docker 的支持。

典型的 Mesos 集群由一个或多个运行 mesos-master 的服务器和一个运行 mesos-slave 组件的服务器集群组成。每个从模块向主模块注册以提供资源。主节点与部署的框架交互，将任务委托给从节点。以下是 Mesos 架构的概述:

*   **主守护进程**:mesos-Master 服务运行在主节点上，管理从守护进程。
*   **从守护进程**:mesos-Slave 服务运行在每个从节点上，运行属于一个框架的任务。
*   **框架**:一个应用程序定义，由一个调度器和一个或多个执行器组成，调度器向主设备注册以接收资源提供，执行器在从设备上启动任务。
*   **Offer** :从节点的资源列表。每个从节点向主节点发送要约，主节点向注册的应用框架提供要约。
*   **任务**:框架调度的要在从节点上执行的工作单元。
*   **Apache ZooKeeper** :用来协调主节点集合的软件。

与其他工具不同，Mesos 使用 Apache ZooKeeper 确保主节点的高可用性，Apache ZooKeeper 复制主节点以形成仲裁。高可用性部署至少需要三个主节点。系统中的所有节点，包括主节点和从节点，都与 ZooKeeper 通信，以确定哪个主节点是当前的主节点。主节点对所有从节点执行健康检查，并主动停用任何出现故障的从节点。

当 Mesos 与 Marathon 结合使用时，可以基于 HAProxy TCP/HTTP 负载平衡器启用服务发现，以及使用 Marathon 的 REST API 定期重新生成 HAProxy 配置文件的辅助脚本。或者，Mesos-DNS，一种基于 DNS 的服务发现机制，最近已经发布了测试版。

## 摘要

集装箱生态系统正在迅速发展。从大型基础设施公司到 PaaS 供应商，再到早期创业公司，甚至在无服务器计算领域，每个人都在叫嚣着要在生态系统中占有一席之地。有许多致力于容器编排工具的贡献者，因为这些工具对于部署现实世界的应用程序是必不可少的，从而推动了 Docker 和容器的采用。我们试图强调构建流程编排工具的一些关键贡献者，但这不仅仅是显式流程编排工具，还必须了解构建、部署、CI/CD、PaaS 以及流程编排者与之交互的其他工具，我们将在自动化和流程编排目录中详细介绍这些工具。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>