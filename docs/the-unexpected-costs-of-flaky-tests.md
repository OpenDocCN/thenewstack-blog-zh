# 古怪测试的意外成本

> 原文：<https://thenewstack.io/the-unexpected-costs-of-flaky-tests/>

[](https://www.linkedin.com/in/serkanozal/)

 [塞尔坎·奥扎尔

塞尔坎是桑德拉的联合创始人兼首席技术官。他在软件开发方面有 10 多年的专业经验，是 AWS 认证专家，拥有分布式环境专利。他主要从事无服务器架构、分布式系统和监控工具方面的工作。](https://www.linkedin.com/in/serkanozal/) [](https://www.linkedin.com/in/serkanozal/)

随着云计算和无服务器技术的发展，大多数系统都是分布式的，对于那些主要产品是软件的公司来说，易剥落会成为一个主要的问题。更重要的是，一个组织的系统越大，他们越有可能以更加古怪的测试告终。

那么，为什么古怪的测试会对开发过程造成如此大的威胁呢？不可靠的测试会使整个测试套件变得不可靠，从而导致各种各样的技术和商业问题。如果您不能区分代码中的错误、在慢速网络上运行，或者配置的测试超时，您的团队将会失去对测试套件的信任。

在之前的一篇文章中，我们谈到了[是什么导致了古怪的测试](https://thenewstack.io/how-to-deal-with-flaky-tests/)。今天，我们将探讨它们对您的团队和公司的影响。

## 理解古怪的测试

2019 年，来自苏黎世大学和 Mozilla [的一组研究人员采访并调查了](https://arxiv.org/pdf/1907.01466.pdf)100 多名开发人员，以确定古怪测试的后果。

由此产生的论文“理解易变的测试:开发人员的视角”也探究了易变的测试对开发和测试团队的原因和影响。在要求开发人员根据根本原因对古怪的测试进行分类时，研究人员发现了 11 种类型:

1.  **并发性:**在多线程软件中，当线程依赖于数据的隐式排序，但竞争条件发生时。
2.  **Async await:** 当系统启动异步任务，但没有等待它们完成。
3.  **限制范围太大:**测试定义了有效输出的范围，但实际输出超出了该范围，但仍然是有效结果。
4.  **测试顺序依赖:**一个测试的结果依赖于在它之前运行的测试。
5.  **测试用例超时:**测试的规模随着时间增长，但是超时没有增加。
6.  **资源泄漏:**内存没有被正确释放，在某些情况下会溢出。
7.  平台依赖:测试依赖于特定于平台的行为。例如在一个操作系统上产生确定性结果而在另一个操作系统上产生不确定性结果的任务。
8.  **浮点精度:**浮点溢出或下溢未被考虑，但却是测试结果的重要部分。
9.  **测试套件超时:**与测试用例超时相反，在这种情况下，没有单个测试对剥落负责；但是测试的集合会导致整个测试套件超时。
10.  **Time:** 这里的测试依赖于本地系统时钟，并且变得不稳定。例如，当比较不同时区的两个时间戳时，可能会发生这种情况。
11.  **随机性:**有时候测试用例需要实际的随机性，但是开发人员忘记了检查边缘用例。

### 为了出货更快，片状测试被忽略

开发人员的重点通常是为他们的软件增加新的功能。新的和改进的功能导致客户的获取，反过来，金钱。编写测试和修复 bug 中的质量保证(QA)通常被认为是为了发布新特性而不得不忍受的烦恼。

如果开发人员没有动力认真对待 QA，他们可能会走捷径，最终导致问题。这可以包括——但不限于——忽略不可靠的测试，简单地重新运行测试套件，直到得到他们想要的结果。

如果不考虑这些测试问题就添加更多的特性，问题就会越积越多。更古怪的测试需要更多的测试套件的重新运行，这反过来会减缓每个新特性的发布。在最糟糕的情况下，您将最终得到如此多的古怪测试，以至于无论您运行多少次，测试套件都不会再成功。此时，持续集成将嘎然而止。

这个停顿事件是最坏的可能结果。您现在最需要摆脱那些易出问题的测试，而且数量也最多。

如果你刚刚开始一个新的测试套件，首先有一些指导方针可以帮助你[避免不可靠的测试](https://engineering.salesforce.com/flaky-tests-and-how-to-avoid-them-25b84b756f60)。

### 古怪的测试增加了成本并减缓了开发

在“理解易变的测试”中，作者报告说“根据 92 个开发人员(77%)的意见，易变的测试是耗时的，因为重现测试失败是不容易的，并且不总是保证可能的。”

为了让一个不可靠的测试工作而不需要修复它，开发人员需要多次执行测试套件。这是一个简单但耗时的解决方法。另一种选择是挖掘问题并尝试修复根本原因，这需要时间*和*经验，不是每个开发人员都有。

该研究的作者指出，“由于不可靠的测试经常与其他测试交织在一起，它们需要一定水平的知识才能修复它们，因此，间歇性的测试可能会导致可用资源分配方面的问题。”

简而言之，修复一个不稳定测试的根本原因会让一个熟练的开发人员在一段未知的时间内(可能会延长)不再构建新的特性。

### 古怪的测试会破坏信任

片状测试产生的最大问题之一是，不一致的测试结果会让开发人员对其有效性失去信心。根据“理解不可靠的测试”，大多数开发人员报告说他们不认为测试结果是可靠的。“因此，”该论文指出，“开发人员开始不太信任测试输出，因此，可能开始忽视它，潜在地导致忽略实际的失败。”

失败的随机性会导致任何团队怀疑他们测试的价值。毕竟，测试无论如何都被视为额外的工作；编写功能代码和测试代码可以使开发工作量增加一倍以上。如果这项额外的工作没有回报，没有人会有动力去做。

如果这些测试被忽视，公司就失去了质量保证的一个关键部分。如果不检查他们的实现，即使是开发人员也不能再相信他们的代码。这导致手动测试花费更多的时间，因为如果出现问题，他们不想承担责任。如果开发人员没有适当地投资于他们的手工测试，软件的质量将会受损——同时，其他团队对开发人员产品的信任也会受损。团队之间没有信任，你的公司文化就会被侵蚀。

但是整个链条也可以反过来。开发人员经常看到修复测试的需要，但是没有时间这样做。他们要求上级为质量保证分配更多的资源，但决策者心中只有新功能。在这种情况下，开发人员对他们的经理做正确的事情失去信心。

## 结论

众所周知，古怪的测试很难修复，并且会束缚你最好的开发人员，否则他们会创造出最好的特性。当一个团队因修复测试而不堪重负时，他们就没有时间构建新的组件了。这是一个双输的情况，你的公司使用更多的资源来发布特性，但仍然会因为软件不稳定而失去潜在的客户。

最后，如果测试被忽视太久，它会侵蚀你对公司的信任。在这个破坏性的链条中，开发人员不再信任测试，其他团队不再信任开发人员，开发人员对他们的工作感觉很糟糕，即使他们正在额外工作来解决问题。最后，你的开发者甚至会考虑换公司，以走出这个恶性循环。通过从一开始就修正不可靠的测试，你将能够在事情失去控制之前纠正方向。

有了桑德拉助手，开发人员可以通过设置断点来确定他们的测试是否可靠，断点允许他们用非侵入式调试来排除测试故障。[今天就从桑德拉开始吧。](https://www.thundra.io/sidekick)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>