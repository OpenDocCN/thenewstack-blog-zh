# 另一天，另一个 Log4j 漏洞

> 原文：<https://thenewstack.io/another-day-another-log4j-vulnerability/>

[丹·洛伦克](https://www.linkedin.com/in/danlorenc)，开源安全供应链公司 [Chainguard](https://chainguard.dev/) 的创始人兼首席执行官，在我说，“ [Log4Shell](https://thenewstack.io/log4shell-we-are-in-so-much-trouble/) 可能，毫不夸张地说，是我们这一代最糟糕的 IT 安全问题”之后，他开玩笑地用一个辛普森迷因来回答，“T8]你迄今为止生活中最糟糕的一天”。”

然后，我看到了这个: [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) ，一个新的 Log4j 漏洞，就没那么好笑了。

首先，好消息。这个安全问题没有原来的那么糟糕。第一件事会让你在接下来的几周甚至几个月里夜不能寐。不相信我？看着吧，孩子们。

## **从何而来**

这个新问题的出现是因为尽管解决了 CVE 的问题，Log4Shell 的修复工作做得很好，但做得还不够。因此，修正版本 [Apache Log4j 2.15.0](https://logging.apache.org/log4j/2.x/security.html) “在某些非默认配置中是不完整的。”

这并不好，但 CVSS 评分为 3.7，中度严重，这比 Log4Shell 的 10 分制灾难评级好得多。

没错，“这可能允许攻击者…使用 JNDI [Java 命名和目录接口]查找模式来创建恶意输入数据，从而导致拒绝服务(DOS)攻击。”但该漏洞仅适用于某些非默认配置。具体来说，如果日志记录配置使用带有上下文查找(例如＄＄{ CTX:loginId })或[线程上下文映射模式](https://logging.apache.org/log4j/2.x/manual/thread-context.html) (%X、%mdc 或%mdc)的非默认模式布局来创建恶意输入数据，那么攻击者就可以控制线程上下文映射(MDC)输入数据。

## 抓住你了！但是不要担心，有解决办法

所以这还不算太糟。但是有一个问题。以前的 Log4Shell 缓解措施(如将系统属性`log4j2.noFormatMsgLookup`设置为`true`)无法缓解这一特定漏洞。所以，如果你一直这样做是为了避免 Log4Shell，你可能还是会有麻烦。

幸运的是，Apache 基金会的开发者已经发布了一个针对这个新问题的修复程序， [Log4j 2.16.0](https://lists.apache.org/thread/d6v4r6nosxysyq9rvnr779336yf0woz4) 。默认情况下，此修补程序删除了对邮件查找模式的支持，并禁用了 JNDI 功能。在早期的(< 2.16.0) Log4Shell 版本中，您仍然可以通过从类路径中删除 JndiLookup 类来缓解这个问题。例如:

`zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`

## **禁用 JNDI 查找**

这是否让你认为部分修复只是禁用 JNDI 查找功能？如果是的话，恭喜你，你是对的。正如开发人员所说，“最安全的做法是将 Log4j 升级到安全版本，或者从 log4j-core jar 中删除 JndiLookup 类。”

苹果软件工程师兼 Apache 基金会日志服务副总裁 Matt Sicker 在邮件列表中进一步解释道:“Log4j 团队认为默认启用 [JNDI 会给我们的用户带来不必要的风险。](https://lists.apache.org/thread/t72msv9cpxw9q5zw8rfkhx52v24z57f1)“此外，“在未受保护的上下文中使用 JNDI 是一个很大的安全风险，应该在这个库和所有其他使用 JNDI 的 Java 库中同样对待。”嗯，鉴于我们所看到的，你不能否认这一点！因此，从此版本开始，默认情况下禁用 JNDI。

这很好，但我也看到，首先，许多程序将需要重写，以处理不再有 JNDI 访问。第二，我想知道在其他 Java 库中可能还隐藏着哪些对 JNDI 的非保密访问。

但后者是以后的事了。现在，如果你不介意的话，我要去[下载并更新所有东西到 Log4j 2.16.0](https://logging.apache.org/log4j/2.x/download.html) 。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>