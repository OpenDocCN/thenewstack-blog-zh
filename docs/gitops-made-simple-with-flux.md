# 用通量简化 GitOps

> 原文：<https://thenewstack.io/gitops-made-simple-with-flux/>

[](https://www.linkedin.com/in/steve-landry-tene-78373738/?originalSubdomain=ca)

 [史蒂夫·兰德里·泰内

史蒂夫·兰德里·泰内是 Container Solutions 的一名原生云工程师。Steve 住在蒙特利尔，是一名 DevOps 爱好者，他热衷于分布式架构、重构遗留代码和所有使事情一键部署的工具。](https://www.linkedin.com/in/steve-landry-tene-78373738/?originalSubdomain=ca) [](https://www.linkedin.com/in/steve-landry-tene-78373738/?originalSubdomain=ca)

持续交付是持续集成的自然延伸，也是云原生组织中部署流程的关键部分。如果处理得当，CI/CD 可以简化几种环境中的代码部署。然而，我们仍然需要首先将代码放在那里。在 CI/CD 中，我们倾向于接受这样一种思想，即对于普遍可用的代码，应该将其推送到版本控制系统或部署环境，

但是如果我告诉你你可以拉而不是推呢？

这就是通量发挥作用的地方。Kubernetes 的 GitOps 运营商 Flux 可以让这一切成为可能。但首先，介绍一下背景。

## 推拉

在软件设计中，识别组件的职责是一个主要的关注点。这很重要，因为从中我们可以推断和确定这些组件之间的交互，每个组件如何实现目标，以及整个编排如何在可持续系统中进行。

当我们设计软件时，我们使用多种模式和原则，其中之一涉及到责任。当对某件事负责时，你唯一关心的是做你被要求做的事，并且做得很好。那个焦点决定了你的行动或行为。

在发送方和接收方之间的关系中，发送方负责通过通道发送的内容的完整性，而接收方负责对该输入进行处理。然后，我们可以很容易地将这种想法转换为推送器和拉出器之间的关系，其中推送器负责提供数据，拉出器负责对数据进行操作。

## 这在 GitOps 中是如何工作的？

GitOps 为开发人员提供了一种使用 Git 管理运营工作流的方法，尤其是针对 Kubernetes。在 GitOps 中推送代码可以分为四个关键概念:

*   您在 Git 中声明性地描述了系统的整个期望状态。
*   能描述的都可以自动化。
*   你推的是代码，不是容器。
*   [拉取请求操作](https://www.weave.works/blog/gitops-operations-by-pull-request)。批准的更改可以自动应用到系统中。

使用 Git，您可以对您对基础设施所做的所有更改进行版本控制。然后，在失败的情况下，您可以轻松地回滚到先前的工作版本。使用“拉”请求来管理对基础设施的这些更改，您可以快速检测到重大更改，并防止它们被应用。

在 GitOps 中，我们有一个 pusher(开发人员/ops ),其职责是将更改推送到一个版本控制存储库中，该存储库包含应用于一组清单的所有更改。我们还有一个拉出器(操作者)，它的唯一职责是拉出那些更改，并确保集群状态等于期望的状态。

当在如此复杂的流程中工作时，以这种方式分离职责有助于使我们的整个工作流程更高效、更易维护、更易扩展。

## 助焊剂的作用是什么？

> “操作符是在 Kubernetes 之上构建应用程序和驱动应用程序的一种方式，位于 Kubernetes APIs 之后。”
> —Sebastien Pahl，红帽公司工程总监

[Flux](https://www.weave.works/oss/flux/) ，正如我们之前提到的，是 Kubernetes 的 GitOps 运营商。因为它是一个操作员，所以它直接在集群中运行，并且通过基于角色的访问控制(RBAC)与一组权限相关联。这使得 Flux 能够直接查询 API 服务器以在集群上运行。

在由 Git 管理的基础设施中，Flux 连接到您的 Git 存储库，并监视特定分支和文件夹上的所有更改。当提交发生时，Flux 将在集群上操作，以便部署这些更改。

使用 Flux 意味着，为了在环境中部署新的或更改的代码，不需要在存储库管道中触发授予集群访问权限的外部工具或脚本。

相反，我们将必要的更改应用到 Git 存储库中，这些更改从 Git 中提取出来，然后复制到集群上。

所以每次我有一个新的容器时，我会在 Git 中更新这些文件，并且这些改变会被复制？

是也不是。

如果更新只与使用的容器有关，您可以让 Flux 直接为您完成这项工作。如果您愿意，它可以观察容器存储库的变化，并自动将其推送到您的环境中。不仅如此，它还可以用这个新映像更新 Git 存储库中的文件，并提交更改。

这不是很美吗？

但是，还是要注意:在这种情况下，有些事情可以自动化，有些事情不能。通常，您的清单中会发生变化的是容器图像。所以使用类似于 [Kustomize](https://kustomize.io/) 的工具，你可以将你的清单分成多个部分。将它们分为可以通过 Flux(资源)更新的和需要通过补丁手动干预的。

## 欢迎来到(集群)联盟

Flux 的另一个好处是集群联合，这一点令人印象深刻。我们知道设置集群联合或者同时在多个集群中复制更改是很棘手的。使用这个工具，可以在每个集群上部署一个 Flux 操作符，所有操作符都监视同一个 Git 存储库。无论何时做出更改，它都将在您的集群中复制。

不仅如此，你还可以将 Flux 与先进的 Kubernetes 递送运营商 [Flagger](https://www.weave.works/oss/flagger/) 结合使用，以自动化金丝雀部署和流量转移的推广。

准备开始了吗？这里是[关于通量](https://docs.fluxcd.io/en/latest/index.html)的完整文档。

Flux 整合到 GitOps 工作流程中，简化了 CI/CD，并支持连续交付容器图像。同时，Git 版本控制确保部署是可复制的、可审计的，并且在必要时是可恢复的。对于小公司来说，使用 Flux 是创建可持续交付过程的快速胜利，在这个过程中，您的团队可以自信地像创建代码一样快速地部署代码。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>