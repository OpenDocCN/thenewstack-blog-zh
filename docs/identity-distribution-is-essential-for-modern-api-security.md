# 身份分发对于现代 API 安全性至关重要

> 原文：<https://thenewstack.io/identity-distribution-is-essential-for-modern-api-security/>

在今天的 API 背后，让许多服务处理一个请求是很常见的。单一应用程序直接在互联网上公开并负责处理整个 API 请求的日子已经一去不复返了。现在，流程通常更加复杂——请求通过负载平衡器到达 API 网关，然后被转发到负责具体端点的服务。为了处理请求，该服务通常会调用其他数据源或服务，这些数据源或服务可能会调用更多的服务，以此类推。

正如您所看到的，许多通信都发生在现代软件服务网络内部。但是为了遵守零信任标准，公司必须适当地保护所有这些请求的通信。因为在这个基于云的服务和不断增加的漏洞的新时代，仅在外围实施安全策略已经不够了。

服务必须接收足够的信息，以便在网格内部实现适当的安全解决方案。这以身份数据的形式来执行授权决策。有了这些数据，服务就可以知道谁在请求什么，以及请求是代表谁发出的。然而，这带来了身份分发试图解决的一系列新问题。

## 什么是身份分布？

身份分发有助于确保在包含 API 的复杂服务网络中，每一方都安全地处理请求并执行明智的授权决策。它能够持续验证身份数据，而不仅仅是在外围。

但是，身份必须安全地分布在所有系统组件中。此外，不建议根据请求头或请求体中设置的普通值执行授权。相反，应该使用签名的令牌或证书来完成这项任务，因为它们提供了验证数据真实性的方法。

## 这不仅仅是对用户进行认证

当考虑请求中的身份信息时，人们会立即想到发起请求的经过身份验证的用户。然而，身份分发不仅仅是关于用户的。接收请求的服务应该验证请求的来源。它应该验证最初发送请求的外部应用程序，并使用允许的调用方列表。该服务还应该能够通过能够限制各方之间不必要的通信的机制来验证直接的内部调用者，比如 API 网关或转发请求的另一个服务。

## 减轻 API 安全风险

在分发用户的身份时，首先想到的可能是一个简单的解决方案:在外围获取用户的凭证(如会话 ID 或访问令牌),并将其传递给所有其他服务。

然而，这种解决方案引入了两个问题。首先，它违反了最小特权原则。假设您将原始凭证传递给所有服务。在这种情况下，这意味着处理请求的每个服务都拥有原始调用者(前端应用程序)拥有的所有权限。如果您的组织内部有一个流氓操作者，这可能会造成安全漏洞。如果您的服务之一将特权令牌发送给外部服务，也可能会产生漏洞。

第二个问题是原始凭证可能包含关于某个实体(如用户)的重要信息。有些信息可能是敏感的，不应该与各方共享，尤其是当单个请求跨越组织边界时。

这两个问题可以用下面的例子来说明。假设在电子商务系统的结账交易中，访问令牌包含用户的敏感支付信息，如信用评级，或者具有处理支付的权限。然后，令牌用于调用库存服务来验证是否所有订购的产品都可用。现在，股票服务有了一个令牌，允许它代表用户进行支付。它也有不应该接触到的敏感信息。所有这些都可以通过使用适当的身份分配技术来避免。

## 身份分配是一个组织问题

身份分发的安全优势取决于所使用的技术选择和实现。最终，这一切都是关于令牌或证书被传递，并根据既定的算法进行验证。授权决策是使用软件工具做出的，如授权管理系统或验证令牌的代码。然而，身份分配的问题绝不是纯粹的技术问题——它是一个组织问题。

组织应该花时间决定哪些服务应该获得哪些身份数据，以正确处理授权决策。您必须知道用户的哪些信息可以安全地跨越组织边界。这将决定数据如何出现在令牌中，以及何时应该交换令牌。例如，一些服务需要用户的社会安全号来适当地授权一个请求，因此令牌将包含它作为一个声明。然而，这是一条敏感的信息，任何不需要它的服务都应该接收没有此声明的令牌。

一方面，您会希望验证关于用户或客户端的哪些信息可以安全地与哪些服务共享。另一方面，您需要具体地确定这些服务需要哪些信息来执行完全知情的授权决策。

## 身份分配技术

不同的技巧和技术可以帮助您正确地实现身份分发。一旦您知道了哪些信息应该与凭证一起传递，以及哪些方应该接收这些信息，您就可以考虑以下解决方案，以便在您的服务网格中充分地分配身份。

### 保护所有流量

如今，传输层安全性(TLS)在互联网上几乎无处不在。当从应用程序向 API 发送包含凭证(令牌或会话)的请求时，这是一个好方法，也是必须的。然而，在外围端接 TLS 仍然很常见。负载平衡器或 API 网关通常会收到一个加密的请求，但随后会通过普通的 HTTP 连接以不加密的方式转发它。这并不被认为是最佳实践——TLS 应该端到端使用，甚至是在您的网格中的服务之间。这允许您的服务控制哪些其他服务正在调用它们，帮助您锁定基础设施。

### 锁定基础设施

在网格中的所有服务之间使用加密连接允许您对该通信进行控制。通过 mutual TLS(MTL)和像 SPIFFE 或 Kubernetes ingress 设置这样的框架，可以确保服务只被特定的服务调用。这甚至可以取代其他形式的传统使用的凭证。例如，服务可以使用 mTLS 而不是硬编码的密码对数据库进行身份验证。mTLS 还可以保护位于不同集群或数据中心的服务之间的流量。这种保护不会取代业务级别的授权，但在创建安全的服务网格中起着重要的作用。

### 使用公认的标准

服务需要一种安全可靠地获取身份数据的方式来做出授权决策。这些数据可以以多种形式交付，但是建议使用已建立的标准。OAuth 和 JSON Web 令牌(jwt)是久经考验的标准的例子，非常适合这个目的。公司应确保发行符合 OAuth 流程和[安全最佳实践](https://datatracker.ietf.org/doc/id/draft-ietf-oauth-security-topics)的令牌，而不是开发定制的解决方案。如果按照[当前最佳实践](https://curity.io/resources/learn/jwt-best-practices/)使用，jwt 在服务间分发身份数据是非常可靠的。

### 基于声明的授权

OWASP 在其 [API 安全漏洞排名](https://owasp.org/www-project-api-security/)中将破坏授权列为头号 API 漏洞。这突出了身份分发对于将正确的身份数据交付给正确的服务是多么重要，以便它们能够执行正确的授权决策。服务应该使用[基于声明的授权](https://curity.io/resources/learn/the-api-security-maturity-model/)，而不是依赖 API 键或范围，因为它为复杂授权提供了最佳解决方案。使用声明允许服务轻松地将授权外部化到[授权管理系统](https://curity.io/resources/learn/entitlement-management-system/)，如开放策略代理(OPA)。

### 作为隐私增强的不透明令牌

为了更好地保护访问令牌中的身份数据，建议使用不透明令牌。与 jwt 不同，不透明令牌不会向前端应用程序或窃听者透露任何信息。当令牌被颁发给第三方应用程序时，这一点尤其重要，因为您的组织无法控制令牌会发生什么。但是，使用 jwt 对于服务来说更方便。作为自包含的令牌，jwt 不需要接收者不断地查询中央服务来检查令牌的有效性或读取相关的身份信息。为了充分利用这两个世界，公司应该考虑实现[幻影令牌](https://curity.io/resources/learn/phantom-token-pattern/)方法，在这种方法中，不透明令牌在您的基础设施外部使用，而相关的 JWT 分布在您的服务网格内部。

### 使用令牌共享技术

处理单个请求时调用其他服务的服务应该确保沿着链传递正确的令牌。在某些情况下，共享原始服务收到的相同令牌是可以接受的。当服务在概念上接近时，这可能是有意义的。但是对于其他人来说，原始服务应该发送一个包含尽可能少的细节的令牌。它应该有足够的细节来执行授权决策，并遵守最小特权原则。这可以通过以下[令牌共享技术](https://curity.io/resources/learn/token-sharing/)来实现:

*   嵌入标记，使原始标记包含其他信息较少的标记。
*   交换令牌，原始服务将令牌交换为另一个仅包含相关信息的令牌。

## 结论

API 需要身份数据来执行授权决策。在现代服务网格中，这些数据必须是分布式的，以便请求处理中涉及的所有各方都可以保持相同的安全级别。实现适当的身份分发技术对于保证 API 和用户数据的安全至关重要。请记住，应该根据您的组织来设计身份分发，并且只有在必要时才应该在服务之间共享数据和凭证。这将防止 it 面临不必要的风险。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>