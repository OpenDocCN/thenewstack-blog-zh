# 通过服务网格将零信任安全应用于 Kubernetes

> 原文：<https://thenewstack.io/applying-zero-trust-security-to-kubernetes-via-service-mesh/>

今年早些时候，白宫发布了一项关于改善国家网络安全的行政命令，为联邦机构创建零信任架构奠定了基础。

 [阿什尔·赛义德

Ashher 是 HashiCorp 的产品营销负责人，工作地点在德克萨斯州的奥斯汀。当他不在追逐他的四个孩子时，他正在探索基于云的技术能够为现代化的组织带来什么样的可能性。](https://www.linkedin.com/in/ashher/) 

美国国家安全局(NSA)和网络安全与基础设施安全局还联合发布了一份 [Kubernetes 强化指南](https://media.defense.gov/2021/Aug/03/2002820425/-1/-1/0/CTR_Kubernetes_Hardening_Guidance_1.1_20220315.PDF)，该指南强调了 Kubernetes 中关键[零信任安全](https://thenewstack.io/what-is-zero-trust-security/)原则的最佳实践。

这些文档强调，组织和开发人员需要重新思考保护其应用程序和基础设施的方式。考虑到安全需求如何随着云基础设施的采用而变化，理解如何在您的运行时、云、平台，尤其是 Kubernetes 集群中应用这些原则是非常必要的。

NSA 指南推荐的一个关键方法是在 Kubernetes 环境中使用服务网格来授权、认证和加密服务对服务的通信。让我们仔细看看开源服务网格如何帮助加强您的安全状况并促进零信任网络。

## 零信任安全

在我们开始讨论零信任方法如何应用于 Kubernetes 之前，我们需要一些关于零信任原则的背景知识，以及为什么它们变得越来越重要。

跨多个云和内部数据中心保护基础架构、数据和访问变得越来越复杂和困难。随着组织转向多云和混合基础架构，他们用来保护其私有数据中心的措施开始变得过时。基于 IP 的身份和基于边界的访问不再适用于瞬息万变的 IP 地址和不断变化的(通常是远程的)需要持续访问共享资源的工作人员。

这种转变需要一种不同的安全方法，这种方法不信任任何东西，甚至不信任您自己的服务和用户，而是在允许访问之前对所有东西进行身份验证和授权。至关重要的是，走向零信任不是二元的；这是一种持续的方法，需要从根本上改变您的架构。幸运的是，这三个最佳实践零信任原则可以帮助指明方向:

1.  **提供基于身份的服务到服务的访问和通信:**服务应该基于服务身份。授权应该使用服务标识，而不是 IP 地址。和服务应该在建立连接时相互验证它们的身份。
2.  **包括机密和证书管理以及强化的 Kubernetes 加密:**机密应该加密，有时间限制，并且能够与全球服务身份一起工作，从而在传输中实现数据加密。访问凭据应该有时间限制，要求用户或应用程序在规定的时间间隔刷新其凭据。
3.  **通过审计和日志记录实现可观察性:**所有的访问尝试都应该被审计和记录。

## 将零信任原则应用于 Kubernetes

既然我们已经认识到基于网络边界的安全性在动态环境中是不够的，我们就需要减少对网络边界控制的依赖。组织可以采取什么步骤在 Kubernetes 环境中实现零信任原则？

### 1.提供基于身份的服务对服务的访问和通信

每个 Kubernetes 集群都提供了一个平面网络，其中每个容器或服务都可以不受任何限制地与另一个容器或服务进行对话。Kubernetes 认为容器网络或在其上运行的应用程序是可信的，不需要身份验证。例如，如果数据库服务和日志服务运行在同一个 Kubernetes 集群上，默认情况下，它们可以在网络级别上相互访问。

用户可以在 Kubernetes 中创建策略，应用默认规则来拒绝集群中的入站和出站流量。但是，即使有这些限制，您仍然需要服务到服务的身份验证和授权，以确保只有所需的资源可供服务使用。

您可以通过引入一个[服务网格](https://thenewstack.io/category/service-mesh/)来解决这个问题，它允许您为 Kubernetes 集群上运行的每个服务分配服务身份。基于服务身份，网格可以使用 mTLS 来认证服务身份，并且可以使用[意图](https://learn.hashicorp.com/tutorials/consul/service-mesh-zero-trust-network#intentions)来授权或阻止服务访问请求，这允许运营商通过服务名称来定义服务到服务的通信许可。有了服务网格，只有当两个服务可以相互验证它们的凭证时，日志记录服务才能访问数据库服务。

### 2.包括秘密和证书管理以及加固的 Kubernetes 加密

将凭证用于 Kubernetes 控制平面，无论是用于身份识别还是用于管理机密，都会扩大攻击面，难以维护，并且不符合上面列出的原则。Kubernetes secrets 在零信任安全架构中有几个弱点:

*   默认情况下，机密是 base-64 编码，而不是加密。
*   因为秘密不会过期(它们没有时间限制)，所以它们会让你面临风险。
*   Kubernetes 只能在集群边界内管理资源，比如机密。如果有多组集群，则必须分别管理多个集群中使用的资源。

带有秘密代理的服务网格可以解决这个问题。例如，Kubernetes 上的 Consul 与 HashiCorp 的 T2 金库进行了整合，这是一种集中的秘密管理解决方案，可以弥补 Kubernetes 秘密中的漏洞。

目标是通过集中的访问控制和审计来确保静态加密机密。工作流应该支持单个 Kubernetes 集群和联合多集群部署。此外，证书自动轮换可以帮助运营商降低其 TLS 证书的生存时间(TTL)值，从而增强其安全性。

### 3.通过审计和日志记录实现可观察性

为了提高 Kubernetes 的安全性，了解集群内部发生了什么以查看发出了什么服务访问请求是很重要的。审计日志允许审计小组检查事件数据，以查看使用了哪些凭证、发生了什么操作以及与这些事务相关联的时间戳。这为安全团队提供了更好的洞察力和责任感。

服务网格部署能够发出集群中运行的每个服务的度量的 sidecar 代理，并保存所有服务对服务通信和访问请求的记录。理想情况下，服务网将[与开源监控工具如 Prometheus 和 Grafana 集成，从而更容易分析服务网络模式并增强安全性。](https://learn.hashicorp.com/tutorials/consul/kubernetes-layer7-observability)

## 结论

随着服务部署环境变得越来越复杂，包括多个 Kubernetes 集群、多个运行时、多云和本地部署，以及它们之间的各种互连，遵循零信任安全原则就变得非常必要。

像 HashiCorp Consul 这样的服务网格是这一过程的重要组成部分，它提供了一个管理层，通过提供基于身份的服务网络来相互验证和授权任何访问，从而实施零信任原则。Consul 可以轻松地在 Kubernetes 和多个环境中实施细粒度的安全策略，而无需将所有安全参数编码到应用程序本身中，从而快速、易于管理地实现零信任安全状态。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>