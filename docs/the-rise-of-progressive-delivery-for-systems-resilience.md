# 系统弹性渐进交付的兴起

> 原文：<https://thenewstack.io/the-rise-of-progressive-delivery-for-systems-resilience/>

在复杂的分布式系统世界中，是什么将精英表演者与其他人区分开来？这些是一直在展开的，但没有断裂的。这些是 Netflixes 和 Expedias，它们成功地在一天内完成了数千次部署，没有用户中断。他们有什么共同点？

少数人和骄傲的人有一些共同的做法，他们工作得很快，但仍然没有停止工作。每个公司都有自己的混乱、金丝雀和彩色代码测试的组合，以防止他们的连续交付影响客户体验。

RedMonk 的创始人 James Governor 向[今年的 QCon 伦敦观众](https://qconlondon.com/london2019/presentation/progressive-delivery)提供了一个新的总括术语来描述这种面向系统弹性的创造性实验:渐进交付。

今天，我们深入探讨渐进式交付的含义，谁已经掌握了它，以及如何使其适应您的业务。

## 渐进交付:渐进交付新价值

渐进式交付是在您将测试、自动化负载测试和部署转移到 DevOps 和 CI/CD(持续交付/部署和集成)之后的下一步，甚至理想情况下它是这一旅程的一部分。

Governor 说 CI/CD 是现代软件开发中一切好东西的源头，但他认为早期先驱的一些相关学科没有得到应有的重视。有了复杂的[服务路由](https://en.m.wikipedia.org/wiki/Routing)，采用试验优先的方法变得更加容易，如 canarying、蓝/绿部署和 A/B 测试，这些方法可以减缓新服务推出的连锁反应。

渐进式交付在更广泛地部署之前将流量路由到特定的用户子集，因此在生产中进行测试不一定会有巨大的风险。

对于 Governor 来说，渐进式交付实际上是一种渐进式实验，它会一直传播到整个用户群，而不会——或者希望不会——降低用户体验。

> “渐进式投放是对爆炸半径进行精细控制的连续投放。”——詹姆斯总督，雷德蒙克

他继续说，渐进式交付的组成部分是:

*   用户细分
*   交通管理
*   可观察性
*   自动化

它不是急于持续交付，而是后退一小步，以提高更广泛版本的质量的方式向更小部分的用户发布。

CloudBees 的首席软件工程师卡洛斯·桑切斯(Carlos Sanchez)将渐进式交付描述为持续交付之后的下一步，“新版本被部署到一部分用户，并在向全体用户推广之前对其正确性和性能进行评估”，或者在未能满足关键指标时进行回滚。

[Expedia](https://m.subbu.org/incidents-trends-from-the-trenches-e2f8497d52ed)的 Subbu Allamaraju 最近的一项研究显示，他们大约三分之二的停机发生在事情发生变化的时候。那么，如何只针对一小部分人进行测试呢？

以下趋势属于渐进式交付的范畴:

*   金丝雀测试* —这是当你向少量用户发布变更时，这意味着如果你发布一个 bug，只有一小部分用户受到影响。
*   [蓝绿色部署](https://martinfowler.com/bliki/BlueGreenDeployment.html) —就像一个方向舵，你开始将新的或更新的服务推出到一个生产环境，然后从一个转移到另一个。这两个环境尽可能保持一致，但是一次只有一个是活动的，这允许您在生产环境中测试，但是如果出现问题，可以快速回滚到另一个环境。
*   A/B 测试——一项高中科学实验遇到了市场营销，你在用户界面上对两组不同的数据测试一个变量，然后看看哪一组表现更好。这有助于测试一个变化对可用性的影响，任何可能影响你转换的东西。
*   [功能切换](https://martinfowler.com/articles/feature-toggles.html) —也称为功能标志，功能切换允许您在运行时隐藏、启用或禁用较小的功能，在用户界面中隐藏(“切换”)。
*   [服务网格](https://www.nginx.com/blog/what-is-a-service-mesh/) —服务网格可以放置在容器和服务之间，它会记住最后一次工作的内容，这有助于在失败时重试调用或恢复到最后一次可用的响应。它允许您将新功能金丝雀路由到特定的用户群，并执行[故障转移](https://searchstorage.techtarget.com/definition/failover)，能够通过高级服务路由和流量转移来编排服务。
*   可观察性(Observability)—Governor 表示，可观察性结合了跟踪、日志记录和指标，这使得开发人员可以构建新的服务，并对如何在生产中管理它们有一个清晰的认识。他以 [Honeycomb](https://www.honeycomb.io/) 为例，展示了一家公司在系统轮询、指标和问题解决方面的技术水平。
*   [混沌工程](https://thenewstack.io/chaos-engineering-can-give-distributed-systems-stability/)——这是一门拥抱失败的艺术，通过定义你的分布式系统的正常状态，然后通过经验阻力测试把厨房的水槽扔进去。

流量跟踪也可以归入这组操作，但是这种出于测试目的将生产中的所有内容异步复制到非生产服务中的行为实际上并不存在于生产中。

## 什么是现实世界中的渐进式交付？

所有这些方法都可以在不同的组合中应用，它们都理解部署不同于发布。

> "部署一项服务并不等同于为所有用户激活它."——詹姆斯总督，雷德蒙克

他举了康卡斯特的例子，该公司拥有 30，000 名客户服务代理。该公司不一定希望推出一项影响每一位代理商的变革，因为这将影响数百万客户。他们可能更愿意提供一些培训，同时一点一点地推出变化。

从这个意义上说，渐进式交付是关于业务和技术的结合。

“它一直是我们业务中阻止客户获得新服务的支柱，但这种情况正在开始改变。我从小就认为它是企业的刹车，它阻止企业采取行动，但在高绩效的组织中，现在它可能不再是刹车，而是企业的现实，”总督解释说。

DevOps 让我们走得更快，但我们需要找到一种方法，在我们的流程中安装新的制动器或至少放慢速度，最好由现在负责部署自己代码的开发人员进行调整。

“大多数人不喜欢应用程序的变化。如果谷歌改变了 Gmail 界面，我们当然不喜欢，但他们让我们按照自己的节奏选择，”他说，可能指的是我们最近都收到的收件箱提醒。

像这样带有一致提醒的较慢的推出更成功，也更容易被大多数用户接受。

他提醒观众，“连续交付对企业来说绝对是可怕的”，指出“[在生产中调试](https://thenewstack.io/honeycombs-charity-majors-go-ahead-test-in-production/)的想法听起来很疯狂。

金丝雀测试、A/B 测试和蓝绿色部署仍然允许在生产中进行测试和调试，但影响的用户群要小得多。

总督指出，这是亚马逊网络服务在全球 16 个自治区拥有 42 个可用区域背后的逻辑。从一开始，AWS 就在这些区域周围建立了严格的界限，以鼓励划分，这样它们就可以支持高水平的可用性，区域之间互为备份。

他说你实际上想要[防火带](https://en.wikipedia.org/wiki/Firebreak)——这种隔离允许一切仍然快速但更稳定地移动。

### 你的实验组由哪些用户组成？

不同的公司将决定谁先推出哪些服务。像所有的实验一样，它根据你自己的因素和用户而变化。

[](https://twitter.com/bkurtic)[Sumo Logic](https://www.sumologic.com/lp/log-analytics-for-your-entire-application-stack/)machine data analytics 的副总裁 Bruno Kurtic 选择先[金丝雀 5%的用户](https://redmonk.com/jgovernor/2019/02/25/progressive-delivery-at-sumo-logic/)，然后利用日志来了解系统和用户对这种变化的反应。他们还在生产中运行影子测试。

Kurtic 在 RedMonk 博客上解释道:

*例如，我们有许多机器学习技术，我们将其作为能力向客户公开。客户可能会抱怨我们的模式识别不起作用。但是我们怎么知道如果我们为其他客户改变算法，不会破坏他们的体验呢？我们可以悄悄地旋转两个集群，测试这个算法的性能。我们对推出的每项服务进行候选人测试。我们如何测试它？我们有一个 Sumo 逻辑的影子副本，用于测试、行业法规等。*

[Cloudflare](https://www.cloudflare.com/en-gb/) Web 性能和安全应用了一群狗、金丝雀和猪。狗是你想要善待的忠诚的宠物顾客，永远不要推出任何可能会先坏了的东西。它们活跃在奥斯陆和慕尼黑等中等规模的科技友好型城市。他们把所有有风险的变化都推给那些用偷来的信用卡注册账户的猪。

[GrubHub](https://get.grubhub.com/legal/restaurant-pos-api-terms) 食品配送服务选择先在较小的城市运行金丝雀部署。这可能是因为这些小城市不仅交通流量少，而且竞争对手也少。

这将因公司和工具的不同而有所不同。当你决定谁和什么时候的时候，只要记住时区和活动高峰之类的事情。

当然，你必须决定对你的用户来说什么是真正的破坏。最常用的危险信号是[谷歌的黄金信号](https://landing.google.com/sre/sre-book/chapters/monitoring-distributed-systems/):

*   等待时间:处理一个请求所需的时间
*   流量:包括每秒的 HTTP 请求
*   错误:失败请求的比率
*   饱和度:负载测量

Governor 提到了以下工具来帮助执行渐进式交付，并特别注意这些黄金信号:

*   [weaver works](https://www.weave.works/):Kubernetes 运营商，使用路由作为交通转移工具，自动推广金丝雀部署
*   帮助人们理解集群中的错误模式
*   Petri:A/B 测试和特性切换的实验
*   [快速启动](https://launchdarkly.com/):用于“功能管理”，根据用户角色自动切换功能

州长说，从您的事件响应中学习是逐步交付的关键。这是企业世界观的必要组成部分。

> “我们很难理解变革管理的心理学，也很难帮助人们理解采用某种方法的价值。”——詹姆斯总督，雷德蒙克

这就是为什么渐进式交付是关于将用户体验与开发人员体验结合起来，并确保整个组织理解这是对业务最好的。

**作者注:我认为“金丝雀测试”这个术语——以一种会死在矿井中以发出有毒气体信号的亮黄色鸟类命名——是一个过时且不必要的残酷术语，它让一些用户听起来像是可以接受的伤亡。我建议我们称之为“截线法”,这是对战略性泼溅绘画的一种艺术隐喻。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>