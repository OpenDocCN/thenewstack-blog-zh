# 保护 Kubernetes 运行时监控的 5 个最佳实践

> 原文：<https://thenewstack.io/5-best-practices-for-securing-kubernetes-runtime-monitoring/>

[](https://www.linkedin.com/in/juliensobrier/)

[Julien Sobrier](https://www.linkedin.com/in/juliensobrier/)

[Julien Sobrier 是领先的云安全平台 Lacework 负责 Kubernetes 安全产品的高级产品经理。Julien 在 Lacework、Netscreen/Juniper、Zscaler 和 Salesforce Octarine 担任了 15 年以上的安全研究员和产品经理。他通过 O'Reilly 合著了 Power Security Tools，并在 OWASP、SOURCE、Les Assises de la Securite 和其他会议上发表了演讲。](https://www.linkedin.com/in/juliensobrier/)

[](https://www.linkedin.com/in/juliensobrier/)[](https://www.linkedin.com/in/juliensobrier/)

为了保护他们的 [Kubernetes](https://thenewstack.io/category/kubernetes/) 和[容器环境](https://thenewstack.io/category/containers/)，组织通常优先考虑预部署或“构建时间”配置，以确保工作负载使用最少的权限，实施良好的安全策略并利用最低权限的 Kubernetes 基于角色的访问控制(RBAC)。目标是最小化 Kubernetes 的攻击面、威胁横向移动的能力以及任何缺口的大小。

但是公司不能简单地希望他们的构建时配置是 100%安全的。他们还需要“运行时”可见性，以了解他们正在运行的 Kubernetes 集群和容器配置可能如何偏离其初始状态，并确定正在进行哪些手动更改。

更重要的是，组织需要运行时检测来及时检测 K8s 和容器环境所有层的网络威胁、漏洞利用和错误配置。此外，运行时日志记录、监控和检测对于遵守 SOC 2、NIST 800-53、针对 Kubernetes 的 CIS 基准测试、PCI DSS 和 ISO 27001 等法规和框架至关重要。

根据 [Red Hat 2021 年 Kubernetes 安全状况报告](https://www.redhat.com/rhdc/managed-files/cl-state-kubernetes-security-report-ebook-f29117-202106-en.pdf):“几乎所有人(94%的受访者)都承认在过去的 12 个月中经历了一次安全事件……相当大一部分人还发现了一个重大漏洞，经历了一次运行时事件，或者未能通过审核。当受访者在生产环境中部署了他们的 Kubernetes 工作负载时，这些发现变得更加重要。”

这里是 Kubernetes 运行时监控和检测的五个安全最佳实践。

## **1。监控网络连接**

绘制和监控所有网络连接至关重要，包括内部(东西)和外部(南北)连接。这有助于理解 Kubernetes 工作负载和名称空间如何相互交互，以及正在访问哪些外部资源(例如，云服务、外部 API)。这显示了 Kubernetes 集群的整个足迹，可用于威胁检测和满足要求映射所有内部和外部网络流量的合规性要求。

了解正常网络流量的情况有助于运行时监控解决方案检测异常行为，例如导致东西向流量错误增加的操作问题，或者提供商阻止的对外部 API 的过多调用。环境中的威胁也可能导致网络连接异常。威胁的一个例子可能是恶意容器或被入侵的应用程序执行网络或端口扫描来发现环境或攻击其他内部 Kubernetes 或云服务(横向移动)。

监控对任何已知恶意 IP 和域的访问作为危害迹象(IoC)非常重要。许多针对 Kubernetes 的攻击导致 cryptominer 软件被安装在容器中。网络连接将显示与新 IP 和域的连接，通常被认为是恶意的，以下载 cryptominer 二进制文件，连接到加密池，并将信息发送回攻击者。

攻击者还可以探测环境以利用错误配置，例如，非生产集群访问敏感的生产服务，如数据库或保管库，或者发送到公共端点的纯文本 HTTP 流量。

Kubernetes 没有提供任何现成的工具来显示网络连接。有效的监控网络安全工具应该显示来自节点和每个工作负载的连接，参考它们的完整身份(即命名空间、工作负载名称、pod 名称)而不是内部 IP 地址。

## **2。监控入口端点**

许多 DevOps 团队最关心的问题之一是意外地将内部服务暴露给互联网。很容易在 Kubernetes 中添加一个外部负载平衡器或入口，并无意中暴露一个缺少公共端点所需的正确身份验证和授权的服务。这种情况最近发生在一家大型汽车制造商身上，当时他们的 Kubernetes 仪表板意外暴露在互联网上，让攻击者通过 web 界面创建和推出新的 pod。

任何外部负载平衡器、入口控制器、节点端口等的添加。应该被记录和验证。还应首先建立从公共 IP 到工作负载的连接，以确保不会发生意外暴露。网络图可用于确定是否有任何公共服务可以直接访问敏感资源，如专用 AWS S3 存储桶、内部数据库或保险库。

## **3。监控 Kubernetes 审计日志**

Kubernetes 的最佳实践之一是保持容器不变，并在部署之前使用基础设施作为代码(IaC)来定义您的环境。这意味着应该尽量减少手工活动，比如登录到容器(kubectl exec)。禁止的活动应包括手动删除资源或更改 Kubernetes RBAC(角色、集群角色、角色绑定等)等操作。).

仅通过查看 Kubernetes 集群配置很难发现手动更改，也不可能将其与用户联系起来。解决方案是启用 Kubernetes 审计日志，也称为 Kubernetes 控制平面日志，记录所有 Kubernetes API 调用，包括用户活动和自动化工作流。但是这些圆木很吵。每天会生成数百万条日志，大部分是针对正常的内部活动。

您需要一种解决方案，能够从这些噪音中提取出有趣的事件，并指出不寻常的活动，例如:

*   容器登录方法，如 kubectl exec、kubectl attach 和 kubectl log
*   一个容器的网络暴露，它可以绕过任何 Kubernetes 网络策略，比如 kubectl 端口转发
*   对角色、角色绑定、集群角色或集群角色绑定的任何更改或添加
*   手动更改容器映像，包括安装软件包和库

在审计日志之外，很难跟踪对 RBAC 的更改。典型的 Kubernetes 设置有 20 多个默认角色和 75 个集群角色。几乎不可能发现这些现有角色的变化，或者任何无意或恶意的绑定。保留这些变更的审计线索以便以后验证它们要容易得多。

Kubernetes 审计日志还显示了由于缺少身份验证、缺少权限或其他类型的配置而导致的 API 调用失败。这将检测操作问题和安全问题。

## **4。监控新 Kubernetes 组件和工作负载的部署**

许多已知的 Kubernetes 漏洞导致流氓容器(通常是 cryptominers)被部署在被入侵的环境中。这些攻击几个月后才被发现，这表明在数千个恶意 pod 中找出一个是多么困难。攻击者可以简单地使用一个模糊熟悉的名字而不被发现。

大多数基于配置的安全解决方案，如 Pod 安全策略或开放策略代理(OPA)网关守护设备，可检测工作负载使用的不安全属性:特权、以根用户身份运行、不安全功能等。在 Kubernetes 中不使用这些特权访问的流氓容器将不会被检测到。

工作负载运行时监控需要更深入。它必须能够检测正在使用的新注册中心，甚至是新的注册中心(尤其是像 Docker Hub 和 Quay 这样的公共注册中心)。它应该检测由新用户创建的工作负载，而不是大多数公司实施的连续部署(CD)工作流。这还将检测可能未通过常规持续集成(CI)工作流验证的工作负载、容器或集群的带外部署，从而可能绕过应用程序生命周期早期实施的安全检查。

## **5。使用基于机器学习的自动化威胁检测**

让我们假设前面的最佳实践已经实现，并且您正在收集跨所有层监控运行时环境所需的所有事件:K8s、容器和工作负载。最后一个最佳实践是利用基于机器的自动化威胁检测来检测隐藏在所有层生成的事件海洋中的未知或高级威胁。

这项技术首先监控 Kubernetes 和容器环境中的活动，以确定什么是“正常”的，并建立基准这包括监控围绕应用程序、API、文件、进程、用户、网络等的活动，以了解什么是“正常”事件，如一段时间内与特定 IP 的一致连接、运行状况检查、pod 重启和工作负载重新计划。第二，异常检测识别偏离基线的异常偏差，并代表未知威胁。这种异常活动的例子在前面的章节中已经介绍过了。如果没有基于机器学习的检测，手动检测规则将会遗漏未知威胁，并生成过多的误报警报，使安全团队不堪重负。

异常检测的另一个好处是，它可以检测利用零日漏洞(如利用 [Log4j 漏洞](https://nvd.nist.gov/vuln/detail/CVE-2021-44228))导致的威胁行为。在通过 Log4j 成功利用远程代码执行(RCE)漏洞的情况下，监控网络连接将显示到新 IP 或域的连接，其中一些可能是已知的恶意连接，以回叫总部、泄漏数据或获取恶意内容。零日漏洞的另一个例子是 CRI-O 的容器运行时引擎中最近的[“Cr 8 escape”漏洞](https://nvd.nist.gov/vuln/detail/CVE-2022-0811)，该漏洞允许威胁逃离容器，在整个集群中移动，并执行恶意活动。异常检测将对这种利用行为发出警报。

## **全面保护您的环境**

虽然 Kubernetes 和容器环境的正确配置在部署前很重要，但在运行时对环境的全面监控和保护同样重要。为此，您应该遵循多种最佳实践，以确保在整个环境中获得全面的运行时保护。

![KubeCon EU 2022](img/3a946f86447e1f058ffa27e8553342db.png)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>