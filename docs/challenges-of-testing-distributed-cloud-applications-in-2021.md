# 2021 年测试分布式云应用的挑战

> 原文：<https://thenewstack.io/challenges-of-testing-distributed-cloud-applications-in-2021/>

[](https://www.linkedin.com/in/serkanozal/)

 [塞尔坎·奥扎尔

塞尔坎是桑德拉的联合创始人兼首席技术官。他在软件开发方面有 10 多年的专业经验，是 AWS 认证专家，拥有分布式环境专利。他主要从事无服务器架构、分布式系统和监控工具方面的工作。](https://www.linkedin.com/in/serkanozal/) [](https://www.linkedin.com/in/serkanozal/)

在过去的二十年里，软件开发走过了漫长的道路。只有消费者和企业的需求超过了硬件和软件的发展。结果，软件系统的复杂性直线上升。

虽然仍然有可能在本地环境中开发和测试某些类型的应用程序，但通常不会这样做。由许多不同移动部件组成的复杂系统很难甚至不可能在本地运行。这使得本地开发和测试变得复杂，本地开发需要在没有整个系统可用的情况下进行，而测试需要等到完全构建的环境中的更改可用时，才能覆盖所有必要的范围。

在本文中，我们将探索与测试分布式架构相关的挑战，并讨论一些实现这一点的方法。

## 测试分布式架构的挑战

能够处理大量负载的系统可以纵向扩展或横向扩展。后者提供了更大的灵活性，可以超越单台机器的限制，但也使系统本身变得更加复杂。实现适当的性能水平，同时保持健康的可用性和容错水平，仍然是一个挑战——尤其是考虑到 CAP 定理的限制。

最终的架构通常由许多不同的组件组成，可能包括:

*   蜜蜂
*   批处理服务
*   负载平衡器
*   消息队列
*   不同类型的存储

在本地环境中设置所有这些是一项复杂的任务，如果不是不可能的话。例如，它可能需要比单个本地机器或本地不可用的云服务更多的内存。

不管分布式架构是否可以在本地建立，它的本质使它比单一系统更具挑战性。当一个请求可以遍历几个不同的组件时，就很难确定发生了什么。

此外，由于组件间通信而导致的故障可以以多种不同的方式表现出来，包括消息的重复或丢失、大脑分裂，或者由于负载平衡器后面有问题的服务子集而导致的间歇性请求失败。

## xUnit 测试:一个有限的解决方案

单元测试已经存在了一段时间，可以成为测试逻辑的有效工具。它的主要优势是自动化——这意味着单元测试可以按需运行，或者作为 CI/CD 管道的一部分，根据需要经常运行。这对于回归测试特别有用。

但是在云开发或者其他分布式系统的开发中，单元测试的好处[要少得多](https://medium.com/scopedev/why-nobody-cares-about-xunit-bba97f4be044)。虽然逻辑仍然需要正确，但在这样的系统中，性能和可靠性更加重要。这取决于组件之间的交互方式，根据定义，这超出了典型单元测试的范围。实际上，单元测试需要嘲讽云资源和第三方服务(比如支付网关)。

微服务之间的松散耦合，以及用不同编程语言编写它们的选项，意味着不同的团队可以使用他们选择的工具，而不相互依赖。

然而，这意味着工具在整个组织中是异构的——使得在不同的团队之间重新利用开发资源变得困难。由于单元测试本质上与原始代码相关，测试整个系统可能需要许多不同编程语言的知识。

## 使用 APM 对分布式应用程序进行故障排除

测试复杂的分布式系统是必要的(尽管更困难)。这确保了它们即使在重负载下也能可靠地工作，并且尽可能早地捕捉到错误，以最小化它们的影响和成本。因为很难在本地测试这样的系统，而且单元测试本身是不够的，所以更普遍的端到端测试风格是必要的。

这就产生了对可观测性解决方案的需求。在分布式系统中调试逻辑非常困难，因为它可能跨越几个不同的服务，如果在本地环境中不可能做到这一点，就更难了。因此，许多公司求助于应用程序性能监控(APM)解决方案来了解不同服务的运行状况以及它们之间的交互。

APM 工具可以有效地可视化系统中不同组件的连接方式。它们还可以提供关于单个服务的见解，例如它们是否启动并运行、一段时间内返回的错误数量以及它们在任何给定时间经历的负载。

另一方面，APM 工具需要大量投资。除了运行中央 APM 服务的任何许可和服务器成本，APM 解决方案本身往往非常复杂。对于较大的组织来说，让专门的人员来开发这样的系统并不少见。

## 微服务测试方法

当所涉及的组件之间以松散耦合的方式构建时，开发、测试和维护分布式系统的复杂性会有所减轻。这是六边形和微服务架构的核心，具有许多优势:

*   **单一责任原则(SRP):** 服务可以专注于做好一件事，将其他关注点委托给其他服务。
*   **可维护性:**如果服务不与其他不相关的逻辑纠缠在一起，那么独立地维护和发展服务会容易得多。
*   **可重用性:**围绕可插拔组件的设计意味着它们可以在新的或不断增长的服务中被重用。
*   **可替换性:**与可重用性一样，可替换性意味着具有不同功能但相同接口的组件可以根据需要轻松替换。在微服务的情况下，整个服务可以被重写而不破坏架构。
*   **可测试性:**与面向对象编程中的类一样，具有明确定义的输入和输出的服务易于测试，无论是单独测试还是作为更大整体的一部分测试。

以一种可测试和可维护的方式设计软件是重要的，但是光靠它本身是不够的。在不能在本地托管的分布式架构上运行端到端测试需要设置环境来支持它们。

做到这一点的一种方法是创建额外的环境，并随着测试的进行，逐渐地在整个环境中促进软件变更。托管和维护这些环境需要大量额外的成本和工作。

通过 CI/CD 实现自动化部署，以及在较低的环境中使用较小的和/或预定的资源来最大限度地降低成本，可以缓解部分问题。然而，后者意味着环境不同；因此，测试并不能提供完全的信心，尤其是在表现方面。

另一种方法是直接在生产中测试。虽然这比测试和生产环境之间完全隔离的风险更大，但是可以通过为测试创建租户并以不同于真实的方式指导测试请求流来降低这种风险。这意味着测试仍然是受控的，并且在某种程度上是隔离的。

能够在真实的生产环境中快速部署变更并获得关于变更的即时反馈是一种敏捷性提升，这本身就超过了风险，更不用说不创建所有这些额外环境所节省的成本和精力了。

## 使用桑德拉助手进行云调试

无论您的环境如何设置，调试分布式应用程序仍然是一个困难且耗时的过程。它需要分布式跟踪，即了解一个请求如何通过不同的服务以及在此过程中发生了什么，并且由于一些问题在非生产环境中可能不容易重现这一事实而变得更加复杂。

所有这些都因为了收集更多关于根本原因的信息而对生产环境进行更改的风险和繁琐而变得更加复杂。

幸运的是，[桑德拉的助手](http://www.thundra.io/sidekick)让这个过程变得简单多了。通过设置不间断跟踪点，您可以有效地调试生产中的流程，而不会阻塞服务和影响客户或下游服务。跟踪点在被命中时捕获上下文(包括变量)，提供对应用程序状态的洞察，这有助于确定问题的原因以及如何解决问题。

桑德拉 Sidekick 通过 IntelliJ IDEA 插件与您的 IDE 集成，允许您在熟悉的编程环境中进行生产调试。最重要的是，您可以使用它来[将一个修补程序](https://www.youtube.com/watch?v=3aOjnEam09Y)直接部署到云环境中，快速确保在您通过正常的 CI/CD 流程推出它之前，该修补程序确实有效。

*通过微服务的远程调试提高开发人员的工作效率。[开始使用桑德拉助手](https://www.thundra.io/sidekick?utm_source=newstack&utm_medium=paid&utm_campaign=Thundra%20Blog)。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>