# 监测 StatsD 的 3 个挑战以及如何应对这些挑战

> 原文：<https://thenewstack.io/3-challenges-to-monitoring-statsd-and-how-to-tackle-them/>

贾斯汀·德弗兰克

贾斯汀是 Circonus 的一名销售工程师。他从事软件工作已经七年了，在销售工程和产品管理方面都担任过职务。他持有经过认证的 Kubernetes 管理员证书，对大规模分布式系统充满热情。

[StatsD](https://github.com/statsd/statsd) 是一个关键的统一协议和工具集，用于收集应用指标和了解应用性能。Etsy 在 2011 年创建了 StatsD，作为发布应用程序指标的协议。不久之后，StatsD 服务器被开发为一种工具，用于接收 StatsD 线路协议指标并随后汇总这些指标。虽然没有官方后端作为 StatsD 生态系统的一部分，但是 [Graphite](https://graphite.readthedocs.io/en/stable/) 成为了最常用的。StatsD 迅速普及，如今已成为监控基础设施的重要组成部分。

尽管年代久远，遗留的 StatsD 管道仍然非常适合应用程序监控目的，只要您能够跟上数据量和提交频率，并且有一个长期存储数据的好地方。对于刚开始分析应用遥测数据的小型企业来说，这可能更现实。然而，随着组织扩展他们的应用程序并引入新的应用程序团队，他们的 StatsD 度量负载开始快速增加。当这种情况发生时，他们的 StatsD 监控解决方案不可避免地变得太脆弱，无法处理他们的应用程序现在发出的各种 StatsD 指标，带来了不准确、性能问题和成本等挑战。

许多组织正在探索传统 StatsD 管道的替代方案，以应对其中的一些挑战。从开源到托管产品，有多种解决方案可供选择。什么适合您取决于这些挑战中哪一个对您的组织影响最大，以及您的组织正在努力实现的特定监控目标。下面列出了这些挑战、陷阱以及您可能需要考虑的解决方案类型。即使您还没有遇到重大挑战，这些也能让您深入了解如何提高 StatsD 监控的规模和有效性。

## **1。计算 SLO 时，预聚合会妨碍灵活性**

**挑战:** StatsD 内置了由 StatsD 守护进程执行的计时器聚合函数，包括计数、最小值、最大值、中值、标准偏差、总和、平方和、百分位数(p90)等。但是大多数 StatsD 服务器只提供静态聚合，您必须预先进行配置。例如，如果您想要度量值的第 97 个百分位数，您必须知道您需要第 97 个百分位数，并从一开始就进行配置，否则您将面临没有所需数据的风险。

**陷阱:**显然，这些信息很难预先猜测，这最终会妨碍团队动态分析延迟或按需计算服务级别目标(SLO)的能力。经理可能希望看到 p85 或 p80，但他们最接近的可能是 p90。此外，各种团队都必须使用相同的 SLO，因为他们被迫共享相同的预先计算的聚合。

**解决方案:**如果您的组织希望实施 SLOs 和“测量一切”等 SRE/DevOps 原则，那么使用对数线性直方图进行 StatsD 聚合。直方图使您能够高效且经济地存储所有原始数据，因此您可以在摄取后即时执行 StatsD 聚合并构建百分位数。因为直方图包含所有数据，所以不需要预先配置。这种灵活性使您的站点可靠性工程(SRE)团队能够为现有和未来的用例动态地设置和测量他们自己的 SLO。

## **2。规模的增加导致性能问题和高运营开销**

**挑战:**自 2011 年以来，发生了很多变化。组织正在采用 Kubernetes、微服务和无状态应用。这意味着他们正在发布更多的 StatsD 指标。此外，StatsD 服务器聚合在大规模使用时会带来许多挑战，包括大量未使用的聚合的预计算，可能有数百万个。在某些情况下，对于一个给定的应用程序计时器指标，会生成 20 个以上的聚合指标，因此，对于您想要收集的每个指标，从表面上看，一个原始指标会变成 10 个或 20 个不同的单独指标。这耗费了大量的计算能力，所有这些数据都必须刷新到后端。

除此之外，您还必须管理 StatsD 服务器的多个原子实现，因为相同的指标必须继续发送到相同的服务器，以确保聚合正确，同时还要管理中继以将流量复制到多个服务器和后端以实现冗余。随着指标基数的增加，许多后端无法按照要求进行扩展，管理这些 StatsD 管道的运营负担非常沉重。

**陷阱:**无法按需扩展不可避免地会导致性能问题、缺乏可见性和故障排除时间增加。日益复杂的体系结构导致更多的网络拥塞、更多的资源和更高的成本。

**解决方案:**如果您的公司正在投资 Kubernetes 和微服务，快速增长或产生大量的 StatsD 指标，那么您需要投资一个更现代的后端数据库，一个可以轻松处理当今应用程序产生的大量指标的数据库。它还应该自动化冗余，以减轻团队的负担。您应该能够在不牺牲性能的情况下按需扩展，并自信地提供出色的用户体验。

虽然不是确保规模和性能所必需的，但对数线性直方图也能为您带来好处。因为直方图可以以低成本压缩和存储所有源数据多年，所以它们消除了多个 StatsD 服务器执行聚合的需要。他们将所有数据压缩到一个直方图中，然后在一个事务中将所有数据发送到您的后端，而不是多个事务。总体而言，与预聚合相比，您显著减少了接收和存储的指标数量(减少了 10 到 20 倍)，并降低了网络带宽和相关成本。

## **3。无数据关联=更长的 MTTR**

**挑战:**向某些服务器/后端组合发送 StatsD 指标不支持 line 协议中的标记。现代 IT 环境是动态和短暂的，这使得标记对于监控服务和基础设施至关重要。

**陷阱:**如果没有标记，监控当今复杂的 IT 基础设施将变得无效。您缺乏对可视化和警报指标进行切片和切块、快速识别和解决问题或跨业务部门关联见解的能力。

**解决方案:**如果您希望通过获得更深入的见解和关联见解来提高监控的复杂性，使监控能够推动更多业务价值，那么您需要一种支持 StatsD 遥测的 Metrics 2.0 标记的监控解决方案。Metrics 2.0 要求使用与正在收集的指标相关的元数据或上下文来标记指标，例如应用程序版本。额外的上下文和元数据使跨不同维度的分析变得更加容易，并极大地改进了在数百万个独特指标中的洞察发现过程。您可以基于这些标签进行搜索，还可以识别特定的服务以进行更深入的分析。通过标记，您可以关联数据并发出警报，因此您可以更快地确定问题的原因，并收集有关您的操作和性能的更多整体信息。

## **提高 StatsD 监控的易用性、规模和灵活性**

许多 StatsD 管道无法处理当今应用发出的大量数据，导致监控 StatsD 指标时出现不准确和限制。根据您的业务、监控目标和对您的组织影响最大的 StatsD 挑战，您可能需要评估其他解决方案，以便提高 StatsD 监控的易用性和灵活性，并从您生成的所有有洞察力的数据中获得更多价值。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>