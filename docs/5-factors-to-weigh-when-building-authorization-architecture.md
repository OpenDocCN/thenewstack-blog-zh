# 构建授权架构时要考虑的 5 个因素

> 原文：<https://thenewstack.io/5-factors-to-weigh-when-building-authorization-architecture/>

当构建一个新的软件应用程序时，权限层不是你通常会关注的东西。你的主要目标是尽可能快地达到产品与市场的契合，所以你要专注于提供核心商业价值，其他事情都要退居其次。

在 [Cerbos，](https://cerbos.dev/?utm_content=inline-mention)的整个团队中，我们有幸曾在各行各业的公司工作过，包括电子商务、广告和供应链等等，我们开发的每一个产品都要求我们考虑不同的用户如何获得资源，以及他们可以采取什么行动。

解决这个问题的每一次尝试都是痛苦的，需要我们的路线图花费几个月的时间来构建和维护一个满足客户需求的访问控制系统。

这是任何软件即服务(SaaS)公司——也许是你的公司——在开始产品创造之旅时将面临的障碍的故事，这需要关于[授权](https://thenewstack.io/how-do-authentication-and-authorization-differ/)的新思维。继续读下去，看看我们学到了什么，让自己省点头疼的事。

## 1.我们对他们

一开始，您可以依赖一个简单的用户和管理员模型。如果你有一个@【ourcompany.com】的电子邮件地址，你就可以访问任何东西。这是开始构建核心产品最简单的方法。我们的许多用户开始授予对他们软件的广泛访问权，而我们专注于开发像权限这样的基础设施元素。

如果你正在销售 B2B SaaS，很可能会有一个只读用户的早期请求。这将让团队成员在不造成任何损害的情况下看到正在发生的事情——这似乎是可以很容易地添加到代码中的事情:所以当出现 GET 以外的 HTTP 动词时，需要进行更多的检查。

百分之九十九的时候，你会从这里开始。角色很简单。生活是美好的，你可以构建核心特性集。但是，事情开始进展顺利，发展迅速，突然之间，您的代码库变成了一个庞然大物——分散、复杂和脆弱的业务授权逻辑遍布代码库。

**需求:**比标准的角色集合更灵活。

## 2.特征门控

随着您继续在核心产品的基础上开发新功能，您可能会收到销售团队提出的修改定价或包装的请求。与年轻的公司相比，更成熟的公司希望能够灵活地从供应商那里购买软件，并要求更多的定制。

作为产品经理，您需要根据为每个客户设计的不同合同来决定哪个客户获得新功能。

这引发了一个有趣的问题，因为现在你可以:

*   与一组产品签订传统合同的客户群。
*   另一批用户使用不同产品的最新合同。
*   处于限时试用或概念验证阶段的客户，他们需要一些但不是全部的访问权限。
*   一个超级重要的企业客户，他有一个定制合同，允许他们访问通常的产品集，外加一个额外的东西，这个东西本来是“交易破坏者”

用代码而不是策略来模拟所有这些不同的访问类型几乎是不可能的。然而，使用存储所有不同访问的数据库来做一些聪明的事情是可能的，但是你只是花费了宝贵的工程时间来构建基础设施，而不是产品。另一场重新包装运动可能即将到来。

**添加新需求:**请求时间上下文以做出许可决定，例如用户分配的包限制。

## 3.走向全球

当[欧盟/美国安全港协议](https://www.ftc.gov/business-guidance/privacy-security/us-eu-safe-harbor-framework)失败时，跨大西洋的数据共享环境发生了重大变化，然后欧盟的[通用数据保护法规(GDPR)](https://gdpr.eu/) 落地，紧接着是[加州消费者隐私法案(CCAP)](https://oag.ca.gov/privacy/ccpa) ，许多类似的法规正在世界各地的法院中运作。

现在需要在系统的核心许可层处理这些限制，以确保数据被隔离。现在的访问取决于我们的员工和客户所在的位置。

这需要根据用户的位置和客户选择存储数据的地区，在每个交互点增加逻辑访问检查。这种变化几乎触及了堆栈中的每个系统

**和另一个需求:**除了他们的角色之外，关于用户的丰富信息，例如位置，以便做出决策。

## 4.向企业扩展

随着您的成功，您将不可避免地想要赢得一些更大的企业客户。这意味着要应对一系列全新的授权挑战。当与跨国企业合作时，特别是最初与 it 的一个部门合作时，在您的权限中反映组织结构很快成为一个难点。

出现了新的需求，例如:

*   用户应该只能访问其部门和地理区域内的资源和数据。
*   伦敦办公室的经理应该能够访问其他英国办公室的所有内容
*   全球的部门主管应该能够在所有地区做任何事情。
*   公司副总裁希望看到一切，但并不真正知道事情是如何运作的，所以他们应该只有查看权限。
*   巴黎办公室的 Sally 是我们的超级明星员工，她偶尔也为美国团队工作，所以如果是满月，她应该可以在每个第三个星期二访问他们的帐户(这里可能有点夸张)。

根据我们的经验，为了支持我们最新的客户，我们不得不花费几个疯狂的白板会议来为每个任务制定访问控制逻辑，并围绕现有的代码库进行黑客攻击。经过一些妥协，我们提出了一个可以接受的解决方案——但是现在代码库看起来更像一碗意大利面条。

**还有一个要求:**基于客户组织结构的动态权限。

## 5.认证和审计

为了赢得企业客户，合规性障碍变得更高，团队的负担也变得更大。为每个客户减少大量重复合规工作的一个方法是获得[ISO 27001 证书、](https://thenewstack.io/authorization-in-the-context-of-soc-2-and-other-certifications/)管理信息安全的国际标准。这需要一些步骤，包括文件和审计。

经历这一过程的一个特别的记忆是，我们的内部委员会将我们召集到一个会议室，与一位目光坚定的审计师会面，我们必须向他展示产品如何:

*   不同客户的有限数据访问。
*   针对不同用户类型的强制访问控制。
*   除非需要，否则我们的内部团队只能有限地访问客户数据。
*   拥有出于支持原因访问客户环境的流程。
*   使客户能够管理自己的权限
*   提供对授权或可疑访问的任何更改的审计跟踪

鉴于我们项目的范围，我们必须分配许多资源来覆盖所有这些领域——整个产品团队至少需要三个月的时间。这让我们偏离了我们的核心产品。

**还有一个需求:**粒度审计和细粒度访问控制，以满足合规性标准。

## 从第一天起就可扩展

在帮助客户的过程中，我们遇到了各种各样的障碍——你们中的许多人肯定也遇到过——我们对授权的要求已经超越了角色，现在包括:

*   比标准的角色集更灵活
*   除了他们的角色之外，关于用户的丰富信息，例如位置，以便做出决策。
*   基于客户组织结构的动态权限
*   粒度审计和细粒度访问控制，以满足合规性标准

因此，在我们与其他公司的这些挑战斗争了太长时间后，我们终于咬紧牙关，决定做点什么，并推出了 [Cerbos](https://cerbos.dev/?utm_content=inline-mention) 。一切都是在开放环境中构建的，我们完全支持开放核心模式，因此您可以选择服务并将其放入您的基础架构中，这样您就不必面临我们曾经面临的相同问题。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>