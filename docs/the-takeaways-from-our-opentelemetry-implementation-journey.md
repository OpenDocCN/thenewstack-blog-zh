# 我们的 OpenTelemetry 实施之旅的收获

> 原文：<https://thenewstack.io/the-takeaways-from-our-opentelemetry-implementation-journey/>

人们很容易对 [OpenTelemetry](https://opentelemetry.io/) 感到兴奋，这是一个开放的可观察性框架，工程师使用它来收集几乎任何类型应用程序的日志、指标和跟踪。

 [艾米·托比

作为一名对可持续系统和以人为本的领导力充满热情的全栈工程师，Amy 将她对人类状况的兴趣和技术系统专业知识相结合，以创造安全、有效和持久的变革。](https://www.linkedin.com/in/amytobey/) 

但是当你真正开始实现它时，事情就变得棘手了。这并不是因为 OpenTelemetry 特别难以使用——在许多方面，它是一个比我们以前拥有的工具集更强大的工具集——而是因为当您的团队采用它时，很容易忽略重要的细节。

其中一些细节属于技术领域；它们与 OpenTelemetry 如何配置和操作有关。其他的就是你所谓的文化。它们涉及到你的工程师使用和思考工具的方式。

我们在 Equinix Metal 实施 OpenTelemetry 的经验为这两个类别提供了一些有价值的见解。下面，我将分享我们旅程中的一些重要收获，以及让您尽可能成功地过渡到 OpenTelemetry 的技巧。

## 技巧 1:决定为什么需要 OpenTelemetry

首先，确保你首先为为什么使用 OpenTelemetry 建立了明确的目标。

这似乎不难做到。这是一个容易爱上的框架。它是免费的。它是开源的。它与主要的可观察性工具一起工作。它不会将您锁定在供应商的代码中。这对于集成像 [Tinkerbell](https://metal.equinix.com/blog/tinkerbell-declarative-provisioning-kubernetes-bare-metal/) 这样的开源工具和框架尤其重要。

尽管如此，确保你的开放式遥测之旅是有目的的还是很重要的。不要因为别人在做就决定设置工具。具体说明你想从中得到什么。

甚至在框架达到 1.0 状态之前，我们就开始在 Equinix Metal 实现 OpenTelemetry。我们决定采用这个平台有两个原因。第一个也是最明显的是，我们没有现成的追踪解决方案，OpenTelemetry 显然是填补这一空白的一种方式。(目前，我们仅将 OpenTelemetry 用于追踪；我们使用不同的解决方案进行日志记录和指标收集。)

但第二个更深层次的目标是，我们希望成为该工具的早期采用者，这样我们就可以帮助它成长。我们相信云计算原生计算基金会(CNCF)的使命，它孵化了 OpenTelemetry。我们还认为，基于开放标准的遥测方法为我们的客户带来了巨大的希望，我们希望从一开始就帮助推动该工具得到更广泛的采用。

## 秘诀 2:不要期待一夜成名

我很想说，在实现 OpenTelemetry 的几个小时内，来自 cross Metal 的工程师们就在屋顶上叫嚣着他们惊人的新的可观测性见解。

然而，事实并非如此。我们的 [OpenTelemetry 实现故事从失败](https://metal.equinix.com/blog/opentelemetry-provisioning-observability-distributed-tracing/)开始。当我们第一次将这个框架添加到我们用来管理基础设施的 Metal API 中时，我们开始看到一些奇怪的错误。这导致我们的一些工程师反对该工具，他们不仅担心 OpenTelemetry 没有产生它应该提供的大的可观测性见解，而且担心它实际上正在创造新的可靠性挑战。

事实上，首次展示非常粗糙，以至于大约一年后我们决定禁用 OpenTelemetry。然后我们去度假(大约在我们 2021 年假期结束时)，回来时精力充沛，头脑清醒。

重置使我们能够确定 OpenTelemetry 问题的根本原因。原来是很久以前添加到 Metal API 中的设计很差的并行线程代码。OpenTelemetry 实际上并不是我们在 API 上遇到的奇怪问题的根源。它们已经发生了一段时间，但 OpenTelemetry 使它们变得更糟，因为它增加了正在运行的并行线程的数量。

一旦我们意识到这一点，解决方案就显而易见了。我们去掉了有问题的代码，然后能够泰然自若地运行 OpenTelemetry。

这里的教训是，如果你的首次展示没有带来立竿见影的成功——很可能没有——坚持下去。获得 OpenTelemetry 等新计划的认可需要时间，你可能会遇到打嗝或更糟的情况……但如果你在遇到第一个障碍时就放弃了，你将错过许多长期价值。

## 技巧 3:使用 OpenTelemetry 自动仪器

OpenTelemetry 最酷的特性之一是它的自动仪器库。您可以加载这些库，而不是编写所有自己的代码来生成跟踪，这些库进入代码库，并以一种几乎自动化的方式将插装代码包装在您的代码周围。

利用自动仪器显然是加速 OpenTelemetry 采用的一种方法。但是如果你以前没有使用过 OpenTelemetry，你可能不会想到利用这个特性。或者，你可能认为它不能很好地将你从大量的手工编码中拯救出来。(提示:会的！)

在[的这篇博客文章](https://metal.equinix.com/blog/opentelemetry-whats-a-collector-and-why-would-i-want-one/)中，我们会更详细地解释我们是如何使用自动插装的，但重点是确保你不会在不必要的时候浪费大量时间编写自己的插装代码。

## 技巧 4:创建定制的工具

上面的提示并不意味着您根本不应该调整您的插装代码。

相反，充分利用 OpenTelemetry 的定制仪器功能非常重要。定制检测意味着您可以配置您的跟踪，以提取对您的业务至关重要的特定上下文信息。

在 Metal，我们配置了定制的工具来收集与我们跟踪的请求相关的硬件规格和操作系统数据等细节。这种上下文使跟踪更有意义和可操作性。

你的背景需求会有所不同，因为你的业务不同。这就是要点:使用定制的工具来收集您需要的任何细节，以使可观测性数据对您的团队和组织尽可能有意义。

## 技巧 5:使用追踪来升级你的心智模型

用 OpenTelemetry 收集踪迹(或日志，或度量)是一回事。收集、链接和共享这些数据，以确保工程师能够真正从中受益，则是另一回事。

这就是为什么我们在处理 OpenTelemetry 提供给我们的可观察性数据时接受了“心理模型”的概念。心理模型是思考数据与被观察系统实际关系的结构化方式。

当你有好的心智模型时，你的工程师可以回答这样的问题:一个服务的踪迹如何与另一个相关？(配置[跟踪传播](https://opentelemetry.lightstep.com/core-concepts/context-propagation/)在这里也有帮助。)我看到了哪些我可能根本不会想到要收集的数据？可观察性数据如何通过提高可靠性而不是简单地对下一个事件做出反应来帮助我变得更主动？

确认你的心智模型是正确的一个好方法是让工程师向你解释痕迹。换句话说，让他们解释一个跟踪，并解释它告诉他们关于它来自的系统或服务的什么。

## 技巧 6:观察你的可观察性

最后，确保您有一个适当的流程来验证您的 OpenTelemetry 和可观测性投资是至关重要的。换句话说，你应该观察你的可观察性。

在 Metal，我们通过对遇到的每一个事件进行回顾来做到这一点。这种方法允许我们问为什么我们没有在事件变成事故之前发现它，以及我们没有收集、没有链接、没有适当地共享或者没有以我们可以拥有的方式利用哪些数据？我们能做些什么来确保它不再发生？怎么会进行得这么顺利？

让人们一起从事故中学习是现场可靠性工程师改变我们组织的最有力的工具。出色的可观察性对于帮助工程师理解事件并从中吸取教训至关重要。

## 结论

我们喜欢 open telemetry——它已经帮助我们推动了一些[有意义的用户体验改进](https://metal.equinix.com/blog/leveraging-opentelemetry-tracing-to-tune-our-rails-monolith/) —我们相信你也会喜欢它。但是不要期望将自动插装库拖放到您的 API 中并就此结束。相反，退一步，根据您团队的独特需求，制定一个如何充分利用 OpenTelemetry 的计划。例如，考虑您的定制仪器需求，以及您的工程师将如何实际应用 OpenTelemetry insights。

我们希望你们这样做，不仅因为我们关心你们，还因为我们真的相信 OpenTelemetry 为有效、主动的可靠性操作创造了机会。我们希望看到更多的团队充分利用 OpenTelemetry 即使它不是在每个关头都一帆风顺。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>