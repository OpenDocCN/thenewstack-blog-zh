# 裸机上的 Kubernetes 与虚拟机:不仅仅是性能

> 原文：<https://thenewstack.io/kubernetes-on-bare-metal-vs-vms-its-not-just-performance/>

关于在裸机和虚拟机上运行 Kubernetes 的争论过于简单。这不仅仅是在虚拟机的相对易管理性和裸机的性能优势之间进行权衡。(事实上，后者现在并不算大，我将在下面解释。)

我将试着梳理一下当时的考虑因素。正如您将看到的，虽然我倾向于相信裸机上的 Kubernetes 是大多数用例的出路，但没有简单的答案。

## 裸机上的 Kubernetes 速度更快，但只有一点点

现在，让我们来解决性能与易用性的问题。

 [安迪·霍尔茨曼

Andy 是 Equinix 的一名站点可靠性工程师，自 v1.9.3 (2018)以来一直在裸机上运行 Kubernetes。他运行了多达 55 个裸机集群的生产环境，在 Ubuntu、CentOS 和 Flatcar Linux 上协调安装了 Kubernetes，最近还帮助将 Equinix Metal 的 Kubernetes 平台的运行速度提高到每个新绿地设施不到一个小时。Andy 在 Twilio 和 SendGrid 担任高级软件工程师后加入了 Equinix。](https://www.linkedin.com/in/andrew-holtzmann) 

是的，虚拟机更易于调配和管理，至少在某些方面是如此。当您可以将节点设置为虚拟机并使用虚拟机供应商的编排工具来编排它们时，您不需要关心底层服务器硬件的细节。您还可以利用黄金映像之类的东西来[简化虚拟机供应](https://metal.equinix.com/blog/accelerating-vmware-vsphere-deployment-bare-metal/)。

另一方面，如果去掉虚拟机管理程序，就不会花费硬件资源来运行虚拟化软件或客户操作系统。您的所有物理 CPU 和内存都可以分配给业务工作负载。

但是重要的是不要夸大这种性能优势。现代虚拟机管理程序非常高效。例如，VMware [报告虚拟机管理程序开销率](https://www.vmware.com/pdf/hypervisor_performance.pdf)仅为裸机的 2%。除此之外，您还必须添加运行客户操作系统的开销成本，但虚拟机和裸机之间的原始性能差异仍然可以忽略不计，至少在您不试图从基础架构中榨取最后一点计算能力时是如此。(有些情况下，这 2%的差异是有意义的。)

总而言之，虚拟化将使您的设备的总资源可用性降低约 10%至 20%。

## 竞争的编排层

现在，让我们来看看在裸机上运行 Kubernetes 与在虚拟机上运行 Kubernetes 的所有其他考虑事项。首先，编排元素。当您将节点作为虚拟机运行时，除了编排容器之外，还需要编排这些虚拟机。因此，基于虚拟机的 Kubernetes 集群需要管理两个独立的编排层。

显然，每一层都在编排不同的东西，所以，理论上，这不会造成问题。实际上，情况往往如此。例如，假设您有一个失败的节点，而 VM 级的 orchestrator 和 Kubernetes orchestrator 都在同时尝试从失败中恢复。这可能会导致您的编排器工作目的不一致，因为 VM 编排器正在尝试建立一个崩溃的服务器，而 Kubernetes 正在尝试将 pod 移动到不同的节点。

类似地，如果 Kubernetes 报告某个节点发生了故障，但该节点是一个虚拟机，您必须弄清楚该虚拟机是真的发生了故障，还是虚拟机编排器出于某种原因将其删除了。这增加了操作的复杂性，因为您需要处理更多的变量。

裸机服务器节点上的 Kubernetes 没有这些问题。您的节点要么完全启动，要么没有，并且没有协调器争夺节点的注意力。

## 下面跑的是什么？

在裸机上运行 Kubernetes 的另一个关键优势是，您总是确切地知道在一个节点中会得到什么。您可以全面了解硬件的物理状态。例如，您可以使用像[智能](https://en.wikipedia.org/wiki/S.M.A.R.T.)这样的诊断工具来评估硬盘的健康状况。

虚拟机无法让您深入了解 Kubernetes 集群所依赖的物理基础设施。您不知道磁盘驱动器有多旧，甚至不知道物理服务器上有多少物理内存或 CPU 内核。您只知道虚拟机的虚拟资源。这使得故障排除更加困难，再次增加了操作的复杂性。

## 利用你所拥有的

出于相关原因，裸机在容量规划和合理调整方面独占鳌头。

在这方面有相当多的细微差别需要考虑。裸机和虚拟化基础架构支持不同的容量规划，并且有各种工具和策略来调整一切。

但最终，在规划裸机容量时，更容易做到完全正确。原因很简单:有了裸机，您可以使用`cgroups`以超高效、超可靠的方式管理 pod 级别的资源分配。使用像[Kubernetes vertical autoscaler](https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler)这样的工具，你可以根据每台物理服务器的总可用资源将资源分配到毫微微核。

这是虚拟机所不具备的优势。相反，您得到的容量规划要粗糙得多，因为可以分配给 pod 的资源取决于您对虚拟机的资源分配。当然，您仍然可以使用`cgroups`，但是您将在一个不知道底层服务器上存在什么资源的 VM 中这样做。它只知道它被分配了什么。

最终，您不得不扩大虚拟机的规模，以应对工作负载需求的不可预测的变化。因此，您的 pod 不能高效地使用资源，并且您的物理服务器上的大量资源可能会在大部分时间里处于闲置状态。

## 不要忘记网络

另一个影响你决定在裸机还是虚拟机上运行 Kubernetes 的因素是网络性能。这是一个复杂的话题，但本质上，裸机意味着更少的网络抽象，从而带来更好的网络性能。

为了更深入地挖掘，考虑虚拟节点，每个节点有两个独立的内核网络堆栈:一个用于虚拟机，另一个用于物理主机。有各种技术可以在两个堆栈之间协商流量(数据包封装、NAT 等)，有些技术比其他技术更有效(提示:NAT 根本没有效率)。但最终，它们都需要某种性能。它们也增加了网络管理和可观察性的复杂性。

在裸机上运行，您只需要担心一个网络堆栈，您不会浪费资源在物理机和虚拟机之间移动数据包，并且在管理或优化网络时需要整理的变量更少。

诚然，管理 Kubernetes 中存在的各种网络，这部分取决于您使用的容器网络接口(CNI ),确实会增加一些开销。但是与完全虚拟化带来的开销相比，这是微不足道的。

## 管理复杂性

正如我已经暗示的，在裸机上的 Kubernetes 和虚拟机上的 Kubernetes 之间的决定影响了管理您的集群的工程师。

简而言之，裸机在大多数方面都简化了操作，从而简化了工程师的工作。除了需要担心的层次和移动部件更少之外，裸机环境还减少了团队工作的限制。他们不必记住虚拟机只支持 X、Y 和 Z 配置，也不必担心某个特定版本的 [libvirt](https://libvirt.org/) 是否支持他们需要的功能。

相反，他们只是简单地部署操作系统和软件包，然后开始工作。当您只处理裸机时，设置集群更容易，并且长期管理运营也容易得多。

## 虚拟机上的 Kubernetes 何时有意义

让我澄清一下，我确实认为在虚拟机上运行 Kubernetes 是有意义的。

一种情况是当您设置小规模的登台环境时，性能优化不是非常重要。对于这种类型的使用情形，充分利用每一个毫微微核通常不是优先考虑的事情。

另一种情况是，您在一个已经非常依赖虚拟化基础架构或特定虚拟化供应商的组织中工作。在这种情况下，将节点作为虚拟机运行只会减少官僚主义的麻烦。或者，购买和安装裸机服务器可能存在物流方面的挑战。如果您可以在几分钟内自助服务一些虚拟机，而不是花几个月的时间来获得物理服务器，那么只要更适合您的时间表，就使用虚拟机。您的组织可能还会依赖于由一家仅在虚拟机上运行容器的云提供商提供的托管 [Kubernetes 平台](https://thenewstack.io/category/kubernetes/)。谷歌云的托管混合多云 Kubernetes 产品 Anthos 支持裸机部署，Red Hat 的 OpenShift 也是如此。AWS 的 EKS 随处裸机支持将于今年晚些时候在 T2 推出。

一般来说，你不应该让对虚拟机的依赖阻止你使用 Kubernetes。最好利用云原生技术，而不是停留在过去，因为你无法拥有最佳的基础架构。

虚拟机显然在许多 Kubernetes 集群中占有一席之地，这一点可能永远不会改变。但在性能优化、简化容量管理或降低运营复杂性等问题上，裸机上的 Kubernetes 脱颖而出。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>