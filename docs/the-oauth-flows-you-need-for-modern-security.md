# 现代安全所需的 OAuth 流

> 原文：<https://thenewstack.io/the-oauth-flows-you-need-for-modern-security/>

几年前，我为 Nordic APIs 撰写了文章“ [8 个重要的 OAuth 流程和权力](https://nordicapis.com/8-types-of-oauth-flows-and-powers/)”。

从那以后，围绕 OAuth 和 OpenID 规范发生了很多事情。有些流程已经更新，有些已经废弃，还增加了一些新的流程。有了这么多变化，现在是更新列表以匹配 OAuth 和 OpenID Connect 在 2022 年必须提供的内容的好时机。

## 有什么变化？

 [丹尼尔·林道

Daniel 是 Curity 的身份专家和专业服务技术总监。他每天都在帮助各种规模的公司设计基于标准的解决方案来管理身份、保护 API 并遵守法规。他有应用程序开发的背景，在使用 SAML、SCIM、OAuth2、OpenID Connect 和 FAPI 等标准构建解决方案方面有丰富的经验。](https://www.linkedin.com/in/daniel-lindau-8891ab24/?originalSubdomain=se) 

在过去的几年中，在开放银行领域已经做了很多工作，推动了新规范的开发。OAuth 工作组已经建立了一个安全最佳实践(BCP ),该实践概述了减少针对 OAuth 协议的已知攻击媒介的方法。例如，BCP 建议不要使用隐式 ilow 和资源所有者密码凭证(ROPC)授权。OAuth 2.1 规范更进一步，取消了隐式授权并完全删除了 ROPC。

OpenID 基金会的金融级 API (FAPI)工作组已经最终确定了许多添加新流的规范。这些配置文件规范还告诉实现者他们需要哪些部分来符合特定的安全级别。记住所有这些，让我们探索当今最相关的流程。

## 授权码授予

授权码授予，或[码流](https://curity.io/resources/learn/oauth-code-flow/)，仍然是广泛使用的 OAuth 流程。现在，BCP 建议公共客户端使用带有证明密钥的代码流进行代码交换(PKCE ),而不是隐式流，它甚至可能会被更广泛地采用。

为了使用代码流获得令牌，客户端只需将浏览器重定向到服务器，就可以向 OAuth 服务器发送授权请求。OAuth 服务器确保用户通过身份验证，并提示用户批准委托。当用户批准时，会向客户端发布一个短期代码。此代码可视为一次性密码。客户端收到这个代码，现在可以在浏览器之外的经过身份验证的后端调用中使用它，并将其交换为令牌。

这里要提到的一点是，用户只需向 OAuth 服务器输入他们的凭证。用户不必向应用程序提供凭据，他们只需将凭据输入到他们已经知道并信任的服务器。这是 OAuth 着手解决的主要问题之一。

另一个好处是令牌永远不会通过浏览器，这使得窃取变得更加困难。因为交换令牌的调用是经过身份验证的，所以服务器可以确保将令牌传递给正确的客户端。

通常，代码流还将允许您接收一个刷新令牌，这使客户端能够在不涉及用户的情况下获得新的访问令牌。这甚至可以在访问令牌过期后进行处理。

代码流最初被认为只供私有客户机使用，因为客户机在交换代码时必须验证自己。然而，情况已经发生了变化，浏览器现在支持更多的机制，如果使用 PKCE 扩展的话，可以和公共客户端一起使用。

代码流已经过大量扩展，以适应更复杂的用例，如开放银行和其他高安全性用例。[本文](https://curity.io/resources/learn/oauth-code-flow/)描述了码流协议的多种可能性。

## 代码交换的证明密钥

虽然在技术上不是一个流，[用于代码交换的证明密钥(PKCE)](https://curity.io/resources/learn/oauth-pkce/) 是在没有秘密的情况下与公共客户端一起使用代码流的密钥。PKCE 是对代码流的授权和令牌请求的扩展。

当使用 PKCE 时，客户端首先为这个流生成一个唯一的密钥。在授权请求中，它将密钥的散列值添加到一个名为 code_challenge 的参数中，并在一个单独的参数 code_challenge_method 中添加用于散列密钥的方法的名称。

流程照常继续，但是当它到达令牌请求时，客户机添加包含密钥明文值的参数 code_verifier。然后，授权服务器(AS)将使用提供的 code_challenge_method 对该值进行哈希运算，并将该值与初始请求中发送的值进行比较。如果值匹配，AS 就知道发出调用的客户端与发出授权请求的客户端是同一个客户端，并且可以颁发令牌。

PKCE 不为客户保密——它仍然是公开的。但是由于 AS 可以依赖重定向统一资源标识符(URI ),并且知道两个请求来自同一个源，因此可以使用代码流来代替隐式流。代码流具有防止重放攻击和将令牌放在 URL 之外的好处，因此它应该被视为一种安全改进。

## 推送的授权请求

代码流的另一个扩展是[推送授权请求(PAR)](https://curity.io/resources/learn/pushed-authorization-requests/) 。PAR 是开放银行社区大力推动的规范。

PAR 将代码流的授权请求移出浏览器，并使用反向通道发送请求。对此请求的响应是一个 URI，然后用于重定向到 AS，替换代码流中的所有参数。这个 POST 请求可能经过了身份验证，因此它的好处是可以提前知道客户是谁。这意味着 AS 不必仅仅依靠重定向 URI 来保证安全性，也不必为潜在的非法请求启动认证和同意过程。

在后台运行也意味着包含个人身份信息(PII)的请求在 URL 中是隐藏的。

## 客户端凭据流

在客户端凭证流中，没有用户。这个流程严格用于服务器到服务器的通信——例如，服务器必须以自己的身份访问 API。所以不涉及浏览器，需要一个私有客户端。要检索访问令牌，客户机只需将其凭证传递给 OAuth 服务器并接收令牌。

通过使用类似于[相互 TLS](https://curity.io/resources/learn/oauth-client-authentication-mutual-tls/) 或[客户端 JWT 断言](https://curity.io/resources/learn/client-assertions-jwks-uri/)的安全客户端认证方法，该流程可以达到更高的安全等级。由于客户端可以使用其凭证获得新的访问令牌，因此在此流程中不发布刷新令牌。

反省

自省是询问 OAuth 服务器令牌是否有效的过程。访问令牌通常通过引用传递，这意味着除了 OAuth 服务器之外，它们对任何人都没有任何意义。自省客户端通常是某种 API 或 API 网关。

[自省是一个简单的认证调用](https://curity.io/resources/learn/introspect-with-phantom-token/)，你发送一个令牌并接收一个包含属于令牌的数据的响应，比如到期时间和主题。自省是幻像令牌模式中的一个关键角色，它被广泛用于隐藏令牌内容，不让那些不应该被允许读取它的人看到。

## 取消

[撤销](https://curity.io/resources/learn/oauth-revoke/)是 OAuth 的一大权力。在 OAuth 之前，向应用程序提供凭据的用户无法收回同意。唯一的办法是更改密码，这可能会带来比禁止应用程序访问用户帐户更糟糕的副作用。使用 OAuth，用户可以通过撤销令牌来决定在任何时候撤回同意。OAuth 提供了两种撤销选项:

*   您可以撤销访问令牌，这可以被视为结束当前会话。如果有刷新令牌，它仍然有效。
*   撤销刷新令牌将使刷新令牌以及随之而来的任何活动访问令牌无效。

客户端在经过身份验证的调用中执行实际的撤销。即使它们已经过身份验证，公共客户端也可能被允许执行撤销。

## 动态客户注册

[动态客户端注册(DCR)](https://curity.io/resources/learn/openid-connect-understanding-dcr/) 继续在 API 平台中扮演重要角色。这在移动 AppAuth 模式中是有益的，但在开放式银行场景中也被证明是有用的。例如，在欧洲开放银行规则 PSD2 中，所有第三方都被颁发一个可信证书，以便在与相关银行通信时使用。

然后，该证书可用于注册您的客户端时进行身份验证，并在以后的选定流程中作为客户端身份验证。这使得银行更容易管理身份验证，因为他们需要配置的只是受信任的发行者——客户端将自己注册并负责自己的配置。

## 动态客户注册管理(DCRM)

开放银行业务带来了 AppAuth 模式通常没有的新需求:在注册后更改客户机的配置。由于 mTLS 被大量使用，系统必须能够更新所使用的证书。`redirect_uri`指向一个网站，而不是你的移动应用程序中的协议定义，这可能会经常改变。

对于这种情况，有一个与 DCR 类似的规范，[动态客户端注册管理(DCRM](https://curity.io/resources/learn/dynamic-client-registration-management) )。DCRM 为客户端定义了一个 API 来更新它的设置，轮换秘密，甚至删除注册。这使得维护客户端配置的负担小了很多，因为客户端自己可以维护它。

## 结论

OAuth 和 OpenID Connect 应该被认为是身份联合和访问授权的事实上的标准，但是这些标准仍然在相对快速地发展。缺失的特性在不断地被添加，需求在不断地变化，澄清也在不断地进行。因此，跟上所有的发展是一项挑战。

在 Curity，我们尽最大努力持续发布最新和更新的资源。请定期查看我们的[资源库](https://curity.io/resources/),了解新增内容。订阅 [RSS 提要](https://curity.io/feeds/)，或者使用[最新动态](https://curity.io/resources/whats-new/)页面查看最新文章。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>