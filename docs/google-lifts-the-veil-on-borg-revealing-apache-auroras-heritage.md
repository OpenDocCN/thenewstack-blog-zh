# 谷歌揭开博格的面纱，揭示阿帕奇奥罗拉的遗产

> 原文：<https://thenewstack.io/google-lifts-the-veil-on-borg-revealing-apache-auroras-heritage/>

2013 年 3 月《连线》杂志的一篇文章称其为“谷歌的秘密武器”，这篇文章表面上是关于受其启发的 Twitter 开源项目。它是(或者仅仅是“我们”)Borg，数据中心流程调度和协调系统，很明显是以印第安纳波利斯 500 锦标赛标题中的第一个名字命名的。

在谷歌之外对 Borg 的了解可以从对 Apache Aurora 的研究中收集到，这也是新栈在二月所做的[。当时，谷歌不会承认博格的存在，拒绝回应请求。](https://thenewstack.io/twitters-aurora-relates-googles-borg-part-1/)

现在，在为下周在波尔多举行的 [EuroSys 2015 会议](http://eurosys2015.labri.fr/)撰写的一篇文章中，一个由谷歌和前谷歌工程师组成的团队首次公开承认，他们使用了一个本土的任务协调系统，而不是巫术，来处理数百万个同时进行的进程。在一项令人惊讶的坦率评估中，该团队将 Borg 的架构与 Kubernetes 的架构进行了比较，Kubernetes 是目前由谷歌管理的开源容器编排系统，并得出了一些有价值的设计选择结论，如果有第二次机会，他们不会重复这些选择。

## 我们现在知道的是

Aurora 首席工程师 Bill Farner 在我们去年 2 月的报道中指出，Borg 是一个聪明的想法，但变得太复杂而难以管理，这一观点得到了谷歌团队文章的证实。以下是对其要点的总结:

*   一个博格**单元**是一组大约 10，000 台机器，作为一个单元来管理。大型单元通常是位于一栋建筑内的**机器集群**的主要居住者，有时是唯一的居住者。
*   共享依赖项和运行时环境的程序与它们共享的数据库一起被打包在一起。
*   一个**任务**是 Borg 的基本功能单元。它可以通过命令行调用来触发，所以它有一个句柄。它是由一组称为**约束**的属性定义的，这些属性的作用就像是可执行的策略——例如，管理允许在哪些硬件类别上运行，以及不允许在哪些类别上运行。每个作业被指定为一个单元。
*   工作中的劳动细分是一个**任务**，每个任务被指定为一个 Linux 控制组(“cgroup”)容器。任务是计划的，而不是作业。任务根据其**延迟敏感度**进行标记，这是一种优先化方案:最容易受到延迟影响的任务被视为高优先级。在一个相当达尔文式的环境中，最牢骚满腹的生物得以生存，高度敏感的任务能够相当频繁地击败低级别的，或**批**任务给高管。(博格的生活，就像他们说的，是一批。)
*   单元的中央控制器是指定的 **Borgmaster** ，它管理单元中每台机器上的代理进程，称为 **Borglets** 。通过公平和民主的选举来确定一个细胞的首领，使用的算法首先是由数字设备公司开发的 Paxos，它是以爱琴海的一个岛屿命名的，这个岛屿只有一个兼职的议会。Borglet 的职责包括启动和停止任务，维护本地资源的状态，并定期向 Borgmaster 报告机器的活动状态。(谷歌永远不会证实这一点，但你只知道在某个地方有一台贴着洁蕊·瑞恩海报的博格特机器。)
*   提交的作业保持在一个峰值上，高优先级(低敏感度)的任务在最上面。调度程序从这些作业中选择一个，并搜索符合要求的机器。根据新任务的限制，调度程序可以抢占已经运行的低优先级任务。然后，基于其资源的相对可用性，对被确定为对于该任务可行的机器进行评分。

## 经验教训

“Borg 的绝大部分工作负载不在虚拟机内运行，”Borg 团队写道，“因为我们不想支付虚拟化的成本。”

该团队没有详细说明成本构成，但很有可能他们指的是 1)额外的虚拟机管理程序层，这导致 2)两个独立规模的复杂分工，限制了整体系统的可扩展性，更不用说 3)采购、支持和维护必要硬件的资金成本。

(VMware 努力揭穿其所谓的虚拟化税的“夸大”想法。但是想象一下，当它们从普通的企业级工作负载扩展到 Google 规模的工作负载时，这些性能成本会呈指数级增长。)

该团队确实提供了一个影响 Kubernetes 的关键设计决策的重要细节，Kubernetes 是一个以 Docker 为导向的调度系统，它是在 Borg 及其继任者 Omega 之后构思的。他们写道，不允许工作聚集在一起是一个错误，迫使用户想出一个需要使用本土管理工具的黑客；Kubernetes 通过允许用户任意标记任何对象来避免这个缺陷，包括它自己版本的调度单元(“pods”)。(事实证明，额外的抽象有助于 Kubernetes 实现负载平衡。)给每台机器分配一个 IP 地址，而不是像 Kubernetes 那样给每个服务分配一个 IP 地址，这迫使每个 Borglet 在其他事情之上管理端口隔离的职责。

即使是好的教训也有其黑暗的一面。该团队写道，Borg 有意提供的调试信息使得对错误原因进行深刻反省变得可行。

> “虽然 Borg 几乎总是‘正常工作’，但当出现问题时，找到根本原因可能是一个挑战，”该团队写道。

该团队对博格细胞进行的压力测试结果显示了鲁棒性和弹性。例如，添加到机器上的每个任务似乎只增加了每条指令消耗的时钟周期(CPI)约 0.3%。但是这个事实最终揭示了，通过演绎过程，在日常处理过程中记录的 CPI 的变化一定是由其他因素引起的，例如某些应用程序的设计。换句话说，一个应用程序的任务设计对整个 Borg 单元性能的影响可能是简单地将任务添加到机器的时间表中的平均性能成本的 16 倍。

显然，Borg 仍然在谷歌内部使用，Omega 和 Kubernetes 也是如此，因为这三个词都是现在时态。这是谷歌进化设计原则的一部分，让新版本的系统进程与旧版本共存，分批逐步淘汰后者。然而，令人惊奇的是，Borg 最初并不是被设计成一个分布式系统编排者，但最终却成为了一个。

“例如，我们将调度程序和主用户界面(适马)分离为单独的进程，并添加了准入控制、垂直和水平自动缩放、重新打包任务、定期作业提交(cron)、工作流管理和离线查询的归档系统操作等服务，”该团队写道。

> 总之，这些使我们能够在不牺牲性能或可维护性的情况下扩展工作负载和功能集。

Kubernetes 作为容器编排者的角色是作为一种 Borg 不应该有的功能的进化形式出现的。

谷歌对博格设计的保密，部分是出于保护其知识产权免受激烈竞争的需要，部分只是谷歌模仿苹果通过不谈论某个话题来激发人们对该话题的兴趣的方式。它几乎成功了，但具有讽刺意味的是，在 Twitter 的 Aurora(受 Borg 启发)作为 Apache 项目提交后，对 Borg 的普遍兴趣开始萌发。

现在，现代超大规模系统设计的相当大一部分历史已经成为公共记录的一部分。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>