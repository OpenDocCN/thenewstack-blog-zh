# 一种新的 Linux 内存控制器承诺节省大量内存

> 原文：<https://thenewstack.io/a-new-linux-memory-controller-promises-to-save-lots-of-ram/>

脸书 Linux 内核工程团队的成员 Roman Gushchin 为 Linux 内核提出了一种全新的平板内存控制器。这种新的平板内存控制器承诺通过共享平板页面，在多个内存**组**之间提供更高的内存利用率。

## 什么是平板页面？

Slab 分配是 Linux 内核中的一种内存管理形式，用于提高对象的内存分配效率。这种类型的内存管理减少了由分配和释放引起的碎片。片分配保留已分配的内存，以便在后续分配类似对象时重用，并提供较低的对象初始化开销。

片分配涉及用于特定类型/大小的对象的高速缓存。该缓存有许多预先分配的内存“块”,这些内存块被分成适合特定对象的固定大小。在内核中，有一个 slab 分配器来管理块，这样当它(内核)收到为对象分配内存的请求时，它可以用现有 slab 中的空闲块来满足该请求。

### 新型板坯控制器

Gushchin 发现了他认为当前 slab 内存控制器中的一个“严重缺陷”。根据 Gushchin 的说法，“现有设计导致内存块利用率低的真正原因很简单:内存块页面由一个内存**组**独占使用。如果某个 **cgroup** 只进行了一些特定大小的分配，或者如果在删除 **cgroup** 后留下了一些活动对象(例如 dentries ),或者 **cgroup** 包含一个几乎不分配任何内核对象的单线程应用程序，但每次都在新的 CPU 上分配:在所有这些情况下，最终的片利用率都非常低。如果**kmem**accounting 关闭，内核就可以将 slab 页面上的空闲空间用于其他分配。”

Gushchin 认为，当 **kmem** 控制器作为选择加入功能引入时，这不是一个问题，必须为每个内存组打开该功能。但是，现在默认情况下，cgroup v1 和 v2 的 kmem 控制器都是打开的。由于现代基于 systemd 的系统倾向于创建大量的 cgroups，因此 slab 的利用效率较低。

通过在多个内存组之间共享平板内存页(并采用基于每个对象(而不是基于每个页面)执行记账的系统)，平板内存控制器的这种新实现旨在实现更高效的利用水平。

根据 Gushchin 的说法，新补丁包含两个半独立的部分:

*   **子页计费 API** ，将来可用于其他非页面大小对象的计费，例如 percpu 分配。
*   **mem_cgroup_ptr API** (指向 memcg 的 refcounted 指针，可以重新用于其他对象的高效重定义，例如 pagecache。

Gushchin 的新平板内存控制器已经在众多工作负载上进行了测试。测试结果显示内存使用显著节省，包括:

*   Web 前端，650-700 Mb，大约 42%的平板内存。
*   数据库缓存，750-800 Mb，大约 35%的平板内存
*   DNS 服务器，700 Mb，大约 36%的平板内存

有了这个新的控制器，在 Linux 中可以获得 35-42%的内存使用。Gushchin 在《lkml.org 线程》的[中指出，他的测试中没有任何东西是针对脸书的。他表示他已经在](https://lkml.org/lkml/2019/9/5/1132) [Fedora](https://www.fedoraproject.org/) 30 系统上测试了这个补丁，发现数字大致相同。

Gushchin 的补丁目前处于“请求评论”状态。如果它被接受，最早在 2020 年它就能找到进入主线内核的方法。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>