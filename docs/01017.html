<html>
<head>
<title>Off-The-Shelf Hacker: More MQTT Fun on Your Network</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现成的黑客:网络上更多的MQTT乐趣</h1>
<blockquote>原文：<a href="https://thenewstack.io/off-shelf-hacker-mqtt-fun-network/#0001-01-01">https://thenewstack.io/off-shelf-hacker-mqtt-fun-network/#0001-01-01</a></blockquote><div><div id="tns-post-body-content">


<p class="translated">本周，我再次<a href="https://thenewstack.io/off-shelf-hacker-lightweight-inter-device-messaging-mqtt/" class="local-link"/>挖掘<a href="http://mqtt.org/" class="ext-link" rel="external "> MQTT </a>消息协议，以及如何将它与ESP8266模块、Raspberry Pi、芯片和我的Linux笔记本一起使用。在所有这些设备之间轻松发送双向消息的能力为有趣且可能有用的远程和自动化小工具开辟了许多可能性。</p>
<p class="translated">在一台芯片计算机上安装<a href="https://mosquitto.org/" class="ext-link" rel="external "> Mosquitto </a> MQTT代理是一件绝对简单的事情，正如上周的文章中所解释的那样。顺便说一下，如果它在启动时没有重新启动，你可能需要编辑<strong> /etc/rc.local </strong>，作为root并在底部添加一个引用程序，以及“&amp;”(在后台运行)符号。然后它应该在下次启动时启动。</p>
<p class="translated">在芯片上运行Mosquitto也没有痛苦。我在厨房里有一个备用插座，所以我简单地将它插入一个2安培的壁式电源插座，并将电路板放在一个不碍事的架子上。在过去的几天里，它一直愉快地运行着，代理MQTT消息。我可以在我的局域网上的任何地方，使用Linux笔记本或我的Android超级手机，通过ssh和/或<strong> MQTT_subscribe </strong>进入芯片。</p>
<p class="translated">谷歌Play商店有许多Android MQTT客户端程序。只需在搜索栏中输入“<a href="https://play.google.com/store/search?q=MQTT%20client&amp;hl=en" class="ext-link" rel="external "> MQTT client </a>”并选择一个。将它们用于测试或快速脏数据监控解决方案。一旦你的手机上有了客户端应用，只需输入你的芯片的IP地址和适当的主题，你通常就可以开始了。</p>
<p class="translated">接下来，我们来谈谈我们的数据生成器。</p>
<h2 class="translated">为MQTT修改ESP8266固件</h2>
<p class="translated">基于ESP8266的传感器是很好的数据生成器。它们价格低廉，易于通过Arduino IDE进行编程，并且可以毫不费力地处理MQTT消息。选择您的传感器，将其连接到GPIO引脚，然后开始发送数据。从另一个方向来看，选择一个输出设备，观察特定的消息并激活连接到该设备的引脚。我们将在以后的文章中介绍如何观察消息(在ESP8266上)和激活GPIO引脚。</p>
<p class="translated">我使用mqtt_esp8266示例程序(在Arduino IDE中)作为esp8266上的基本mqtt客户端。添加PIR传感器代码(已在<a href="https://thenewstack.io/off-shelf-hacker-create-early-warning-detector-passive-infrared-sensors/" class="local-link">“创建带有被动式红外传感器的早期预警探测器”</a>中介绍)可生成一个完全可用的数据生成程序。每当热物体移动到传感器前面时，它就向芯片代理发送MQTT消息。听着，妈，没有电线。</p>
<p class="translated">这是代码。<br/></p>
<div id="crayon-642150d2b5123248731292" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-c">/*</span>
<span class="crayon-c"> -----------------------------------------</span>
<span class="crayon-c"> drtorq's Modded - Basic ESP8266 MQTT example</span>
<span class="crayon-c"> filename: mqtt_esp8266_1</span>
<span class="crayon-c"> -----------------------------------------</span>
<span class="crayon-c">*/</span>
 
<span class="crayon-p">#include </span>
<span class="crayon-p">#include </span>
 
<span class="crayon-c">// Update these with values suitable for your network.</span>
 
<span class="crayon-e">const </span><span class="crayon-e ">char*</span><span class="crayon-h"> </span><span class="crayon-i">ssid</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">"your AP name"</span>;
<span class="crayon-e">const </span><span class="crayon-e ">char*</span><span class="crayon-h"> </span><span class="crayon-i">password</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">"your AP password"</span>;
<span class="crayon-e">const </span><span class="crayon-e ">char*</span><span class="crayon-h"> </span><span class="crayon-i">mqtt_server</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">"192.168.1.111"</span>;<span class="crayon-h">     </span><span class="crayon-c">// IP address of the MQTT Broker</span>
 
<span class="crayon-e">WiFiClient </span><span class="crayon-i">espClient</span>;
<span class="crayon-e">PubSubClient </span><span class="crayon-e">client</span>(<span class="crayon-i">espClient</span>);
<span class="crayon-e">long </span><span class="crayon-i">lastMsg</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">0</span>;
<span class="crayon-e">char </span><span class="crayon-i">msg</span>[<span class="crayon-cn">50</span>];
<span class="crayon-e">int </span><span class="crayon-i">value</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">0</span>;
 
<span class="crayon-e">int </span><span class="crayon-i">calibrationTime</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">20</span>;
<span class="crayon-e">int </span><span class="crayon-i">pirPin</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">2</span>;<span class="crayon-h">    </span><span class="crayon-c">//the digital pin connected to the PIR sensor's output</span>
<span class="crayon-e">int </span><span class="crayon-i">ledPin</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">13</span>;
 
<span class="crayon-e">void </span><span class="crayon-e">setup_wifi</span>()<span class="crayon-h"> </span>{
 
<span class="crayon-h">  </span><span class="crayon-e">delay</span>(<span class="crayon-cn">10</span>);
<span class="crayon-h">  </span><span class="crayon-c">// We start by connecting to a WiFi network</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>();
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"Connecting to "</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-i">ssid</span>);
 
<span class="crayon-h">  </span><span class="crayon-i">WiFi</span><span class="crayon-st">.</span><span class="crayon-e">begin</span>(<span class="crayon-i">ssid</span>,<span class="crayon-h"> </span><span class="crayon-i">password</span>);
 
<span class="crayon-h">  </span><span class="crayon-e">while</span><span class="crayon-h"> </span>(<span class="crayon-i">WiFi</span><span class="crayon-st">.</span><span class="crayon-e">status</span>()<span class="crayon-h"> </span>!=<span class="crayon-h"> </span><span class="crayon-i">WL_CONNECTED</span>)<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">delay</span>(<span class="crayon-cn">500</span>);
<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"."</span>);
<span class="crayon-h">  </span>}
 
<span class="crayon-h">  </span><span class="crayon-e">randomSeed</span>(<span class="crayon-e">micros</span>());
 
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">""</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"WiFi connected"</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"IP address: "</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-i">WiFi</span><span class="crayon-st">.</span><span class="crayon-e">localIP</span>());
}
 
<span class="crayon-e">void </span><span class="crayon-e">callback</span>(<span class="crayon-e ">char*</span><span class="crayon-h"> </span><span class="crayon-i">topic</span>,<span class="crayon-h"> </span><span class="crayon-e ">byte*</span><span class="crayon-h"> </span><span class="crayon-i">payload</span>,<span class="crayon-h"> </span><span class="crayon-e">unsigned </span><span class="crayon-e">int </span><span class="crayon-i">length</span>)<span class="crayon-h"> </span>{
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"Message arrived ["</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-i">topic</span>);
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"] "</span>);
<span class="crayon-h">  </span><span class="crayon-e">for</span><span class="crayon-h"> </span>(<span class="crayon-i">int</span><span class="crayon-h"> </span><span class="crayon-m">i</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">0</span>;<span class="crayon-h"> </span><span class="crayon-m">i</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;lt;</span><span class="crayon-h"> </span><span class="crayon-i">length</span>;<span class="crayon-h"> </span><span class="crayon-m">i</span>++)<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>((<span class="crayon-i">char</span>)<span class="crayon-i">payload</span>[<span class="crayon-m">i</span>]);
<span class="crayon-h">  </span>}
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>();
 
<span class="crayon-h">  </span><span class="crayon-c">// Switch on the LED if an 1 was received as first character</span>
<span class="crayon-h">  </span><span class="crayon-e">if</span><span class="crayon-h"> </span>((<span class="crayon-i">char</span>)<span class="crayon-i">payload</span>[<span class="crayon-cn">0</span>]<span class="crayon-h"> </span>==<span class="crayon-h"> </span><span class="crayon-s">'1'</span>)<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">digitalWrite</span>(<span class="crayon-i">BUILTIN_LED</span>,<span class="crayon-h"> </span><span class="crayon-i">LOW</span>);<span class="crayon-h">   </span><span class="crayon-c">// Turn the LED on (Note that LOW is the voltage level</span>
<span class="crayon-h">    </span><span class="crayon-c">// but actually the LED is on; this is because</span>
<span class="crayon-h">    </span><span class="crayon-c">// it is acive low on the ESP-01)</span>
<span class="crayon-h">  </span>}<span class="crayon-h"> </span><span class="crayon-e">else</span><span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">digitalWrite</span>(<span class="crayon-i">BUILTIN_LED</span>,<span class="crayon-h"> </span><span class="crayon-i">HIGH</span>);<span class="crayon-h">  </span><span class="crayon-c">// Turn the LED off by making the voltage HIGH</span>
<span class="crayon-h">  </span>}
}
 
<span class="crayon-e">void </span><span class="crayon-e">reconnect</span>()<span class="crayon-h"> </span>{
<span class="crayon-h">  </span><span class="crayon-c">// Loop until we're reconnected</span>
<span class="crayon-h">  </span><span class="crayon-e">while</span><span class="crayon-h"> </span>(!<span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">connected</span>())<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"Attempting MQTT connection..."</span>);
<span class="crayon-h">    </span><span class="crayon-c">// Create a random client ID</span>
<span class="crayon-h">    </span><span class="crayon-e">String </span><span class="crayon-i">clientId</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">"ESP8266Client-"</span>;
<span class="crayon-h">    </span><span class="crayon-i">clientId</span><span class="crayon-h"> </span>+=<span class="crayon-h"> </span><span class="crayon-e">String</span>(<span class="crayon-e">random</span>(<span class="crayon-cn">0xffff</span>),<span class="crayon-h"> </span><span class="crayon-i">HEX</span>);
<span class="crayon-h">    </span><span class="crayon-c">// Attempt to connect</span>
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">connect</span>(<span class="crayon-i">clientId</span><span class="crayon-st">.</span><span class="crayon-e">c_str</span>()))<span class="crayon-h"> </span>{
<span class="crayon-h">      </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"connected"</span>);
<span class="crayon-h">      </span><span class="crayon-c">// Once connected, publish an announcement...</span>
<span class="crayon-h">      </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">publish</span>(<span class="crayon-s">"mqtt"</span>,<span class="crayon-h"> </span><span class="crayon-s">"hello world"</span>);
<span class="crayon-h">      </span><span class="crayon-c">// ... and resubscribe</span>
<span class="crayon-h">      </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">subscribe</span>(<span class="crayon-s">"inTopic"</span>);
<span class="crayon-h">    </span>}<span class="crayon-h"> </span><span class="crayon-e">else</span><span class="crayon-h"> </span>{
<span class="crayon-h">      </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"failed, rc="</span>);
<span class="crayon-h">      </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">state</span>());
<span class="crayon-h">      </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">" try again in 5 seconds"</span>);
<span class="crayon-h">      </span><span class="crayon-c">// Wait 5 seconds before retrying</span>
<span class="crayon-h">      </span><span class="crayon-e">delay</span>(<span class="crayon-cn">5000</span>);
<span class="crayon-h">    </span>}
<span class="crayon-h">  </span>}
}
 
<span class="crayon-e">void </span><span class="crayon-e">setup</span>()<span class="crayon-h"> </span>{
<span class="crayon-h">  </span><span class="crayon-e">pinMode</span>(<span class="crayon-i">BUILTIN_LED</span>,<span class="crayon-h"> </span><span class="crayon-i">OUTPUT</span>);<span class="crayon-h">     </span><span class="crayon-c">// Initialize the BUILTIN_LED pin as an output</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">begin</span>(<span class="crayon-cn">115200</span>);
<span class="crayon-h">  </span><span class="crayon-e">setup_wifi</span>();
<span class="crayon-h">  </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">setServer</span>(<span class="crayon-i">mqtt_server</span>,<span class="crayon-h"> </span><span class="crayon-cn">1883</span>);
<span class="crayon-h">  </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">setCallback</span>(<span class="crayon-i">callback</span>);
 
<span class="crayon-h">   </span><span class="crayon-c">// Calibrate sensor</span>
<span class="crayon-h">  </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"calibrating sensor "</span>);
<span class="crayon-h">    </span><span class="crayon-e">for</span>(<span class="crayon-i">int</span><span class="crayon-h"> </span><span class="crayon-m">i</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-cn">0</span>;<span class="crayon-h"> </span><span class="crayon-m">i</span><span class="crayon-h"> </span><span class="crayon-sy">&amp;lt;</span><span class="crayon-h"> </span><span class="crayon-i">calibrationTime</span>;<span class="crayon-h"> </span><span class="crayon-m">i</span>++){
<span class="crayon-h">      </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">print</span>(<span class="crayon-s">"."</span>);
<span class="crayon-h">      </span><span class="crayon-e">delay</span>(<span class="crayon-cn">1000</span>);
<span class="crayon-h">      </span>}
<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">" done"</span>);
<span class="crayon-h">    </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"SENSOR ACTIVE"</span>);
<span class="crayon-h">    </span><span class="crayon-e">delay</span>(<span class="crayon-cn">50</span>);
}
 
<span class="crayon-e">void </span><span class="crayon-e">loop</span>()<span class="crayon-h"> </span>{
 
<span class="crayon-h">  </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(!<span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">connected</span>())<span class="crayon-h"> </span>{
<span class="crayon-h">    </span><span class="crayon-e">reconnect</span>();
<span class="crayon-h">  </span>}
<span class="crayon-h">  </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">loop</span>();
 
<span class="crayon-h">    </span><span class="crayon-c">// added PIR sensor code segment here</span>
 
<span class="crayon-h">    </span><span class="crayon-e">int </span><span class="crayon-i">proximity</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-e">digitalRead</span>(<span class="crayon-i">pirPin</span>);
 
<span class="crayon-h">    </span><span class="crayon-e">if</span><span class="crayon-h"> </span>(<span class="crayon-i">proximity</span><span class="crayon-h"> </span>==<span class="crayon-h"> </span><span class="crayon-i">LOW</span>)<span class="crayon-h"> </span><span class="crayon-c">// If the sensor's output goes low, motion is detected</span>
<span class="crayon-h">       </span>{
<span class="crayon-h">       </span><span class="crayon-e">digitalWrite</span>(<span class="crayon-i">ledPin</span>,<span class="crayon-h"> </span><span class="crayon-i">HIGH</span>);
<span class="crayon-h">       </span><span class="crayon-e">snprintf</span><span class="crayon-h"> </span>(<span class="crayon-i">msg</span>,<span class="crayon-h"> </span><span class="crayon-cn">75</span>,<span class="crayon-h"> </span><span class="crayon-s">"Motion Detected #%ld"</span>,<span class="crayon-h"> </span><span class="crayon-i">value</span>);
<span class="crayon-h">       </span>++<span class="crayon-i">value</span>;
<span class="crayon-h">       </span><span class="crayon-i">Serial</span><span class="crayon-st">.</span><span class="crayon-e">println</span>(<span class="crayon-s">"Motion detected!"</span>);
<span class="crayon-h">       </span><span class="crayon-i">client</span><span class="crayon-st">.</span><span class="crayon-e">publish</span>(<span class="crayon-s">"mqtt"</span>,<span class="crayon-h"> </span><span class="crayon-i">msg</span>);
<span class="crayon-h">       </span><span class="crayon-e">delay</span>(<span class="crayon-cn">200</span>);
<span class="crayon-h">       </span>}
<span class="crayon-h">    </span><span class="crayon-e">else</span>
<span class="crayon-h">       </span>{
<span class="crayon-h">       </span><span class="crayon-e">digitalWrite</span>(<span class="crayon-i">ledPin</span>,<span class="crayon-h"> </span><span class="crayon-i">LOW</span>);
<span class="crayon-h">       </span><span class="crayon-e">delay</span>(<span class="crayon-cn">200</span>);
<span class="crayon-h">    </span>}<span class="crayon-h">  </span>
}
</pre>
</div>
</div>

<p class="translated"><br/>该设置已经静默运行了几天，每次我在办公桌前移动时都会被检测到。这里有一个在Linux笔记本窗口上的<strong> mosquitto_sub </strong>命令的屏幕截图，从网络上监控传感器。没错，超过46，500条“侦测到移动”信息。很管用。</p>
<div id="attachment_1825524" class="wp-caption aligncenter"><img aria-describedby="caption-attachment-1825524" decoding="async" loading="lazy" class="size-full wp-image-1825524" src="../Images/c95d76bea378361144728d6300da1926.png" alt="" data-original-src="https://cdn.thenewstack.io/media/2017/01/a95010ba-screenshot-01192017-063910-am.png"/><p id="caption-attachment-1825524" class="wp-caption-text translated">Linux笔记本上的mosquitto_sub结果</p></div>
<p class="translated">传感器能够在一秒钟内看到几次运动，因此在它最初启动后，更改代码以忽略一到三秒钟的检测，将减少流向代理的数据量。我认为在现实世界中，使用这种技术，我们不太可能漏掉入侵者。</p>
<p class="translated">基于ESP8266的设备不是唯一可以发送MQTT消息的设备。</p>
<h2 class="translated">也在Raspberry Pi上运行MQTT客户机</h2>
<p class="translated">Raspberry Pi也可以作为订阅者和发布者加入到您的MQTT世界中。</p>
<p class="translated">想象一下，有一个支持ESP8266的院子灯，它通过MQTT消息切换开/关。如果能够按下树莓派上的按钮并打开灯，这可能会很有用。</p>
<p class="translated">我不久前写了一个Python程序来检测树莓派上的按钮。因为它使用了<a href="http://www.semicomplete.com/projects/xdotool" class="ext-link" rel="external "> xdotool </a>和一个系统调用，所以有点像组装的。现成的黑客有时是一个<a href="http://www.urbandictionary.com/define.php?term=kludge" class="ext-link" rel="external ">组装</a>。就像我常说的，让原型工作，做你的演示，然后根据需要改进设计。此外，如果它工作得足够好，您可能总是“按原样”使用它</p>
<p class="translated">好的一面是，我所要做的就是将mosquito客户端添加到Pi中，并修改Python程序来调用<strong>mosquito _ pub</strong>命令，而不是<strong> xdotool </strong>。</p>
<p class="translated">启动Pi并使用<strong> apt-get </strong>安装Mosquitto客户端软件。<br/></p>
<div id="crayon-642150d2b5128264758187" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-i">pi</span>%<span class="crayon-h">  </span><span class="crayon-i">apt</span>-<span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-i">mosquitto</span>-<span class="crayon-v">clients</span>
</pre>
</div>
</div>

<p class="translated"><br/>接下来，通过芯片MQTT代理(IP=192.168.1.111)订阅PIR传感器，试用Mosquitto客户端。<br/></p>
<div id="crayon-642150d2b512c749578678" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-i">pi</span>%<span class="crayon-h">  </span><span class="crayon-i">mosquitto_sub</span><span class="crayon-h"> </span>-<span class="crayon-i">h</span><span class="crayon-h"> </span><span class="crayon-cn">192.168.1.111</span><span class="crayon-h"> </span>-<span class="crayon-st">t</span><span class="crayon-h"> </span>“<span class="crayon-i">mqtt</span>”
</pre>
</div>
</div>

<p class="translated"><br/>只要PIR传感器前面有移动，就会出现一条新消息。</p>
<p class="translated">使用<strong>mosquito _ pub</strong>命令测试发送信息也很容易。在Raspberry Pi上打开另一个终端，并输入以下命令行。<br/></p>
<div id="crayon-642150d2b512d509376725" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-i">pi</span>%<span class="crayon-h">  </span><span class="crayon-i">mosquitto_pub</span><span class="crayon-h"> </span>-<span class="crayon-i">h</span><span class="crayon-h"> </span><span class="crayon-cn">192.168.1.111</span><span class="crayon-h"> </span>-<span class="crayon-st">t</span><span class="crayon-h"> </span>“<span class="crayon-i">mqtt</span>”<span class="crayon-h"> </span>-<span class="crayon-st">m</span><span class="crayon-h"> </span>“<span class="crayon-e">Button </span><span class="crayon-i">Pushed</span>”
</pre>
</div>
</div>

<p class="translated"><br/>另一个Raspberry Pi窗口中会立即显示“按钮已按下”。如果您在Linux笔记本上监视“mqtt”主题，该消息也会出现在那里。</p>
<p class="translated">下面是Python代码，用Pi: <br/>上的<strong>mosquito _ pub</strong>行代替xdotool</p>
<div id="crayon-642150d2b512e246074377" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-p"># filename: mqtt-button-push.py</span>
 
<span class="crayon-e">import </span><span class="crayon-i">RPi</span><span class="crayon-st">.</span><span class="crayon-e">GPIO </span><span class="crayon-e">as </span><span class="crayon-e">GPIO</span>
<span class="crayon-e">import </span><span class="crayon-e">time</span>
<span class="crayon-e">import </span><span class="crayon-e">os</span>
 
<span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-e">setmode</span>(<span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-i">BCM</span>)
 
<span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-e">setup</span>(<span class="crayon-cn">17</span>,<span class="crayon-h"> </span><span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-i">IN</span>,<span class="crayon-h"> </span><span class="crayon-i">pull_up_down</span>=<span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-i">PUD_UP</span>)
 
<span class="crayon-i">osout</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">''</span>
 
<span class="crayon-e">while </span><span class="crayon-i">True</span>:
<span class="crayon-h">    </span><span class="crayon-i">input_state</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-i">GPIO</span><span class="crayon-st">.</span><span class="crayon-e">input</span>(<span class="crayon-cn">17</span>)
<span class="crayon-h">    </span><span class="crayon-e">if </span><span class="crayon-i">input_state</span><span class="crayon-h"> </span>==<span class="crayon-h"> </span><span class="crayon-i">False</span>:
 
<span class="crayon-h">        </span><span class="crayon-i">print</span><span class="crayon-h"> </span><span class="crayon-s">'Long Button Pressed'</span>
 
<span class="crayon-h">        </span><span class="crayon-p"># os.system("xdotool search --name 'Impress' key Down")</span>
<span class="crayon-h">        </span><span class="crayon-p"># system call line for a button push to advance a LibreOffice Impress slide</span>
 
<span class="crayon-h">        </span><span class="crayon-p"># building a new line with the mosquitto_pub system call</span>
<span class="crayon-h">        </span><span class="crayon-i">osout</span><span class="crayon-h"> </span>=<span class="crayon-h"> </span><span class="crayon-s">"mosquitto_pub -h '192.168.1.111' -t 'mqtt' -m 'Button Pushed'"</span>
<span class="crayon-h">        </span><span class="crayon-e">print </span><span class="crayon-e">osout</span>
<span class="crayon-e">        </span><span class="crayon-i">os</span><span class="crayon-st">.</span><span class="crayon-e">system</span>(<span class="crayon-i">osout</span>)
 
<span class="crayon-h">        </span><span class="crayon-i">time</span><span class="crayon-st">.</span><span class="crayon-e">sleep</span>(<span class="crayon-cn">0.2</span>)
</pre>
</div>
</div>

<p class="translated"><br/>按钮连接到Pi上的GPIO引脚17。</p>
<p class="translated">接下来，只需运行Python程序，让按钮向代理发送MQTT消息。<br/></p>
<div id="crayon-642150d2b512f992249867" class="crayon-syntax crayon-theme-github-gist crayon-font-liberation-mono crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always">
<p class="crayon-plain-wrap"/>
<div class="crayon-main">
<pre><span class="crayon-i">pi</span>%<span class="crayon-h">  </span><span class="crayon-e">python </span><span class="crayon-i">mqtt</span>-<span class="crayon-i">button</span>-<span class="crayon-i">push</span><span class="crayon-st">.</span><span class="crayon-v">py</span>
</pre>
</div>
</div>

<p class="translated"><br/>每次按下按钮，订阅“mqtt”主题的所有<strong>mosquito _ sub</strong>窗口中都会出现一条新消息。</p>
<p class="translated">请注意,“按钮已按下”消息无缝融入PIR“检测到运动”消息中。</p>
<p class="translated">您可以让ESP8266连接的院子灯监视“按钮被按下”消息，以显示在“mqtt”主题中，然后每当它看到一个消息时就切换灯。我们还可以在收到“检测到运动”信息时打开灯。</p>
<p class="translated">Raspberry Pi有几个Python MQTT库，所以您可以考虑使用它们来代替对mosquitto_pub的系统调用。</p>
<p class="translated">这有多简单？</p>
<h2 class="translated">将这些点连接起来</h2>
<p class="translated">我得到的印象是，很多人认为MQTT很奇怪，很难使用，而且很复杂。正如我们所见，在ESP8266、芯片、Raspberry Pi和Linux笔记本上使用Mosquitto服务器(代理)和客户端非常简单。</p>
<p class="translated">显然，对于生产环境，安全性和设备管理是需要考虑的重要方面。最棒的是，在加密的无线网络上，在防火墙后面，有很多原型设计的想法，你现在就可以尝试。随着我们对技术的掌握，我们将在其他主题上展开讨论。</p>


<div class="tns-logo-slug">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 68 31" version="1.1">
<title>Group</title>
<desc>Created with Sketch.</desc>
<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
<g id="Group">
<path d="M24.002,29.619 L29.77,29.619 L29.77,15.808 C29.77,15.038 29.622,11.265 29.59,10.414 L29.77,10.414 C31.424,14.019 31.473,14.147 32.168,15.322 L39.65,29.618 L44.845,29.618 L44.845,0 L39.075,0 L39.075,11.064 C39.075,12.197 39.075,12.44 39.182,14.472 L39.325,17.468 L39.151,17.468 C39.034,17.267 38.596,16.173 38.467,15.929 C38.164,15.323 37.725,14.512 37.373,13.905 L30.031,0 L24,0 L24,29.619 L24.002,29.619 Z" id="Path-Copy" fill="#FF3287"/>
<path d="M56.948,0 C50.745,0 47.606,3.43 47.606,8.296 C47.606,14.114 51.036,15.404 55.518,17.132 C60.438,18.853 61.782,19.332 61.782,21.539 C61.782,24.225 58.969,24.867 57.401,24.867 C54.579,24.867 52.493,23.342 51.536,20.858 L47,24.185 C49.43,28.937 52.145,30.185 57.713,30.185 C59.364,30.185 62.059,29.74 63.727,28.694 C67.779,26.156 67.779,22.22 67.779,20.898 C67.779,18.129 66.531,16.207 66.178,15.726 C65.049,14.121 63.032,12.918 61.25,12.278 L57.084,10.914 C55.073,10.267 52.928,10.105 52.928,8.019 C52.928,7.707 53.008,5.528 56.288,5.319 L61.465,5.319 L61.465,0 C61.465,0 57.342,0 56.948,0 Z" id="Path-Copy-2" fill="#00AFF4"/>
<polygon id="Path" fill="#00AFF4" points="5.32907052e-15 1.77635684e-15 5.32907052e-15 5.319 7.572 5.319 7.572 29.564 14.132 29.564 14.132 5.319 21.544 5.319 21.544 1.77635684e-15"/>
</g>
</g>
</svg> </div>

</div>
</div>    
</body>
</html>