# 苦乐参半的 Kubernetes 生产之路

> 原文：<https://thenewstack.io/the-bittersweet-road-to-kubernetes-production/>

[](https://giantswarm.io/)

 [Oliver Thylmann，Giant Swarm

联合创始人丈夫，三个孩子的父亲，自 1996 年以来的互联网企业家，开发者耳语者，极客，强迫性第一采用者，德国科隆 Giant Swarm 联合创始人。](https://giantswarm.io/) [](https://giantswarm.io/)

> “我们可以通过三种方法学习智慧:第一，通过反思，这是最高尚的；第二，通过模仿，这是最容易的；第三是经验，这是最痛苦的。”—孔子(公元前 551-479 年)

我们已经在生产中运行 Kubernetes 一段时间了，并且与大公司合作——全球流量、黑色星期五和圣诞节销售、严格的安全准则和多国团队。我们 24/7 全天候管理这些集群，随时为每个集群准备好寻呼机。我们是企业客户的 SRE 团队。

这使我们处于一个独特的位置来分享我们的一些考验和磨难，有些是痛苦的，有些是站在巨人的肩膀上，有些是从一开始就反思的。我们去过了，买了 t 恤。这会很有趣的。

## 安全性:RBAC、PSP 和网络策略

安全性是我们的一大关注点，我们共同编写了 [Kubernetes CIS 基准](https://www.cisecurity.org/benchmark/kubernetes/)，现在已经实现了合规性(重要:在有意义的地方！)和许多其他 CIS 基准(AWS 和 Docker)。我们在集群中默认启用了 RBAC，在某些情况下已经使用了 Kubernetes 1.6，最终使用了 Kubernetes 1.7。由于我们在容器中托管所有基础设施组件，其中许多组件，如 [Calico Networking、](https://www.projectcalico.org/)作为由 Kubernetes 管理的 pods 运行，所以“关闭特权容器”的古老格言对我们来说是不可行的(因为它不适用于大多数严重的生产设置)。

为了解决这个问题，我们将 RBAC 和 Pod 安全策略(PSP)结合起来，通过限制扩展安全上下文的使用来缓解这个问题。我们认为这是一个合理的解决方案，直到我们尝试了它。我们发现了一些小错误(PSP 还在 alpha 版本中),但是几乎没有预先制定的政策，这意味着几乎没有人可能使用过这个。这就是成为新锐的代价。尽管如此，我们还是做得很好，社区中关键人物的帮助令人惊叹。

我们最终设法完成了，从那时起，每个集群都被完全锁定了。我们甚至有客户使用 Calico 网络策略，在不同团队的每个名称空间的基础上，限制出口流量到本地的 NFS 共享。

我们也开始部分讨厌安全扫描仪。所有集群 etcds 都完全加密，但运行在未加密的 EBS 卷上。理论上，这没问题，因为所有的内容都是加密的。但是安全扫描器会注意到未加密的 EBS，从那时起，他们会说设置是不安全的，直到你修复它。这是恼人的小问题之一。如果您了解 etcd，您就会知道 it 的实时迁移有多麻烦。

## 更新:不要碰！起作用了！

我们将基础设施视为代码，这意味着[我们拥有完整的 CI/CD](https://blog.giantswarm.io/giantswarm-continuous-deployment/) 设置来管理基础设施组件，尤其是我们自己构建的组件。实际上，我们有一个补丁和大小更新的系统，对何时部署它们有不同的规则。但随着时间的推移，我们了解到其中很大一部分是确保我们实际上被允许部署它们。

到目前为止，我们的合同中甚至有一部分说，如果您的集群超过三个月没有更新，我们的管理将不再包括在内。这是一位客户提出的建议，他现在可以告诉他们的团队，他们需要升级，因为否则成本会很高。它工作了。比其他任何东西都好，因为否则团队只会说:但是它在工作，为什么要碰它？

通用电气首席执行官杰克·韦尔奇曾经说过:“我一直相信，当一个机构内部的变化速度比外部的变化速度慢时，末日就在眼前。唯一的问题是什么时候。”

这确实是个问题。我们在较旧的集群中发现了大多数生产问题，主要是因为任何客户集群中的每个生产事件都会导致全面的#事后分析，直到根本原因得到解决并推广到所有客户集群。我们确保——非常确定——我们有单一的产品，客户喜欢我们这一点，因为他们看到的问题更少。这也意味着，我们需要让人们升级。

我们还与我们的一个大公司客户在工具方面密切合作，使分布式公司团队的部署和升级更简单。在我们的博客上关注这个[。](https://blog.giantswarm.io/)

## 安装:AWS 在几个小时内完成，现场安装费用为$var

> “试图预测未来就像试图在没有灯光的夜晚开车行驶在乡村道路上，同时从后窗往外看。”——彼得·德鲁克

我们可以在 AWS 上在两个小时内启动整个[巨型 Swarm 安装](https://www.youtube.com/watch?v=Nq5uIIT5mOw),接近 Azure 上的安装——最终可能会相同，因为我们最近在 Azure 上推出了我们的生产就绪 Kubernetes。从那里，我们的客户可以创建任意多的集群。我们的优势是我们可以在内部做同样的事情，但遗憾的是，我们仍然不得不说，内部安装需要时间。我开玩笑说，这需要 6 个小时到 6 个月的时间，两者都不太可能。

内部部署的问题在于它们都是不同的。VPN 是如何工作的？那 Jump 主机呢？服务器是否正确联网？我们可以进入劳工组织吗？对于我们的许多客户来说，内部部署具有真正的价值，但它完全不同，也不容易使用。如果您没有集成负载平衡器 API，情况尤其如此(您甚至可以为自己的规则获得自己的 F5 networks BIG-IP 空间吗？)并且没有适当的标准化和 Kubernetes 支持的存储解决方案。我们有 iSCSI connected，它与 Docker 有一些稳定性问题，还有 NFS，它的表现并不总是那么好。我们正在寻找 EMC Ipsilon 和 Rex-Ray 或 [Rook](https://rook.io/) ，但它们都不完美。在上游有一个好的动态供应器的云提供商身上会好得多。

## 负载测试和终止 AWS

很明显，我们与客户一起进行负载测试，并推动他们这样做。但是，一旦我们开始崩溃，因为当负载测试来了，没有什么工作了。这是集群的彻底死亡。然而，我们客户的团队仍然习惯于旧的工作方式，只是提出负载测试失败的想法，并说他们会再试一次。

我们不知道如何解决它，直到我们挖得更深。首先，负载测试配置错误，没有产生 100，000 个并发用户。相反，它在每个位置产生了 100，000 个并发用户，由于使用了三个原始位置，因此产生了 300，000 个并发用户。然后我们进一步挖掘，发现小型集群中使用的 EC2 机器有 1gb 网卡，几秒钟后它们就饱和并死亡了。流量从未到达集群级别。

在扩展集群后，它运行得非常好。

## 身份验证—从 OIDC 证书到 Azure AD

> “从前有 __。每天，___。某天 __。正因为如此，_ _ _ _ _ _。正因为如此，_ _ _ _ _ _。直到最后 __。”——皮克斯讲故事规则#4

我们的设置默认为由我们的 API 和 [cert-operator](https://github.com/giantswarm/cert-operator) 自动进行的证书认证，并基于后端的 Vault。然而，目前许多公司都在使用活动目录，它很好。我们希望转移客户，使其能够通过认证。

由于我们希望通过 Kubernetes 支持的 OIDC 接口进行集成，首先，我们需要客户升级到较新版本的 ADFS，因为旧版本不提供任何 OIDC 端点。然而，当我们开始测试时，我们遇到了自签名证书的问题，所以我们开始了使用 Dex 的[测试。经过一些来回，我们得到了工作，但我们仍然有问题，从 OIDC 端点扩展索赔/范围。因为 Dex 的 UX 方面还没有解决(如果你没有运行构造的话)。在某个时候，我们决定尝试第三条路:Azure AD。](https://github.com/coreos/dex)

客户在他们的内部 ADFS 和 Azure AD 之间进行了同步。通过与我们在微软的朋友交谈(让他们直接参与我们的工作很好)和查看一些上游文档，我们发现这是一个值得尝试的解决方案。在微软的帮助下，我们解决了上游文档中的一些未决问题，我们很快让它工作起来，从那时起，客户的所有集群都预设了 Azure AD 身份验证。

## 共同成长

正如这些故事所显示的，在 Kubernetes 的生产过程中，有许多技术和组织方面的挑战需要克服；有些来得早，有些来得晚，有些是规模，有些是资源压力。如果我们和客户之间只有简单的供应商-客户关系，事情就不会变成这样。相反，我们很高兴能够与客户建立真正的关系和合作伙伴关系，帮助我们共同成长。

我们希望通过在这里分享我们的经验，我们至少可以部分地将这种关系扩展到您，下次您遇到我们时，请联系我们，了解更多来自 Kubernetes 生产战壕的战时故事。

*Oliver Thylmann 将于 2018 年 5 月 2 日至 4 日在丹麦哥本哈根举行的 [KubeCon + CloudNativeCon EU](https://events.linuxfoundation.org/events/kubecon-cloudnativecon-europe-2018/) 上与阿迪达斯共同展示“[企业新鞋——阿迪达斯全球 Kubernetes 发布之旅](http://sched.co/DYAl)”。*

![](img/aa4c75ca1c26fd34976ffd3db36b08be.png)

本文由 Giant Swarm 代表新堆栈的赞助商[kube con+CloudNativeCon Europe](https://events.linuxfoundation.org/events/kubecon-cloudnativecon-europe-2018/)供稿。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>