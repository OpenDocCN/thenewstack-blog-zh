# 网飞如何建造高速连续交付平台 Spinnaker

> 原文：<https://thenewstack.io/netflix-built-spinnaker-high-velocity-continuous-delivery-platform/>

你看了《奇异事物》或《第八感》吗？它有没有因为软件故障而中断过，这是我们在几乎所有其他流媒体服务中经历过的事情？可能永远不会。考虑到网飞拥有最具活力的基础设施之一，开发者不断发布更新和新软件，这真是令人难以置信。他们是如何做到的？

“我们不希望你的‘陌生事物’流被一个事实打断，也许是一个工程师推出了一个错误的部署或对一个他们不应该有的属性进行了更改，整个系统都崩溃了，”网飞的工程工具总监 Dianne Marsh 说。

对于保持动态基础设施的持续正常运行时间至关重要的是 [Spinnaker](https://www.spinnaker.io/) ，这是一个完全开源的、多云的、连续的交付平台，由网飞内部开发，以帮助开发团队发布软件更改，并对不会出现任何问题充满信心。Spinnaker 提供了两个核心特性:集群管理和部署管理。

Spinnaker 继承了网飞的另一个开源工具 [Asgard，这是一个云交付平台](https://github.com/Netflix/asgard)，旨在简化向亚马逊网络服务(AWS)交付网飞服务。

Asgard 被社区广泛采用，但是它也遇到了一些挑战。Asgard 被设计成只支持 AWS，但是用户希望在他们自己的环境中使用它。此外，作为网飞的内部工具，开发人员不需要许可就可以进行部署，但外部用户需要这样的能力。为了满足自己的需求，人们不得不放弃 Asgard。当人们用叉子叉它时，网飞发现了一个问题。

“这导致了 Asgard 源代码的碎片化，因为他们很难将这项技术带回来。我们失去了其他公司在这些工作上的创新，”马什说。“因此，对我们来说，思考如何使这个平台成为一个不需要分叉的可扩展平台非常重要，我们可以与社区合作，而不是推出一些社区可能会采用的东西，但却不知道如何才能做出贡献。”

网飞开始将 Asgard 的继任者不仅仅视为一个部署工具，而是一个持续的交付平台。因此开始了后来被称为 Spinnaker 的项目工作。

当网飞的核心团队在开发 Spinnaker 时，网飞还有另一个部署管理项目，由网飞 edge 开发者体验总监 Sangeeta Narayanan 领导。他们正在为自己的需求构建特性和功能，因为他们不能等待集中的团队完成他们正在开发的产品。

Marsh 解释说，Edge Center API 团队有非常迫切的需求；他们需要以安全、可靠和可重复的方式进行快速部署。当其他团队看到 Edge Center API 团队完成的工作时，他们希望使用该项目。这给边缘团队带来了不必要的压力，因为它不是集中团队的一部分，而且该工具不是为支持整个网飞而设计的。

集中式团队正在追逐 Edge Center API 团队正在开发的特性，并试图跟上。“如果我们想要集中一个工具，它将服务于整个网飞。我们需要在我们正在开发的工具中体现这些特性，”Marsh 说。Edge Center API 团队是为了一个非常明确的目的来解决一个问题，这使得他们可以跑得非常快，而集中式团队是为了解决整个组织的问题，所以他们必须慢慢地、小心地走。

随着时间的推移，很明显，集中式团队永远也赶不上 Edge Center API 团队。按照这个速度，集中产品将准备好供 Edge 团队在生产中使用。[安德鲁·格洛弗](https://www.linkedin.com/in/ajglover/)，网飞的交付工程经理，负责大三角帆。他会见了 Narayanan，并承认他的团队不可能跟上她的团队，并询问是否有一种方法可以联合起来，以便 Spinnaker 团队可以将 Edge 团队的需求构建到集中式工具中。

Narayanan 给了他两个开发人员，他们在这个项目上工作，这样他们可以将 Edge Center 团队的特性和上下文带到集中的团队中。Edge Center 团队正在开发一个持续的交付工具，而 Asgard，在其初期，是一个交付工具和基础设施管理工具。他的两个团队一起工作，最终的产品是一个持续交付的基础设施管理平台。“Spinnaker 将这两种功能结合在一起。它被设计成一个可插拔的架构，”Marsh 说。

网飞于 2014 年开始在内部使用 Spinnaker，并于次年开源。基于该公司在 Asgard 方面的经验，网飞确保 Spinnaker 解决了 Asgard 社区面临的大多数问题。网飞与一些合作伙伴一起开发了多云战略，并构建了可插拔架构。

开发团队与谷歌、微软和许多其他公司合作。因此，Google、Microsoft、Amazon、Pivotal 甚至 Oracle 都能够在其环境中使用 Spinnaker。不需要叉子。这个圆圈是完整的。这些公司受益于网飞的创新，反过来，网飞也受益于社区的创新。这是纯粹的开源双赢模式。

## 工具和文化

“我们想提供护栏，而不是大门。我不想阻止你做一些事情，我想给你一些背景，为什么我们认为这可能是一个坏主意。我想确定你有做决定的所有背景。但我不想阻止你这样做，”马什说。

“开箱即用，Spinnaker 支持复杂的部署策略，如发布金丝雀、多阶段环境、红/黑(又名蓝/绿)部署、流量分流和轻松回滚，”谷歌产品经理[克里斯托弗·桑森](https://www.linkedin.com/in/christophersanson/)、[在博客文章](https://cloudplatform.googleblog.com/2017/06/spinnaker-10-continuous-delivery.html)中写道。“这部分是由于 Spinnaker 在云中使用了不可变的基础设施，对应用程序的更改会触发整个服务器群的重新部署。相比之下，为正在运行的计算机配置更新的传统方法会导致部署速度更慢、风险更大以及难以调试的配置漂移问题。”

网飞有一个多地区的环境，在这样的部署系统中，你真的不希望你的工程师同时在全球范围内推动所有地区的变化。

网飞给予开发者做出选择的自由，但是伴随着巨大的权力而来的是巨大的责任。所有这些都反映在 Spinnaker 中。

“工程师决定他们自己的部署策略。Spinnaker 内置了许多不同的策略。在连续交付管道中，我们让他们能够添加人工判断，”Marsh 说。人工判断听起来可能与持续部署背道而驰，但网飞给了它的开发人员这种选择。“我认为这给了他们建立对我们工具信心的机会，”Marsh 说。这就像你离开零售店前的最后一个窗口，在那里你仍然可以再次看到所有的东西。

然而，为了帮助开发者避免最终关闭流媒体服务，网飞希望根据服务的关键程度为开发者提供智能默认设置。与告诉用户你正在其他设备上观看什么或推荐什么节目的服务相比，流媒体电影或节目至关重要。如果这些服务出现故障，没什么大不了，但流媒体服务至关重要。Marsh 说:“我们希望以不同于对待其他服务的方式来对待这些核心服务和关键服务。

展望未来，她说，声明式连续交付提供了一种能力，可以更抽象地描述部署的内容和位置。它解放了开发人员，让他们专注于他们试图解决的领域和问题。“我们承担了部分责任，他们给我们一些配置信息，而不是他们想要部署到什么特定的实例类型，或者他们想要使用什么特定的参数，”她说。“人们确实希望更多地关注他们将要解决的问题，而不是每个人都了解构建部署的细节。”

## Spinnaker，开发者的感觉 8

网飞文化对大三角帆有很大的影响。“网飞的指导原则之一是，我们需要松散耦合但高度一致。这意味着团队自己有责任与其他团队就他们正在做的事情以及他们可能对其他人产生的影响进行沟通，”Marsh 说，“Spinnaker 使这些团队能够经历各个阶段，以确保他们在部署改进而不是倒退服务的东西的过程中充满信心。”

达信坚信组织文化与其开发或使用的工具之间的关系。“技术可以影响文化，文化可以影响工具，”Marsh 说。她说，理解当我们制造工具时，它们反映了我们的文化，这一点非常重要。“如果我们没有在这些工具中反映文化，我们可能会用我们的工具挑战文化。这是两种非常不同的方法，需要以非常不同的方式处理，”Marsh 说。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>