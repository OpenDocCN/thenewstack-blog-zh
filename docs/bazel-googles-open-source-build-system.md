# Bazel，Google 的开源构建系统

> 原文：<https://thenewstack.io/bazel-googles-open-source-build-system/>

软件开发人员生活中最重要的应用程序之一是 Make 实用程序或其等价物。Make 最早出现在 1977 年，之后一直伴随着我们。有非常多的构建工具，有些基于 Make，有些则完全不同。原理是一样的。构建系统有一组规则，告诉它如何从源文件构建应用程序，这些源文件通常是从版本控制系统获取的。Make 实用程序读取规则，然后运行编译器和连接器进行构建。真正好的也会进行测试。

谷歌一直在使用他们自己的系统，名为 Blaze，并将其中的一部分开源为语法名为[的 Bazel](http://bazel.io/)——最近以 alpha 状态发布。在这篇文章中，我将给出一个关于 Bazel 的概述。

那么巴泽尔有什么不同呢？它旨在做两件事:快速正确地构建。它使用了一个巨大的共享代码库，所有的软件都是从源代码构建的。速度是通过缓存和并行来实现的。Blaze 解决的问题与 Bazel 略有不同，因为它是为谷歌的内部系统设计的。任何谷歌工程师都可以通过调用 Blaze 命令在任何机器上从源代码构建任何谷歌产品。以下是一名谷歌工程师在[黑客新闻](https://news.ycombinator.com/item?id=9256844)上对 Blaze 的评论:

在谷歌工作，Blaze 是最让我惊讶的技术之一。任何工程师都可以在任何机器上通过调用 Blaze 命令从源代码构建任何谷歌产品。我可能不想从源代码中构建 GMail(可能需要一段时间)，但知道我可以这样做真是太棒了。

我认为这对非常大的开源项目(如数据库或操作系统)非常有用，这些项目可能会让贡献者不敢去构建和测试。

## 使用巴泽尔

Bazel 处理包——相互依赖的文件集合，子目录——和子包。每个包都是一个目录，包含一个名为 BUILD 的文件。

这些包将目标定义为文件或规则。文件可以是源文件，也可以是由诸如。obj 文件或资源文件。规则描述了如何从输入文件生成输出文件，包括其他规则，以及构建输出文件所需的步骤。

Bazel 在 Linux 和 Mac 环境下作为客户机服务器运行。Windows 目前似乎不是 Bazel 团队的优先考虑事项，大概是因为他们没有为其开发，并且这不是他们内部使用的平台。

客户端是基于命令行的，使用“bazel”命令调用客户端，或者使用“bazel test”命令运行测试。Bazel 客户机与一个长时间运行的服务器对话，如果它不存在，就启动一个；每个工作区有一个服务器，它是一个包含您正在构建的源代码的目录。Bazel 旨在避免 Make 过程中的错误问题，这需要在修复错误后重新构建一切之前进行“清理”。Bazel 中构建阶段的成功或失败都在数据库中进行跟踪，如果输入阶段没有改变，那么就不会发生重建。Bazel 保证在一个成功的构建之后，在此期间没有进行任何编辑，构建将处于一致的状态。

### 编程语言支持

Bazel 背后的技术主要是 Java 和 Bash 脚本。为 C/C++、Objective-C、Java、Python 和 Bourne Shell 脚本提供编程语言支持。目前 Bazel 处于 alpha 阶段，但它计划添加 JavaScript，并在 2015 年 6 月[日](http://bazel.io/roadmap.html)达到 beta 后继续。

### 扩展 Bazel

Bazel 可以通过[云雀](http://bazel.io/docs/skylark/index.html)语言扩展规则和宏。宏是从构建文件中调用的函数，用于为构建创建规则。Skylark 的语法是 Python 的一个子集，尽管一些不支持的特性是 class、while、break、continue、lambda 和其他一些特性。它还是线程安全的，数据结构是不可变的，全局值是常量，不能重新分配，变量类型也不能改变。这些限制有助于加速构建，因为它们允许部分构建并行运行。

### 测试支持

Bazel 构建规则定义了由命令“bazel test”运行的自动测试。测试运行器处理多个测试可执行文件，这些文件是通过运行测试规则创建的，并且是有时间限制的，这取决于测试的大小或指定的超时。[测试百科全书](http://bazel.io/docs/test-encyclopedia.html)强烈建议将测试减少到最小的依赖性，这样结果就可以可靠地重现。

### 巴泽尔查询

一个特别强大的特性是 Bazel 查询语言，它用于分析构建依赖关系。这涉及到一个学习曲线；然而，对于更简单的构建，您甚至可能不需要它。基本上，您将过滤器应用于返回目标。这些可以是路径、文件、规则等。这是一个强大的系统，图论的知识会派上用场！

## 结论

鉴于谷歌构建了大量的软件，看到他们推进构建技术的发展是令人鼓舞的。但是请注意，这些规则中只有 10%是开源的，其余的都是特定于 Google build 的，所以对于局外人来说没有意义。

Bazel 特别针对具有以下特征组合的项目:它们有一个支持多个平台的大型共享代码库，它们用多种语言编写，并有一个广泛的测试套件。如果那是你的项目，仔细看看巴泽尔。

鉴于许多企业使用 Windows 并为其开发软件，我想知道这是否会限制 Bazel 的使用。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>