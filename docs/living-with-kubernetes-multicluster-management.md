# 与 Kubernetes 一起生活:多集群管理

> 原文：<https://thenewstack.io/living-with-kubernetes-multicluster-management/>

[](https://www.linkedin.com/in/justingarrison/)

 [贾斯汀·加里森

贾斯汀是亚马逊网络服务(AWS)的高级开发人员。](https://www.linkedin.com/in/justingarrison/) [](https://www.linkedin.com/in/justingarrison/)

基础设施有蔓延的趋势。数据中心处理服务器蔓延和虚拟机蔓延。随着容器的出现，管理员通过诸如 Kubernetes 之类的编排系统来适应容器的蔓延。许多环境现在已经达到 Kubernetes 集群蔓延的阶段，这意味着管理员必须找出管理和部署到数十或数百个集群的最佳方式。

使用多个集群有很多理由。建议为应用程序环境和区域建立不同的集群。如果您的应用程序在团队之间有不同的计算需求或安全界限，您可能需要更多的集群。这个数字快速增长的原因与服务器和虚拟机一样。

历史上，我们通过创建工件将维护负担转移到构建时间而不是运行时间来解决蔓延问题。例如，定制亚马逊机器映像(AMI)有助于部署大量[亚马逊弹性计算云](https://aws.amazon.com/ec2/)(亚马逊 EC2)实例，自动化我们部署的资源的生命周期管理，例如管理服务器的配置管理，或添加额外的管理层来协调一组资源，如控制一组服务器的自动扩展组。

Kubernetes 目前没有办法将所有东西捆绑到一个包含运行集群所需的所有二进制文件和配置的工件中，因此使用自动化和附加管理层是我们的最佳选择。每种模式都适用于不同的关注领域，所以要注意你的目标是什么。

多集群管理也会影响应用程序:如何将应用程序部署到多个集群，如何在集群之间公开服务，以及如何配置灾难恢复。所有这些主题都有很多选项，取决于您的环境和需求。

在本文中，我们将关注集群配置和管理选项，以帮助负责 Kubernetes 控制平面的工程师。

## 多集群需求

创建您的第一个集群可能是一个陡峭的学习曲线。即使有了托管的 Kubernetes 选项，仍然有一些组件需要您负责。当您开始理解需求时，您就能够自动创建集群并部署一些标准配置，比如网络插件和容器运行时。

随着环境的增长，您可能需要考虑其他方面，以确保能够满足您的业务需求和维护群集的要求:

*   配置和默认服务
*   集群发现
*   访问和安全性
*   修补和生命周期管理

如何解决这些问题的细节将取决于您的环境、工具和需求。我们无法为您解决所有这些问题，但我们会关注这些领域以及您应该如何考虑它们。

## 配置和默认服务

配置和默认服务高度依赖于您的安装工具。如果您的工具是定制的，它们可能没有考虑不同的配置。您可能从一个公共基础开始，如 Kubernetes 版本和基础服务，然后扩展到允许您的配置包括其他计算资源、存储和网络选项。

您可能会使用 [Terraform](https://www.terraform.io/) 、 [eksctl](https://eksctl.io/) 、[集群 API](https://cluster-api.sigs.k8s.io/) 或类似于 [kubespray](https://github.com/kubernetes-sigs/kubespray) 的工具来部署您的集群。在每种情况下，您都有创建集群的方法，但是您可能并不总是能够在部署时安装您的默认集群服务，例如 [metrics server](https://github.com/kubernetes-sigs/metrics-server) 、 [AWS 负载平衡器控制器](https://github.com/kubernetes-sigs/aws-load-balancer-controller)或 [fluent-bit](https://github.com/fluent/fluent-bit) 。

还存在持续的配置需求，以添加自定义资源、节点标签或在集群之间同步配置映射和机密。不管你需要什么，很明显没有一个工具可以做所有的事情。将集群创建(例如服务器和负载平衡器)与配置(例如工作负载存储和网络)分离是一个好主意。随着您的需求变化和所有权适应您的使用情形，它允许更大的灵活性。

您的集群部署可能会采用某种形式的数据表示，比如 YAML，它允许您的工具创建集群。如果您有一个部署集群的集中式团队，他们可能会有一个包含所有集群配置的单一 repo。如果较小的团队负责部署和管理他们自己的集群，他们可能会将配置保存在单独的存储库中。

集中式回购的一个问题是，您的回购将随着集群数量的增加而增长，并且很难测试升级和通用配置等方面的变化。monorepo 最终会使用复杂的 CD 系统，只对特定的子目录应用更改，并且它可能会有多个升级和回滚的协调步骤。

随着时间的推移，对单一回购协议进行变更的风险会越来越大。针对每个集群、应用、团队或环境的回购将需要多次提交和审查，以协调变更。这是额外的工作，在大型环境中更难验证。

第三种方法用于工具，如配置管理，即将较小的 repo 用于常见配置，并使用将多个 repo 组成一个集中部署的工具。像 [Flux](https://fluxcd.io/) 这样的工具可以实现回购组合，允许不同的集群绑定到特定的分支或标签，这可以帮助集群根据需要更快或更慢地适应变化。

持续的配置将需要不同于集群创建的工具。在这种情况下，我们可以使用 Kubernetes 控制器模式从 Git repo 或 CRD 中读取数据，然后将这些更改应用到一个集群或一组集群。如果你是 GKE 的客户，像[配置同步](https://cloud.google.com/anthos-config-management/docs/config-sync-overview)这样的工具可以解决这个问题。如果你有一个自我管理的集群，一个 [GitOps](https://www.weave.works/technologies/gitops/) 控制器可能是你最好的选择。

## 集群发现

一旦您有了多个集群，您将需要某种方法来找出谁负责哪个集群，什么服务在哪里运行，以及集群内的服务如何发现彼此。在许多方面，这类似于[配置管理数据库，](https://en.wikipedia.org/wiki/Configuration_management_database)传统上存储在电子表格中，用户可以参考它来找到他们需要的服务器。在 Kubernetes 的情况下，您将希望使用更新的技术，比如定制资源，以允许更频繁的更新并将其用于自动化。

对于服务器，我们称之为“服务发现”，对于多个集群，我们可以依赖类似的模式。我们需要一个单一的位置来存储有关集群、服务和端点的信息。我们还需要一些方法来查找这些信息并调用所需的端点。

对于托管服务，您的集群清单可能是您的提供商的服务仪表板。您可以查看您的所有集群，并通过提供商的 API 实现它们的自动化，但附加元数据/标签或使用集群命名方案来了解它们的用途或负责人将由您决定。

对于自我管理的集群，最好您的用于部署和管理集群的集中式工具拥有这些信息。像 Cluster API 这样的工具允许您将元数据放在集群定义资源上，以帮助您识别这些信息。您还可以将信息作为元数据存储在用于在 Git 中部署集群的数据文件中。

Kubernetes 服务使用 CoreDNS 来发现端点。DNS 是允许服务找到彼此的好方法。我们还可以将 DNS 用于集群或服务网格之类的工具，用于服务到服务的发现和跨集群通信。

像 [ExternalDNS](https://github.com/kubernetes-sigs/external-dns) 和 [Admiral](https://github.com/istio-ecosystem/admiral) 这样的工具试图解决这个问题，还有 [Kubernetes 集群联邦特殊利益集团(SIG)](https://github.com/kubernetes-sigs/kubefed) 。如果您对让您的服务跨多个集群工作感兴趣，我建议您参与 KubeFed SIG。

## 访问和安全性

对于多集群的使用，我们应该讨论一些安全问题:

*   某人如何访问群集并向群集标识自己(身份验证)
*   他们在集群中可以做什么(授权)
*   管理秘密

在多集群环境中考虑这些事情实际上是为了集中管理。单点登录(SSO)可以帮助对多个集群中的用户进行身份验证，并且根据您基于角色的访问控制(RBAC)需求，传统的 CI/CD 工作流或 GitOps 可以帮助管理多个集群中的权限。

单点登录可以是与您运行的外部身份提供商或通过您的云提供商的集成。像 [dex](https://github.com/dexidp/dex) 这样的工具可以帮助您设置 OpenID Connect 身份验证到具有各种提供者的集群。如果你使用云提供商，像 [aws-iam-authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator) 和身份和访问管理(iam)这样的工具是你应该使用的。

授权依赖于集群中的 RBAC。这需要角色并定义他们可以对集群中的资源执行的操作。这非常灵活，并且高度依赖于您组织的需求。

在这方面有一个工具可以提供帮助，那就是 [audit2rbac](https://github.com/liggitt/audit2rbac) ，它可以获取 Kubernetes 访问日志，并将它们转换成 rbac 资源定义。 [rbac-tool](https://github.com/alcideio/rbac-tool) 和 [rbac-audit](https://github.com/cyberark/kubernetes-rbac-audit) 是允许您审计集群中现有 rbac 权限的其他选项。

您还需要允许工作负载通过服务帐户和角色绑定来访问 Kubernetes API，可能还有云资源。如果你是 GKE 的客户，你可以通过[工作负载身份](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)来完成，在[亚马逊弹性 Kubernetes 服务](https://aws.amazon.com/eks/)(亚马逊 EKS)你可以使用 [IAM 服务账户角色(IRSA)](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html) 。

将 RBAC 规则应用到多个集群与任何集群配置有相同的问题。如何应用和验证规则将取决于您的工具，但是您应该能够像进行任何配置一样将它应用于多个集群。

您的应用程序经常需要秘密，有几种方法可以获得它们。第一种是创建本机秘密资源，并在集群之间同步它们。这适用于一些集群，但是一旦你需要排除秘密或者集群，事情就变得复杂了。

更好的方法是使用云提供商的秘密管理产品或类似于 [Hashicorp Vault](https://www.vaultproject.io/docs/platform/k8s) 的工具来集中秘密存储。就像 SSO 一样，我们可以集中管理秘密，然后 pods 可以在运行时访问信息。这使得排除和许可更容易，撤销机密更快。

## 修补和生命周期管理

我们在之前关于集群升级的文章中讨论了补丁和生命周期管理。这些模式仍然适用于单个集群，当您有多个集群时，有些模式会更好。对于大量集群，您需要考虑的主要问题是集群之间的协调，这样就不会有太多的更新并行发生。

通过一次执行大量集群升级，您可能会因为配置不良或相关资源过载而破坏更多东西。如果您的所有集群都从容器注册表中提取映像，您可能会遇到限制或伸缩问题，这些问题可以通过进行较慢的部署来解决。

与任何 Kubernetes 资源一样，使用声明式配置是一个不错的选择。像 [kOps](https://github.com/kubernetes/kops) 和集群 API 这样的工具可以将升级应用到集群控制平面。协调您想要一次升级多少个集群，以及以什么顺序升级，将是您的责任。

即使您使用完全托管的 Kubernetes 解决方案，如亚马逊 EKS 和[托管节点组](https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html)，协调集群升级仍然是一个好主意。总是建议先升级较低的环境集群，然后再进入生产环境。度量和自动化是成功的关键。相信你的工具在没有人工干预的情况下做正确的事情将会让你的团队扩展。

## 结论

对于多集群 Kubernetes 管理，一些事情可以用简单的脚本来处理，以便在任何地方应用相同的资源。但是在某一点上，您可能会超越该选项，并且需要更多的逻辑来应用于集群的配置位置和方式。

在这个领域，越来越多的工具和服务被频繁地开发出来，所以请务必查看您的提供商提供的最新选项。在任何情况下，我们都不需要发明新的模式，因为长期以来，蔓延一直是基础设施的一个问题。

在可能的情况下，重用带有 CRDs 的 Kubernetes 状态存储，并在需要时重用控制循环模式。将您当前的需求与自动化紧密结合将让您快速提出解决方案，但是将您当前的实现与需求分离将有助于您随着时间的推移进行扩展。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>