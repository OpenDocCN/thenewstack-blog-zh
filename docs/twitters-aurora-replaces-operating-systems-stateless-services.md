# Twitter 的 Aurora 如何用无状态服务取代操作系统(第 2 部分)

> 原文：<https://thenewstack.io/twitters-aurora-replaces-operating-systems-stateless-services/>

这是我们关于 Twitter 的极光项目系列的第二部分。在…里

[part one,](https://thenewstack.io/twitters-aurora-relates-googles-borg-part-1/)

斯科特探索了一个没有操作系统的未来，以及这是如何在受到谷歌博格影响的项目中表现出来的。在第二部分中，Scott 探讨了 Aurora 如何应用于任何公司，无论其规模如何。

很难想象所有可能通过网络作为服务提供的软件最终会发展到 Twitter 的规模。然而，关于 Apache Aurora——Twitter 正在开发的微服务架构，它正在为开源社区做出贡献——有一个新出现的事实不容忽视:它没有建议或要求它必须以 Twitter 的规模部署才能对其他人有用。

> 这就是 Aurora 成为开源项目的原因，也是它可能会改变世界各地每个数据中心工作方式的原因。

在 Twitter 管理 Apache Aurora 项目系列的第 1 部分中，新的堆栈向您介绍了 Bill Farner。前几年，作为一名谷歌开发人员，法纳观察了谷歌内部构建的第一个微服务架构，称为 Borg。特别是，他注意到了它的缺点，并将这些经验应用到他后来在 Twitter 担任 Aurora 首席工程师的工作中。

在过去的十年中,“失败的鲸鱼”成为了整体架构缺陷的象征，因为他们试图达到……嗯，Twitter 的规模。因此，在 2010 年，法纳领导努力将 Twitter 带入一个全新的存在框架:一个桌子被翻转，服务器从属于工作的框架。

## 故障域

在互联网规模上，服务器更像蚂蚁。它们不包含工作，而是对工作有贡献。作业远远大于任何一台服务器或服务器集群。当服务器出现故障时，作业会补偿它们的损失，工作继续进行。因此，管理像 Twitter 这样庞大的进程就成了一种管理蚂蚁的练习。

如果你曾经研究过北美的蚁丘和南美的蚁丘，你会注意到没有两个设施提供相同的性能。

Farner 在与新堆栈的电子邮件交流中解释道:“典型的 Aurora/Mesos 集群局限于一个物理设施内，其中数据中心内的延迟被认为相对一致。“这允许平台的用户基于他们的上游和下游服务依赖性做出归航决策。换句话说，这是一个发生在全球层面的‘人为调度’决策。”

因此，法纳继续说，尽管 Twitter 各种设施中的机器不会是彼此的副本，但在 Twitter 内运行的服务的所有者有权选择他们将使用的集群以及每个集群将消耗的容量。“容量规划人员和产品预测人员有责任确保我们(Twitter)有足够的容量，不会阻碍产品开发，”他表示。

然而，像英特尔这样的制造商当然可以改变处理器的性能。ARM 等竞争对手可以向服务器组合中添加新的架构。尽管像脸书这样的大批量购买者可能会提供他们允许这些配置文件变化的指导原则，但服务器硬件技术的发展比任何单个服务器的使用寿命都要快。因此，某些地方的某些软件必须减轻性能差异，因为即使是“普通的”概念，对于服务器来说，在三年的时间框架内也会发生根本的变化。

用来减轻这种世代差异的是操作系统。如果你写了一个与操作系统紧密结合的软件，那么当操作系统移植到新一代硬件时，软件不会崩溃。

今天的微服务环境，包括那些运行在 Apache Mesos 上并由 Aurora 提供调度和编排的环境，颠倒了软件和硬件之间的整个关系。这种环境中的传统操作系统，例如 Linux，仍然可以保持每个服务器单元的功能。另一个 Linux 可以为应用程序和服务维护容器内部的操作环境。但是像 Linux 或 Windows Server 这样的操作系统已经不再是作业控制系统了。在这个颠倒的世界里，没有一台服务器运行一个域。

Twitter 的 Farner 说:“在构建 Aurora 的过程中，对我来说非常重要的一点是，我们不会与外部系统紧密耦合。

“Aurora 目前假设所有内核都是平等的，但事实绝对不是这样，”他继续说道。“最大限度地减少硬件配置文件的数量很有帮助，但是在大型集群中，总会有旧平台在使用，而新平台会取而代之。解决这一问题的策略是非常有弹性的软件，可以处理单个主机速度慢的问题(因为不管平台差异如何，这都是事实)，以及对水平扩展的偏好。虽然这实际上依赖于大数定律，但重要的是，我们(Aurora)不允许我们的开发人员构建与硬件平台相耦合的软件。”

## 动物农场

这类似于每个技术作家在面向全球读者出版时面临的问题:信息必须翻译给所有的眼睛和耳朵。Farner 认为，Mesos 驱动的环境中的弹性软件将服务器和集群视为非独特的单元，并将单个任务视为无状态服务。

这个概念听起来比实际情况更严峻。如果你已经开发过 Web，你就会知道 API 调用期望一个离散的数据包以一种规定的、通常是统一的方式进行交换。客户端程序从不期望必须关心处理调用的服务器函数的状态——它服务的最后一个客户端是否以某种方式改变了它，或者它是否使用了某些可能以某种不可预见的方式影响输出质量或可靠性的寄存器。服务器的状态对客户端来说无关紧要，这就是 REST 协议在 Web 上工作的原因。

法纳告诉我们，如果状态在微服务架构中很重要，那么这些服务就不会在机器之间或操作系统之间重新定位。然而，如果开发人员将他们的微服务架构设计成真正的无状态，并利用服务注册和发现系统(Twitter 使用 [Apache ZooKeeper](https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index) )在服务和它们运行的不同配置的系统之间提供一个抽象层，那么他说，将这些服务迁移到 Mesos/Aurora 平台的过程将是“无操作的”

正如你可能想象的那样，正如法纳回忆的那样，Twitter 一开始并不是一件没有用的事情:

“事实上，我们[Aurora]早期采用的许多服务都遵循了最佳实践，但他们在迁移到 Aurora 之前也试图最大限度地降低硬件成本。这意味着他们试图让每个进程(或实例)消耗机器上的全部 CPU 和 RAM。在一些不幸的情况下，这实际上影响了软件的架构(这也是有问题的，因为无论如何，迁移到一个新的平台对他们来说都是困难的)。对于像 Aurora 这样的平台，我们强烈希望实例的大小是机器的几分之一，因为这允许 Aurora 执行更好的装箱，并实现更高的全局硬件利用率。”

> Twitter 在这个世界上的主要功能解释起来非常简单:向人群传播短信。

Twitter 的每一项功能都是这项主要工作的延伸。然而，在 Twitter 已经达到的规模上，这项简单的工作是不可能用 20 世纪为计算设计的整体架构来完成的。Mesos 和 Aurora 与第一个分布式操作系统的不同之处，就像土星 V 火箭与泰坦 II 的不同之处一样。但是如果推特没有遇到太多次失败的鲸鱼，这种非常不同的工作方式可能不会被想到。

法纳认为，即便如此，Aurora 项目的突出因素并不是 Twitter 的内在因素。“当然，最大的区别在于，”他说，“我们的平台是开放的，任何人都可以利用并为之做出贡献。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>