# 作为代码的监控:它是什么以及为什么需要它

> 原文：<https://thenewstack.io/monitoring-as-code-what-it-is-and-why-you-need-it/>

[](https://sensu.io/)

 [肖恩·波特

肖恩·波特是 Sensu 项目的创建者，也是开源监控领域的领导者 Sensu Inc .的联合创始人兼 CTO。Sean 是一名经验丰富的系统操作员和软件开发人员，在自动化基础设施方面有十年的经验。作为 Sensu Inc .的首席技术官，他监督 Sensu 的开发，并与用户合作，以更好地了解 Sensu 如何帮助他们解决复杂的监控问题。](https://sensu.io/) [](https://sensu.io/)

“一切如代码”已经成为采用 DevOps 和 SRE 实践的领先组织的现状，然而，监控和可观察性已经落后于应用程序和基础架构交付的进步。术语“作为代码监控”无论如何都不是新的，但是将监控自动化作为基础设施作为代码(IaC)计划的一部分并不等同于作为代码监控的完整的端到端解决方案。代码监控不仅仅是代理、插件和导出程序的自动安装和配置，它涵盖了整个可观察性生命周期，包括自动诊断、警报和事件管理，甚至自动补救。

持续集成和持续交付(CI/CD)彻底改变了我们构建和部署应用程序的方式。随着 DevOps、基础设施即代码和容器化的出现，基础设施和 IT 管理变得分散化。现在，组织可以更加敏捷，更快地交付高质量的软件。CI/CD、配置管理、基础设施即代码和云计算都是作为工具出现的，以促进这种高速变化，但直到最近，监控工具仍在对现代 IT 环境的变化做出反应。

全面的 CI/CD 计划应包括监控和可观察性。在这篇文章中，我将研究代码监控如何填补这个空白。

但首先，简要介绍一下 CI/CD 的历史。

## CI/CD 和 IaC:简史

在过去的 10-15 年里，IT 运营界发生了很大的变化。尽管现在在一个组织中发现 CI/CD 管道非常普遍，但这是一个相对较新的概念。在开始的时候，有持续的集成，CI 仅仅被认为是测试和构建应用程序的开发工具，而不是自动化其他操作问题。

在约翰·奥尔斯堡(John Allspaw)2009 年的演讲《T0》“每天 10+部署”、Jez Humble 和大卫·法利(David Farley)2010 年的著作《T2》中，“持续交付”的时代，一切都变了。我们意识到，我们可以用 CI 做更多的事情，而不仅仅是构建和测试应用程序代码——我们还可以自动化部分发布和部署过程……因此，CI/CD 管道诞生了。

在我们意识到这一点之前，“作为代码的基础设施”这个术语就已经进入了方言，并且成为了 DevOps 运动的一个主要的基础元素，允许开发人员和操作人员提高速度，同时提高可重复性、可靠性和可维护性。[正如我之前所说的](https://thenewstack.io/infrastructure-as-code-evolution-and-practice/)，通过以同样的方式对基础设施和应用程序部署进行编码，您为从基础设施到应用程序的所有配置状态建立了一个框架——一个真理之源。以代码形式管理基础架构意味着我们可以将基础架构集成到这个新的 CI/CD 管道中。

## 新的*新的*基础设施作为代码，以及可观察性在其中的位置

快进到今天:CI/CD 和 IaC 继续发展，通过 Kubernetes 这样的平台进行集装箱化和集装箱编排是新的常态。作为代码的第一代基础设施更为真实，因为我们花了大量时间使用复杂的 DSL 或像 Ruby 这样的实际编程语言编写“代码”。有了 Kubernetes，我们有了一个通用的打包解决方案(容器),并且能够将更多的底层基础设施描述为声明性的 YAML“代码”这降低了进入壁垒，使许多组织更容易获得 IaC。现在，您可以在几分钟内而不是几个月内实现应用程序部署的自动化。

CI/CD 的巨大成功创造了对“一切如代码”解决方案的永不满足的需求。尽管仍有更多的工作要做，像容器和 Kubernetes 这样的工具和平台已经不断成熟，并将基础设施作为代码原则带给了大众。但是，这将把监控和可观察性留在哪里呢？

## 以监控为代码将可观测性集成到 CI/CD 管道中

最先进的组织已经得出了一个结论，我们认为该行业的其他组织将在 CI/CD 的下一个十年里得出这个结论:将更多的持续运营功能纳入我们的交付管道是当务之急，其中最主要的是监控和可观测性。

在当今时代，任何构建和部署应用程序的人都需要像定义和部署基础设施一样集成监控功能:通过集中式管道作为代码。随着软件组件数量的增加(例如微服务)或组织单位数量的增加，这对于操作安全变得更加重要。

纳入对受管理基础设施的主动监控会产生一种共生关系，在这种关系中，会自动收集和检测新的指标和故障，以响应代码更改和新的部署。作为代码进行监控是这个世界的统一视图和整个应用程序生命周期管理的关键。

## 作为监控代码的基础设施不同于作为代码的监控

当我们在网上搜索“作为代码的监控”时，我们会发现许多来自各种流行监控工具的博客文章。但随着我们深入挖掘，他们所描述的不是作为代码的监控，而是简单地部署代理或使用配置管理工具(如 Puppet、Chef、Ansible、Terraform 或 Helm)配置导出器，即作为部署监控代码的基础架构。除了简单的数据收集之外，这些解决方案没有提供配置大部分监控解决方案的方法。这在很大程度上是尝试将传统监控工具和工作流改造成现代 DevOps 范式的结果。

“现有的大多数 as 代码监控选项仅限于数据收集配置；他们缺乏将你从 Sensu 等工具中获得的反应式逻辑和自动化进行编码的能力。”——首席软件工程师@财富 1000 强金融科技组织。

观看这段 8 分钟的讲解视频，了解 Sensu Go 的监控代码:

[https://www.youtube.com/embed/eUZTMdYtCmg?feature=oembed](https://www.youtube.com/embed/eUZTMdYtCmg?feature=oembed)

视频

通过这种方法，开发人员可以构建、测试和部署他们的应用，并通过统一的 CI/CD 管道监控数据收集，然后完全在该管道的带外管理监控解决方案的其余部分(例如，通过单击基于 SaaS 的监控仪表板中的按钮来配置警报规则和集成)。代码形式的全面监控包括收集、诊断、警报、处理和补救(自我修复)，所有这些都定义为代码。

作为代码的端到端监控应包括:

*   **插装**:插件和导出器的安装和配置。
*   **调度和编排**:监控作业的管理(如收集、抓取)。
*   **诊断**:收集额外的上下文(例如，自动分类，包括验证配置、检查日志文件等)。
*   **检测**:可观察性事件的编码评估、过滤、重复数据删除和关联。
*   **通知**:警报和事件管理的编码工作流，包括自动创建和解决事件。
*   **处理**:将指标和事件路由到数据平台，如 Elasticsearch、Splunk、InfluxDB 和 TimescaleDB，用于存储和分析。
*   **自动化**:整理补救措施，包括与 Ansible Tower、Rundeck 和 Saltstack 等 runbook 自动化平台的集成。

“一切如代码”运动的主要好处之一是版本控制，它提供了逻辑“检查点”,代表我们的系统在给定时间点的状态。如果完整的监控和可观察性解决方案没有以与它们监控的系统相同的方式(作为代码，通过集中式 CI/CD 管道)进行管理，它就会变得不耦合，使得很难或不可能随着时间的推移进行推理。通过将真正的监控作为代码，您可以获得与产品和服务的构建、测试和部署相一致的监控版本控制，从而提高可见性、可靠性和可重复性。

“代码监控解决了许多项目的一个问题，即生产前测试或部署期间的意外问题未被发现。我们失去了允许失败的测试继续的时间，然后更多的时间来解决问题，当然，我们错过了在失败点调查根本原因的机会。借助通过单一、统一的管道与应用一起部署的监控，我们可以及早发现任何问题，避免手动照看测试和 CI/CD 流程。”— Seng Phung-Lu，道明银行 AVP 站点可靠性工程、DevOps 工具工程和云监控

例如，借助 [Sensu](https://sensu.io/) ，您可以将整个端到端监控解决方案定义为声明性 JSON 或 YAML 代码，包括收集、诊断、警报、处理和修复(自我修复)。当一个新的端点启动时(比如云计算实例或 Kubernetes Pod)，Sensu 会自动向平台注册，并开始收集监控和可观察性数据；自动诊断、警报管理和服务补救都被定义为代码。有了作为代码实现的完整监控，您可以消除现有的部署，并以可重复和可靠的方式恢复它们；正如 Seng 在上面所评论的那样，这也为生产前环境提供了额外的好处。

如果您已经在 CI/CD 和 IaC 上投资，那么您已经有了版本控制、构建、测试和部署软件的管道。只有让您的监控经历相同的生命周期才有意义——这都是相同工作流程的一部分。都是综合的。

## 展望未来

由于代码工作流是一种规范，在持续集成、持续部署和基础架构之后的下一个逻辑步骤是作为代码进行监控——自动监控我们的系统，作为代码，与管理下的应用程序和基础架构相结合。

在过去的 10 多年里，CI/CD 成为我们构建、测试和部署基础设施和应用的基础。在未来 10 年，我们将看到应用程序生命周期的其余部分(包括监控和可观察性)作为代码进行管理，并集成到同一管道中。在不久的将来，您将拥有真正的时间点上下文来全面了解您的关键基础架构，并拥有与您的应用程序的构建、测试和部署相一致的版本控制。

*Caleb Hailey(Sensu 首席执行官)、Seng Phung-Lu(道明银行 AVP 站点可靠性工程)、Sean Simon(道明银行高级 IT 架构师)、&David Beaurpere(work day 首席软件工程师)对本报告亦有贡献。*

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>