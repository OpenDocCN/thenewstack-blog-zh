# 问与答:为什么可观察性数据采样会耗费开发团队的时间和金钱

> 原文：<https://thenewstack.io/qa-why-observability-data-sampling-can-cost-devops-teams-time-and-money/>

向高度分布式、云原生环境的转变继续需要更好的可观察性。随着开发人员和其他 DevOps 团队在地理上变得更加分散，疫情进一步加速了这一趋势，一个集中的系统来汇集和分析高基数遥测数据变得更加重要。

![Christine Yen, CEO of Honeycomb](img/88358818668d87be3183dde723b2e03a.png)

蜂巢首席执行官兼联合创始人 Christine Yen

为了帮助 DevOps 团队扩展他们的可观测性工具，领先的可观测性提供商 [Honeycomb](https://www.honeycomb.io/?utm_content=inline-mention) 发布了一个开源采样代理 [Refinery](https://github.com/honeycombio/refinery) 。Refinery 进一步“提炼”了组织越来越需要的高基数数据分析。Refinery 还补充了 Honeycomb 的企业产品，包括服务级别目标(SLO)、其获得专利的安全租赁、培训和其他支持。

新的 Stack 最近与 Honeycomb 的首席执行官兼联合创始人 [Christine Yen](https://www.linkedin.com/in/christineyen) 进行了交谈，讨论 Refinery 和 Honeycomb 的企业产品如何帮助 DevOps 团队满足当今通常非常苛刻的可观测性需求和许多其他挑战。这些挑战包括如何通过以可承受的方式按需访问正确的高基数数据来满足客户需求。

### Refinery 为挣扎于可观测性的 DevOps 团队解决了什么问题？他们以前是怎么过的？

对于绝大多数应用程序来说，收集可观测性数据的增量成本非常小，而且不引人注目。但是对于大规模运行的应用程序(每月生成数百亿次事件或每年生成数千亿次事件的应用程序)，突然之间，生成的每一个字节都可能累积成需要管理的海量数据和流量。在这种规模下，传输和保存系统生成的每一个可观测性数据远远超过了数据最初打算提供的好处。当您的可观测性数据流变成汹涌的洪水时，需要考虑一个权衡:在不破坏其他系统或您的银行的情况下，您到底需要多少数据来实现期望的结果？

对于以数千亿规模运营的企业来说，大多数应用程序的现实情况是，它们的绝大多数事件都是成功的，而且几乎完全相同。所以他们不需要保存大量的数据。相反，为了有效地调试他们的应用程序，他们需要的是保存一个成功(或“好”)事件的代表性样本，以此来比较不成功(或“坏”)的事件。简而言之，这就是抽样。对他们的可观察性数据进行采样给了他们一种方法来确保他们仍然能够完整地了解他们系统中的活动，同时将成本控制在可控范围内。

但是，到目前为止，这种取样方法是一种可怕的经历。大多数可观察性工具采用三种采样方法中的一种:

1.  一种简单的、钝力的恒定采样方法。
2.  一种黑箱、“相信供应商的逻辑”的抽样方法，不允许客户就对他们重要的事情发表意见。
3.  或者他们根本不采样，这在很大程度上导致了大量金钱的浪费。

在 Honeycomb，我们相信提供良好的默认值，但始终授权我们的客户保留控制权——这也适用于我们的炼油厂取样策略。我们的用户可以指定哪些轨迹不如其他轨迹有趣，并以不同的速率对它们进行采样，经常捕获罕见事件，很少捕获频繁事件。他们向 Honeycomb 发送一小部分可观测性数据，我们的可视化将在幕后进行数学运算，从收到的样本中重建整个数据集的视图。

Refinery 的一个核心优势是，它让您处于控制之中，并为您提供灵活性、选择性和透明度。它是开源的，因此任何人都可以理解它是如何工作的；这不是一个专有的魔法盒。我们为您提供了几种直观而复杂的方法来做出适合您的采样决定；我们不会神秘地为你制造它们。使用 Refinery，您总是可以控制您采样的数据，因此，您的可观测性解决方案将花费多少。

### 与 Honeycomb 之前的取样代理相比，Refinery 有何不同？

我们以前的采样解决方案不够灵活——它们的采样规则在代码中紧密耦合。具体来说，您必须在编译时链接我们的定制动态采样库并设置配置，而不是在运行时。Refinery 提供了更大的灵活性，不仅在配置方面，而且在部署和扩展选项方面。

炼油厂在客户的基础设施上运行。这使他们能够完全控制自己的数据，不仅节省了可观察性成本，还节省了所有基于云的应用程序的网络出口成本。

### 您能详细说明在提供工程团队交付最佳用户体验所需的采样数据和与访问这种高基数数据相关的成本之间的权衡吗？

绝对的。这可能会在回答介绍问题时回答，但我很乐意补充更多的细节。一般来说，采样是一种管理大量数据的方法。

没有一家大规模运营的公司会出于运营和可靠性目的保留所有数据，他们也不想这样做，因为您需要为您的监控和可观察性工具提供基础架构，这将使您的实际生产集群相形见绌。

通过采样，高流量客户可以获得其系统中正在发生的事情的草图，而不会产生巨大的高分辨率图片的成本。Refinery 使客户能够获得草图中重要细节的高分辨率视图。分布式跟踪的兴起在一定程度上规范了采样的概念。

例如，你不能在脸书或网飞尺度下保留所有痕迹的 100%。那么如何挑选最有趣最有代表性的 N %呢？但对于我们这些没有脸书或网飞规模预算的人来说，优化问题变成了:你如何以最低的价格得到最好的草图？

Refinery 将对话向前推进了一步:我们的用户可以将应用程序逻辑本身(在代码中)与“最有趣的”逻辑(通常受触及所述代码的生产流量的特征的影响)分离，但仍然可以根据自己的意愿对其进行定制。因为我们的产品经理不可能比你更了解你的流量模式，我们努力提供一个坚实的基线，同时允许你把它变成你自己的。

换句话说，驱动采样策略变化的条件几乎总是在代码本身之外，不可预测，并且极其特定于您的业务。以下是这种情况的几个例子:

*   众多客户中的一个客户突然增加了流量。
*   您的工程领导引入了一个性能计划来消除持续时间超过 N 秒的请求，这意味着您会发现持续时间超过 N 秒的事件非常有趣。

Refinery 允许我们的客户调整这些参数，以便控制发送给他们的监控和可观察性解决方案的数据量(从而控制他们的账单)。他们可以混合和匹配采样方案和规则。他们还可以在预演模式下测试这些策略，以便在测试新方法时不会意外丢失任何关键数据。

### 关于所谓的“可观察性的三个支柱”有很多讨论。这个概念如何以及为什么会创建重复的数据存储？为什么这是不必要的？

老实说，我的同事 Danyel Fisher，[蜂巢的主要设计研究员]，在他的新文章[中很好地解释了这一点，“‘可观察性的三个支柱’是如何错过大画面的。”](https://thenewstack.io/how-the-3-pillars-of-observability-miss-the-big-picture/)

这三个所谓的支柱只是三种不同类型的数据，你可以用来观察。三大支柱的讨论没有抓住要点。不是数据的问题。关键是你如何处理这些数据。当讨论集中在三种不同的数据类型时，很容易忽略这样一个事实，即您仍然只是在试图解决同一个问题。为什么您试图用三个不同的数据集来解决一个问题，这三个数据集在由不同类型的工具管理的不同数据存储中复制数据？喜欢可观察性定义的供应商喜欢它，因为他们有三种不同的工具卖给你。

可观察性是关于你可以理解你的生产服务内部正在发生的事情的新的和独特的方法，通过允许你以内聚的方式看到你的服务，这是单独的工具不能向你展示的，无论你如何尝试连接它们。没有必要用一个工具来存放结构化日志，用另一个工具来跟踪，用另一个工具来查看其他事件，比如指标。当我们谈到大规模运营的挑战时，这种类型的重复只会加剧问题。对于企业来说，维护这一切的效率非常低，非常浪费，最重要的是，成本高得离谱。

相反，我们应该做的是专注于如何用一套有凝聚力的能力来解决一个问题。工程团队需要一种可靠的方法来发现生产服务中的问题。对于那些他们发现他们开始关心底层数据类型的时候，因为他们的花费呈指数增长，这就是 Refinery 的用武之地。就像 Honeycomb 专注于改善您的可观测性体验一样，我们的采样产品可以帮助您改善大规模管理可观测性数据的体验。

### Refinery 如何以及为什么将可观测性数据合并到一个数据存储中(并因此取代“可观测性的三个支柱”的概念)？

Refinery 并不负责整合可观测性数据。refinery——以及一般的采样——是在发送大量数据时获得可靠的可观测性体验的成本效益所在。但是在拥有单一数据存储的主题上，我们认识到每个“支柱”都可以从一些其他数据源中计算出来。

在 Honeycomb，我们基本上将这些“支柱”中的所有数据视为相同。您可以获取任何日志数据，在其中放入一些跟踪 id 来定义一个层次结构，并使其成为一个跟踪。您可以根据日志数据或部分跟踪来计算任何指标的值。这是“三大支柱”营销的转移注意力的方法。所有这些数据本质上都是相同的，这“三大支柱”中的每一个都可以转化为另一个。断言有三种不同的重要数据类型是供应商的遗风，他们(方便地[对他们])有三种粘合在一起的遗留产品。他们更关心他们想要销售的三个 SKU，而不是考虑他们的客户试图用这些数据解决什么问题。

<svg viewBox="0 0 68 31" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Group</title> <desc>Created with Sketch.</desc></svg>