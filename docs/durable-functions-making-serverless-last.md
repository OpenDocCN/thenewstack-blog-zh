# Azure 持久功能:让无服务器持久

> 原文：<https://thenewstack.io/durable-functions-making-serverless-last/>

对于事件驱动计算来说，无服务器可能是一个令人困惑的名字，因为它太关注你不必关心的事情，而不是你能做什么。这个名字确实提醒了我们[无服务器平台](/category/serverless/)并不能帮助管理状态；虽然将状态外部化以便它不与应用程序的业务逻辑交互是一个好的实践，但是除了最简单的应用程序之外，所有应用程序都有需要管理的状态。

在[微软](https://azure.microsoft.com/en-us/?v=17.14)自有的无服务器服务 [Azure Functions](https://azure.microsoft.com/en-us/services/functions/) 中，新的持久功能是管理状态的一个选项，Azure Functions 的高级项目经理 [Chris Anderson](https://github.com/christopheranderson) 告诉新的堆栈，他希望看到其他框架和工具来帮助状态，以便可以与业务逻辑分离。毕竟，能够专注于该逻辑是无服务器的真正优势。

除了消除管理基础设施的负担，无服务器还消除了解决状态等问题的现有工具。“当我们只给你功能时，我们拿走了你过去拥有的很多东西，比如管理状态的框架。这就像试图在没有 ASP.NET 框架的情况下创建一个 web 服务器，所以你必须管理每个请求的工作流程的每一部分，只是跨越许多不同的服务。持久功能是实现不仅仅是点到点触发的第一步。”

持久函数处理管理应用程序状态的任务。“以前，客户必须自己管理所有外部状态，方法是将消息放在一个队列中，并在某个数据库中保存一份记录，记录作业的详细信息，这可能是大量数据。队列本身无法容纳大量数据；它只能保存一个指向更多数据的地方的指针。”

## 编排模式

持久功能旨在解决各种模式和场景，这些模式和场景使用触发器、计时器和通知会很快变得复杂，特别是在编排一系列活动时，这些活动包含一组复杂的任务，每次特定事件发生时都需要执行这些任务。

最简单的例子是事件的“直线”。“当我有一个任务时，会导致另一个任务发生，导致另一个任务发生，导致*另一个*任务发生……通过一些 if 语句和其他业务逻辑来分叉工作流，但我正试图从 a 点到达 b 点，”Anderson 解释道。

扇出和扇入是另一种常见的无服务器模式。想想 MapReduce 是如何工作的。“将工作分散到许多并行节点在无服务器模式下非常有效，因为你有许多小型机器；因此，如果您有一个大的工作项目，您希望将它分成尽可能多的小节点并展开，而无服务器将根据您的需要并行展开尽可能多的节点，然后再缩小。安德森说:“无论您有一个大任务还是许多大任务，它都会自动调整大小，因此您总能达到最大的并行度。

安德森说，最难的部分是“扇入”步骤，因为工作流需要知道所有这些消息何时完成，这样它才能运行流程的下一步。持久函数允许开发人员用一个简单的 FOR 循环和 AWAIT 调用来表达这一点，以等待所有这些事情散开完成。

“过去许多复杂的部分，如轮询和错误情况等，现在都可以用五行 C#来表达，”Anderson 自豪地说。而且不要以为只是为了数据并行操作；它对于自动化也很有用，例如并行调配多个虚拟机，需要完成多个步骤，包括让某人在流程上签字。

持久函数可以跟踪循环过程中的状态，就像一场多回合的游戏表演。“我可以操纵它来创建我称之为持久有状态单例的东西，这是一种在循环中运行的编排，它跟踪该对象的当前状态，我可以向它发送外部消息，让它做其他事情。”

持久函数可以帮助处理的另一个复杂场景是等待一些外部交互。“在现实世界中，我们将有其他外部系统与我们的编排进行交互；安德森说:“我总是可以尝试将这些东西包装在其他函数中，但我不想让一个函数轮询一些外部服务，以了解它是否存在。”。

持久函数支持外部事件的概念，无论是另一个服务还是其他地方的另一个函数，调用持久函数来传递它和一条信息，持久函数可以等待该事件。

## 国家不一定很昂贵

Anderson 认为这是一个很好的方法来处理用户与功能驱动的交互，比如双因素认证(2FA)服务。“人类的运行速度和 restful 服务不一样！要过几秒钟才能拿出手机看看 2FA 码是什么。”

持久功能编排可以向用户发送通知，告知有一个 2FA 代码需要输入，等待用户返回代码，验证该代码，或者在终止登录尝试之前允许再尝试两三次，所有这些都不需要保持功能运行，也不需要向您收费。

“你没有长时间运行的功能等待其他事情完成；一旦它必须进行外部调用以获取状态，持久函数就会关闭 orchestrator，您不再需要为它付费，因此您只需在 orchestrator 不等待外部状态时为它付费。”

耐久功能显然很适合 Azure 服务，如[事件网格](https://azure.microsoft.com/en-us/services/event-grid/)和[事件中心](https://azure.microsoft.com/en-us/services/event-hubs/)，但它也很适合第三方事件。Anderson 提到使用 Twilio 和 webhook 请求函数来添加 2FA 到 Slack，而不需要拿出手机。

“在幕后，这是一个 HTTP 请求。你可以用另一个函数作为外部事件的前端，或者外部事件可以直接调用管理端点，”Anderson 说。“实际上，您通常会有一个功能放在前面，然后您可以有几个不同的触发器，如队列或带有 HTTP 端点的管理面板，它们都可以根据哪个工作流有意义来触发该功能。”

[Azure Logic Apps](https://azure.microsoft.com/en-us/services/logic-apps/) 到目前为止，工作流一直是编排的主要选择(持久功能可以与逻辑应用一起运行)，但这并不适合那些喜欢编写代码而不是使用图形界面的开发人员。

目前，工作流只能用 C#编写，但它将涵盖其他语言。扩展该服务以容纳用 Node.js、JavaScript 和 Typescript 编写的代码的计划正在进行中。

虽然 Azure Functions 在函数背后有一个持久的文件系统，而不是通常的只读副本(因为它是基于 [Azure App Service](https://azure.microsoft.com/en-us/services/app-service/) 和 [WebJobs](https://www.hanselman.com/blog/IntroducingWindowsAzureWebJobs.aspx) 构建的)，但这不是一个存储状态的好地方，因为它太昂贵了。相反，Durable Functions 使用 Azure 存储队列和 Azure 表存储作为键值对。“最终我们会给你选择使用其他底层 Azure 技术来获得更高的性能，”Anderson 说。

“我们希望有更多的提供者让你转而使用 [Azure 服务总线](https://azure.microsoft.com/en-us/services/service-bus/)队列和 [Cosmos DB](https://thenewstack.io/cosmos-db/) 来实现更高的吞吐量。安德森说:“通常，你必须使用 Kafka 或活动中心之类的东西来管理这种吞吐量。

理论上，这种抽象可以使持久函数在本地工作成为可能(正如函数运行时已经可以做到的那样)。这种情况是否会发生将取决于客户的反馈，但安德森假设性地谈到了能够使用 Redis，例如，作为持久功能的存储。

目前在预览版中，持久功能可能会随着 Azure Functions 的第 2 版(它依赖于该版本)的推出而全面上市。以及存储选项和更广泛的语言支持的计划扩展，它将及时添加更多的扩展选项。“我们计划为您进行自动分片，因此您可以利用许多实例，并通过这些实例实现并行扩展。”

但是，安德森希望看到更多旨在使无服务器大规模开发变得更容易的框架和项目，而不是扩大持久功能的范围。

“我们不得不做出这种权衡(使用无服务器):你不必管理基础设施，但你必须放弃对你的应用程序管道的更多控制，并且当限制到单个功能入口点时，没有多少框架(如果有的话)可以工作。安德森说:“我的预期是，我们将会看到在单一功能层面上运作的新一代框架。

微软是这一新技术的赞助商。

特征图像通过 px here[。](https://pxhere.com/en/photo/1347881)

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>