# 利用分布式追踪获得更好的混沌工程覆盖率

> 原文：<https://thenewstack.io/using-distributed-tracing-to-get-better-coverage-with-chaos-engineering/>

为了迎接 2020 年 10 月 6 日至 8 日举行的[混沌大会](https://www.chaosconf.io/)，Lightstep 赞助了这篇文章。

 [丹尼尔的勺子

丹尼尔是 Lightstep 的首席技术官和联合创始人。](https://www.linkedin.com/in/spoons/) 

每个人都知道混沌工程是提高软件应用程序弹性的一个很好的方法。通过提供一个练习以安全的方式处理故障的机会，chaos 帮助开发人员构建更健壮的代码，并增强他们对故障响应能力的信心。分布式跟踪可以通过帮助找到根本原因和其他起作用的因素来支持这一点:跟踪对分布式系统中的因果关系进行编码，以便您可以使用它们来跟踪跨服务传播的故障。但是，跟踪不仅仅可以帮助您对事件做出响应，无论是真实事件还是虚构事件。它也是一个工具，可以帮助你在事件发生之前更好地理解你的应用*，从而计划更有效的混沌实验。*

现代分布式追踪源于谷歌的工作(包括我的一位联合创始人)。谷歌的内部 Dapper 工具用于调试生产中的应用程序，规划优化，并让团队对绩效负责。分布式跟踪通过支持从结果追溯到原因的能力，形成了可观察性的基础。你可能听说可观测性是指“能够提出任何问题”——在某种程度上，这是真的，因为你肯定应该考虑如何从许多不同的角度看待遥测技术。但在我看来，只有一个问题很重要:是什么导致了这种变化？

当在游戏日练习或自动混乱攻击期间调试故障时，[分布式跟踪可以向您显示](https://opentracing.io/media/ship-more-sink-less/)软件中还有哪些变化与这些故障相关。例如，可能其他服务的响应速度较慢(可能错过了它们的 SLO)或者流量被路由到辅助数据中心(增加了网络成本)。重要的是，不仅要考虑单个请求，还要考虑具有统计意义的请求集。同样重要的是，不仅要分析成为攻击目标的请求，还要分析不属于攻击的请求。这样，你就能明白什么是正常的，什么是不正常的。在任何分布式系统中，许多事情总是出错——尽管其中大多数都无关紧要或者正在被妥善处理。因此，能够了解应用程序行为在攻击期间实际上是如何*改变*的，对于快速找到促成因素至关重要。

但是你怎么知道你的混乱攻击是正确的攻击呢？你如何区分轻重缓急？你怎么知道你已经做得够多了？像其他种类的测试一样，您可以将测试*覆盖率*视为测量您的混沌练习进度的一种方式。对于单元测试，我们将测量在至少一次测试中运行了多少行代码。但是在混沌工程中测量覆盖率的正确方法是什么呢？

正如在监控中一样，查看您的基础设施可以帮助您为混沌练习建立一个基线。您第一次尝试监控时可能会回答这样的问题:您的主机启动了吗？有进程崩溃了吗？因此，覆盖意味着确保每台主机都有一个监控代理，并且每个进程都在报告崩溃。从混沌工程开始，您可能会想，哪些主机和哪些服务是攻击的目标。

但是就像在监控中一样，你真的需要从*用户的角度*考虑应用程序的行为。因此，就像你在衡量性能一样，比如说，在完成购买后分别登录应用程序，你应该考虑如何在每个交互中引入错误。在某种程度上，只要确保在每个服务中注入故障，就可以获得一定的覆盖率。但是，当您的组织开始采用诸如增量部署(例如，canaries 或 blue-green 部署)或特性实验之类的实践时，使用服务作为定义覆盖范围的方式将会导致一些缺口。

例如，假设您为一个服务推出了一只金丝雀，并且您还将故障注入到另一个上游服务中。如果金丝雀的目的是理解新代码在生产中的行为，那么你肯定会想知道新代码在面对上游故障时的行为。但是如果金丝雀只处理很小比例的请求，那么它*不会*暴露于失败。显然，您可以向金丝雀添加实例，或者增加您正在注入的故障的数量。但是，如何在利用部署最佳实践(如增量部署和特性实验)的同时获得良好的覆盖率，并限制混乱攻击的规模呢？分布式跟踪可以告诉你是否幸运地使 canary 实例受到了任何上游攻击，但是我真正兴奋的是使用分布式跟踪和应用程序级故障注入( [ALFI](https://www.gremlin.com/blog/the-next-step-application-level-fault-injection/) )来更精确地——并且更有效地——针对*攻击。*

ALFI 允许你使用关于应用程序如何处理请求的信息来瞄准非常细粒度的攻击。与整个流程的黑洞流量不同，ALFI 允许您丢弃特定端点的请求，甚至是特定类型的请求。

将这些与分布式跟踪结合在一起，现在您可以根据应用程序中发生的事情来确定攻击的目标。例如，使用跟踪，您可以根据请求是否来自(甚至是否通过)canary 实例，在上游服务中注入错误。这样，您可以确保获得良好的覆盖率——而不仅仅是希望攻击同时针对新版本和旧版本——而不会增加错误的数量。

分布式跟踪和混沌工程本身都有很多优点，但是当它们联合使用时，为构建弹性系统提供了一个特别强大的工具。分布式追踪和 ALFI 一起可以增加混乱练习效果的信心，同时减少攻击的爆炸半径。跟踪可以向您显示您的混沌覆盖目前有多好，并帮助您创建攻击来增加覆盖范围，而不会增加这些故障影响最终用户的风险。

通过 Pixabay 的特征图像。

目前，新堆栈不允许直接在该网站上发表评论。我们邀请所有希望讨论某个故事的读者通过推特(Twitter)或脸书(T2)与我们联系。我们也欢迎您通过电子邮件发送新闻提示和反馈:[反馈@thenewstack.io](mailto:feedback@thenewstack.io) 。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>