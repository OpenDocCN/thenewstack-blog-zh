# Kubernetes 应用程序是雪花:找到一个可扩展的保护框架

> 原文：<https://thenewstack.io/kubernetes-apps-are-snowflakes-find-an-extensible-protection-framework/>

[](https://www.linkedin.com/in/sayandebsaha/)

[Sayan Saha](https://www.linkedin.com/in/sayandebsaha/)

[Sayan Saha 是一位经验丰富的产品执行官，拥有超过 12 年的开源软件产品管理经验，涉及基于 Linux 的平台软件、容器、Kubernetes、高可用性/集群软件和软件定义的存储。在 NetApp，他是 Astra 和 Trident 的产品管理高级总监，Astra 是一种针对 Kubernetes 应用程序的完全托管(SaaS)多混合云数据管理服务，Trident 是一种针对容器化工作负载使用持久存储的开源解决方案。](https://www.linkedin.com/in/sayandebsaha/)

[](https://www.linkedin.com/in/sayandebsaha/)[](https://www.linkedin.com/in/sayandebsaha/)

随着开发人员和应用程序团队选择[容器](https://thenewstack.io/category/containers/)和 [Kubernetes](https://thenewstack.io/category/kubernetes/) 作为他们构建、部署、运行和扩展应用程序的首选技术，每天都有更多的数据应用程序登陆 Kubernetes。越来越多的独立软件供应商(ISV)将他们的应用程序打包成容器在 Kubernetes 上运行，在所有垂直行业中广泛使用。许多这样的应用程序都是业务关键型的，它们的中断会导致严重的收入、生产力和声誉损失。

随着企业意识到保护其 Kubernetes 应用程序的业务需求，他们转向自己动手的开源或市场上可用的商业解决方案。保护 Kubernetes 应用程序通常需要在发生灾难、网络攻击、恶意或无意的用户错误后恢复应用程序的能力:

*   在同一集群内
*   同一地区的不同集群
*   区域/地理中的独立集群

应用这些解决方案来保护和移动 Kubernetes 应用程序通常不能开箱即用。Kubernetes 的灵活性和可扩展性(使用自定义资源定义)使其深受开发人员的欢迎，但也使保护 Kubernetes 应用程序变得更加困难，因为没有标准的方法来确定需要备份什么才能在灾难后成功恢复。

## 真实世界的 Kubernetes 应用程序是雪花

没有一个标准的 Kubernetes 规范来定义应用程序的组成，这使得确定要备份和克隆哪些资源的问题变得尤为困难。因此，专注于 Kubernetes 应用程序保护(提供备份/恢复和灾难恢复(DR))的解决方案假设开发人员将如何设计他们的应用程序，并尽力找出实际应用程序的组成部分，以及如何最好地保护它。

这种方法导致了 Kubernetes 应用程序发现过程的自动化。在高度动态的 Kubernetes 环境中，自动化应用程序发现过程是可取的。然而，自动发现通常只适用于应用程序简单且局限于某个名称空间的情况。如果应用程序跨越多个名称空间、拥有集群范围的资源和/或使用外部完全托管的数据库、数据存储或消息服务，那么简单的应用程序发现和随之而来的应用程序保护功能不足以保护大多数 Kubernetes 工作负载。

## Kubernetes 应用程序由什么组成？

大多数现实世界中的 Kubernetes 应用程序并不遵循开发人员开发和部署 Kubernetes 应用程序所遵循的标准方法。开发人员如何定义 Kubernetes 应用程序可以是以下内容的组合(并非详尽的列表):

1.  App = 1..1 个命名空间中的 n 个资源
2.  App = 1..名称空间
3.  App = 1..n 个命名空间+ 1..n 群集范围的资源
4.  App = 1..1 中的 n 个资源..n 个命名空间+ 1..n 群集范围的资源
5.  App = 1..1 中的 n 个资源..n 个命名空间+ 1..n 群集范围的资源+外部资源(例如，公共云中的完全托管的数据库)

从上面可以明显看出，使用名称空间作为应用程序分隔符并不能涵盖开发人员定义 Kubernetes 应用程序的所有不同方式。自动推断组成 Kubernetes 应用程序的所有组件也会导致识别 Kubernetes 应用程序资源的失误。

## 带有用户输入的自定义应用程序定义

为了有效地备份和恢复应用程序，用户必须能够指定他们的 Kubernetes 应用程序的组成部分，该应用程序提供必须确保其业务连续性的关键“服务”。理想情况下，用户应该有机会使用 Kubernetes 本地机制定义自己的应用程序，或者定义一个符合上面列举的应用程序定义模式的定制应用程序。

在某些情况下，确定应从应用程序定义中排除的资源也同样重要，因为它们可能与目标/目标群集或命名空间无关，从而妨碍成功恢复。一个有效的 Kubernetes 应用程序保护解决方案必须要么让用户能够指定这些细节，要么智能地帮助发现这些复杂的应用程序。一旦用所有必需的资源定义了应用程序，保护应用程序就不再是猜测，从而带来更可预测的结果。

## 钩子，钩子，还有更多钩子

企业备份软件多年来一直使用挂钩或前脚本/后脚本，使用户能够插入自定义操作来进行应用程序一致性备份，如在拍摄快照以将内存中的表刷新到磁盘之前暂停数据库。用“执行挂钩”插入定制动作的能力在 Kubernetes 应用程序中有了全新的含义。可预测地控制 Kubernetes 应用程序的端到端备份和恢复，以在恢复后实现成功的应用程序实例化，通常需要在备份前后以及恢复前后对构成 Kubernetes 应用程序的若干资源执行自定义操作。

Kubernetes 中的执行挂钩在备份-恢复工作流程中可用于实现许多目标，如在备份/恢复之前或之后动态应用网络安全策略，在克隆之前改变入口控制器的注册路径，刷新 IP 地址，以及其他定制的特定于应用程序的操作。Kubernetes 应用程序保护解决方案必须允许具有执行挂钩的备份/灾难恢复工作流的可扩展性，使用这些执行挂钩可以插入特定于应用程序的自定义操作。

## 不要备份和恢复什么

确定哪些应用程序资源需要保护至关重要，但哪些不需要备份和/或恢复也同样重要。这是因为某些资源(如机密、IP 地址和节点端口)可能与灾难恢复的目标集群无关。对构成 Kubernetes 应用程序的所有资源进行批量备份，然后进行后续恢复，可能会导致恢复失败，因为资源的子集在目标群集中完全无效。从概念上讲，通常有两种方法来解决这种情况。

*   使用过滤器排除备份或恢复在目标集群中没有意义的特定资源，使 Kubernetes 或操作员(部署和管理 Kubernetes 应用程序的流行设计模式)能够重新创建这些资源。
*   在资源到达目标群集之前对其进行转换。

Kubernetes 应用程序保护解决方案必须允许用户执行上述所有操作，以确保恢复后正确的应用程序行为。

## 摘要

随着企业意识到保护其 Kubernetes 应用程序的需要，在大规模采用这些解决方案之前，评估它们的可定制性和可扩展性非常重要。提供一套最佳实践也很重要，它可以指导开发人员在设计 Kubernetes 应用程序时坚持一套方法，包括推荐一套他们可以利用的标准集群内和外部服务，以便在关键业务 Kubernetes 应用程序在企业中变得无处不在时更容易保护它们。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>