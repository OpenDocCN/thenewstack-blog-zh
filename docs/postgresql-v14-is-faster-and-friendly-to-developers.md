# PostgreSQL v14 更快，对开发人员更友好

> 原文：<https://thenewstack.io/postgresql-v14-is-faster-and-friendly-to-developers/>

对于开源关系数据库 [PostgreSQL](https://www.postgresql.org/) 来说，这是重要的一年。[栈溢出](https://insights.stackoverflow.com/survey/2021#most-loved-dreaded-and-wanted-database-want)开发者将其命名为 2021 年最想要的数据库， [DB-Engines](https://db-engines.com/en/blog_post/85) 第三次将其命名为年度数据库管理系统。所以上个月维护者发布[版本 14](https://www.postgresql.org/about/news/postgresql-14-released-2318/) 的时候，最好留个记号。新版本提供了超过 220 个补丁——比平常增加了 30%。

新的 Stack 采访了企业数据库性能软件提供商 [Percona](https://www.percona.com/) 的 PostgreSQL 负责人 [Umair Shahid](https://twitter.com/pg_umair) ，以及 [PostgreSQL 行为准则](https://www.postgresql.org/about/policies/coc/)委员会主席、伊斯兰堡和迪拜用户组负责人以及[美国 PostgreSQL 协会(PgUS)](https://postgresql.us/) 用户组委员会成员。他强调了 14 在性能、水平扩展、可观察性、开发人员体验和安全性方面的更新，我们现在为您带来这些更新。

## PostgreSQL v14.0:性能增强

Shahid 将性能增强分为两组——一组在后台“正常工作”,无需用户干预，另一组需要更改配置才能工作。两者都将提高存储和资源效率，这当然会降低成本。

减少膨胀是这些幕后改进之一。频繁更新的索引往往会有[死元组](https://www.percona.com/blog/2018/08/06/basic-understanding-bloat-vacuum-postgresql-mvcc/#:~:text=As%20seen%20in%20the%20above,runs%20VACUUM%20on%20such%20Tables.)——任何已被删除但仍占用空间的记录——这会导致索引膨胀。通常，这些元组仅在真空运行时被移除。沙希德解释说，在两次清空之间，当页面被填满时，更新或插入将导致页面分割——这是不可逆的。即使现有页面中的死元组可能已经被移除，从而为额外的元组腾出空间，也会发生这种拆分。在 PostgreSQL 14 中，即使在两次清空之间，也会自动检测和删除死元组，从而减少页面拆分次数，进而减少索引膨胀。

类似地，在 14 之前，当删除数据并运行清空时，PostgreSQL 会将该数据标记为待删除，然后等待下一轮清空来实际释放空间。一种新的算法允许急切删除数据，从而更有效地释放空间。

vacuum 现在能够一次性识别并释放空间。沙希德称这是“减少空间占用和提高效率的更有效的方法”。"

尽管如此，开发人员和数据库管理员仍将拥有回滚和时间点恢复的常用缓冲。

这个版本还为并行查询执行带来了更多特性，PostgreSQL 可以设计查询计划，利用多个 CPU 更快地响应查询。现在，您的数据库可以并行执行返回查询和刷新物化视图的查询。

更突出的更新包括 LibPQ 的管道模式，这是开发人员用来将应用程序连接到数据库的接口。有了 PostgreSQL，他们现在能够使用管道模式。LibPQ 过去是单线程的，它会等待一个查询完成执行，然后将下一个查询发送到数据库。现在，devs 可以将多个事务输入管道，LibPQ 将依次执行它们，并将结果反馈给应用程序。应用程序不再需要等待第一个事务完成才能执行下一个事务。

这是沙希德评论的更新之一，“为什么我们没有早点想到这个？这太容易了！但技术就是这样进步的。”

另一个显而易见的潜在升级是 TOAST，现在允许 LZ4 压缩。TOAST 是一个允许存储更多数据的系统。在版本 14 之前，它使用 PGLZ，这是一种非常快速的压缩算法，但实际压缩比很小。LZ4 同样非常快——沙希德说它是无损的，这意味着你不会丢失任何数据，就像你会丢失像素化的压缩照片一样——而且它还有很高的压缩比。

他说，它因数据而异，但该算法智能地利用了数据所需的空间。继续照片的例子，如果你有一个晴朗的蓝天，它会以比秋天森林的彩色照片高得多的压缩比来压缩它。

## PostgreSQL v14.0:水平可伸缩性和分布式工作负载

这个版本的下一个新增功能是复制正在进行的事务。典型的集群设置几乎不会有单个节点，因为这会成为单点故障。它通常分布在一个主节点和多个次节点之间，这些节点相互通信以确保同步。以前，大型事务被写入磁盘，直到事务完成，然后才被复制到备用节点。使用 PostgreSQL 14，可以将正在进行的事务复制到备用节点，而无需等待事务完成。

水平可伸缩性的其他更新涉及外部数据包装器。借助 FDW，您能够以特定的方式对数据进行分片或切片，以便将数据分布在不同的服务器上，从而实现分布式工作负载的水平可伸缩性。现在，您不仅可以在本地表中，而且可以在外部表中执行批量插入，而不是逐行插入。

此外，在执行查询时，它会扫描或读取表，以了解从哪里获取数据。从版本 12 开始，本地查询可以并行运行，但是现在也可以并行扫描外部表。

## PostgreSQL v14.0:可观察性

对于数据库管理员来说，数据库的可观察性也有了许多增强，提供了更深入的见解和统计数据。

PostgreSQL 的核心引擎公开了一个 API，允许用户编写自定义扩展来增强功能，而无需对核心引擎进行任何更改。最流行的扩展之一是 [pg_stat_statement](https://www.postgresql.org/docs/9.4/pgstatstatements.html) ，它监控数据库中的查询并跟踪统计数据。它使用查询散列为查询分配唯一的 id，然后可以通过核心服务器跟踪这些查询。

“在 PostgreSQL 版本 14 中，我们将扩展中的散列技术应用到核心服务器中，因此您可以使用相同的散列，并对相同的查询使用任何其他扩展。”Shahid 继续说，以前，只有核心服务器和`pg_stat_statement`知道那个 id——现在任何扩展都可以使用同一个 ID，允许跨 PostgreSQL 系统和日志功能的更丰富的可观察性。

## PostgreSQL v14.0:方便开发人员

“如果有人正在开发一个应用程序，你不能指望他们是一个数据库专家，”沙希德说。

在其他开发人员体验改进中，Shahid 表示，他们已经对 JSON 进行了增强，进一步完善了非结构化数据的可用性，因此开发人员能够在他们喜欢使用的语言中使用它，包括 Python 和 Java。

“这不仅仅是以原生数据类型获得特性，而是要确保开发人员以他们习惯的方式使用它，”他说。

他们还增加了多范围类型。在此版本之前，开发人员只能有一种范围类型，具有特定的起点和终点，例如办公室从上午 9 点到下午 5 点开放。现在，您可以在一组范围中指定一个不连续的范围，例如会议室从上午 9 点到 9 点 30 分、11 点到中午 12 点等等。现在，您可以在同一个变量中保存一天中的整个时间段。

PostgreSQL 11 中添加了典型的存储过程，让开发人员可以在一段代码中进行事务控制。PostgreSQL 14 实现了 OUT 参数，允许开发人员在存储过程中使用多个参数返回数据。这个特性对于 Oracle 开发人员来说是熟悉的，对于试图从 Oracle 迁移到 PostgreSQL 的人来说也是受欢迎的。

## PostgreSQL v14.0:安全性

也许对许多用户来说最有趣的特性直到我们采访 Shahid 结束时才被提及——安全性。

在这个版本之前，PostgreSQL 的一个潜在缺点是默认的身份验证方法是 MD5，除了别的以外，它不再符合 PCI DSS 支付卡标准。MD5 利用双方持有的加密密钥。当你发送数据时，你需要有一个机制来确保对方知道如何解密

然而，沙希德解释说，如果有人在中间嗅探，MD5 有可能在中途被解密。

PostgreSQL 的默认身份验证方法现在是 [SCRAM，Salted Challenge Response 身份验证机制](https://en.wikipedia.org/wiki/Salted_Challenge_Response_Authentication_Mechanism)，它符合更高级别的行业标准。salted challenge 发送数据而不告诉接收者如何解密——双方都已经知道如何解密。这就消除了嗅探器的力量。

他们还对预定义的角色进行了更新，包括`pg_read_all_data`允许向能够读取所有数据的用户分配权限。常见的用例是分析人员或负责设置复制平台的人员，在该平台上添加新表。

他们还增加了`pg_write_all_data`。Shahid 给出了一个表的例子，它设置了表的特征。

“pg_write_all_data 向用户授予超级用户风格的权限，因此应该谨慎使用。但是在需要的情况下，它提供了很多方便。应用程序在发展，数据库在发展，模式在发展。Shahid 说:“写入所有数据的一揽子权限可以确保用户继续拥有所需的权限，明确分配此类权限不会因更新而丢失。

他强调这是一种便利，只能有节制地使用。

## 是什么让 PostgreSQL 如此受欢迎？

“许可证与此有很大关系，”沙希德说。“并不是因为人们真的去阅读许可证，试图去理解它。只是，在开源领域，开放程度各不相同。”

他继续说 [PostgreSQL 开源许可](https://www.postgresql.org/about/licence/)是最自由的，只有 143 个字，他总结为:

*   你想做什么就做什么。
*   出了问题不要怪加州大学。

Shahid 解释说，这种开放性是为什么所有主要的云供应商都可以提供 PostgreSQL 解决方案，以及数据库有如此多的分支和更名。

还有，就像它服务于分布式系统一样，它是高度分布式开源社区的产物。

“这个项目背后有一个独特的社区，因为它不是由一个单一的商业实体运营的。PostgreSQL 是一家真正的多用户、多地区、多种族的公司。决策的唯一方面是‘什么对项目有益’而不是‘什么对商业有益’，因为没有商业，”他说，提醒我们开源是一种开发模式，[而不是商业模式](https://thenewstack.io/open-source-licenses-who-holds-the-power/)。

他说，当你看绝对数字时，毫无疑问 MySQL 和 Oracle 会有更多的用户，但这种增长相当平缓，而 PostgreSQL 等开源解决方案继续向上增长。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>