# 美国职业棒球大联盟关于部署和监控 Kubernetes 的经验教训

> 原文：<https://thenewstack.io/lessons-from-major-league-baseball-on-deploying-and-monitoring-kubernetes/>

[Circonus](https://www.circonus.com/) 赞助了这篇帖子。

 [鲍勃·穆尔

鲍勃·穆尔是 Circonus 的首席执行官。他是一位经验丰富的技术首席执行官，拥有超过 38 年的与商业、政府、学术和非营利组织合作的经验。在加入 Circonus 之前，Bob 是 Cloudamize、Artisan Mobile 和 Boomi 的首席执行官，也是 SCT 全球教育解决方案的总裁。Bob 在 EDS 工作了 19 年，开始时担任系统工程职位，后来担任高级管理人员，领导英格兰、香港和澳大利亚的运营。](https://www.linkedin.com/in/bobmoul/) 

我们最近与美国职业棒球大联盟(MLB)的高管谈论了他们的 Kubernetes 部署，包括他们面临的挑战和他们学到的经验教训——特别是在 Kubernetes 监控方面。目前，MLB 有大约 70 个 Kubernetes 集群，分布在 30 个棒球场，其中大部分在 GKE，但也有一些在 EKS。以下是 MLB 分享的六个经验教训，其中包括一些你可以应用到你自己的集群中的见解，为你的组织节省大量的时间和金钱。

**第一课:集中监控数据以简化警报配置并更好地管理指标。**

自部署 Kubernetes 以来，MLB 学到的最重要的经验是将所有 Kubernetes 监控指标集中到一个平台上。起初，该组织在其每个集群内创建了监控工具的孤岛—如果您有有限数量的集群可以轻松管理，这种策略可能会奏效。但是当你有一个较大的 Kubernetes 足迹时，过滤集群使用不同的工具生成的大量数据是一个挑战。MLB 发现，每分钟大约有 75 万个时序数据从每个集群中流出，数据太多，难以管理。通过将其指标整合到一个平台中，联盟可以过滤掉 90%的数据，并为每个较大的集群保留大约 15，000 到 30，000 个时间序列。这使他们能够专注于他们真正关心并能够解决的 15 到 20 个可行问题，例如 pod 崩溃循环、内存压力、PID 压力等。

集中所有数据也简化了警报管理。以前，他们必须跨所有群集配置警报管理，而且许多群集处于各种不合规状态。通过将集群生成的所有数据放在一个地方，他们现在有一组警报数据来管理 15-20 个主要问题。

**第二课:使用普罗米修斯接收数据的“拉动模式”在可见性上留下了漏洞。**

普罗米修斯公司的“拉动模式”并不适用于 MLB，因为它有一个跨越全国各地棒球场的复杂网络。其网络跨越 VPN、不同的云、内部部署等。；因此他们不可避免地会有“滴”结果，“拉取”会失败，他们会在数据中看到巨大的漏洞。他们解决这个问题的唯一方法是找出某种回填过程，这是非常难以管理的。通过转向接收数据并集中处理数据的“推送模式”，他们能够克服这一挑战。

**第 3 课:了解资源利用率，以防止** **过度配置并节省大量成本。**

过度配置集群是 Kubernetes 中的一个常见问题。事实上，大多数组织很可能在他们的集群中有很多他们没有意识到的浪费。了解资源利用率是防止这种情况的关键。

很难理解的是您的 pod 需要多少 CPU 和 RAM，而它们实际使用了多少。重要的是能够显示这些信息，并根据您的实际使用情况做出支出决策。许多组织决定扩大规模，因为他们发现自己的 CPU 利用率很高。然而，CPU 的增加并不一定意味着您的延迟增加了，它只是意味着您正在使用您说过要使用的内核。MLB 最初基于 CPU 进行自动扩展设置，但现在它基于从实际利用率中得出的指标进行自动扩展。例如，MLB 可能会分析每秒请求数，并决定不进行扩展，因为他们知道在该请求速率下，这种级别的扩展已经满足了性能要求。随着时间的推移，这将为他们节省大量成本。

大多数组织高估了保持集群最佳运行所需的资源。如果您对资源利用率指标进行更深入的研究，您可能会发现您并没有使用您认为应该使用的资源，因此这是一个节省成本的巨大机会。

**第四课:投资 Kubernetes 知识共享。**

花时间将 Kubernetes 如何运作的知识传授给实际运行集群的开发团队。除非你有足够的资源雇佣一个非常大的 SRE 团队，否则不可能用一个小团队来管理库伯内特所有的扩张。每个人都需要参与进来，并从常见错误中学习，从而更深入地了解 Kubernetes 的运营方式。

知识共享至关重要，因为你不能将传统的 IT 专业知识应用于 Kubernetes——这与生俱来的差异太大了。没有开发过在 Kubernetes 上运行的软件的软件工程师会根据过去的经验，用一套假设来研究这项技术。通过应用这些过去的知识而不对其进行修改，组织将拥有不太可靠且更难操作的集群。通过将关于 Kubernetes 如何工作以及如何运作的细微差别的知识传授给这些团队，他们将更好地理解如何构建可在 Kubernetes 上运行的软件。如果你将 Kubernetes 的细微差别和知识孤立或隔离到一个团队中，你最终只会生产出烧钱的软件。

第五课:让库伯内特人民主化。

MLB 有一个由 8-10 名工程师组成的核心团队，负责 CI/CD 管道。集群归使用它们的团队所有，而不是由这个中心团队独自管理 Kubernetes。这有利于知识共享，但也很有挑战性，因为 Kubernetes 很复杂。

例如，MLB 70 多个集群中的大部分都处于不断崩溃的各种状态，因此关于这些问题的疑问不可避免地会回到核心团队。因为有如此多的集群，所以没有办法让一个集中的团队来管理所有这些集群并了解所有部署的上下文。因此，MLB 使用 Terraform 建立规则，允许警报直接发送给拥有该集群的团队。如果团队陷入困境，他们会向核心团队寻求帮助。此外，MLB 为 Kubernetes 的部署和监控提供了集中的工具(如第 1 课所述)，这使得团队之间能够保持一致。

**第 6 课:使用覆盖 80%用例的交钥匙监控** **解决方案，以节省大量时间。**

MLB 发现，大约 80%的用例在 Kubernetes 中运行得非常好。通过为这 80%应用统包式监控解决方案，他们节省了大量时间。他们只需放下一个代理，就能立即获得警报、可视化和数据洞察，而无需额外的工作。通过一个交钥匙解决方案，MLB 可以启动一个集群，并且已经设置了 15-20 个重要的警报。如果出现故障，他们会收到警报，并可以查看控制面板来确定问题是什么以及如何修复。如果他们想进一步定制，他们可以。

## **打你的 Kubernetes 部署出公园**

无论您已经部署了 Kubernetes 集群还是正在考虑部署，您都很清楚 Kubernetes 可以带来的好处，但是您也知道它有多复杂。职业棒球大联盟在这一过程中获得了一些见解，以确保他们继续最大限度地发挥 Kubernetes 部署的价值。希望他们分享的一些内容可以帮助您的组织做到这一点。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>