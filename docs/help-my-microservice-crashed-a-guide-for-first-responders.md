# 救命啊！我的微服务崩溃:第一反应者指南

> 原文：<https://thenewstack.io/help-my-microservice-crashed-a-guide-for-first-responders/>

我不想对你撒谎。在云中发生微服务崩溃，然后试图弄清楚到底发生了什么，这是非常令人沮丧的。启动并运行另一个实例很容易，但是如果不知道前一个实例失败的原因，就无法保证新服务会比它所替代的服务更稳定或更不稳定。

在本文中，我们将探讨一些策略，帮助您更好地理解是什么情况导致了您的微服务崩溃。充分了解失败的原因将为您提供实施更改的机会，以提高您的微服务的稳定性，并有望防止同样的问题再次发生。

## 当一切都太迟的时候

不幸的是，如果你发现了这篇文章，我没有太多有用的建议给你，因为你的微服务刚刚崩溃了，你拼命想找出原因。通过提前准备支持基础设施和监控，您将能够更好地确定哪个微服务崩溃了及其原因。适当的准备是本文关注的主题，但是这里有一些提示，这样我就不会让你无所适从了。

### 确定问题根源的微服务

在微服务环境中，每个服务可能都依赖于其他服务。由于这些依赖关系，一个服务中的故障通常会表现为另一个服务的明显故障，而该服务对另一个服务起依赖作用。识别哪个服务失败是第一步。如果您怀疑某项服务是失败的原因，请验证它的所有依赖项是否正常运行并按预期响应。

### 保存证据

在生产环境中，您会希望尽快恢复服务并运行。通常，这个过程可能涉及实例化一个新的虚拟机或一个新的机器集群。当完成任一操作时，自动化流程有时可能会破坏以前的实例或集群。如果可能，采取措施保护这些设备。日志文件、内存转储和在违规机器上执行诊断工具可能会提供导致故障的重要线索。

### 准备是关键

希望您正在阅读这篇文章，为迁移到微服务架构做准备，并计划一个全面的支持策略。一个设计良好的微服务架构允许单个团队实现独立的功能，并创建一个高度可扩展、松散耦合的环境，并支持新功能的快速引入。

这些对开发过程的好处导致了一个很难用传统的生产监控工具来监控的环境。您可能希望研究并实现一个应用性能监控工具(APM ),该工具允许开发人员了解其应用的当前状态，自动执行支持生产系统的许多流程，并在关键指标超出定义的性能限制时发出警报。

## 选择好的 APM

 [迈克·麦克罗里

迈克·麦克罗里是一名全球公民，目前已经在太平洋西北部定居。白天，他是一个质量工程团队的高级工程师，晚上，他写作，为几个基于网络的项目提供咨询，并经营一家稍微成功的易贝贴纸公司。当他不敲键盘的时候，他会和他的孩子们一起去远足、钓鱼、探索城市和乡村的风景。他总是很乐意帮助另一个开发人员，他特别喜欢帮助那些带着美食甜甜圈、精酿啤酒和/或单一麦芽苏格兰威士忌的人。](https://www.linkedin.com/in/echovue/) 

APM 通常由安装在微服务机器或容器上的代理组成，并与中央 APM 服务器或服务器集群通信。在某些情况下，APM 代理本身可以作为一个独立的容器运行，特别是对于需要更深层次工具的服务。这种方法的优点是它将服务的监控与实际的服务本身分离开来。它还允许持续有效地监控分析数据，即使目标机器出现故障或意外关机。

理想情况下，您选择和实施的 APM 解决方案应该包括趋势分析或机器学习，以支持完全自动化的监控。APM 工具还应该包括动态基准和规则，并允许用户自定义他们自己的规则，这些规则可用于在系统降级到不可用的程度之前生成警报。

最后，APM 解决方案应该支持实时和历史服务的可视化，以使开发人员能够了解与内存、处理和网络通信等指标相关的机器状态。日志数据的收集、聚合和索引也是全面监控解决方案的重要组成部分。

## 跟踪、容错和防御编码

除了部署全面的 APM 解决方案之外，您还应该在构建微服务时实施一些开发最佳实践，以便在出现故障时为负责运营支持的人员提供支持和故障排除。

总是假设你的系统的某些方面会失败。即使你的代码是完美的，它仍然依赖于基础设施、依赖的服务和不可预知的用户输入。对应用程序进行编码，使其能够优雅地处理任何依赖关系的故障，并使识别故障源变得容易。尽可能添加全面的异常处理、描述性日志消息和验证。

在服务之间传递消息或请求时，向来自同一客户端的所有请求添加一个相关令牌或跟踪 ID。当您试图通过多个服务跟踪客户机的请求时，这些令牌将被证明是非常宝贵的，尤其是当您将所有日志聚合到一个索引日志聚合系统中时。

最后，以一种支持容错的方式部署您的微服务。使用基于软件的负载平衡器，并将单个微服务分布在多个虚拟机上(如果可能，分布在不同的地理位置)，将有助于在其中一个实例出现故障时最大限度地减少用户的停机时间。

*要了解更多关于监控微服务的信息，请获取免费电子书:[容器监控&管理](https://www.ca.com/us/info/docker-container-monitoring-essentials.html#download)。*

[CA Technologies](https://www.broadcom.com/info/aiops/docker-monitoring) 是新堆栈的赞助商。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>