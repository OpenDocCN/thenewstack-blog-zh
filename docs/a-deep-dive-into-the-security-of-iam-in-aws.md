# 深入探讨 AWS 中 IAM 的安全性

> 原文：<https://thenewstack.io/a-deep-dive-into-the-security-of-iam-in-aws/>

公共云是寻求利用组织基础架构漏洞的网络犯罪分子的重要目标。虽然潜在漏洞的时间框架可能会有所不同，但黑客通常会在几分钟内扫描新部署的云资源，以寻找可利用的弱点。

不幸的是，许多[安全](https://thenewstack.io/security/)漏洞在很长一段时间内未被发现，有时甚至长达数月，这使得组织必须实施强大的安全措施并定期监控其云环境中的潜在威胁。

云中全面安全计划的关键组成部分之一是安全可靠的身份和访问管理(IAM)实现。IAM 在控制和管理对云资源的访问方面发挥着关键作用，确保只有[授权用户](https://thenewstack.io/how-do-authentication-and-authorization-differ/)拥有对资源执行操作的必要权限。

在[亚马逊网络服务(AWS)中，](https://aws.amazon.com/?utm_content=inline-mention)身份和访问管理允许用户根据用户身份、角色和其他属性为 AWS 资源定义细粒度的访问控制策略。

通过 AWS 的 IAM 特性，管理员可以授予用户和服务访问资源的权限，还可以创建 AWS 服务访问资源的角色。

IAM 还提供了一个集中位置来管理用户帐户，包括密码策略、多因素身份验证和其他与安全相关的设置。此外，IAM 可以与其他 AWS 服务集成，如亚马逊简单存储服务(S3)，以提供更细粒度的访问控制策略。

[设计良好的 IAM 实施](https://thenewstack.io/5-software-security-goals-all-ctos-should-prioritize/)有助于降低安全漏洞的风险，方法是减少攻击面，将访问权限限制在授权用户，并提供一个集中的位置来管理对云资源的访问。

## 云错误配置:头号云风险

云中的主要攻击面不是云中托管的服务器的操作系统，也不是应用程序的配置或应用程序的安全性。虽然这些仍然与数据中心相关，但现在大多数黑客攻击都涉及[云资源的错误配置。](https://thenewstack.io/the-top-4-threats-to-securing-your-cloud-infrastructure/)

“几乎所有对云服务的成功攻击都是客户错误配置、管理不善和失误的结果，”Gartner 副总裁 Neil MacDonald 在[2019 年关于云安全的报告中写道。](https://www.gartner.com/en/documents/3899373)

在新闻媒体中，这些场景经常被过于简化地描述，比如 AWS S3 桶向世界开放。然而，当深入挖掘时，经常出现的情况是，IAM 错误配置的组合被用来访问 S3 数据。

[https://www.youtube.com/embed/Qr2PZkpBpwo](https://www.youtube.com/embed/Qr2PZkpBpwo)

视频

即使您认为自己是安全的，因为您已经根据最佳实践检查了 IAM 配置并使用了 AWS IAM 分析器，但您仍然可能有非常容易受到攻击的设置。通常很难识别它们，而且安全工具通常会遗漏它们。

例如，有一个弹性计算云(EC2)操作，它允许 EC2 实例更改应用于它的 IAM 策略——许多人无意中打开了这个操作。这带来了巨大的潜在漏洞。

类似地，IAM 权限中的 S3 列表在生产环境中可能是危险的，但是您的安全工具可能不会将它们识别为漏洞。即使您制定了合规性标准，您的安全工具也可能无法捕捉到黑客正在使用的一些技术。

许多高级云错误配置只有在考虑环境的完整上下文时才会显现出来。你不能仅仅扫描一个基础设施代码文件就认为你是安全的；你必须观察那个[地形或云形成](https://thenewstack.io/terraform-vs-cloudformation-which-is-better-for-you/)脚本何时运行和部署，无论是自动还是手动。

您还必须考虑配置如何影响总体帐户、Amazon 虚拟专用云(VPCs)和其他组件。这就是黑客的目标，因为主网络不是 TCP/IP 网络，而是 IAM 网络。

研究表明，太多的组织不重视他们的 IAMPalo Alto Networks 的安全研究分支 Unit 42 在 5 月发布的一份报告中发现，99%被研究的组织都有过度宽松的 IAM 策略，这意味着他们颁发的证书在过去 60 天内没有使用过。

## 配置不当的 IAM 策略的危险

IAM 策略在控制对 AWS 资源的访问方面起着关键作用。这些策略是用 JSON 编写的，定义了谁可以在什么条件下访问哪些资源。这些策略可以与用户、组和角色等 AWS 身份相关联，也可以直接与 AWS 资源相关联。

当用户请求访问 AWS 资源时，AWS 会对策略进行评估，并根据适当的策略授予或拒绝访问权限。

在 AWS 中，系统的安全性取决于管理员设置的配置和策略。

值得注意的是，IAM 策略不仅适用于用户，还适用于 AWS 中运行的基础设施，比如 EC2 实例。一个常见的安全问题:当 IAM 策略过于宽松时，允许对 AWS 资源进行过多的访问。

例如，如果在 EC2 实例上使用通配符`*`设置策略进行读写访问，那么如果攻击者获得对实例的访问权限，这可能会导致安全漏洞。这是因为攻击者拥有与 EC2 实例相关的所有资源的读写权限，这可能会导致数据泄露、横向移动和其他安全事故。

在策略中使用通配符(即`*`)将权限授予特定 AWS 服务中的所有可用操作。因此，当服务/资源中引入新的动作时，它们将自动继承所有的`read`策略，只要它们被`read-*`语句覆盖。

这可能会导致意想不到的后果，因为用户可能会执行不期望的操作。因此，建议使用更具体的策略，只包括必要的权限，而不是使用通配符策略，如`read-*`。

`iam:PassRole`权限允许 IAM 用户或角色将 IAM 角色传递给 EC2 实例，从而允许 EC2 实例承担 IAM 角色并执行与该角色相关联的策略授权的操作。

这在希望更改与 EC2 实例相关联的 IAM 实例配置文件的情况下非常有用，例如，授予或撤销某些权限。

然而，重要的是要小心管理这个权限，并确保它只授予可信的实体，以防止对 AWS 资源的任何未经授权的访问。

不将`iam:PassRole`权限仅授予受信任的实体会导致几个安全隐患。例如，它可能导致对 AWS 资源的未授权访问:如果攻击者获得了对具有`iam:PassRole`权限的 IAM 用户或角色的访问权，他们可以启动新的 EC2 实例，并将恶意的 IAM 角色传递给这些实例。这可能使攻击者能够访问敏感的 AWS 资源，并对您的环境造成损害。

## 身份访问管理的安全性

[AWS 中基于属性的访问控制(ABAC)](https://thenewstack.io/why-you-should-choose-ngac-as-your-access-control-model/) 允许管理员根据用户身份、请求时间、资源类型等属性为 AWS 资源定义细粒度的访问控制策略。ABAC 策略是使用 AWS 身份和访问管理策略定义的。

[AWS 中的 IAM](https://thenewstack.io/best-practices-for-securing-identity-and-access-management-on-amazon-web-services/)是一项服务，使您能够管理用户、组和各种 AWS 资源的权限。它是 AWS 安全性的关键组件，允许您控制对 AWS 资源的访问。

这些策略可以针对特定的 AWS 资源，如 S3 存储桶或 EC2 实例，允许管理员对不同的资源应用不同级别的访问控制。这种级别的控制有助于保护敏感数据，并强制遵守安全最佳实践。

IAM 中的一个关键概念是主体的概念。主体是可以与 AWS 资源交互的实体，可以是用户、组或角色。每个主体都与一个 AWS 访问密钥和秘密密钥相关联，它们用于在向 AWS 发出请求时对主体进行身份验证。

AWS IAM 有许多内置策略，允许您提供对各种 AWS 服务和资源的细粒度访问控制。这些策略是用 JSON 编写的，可用于根据各种条件允许或拒绝对 AWS 资源的访问，例如资源的 Amazon 资源名称(ARN)、时间或请求的 IP 地址。

您还可以创建自定义策略来控制对特定资源的访问或执行特定操作。策略可以附加到用户、组或角色，它们类似于用户和组，但旨在用于 AWS 服务和资源，而不是人类用户。

设计安全 IAM 的许多复杂性不仅仅局限于对策略的理解，而是由主体、动作和资源的交互引起的。在很多情况下，你可能会把事情变得过于复杂，或者更糟糕的是，你可能会让事情变得过于放纵，从而变得危险。

## 通过 ABAC 简化对 AWS 资源的访问

管理对 AWS 资源的访问是一项挑战，尤其是在大型复杂的环境中，多个团队负责不同的应用程序和资源。这就是 ABAC 的用武之地。它允许您根据资源的属性或标签授予对资源的访问权限。

我们将描述一个场景，其中多个团队——团队 A、团队 B、团队 C——负责不同的应用程序和 AWS 资源。为了控制对这些资源的访问，我们将使用 ABAC，根据资源标签的值授予访问权限。例如，如果一个资源被标记为`team: A`，这意味着团队 A 可以访问该资源。

### 以下是 ABAC 在 AWS 的工作方式

*   **资源标记:**第一步是用适当的属性标记 AWS 资源，比如`team: A`。这允许您对资源进行分类，并将它们与适当的团队相关联。
*   **策略定义:**接下来，我们定义基于标签值控制资源访问的策略。这些策略以 JSON 格式编写，并使用 AWS IAM 策略语言来指定允许或拒绝访问的条件。
*   **策略附加:**然后将策略附加到适当的 IAM 用户、角色或组。例如，如果团队 A 负责一个标签为`team: A`的资源，我们将把允许访问该资源的策略附加到与团队 A 相关联的 IAM 用户或角色上
*   **访问控制:**当 IAM 用户或角色试图访问资源时，AWS 会评估附加的策略，以确定是允许还是拒绝请求。如果请求满足策略中指定的条件，则授予访问权限。

ABAC 要求仔细管理标签值和修改标签的权限。例如，我们希望将对`team`标记的写权限仅限于受信任的实体，比如团队管理员或资源所有者，以防止对标记值进行未经授权的更改。

通过使用 ABAC，我们可以根据资源标签的值动态控制对 AWS 资源的访问，从而更容易管理大型复杂环境中的访问。无论您有多个团队在开发不同的应用程序，还是管理对大量资源的访问，ABAC 都是一个强大的工具，可以简化访问控制并降低未经授权访问的风险。

## 将策略用作 IAM 的代码

请记住，不能像对待本地数据中心一样对待云，以使其健壮和安全；[不是有护城河就能保护的城堡。](https://thenewstack.io/why-the-castle-and-moat-approach-to-security-is-obsolete/)黑客总能找到绕过传统安全控制的方法。难怪越来越多部署在云上的组织正在转向[零信任策略，](https://thenewstack.io/what-is-zero-trust-security/)这依赖于健壮的 IAM 架构。

云的目的是快速发展，其软件定义的基础架构是高度动态的，通过 API 进行配置、部署和维护。这些 API 为客户提供了快速、实验和迭代的能力，这是云的主要优势之一。

然而，这些 API 也带来了安全性和合规性方面的挑战。由于 API 是高度自动化的，并消除了许多与传统 IT 基础设施相关的手动检查和摩擦，因此很容易无意中错误配置资源或忽略安全漏洞。

开发人员现在通过 API 构建和修改他们自己的基础设施环境。这就是为什么在云上使用策略作为任何类型的安全代码都很重要。

策略即代码允许将安全策略定义为代码，可以像任何其他软件代码一样对其进行版本控制和审计。这使组织能够自动执行安全策略，这有助于打击黑客，他们也使用自动化来找到他们可以利用的漏洞。它有助于防止安全事故，并减少检测和响应安全事故所需的时间。

策略作为代码的方法允许安全团队在整个软件开发生命周期中定义和执行策略。这意味着安全策略被集成到开发流程中并自动执行，从而降低了环境中出现安全问题的风险。

策略即代码还支持持续监控和合规性测试，这有助于组织尽早发现安全问题并快速做出响应。这就形成了一个反馈回路，在这个回路中，安全策略会根据最新的威胁情报和安全趋势不断改进，从而随着时间的推移变得更加有效。

## 什么是开放策略代理，它有什么帮助？

由 Styra 创建的用于实现云配置管理策略的开源工具[开放策略代理(OPA)](https://www.openpolicyagent.org/) ，经常被用作任何策略的基石。

OPA 是一个策略引擎，通过提供统一、灵活的方法来定义和实施跨云环境的安全策略，帮助解决 IAM 和 AWS 云错误配置的问题。以下是 OPA 可以提供帮助的一些具体方式:

*   **定义和实施策略:** OPA 允许您将 IAM 和 AWS 云错误配置的策略定义为代码，可以对其进行版本控制、审查和测试。借助 OPA，您可以定义策略来确保遵循安全最佳实践，例如确保只有授权用户和应用程序才能访问 AWS 资源，确保传输中的数据和静态数据都经过加密，以及安全配置得到一致应用。
*   **实施细粒度的访问控制:** OPA 通过允许您定义评估特定于上下文的信息(如用户身份、资源类型和请求参数)的策略来提供动态授权。这使您能够实施细粒度的访问控制，从而降低权限提升攻击的风险并提高整体安全性。
*   **与现有工具集成:** OPA 可以与现有工具集成，如 AWS Config 和 AWS Security Hub，以提供一致的自动化方法来实施安全策略。例如，您可以将 OPA 与 AWS Config 一起使用，以在整个 AWS 环境中监控和强制遵守安全策略。
*   **提供策略决策的可见性:** OPA 通过允许您审计和分析策略评估来提供策略决策的可见性。这可以帮助您识别不符合的区域，并就如何改进安全策略做出明智的决策。
*   **支持协作和标准化:** OPA 允许团队在策略定义上进行协作，审查变更并确保策略在不同环境中保持一致。这有助于确保安全策略得到有效实施，并降低安全违规的风险。

## 使用开放策略代理的工具

Snyk 于 2022 年 2 月收购的云基础设施安全公司 Fugue 最近宣布将其两款旗舰产品 Fugue Platform 和 Fugue Risk Manager 合并为统一的软件即服务(SaaS)解决方案，名为 Fugue。

新产品结合了两个平台的优势，为云利益相关方提供了一个全面的解决方案，用于保护云基础架构、提供合规性保证和报告，并使应用程序团队能够“左移”并在软件开发生命周期的早期纳入安全性和合规性。

新的 Fugue 平台的一个关键特性是其 API，它使开发人员能够将云基础设施策略检查集成到 [CI/CD](https://thenewstack.io/a-primer-continuous-integration-and-continuous-delivery-ci-cd/) 管道中。这使得团队能够在开发过程的早期合并安全性和遵从性检查，有助于防止问题发生在下游。

例如，Fugue 使用 [OPA](https://thenewstack.io/getting-open-policy-agent-up-and-running/) 来实现云配置管理策略。OPA 可以将云安全策略定义为代码，可以在 CI/CD 管道中进行测试。

Fugue 还提供了一个策略库，其中包括通用云安全和合规框架的预定义策略，如 CIS AWS Foundations Benchmark、GDPR、HIPAA、NIST ISO 27001 800-53 rev . 4、PCI 和 SOC 2。用户可以自定义这些策略，以满足其特定的安全性和合规性要求。

当检测到违反策略时，Fugue 会自动创建一个补救计划来纠正问题。这可能包括更新云配置、对云资源采取行动以及向安全团队发送警报。Fugue 提供了对所有策略违规和补救措施的可见性，使安全团队能够跟踪和审计对云配置所做的更改。

此外，Fugue 的云资源可视化工具提供了云资源、配置和关系的自动生成的可视化，这有助于团队了解和跟踪随时间的变化。

这里将详细介绍由 Fugue 开发的两个开源 OPA 解决方案，并深入探讨作为 SaaS 解决方案的 Fugue 风险管理器。

### 边条

Regula 由 Fugue 开发，旨在帮助组织评估其云基础设施是否符合安全和监管标准。它还利用 OPA 框架为安全性和合规性提供了一种策略即代码的方法。

该工具的工作原理是分析云基础架构配置，并将它们与定义的策略进行比较。它支持扫描以各种格式存储的基础设施配置，包括 AWS CloudFormation、AWS Kubernetes manifests 和 Terraform。当检测到违规时，Regula 会提供有关该问题的详细信息以及如何补救的指导。

Regula 的主要优势之一是它可以集成到 CI/CD 管道中，以便组织可以评估其云基础架构的合规性，作为其软件交付流程的一部分。这有助于确保及早发现合规性和安全性问题，并快速解决这些问题。

### 弗雷戈

[Fregot](https://github.com/fugue/fregot) 对于任何使用减压阀政策语言的人来说都是一个很有价值的工具，它在 OPA 政策引擎中使用。使用 Fregot，开发人员可以在一个轻量级、用户友好的环境中评估表达式、调试代码、测试策略等等。

与 OPA 代理不同，它提供了专门为 Kubernetes 设计的通用组件和功能，Fregot 的开发旨在提供一个简化的、特定于减压阀的工具包，可用于增强开发体验。

这包括用于调试减压阀查询和模块的有用工具，以及增强的错误消息，使识别和修复问题变得更加容易。Fregot 还提供了扩展和试验不同语言特性的便利，对于想要试验减压阀语言并探索其全部潜力的开发人员来说，这是一个极好的选择。

### 神游风险经理

当强化 IAM 架构和改善组织的整体安全状况时，Fugue Risk Manager 是一个重要的工具，可以考虑作为 AWS IAM 安全工具的一部分。

它通过提供安全性和合规性来帮助解决与云基础架构相关的风险，并为基础架构团队提供单一的事实来源。

Fugue Risk Manager 扫描云环境，以发现正在运行的云基础架构资源，并识别基础架构合规违规情况。它通过实时检测和缓解安全风险，为 AWS 环境提供持续的安全性和合规性。

一旦建立了已知良好的基础设施基线，Fugue Risk Manager 就可以识别未经授权的更改和配置偏差。它会自动将漂移事件补救回调配的基准，确保基础架构保持安全和合规。

该工具还生成关于补救事件的合规性报告，允许组织维护其云基础架构更改的审计跟踪。

除了识别 AWS 帐户中的错误配置、漏洞和策略违规之外，Fugue Risk Manager 还提供持续的监控和报告，以帮助组织了解其基础架构安全的状态，并采取措施解决任何已识别的风险。

此外，Fugue Risk Manager 还与其他 AWS 安全工具(如 AWS Security Hub、AWS Config 和 AWS Inspector)相集成，以提供整个组织的 AWS 环境的全面安全视图。

## AWS 中 IAM 安全性的最佳实践

要维护 Amazon 云上的 IAM 安全性，请遵循以下最佳实践:

将尽可能少的权限授予所有用户。最小特权原则是[零信任安全策略的基石，](https://thenewstack.io/what-do-authentication-and-authorization-mean-in-zero-trust/)建议用户只应被授予执行其工作所需的最小权限集。这有助于最小化意外或恶意操作的潜在影响，并使理解和审核正在使用的权限变得更加容易。

请记住，IAM 权限可以通过 AWS 管理控制台、API 和 CLI 来授予，所有这些都应该尽可能地进行审核和锁定。

使用像 Fugue 最佳实践框架这样的工具可以帮助识别合规性检查可能遗漏的任何潜在漏洞。

将 IAM 变更作为变更管理流程的一部分也很重要，这样可以确保任何变更都经过适当的审查和批准。这有助于降低意外或未经授权更改 IAM 配置的风险。

“默认拒绝”的思想也是 IAM 安全性的一个重要方面。通过拒绝所有未经明确允许的访问，您可以帮助防止对您的资源进行未经授权的访问。此外，使用特权身份和会话管理工具有助于监控和控制对敏感资源的访问，从而提供额外的安全保护。

**使用单个 IAM 用户，而不是 root 帐户。**root 帐户拥有对所有 AWS 资源和服务的完全管理权限。通过使用 IAM 用户而不是 root 帐户，您可以委派管理控制，提供细粒度的权限，并增强 AWS 环境的安全性。

**使用群组将权限分配给多个用户。** IAM 组是向多个用户授予一组权限的一种方式。您可以将权限分配给一个组，然后将用户添加到该组，而不必单独向每个用户授予权限。这使得管理用户权限更加容易，并减少了进行更改所需的工作量。

**使用角色向 AWS 服务和应用程序授予权限。** AWS 角色允许您将权限授予 AWS 服务和应用程序，而不是 IAM 用户或组。例如，您可以授予一个角色，该角色允许 Amazon S3 向一个存储桶读写对象。这消除了与其他服务或应用程序共享 AWS 凭证的需要。

**对特权用户使用多因素认证(MFA)。** MFA 通过要求用户在访问 AWS 资源之前提供两种形式的身份验证来提供额外的安全层。建议为特权用户(如 IAM 管理员)启用 MFA，以帮助防止未经授权的访问。即使密码被泄露。

**定期轮换访问密钥。**访问密钥用于验证 AWS API 请求。访问密钥应定期轮换，以降低未经授权访问的风险。旋转访问密钥时，会创建一个新密钥，并停用旧密钥。

**删除不必要的权限和访问。**定期检查并删除任何不再需要的权限或访问特权。这有助于减少攻击面，并最大限度地降低未经授权访问的风险。

**监控和审查访问密钥、用户策略和认证日志。**监控和查看访问密钥、用户策略和认证日志可以帮助您检测和防止任何未经授权的访问。定期监控还可以帮助您识别可能指示潜在安全问题的趋势和模式。

**定义和测量平均恢复时间(MTTR)。**这对于在云环境中有效管理安全性至关重要。MTTR 是指检测和解决安全事件所需的时间。通过为您的 MTTR 设置目标，您可以确保您的团队能够快速响应潜在威胁，并将安全事件的影响降至最低。

测量 MTTR 还可以帮助您确定安全流程中需要改进的地方。例如，如果您的 MTTR 明显长于您的目标，这可能表明您的团队需要额外的培训或资源来更快地响应安全事件。

除了衡量 MTTR，建立一个持续监控和评估您的云安全状况的流程也很重要。这可以帮助您在错误配置成为安全风险之前识别和补救它们。自动化补救对降低 MTTR 特别有帮助，因为它可以快速解决问题，而无需手动干预。

## 结论

在 AWS 云中，管理大型数据集的安全性和合规性可能是一项艰巨的任务。简化这一过程的一种方法是将策略用作代码。通过将策略定义为代码，组织可以确保在所有 AWS 资源中一致地满足其安全性和合规性要求。

这种方法支持更高效的监控和审核，以及更轻松的安全和合规性流程自动化。此外，作为代码的策略有助于检测和防止错误配置和安全漏洞，这对于潜在风险较高的大型数据集尤为重要。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>