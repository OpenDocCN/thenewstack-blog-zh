# 切换到 Go 并了解它在这个过程中缺少什么功能

> 原文：<https://thenewstack.io/switching-to-go-and-learning-what-features-its-missing-along-the-way/>

从以前的 ruby 爱好者到自学 JavaScripters 的人，我们已经听说了许多开发人员冒险使用 Go 编程。简单性、性能、并发性和一个不断增长的、充满活力的 Go 社区是这些转变背后的一些理由。

在上个月的 Gophercon India 的演讲中，Errplane(现在是开源度量和分析初创公司 [InfluxDB](http://influxdb.com/) )的联合创始人 Matthew Campbell 讲述了他在切换到 Go、监控大规模 Go 服务器以及如何使用远程团队在大型平台上构建完全分布式项目方面的经验。

[马修·坎贝尔，InfluxDB:如何使用 Go](https://thenewstack.simplecast.com/episodes/matthew-campbell-influxdb-how-to-keep-wall-street-chatting-using-go) 保持华尔街聊天

Campbell 曾是 Rails 的开发人员，他在纽约和曼谷工作，曾帮助过彭博的项目。Campbell 讲述了他是如何决定在汤姆森路透的一个项目中开始使用 Go 的，这个项目是为股票交易者重建即时通讯平台，最初是用 Java 和 C++编写的。

汤森路透的 [Eikon Messenger](http://thomsonreuters.com/en/products-services/financial/equities-markets/eikon-messenger.html) 是谷歌之外较老的围棋应用之一，已经推出两年多，全球用户超过 30 万。它是东南亚和欧盟最大的金融即时通讯软件，在美洲排名第二，并运行着一个非常大的 Go 服务器。

坎贝尔描述了这个项目最初是如何在纽约开始的，但是因为他们在当地找不到 Go 开发者，他们最终在世界各地招聘，最终把它建成了一个完全分布式的项目。

Eikon 使用一个基于网络的平台，包括一个用于商品和金融咨询的完整的股票交易平台。Java 用于前端消息传递系统，但后端在 Go 中。坎贝尔列出了该平台使用的几个协议，包括微软 SIP，这是一个必要的组件，因为每个银行都使用微软的即时消息。

Campbell 还提到了在金融世界的现实中该项目的独特需求:“我们有一个非常敏感的设置，比大多数网络应用程序都要敏感。很多网络应用可能会宕机，可能会出现问题，但在即时通讯中，如果你崩溃了，用户会丢失消息，或者他们与你的服务器断开连接，那么他们会非常不安。”

> “我们的客户特别敏感，因为他们在这个平台上做了数千或数百万美元的交易。因此，当我们停机时，人们实际上每分钟都在损失金钱。所以我们必须非常优秀。”

Campbell 接着描述了他认为 Go 缺少的功能，以及团队使用的解决方法。首先，它缺少一个“像样的”XML DOM 解析器；该团队通过使用配备了 XML2 的 C 库进行了调整，但是遇到了与 C 和 Go 的集成问题。其次，它还缺少一个性能良好的正则表达式([正则表达式](https://en.wikipedia.org/wiki/Regular_expression))，因为使用 Go-Redis 库还不够；因此，团队使用 PCRE (Perl 兼容正则表达式)。序列化是 Go 中的另一个大问题:因为 Go 缺乏泛型，所以最终会进行大量的反射，从而降低垃圾收集器的性能。

关于垃圾收集的问题，Campbell 解释说，因为这是一个即时消息系统，用户对任何延迟都会感到沮丧，“这会破坏体验。因此，垃圾收集性能是我们的首要关键指标之一。”他还指出，垃圾堆的大小会影响垃圾收集的速度，因此面对缓慢的响应时间，团队不得不大幅减少堆的大小，并使用严格的方法测试性能。

但是坎贝尔指出，每个应用程序——不管它运行哪种语言——总会有 IO 性能问题。在这种情况下，系统必须处理成千上万的用户同时登录。为了应对这种情况，坎贝尔采用了一种被称为“俄罗斯娃娃方法”的策略，从一个名为 Nitro 的核心服务器开始，它有一个超快的内存缓存。IO 被分解为永久信息(名册列表、朋友列表和历史)和临时信息(当前位置、登录服务器)，并使用 Redis 进行处理，每个刀片服务器上运行大约四个 Redis 实例，从而确保在需要检索缓存数据时不会出现障碍。在 Redis 耗尽的罕见情况下，系统会转而使用 MySQL。当与一致散列相结合时，数据可以很容易地分布在所有 Redis 实例中，并且可以轻松地进行水平扩展，不需要在各个服务器之间进行协调，也不需要运营开销。

坎贝尔称赞围棋的一贯编译者说，

> “每次新版本发布，我们都在同一天编译，转换代码，不出一周，它就投入生产了。我们从未遇到过 Go 编译器弄乱我们代码的问题。这是我们拥有的最好的东西之一。”

另一方面，Campbell 指出，到目前为止，还没有关于 Go 的“好的集成测试套件”。为了克服这一点，产生了一个即时消息服务器集群，如 Redis、MySQL 和 [Elasticsearch](https://www.elastic.co/) ，并预先填充了数据，Bot 使用公共接口在其上运行，以完成集成测试。

虽然 Go 不支持动态链接，但是这个项目需要使用插件。作为一种变通方法，该团队使用 TCP 将插件链接回主进程。有时进程在同一个机器上运行，有时，当需要更高的性能时，它们被转移到自己的服务器上。“但代码不会改变，”坎贝尔说，“因为它只使用 TCP，所以机器在哪里并不重要，所以它提供了一个很好的扩展策略，你可以独立部署。”

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>