# SoundCloud 的 Prometheus:适用于集装箱的监控系统和时间序列数据库

> 原文：<https://thenewstack.io/soundclouds-prometheus-monitoring-system-time-series-database-suited-containers/>

Prometheus 是 SoundCloud 的下一代监控系统，已经赢得了 Docker 工程团队的好评。这是一项专为容器设计的服务，提供了关于这个新时代的数据密集度以及即使是互联网规模的公司也必须如何适应的视角。

[SoundCloud](https://soundcloud.com/stream) 当然是公开分享音轨的在线交换。这是一个非常受欢迎的平台，为艺术家提供了直接的好处，让他们被听众发现，可能被推广人发现，甚至可能被潜在的代理人发现。它使业余和专业音乐家能够分享一个共同的观众。

与 2007 年夏天相比，该公司面临着一系列新的现实，当时该公司建立在用 Ruby on Rails 编写的单一应用程序上。在当时，这是最直接有效的方法来构建一种服务，让音响发烧友可以立即开始使用。后端模型是一个带有完整公共 API 的单一存储库，使客户端应用程序能够利用他们想要的任何架构或平台。这就是当时开发人员所说的，保持简单。但是简单是没有规模的。对于巨石柱来说尤其如此——向[亚瑟·C·克拉克](https://en.wikipedia.org/wiki/Arthur_C._Clarke)道歉。

为了适应这种情况，SoundCloud 采用了微服务架构。在这一转变中，他们现在运行数百个服务和数千个实例，其中许多同时运行。还有关于理解数据的维度、缩放数据、拥有查询语言并使其易于管理的问题。考虑到这些因素，SoundCloud 开始寻找监控服务。他们找不到，所以他们创造了普罗米修斯，这实际上不仅仅是一个监控系统。它实际上是一个集监控服务和时间序列数据库于一体的产品。Johannes 'fish' Ziemke 是 Docker，Inc .的基础设施工程师，以前是 SoundCloud 的系统和基础设施工程师，[将 Prometheus](http://5pi.de/2015/01/26/monitor-docker-containers-with-prometheus/) 描述为“高维数据模型，其中时间序列由指标名称和一组键值对来标识。灵活的查询语言允许查询和绘制这些数据。它具有高级指标类型，如摘要、从指定时间范围内的总计构建比率或对任何表达式发出警报，并且没有依赖性，使其成为停机期间调试的可靠系统。”普罗米修斯是用 Go 编程语言编写的。

## 逃离巨石柱

当应用程序占用单个处理器的内存空间时，系统监控非常简单。它定期或按计划的报告周期进行。应用程序生成了日志，管理员对其进行了诊断。扩大规模是一个倍增的过程。您将相同的应用程序聚集在一起，并使用负载平衡器将客户端请求分配给它们。

今天，应用程序存在于网络中。在这些应用中，作业不仅通过盲目的负载平衡器，而且通过问题域或逻辑域的方式分布在多个服务器之间——服务器扮演离散的角色。然而，即使这种架构也有些单一(也许它会是“多石的”，除了那不是一个词)。

随着 monolith 用户数量的线性增长，为他们提供服务所消耗的时间也呈指数增长。正如 SoundCloud 开发者 Phil calado 去年 6 月写的那样，“我们觉得我们总是在修补系统，而没有解决根本的可扩展性问题。”

早期，SoundCloud 的开发人员知道他们需要转向微服务架构。微服务的概念从根本上来说就是它听起来的样子:相互关联的流程被划分成更小的逻辑域。当应用程序需要扩展时，产生新的流程比复制整个功能块更有效。

但问题是:当你在一个微服务架构上运行基于互联网的业务时，任何人都很难对其所有工作的状态进行总体监控。因此，没有一种不言自明的方法来确定为什么会出现瓶颈或如何修复它们。

## 卸载母舰

聪明的是，SoundCloud 团队选择逐步将流程从“母舰”(Arthur 爵士会喜欢这些人)过渡到她基于微服务的同行。至少在短期内，这两种体系需要共存。他们将通过对消息应用消费模型来实现这一点。微服务将尽可能地消耗这些消息，剩下的将由母舰处理。虽然最初的 monolith 是用 Java 构建的，但是每个微服务都可以使用开发人员认为最合适的语言来构建。

使用 DevOps 专业工具包中最常用的工具来监控母舰及其膨胀的宇宙。StatsD 从系统中的每个服务吸收相关的统计数据。它通过 [Graphite](http://graphite.wikidot.com/) 引擎刷新这些指标的相关数据来创建图表。但在 2012 年，SoundCloud 在 StatsD 和 Graphite 上遇到了与最初的母舰基本相同的问题:它们不可扩展。现在，微服务实例在任何时刻都数以千计，没有任何可靠的方法将这些服务生成的所有事件汇集到一个管道中。

SoundCloud 不得不考虑一种新的监控方式:主动采样。在你的脑海中想象一下，在一个蚁群中，每只工蚁都在不断地报告自己建造蚁群的进度。你会认为一个有效的系统应该是一个收集所有这些报告并把它们堆在女王桌上的管道。然而，在实际应用中，将每一份报告存档并不总是确定建设项目状态所必需的。让兵蚁在路上巡逻，并在行进中收集报告，这可能已经足够好了。

这个团队建造了普罗米修斯来管理兵蚁。Prometheus 以希腊神话中火的预兆或臭名昭著的恐怖科幻电影命名，它利用按时间序列排序的最小组织的键/值对数据库。这些关键字的组织方式使这些系列能够很容易地相互关联，从而实现多维视图，绘制一个系列与另一个系列的对比图，并寻找相关性。该团队构建了自己的图表系统 PromDash，不仅可以构建实时图表，还可以收集元数据，以便使用 SQL 形式进行临时查询。

[![A sample chart produced by PromDash [Courtesy SoundCloud]](img/65b904ab39f363f2f53ad16335edf3ce.png)](https://thenewstack.io/wp-content/uploads/2015/02/promdash_event_processor-1b82c8fbde0e1e14a1cae7dec0fef29b.png)

PromDash 制作的样本图表[由 SoundCloud 提供]

而且因为 SoundCloud 从一开始就把 Prometheus 设计成开源的，所以这个团队从来不是一个人。现在，该监控系统已经获得了 Docker 以及主数据管理平台制造商 Boxever 的大力支持。

去年 1 月 30 日，Boxever 的高级开发人员 Brian Brazil 在他公司的博客中写道:“你并不总是有能力改变你的服务代码来添加工具。”“许多供应指标[*都是*在一个单一的预定义格式中，对此你几乎无法控制。”

Brazil 展示了他的团队如何使用 Prometheus 的 exporter 函数获取 Java 的 mBeans 已经公开的测量数据，并将其转换为 Prometheus 可以使用的格式。因此，Boxever 的系统可以实时监控客户端延迟，而不必从每一个 bean 中获取元数据。

据 Prometheus 在 SoundCloud 的开发人员称，其结果是“操作简单”。您可以随时随地启动监控服务器，甚至可以在本地工作站上启动，而无需设置分布式存储后端或重新配置环境

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>