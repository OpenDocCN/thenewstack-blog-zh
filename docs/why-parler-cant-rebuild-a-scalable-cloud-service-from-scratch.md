# 为什么 Parler 不能从头开始重建可扩展的云服务

> 原文：<https://thenewstack.io/why-parler-cant-rebuild-a-scalable-cloud-service-from-scratch/>

当[亚马逊网络服务](https://aws.amazon.com/?utm_content=inline-mention)通知 Parler[终止其托管协议](https://www.theverge.com/2021/1/11/22223335/parler-amazon-terminates-web-hosting-aws-google-apple-capitol)时，该社交平台最初声称将在一周内重新上线。它似乎已经从 [Epik](https://malcontentment.com/parler-finds-new-domain-host-in-sammamish-washington/) 那里获得了 DNS 托管服务(这家位于华盛顿州 Sammamish 的公司托管了 8chan、the Daily Stormer、Gab 和 Stormfront 等网站，这些网站已经被其他提供商抛弃，最近也因此失去了与 PayPal 的关系)。

但后来的一份声明表明，其他提供商不愿意托管该平台，因此该服务可能不会回来:“大多数拥有足够服务器来托管我们的人都对我们关闭了大门，”一份针对 Parler 用户群的声明称，该公司的法律团队在法庭上表示，如果不能访问 AWS，他们可能不会回来。

即使社交网络找到了主机提供商，设置它需要的所有不同服务可能会非常慢，甚至是不可能的。尽管人们都在谈论混合计算和边缘计算，但对于拥有小型基础架构团队且没有太多资本支出预算、需要快速构建大型服务的组织来说，超大规模云仍有一些难以匹敌的优势。

## **非常跨云的迁移**

Parler 没有公布其架构的具体细节，尽管它最初表示，它没有使用任何特定于 AWS 的服务来将其绑定到一个云上。“我们从未依赖亚马逊(原文如此)的专有基础设施和制造裸机产品，为类似事件做好了准备。”

当然，Railsbridge 创始人 [Sarah Mei](https://www.linkedin.com/in/sarahmei/) 从 2020 年夏天断电的细节中推断出[的主数据存储是关系型的](https://twitter.com/sarahmei/status/1348476140596252672)，而[的基础设施规模非常小](https://twitter.com/sarahmei/status/1348478257545367553)。使用关系数据存储确实使设计功能变得更容易，比如允许用户编辑帖子(Twitter 会发现很难支持这一点，因为其分布式数据存储中的分片)，并且运行关系数据库是一项众所周知的任务(尽管 Parler 似乎没有太多关于关系数据库索引的经验)。Parler 甚至可能选择在虚拟机中运行关系数据库，而不是使用 RDS 来简化任何潜在的迁移，但是使用关系数据存储对于社交网络来说是一个不同寻常的实施决策，因为多少个表连接常见操作[将需要](https://twitter.com/sarahmei/status/1348477224467394560))，所以它需要一个与 AWS 具有相同性能和延迟的托管平台，以避免降低用户体验。

但帕勒自己对 AWS 的诉讼称，“应用程序和网站都是为了配合 AWS 的技术而编写的。”互联网侦探发现了 Parler 正在使用的多个 AWS 服务:AWS 证书管理器、AWS CloudFront 缓存、应用程序负载均衡器、Parler API 的弹性负载均衡、基于地理位置的 DNS 解析、S3 存储、甚至亚马逊简单邮件服务。

使用您用于托管的云提供商中的高级服务是合乎逻辑的；与使用 NGINX 或 [HAProxy](https://www.haproxy.com/?utm_content=inline-mention) 构建自己的负载平衡、使用 Squid 进行缓存、为基于地理的 DNS 路由选择单独的提供商相比，它们更便宜、更高效、更安全。ELB 有四种不同的内置负载平衡选项。Parler 甚至没有选择运行自己的邮件服务器；这是一项相对简单的任务，即使对于没有增加业务差异的商品也是如此。

但它也将您与 AWS 联系在一起，因为要迁移到另一个云，您必须用您迁移到的云中的等效服务来重新实施所有这些选择，这就是为什么从一个云提供商到另一个云提供商的大多数迁移都是经过大量规划后完成的长期操作，并且通常得到您要迁移到的云的帮助。

“所有这些都是相对构建块级别的原语，人们自欺欺人地认为，如果我在使用这些东西，这些东西在所有其他提供商中都是等价的，所以应该很容易移动。不是的。”鸭嘴集团[的首席云经济学家科里·奎因](https://www.duckbillgroup.com/)告诉新堆栈。

“这是每个人都告诉自己的谎言。因此，他们正在做的是减缓他们自己的功能开发，因为他们必须从这些原语构建东西[而不是使用更高级别的服务]。然而，当他们不得不搬走时，结果是‘哦，我们对物理数据中心中并不存在的东西有太多的依赖。“你在建立具有战略退出路径的东西的想法；你只是认为你是。你在扮演知道自己在做什么的人。”

从可以在不同云之间轻松切换的意义上来说，构建“多云”的想法很有吸引力，但在实践中，它与您的最低公分母功能相关联，并且仍然需要努力超越自包含虚拟机。

像 [Terraform](https://www.hashicorp.com/?utm_content=inline-mention) 这样的工具产生特定于云提供商的脚本。即使在不同的云上使用 [VMware 服务](https://tanzu.vmware.com?utm_content=inline-mention)在日常运营中也会有差异。

虽然容器和 Kubernetes 通过运行在表面上可互换的基础设施上的自包含包，甚至是使用虚拟 Kubernetes 从 Kubernetes 集群爆发到云 Kubernetes 服务的选项，在一定程度上解决了这一问题，但使基础设施真正可互换意味着使包真正自包含。这意味着，你必须拥有自己的所有实现，而不是调用云服务来获得授权、存储或其他任何东西。

承诺将云放入您的数据中心的混合云硬件是实现私有云的最有效方式，无需复制公共云已经完成的所有工作。但是，奎因再次指出，“这意味着你能够与公司做生意。”

“AWS 前哨站需要能够至少每六个小时与主区域同步一次。”Azure Stack Hub 可以在没有持续连接到 Azure 的情况下运行，但那[会降级或阻止某些功能](https://docs.microsoft.com/en-us/azure-stack/operator/azure-stack-disconnected-deployment?view=azs-2008#features-that-are-impaired-or-unavailable-in-disconnected-deployments)，你仍然需要有 Azure 订阅。在这两种情况下，可用的云服务都是有限的，并且您需要具备运行混合云系统的专业知识。

Quinn 说，一个新兴的选择是 Oracle 云专用区域。“他们声称你的设施中的每项服务都在全力运行，这样的努力的价格大约是每年 400 万美元或 600 万美元。”

## **构建云很难**

运行大型且受欢迎的服务不一定需要超大规模云的规模。像 Stack Overflow 这样每月有超过 1 亿访问者的网站可以在相对较少的服务器上运行(T4 大约有 20 到 50 台服务器服务于网站本身，尽管有更多的硬件用于网络、日志、监控、备份和其他关键的基础设施任务)。(Quinn 指出，Stack Overflow 还构建了一个 CDN，因此认为它是从少数服务器上的一个位置提供服务是不准确的。)

虽然 Stack Overflow 使用机器学习来推荐问题，以便在[主页](https://kevinmontrose.com/2015/01/27/providence-machine-learning-at-stack-exchange/)上显示，但这与脸书的规模不同，后者开发了自己的人工智能加速硬件，你需要使用 AWS、Azure 或 GCP 来匹配。如果像 Parler 这样的服务想要建立一个算法 feed 来推荐帖子、群组或其他成员，那就需要更多的基础设施。

但是即使没有这些，一个服务需要的不仅仅是网站托管和负载平衡。DDoS 攻击持续上升；根据 Cloudflare 的数据，2020 年，从 Q1 到 Q2 的数量翻了一番，然后在第三季度再次翻了一番。越来越多的攻击是小规模、短暂的攻击，可能在您通过手动分析发现它们之前就已经结束了，但仍然会造成损害。鉴于赎金驱动的 DDoS 攻击的增加，每个服务都需要一个 DDoS 提供商，最好是一个拥有足够复杂的工具来区分好访客和恶意机器人的提供商；像帕勒这样的人更是如此。

构建一切从 MFA 和认证服务(用于注册新用户和安全地更改密码)到计费系统再到备份和监控，就像回到了过去。“你最终基本上把时钟拨回到 20 年前，回到所有这些东西都存在之前的时代，而你自己则从零开始打造这一切。这是可能的，但这种无差别的繁重工作需要花费太多的时间、精力和金钱，而云的奇迹是你不必这样做。”

奎因指出，仅仅是为社交网络设计正确的架构和基础设施就需要专业知识(对于拥有这种知识的员工来说，竞争非常激烈)。“在这个领域，经验决定一切，你必须有大规模扩展事物的经验，并了解这些事物在压力下如何破裂，以便能够有效地对这些事物进行推理。”

即使在云中，尝试扩展计算和存储并跨多个区域保持弹性(以避免停机并为全国和世界各地的用户提供良好的连接)也是一件棘手的事情。自己构建所有的基础设施，并随着业务的增长进行扩展则完全是另一回事。

以云存储为例。“每个大型云提供商都有一个对象存储。如果你想在自己的数据中心运行一个对象存储，你要么运行一些会有性能问题的 janky 开源项目，要么在一堆大型服务器和驱动器上安装一些供应商的存储解决方案。”云提供的不仅仅是现成的对象存储，还有极高的耐用性，这意味着硬盘故障不会影响生产；事实上，它们可以在任何时候发生，对可用性没有影响。

像 AWS、Microsoft Azure 和 Google Cloud Platform 这样的云服务在存储(以及他们业务的每个其他领域)方面的专业知识是难以匹敌的，这就是云订阅让你利用的优势。“有一个团队将他们的整个职业生涯都奉献给了探索人类知识的扩展总和，即硬盘如何发生故障，如何避免故障，以及如何以最理想的方式用最少的成本更换硬盘。”

云服务使用[擦除编码](https://towardsdatascience.com/erasure-coding-for-the-masses-2c23c74bf87e)；AWS 没有给出具体的细节，但微软记录了几年前它如何在 Azure [中使用擦除编码来节省空间和降低成本。“他们把一个文件或一个对象分割成，比如说，100 个块，其中任何 70 个块都可以重新组合来传送文件。这是得到那些可笑的耐久性数字的唯一方法；AWS 可能会失去整个设施，而 S3 不会遭受数据丢失。”](https://azure.microsoft.com/en-us/blog/data-series-usenix-best-paper-award-erasure-coding-in-windows-azure-storage/)

您可以在 Windows Server 中使用 Storage Spaces Direct 进行擦除编码，但这并不能等同于云存储，这在您自己的数据中心中可能没有意义。“对象存储令人生厌、过于挑剔，而且会妨碍您的工作，因为它是 s an 之上的一个中间层。为什么不直接与 SAN 对话，并在事情可能发生时为自己节省复杂性。”当然，这将意味着重写基于对象存储的堆栈部分。

但是你也不会得到近乎无限的云存储空间。Quinn 指出，“你不能比他们增加额外容量的速度更快地写入数据”，并补充说，如果有必要，亚马逊可以暂时驱逐自己的工作负载，以便在增加容量的同时为客户提供更多资源。

在托管或托管设施或您自己的数据中心中调配虚拟机与在云 IaaS 服务中不同，在云 IaaS 服务中，代理将自动应用于虚拟机，一些服务将立即可用。

云服务中的网络是软件定义和虚拟化的，并由全球连接提供支持:对等、存在点、互连、共享和全资海底电缆甚至卫星连接的混合，这意味着任何地区的任何实例都可以连接到服务和其他实例，并且只要在软件中进行配置，就可以从外部访问。你从 ISP 处获得的互联网连接或作为主机包的一部分，将需要更多的配置和更多的管理(如果反铲挖土机碰到你的连接，你将需要备用光纤和供应商)。准备习惯于处理错误的或恶意的重定向互联网流量的 BGP 路由:云提供商会为你解决这个问题。

奎因指出，云区内部的网络连接也面临很大压力；“架顶式交换机拥塞是大多数人不会考虑的事情，因为大多数人没有大规模构建这些东西”。对网络的改变也必须小心进行；例如，Azure 模拟其整个 Azure 网络，并提前实践所有主要更改以避免错误。

当然，这是在您拥有数据中心和服务器之后。计算、存储和网络都必须针对您自己的数据中心的峰值负载进行调配；这意味着与供应商谈判服务器和网络硬件价格，将它们供应并交付给准备安装它们的设施(在疫情 2021 中更棘手，供应商和托管设施之间通常需要两到三个月的时间)。硬件、数据中心空间和互联网连接将会增加一大笔前期费用或多年合同。

不要忘记电源和冷却。绿色能源可能不是 Parler 的关注点，但对于致力于将可再生能源作为企业社会责任计划一部分的组织来说，云是一个有意义的选择[前 AWS 建筑师和技术环境顾问 Paul Johnston](https://twitter.com/PaulDJohnston) 告诉我们。“云在将电网升级为可再生能源等方面带来规模经济方面表现出色。因此，数据中心/云行业的整合是一件好事，因为它将重点放在绿化我们的工作负载上。”

## **云改变了游戏**

奎因指出:“每个 AWS 区域都要花费数十亿美元和数年时间。”如果你甚至需要一小部分云服务，你也不能在一夜之间建立基础设施或堆栈，尤其是当你不确定你将增长多快，甚至你是否会继续经营的时候。

“云的真正强大之处在于，我不再需要投资数十万美元来构建一个相对较小的系统，也不再需要花费数月时间，我只需向任何一家云提供商申请一张信用卡。我可以立即进入控制台。我开始四处点击或使用 API，我得到类似空服务器的东西或更高级别的托管服务产品，我能够立即开始使用它们。”

实验成本很低:如果业务成功，你可以在同一个云提供商上发展到大型组织的规模。在这一过程中，云提供商将以私有数据中心难以企及的速度和规模构建新功能，并提供更快或更便宜的新实例类型；这是一个良性循环。“实际上，今天没有人会从一个想法开始，然后尝试去证明它，也没有人会使用云提供商，只是因为你为什么要这样做？”

即使迁移到云也需要时间，这是因为云提供商和第三方服务提供了现成的迁移工具。反其道而行之没什么帮助。

“也许在遥远的未来，我决定采用脸书，并意识到对于我们目前的规模，这些工作负载在云上运行可能没有意义。Dropbox 尝试过，但不太顺利…在这种情况下，我可以非常有意识地建立一个数据中心或租用数据中心空间，并迁移那些由于任何原因无法驻留在云中的非常特定的工作负载。”奎因说，但这不是帕勒想要做的。

“如果由于各种原因使用 AWS 变得不可行，我将如何停止使用它？这是许多公司都有的一个非常真实、非常有效的担忧，问这个问题绝对没有错。”解决方案可以是云迁移、多云、混合云或私有数据中心。但这与帕勒面临的问题不同。“如果我的公司变得如此具有辐射性，以至于没有一家值得尊敬的公司会同意与我们做生意，该怎么办？”

大多数组织不必将云服务条款视为一种生存威胁。如果 AWS 不与你打交道，你将很难成为主流数据托管服务、DDoS 保护服务和其他供应商的客户，这些供应商有能力和连接性来保持像 Parler 这样的服务在线，即使他们可以建立自己的技术栈。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>