# Kubernetes 策略执行的 4 个最佳实践步骤

> 原文：<https://thenewstack.io/4-best-practice-steps-for-kubernetes-policy-enforcement/>

[](https://www.linkedin.com/in/robert-a-brennan/)

 [罗伯特·布伦南

罗伯特·布伦南是 Fairwinds 的开源总监。Robert 在 Fairwinds 推动软件计划，重点放在开源上。他帮助公司以安全、可扩展和用户友好的方式采用和维护 Kubernetes 集群。](https://www.linkedin.com/in/robert-a-brennan/) [](https://www.linkedin.com/in/robert-a-brennan/)

随着组织对 Kubernetes 的采用越来越成熟，对控制的需求也越来越大。无论是法规遵从性还是安全性在推动需求，控制都转化为创建和实施策略。由于 Kubernetes 和容器的动态和短暂的性质，这可能是一个巨大的挑战。首先，如何制定正确的政策？第二，你如何执行它们？

具有多个 Kubernetes 集群和多个用户的环境中的不一致性会导致安全事故和停机，并产生新的违规合规性要求。我们都知道，要符合任何行业法规和组织指导原则，我们不能简单地编写策略并信任个人会遵守它。策略执行已经成为安全和网络访问的标准。这也必须成为 Kubernetes 的标准。

## 多用户、集群和租户 Kubernetes 环境的一致性挑战

由于多个工作负载以不一致的方式或手动方式部署和修改，管理群集配置变得非常困难。如果没有护栏，集装箱和集群之间的配置可能会有差异，这对于识别、纠正和保持一致性是一个挑战。然而，手动识别这些错误配置是非常容易出错的，并且会很快让运营团队不堪代码审查的重负。然后，DevOps 团队疲于响应页面和灭火，几乎没有时间对基础架构进行实质性改进或执行例行升级。组织浪费时间和金钱来应对由可避免的错误配置引起的问题。

这就是执行策略模式对 Kubernetes 的成功至关重要的地方。策略实施提供了一套一致的标准，以便工程团队避免产生安全漏洞、过度消耗计算资源或引入嘈杂的工作负载。这里是 Kubernetes 策略执行的四个最佳实践。

### 1.了解您的 Kubernetes 战略

您的组织可能已经有了一套策略。有些可能适用于 Kubernetes，有些可能不适用。您应该从询问有关安全性、配置和工作负载的问题开始。

为了安全起见，您需要能够回答:

*   谁有权访问集群？
*   用户可以在集群中采取什么行动？
*   工作负载在集群中拥有什么级别的权限？
*   您的集群中工作负载之间的网络策略是什么？

对于配置，您希望能够回答:

*   Kubernetes 资源是在哪里定义的(例如，在基础设施即代码回购中)？
*   发生了什么变化，什么时候？
*   您对资源变更的代码审查流程是什么？
*   什么类型的资源可以部署在您的集群中？
*   哪些名称空间可供哪些用户使用？
*   工作负载部署到哪些命名空间？
*   如何设置工作负载或名称空间的可用资源量？
*   跨工作负载的通用标准/默认值是什么？

对于部署，您希望能够回答:

*   谁可以向您的集群部署工作负载和服务？
*   如何将工作负载和服务部署到您的集群中(例如，通过 CI、kubectl 或 Helm)？
*   环境之间的晋升路径是怎样的？
*   谁负责您环境的哪些方面？

通过回答这些问题，您可以进入创建策略的下一步，使 Kubernetes 更加安全、可靠和高效。

### 2.创建 Kubernetes 策略

在 Kubernetes 中，策略最好用代码来定义。策略即代码受益于版本控制、审计、测试和可重复性。您可以在审核模式下使用这些策略来监控现有资源的错误配置，或者在强制模式下使用这些策略来防止新的错误配置进入集群。

策略分为三类:

*   标准策略:在所有组织、团队和集群中实现最佳实践。例如，不允许默认命名空间中的资源，要求设置资源限制，或者阻止工作负载以 root 用户身份运行。
*   特定于组织的策略:实施特定于组织的最佳实践。例如，要求每个工作负载都有特定的标签，强制执行允许的映像注册表列表，或者有助于满足合规性和审核要求的策略。
*   特定于环境的策略:针对特定的集群或名称空间实施或放松策略。例如，在 prod 集群中实施更严格的安全措施，或者在运行核心基础设施的名称空间中实施更宽松的策略。

但是仅仅制定这些政策是不够的。我们都曾遇到过政策手册被搁置在书架上积满灰尘的情况。当安全性、合规性和成本超支悬而未决时，强制执行是必要的。

### 3.实施这些政策

简单地为您的工程团队准备一份最佳实践文档是行不通的——它很可能会被遗忘或忽略。Kubernetes 策略执行有助于防止常见的错误配置被部署到集群中，支持 IT 合规性和治理，并允许团队在知道护栏已到位的情况下放心发货。

在接近 Kubernetes 策略执行时，有三个选项可供选择。

首先是开发自己的内部工具。当然，工程师喜欢为一个问题开发他们自己的工具；然而，领导者需要决定他们的团队是否可以花费时间、金钱和资源来开发和维护自主开发的工具，而不是致力于特定于他们业务的问题。

下一个选择是部署开源。有许多不同的开源工具可以帮助进行安全性、效率和可靠性配置。有开源审计工具，如 Trivy(用于容器扫描)和 kube-hunter(用于网络嗅探)，以及 Fairwinds 自己的贡献，如 Polaris(用于配置验证)和 Goldilocks(用于审计资源请求和限制)。开放策略代理(OPA)是一个开源的通用策略引擎。

如果您选择开源路线，您的团队将花费时间部署和管理每个工具。你需要问问你的团队是否有足够的带宽来做这件事，以及这是否能让你专注于那些能为你赚钱的应用或服务。

第三个选项是选择策略驱动的配置验证平台。这些平台在单一平台后面结合了一套开源工具。策略可以联合到您的每一个环境，联合到您的 CI 管道(当它检查基础架构即代码时),联合到您的集群的准入控制器，并扫描您的机群中的每一个集群。您将能够看到集群何时合规，以及何时变化可能会使您不合规。对于 Kubernetes 经理来说，策略驱动的配置验证平台使您能够从 CI/CD 管道到生产中自动执行策略，并维护一个安全、高效和可靠的环境。

### 4.使用策略实施获得多集群可见性

没有可见性，运营团队就无法查明导致安全和合规性事件、停机和计算资源超支的错误。如果您实现了一个 Kubernetes 策略执行平台，您还可以使用它来了解集群中实际发生的情况。

策略控制面板通过提供跨集群的共享可见性，有助于弥合开发和运营团队之间的分歧，因此他们可以在花费时间或金钱之前预测和修复问题。运营团队可以使用一个平台来统一检查和应用 Kubernetes 的最佳实践。这种可见性对任何努力管理 Kubernetes 的人来说都是一个巨大的好处。

通过遵循这四个步骤，工程领导可以放心地知道 Kubernetes 在多个团队和集群中是正确的。

通过 Pixabay 的特征图像。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>