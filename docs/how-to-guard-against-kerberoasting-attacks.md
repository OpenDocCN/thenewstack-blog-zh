# 如何防范 Kerberoasting 攻击

> 原文：<https://thenewstack.io/how-to-guard-against-kerberoasting-attacks/>

[](https://www.semperis.com/)

[Sean DEU by](https://www.semperis.com/)

[Sean DEU by 在 Semperis 担任服务总监，他在企业 IT 和混合身份方面拥有 30 年的经验。作为 Intel 的 Active Directory、德州仪器的 nt 网络的原始架构师和技术领导者，以及 15 次 MVP 校友，Sean 从一开始就参与了 Microsoft identity。从那以后，他在许多财富 500 强公司担任身份战略顾问的经历让他对当今以身份为中心的安全挑战有了更广阔的视角。肖恩是行业新闻资深人士；作为 Windows IT Pro 的前技术总监，他发表了 400 多篇关于 AD、混合身份和 Windows Server 的文章。](https://www.semperis.com/)

[](https://www.semperis.com/)[](https://www.semperis.com/)

被称为 Kerberoasting 的网络攻击方法已经存在了一段时间。但这并不意味着网络罪犯不喜欢它。Kerberoasting 认证仍然是针对 Microsoft Active Directory (AD)的最普遍、最有效的攻击之一。

2020 年 12 月，美国国土安全部发布了一项指令，指示联邦机构防范 Kerberoasting，作为减轻网络安全管理软件产品袭击危险的一部分。这项技术也与勒索软件攻击有关。对于 AD 管理员来说，Kerberoasting 是一种他们会后悔忽略的策略。

作为快速入门: [Kerberos](https://web.mit.edu/kerberos/) 是一种认证协议，用于验证用户或主机的身份。客户端从 Kerberos 密钥分发中心(KDC)接收票证，然后在建立连接时将票证提供给服务器。(每个域控制器都有一个 KDC。)在 Active Directory 中，票证授予票证(TGT)允许用户请求票证授予服务(TGS)票证，该票证可用于访问加入域的资源，如文件服务器。

鉴于 Kerberos 在身份验证中的作用，它显然是攻击者感兴趣的目标。Kerberoasting 策略是威胁者用来加强对受害者控制的主要方法之一。一旦攻击者进入目标环境，他们就执行 Kerberoasting 认证来窃取服务帐户凭证的散列。这些帐户通常具有管理员权限，经常被忽视，并且往往具有不安全且不会过期的密码。这种攻击给网络罪犯带来的一个好处是，他们不必以提升的权限登录即可执行。任何域用户的帐户都可以。

Kerberos 认证是这样工作的:

*   在危及域用户帐户的安全并向 AD 进行身份验证后，威胁参与者在其本地域控制器上收到来自 KDC 的票证授予票证。从那里，攻击者向 DC 请求服务票，无论他们选择什么服务作为目标。
*   域控制器将创建一个票证授予服务票证，用服务的密码对其进行加密，然后将其交给用户。在正常情况下，用户然后将 TGS 票证传递给服务，服务将对其进行解密，并根据用户是否具有适当的权限来授予或拒绝访问。
*   威胁参与者不一定关心对服务的访问；他们已经得到了他们所需要的 TGS 入场券。有了这个票，攻击者就拥有了服务帐户的弱加密密码哈希(记住，哈希是用来加密票的内容的)。然后，攻击者可以通过 Mimikatz 等工具从系统内存中提取密码哈希，然后使用 Hashcat 和 John the Ripper 等工具离线破解。破解密码哈希后，攻击者可以利用服务帐户的提升权限或继续进行域侦察。

攻击者可以通过枚举 AD 环境中的服务主体名称(SPN)来识别他们想要作为目标的服务帐户。SPN 用于在 AD 中宣传服务，因此用户可以轻松地发现它们。所有通过 AD 身份验证的用户都可以查询具有 SPN 的帐户。出于实际原因，只有域用户 SPN 容易受到 Kerberoasting 认证的攻击。基于主机的服务帐户使用 128 个字符的随机生成的密码，该密码每 30 天更改一次，而组管理的服务帐户(gMSAs)使用超过 100 个字符的随机复杂密码，该密码会自动更改。与域用户帐户绑定的 SPN 的密码是由人创建的，因此更容易被破解。

## **反击 Kerberoasting 认证**

减轻 Kerberos 认证很困难，因为这种攻击滥用了 Kerberos 固有的功能。例如，任何经过身份验证的域用户都可以为网络上的服务请求 TGS 票证。然而，问题是处理请求的域控制器并不关心用户是否有权访问他们请求票证的服务。是服务本身实施了访问控制，从而为攻击创造了机会。

然而，这并不意味着组织没有反击的手段。从检测的角度来看，组织应该监控可疑活动，例如请求异常数量的服务票证的域用户帐户。组织可以审计 Kerberos 服务票据操作，尽管这样做将生成如此多的日志，以至于在没有为特定环境建立基准的情况下，输出很可能是无用的。

由于这种方法可能会产生大量噪音，因此阻止这类攻击的更好策略可能只是要求服务帐户使用更强的密码。这些密码应该至少有 30 个字符，并且应该定期轮换以降低风险。随机密码生成器随处可见，所以只需跟踪它们就行了(最好是在特权访问管理解决方案中)。

此外，组织必须确保正确监控和管理服务帐户。拥有过多特权的帐户对攻击者来说是特别有吸引力的目标。同样，特权帐户(如 Administrator)永远不应该有与之相关联的 SPN。

通过良好的密码安全和持续的监控，组织可以减少网络犯罪分子利用 Kerberoasting 认证这一长期流行的策略来破坏其活动目录环境的威胁。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>