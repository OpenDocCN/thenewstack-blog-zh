# 毕马威从代码基础设施中学到了什么:工具、人员和过程

> 原文：<https://thenewstack.io/what-kpmg-learned-about-infrastructure-as-code-tools-people-and-process/>

咨询公司[毕马威](https://home.kpmg/xx/en/home.html)的软件工程总监杰夫·阿迪利奥认为，虽然软件开发已经发生了巨大的变化，以帮助公司更快地交付，但在运营方面却不太真实，但这是需要发生的。

“基础设施即代码(IaC)提供了一种使运营更加敏捷和高效的方式,”他上周在旧金山的一次 [DevOps World|Jenkins World](https://www.cloudbees.com/devops-world/san-francisco) 演讲中说道。他正在讲述从这家专业服务公司的客户工作中吸取的经验教训。

在演讲中，他讨论了在组织环境中关于基础设施即代码的考虑，包括文化、日常工作流程和使用的工具中的潜在变化。

## 真理的单一来源

IaC 是一种管理基础架构及其所有部分(从网络到虚拟机再到负载平衡器)的方式，它是关于环境的真实信息的单一来源。

基础设施即代码是一个声明性模型，用于定义基础设施的外观。在这种方法中，我可以查找我所有的连接。我可以与其他项目、其他团队分享配置的一点一滴。我可以让其他人回顾这些变化，他解释道。

对于一个金融服务客户，一个三人小组使用 IaC 在七个不同的环境中管理和创建了 7，000 个不同的基础架构资源。这些是覆盖多个地区的生产和非生产环境。

手动管理 7，000 个不同的部分需要花费大量时间，而且容易出错。失误导致漂移。他说，作为代码的基础设施可以帮助标准化该过程，并确保每个环境都是相同的，并将变化传播到每个环境。

对于像金融服务这样高度监管的行业，审计非常重要。您需要一种方法来轻松检查基础架构以及它将如何部署。这个声明性模型是人类可读的。使用 IaC，技术风险、安全和内部审计可以发展。It 可以建立信任来加快批准过程，从而更快地做出更改。

他说，它也不需要大量的调试时间。有了模型或计划，您只需将现有状态与预期状态进行比较就可以找到问题，然后重新应用计划来恢复它。

## SaaS 与不可知论者

Ardilio 说，这是工具、人员和流程的问题。

“有很多工具，但我们必须让我们的人和流程保持一致，以便在这些工具上执行，”他说，并解释说他不想深入研究这项技术。

所有主要的云提供商都提供某种程度的基础设施作为代码，尽管它是可重复的，但这并不意味着它在所有这些新环境中都是一键启动的。他说，进入一个新环境确实需要一些准备。如果其他团队要使用这些环境，您需要理解并为此做好准备。

IaC 即服务的缺点是受提供商的限制，这对于一些组织来说比其他组织更重要。另一个需要考虑的问题是弹性，因为云提供商也不能避免停机。

采用更加独立于供应商的方法消除了锁定问题，但也带来了其他问题。

“如果一个新的产品或服务在某个云提供商上可用，并且我正在使用 [Terraform](https://www.terraform.io/) ，例如，一个建立在插件和模块上的抽象层，那么这个新的插件或模块可能不会立即存在于该云提供商。我需要思考这意味着什么。我可能需要向社区寻求对该模块的支持，”他说。

### 分享文化

然后是人的问题，“这可能是我工作过的组织要克服的最困难的障碍之一，文化方面，”他说。

我们需要开始考虑将事情分解成模块、不同团队共享的模块或组件。他说:“我们需要在软件方面学到的原则——最佳实践、迭代过程、反馈循环——并在基础设施方面应用它们。”。

将基础设施作为代码使用的软件开发人员可能不具备基础设施知识，但是具有关于如何将大型事物分解成更小的可用组件的工程思维。

“我如何找到重复的模式并将工程技能应用到基础设施中。这需要那种心态，”他说。

“我们需要创造一种对试验和尝试新事物持开放态度的文化。我们需要快速失败。我们需要从错误中吸取教训。我们需要分享，我们需要合作，我们需要建立最佳实践，”他说。

建立这种文化使组织能够在过程的早期引入技术风险人员和安全人员。

“他们是我们团队的一部分。作为我们团队的一部分，他们正在填补…我们需要实现的需求，这是我们期望的验收标准。

“我们完成代码并做出更改，他们根据验收标准对代码进行审查。因为有了 IaC 和这个数据模型，它实际上非常易读。技术风险人员可以真正理解我们正在进行的实施，并批准该流程。作为一名技术风险人士，我不再同意已经在运行的东西。我正在签署即将部署的东西，”他说。

### 建立信任

更短的迭代是敏捷的关键。

“我们想把变化推出去。我们不希望它们堆积起来。我有一个季度发布周期的客户，这个发布周期有 40 个批准者列在变更请求上。每个人都不敢相信这个系统，因为一切都是手动的，”他说。

一旦变化越积越多，风险就越大。IaC 购买的是建立信任的手段。他说，技术风险人员在流程中参与得越多，他们就越舒服，越信任，也越愿意批准对流程进行标准更改，这有助于更快地将这些东西推出去。

他说，版本控制在基础设施代码和应用程序代码中同样重要。

“我看到很多公司已经迁移到 Git。他们只是把它当作另一种工具。他们在做以前做过的事情，但只是在 Git 中，不一定利用最佳实践，”他说。然而，您已经有了所有这些变化，您如何最好地管理所有这些版本呢？他推荐类似于 [GitFlow](https://datasift.github.io/gitflow/IntroducingGitFlow.html) 或其他建模工具的东西。

如果您管理七个不同的环境，源代码控制可能会是一个问题，无论您是为每个不同的环境使用一个 repo 和一个 fork，还是为每个环境使用一个分支，等等。管理起来变得一团糟。人们试图在这些环境中传播变化时会遗漏一些东西。KPMG 使用单一源代码 repo——一个文件，其中有一些对每个环境都是唯一的东西，比如它的名称和它所连接的对等体——来保证一个环境中的变化会将需求传播到所有环境。

他说:我们需要支持模块化、组件驱动的设计。我们需要寻找机会来创建可重用的组件。

“如果我以一种方式解决问题，而另一个团队以不同的方式解决，如果我们想要做出改变，如果我们在一个地方做出改变，那么所有其他地方都需要改变。所以我们需要考虑这一点。找出那些重复的模式，”他说。

### 涉及无数团队

代码评审也和应用程序代码一样。

“随着公司开始采用 IaC 原则，即框架，代码审查是分享信息的好方法，”他说。“每个人对待事情的方式都会有所不同，尤其是当每个人都还在学习的时候。让以不同方式处理事情的多个人参与代码审查过程非常有帮助。”

在这些代码评审中，他们不只是评审代码，而是评审这些计划。对于一个拉请求，管道要做的第一件事是为它所连接的七个环境中的每一个提出一个计划。这就是系统所说的在七种不同环境下要做的事情。它将创建这个资源，删除这个资源，修改这个资源。你可以看到它将如何在每一个这样的环境中发挥作用。这为接受该拉取请求创建了标准。

在管道中，我可以开始引入诸如策略检查之类的东西。它允许我们根据特定条件创建自动通过/失败。这些条件成为我们如何执行不同政策的关卡。如果我将一个新的存储卷连接到我的一个虚拟机，必须对其进行加密，因为我们的政策要求这样做。策略检查可以强制执行。

“这些是自动化可以帮助我们在部署之前对我们的变化可能产生的结果建立信心的方式，”他说。

它还提供了一种方法，不仅可以开始测试这些策略，还可以开始测试这些环境的创建和破坏。

这是一个常见的场景，他说:

您做出了改变，现在部署了它，它现在工作了。但是你没有意识到你的改变间接依赖于计划中的其他东西。十步计划已经开始实施。步骤 3 有变化，所以是 3.1。如果您应用 3.1，它可能会运行，因为步骤 10 已经在过去的某个时候应用过了，您不需要重新应用它。但是当你试图建立一个新的环境时，也许几个月后，这个计划开始失败，因为你有一个未知的依赖。

“有些框架有内置的方法来帮助进行依赖跟踪，但情况并非总是如此。…这是及早发现这些事情的好方法。他说:“如果我能根据我的拉取请求分配状态，并建立一个全新的环境，然后将整个环境拆除，我就能更快地识别这些东西。”。

所有这些团队都在为一个更大的整体的不同部分、不同平台而工作。每个人可能都有自己的项目，他们为每一个部分管理。不可避免地会有共享资源，团队在处理不同部分时会发生冲突。一个群体的变化会把另一个群体的变化吹走。他说，弄清楚团队如何解决这个问题至关重要。

CloudBees 赞助了这个故事，由 New Stack 独立撰写。

专题图片:[提炼出的](https://www.flickr.com/photos/distillated/)管图拼图。根据 [CC BY-SA 2.0](https://creativecommons.org/licenses/by/2.0/) 授权。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>