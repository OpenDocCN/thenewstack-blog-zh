# 如何应对片状测试

> 原文：<https://thenewstack.io/how-to-deal-with-flaky-tests/>

[](https://www.linkedin.com/in/serkanozal/)

 [塞尔坎·奥扎勒

塞尔坎是桑德拉的联合创始人兼首席技术官。他在软件开发方面有 10 多年的专业经验，是 AWS 认证专家，拥有分布式环境专利。他主要从事无服务器架构、分布式系统和监控工具方面的工作。](https://www.linkedin.com/in/serkanozal/) [](https://www.linkedin.com/in/serkanozal/)

构建 CI/CD 管道的主要目标是提高开发速度。集成和部署过程自动化程度越高，新版本发布的速度就越快。测试套件——检查代码中引入的错误的测试集合——是这种管道的关键部分。

有时，测试可能是不可靠的，这意味着它们在没有任何代码更改的情况下，以看似随机的间隔失败或成功。您需要多次运行测试套件来确定您是否有一个 bug 或者一个不可靠的测试。这个过程极大地减慢了你的 CI/CD 流程。如上所述，这些管道应该*提高*开发者的速度，而不是阻碍你。

如果您的套件中有太多古怪的测试，它们也会削弱您对这些测试的信任。如果一个测试随机失败，你怎么能相信另一个测试不会做同样的事情呢？如果对您的测试没有信心，您的团队可能会停止认真对待测试结果，甚至从一开始就停止编写测试结果。

## 如何识别不可靠的测试

有两种方法可以感受到你的测试有多不可靠。一种是多次运行一个测试，甚至是整个测试套件。如果您没有在测试运行之间更改任何代码，并且测试套件在每次运行时显示不同数量的失败测试，那么您可以确定您的测试出现了问题。

另一种方法是每次以不同的顺序运行它们。如果您的测试在顺序改变时失败，这是您没有考虑测试间依赖的一个标志。

一些工具可以对此有所帮助。对于 Java 开发者来说，有一个[Gradle 插件](https://blog.gradle.org/gradle-flaky-test-retry-plugin)，它将重新运行你的测试，看看它们是否是确定性的。虽然这不能节省您的时间，但它至少自动化了寻找不可靠测试的过程。

Spotify 构建了一个 GitHub bot，它可以在合并之前多次运行新代码的测试——你可以在 pull 请求时手动启动它。虽然这个机器人不是公开可用的，但构建这样一个工具很容易。

[AVA](https://github.com/avajs/ava) 是另一个 JavaScript 测试者。它并行运行您的测试，这样做的好处是可以同时开始所有的测试，所以它们不会互相依赖。

另一个选择是桑德拉 Sidekick，它允许开发人员通过设置断点，用非侵入式调试来排除测试故障。通过这种方式，开发人员可以弄清楚测试是否真的不可靠。

## 如何解决易变的测试？

现在您可以找到这些不稳定的测试，您需要修复它们。这里有七个非常有效的策略。

### 1.可视化测试运行

虽然单独的测试运行可视化可以让您了解您的测试工作得有多好，(结合多个随机的测试运行)您也将清楚地了解到不可靠的测试随着时间的推移是增加还是减少。一个简单的表格，行显示时间，列显示测试就足够了。

### 2.隔离片状测试

一旦你找到了你的古怪测试，你应该为它们创建一个单独的测试套件作为隔离。您的非易失性测试不必运行多次，因此创建一个额外的测试套件将使您免于重复部分工作。谷歌甚至创造了一个工具来帮助解决这个问题，它通过自动将零散的测试放到一个单独的测试套件中。

这种实践在修复易变的测试时也会有所帮助，因为它允许您独立地关注易变的测试。如果将测试隔离在它们自己的套件中可以解决这个问题，那么这个变化将会给你一个想法，测试间的依赖是不是问题的原因。

### 3.清理状态

删除测试运行前生成的所有状态和数据，这样您的测试就不会被您忘记的现有数据所干扰。这种状态可以存在于缓存、数据库甚至变量中。您还需要检查您的测试在完成后是否被正确清理——清理错误在测试套件中通常会被忽略。在最坏的情况下，您需要为每个测试运行重建整个系统。

对于数据库，使用事务可能会有所帮助。这些可以在测试运行后回滚，将数据库恢复到测试开始前的状态。

### 4.寻找暂停

由于超时，访问网络资源的异步测试特别容易失败。网络速度可快可慢，取决于使用它的服务数量。过短的超时会导致测试失败。批量设置超时变量将允许您在将来快速更改它们。

如果您有一个依赖于异步服务的复杂测试，在开始测试之前，尝试检查服务的可用性。当超时太长时，这将节省时间。

### 5.使用测试替身

如果你测试一个不确定的服务，你可以创建一个简化的版本。对这种实践的一个常见批评是，测试替身并不总是准确地模拟实际服务。通过确保测试副本不偏离原始副本，您可以考虑更新。编写契约测试有助于缓解这个问题。

### 6.检查系统时钟

如果您的代码依赖于无法提前知道的数据，如系统时钟，请将这些数据源包装在您的代码中，不要直接依赖它们。这将允许您在运行测试之前用硬编码数据替换它们的输出。

### 7.检查内存泄漏

剖析您的测试代码，了解它的内存使用情况。如果您的代码有内存泄漏，您将看到您的测试套件的内存使用随着每次运行测试而增长。根据可用的资源和该硬件上运行的其他系统，内存泄漏很可能是您的问题的根源。

如果您使用资源分配池作为代码和实际内存分配之间的包装，请求太多将导致代码以确定的方式失败。然后，您可以尝试通过降低内存分配来解决这个问题。

## 摘要

古怪的测试不是微不足道的。即使第一眼看上去剥落似乎是随机的，但重要的是要记住预先存在的状态、网络问题、时间，甚至内存分配都可以在测试功能的好坏方面发挥作用。

幸运的是，有可行的方法来消除测试中的片状剥落。多次重新运行您的测试，更改它们的执行顺序，并可视化它们如何随着时间的推移而成功和失败。最后，将零散的测试隔离到一个单独的测试套件中，并通过查看潜在的根本原因来尝试修复它们。

不可靠的测试会耗费你的时间和金钱，因为多次重复测试会降低你的 CI/CD 流程，并侵蚀你的团队对测试的信任。[桑德拉助手](https://www.thundra.io/sign-up)目前是 Java 应用程序的 IntelliJ IDEA 插件。您可以在几分钟内开始，并立即开始故障排除测试，这样您的团队就不会浪费更多时间。

通过 Pixabay 的特色图片。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>