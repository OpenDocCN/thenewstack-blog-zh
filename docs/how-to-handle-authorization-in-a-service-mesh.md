# 如何在服务网格中处理授权

> 原文：<https://thenewstack.io/how-to-handle-authorization-in-a-service-mesh/>

微服务架构形成了一个生态系统，在这个生态系统中，应用程序的各个小部分协作完成一个业务案例。

 [朱迪思·卡勒

Judith 是一名产品营销工程师，对安全性和身份非常感兴趣。在加入 curity 团队之前，她最初是一名开发人员，后来成为了一名安全工程师和顾问。](https://www.linkedin.com/in/judith-k-3269a6a9) 

使用微服务的最大好处是开发人员可以独立地更改、更新和部署应用程序的各个部分。团队可以并行工作，理想情况下，不必等待其他团队发布。这种灵活性提高了生产效率，缩短了新功能的上市时间。

然而，即使服务在微服务架构中是高度独立的，它们仍然必须相互通信才能协同工作。然而，随着参与方数量的增加，服务通信成为一个挑战。在多个服务和版本之间路由请求，同时实现授权、认证或加密等安全需求变得很复杂。

## 基础设施层

服务网格解决了大规模应用程序中服务通信的挑战。它添加了一个基础设施层，为微服务处理服务发现、负载平衡和安全通信。通常，服务网格通过一个额外的组件来补充每个微服务——一个通常被称为侧柜或数据平面的代理。

代理截取来自和去往其伴随服务的所有流量。它通常使用 MutualTLS(一种带有客户端身份验证的加密连接)与服务网格中的其他代理进行通信。这样，服务之间的所有流量都被加密和验证，而无需更新应用程序。只有属于服务网格的服务才能参与通信，这是一种安全改进。此外，服务网格管理功能允许您配置代理和实施策略，例如允许或拒绝特定连接，从而进一步提高安全性。

## 应用层

要实现一个[零信任架构](https://curity.io/resources/learn/zero-trust-overview/)，你必须考虑几层安全。应用程序不应该盲目地信任一个请求，即使它是通过加密线路接收的。它必须验证请求是合法的，并确保数据访问在应用程序级别是安全的。在应用层实现认证和授权的一个成熟的协议是 [OAuth 2.0](https://curity.io/product/token-service/?=use-cases?tab=mesh) 。

像入口控制器、API 网关或反向代理这样的组件是通过在请求到达服务网络之前验证 OAuth 访问令牌来实施认证和执行基本授权的理想选择。但是，最佳实践是不仅在外围对每个请求进行身份验证和授权，而且在网络内部和服务之间进行身份验证和授权。由于授权决策是业务逻辑的一部分，令牌验证也是应用程序的一部分。

验证令牌时，建议遵循[最佳实践](https://curity.io/resources/learn/jwt-best-practices/)，例如:

*   仅接受就颁发者和过期时间而言有效的令牌。
*   确保令牌用于与受众、范围和声明相关的预期用途。

## 服务中和服务之间的令牌

在服务网格中引入应用程序级别的授权带来了挑战。如上所述，服务协作完成一个业务案例。但是当服务网格中的所有服务都需要授权时，服务请求必须包含授权数据。换句话说，服务需要能够[与其他服务](https://curity.io/resources/learn/token-sharing)共享令牌。

### 转发令牌

直观的方法是简单地将传入的令牌转发给下游服务。只要所有服务都需要相同的权限，并且令牌位于一个安全域内，这种方法就可以很好地工作。虽然重用令牌是一个简单的解决方案，但当令牌的特权(即范围和声明)增长到满足后续请求的所有要求时，就会出现问题。具有许多特权的令牌最终会成为漏洞攻击的目标，并违反了最小特权原则。

在转发令牌时，隐私是另一个需要关注的问题，尤其是在像外部服务这样的安全边界上转发令牌时。令牌通常携带用户或业务数据。在为多个服务重用令牌时，每个服务都有特定的要求，这些要求会影响令牌中的数据。例如，一个服务可能需要用户的银行账号，而另一个服务可能需要用户的家庭地址，这可能与第一个服务无关。发送不相关的数据，其中一些可能是敏感的数据隐私法带来了不必要的安全风险。

### 定制令牌

遵循最小特权原则，确保令牌包含的数据刚好够服务完成其任务。如果预先知道完成业务案例所需的后续服务请求链，那么嵌入令牌是利用定制令牌的合适方法。在这种方法中，父令牌为其他服务的每个后续请求携带一个嵌入式令牌。API 网关或服务可以在向下一个服务发送请求之前提取嵌入的令牌。接下来，服务接收带有相应范围的定制令牌，并声明服务需要履行其在业务案例中的职责。

嵌入式令牌方法需要特定的标准化令牌服务和基础设施。首先，令牌服务必须能够嵌入令牌。它必须拥有请求的依赖树信息，才能知道为传入的令牌请求嵌入哪些令牌。它很可能会根据客户机 id 和范围做出决定。当依赖关系树很复杂，并且有几层嵌入的标记时，评估包括哪些标记的任务变得很麻烦。由于父令牌包含嵌入式令牌，因此它比单个令牌大。

因此，请求的大小变得更大，因此需要能够处理大型 HTTP 报头的网络基础设施。基础设施不仅必须能够传输潜在的大消息，还必须缓存令牌以供进一步处理。当负载出现高峰时，这尤其具有挑战性。

有时，最终的服务链可能事先并不知道。这在松散耦合的服务世界中很常见，在这种环境中，系统经常作为敏捷范例的一部分而改变，或者过程是有条件的。因此，为后续服务请求嵌入所需的令牌可能是不可能的。在这种情况下，嵌入式令牌方法将不起作用，需要一种更动态的方法。

### 按需代币

本文介绍的最灵活的方法是令牌交换。它可用于将现有令牌交换为新令牌。新令牌的范围可以缩小，并声称是原始令牌的子集。或者，也可以换成全新的，以适应不同的安全域。OAuth 2.0 的令牌交换协议在 [RFC8693](https://www.rfc-editor.org/info/rfc8693) 中被标准化。

每当服务旨在调用下游服务进行进一步处理时，以及每当原始令牌不满足后续服务请求的要求时，最初调用的服务可以将其令牌交换为新的定制令牌。它只是向令牌服务发送一个请求，请求一个新的令牌。然后，令牌服务检查它的规则集，如果请求有效，它就发出并返回一个新令牌，调用服务在它对下游服务的请求中使用这个新令牌。

令牌交换过程有两个关键方面。首先，它通过为特定服务或一组服务发布具有狭窄范围和声明的定制令牌，帮助实现最小特权原则。其次，它通过在实际需要时按需发放令牌来实现灵活性。这种方法非常适合微服务范例，在微服务范例中，服务以各种方式松散耦合和组合。新令牌基本上没有限制。通过令牌交换，您可以安全地跨越安全边界并实现各种用例，包括[模拟](https://curity.io/resources/learn/impersonation-flow-approaches/)。

然而，由于该协议需要额外的请求来获得新令牌，这种方法意味着在等待时间至关重要的系统中的挑战。此外，令牌服务还必须维护规则集，以满足何时发布新令牌的条件。该规则集基于业务规则，必须考虑安全问题以避免权限提升。

## 结论

安全性是一个多学科领域，需要在不同的层面上实施。服务网格通过添加一个基础设施层来提高基于微服务构建的应用程序的安全性，在该基础设施层中，连接的服务可以安全地进行通信。OAuth 2.0 增加了应用层的安全性，并允许跨不同微服务安全地实现业务规则。在服务网格中的服务之间共享令牌有三种方法:转发、嵌入和按需。这些方法并不相互排斥，而是可以结合起来实现一个适合业务及其先决条件的安全实现。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>