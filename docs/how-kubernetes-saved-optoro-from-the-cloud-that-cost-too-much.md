# Kubernetes 如何将 Optoro 从成本高昂的云中拯救出来

> 原文：<https://thenewstack.io/how-kubernetes-saved-optoro-from-the-cloud-that-cost-too-much/>

Kubernetes 是高度可用的，允许部署容器化的应用程序，是可扩展的，并且已经成熟到其好处越来越相关和可测量的程度。它让您能够提供客户期望的规模、稳定性和效率。它还能让你快速打破常规，这样你就可以创新、犯错并找到回头路。

在本文中，我将解释为什么我们将 Optoro 的 Ruby on Rails 堆栈从 T2 亚马逊网络服务的虚拟私有云(VPC)迁移到 SDC 的 Joyent 智能数据中心，以及这条路径如何引导公司直接进入容器化，以及开源 Kubernetes 容器编排引擎的好处。

## 为什么我们离开了云

 [扎克·邓恩

Zach Dunn 是 Optoro 平台运营和 CISO 的高级总监，他帮助团队为企业客户构建和交付现代软件。他在技术职业生涯的大部分时间都在担任类似生产基础设施的角色，职责包括热通道苦工、专业书呆子牧人和预算负责人。一旦被认为是一个独立的个体，这些天他通常被称为阿拉贝拉的爸爸，有时也被称为威廉的爸爸。](https://www.linkedin.com/in/zach-dunn-11507217/) 

大多数公司认为云是未来。我们从 AWS 中的 EC2-Classic 开始，那里一切都是狂野和开放的。Optoro 在这个术语变得很酷之前是云原生的，在我加入时一直如此——2015 年将公司迁移到 AWS VPCs。整个基础设施建立在 Ruby on Rails 之上，由一系列关系数据库和后端应用程序提供支持。

后来变贵了。

作为一家快速发展的公司，我们希望给我们的开发人员提供构建和尝试新事物的能力。然而，作为一家新生的创业公司，我们必须将现金放在决策的首位。我们花了很多钱来运行我们的服务器，因为我们从 EC2 开始，这是一个经典的虚拟机架构。我们实际上无法大幅度扩展我们的应用程序，而且我们的许多集成一天 24 小时都在运行，这并不理想。我们列出库存清单，处理来自仓库和手持设备的请求，但这不是很循环。

我们还遇到了需要比数据集暗示的多调整一点的情况。我的经典例子是我们的 Redis 队列，在那里我们运行了比我们需要的稍微大一点的机器，因为我们运行在共享的硬件和 Amazon 上。我们不得不对冲我们的赌注，运行更大的机器，所以我们不得不支付比我们需要的更多。许多突发功能对我们来说并不那么有用，我们要做大量的网络事务和磁盘 I/O。每个月，我们的账单中有 20-30%只是 I/O，而且这些账单越来越大。

它需要改变。我们无法抵消 I/O，甚至在支出上加倍，我们意识到我们可以更便宜地在内部运行。Optoro 在成本方面处于稳定状态 APIs 和数据库从未关闭，因此成本会随着云的扩展和收缩而增加或减少。通过迁移到数据中心，我们可以平衡这些成本，并提高财务管理的可预测性。因此，我们没有走成本优化路线，而是拉起车，拉起操纵杆，然后冲出去。

## 数据中心迁移成功的原因

当我们第一次从 AWS 转移到 on-premise 时，第一次迭代使用了 [Joyent SDC](https://github.com/joyent/sdc-sdc) ，一个开源的基础设施即服务(IaaS)，用[哈希公司的 Terraform](https://www.terraform.io/) 来构建和管理它。当我们在 AWS 内部时，我们已经倾向于 Consul 和 HashiCorp 堆栈，所以当我们搬进自己的数据中心时，这一点没有改变。在迁移过程中，我们学到了很多东西，也获得了很多好处。

例如，知道你的限制在哪里是很重要的。当我们查看我们的应用程序时，在租来的硬件上运行它是没有意义的。我们开始着手迁移我们的应用程序。当您回到现场时，您可以在迭代过程中构建更好的系统。当你明白了自己平台的短板，你就明白了优势在哪里。

迁移的好处是:

*   我们一直在尽可能提高云中机器的性能，但是随着我们向裸机的迁移，这些限制消失了。
*   如果我们使用容量，它不会增加成本。事实上，我们被激励去使用它，因为我们从购买的罐头中获得了价值。这是我们的第一代技术，具有 32 个内核、256GB RAM 和固态硬盘，我们的机器提供的容量和性能远远超过云。
*   我们继续使用 Terraform 部署映像和管理实例，就像在 AWS 中一样。
*   我们的直连存储意味着不再有围绕 I/O 的争用。
*   我们实现了可观的成本节约，这让我们大吃一惊。
*   我们可以更容易地隔离工作负载，因为我们控制了金属，并且我们的性能已呈指数级提高。
*   通过提高性能，我们通过平台的效率购买了更多容量

我们坐下来，和我们的董事会和财务分析师一起算了算。我们对迁移到数据中心进行了建模，以估计在一定年限内我们可以节省多少成本。价格稳定对我们来说很重要，可预测性也是如此。我们想证明云是更好的选择。作为一家初创公司，我们不想为了获得较低的运营率而在新事物上投入大量现金。

当我们计算这些数字时，我们发现我们看到的是 60%的节约—我们并没有试图粗略估计或估计机会成本。这些是硬成本，对董事会和我们来说意义重大。董事会知道我们在做什么，我们得到了他们的认可，这很重要。改变是困难的，接受是必不可少的。

他们相信我们能成功，我们做到了。大约两年半后，其中一个人问我的老板关于我们展示的模型。他们想知道这是否可行，成本是否如我们所想。我们把它挖了出来，意识到我们错了。我们存了更多。

## 为什么数据中心迁移可能不适合您

从云迁移到内部部署并不适合所有人。你不能放弃你还在写基础设施代码的想法。您仍然需要构建一代又一代的服务器，并且需要能够扩展、替换和重新设计。你有可能把自己逼入绝境。

## Kubernetes 如何改变未来

我们经历了两次迁移——从亚马逊 EC2 Classic VPCs，到亚马逊 VPC，再到 Joyent SDC 的内部部署。Joyent 创建了一个可以跨数据中心调度的 Docker API，就在那里，我们的容器化之旅开始了。我们开始将我们的虚拟机资产转换为 Docker 容器，并在 2018 年开始尝试 Kubernetes。这标志着我们的第三次迁徙——这一次是去金属上的库贝内特斯。

我们已经在模仿平台即服务(PaaS)方法，Consul 运行在 Joyent 的 SDC 上，使用 Terraform 进行配置。集装箱化已经是我们发展轨迹的一部分，所以从模仿 PaaS 到认真采用一个平台是有意义的。自从我们的第一次调查以来，Kubernetes 已经成熟并有了更大的发展势头。我们觉得我们可以从这个行业的经验中学习。我们的高级工程师在本地进行了几次 sprints 测试 Minikube，以了解 Kubernetes 与现有基础设施工具和应用程序集成的难易程度。

我们也知道我们不想吸收额外的成本。我们需要一个商业案例，但我们找不到适合 OpenShift、GKE 或 EKS 的案例。我们希望允许我们的开发人员继续直接管理他们的集群。这是我们发现牧场主的时候。[它对采用容器的商业案例的研究](https://rancher.com/blog/2019/business-case-for-container-adoption)帮助我们了解了更多关于该技术的信息，并成功地完成了概念验证，见证了我们服务的稳步迁移，我们现在在生产中运行 42 项服务中的 13 项，我们的目标是在今年迁移整个基础设施。

展望未来，我们决定不更新我们现有的 Joyent 平台，而是将我们的 Kubernetes 集群附加到我们现有的基础设施上。它让我们可以根据需要使用 Kubernetes 来增加和减少节点数量。同样重要的是，如果我们需要更多容量或者将数据中心的规模扩大三倍，我们只需要扩展云中的集群。然后，如果我们知道这将是我们的稳态，我们可以回购我们的基本负载，并优化成本。

好处是广泛的:

*   我们可以让环境旋转起来，尝试新的想法，当出现问题时，我们可以把它们推倒。这使我们知道我们确实在构建声明性基础设施。
*   我们可以根据需要灵活扩展我们的美国数据中心网络。
*   我们的质量保证团队非常欣赏集群的精细可见性，这使他们能够检查权限、重新部署应用程序以及查看和监控各个日志。

## 结论

我的团队不受约束，可以引入新工具，而没有大多数商业平台带来的摩擦。我们可以发挥创造力，做更多的事情，而不受封闭环境的束缚。我们还可以快速改变策略，这在我们的动态组织中产生了很大的影响。有经验教训——搬到 Kubernetes 不是没有挑战——但它使我们的生活更容易。这就是 Kubernetes 的美妙之处。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>