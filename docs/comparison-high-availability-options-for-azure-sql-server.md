# 比较:Azure SQL Server 的高可用性选项

> 原文：<https://thenewstack.io/comparison-high-availability-options-for-azure-sql-server/>

[](https://us.sios.com/)

 [大卫·伯明罕

大卫·伯明罕是 SIOS 科技公司的技术传道者。他是技术社区公认的高可用性专家，在过去的 12 年中，他一直荣幸地当选为 Microsoft MVP:六年当选为集群 MVP，六年当选为云和数据中心管理 MVP。David 拥有多项技术认证，并拥有三十多年的 IT 经验，包括在金融、医疗保健和教育领域。](https://us.sios.com/) [](https://us.sios.com/)

丰富的选择并不总是好事。有时候只会制造混乱。如果您想要在 Azure 上配置任务关键型 SQL Server 基础架构以实现高可用性(HA)和灾难恢复(DR ),请考虑这些选项。您可以在配置为 Windows 故障转移群集实例的多个虚拟机(VM)上运行 SQL Server，其中 VM 跨容错域或多个 Azure 可用性区域分布。您可以使用存储解决方案，如高级文件共享、Azure 共享磁盘或直接存储空间；或者，您可以使用第三方工具来创建无 San 集群解决方案。SQL Server 内置的“永不停机”可用性组选项又是怎么回事呢？Azure 的站点恢复服务怎么样？

尽管所有这些选项都旨在提高可用性，但并非所有这些选项都能为您提供真正的高可用性，高可用性的定义是能够在 99.99%的时间内访问您的应用程序和数据。这些选项中的一些(但不是全部)可以提供灾难恢复支持，这涉及到在地理位置不同的区域构建一个基础架构，如果您的整个主要基础架构离线，该基础架构可以快速恢复在线。

## **哈经 FCI**

为高可用性配置 SQL Server 的传统方法包括创建 Windows 故障转移群集实例(FCI)。在内部部署中，这将涉及创建一个至少由两台运行 SQL Server 实例的服务器组成的群集(理想情况下位于两个独立的数据中心以消除任何单点故障)，以及第三台服务器或一个文件共享见证服务器，以确保您的 FCI 群集仲裁。

在 Azure 中，你将做同样的事情，只是使用虚拟机而不是独立的服务器，集群中的每个虚拟机都运行在一个不同的 Azure 可用性区域中(将 AZ 视为一个不同的云数据中心)。通过将 FCI 中的每个节点定位在不同的 AZ 中，承载主动运行 SQL Server 的虚拟机的整个 AZ 可能会脱机，但 FCI 中的智能会将另一个 AZ 中的 SQL Server 实例联机，以接管不再可用的虚拟机。从运行 SQL Server 的虚拟机的角度来看，这种方法消除了单点故障问题，这种问题在所有虚拟机都在同一个 AZ 中运行的任何配置中都可能出现。

从概念上讲，这是合理的，但是在云中运行 FCI—任何云—会产生与存储相关的问题，而这些问题在内部部署中是不存在的。在本地 FCI 中，您可以选择使用某种共享存储系统 SAN 或 NAS 系统—FCI 中的所有节点都可以访问。如果主动节点出现故障，可以激活一个备份节点，它将访问 SAN 或 NAS，继续对共享存储系统上的 SQL Server 数据库进行读写操作。但直到最近，在 Azure(或 AWS 或谷歌云服务，就此而言)中还不可能以同样的方式共享存储。

## **高级文件共享**

Azure 的高级文件共享现在提供了一个配置共享的区域冗余存储的选项。这实际上创建了一个存在于两个独立 az 中的存储系统。如果一个 AZ 离线，关闭活动虚拟机及其高级文件共享的本地实例，FCI 将故障切换到第二个 AZ，备用虚拟机可以介入并开始与其自己的高级文件共享的本地实例进行交互，该实例包含离线 AZ 中存储的所有数据的镜像。

理论上，使用区域冗余高级文件共享配置 FCI 可以为您提供您在高可用性配置中寻求的 99.99%的 SQL Server 可用性。但是，依赖区域冗余高级文件共享会导致一些组织可能无法接受的特性/功能成本:某些存储特性不能在使用区域冗余高级文件共享的配置中使用，包括磁盘爆发、只读主机缓存和 Azure 磁盘加密。如果您的组织打算在其 SQL Server 部署中使用这些功能中的任何一项，您将需要选择另一条路径，而不是涉及区域冗余高级文件共享的路径。

## **Azure 共享磁盘**

Azure 的区域冗余高级文件共享的替代方案是 Azure 共享磁盘，这是一种 Azure 托管磁盘功能，使您可以同时将托管磁盘连接到多个虚拟机。在 FCI 中使用时，Azure 共享磁盘似乎可以提供与本地 SAN 中使用的共享存储资源相同的共享存储资源。然而，Azure 共享磁盘有许多与 Azure 高级文件共享相同的限制。如果 maxShares 设置为大于 1(这在 FCI 中很自然)，则磁盘破坏和只读主机缓存不可用。Azure 站点恢复和 Azure 磁盘加密也不可用。Azure 共享磁盘仅适用于 ultra disks、premium SSDs 和 standard SSDs，并且根据您使用的类型还有其他限制。

最后，虽然您可以配置 FCI，以便虚拟机位于单独的 az 中，但您只能将 Azure 共享磁盘解决方案附加到单个区域中的虚拟机。如果前面提到的限制对您适用，这使得使用 Azure 共享磁盘在 Azure 中配置一个真正的 HA 解决方案成为可能，但不是一个您可以扩展以支持 DR 的解决方案(这将涉及共享或复制数据到一个单独的区域)。

## **储位直达**

使用 Azure 的存储空间直接选项的 FCI 怎么样？Storage Spaces Direct 采用了一种不同的方法来实现共享存储解决方案，这种方法更类似于传统的 SAN 或 NAS 配置。FCI 中的每个节点都可以访问存储空间直接配置中的存储，因此，如果一个节点变暗，另一个节点可以继续访问存储中的数据。您还可以利用磁盘爆发、只读主机缓存和 Azure 磁盘加密，从而消除使用区域冗余高级共享的 FCI 中固有的限制。

但是，您知道“无论如何”都会发生，直接使用存储空间的 FCI 的主要缺点是您不能跨多个 az 配置存储。如果不能跨多个 az 分布存储，您就无法配置确保真正高可用性的 SQL Server 解决方案。单点故障将一直存在，即使 AZ 中有多个虚拟机可以在主虚拟机因任何原因停止运行时接管。如果整个 AZ 由于某种原因而陷入黑暗——这种情况确实会发生——那么您的整个 SQL Server 基础架构都会离线。考虑到真正的高可用性配置中可接受的停机时间每月不到五分钟，以及使整个数据中心恢复在线的复杂性，如果您将高可用性目标直接锁定在存储空间上，您可能会看到更长的停机时间。

## **无桑星团**

HA 的另一个 FCI 配置涉及到第三方无 San 集群软件的使用。在无 San 群集中，FCI 中的每个虚拟机都配置有自己的本地存储系统。没有任何东西是以 Azure Premium 文件共享或存储空间直接共享的方式共享的。相反，无 San 集群软件使用同步的块级复制来确保写入连接到主虚拟机的存储的任何数据也写入连接到独立 az 中的一个或多个辅助虚拟机的存储(或作为灾难恢复选项异步写入远程区域中的虚拟机)。同步数据复制可确保同一区域中辅助 FCI 节点上的数据始终镜像主动/主节点上的数据。如果活动虚拟机变暗，或者如果节点所在的整个 AZ 变暗，FCI 将故障切换到辅助群集节点，SQL Server 可以在该节点上开始处理其本地存储系统中的最新数据，并继续为您的组织和/或其客户提供生产支持。

如果您将无 San 集群解决方案用于灾难恢复和高可用性，则灾难恢复基础架构的故障转移是手动的，并且存在灾难恢复基础架构上的存储数据可能不总是与活动虚拟机上的数据完全同步的风险(由于异步复制中的滞后时间)，但很少会超过几秒钟不同步。在灾难恢复解决方案中，这种差异更容易被接受:如果整个地区的数据中心停机，最好能够使灾难恢复基础架构快速上线，即使有轻微的数据丢失，而不是让**没有**数据和**没有**基础架构上线。

是的，这也确实发生了。

无群体聚类的缺点是什么？它涉及使用第三方软件，而不是微软本地解决方案，因此您必须为 FCI 中的每个虚拟机购买许可证，以利用无 San 集群。尽管无 San 集群软件可以与 2008 年以后的任何版本的 SQL Server 一起工作，尽管它非常干净地集成到 Windows Server FCI 管理软件中，但它仍然是您需要学习如何配置和管理的另一个软件。

## **非 FCI 人接近 HA**

顶部选项列表中有两种不涉及创建 FCI 的高可用性方法。事实上，一个是内置于 SQL Server 本身的 HA 解决方案:SQL Server 可用性组(AGs)。AG 解决方案的运行方式有点像采用无 San 集群的 FCI:从 AG 管理控制台中，您会发现两个(或更多)虚拟机，每个虚拟机都有自己的本地存储和自己的 SQL Server 本地副本(在 AG 中总是处于活动状态)。然后，AG 软件将对主 SQL Server 的任何写入复制到辅助虚拟机上的存储中的 SQL Server 数据库，辅助虚拟机可以位于单独的 az 中，以消除单点故障并确保高可用性。

与无 San 群集一样，AG 软件可以以同步方式将数据从主 SQL Server 数据库复制到辅助 SQL Server 数据库，因此即使在高性能生产环境中，AG 软件也可以非常快速地复制数据。如果运行 SQL Server 的主虚拟机关闭，其中一个活动的辅助虚拟机可以开始充当新的 SQL Server 主实例。SQL Server 数据库与主虚拟机上的活动数据库完全相同，因此辅助实例可以轻松介入并支持组织的 SQL Server 需求。

AG 还可以用于将 SQL Server 数据库异步复制到远程区域的基础架构，这使得它作为灾难恢复解决方案也是可行的。

但是，正如我们到目前为止研究的所有解决方案一样，也有一些问题。作为 SQL Server 的一项功能，AG 仅复制与 SQL Server 关联的数据，因此主虚拟机上存储中的其他数据不会复制到辅助虚拟机。此外，AG 只复制用户命名的 SQL Server 数据库。这是一个重要的考虑因素，因为系统创建的数据库，如那些监控用户、作业、密码等的数据库，**不会**复制到辅助虚拟机。您需要找到另一种复制解决方案，以确保您的辅助虚拟机拥有这些数据库的副本。

AG 的另一个问题是 AG 的真正威力取决于您使用的 SQL Server 版本。SQL Server 标准版只能支持将**一个** SQL Server 数据库复制到**一个**辅助虚拟机。如果您需要复制多个数据库，或者想要将一个或多个数据库复制到多个辅助虚拟机，则需要使用 SQL Server Enterprise Edition，即使您没有其他理由使用 SQL Server Enterprise Edition。这里的问题是价格:SQL Server Enterprise Edition 比 SQL Server Standard edition 贵得多，并且您需要为配置中的每个虚拟机的每个 vCPU 核心 *—* 而不仅仅是获得一个许可证。如果您选择 AG 途径，基本的 HA 特性都存在，但要获得您所寻求的保证，可能需要花费大量资金。

Azure Site Recovery 怎么样？Azure Site Recovery 听起来是一个理想的解决方案:它将你的虚拟机和数据从一个 AZ 复制到另一个单独区域的 AZ。如果您的主虚拟机变暗，您可以转向辅助区域中的虚拟机，并使用它来满足您的 SQL Server 需求。然而，这里的问题是响应时间。Azure Site Recovery 实际上是一个 DR 解决方案，而不是 HA 解决方案。与该服务相关的 SLA 承诺恢复时间目标(RTO)为两小时，即在计划外停机后让您的远程基础架构恢复在线所需的时间。面对摧毁整个地区数据中心的灾难，这可能是完全可以接受的，但 RTO 与 HA 配置的目标不一致。在为真正的 99.99%应用程序可用性而设计的高可用性配置中，SLA 保证每月不到 5 分钟的计划外停机时间，RTO 以秒而不是小时来衡量。

## **底线**

在 Azure 上为 HA 配置 SQL Server 时，您有多种选择，但每个选择都以某种方式进行了限定。使用带有存储空间 Direct 的 FCI 不会提供真正的 HA，因为存储空间 Direct 必须位于一个 AZ 中。如果你不需要这些选项不支持的性能和安全功能，带区域冗余共享存储或 Azure 共享磁盘的 FCI**可能会**工作。配置为无 San 集群的 FCI**将**提供您寻求的高可用性(以及灾难恢复支持)，但您必须愿意许可和管理非微软解决方案。类似地，AG 方法可以确保用户命名的 SQL Server 数据库的高可用性，但是**只能确保**用户命名的 SQL Server 数据库的高可用性。而且，如果您需要复制**多个**数据库(或者将一个或多个数据库复制到多个辅助虚拟机(例如，复制到远程灾难恢复基础架构)，您将需要使用更昂贵的 SQL Server 企业版—如果您没有其他理由使用企业版，这可能是一颗昂贵的药丸。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>