# 对于不稳定的熔毁补丁，你可能要考虑检测

> 原文：<https://thenewstack.io/cpu-patches-unstable-might-want-consider-detection/>

自现代 CPU 中的严重漏洞被公布以来已经过去了三周，问题还远未解决。无论是基于软件还是基于硬件的补丁，都导致了一些系统的不稳定，引发了一个问题，即是否最好谨慎行事，选择检测而不是打补丁。

快速提醒一下，[有三种不同的攻击](https://thenewstack.io/need-know-meltdown-spectre-cpu-flaws/)源自现代 CPU 的一个底层性能增强功能，称为推测执行，CPU 提前猜测程序最可能采取的执行路径，以便它可以更快地返回结果。

一种被称为 Meltdown 的攻击变种允许用户空间应用程序读取受保护的内核内存，其中可能包含秘密，如密码、加密密钥和其他敏感信息。Meltdown 会影响 Intel CPUs 和一些 ARM CPU，并通过对操作系统隔离内核和用户空间内存的方式进行重大更改来缓解。

另一种更常见的攻击称为 Spectre，至少到目前为止有两种变种。它允许本地攻击者欺骗应用程序从自己的内存中泄漏机密，并且几乎可以在所有 CPU 上被利用。修复 Spectre 需要重新编译具有新保护的软件，以及通过微码更新对 CPU 的行为方式进行低级更改。

## 补丁故障

首先，值得注意的是 Meltdown 和 Spectre 补丁都会对性能产生影响，虽然这种影响对于消费电脑上的大多数任务来说可能不明显，但某些服务器工作负载可能会受到显著影响；尤其是那些涉及大量 I/O 活动的应用程序，如数据库操作。此外，补丁对老一代 CPU 的性能影响通常更大。

但是，如果有什么比性能下降更让数据中心运营商害怕的话，那就是服务器的不稳定性。在这方面，Meltdown 和 Spectre patches 并非没有问题。

上周，[英特尔证实](https://newsroom.intel.com/news/root-cause-of-reboot-issue-identified-updated-guidance-for-customers-and-partners/)它在 1 月 9 日发布的微码更新修复了 Spectre variant 2，导致由 Haswell 和 Broadwell CPUs 驱动的数据中心和消费系统出现重启问题；尽管也有用户报告其他 CPU 家族的不稳定性。该公司认为，它已经隔离了根本原因，并开发了一个改进的修复程序，已与系统制造商分享进行测试。

> “对我来说，整个 IBRS_ALL 功能非常清楚地表明‘英特尔对此并不认真，我们将有一个丑陋的黑客，它将非常昂贵，我们不想默认启用它，因为这在基准测试中看起来很糟糕’，”Linus Torvalds

与此同时，包括戴尔、惠普和联想在内的许多大型原始设备制造商从 1 月 9 日起停止分发之前发布的包含有错误 CPU 微码的 BIOS/UEFI 更新。供应商现在必须为受影响的客户提供 BIOS 降级选项，并且在测试新补丁后，他们必须说服这些客户再次升级他们的 BIOS，从而导致更多的计划内重启和停机。

幸运的是，Linux 提供了一种基于内核的机制来加载更新的微码，这允许用户测试补丁，而无需实际更新 BIOS。

CPU 没有非易失性存储器，所以一旦芯片出厂，芯片上写的任何指令都不能改变。这意味着在每次系统重新启动后，必须重新应用任何后续的微码补丁，并且在启动过程中进行得越早越好。这就是为什么微码更新的首选方法是通过系统 BIOS，因为代码在操作系统之前执行。

然而，由于计算机制造商与其 BIOS 更新的频率高度不一致，并且主板通常具有较短的支持寿命，所以像 Linux 这样的一些操作系统提供了在内核初始化过程早期应用 CPU 微码补丁的替代方法。这确保了旧系统的用户也可以从他们的 CPU 的最新补丁和错误修复中受益，并且在出现问题时使微码回滚更容易。

问题是，即使英特尔修复了最近的重启问题，一些人对该公司修复 Spectre 的整体方法并不满意。Linus Torvalds 强烈批评了英特尔为减轻分支目标注入而添加的新 CPU“功能”，该缺陷被称为 Spectre variant 2。

“所有这些都是纯粹的垃圾，”[他评论](https://lkml.org/lkml/2018/1/21/192)提议的内核补丁试图使用英特尔 CPU 微码中添加的新分支推测控制机制。“英特尔真的打算让这种垃圾建筑化吗？有人跟他们说过，告诉他们他们疯了吗？”

托沃兹在 Linux 内核邮件列表的后续消息中说:“对我来说，整个 IBRS_ALL 功能非常清楚地表明‘英特尔对此并不认真，我们将有一个非常昂贵的丑陋黑客，我们不想默认启用它，因为那在基准测试中看起来很糟糕’。“所以他们试图把垃圾推给我们。即使从技术角度来看，他们的做法也是完全错误的。”

Meltdown 补丁只需要操作系统级别的修复，对于 Linux 用户来说也不是很顺利，它们在旧内核上的稳定性也受到了质疑。

Meltdown 是通过一个名为 KPTI(内核页表隔离)的新内核功能修复的，该功能最初名为 KAISER，是一种增强内核地址空间布局随机化(KASLR)以抵御攻击的方法。KASLR 是所有现代操作系统中以某种形式存在的安全特性，其目标是随机化内核内存地址，使其更难通过利用内存损坏漏洞来实现任意代码执行。

问题是 KPTI 原本是最新内核版本的一个新特性，并且是在这个前提下设计的。后来，当 Meltdown 缺陷的消息出现时，内核开发人员意识到他们已经在开发的新功能也正好缓解了 CPU 漏洞。然而，这也意味着 KPTI 将不得不被移植到旧的、长期支持的内核版本，以防止它们崩溃。

Linux 内核黑客 Andrew Lutomirski [本月早些时候在 Hacker News](https://news.ycombinator.com/item?id=16087736) 上表示，4.14 之前的内核补丁来自一个相当旧的 KAISER 版本，与 4.14 和 4.15 内核不匹配。他说，这意味着他们会有错误，其中一些不会得到修补，因为这些后端口补丁的上游支持很少。

随着时间的推移，上游 KPTI 版本和后端口版本将会分歧更大，并且改进不会被后端口，这将在其他低级别架构更改需要被后端口时导致额外的问题。

“至少一些版本的‘KAISER’在受到熔毁影响的硬件上，将内核堆栈暴露给用户空间，”Lutomirski 说。“如果这还不能用来挖箱子，我就吃掉我的帽子。KPTI 没有这个问题。”

这意味着最好的做法是使用 Linux 内核的最新稳定版本——目前是 4.14——这也有可能获得仍在开发中的 Spectre 相关补丁。然而，许多用户将被他们的 Linux 发行版所提供的内核版本所束缚，所以升级对他们中的许多人来说并不是一个真正的选择。

## 长期不确定性

即使 CPU 微码和操作系统级补丁的所有当前问题都得到解决，也不能保证投机执行的后果会很快平息下来。

发现 Spectre 的研究人员在他们的论文中指出，迄今为止发现的两种变体很可能不是利用这种 CPU 功能的唯一方式。这意味着未来的研究可能会发现更多的攻击方法和变种，可能需要更多的补丁。

最终，推测性执行需要重新设计，如果不是完全从未来几代 CPU 中消除的话，可能会以我们习惯的性能为代价。但即使这样也不能保证行业不会再次经历这一痛苦的过程，因为处理器还有许多其他可以隐藏缺陷的功能。Meltdown 和 Spectre 可能会带来麻烦。

著名的密码学家和安全专家 Bruce Schneier 在最近发表在《大西洋月刊》的一篇文章中对 T2 说:“针对硬件的攻击，而不是针对软件的攻击，将会变得更加普遍。”。“去年秋天，在英特尔的管理引擎(其微处理器上的远程管理功能)中发现了漏洞。像 Spectre 和 Meltdown 一样，它们影响了芯片的运行方式。寻找计算机芯片上的漏洞是一件新鲜事。现在，研究人员知道这是一个富有成效的探索领域，安全研究人员、外国情报机构和犯罪分子将会穷追不舍。”

## 专注于检测

现实情况是，许多组织无法在其所有系统上部署 Meltdown 和 Spectre 补丁，因为他们有需要旧操作系统才能工作的旧应用程序，并且不容易升级。对于其他公司来说，对其工作负载的性能影响将是不可接受的，因此他们将决定冒不打补丁的风险，并尽可能隔离这些系统。

“如果一个工作负载在没有其他重大故障的情况下不太可能被实际利用，那么检测肯定是更可取的，”Linux 基础设施安全公司[的研究人员在博客文章](https://capsule8.com/)中说。“然而，我们认为，即使在存在更多合法风险的情况下，检测仍然是一种不错的替代方法，尤其是在响应可以自动化的情况下。例如，在敏感信息完全暴露之前检测并关闭违规进程通常是可行的。”

Meltdown 和 Spectre 都通过监控 CPU 的缓存访问时间来泄漏信息，以重建存储在那里的数据，即使是由推测性执行导致的临时数据，也应该被丢弃。这种利用技术被称为旁路攻击，攻击者将 CPU 缓存置于已知状态，然后测量操作时间以确定缓存状态的变化。

Capsule8 使用 Linux Perf 子系统建立了一个检测策略，可以发现利用 Meltdown 和 Spectre 的企图，而性能影响低于实际补丁。该探测器的代码已在 Apache 2.0 许可下发布，可与 Capsule8 的开源监控传感器配合使用。

“这是一种非常低影响的方式，可以连续计算和监控整个系统的缓存缺失率，”研究人员说。在我们的测试中，在我们模拟的 CPU 和缓存密集型工作负载中，运行该检测平均会消耗一个内核上 3%的 CPU，峰值为 10%

漏洞管理公司 Qualys 的研究人员在[的一篇博客文章](https://blog.qualys.com/news/2018/01/16/meltdown-spectre-mitigation-is-a-work-in-progress)中说:“就运营风险和安全风险而言，每家公司都有自己的风险。”。“出于这个原因，Qualys 认为，对于一些组织来说，最好不要打补丁，而是使用不同的补偿控制来尽可能降低风险。”

在这一点上，许多网络安全和防病毒公司应该有公开发布的 Meltdown 和 Spectre 概念验证漏洞的检测签名，而且值得记住的是，为了执行这些攻击，黑客首先需要能够在易受攻击的系统上执行恶意代码。这种情况发生的几率可以通过各种其他安全控制措施来降低。

由[卢克·弗林特](https://unsplash.com/photos/9jErXqFwAYs?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/search/photos/detect?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>