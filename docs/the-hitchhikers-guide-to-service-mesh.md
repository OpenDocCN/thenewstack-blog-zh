# 服务网格的搭便车指南

> 原文：<https://thenewstack.io/the-hitchhikers-guide-to-service-mesh/>

[HashiCorp](https://www.hashicorp.com/?TheNewStack) 赞助本帖。

 [彼得·麦卡伦

Peter 是 hashi corp Consul 的高级产品营销经理。](https://www.linkedin.com/in/petercmccarron/) 

在上周的 Kubecon EU 大会上，有很多人关注服务网格、边车、微服务和许多其他“网格”事物。为了帮助浏览本次活动的资源、视频、会议和各种其他内容，我们认为提供一个方便的参考指南来探索这些概念是什么以及它们为什么在当今市场上如此突出是很好的。本指南的目的不是为读者指明方向，而是帮助挑选出在一个新的和不断变化的技术领域中使用的工具和术语。所以不要惊慌，拿起你的毛巾，让我们开始吧！

## 但是为什么是服务网格呢？

 [科迪·德·阿克兰

Cody 是 hashi corp consult 的技术产品营销经理。](https://www.linkedin.com/in/codydearkland/) 

有时候听关于服务网格的讨论感觉有点像听 Vogon 诗歌，但它确实是现代应用程序网络的一个重要进步。在其核心，服务网格正试图解决一个简单的问题，我如何有效和安全地连接我的应用程序？传统网络的追随者可能会觉得这是一个已经解决的问题的不必要的复杂化，但是，正如许多人指出的那样，云和容器确实改变了这些传统网络概念的应用方式。为了进一步细分，让我们用一个基本的、真实的例子来说明是什么加快了对服务网格的需求。

想象一下有人在盖房子。有基本的组成部分，如电力，水，使家居宜居所需的管道和一些更可定制的功能，如家具，油漆颜色和电器。假设你想问事情进展如何(为了这个例子，这是一个前手机世界)。你如何联系到建筑商？你可以直接开车过去，问问你是否知道地址。如果他不知道，他需要某种信息来联系建筑商，比如电话号码。现在想想你如何让一部座机连接到一个新家。首先，电话公司的人需要来给房子布线并连接到他们的网络，然后他们给房子分配一个电话号码，然后电话号码需要发布到某种目录中，然后拨号，最后，我们可以问建筑商，“进展如何？”

现在想象一下，如果建筑商告诉他，“我实际上每隔几天或几周就要把这个房子搬到一个不同的地方，每次搬家都需要你来重新布线电话服务，这会有多烦人。”如果建造者有个东西跟着他，不管房子在哪里，都能找到他，这不是更容易吗？类似手机的东西？这就是服务网格的好处。我不想等待一个电话号码(或 IP 地址)被分配，让他们与我的其余服务连接。我应该能够用一个工具(像一个 sidecar 代理)让我的服务一致地伸出手，并且那个设备应该让我连接到其他想要的服务。

## 听起来不错，我如何开始？

如果现在服务网的想法听起来像泛银河漱口杯一样好，那太好了！但是就像这种饮料一样，知道它到底是由什么组成是很重要的，也许最好只喝一种。为了简单起见，我们将分解服务网格的一些组件，并解释它们的角色和意义。这篇博文将涵盖:

*   带边车代理的基础
*   交通管理
*   安全性
*   具有网关的全局网格
*   跨度和跟踪的可观测性

### 带边车代理的基础

坚持我们的主题，把边车代理想象成你的巴别鱼。将这些与您的服务配对，以实现轻松的通信和其他服务。边车代理顾名思义。它们附加到网格中运行的服务，因此，服务只需要向代理发送 HTTP 或 gRPC 之类的请求，而不需要知道向其发送请求的服务的具体地址或位置。这些代理通常被称为“数据平面”；工作负载数据通过的平面。服务网格提供商通常要么部署他们自己的内部侧柜(通常称为“数据平面”)，要么利用第三方解决方案，如 Envoy、HAProxy 或 NGINX。这很好，但是您可能会问服务如何与 sidecar 代理配对？答案是，它是在服务级别完成的。这里我们将使用 HashiCorp Consul 作为例子，但是其他服务网格提供者也遵循类似的模式来完成这个任务。当向 Consul 服务网格添加新服务时，运营商需要包含一个`service definition`。在这个定义中，用户可以定义服务类型、服务将在哪些端口上运行以及其他有用的信息。当将服务添加到 Consul 服务网格时，用户只需添加一个`sidecar_service`定义，Consul 将从那里获取它。所有这些都是告诉 Consul 这个新注册的服务需要与 sidecar 代理配对，并且它应该遵循任何新定义的或现有的流量策略。有了这些辅助设备，我们现在可以开始添加使服务网格如此有益的功能。

### 交通管理

既然我们已经为网格中的服务建立了通信方法，那么是时候应用一些规则了。Sidecar 代理，就其本身而言，仅仅是请求的促进者——它们需要被给予明确的指示，以防止你的服务最终出现在 Vogon Constructor 舰队的一艘船的厨房里。除了糟糕的笑话，对服务对服务的交流有某种指导是很重要的。幸运的是，服务网格提供商能够直接与 sidecar 代理接口，以形成和控制服务到服务的通信。这就是为什么您经常听到服务网格提供商被称为“控制平面”，而不是我们前面提到的数据平面。

控制平面是网格运营商定义策略和协议的地方，用于定义网格中的服务应该如何彼此交互。例如，假设有一个名为“frontend”的 web 服务和一个名为“db”的数据库服务。在服务网格中，我可以编写一个规则(在咨询中我们称之为意图),允许我“前端”的任何版本与“数据库”服务进行通信。当我增加或减少在我的环境中运行的“前端”服务的数量时，我不必担心配置它们向“数据库”发送请求的能力，因为 sidecar 代理已经被允许促进该流量。

随着应用程序新版本的推出，这些流量管理策略也会有所帮助。传统上，在“真实世界”场景中进行测试对开发人员来说是一个挑战，因为在生产环境中部署测试应用程序并不理想。不过，对于服务网格，这可以通过一种不会导致极度恐慌的方式来实现(记住，不要恐慌)。CI/CD 实践—如 canary 部署、A/B 测试等。—推广快速发展、经常发展的理念。有了服务网格，网络不再成为实现这些实践的瓶颈。版本化的应用程序可以添加到网络中，并带有元数据标签，这将允许一定数量的流量被路由到这些应用程序。在 Consul 中，我们称这些为“流量分割器”,它们可以根据我希望某个版本看到的流量进行加权。通过这样做，我将网络与应用程序交付过程结合起来，以实现更快的测试和版本控制。

### 安全性

从安全角度来看，这是防止未经批准的连接的第一步，但幸运的是，服务网格提供了更高级的安全功能。使用 sidecar 代理使网络能够在服务之间自动进行 mTLS 加密和认证。这意味着在连接请求时，服务将被要求提供认证证书。这些证书由服务网格自动生成和轮换，有助于避免由于无效或过期的凭据而导致的潜在中断。TLS 还增加了传输中加密信息的好处，从而防止信息在传输过程中被复制或查看。服务网格还可以提供更细粒度的安全方式，以实现零信任并防止大型数据中心环境中的横向移动。

## 有网关的银河网

网络和空间一样，可以很大。非常大。因此，几乎不可能将所有需要与网格交互的服务都整合到服务网格中。其中一部分原因可能是组织不希望网格能够看到的特定数据中心中的服务，或者是因为某些服务无法连接 sidecar 代理。无论哪种方式，都应该有一种方法使这些非网格服务既能与服务网格交互，又能在进入或离开网格时将相同的安全和流量策略附加到它们的请求上。这就是网关的用处。网关本质上充当固定端点，服务网格出于各种目的将其识别为可信的。以下是利用网关来扩展网格功能的一些方法:

*   网关:服务网格可以跨越多个环境，比如多个 Kubernetes 环境、Nomad 集群或虚拟机。这些环境可以独立运行，但是需要可见性和相互通信的能力。网关是在这些环境中交换服务信息和促进请求的一种方式。
*   入口/API:外部客户端和服务可以利用这些网关向基于网格的服务发送请求。入口网关由在单个端口上暴露给公共互联网的代理组成。到达此网关的请求将被验证，然后根据网状网络的流量路由策略进行转发。
*   出口/端接:云中的托管服务应用程序或非容器化的遗留应用程序通常没有 sidecar 代理。取而代之的是，服务网格提供商将利用单个代理来促进从网格内部对这些服务的请求。

服务网格可以以各种组合使用这些中的一些或全部。实际上，这取决于一个组织希望管理的网络覆盖面积有多大，但不管怎样，它们都是帮助请求在网格中导航的强大工具。

## 跨度和跟踪的可观测性

“任何一个人，只要他能够纵横银河系，忍受它，忍受它，与可怕的困难作斗争，战胜它，并且仍然知道他的毛巾在哪里，他显然是一个不可忽视的人。”

正如随时知道你的毛巾在哪里很重要一样，知道你的网格上正在运行什么服务也很重要。服务网格是一个强大的工具，但有时会感觉到运营商在采用它时不得不给予大量的盲目信任。我必须相信，连接实际上是由网格建立的，并且是我会批准的。

与其他一些网络环境相比，服务网格实际上可以提供更丰富的可观察性，因为从第 7 层的角度来看，它们更具应用感知性。Sidecar 代理能够捕获应用程序级别的流量以及所谓的“span”数据。跨度实质上是请求在网格中移动时的日志。在请求到达的每一点，它都会捕获这个跨度数据，然后可以将这些数据转发给大量的监控工具。从那里，运营商实际上可以钻取这些跨度，并提取更详细的信息。现在不仅仅是“一个连接失败了”，而是“一个连接在这个特定点失败了，这里是失败的原因。”这种捕获 span 数据并对其进行解释的过程称为分布式跟踪，是一种非常受欢迎的功能。服务网格提供商将 Open Tracing、Zipkin 和 Jaeger 等工具与各种监控解决方案相结合，以创建强大的仪表盘和警报功能。

## 结论

服务网格可能不是生命、宇宙和一切事物的答案，但对于现代应用程序来说是一个非常强大的工具。我们已经看到在应用程序的创建、部署和迭代方面取得了巨大的进步，因此将其中一些实践应用到如何实现联网上是有意义的。要记住的最重要的事情是，服务网格的采用不是一个翻转的开关，突然所有东西都是网格的一部分。这是一个旅程，需要渐进式的变化和将服务从现有环境迁移到这些更新、更动态的环境的策略。在 HashiCorp，我们试图捕捉这一旅程中的步骤，并提供材料来帮助指导组织沿着这条道路前进。希望本指南提供了一些很好的基础知识，将帮助任何新的搭便车者浏览 KubeCon 和其他与 mesh 相关的活动。

最重要的是，再见，谢谢所有的鱼。

通过 Pixabay 的特征图像。

目前，新堆栈不允许直接在该网站上发表评论。我们邀请所有希望讨论一个故事的读者通过 [Twitter](https://twitter.com/thenewstack) 或[脸书](https://www.facebook.com/thenewstack/)访问我们。我们也欢迎您通过电子邮件发送新闻提示和反馈: [feedback@thenewstack.io](mailto:feedback@thenewstack.io) 。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>