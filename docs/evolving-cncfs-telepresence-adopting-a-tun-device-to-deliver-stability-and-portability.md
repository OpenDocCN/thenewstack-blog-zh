# 发展 CNCF 的远程呈现:采用 TUN 设备提供稳定性和便携性

> 原文：<https://thenewstack.io/evolving-cncfs-telepresence-adopting-a-tun-device-to-deliver-stability-and-portability/>

何塞·科尔特斯

何塞·科尔特斯是大使实验室的高级软件工程师。

在微服务环境中，您的服务将向其他服务和应用程序发出网络请求，通常使用 Kubernetes 的 DNS 解析机制进行服务发现。当应用程序在集群中运行时很容易，但是如何在本地运行呢？修改您的应用程序以意识到它正在本地运行既不实际也不可持续。云原生的部分好处是能够开发一次应用程序，并且知道它在任何地方都可以工作，无需修改。远程呈现有助于消除 API 服务器的中间人，让您可以直接与集群对话。

云原生开发的目标是变得更加灵活和可伸缩，以便可以快速构建和交付软件。云原生技术提供了许多好处，但了解云原生方法带来的挑战也很重要。开发人员不再依赖于独立的本地、测试和生产环境的相对安全性。相反，开发人员在本地机器上使用远程 Kubernetes 集群，可能无法完全了解或看到正在发生的事情。从本地切换到远程环境还会增加认知负荷和不可避免的延迟，进而导致更慢的开发反馈循环。在这种背景下，远程呈现技术应运而生:让远程变成本地。

一般来说，有两种方法可以与远程 Kubernetes 集群交互——通过它的入口，访问一个应用程序或它的 API 服务器，通常是通过 kubectl。作为开发人员，这些方法并不总是有效的，因为您需要更多来编码、发布和运行分布式面向服务的应用程序。

## 把它拿走，网真

[开源 CNCF 远程呈现工具](https://www.telepresence.io)通过提供从本地机器*到远程集群*的网络连接来解决这些问题。Telepresence 允许您通过服务的 DNS 名称调用服务，并获得与您在集群中运行时相同的响应。它使远程成为本地，允许您在没有任何特殊逻辑的情况下在本地运行您的应用程序，就像它在生产环境中运行一样。

但是这是如何工作的呢？网真如何把你和 Kubernetes 联系起来？这都是关于网络的。通常，网真的联网方法包括在您的机器上运行的本地守护程序，该守护程序打开到集群上的 pod(流量管理器)的隧道，并将流量移入和移出隧道。

那么流量是如何从本地应用程序到达守护程序的呢？这就是调谐器设备的用武之地。

## 轻按调谐器设备

或者更确切地说，这是调谐器设备*应该*介入的地方，而且它会介入。但是首先，让我们看看导致包含 TUN 设备的背景。

### 网络问题

早期版本的网真使用防火墙规则进行集群连接。这并不罕见，因为防火墙通常用于过滤网络流量或将流量从一个端点重定向到另一个端点。但是这种方法充满了问题。举几个例子，它:

*   引入了对 SOCKS 和 SSH 的依赖，这可能并不存在于每个用户的机器上。
*   是特定于平台的，每个平台需要不同的配置。
*   没有为网真提供在 Windows 上创建这种防火墙重定向的直接方法。
*   如果用户预先存在与远程呈现冲突的防火墙规则或者需要手动清理的防火墙规则，可能会产生问题。
*   不可扩展。大型集群创建了数以千计的规则，需要不断维护。

### 调谐器解决方案

新版本的网真(2.3.0 以后)的目标是使用调谐器设备来解决这些挑战。现在，通过网真连接到集群更像是连接到 VPN。调谐器设备的主要用例是让 VPN 客户端访问专用网络。另外，这种新的联网方式提供了稳定性和可移植性。

调谐器设备是虚拟点对点连接或虚拟网卡，它允许访问通过物理设备路由流量的特定网络。作为一个例子，想想 Linux 系统如何连接到互联网。机器上有一个物理以太网卡，网卡上插有一根以太网电缆。Linux 内核将这个以太网卡表示为一个*网络接口，*通常被命名为 eth0 或类似的名称。内核知道这个网络接口有一个分配给它的特定 IP 地址，比如 192.168.1.103，并使用特定的网关，比如 192.168.1.1，将流量路由到特定的网络；如果只有一个网卡，这通常是 0.0.0.0，即整个互联网。

内核以同样的方式表示 TUN 设备——它有一个 IP 地址，可能有一个网关，并路由对给定网络的访问。唯一区别是调谐器设备不是底层物理设备的代表。相反，当包被发送到 TUN 设备时，内核期望一个用户空间进程从中读取包，并按照自己喜欢的方式对包进行寻址。换句话说，调谐器设备是不直接对应于物理网络设备的网络接口。

如上所述，VPN 是 TUN 设备最常见的使用案例。在 VPN 中，客户端将从 TUN 设备中读取数据包，对其进行加密，并将其转储到通向 VPN 服务器的开放隧道中。VPN 服务器接收数据包，对其进行解密，并将其路由到目的地。

当然，网真不是 VPN，那么网真如何使用 TUN 设备呢？完整的[摘要是一篇更详细的博客文章](https://blog.getambassador.io/implementing-telepresence-networking-with-a-tun-device-a23a786d51e9)和一篇[最近的 Dev House 活动演讲](https://www.youtube.com/watch?v=Yl7QoRkH8y4)的一部分，但大体上它可以:

1.  创建新调谐器设备。
2.  向流量管理器请求集群联网。
3.  允许流量管理器运行各种试探法来确定群集中 pod 和服务的 CIDR 范围，并回复根守护程序。
4.  向 TUN 设备注册流量管理器提供的 CIDRs，允许操作系统通过该设备向其发送流量。

## 融入网真:我们希望的一切？

那么，问题解决了——对吗？我们有办法插入集群，就好像它只是任何其他网络(或任何其他 VPN)，但是我们解决了防火墙方法带来的问题吗？以下是我们确定的结果:

*   现在特定于平台的代码少多了。所需要的只是创建和配置调谐器设备的系统调用；其余的与平台无关。
*   多亏了 wintun.net 的优秀员工，现在有了一种在 Windows 上创建 TUN 设备的简单方法。
*   它需要更少的依赖:Windows 上的 wintun，Mac 或 Linux 上的任何东西。
*   不再与防火墙发生冲突——我们不再操纵防火墙规则(除了一些与连接隧道无关的特定于 Linux 的边缘情况)。

网真总是在不断发展进步。考虑到这一点，我们继续致力于优化 TUN 设备，包括提高其效率的增强功能:

*   TCP 压力测试简介。
*   针对延迟和吞吐量优化处理流量所涉及的逻辑。
*   与社区保持联系，以确保它与所有 VPN 提供商一起工作，并确保用户有一种简单的方法来调试不工作的 VPN 配置。
*   扩展流量管理器，以处理尽可能多的用户流量。

## 总之:从网真开始

基于 Telepresence 为 Kubernetes 提供快速本地开发的承诺，TUN 设备的引入简化了网络，提高了稳定性和便携性，同时为性能和可扩展性的提高铺平了道路。

与所有 CNCF 项目一样，网真的成功取决于社区的参与。面对如此多种多样的笔记本电脑、集群和应用，以及由此带来的网络挑战，我们总是希望收到反馈，听到关于缺陷和成功使用案例的信息。请加入我们的[休闲时间，提出问题或分享你的故事](https://a8r.io/slack)！

如果你想亲自尝试一下[网真](https://www.getambassador.io/products/telepresence)，那么[很容易上手](https://www.getambassador.io/docs/telepresence/latest/quick-start/demo-node/)。你也可以为开源[网真项目](https://github.com/telepresenceio/telepresence/contribute)做出贡献。Ambassador Labs 定期举办面向初学者和专家的“[与维护人员见面](https://www.getambassador.io/about-us/events/meet-the-maintainers-sessions/)”会议。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>