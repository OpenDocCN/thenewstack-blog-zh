# 右边走廊:Dynatrace 启动云铸造单元测试

> 原文：<https://thenewstack.io/right-corridor-dynatrace-jump-starts-cloud-foundry-unit-testing/>

如果您是一名 Cloud Foundry 应用程序开发人员，那么在将工作部署到生产环境之前，您会对其性能进行怎样的测试？CI/CD 框架可以帮助您在沙箱系统中对代码运行一系列自动化测试。但是它能让你进行单元测试吗？

“Cloud Foundry 中的测试过程，”该平台的文档写道，“从对系统中最小的契约点(即每个系统组件中的方法调用)运行单元测试开始。在成功执行单元测试之后，运行集成测试来验证作为在单个机器(例如，虚拟机或裸机)上运行的单个连贯软件系统的一部分的交互组件的行为。”

如果你用 Cloud Foundry 的主要贡献者喜欢的方式测试你的软件，你是在孤立地测试单个功能。或者，正如许多开发者商店发现的那样，他们*认为*他们是。或者，也许他们正在执行一系列的步骤，这些步骤看起来是第二天性，因此他们也可以被称为单元测试，所有人都知道。

在上个月的 Cloud Foundry 峰会期间，应用性能管理服务提供商 [Dynatrace](http://www.dynatrace.com) 宣布与 Cloud Foundry 的管家 [Pivotal](https://tanzu.vmware.com/) 合作。对象？打开 PaaS 平台性能指标的闸门。

## 那么什么是单位呢？

单元测试是一种方法论，一些现代 CI/CD 框架的支持者甚至没有提及，尽管长期的支持者如 [Martin Fowler 认为它是一门科学](http://martinfowler.com/bliki/UnitTest.html)。它几乎就像它听起来的那样:彻底评估孤立的一小段代码的行为的过程，最好是以自动化的方式，以确保该过程的逻辑结果总是在预期的范围内。这些边界之间的空间就是单元测试人员所说的走廊。

理论上，单元测试将是新兴的[微服务](/category/microservices/)架构的完美匹配。

正如 [Fowler 在演讲](http://martinfowler.com/articles/microservice-testing/#testing-unit-introduction)中所说的，当开发人员在为代码模块设计单元测试时遇到困难时，这个困难本身可能是一个积极的信号，表明模块太大了——它应该被分解成组成部分，不仅仅是为了单元测试，也是为了作为微服务的更高效率。“因此，除了作为一个有用的测试策略，单元测试也是一个强大的设计工具，”Fowler 写道，“特别是当与测试驱动开发相结合时。”

虽然 Cloud Foundry 开发人员已经采用了微服务架构，但该平台本身可以说是为快速、有时甚至是肮脏的开发而设计的。性能并不总是一个需要考虑的因素，特别是在公共 PaaS 提供商的情况下，他们自己的管理员应该负责提供性能。那么，PaaS 平台上的单元测试能有多有效呢？这些性能因素中有很多都被开发者有意或无意地掩盖了。

> 单元测试制度不应该过于关注代码的单个元素，以至于忘记了这些元素是如何实现的。

“当你开始谈论如何在构建环境中执行单元测试的性能因素时，”新安装的 Dynatrace 产品宣传员 [Mike Villiger](https://www.linkedin.com/in/mvilliger) 在接受新堆栈采访时说，“在‘默认’云铸造环境中，或者甚至是更传统的环境中的性能指标——是的，测试环境和生产环境之间的性能指标会有所不同。

“这就是为什么当您查看一些更简单、更传统的性能指标(如响应时间)时，您将构建一个响应时间走廊，以确定在该执行环境中什么是正常的。当你在那条走廊之外的时候，你将会寻找失败。在单元测试环境中，你不会有统计基础，就像在传统的性能测试中，你会有成千上万的数据点，在那里你可以准确地确定什么是 90%的性能，什么是 97%的性能，等等。所以毫秒级的统计显著性并不是你在单元测试中要寻找的。在单元测试中，你要寻找那些超过走廊的响应时间。”

## 内部工作

在非常精细的层面上测试过代码的开发人员可能对 [JUnit](http://junit.org/junit4/) 很熟悉，这是一个用 Java 自动化可重复测试的单元测试框架。许多使用 Jenkins 作为 CI/CD 平台的开发公司都熟悉用 JUnit 自动化他们的单元测试。正如 Dynatrace 的 Villiger 告诉我们的，他的公司与 Pivotal 的新关系变得更加有趣，因为它与 Jenkins 的商业管家 [CloudBees](https://thenewstack.io/microservices-transforming-jenkins-cloud-platform/) 有着现有的关系。

“Pivotal 已经与 CloudBees Enterprise Jenkins 建立了合作关系，以便能够在 Cloud Foundry 环境中独立完成您的单元测试和整个生命周期，”Villiger 说，“这样，您就不会在管道中的任何一点离开您将在生产中运行的平台。”类似这样的协议可以将 JUnit 和单元测试框架引入一种无缝的自动化封装中——这是一种平台在代码生成时关注代码性能的方式。

在过去的两年中，Cloud Foundry 为 Java 应用程序提供了一种基于容器的暂存机制。云铸造[花园](https://github.com/cloudfoundry-incubator/garden)项目为 Linux 容器提供了隔离，它们需要在 PaaS 平台上以分布式方式大规模运行。正如 Villiger 提醒我们的，在 Diego orchestrator 的一个单元中运行的每个 Garden 容器都包含一个 Tomcat 实例作为其堆栈的一部分。

村民认为，在测试阶段运行应用程序，通过这种特殊的设置，应该与在生产中运行应用程序没有太大的不同。因此，他说，将 Dynatrace 注入 CloudBees 和 Pivotal 的生产阶段，也有将其引入测试的好处——这样一来，就可以在一个自包含的模型中将必要程度的 Dynatrace 性能指标集成到单元测试中。

## n + 1 问题

包含比 Cloud Foundry 开发人员以前可获得的更多的性能指标，不会改变他们对性能走廊边界的看法吗？

“在我看来，有趣的事情之一是，我们有一个复制旧问题的新堆栈，”Dynatrace 的 Mike Villager 回应道。“我们有了这种全新的架构，我们在谈论微服务，我们在谈论一种用于获取数据的微服务，我们在拆分不同的元素:你有 Spring，你有 [Spring Boot](http://projects.spring.io/spring-boot/) ，你有 [Spring Cloud](http://projects.spring.io/spring-cloud/) 等等。最后会发生什么，你会遇到那个 *n + 1* 问题。”

[24 年前我在一本关于 Visual Basic 的书里写过 *n + 1* 问题](https://www.bookdepository.com/Extending-Visual-BASIC-for-Windows-D-F-Scott/9780672301001)。当您将从数据库获取记录的工作委派给动态组成每个查询的组件时，可能会出现这种现象。如果一个数据表有 1，000 条记录，并且一个 loop 子句循环调用每次提取一条记录的查询，那么生成 SQL 查询的组件将该查询约束到每条特定记录，总共有 1，001 个查询(1 个用于“悬崖”提取，表明没有表了)。早在 20 世纪 90 年代，我就认为这种方法是对 SQL 的误用；中间组件应该能够迭代“SELECT * FROM table”指令的结果。

Villiger 指出，对于微服务，每当编排平台调度 1001 个服务来迭代 1000 条记录时，都会出现同样的问题。普通的单元测试将应用于获取单个记录的函数，使其获取速度更快。但是它不会提示测试人员这样一个事实，即集体处理记录会减少服务的重复，有效地提高应用程序的整体性能。

“在某种程度上，我们正在看着同样的老问题在新的堆栈中自我复制，”维利热说。“接下来将会发生的一些新事情将会是额外的架构回归，在这种情况下，开发人员可能会绕过数据服务，直接从数据库中附加一条记录，而他本应该迭代数据服务才能到达那里。”他解释说，在这种情况下，服务之间不一致，不遵循彼此的程序——一个服务跳过一两步。

他说，架构回归倾向于落在性能回归的边界之外——单元测试的典型焦点。"但是它们是回归，尽管如此，开发者应该关注."

他的观点是:单元测试制度不应该过于关注代码的单个元素，以至于忘记了这些元素是如何实现的更广泛的背景。Villiger 和 Dynatrace 正在寻找机会将性能指标注入到 Cloud Foundry 开发空间中，但至少要在一个级别的上下文中定义性能走廊，而不是局限于单元。

Cloud Foundry 和 [Pivotal](https://tanzu.vmware.com/) 是新堆栈的赞助商。

专题图片:终极单元测试:5 月 29 日，亚历山大·罗西刚刚在第 100 届印第安纳波利斯 500 比赛中穿过砖块。斯科特·富尔顿的照片。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>